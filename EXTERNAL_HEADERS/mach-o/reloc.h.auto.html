<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>reloc.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">reloc.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 1999 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this
 * file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*	$NetBSD: exec.h,v 1.6 1994/10/27 04:16:05 cgd Exp $	*/</span>

<span class="enscript-comment">/*
 * Copyright (c) 1993 Christopher G. Demetriou
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. The name of the author may not be used to endorse or promote products
 *    derived from this software without specific prior written permission
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
 * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_MACHO_RELOC_H_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_MACHO_RELOC_H_</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdint.h&gt;</span>

<span class="enscript-comment">/*
 * Format of a relocation entry of a Mach-O file.  Modified from the 4.3BSD
 * format.  The modifications from the original format were changing the value
 * of the r_symbolnum field for &quot;local&quot; (r_extern == 0) relocation entries.
 * This modification is required to support symbols in an arbitrary number of
 * sections not just the three sections (text, data and bss) in a 4.3BSD file.
 * Also the last 4 bits have had the r_type tag added to them.
 */</span>
<span class="enscript-type">struct</span> relocation_info {
   int32_t	r_address;	<span class="enscript-comment">/* offset in the section to what is being
				   relocated */</span>
   uint32_t     r_symbolnum:24,	<span class="enscript-comment">/* symbol index if r_extern == 1 or section
				   ordinal if r_extern == 0 */</span>
		<span class="enscript-reference">r_pcrel</span>:1, 	<span class="enscript-comment">/* was relocated pc relative already */</span>
		<span class="enscript-reference">r_length</span>:2,	<span class="enscript-comment">/* 0=byte, 1=word, 2=long, 3=quad */</span>
		<span class="enscript-reference">r_extern</span>:1,	<span class="enscript-comment">/* does not include value of sym referenced */</span>
		<span class="enscript-reference">r_type</span>:4;	<span class="enscript-comment">/* if not 0, machine specific relocation type */</span>
};
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">R_ABS</span>	0		<span class="enscript-comment">/* absolute relocation type for Mach-O files */</span>

<span class="enscript-comment">/*
 * The r_address is not really the address as it's name indicates but an offset.
 * In 4.3BSD a.out objects this offset is from the start of the &quot;segment&quot; for
 * which relocation entry is for (text or data).  For Mach-O object files it is
 * also an offset but from the start of the &quot;section&quot; for which the relocation
 * entry is for.  See comments in &lt;mach-o/loader.h&gt; about the r_address feild
 * in images for used with the dynamic linker.
 * 
 * In 4.3BSD a.out objects if r_extern is zero then r_symbolnum is an ordinal
 * for the segment the symbol being relocated is in.  These ordinals are the
 * symbol types N_TEXT, N_DATA, N_BSS or N_ABS.  In Mach-O object files these
 * ordinals refer to the sections in the object file in the order their section
 * structures appear in the headers of the object file they are in.  The first
 * section has the ordinal 1, the second 2, and so on.  This means that the
 * same ordinal in two different object files could refer to two different
 * sections.  And further could have still different ordinals when combined
 * by the link-editor.  The value R_ABS is used for relocation entries for
 * absolute symbols which need no further relocation.
 */</span>

<span class="enscript-comment">/*
 * For RISC machines some of the references are split across two instructions
 * and the instruction does not contain the complete value of the reference.
 * In these cases a second, or paired relocation entry, follows each of these
 * relocation entries, using a PAIR r_type, which contains the other part of the
 * reference not contained in the instruction.  This other part is stored in the
 * pair's r_address field.  The exact number of bits of the other part of the
 * reference store in the r_address field is dependent on the particular
 * relocation type for the particular architecture.
 */</span>

<span class="enscript-comment">/*
 * To make scattered loading by the link editor work correctly &quot;local&quot;
 * relocation entries can't be used when the item to be relocated is the value
 * of a symbol plus an offset (where the resulting expresion is outside the
 * block the link editor is moving, a blocks are divided at symbol addresses).
 * In this case. where the item is a symbol value plus offset, the link editor
 * needs to know more than just the section the symbol was defined.  What is
 * needed is the actual value of the symbol without the offset so it can do the
 * relocation correctly based on where the value of the symbol got relocated to
 * not the value of the expression (with the offset added to the symbol value).
 * So for the NeXT 2.0 release no &quot;local&quot; relocation entries are ever used when
 * there is a non-zero offset added to a symbol.  The &quot;external&quot; and &quot;local&quot;
 * relocation entries remain unchanged.
 *
 * The implemention is quite messy given the compatibility with the existing
 * relocation entry format.  The ASSUMPTION is that a section will never be
 * bigger than 2**24 - 1 (0x00ffffff or 16,777,215) bytes.  This assumption
 * allows the r_address (which is really an offset) to fit in 24 bits and high
 * bit of the r_address field in the relocation_info structure to indicate
 * it is really a scattered_relocation_info structure.  Since these are only
 * used in places where &quot;local&quot; relocation entries are used and not where
 * &quot;external&quot; relocation entries are used the r_extern field has been removed.
 *
 * For scattered loading to work on a RISC machine where some of the references
 * are split across two instructions the link editor needs to be assured that
 * each reference has a unique 32 bit reference (that more than one reference is
 * NOT sharing the same high 16 bits for example) so it move each referenced
 * item independent of each other.  Some compilers guarantees this but the
 * compilers don't so scattered loading can be done on those that do guarantee
 * this.
 */</span>
#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__BIG_ENDIAN__</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__LITTLE_ENDIAN__</span>)
<span class="enscript-comment">/*
 * The reason for the ifdef's of __BIG_ENDIAN__ and __LITTLE_ENDIAN__ are that
 * when stattered relocation entries were added the mistake of using a mask
 * against a structure that is made up of bit fields was used.  To make this
 * design work this structure must be laid out in memory the same way so the
 * mask can be applied can check the same bit each time (r_scattered).
 */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* defined(__BIG_ENDIAN__) || defined(__LITTLE_ENDIAN__) */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">R_SCATTERED</span> 0x80000000	<span class="enscript-comment">/* mask to be applied to the r_address field 
				   of a relocation_info structure to tell that
				   is is really a scattered_relocation_info
				   stucture */</span>
<span class="enscript-type">struct</span> scattered_relocation_info {
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">__BIG_ENDIAN__</span>
   uint32_t	r_scattered:1,	<span class="enscript-comment">/* 1=scattered, 0=non-scattered (see above) */</span>
		<span class="enscript-reference">r_pcrel</span>:1, 	<span class="enscript-comment">/* was relocated pc relative already */</span>
		<span class="enscript-reference">r_length</span>:2,	<span class="enscript-comment">/* 0=byte, 1=word, 2=long, 3=quad */</span>
		<span class="enscript-reference">r_type</span>:4,	<span class="enscript-comment">/* if not 0, machine specific relocation type */</span>
   		<span class="enscript-reference">r_address</span>:24;	<span class="enscript-comment">/* offset in the section to what is being
				   relocated */</span>
   int32_t	r_value;	<span class="enscript-comment">/* the value the item to be relocated is
				   refering to (without any offset added) */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* __BIG_ENDIAN__ */</span>
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">__LITTLE_ENDIAN__</span>
   uint32_t
   		<span class="enscript-reference">r_address</span>:24,	<span class="enscript-comment">/* offset in the section to what is being
				   relocated */</span>
		<span class="enscript-reference">r_type</span>:4,	<span class="enscript-comment">/* if not 0, machine specific relocation type */</span>
		<span class="enscript-reference">r_length</span>:2,	<span class="enscript-comment">/* 0=byte, 1=word, 2=long, 3=quad */</span>
		<span class="enscript-reference">r_pcrel</span>:1, 	<span class="enscript-comment">/* was relocated pc relative already */</span>
		<span class="enscript-reference">r_scattered</span>:1;	<span class="enscript-comment">/* 1=scattered, 0=non-scattered (see above) */</span>
   int32_t	r_value;	<span class="enscript-comment">/* the value the item to be relocated is
				   refering to (without any offset added) */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* __LITTLE_ENDIAN__ */</span>
};

<span class="enscript-comment">/*
 * Relocation types used in a generic implementation.  Relocation entries for
 * normal things use the generic relocation as discribed above and their r_type
 * is GENERIC_RELOC_VANILLA (a value of zero).
 *
 * Another type of generic relocation, GENERIC_RELOC_SECTDIFF, is to support
 * the difference of two symbols defined in different sections.  That is the
 * expression &quot;symbol1 - symbol2 + constant&quot; is a relocatable expression when
 * both symbols are defined in some section.  For this type of relocation the
 * both relocations entries are scattered relocation entries.  The value of
 * symbol1 is stored in the first relocation entry's r_value field and the
 * value of symbol2 is stored in the pair's r_value field.
 *
 * A special case for a prebound lazy pointer is needed to beable to set the
 * value of the lazy pointer back to its non-prebound state.  This is done
 * using the GENERIC_RELOC_PB_LA_PTR r_type.  This is a scattered relocation
 * entry where the r_value feild is the value of the lazy pointer not prebound.
 */</span>
<span class="enscript-type">enum</span> reloc_type_generic
{
    GENERIC_RELOC_VANILLA,	<span class="enscript-comment">/* generic relocation as discribed above */</span>
    GENERIC_RELOC_PAIR,		<span class="enscript-comment">/* Only follows a GENERIC_RELOC_SECTDIFF */</span>
    GENERIC_RELOC_SECTDIFF,
    GENERIC_RELOC_PB_LA_PTR,	<span class="enscript-comment">/* prebound lazy pointer */</span>
    GENERIC_RELOC_LOCAL_SECTDIFF,
    GENERIC_RELOC_TLV		<span class="enscript-comment">/* thread local variables */</span>
};

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* _MACHO_RELOC_H_ */</span>
</pre>
<hr />
</body></html>