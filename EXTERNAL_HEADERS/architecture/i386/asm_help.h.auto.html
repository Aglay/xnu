<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>asm_help.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">asm_help.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/* Copyright (c) 1991 NeXT Computer, Inc.  All rights reserved.
 *
 *	File:	architecture/i386/asm_help.h
 *	Author:	Mike DeMoney, NeXT Computer, Inc.
 *	Modified for i386 by: Bruce Martin, NeXT Computer, Inc.
 *
 *	This header file defines macros useful when writing assembly code
 *	for the Intel i386 family processors.
 *
 * HISTORY
 * 10-Mar-92  Bruce Martin (<a href="mailto:bmartin@next.com">bmartin@next.com</a>)
 *	Adapted to i386
 * 23-Jan-91  Mike DeMoney (<a href="mailto:mike@next.com">mike@next.com</a>)
 *	Created.
 */</span>

#<span class="enscript-reference">ifndef</span>	<span class="enscript-variable-name">_ARCH_I386_ASM_HELP_H_</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">_ARCH_I386_ASM_HELP_H_</span>

#<span class="enscript-reference">include</span>	<span class="enscript-string">&lt;architecture/i386/reg_help.h&gt;</span>


#<span class="enscript-reference">ifdef</span>	<span class="enscript-variable-name">__ASSEMBLER__</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ALIGN</span>						\
	.align	2, 0x90

<span class="enscript-comment">/* Note that ROUND_TO_STACK rounds to Intel's stack alignment requirement,
 * but it is not sufficient for the Apple ABI which requires a 16-byte
 * aligned stack.  Various parts of the OS depend on this requirement,
 * including dyld.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ROUND_TO_STACK</span>(len)				\
	(((len) + STACK_INCR - 1) / STACK_INCR * STACK_INCR)

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">notdef</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CALL_MCOUNT</span>						\
	pushl	%ebp						;\
	movl	%esp, %ebp					;\
	.data							;\
	<span class="enscript-reference">1</span>: .<span class="enscript-type">long</span> 0						;\
	.text							;\
	lea 9b,%edx						;\
	call mcount						;\
	popl	%ebp						;
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CALL_MCOUNT</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">/*
 * Prologue for functions that may call other functions.  Saves
 * registers and sets up a C frame.
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">NESTED_FUNCTION_PROLOGUE</span>(localvarsize)			\
	.set	__framesize,ROUND_TO_STACK(localvarsize)	;\
	.set	__nested_function, 1				;\
	CALL_MCOUNT						\
	.<span class="enscript-keyword">if</span> __framesize						;\
	  pushl	%ebp						;\
	  movl	%esp, %ebp					;\
	  subl	$__framesize, %esp				;\
	.endif							;\
	pushl	%edi						;\
	pushl	%esi						;\
	pushl	%ebx

<span class="enscript-comment">/*
 * Prologue for functions that do not call other functions.  Does not
 * save registers (this is the functions responsibility).  Does set
 * up a C frame.
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">LEAF_FUNCTION_PROLOGUE</span>(localvarsize)			\
	.set	__framesize,ROUND_TO_STACK(localvarsize)	;\
	.set	__nested_function, 0				;\
	CALL_MCOUNT						\
	.<span class="enscript-keyword">if</span> __framesize						;\
	  pushl	%ebp						;\
	  movl	%esp, %ebp					;\
	  subl	$__framesize, %esp				;\
	.endif

<span class="enscript-comment">/*
 * Prologue for any function.
 *
 * We assume that all Leaf functions will be responsible for saving any
 * local registers they clobber.
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">FUNCTION_EPILOGUE</span>					\
	.<span class="enscript-keyword">if</span> __nested_function					;\
	  popl	%ebx						;\
	  popl	%esi						;\
	  popl	%edi						;\
	.endif							;\
	.<span class="enscript-keyword">if</span> __framesize						;\
	  movl	%ebp, %esp					;\
	  popl	%ebp						;\
	.endif							;\
	ret


<span class="enscript-comment">/*
 * Macros for declaring procedures
 *
 * Use of these macros allows ctags to have a predictable way
 * to find various types of declarations.  They also simplify
 * inserting appropriate symbol table information.
 *
 * NOTE: these simple stubs will be replaced with more
 * complicated versions once we know what the linker and gdb
 * will require as far as register use masks and frame declarations.
 * These macros may also be ifdef'ed in the future to contain profiling
 * code.
 *
 */</span>

<span class="enscript-comment">/*
 * TEXT -- declare start of text segment
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">TEXT</span>						\
	.text

<span class="enscript-comment">/*
 * DATA -- declare start of data segment
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DATA</span>						\
	.data

<span class="enscript-comment">/*
 * LEAF -- declare global leaf procedure
 * NOTE: Control SHOULD NOT FLOW into a LEAF!  A LEAF should only
 * be jumped to.  (A leaf may do an align.)  Use a LABEL() if you
 * need control to flow into the label.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">LEAF</span>(name, localvarsize)			\
	.globl	name					;\
	ALIGN						;\
<span class="enscript-reference">name</span>:							;\
	LEAF_FUNCTION_PROLOGUE(localvarsize)

<span class="enscript-comment">/*
 * X_LEAF -- declare alternate global label for leaf
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">X_LEAF</span>(name, value)				\
	.globl	name					;\
	.set	name,value

<span class="enscript-comment">/*
 * P_LEAF -- declare private leaf procedure
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">P_LEAF</span>(name, localvarsize)			\
	ALIGN						;\
<span class="enscript-reference">name</span>:							;\
	LEAF_FUNCTION_PROLOGUE(localvarsize)

<span class="enscript-comment">/*
 * LABEL -- declare a global code label
 * MUST be used (rather than LEAF, NESTED, etc) if control
 * &quot;flows into&quot; the label.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">LABEL</span>(name)					\
	.globl	name					;\
<span class="enscript-reference">name</span>:

<span class="enscript-comment">/*
 * NESTED -- declare procedure that invokes other procedures
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">NESTED</span>(name, localvarsize)			\
	.globl	name					;\
	ALIGN						;\
<span class="enscript-reference">name</span>:							;\
	NESTED_FUNCTION_PROLOGUE(localvarsize)

<span class="enscript-comment">/*
 * X_NESTED -- declare alternate global label for nested proc
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">X_NESTED</span>(name, value)				\
	.globl	name					;\
	.set	name,value

<span class="enscript-comment">/*
 * P_NESTED -- declare private nested procedure
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">P_NESTED</span>(name, localvarsize)			\
	ALIGN						;\
<span class="enscript-reference">name</span>:							;\
	NESTED_FUNCTION_PROLOGUE(localvarsize)

<span class="enscript-comment">/*
 * END -- mark end of procedure
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">END</span>(name)					\
	FUNCTION_EPILOGUE


<span class="enscript-comment">/*
 * Storage definition macros
 * The main purpose of these is to allow an easy handle for ctags
 */</span>

<span class="enscript-comment">/*
 * IMPORT -- import symbol
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IMPORT</span>(name)					\
	.reference	name

<span class="enscript-comment">/*
 * ABS -- declare global absolute symbol
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ABS</span>(name, value)				\
	.globl	name					;\
	.set	name,value

<span class="enscript-comment">/*
 * P_ABS -- declare private absolute symbol
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">P_ABS</span>(name, value)				\
	.set	name,value

<span class="enscript-comment">/*
 * EXPORT -- declare global label for data
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">EXPORT</span>(name)					\
	.globl	name					;\
<span class="enscript-reference">name</span>:

<span class="enscript-comment">/*
 * BSS -- declare global zero'ed storage
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">BSS</span>(name,size)					\
	.comm	name,size


<span class="enscript-comment">/*
 * P_BSS -- declare private zero'ed storage
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">P_BSS</span>(name,size)				\
	.lcomm	name,size

<span class="enscript-comment">/*
 * dynamic/PIC macros for routines which reference external symbols
 */</span>

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__DYNAMIC__</span>)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">PICIFY</span>(var)					\
	call	1f					; \
<span class="enscript-reference">1</span>:							; \
	popl	%edx					; \
	movl	L ## var ## $non_lazy_ptr-1b(%edx),%edx

#<span class="enscript-reference">define</span> <span class="enscript-function-name">CALL_EXTERN_AGAIN</span>(func)	\
	PICIFY(func)		; \
	call	%edx

#<span class="enscript-reference">define</span> <span class="enscript-function-name">NON_LAZY_STUB</span>(var)	\
.non_lazy_symbol_pointer	; \
L ## var ## $non_lazy_ptr:	; \
.indirect_symbol var		; \
.<span class="enscript-type">long</span> 0				; \
.text

#<span class="enscript-reference">define</span> <span class="enscript-function-name">CALL_EXTERN</span>(func)	\
	CALL_EXTERN_AGAIN(func)	; \
	NON_LAZY_STUB(func)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">BRANCH_EXTERN</span>(func)	\
	PICIFY(func)		; \
	jmp	%edx		; \
	NON_LAZY_STUB(func)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PUSH_EXTERN</span>(var)	\
	PICIFY(var)		; \
	movl	(%edx),%edx	; \
	pushl	%edx		; \
	NON_LAZY_STUB(var)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">REG_TO_EXTERN</span>(reg, var)	\
	PICIFY(var)		; \
	movl	reg, (%edx)	; \
	NON_LAZY_STUB(var)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">EXTERN_TO_REG</span>(var, reg)				\
	call	1f					; \
<span class="enscript-reference">1</span>:							; \
	popl	%edx					; \
	movl	L ## var ##$non_lazy_ptr-1b(%edx),reg	; \
	NON_LAZY_STUB(var)


#<span class="enscript-reference">else</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">BRANCH_EXTERN</span>(func)	jmp	func
#<span class="enscript-reference">define</span> <span class="enscript-function-name">PUSH_EXTERN</span>(var)	pushl	var
#<span class="enscript-reference">define</span> <span class="enscript-function-name">CALL_EXTERN</span>(func)	call	func
#<span class="enscript-reference">define</span> <span class="enscript-function-name">CALL_EXTERN_AGAIN</span>(func)	call	func
#<span class="enscript-reference">define</span> <span class="enscript-function-name">REG_TO_EXTERN</span>(reg, var)	movl	reg, var
#<span class="enscript-reference">define</span> <span class="enscript-function-name">EXTERN_TO_REG</span>(var, reg)	movl	$ ## var, reg
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* __ASSEMBLER__ */</span>

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* _ARCH_I386_ASM_HELP_H_ */</span>
</pre>
<hr />
</body></html>