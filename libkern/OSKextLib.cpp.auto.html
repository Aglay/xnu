<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>OSKextLib.cpp</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">OSKextLib.cpp&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2008-2012 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> {
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/OSKextLibPrivate.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/mkext.h&gt;</span>
};

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSContainers.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSKext.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/OSKextLib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/OSKextLibPrivate.h&gt;</span>

<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> {

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PRAGMA_MARK</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> <span class="enscript-variable-name">C</span>-<span class="enscript-variable-name">based</span> <span class="enscript-variable-name">kext</span> <span class="enscript-variable-name">interface</span> (<span class="enscript-variable-name">loading</span>/<span class="enscript-variable-name">loaded</span> <span class="enscript-variable-name">kexts</span> <span class="enscript-variable-name">only</span>)
#<span class="enscript-reference">endif</span>
<span class="enscript-comment">/*********************************************************************
*********************************************************************/</span>
kern_return_t <span class="enscript-function-name">OSKextLoadKextWithIdentifier</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> * bundle_id)
{
    <span class="enscript-keyword">return</span> OSKext::loadKextWithIdentifier(bundle_id);
}

<span class="enscript-comment">/*********************************************************************
*********************************************************************/</span>
uint32_t
<span class="enscript-function-name">OSKextGetLoadTagForIdentifier</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> * kextIdentifier)
{
    uint32_t result  = kOSKextInvalidLoadTag;
    OSKext * theKext = NULL;  <span class="enscript-comment">// must release
</span>
    <span class="enscript-keyword">if</span> (!kextIdentifier) {
        <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
    }

    theKext = OSKext::lookupKextWithIdentifier(kextIdentifier);
    <span class="enscript-keyword">if</span> (theKext &amp;&amp; theKext-&gt;isLoaded()) {
        result = theKext-&gt;getLoadTag();
    }
<span class="enscript-reference">finish</span>:
    <span class="enscript-keyword">if</span> (theKext) theKext-&gt;release();
    <span class="enscript-keyword">return</span> result;
}

<span class="enscript-comment">/*********************************************************************
*********************************************************************/</span>
OSReturn <span class="enscript-function-name">OSKextRetainKextWithLoadTag</span>(uint32_t loadTag)
{
    OSReturn   result = kOSKextReturnNotFound;
    OSKext   * theKext = NULL;  <span class="enscript-comment">// do not release; as this function is a retain
</span>
    <span class="enscript-keyword">if</span> (loadTag == kOSKextInvalidLoadTag) {
        result = kOSKextReturnInvalidArgument;
        <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
    }
    theKext = OSKext::lookupKextWithLoadTag(loadTag);
    <span class="enscript-keyword">if</span> (theKext) {
        result = kOSReturnSuccess;

        OSKextLog(theKext,
            kOSKextLogDebugLevel |
            kOSKextLogKextBookkeepingFlag,
            <span class="enscript-string">&quot;Kext %s (load tag %d) has been retained.&quot;</span>,
            theKext-&gt;getIdentifierCString(),
            loadTag);

       <span class="enscript-comment">/* Call this after so a log message about autounload comes second.
        */</span>
        theKext-&gt;setAutounloadEnabled(true);
    } <span class="enscript-keyword">else</span> {
        OSKextLog(theKext,
            kOSKextLogErrorLevel |
            kOSKextLogKextBookkeepingFlag,
            <span class="enscript-string">&quot;Can't retain kext with load tag %d - no such kext is loaded.&quot;</span>,
           loadTag);
    }
<span class="enscript-reference">finish</span>:
    <span class="enscript-keyword">return</span> result;
}

<span class="enscript-comment">/*********************************************************************
*********************************************************************/</span>
OSReturn <span class="enscript-function-name">OSKextReleaseKextWithLoadTag</span>(uint32_t loadTag)
{
    OSReturn result  = kOSKextReturnNotFound;
    OSKext * theKext = NULL;  <span class="enscript-comment">// must release twice!
</span>    
    <span class="enscript-keyword">if</span> (loadTag == kOSKextInvalidLoadTag) {
        result = kOSKextReturnInvalidArgument;
        <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
    }
    theKext = OSKext::lookupKextWithLoadTag(loadTag);
    <span class="enscript-keyword">if</span> (theKext) {
        result = kOSReturnSuccess;
        <span class="enscript-reference">OSKext</span>::considerUnloads();  <span class="enscript-comment">// schedule autounload pass
</span>        theKext-&gt;release();  <span class="enscript-comment">// do the release the caller wants
</span>        theKext-&gt;release();  <span class="enscript-comment">// now do the release on the lookup
</span>        OSKextLog(theKext,
            kOSKextLogDebugLevel |
            kOSKextLogKextBookkeepingFlag,
            <span class="enscript-string">&quot;Kext %s (load tag %d) has been released.&quot;</span>,
            theKext-&gt;getIdentifierCString(),
            loadTag);
    } <span class="enscript-keyword">else</span> {
        OSKextLog(theKext,
            kOSKextLogErrorLevel |
            kOSKextLogKextBookkeepingFlag,
            <span class="enscript-string">&quot;Can't release kext with load tag %d - no such kext is loaded.&quot;</span>,
           loadTag);
    }
    
    <span class="enscript-comment">// xxx - should I check that the refcount of the OSKext is above the lower bound?
</span>    <span class="enscript-comment">// xxx - do we want a OSKextGetRetainCountOfKextWithLoadTag()?
</span><span class="enscript-reference">finish</span>:
    <span class="enscript-keyword">return</span> result;
}

<span class="enscript-comment">/*********************************************************************
* Not to be called by the kext being unloaded!
*********************************************************************/</span>
OSReturn <span class="enscript-function-name">OSKextUnloadKextWithLoadTag</span>(uint32_t loadTag)
{
    <span class="enscript-keyword">return</span> OSKext::removeKextWithLoadTag(loadTag,
        <span class="enscript-comment">/* terminateServicesAndRemovePersonalitiesFlag */</span> false);
}


#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PRAGMA_MARK</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> <span class="enscript-variable-name">Kext</span> <span class="enscript-variable-name">Requests</span>
#<span class="enscript-reference">endif</span>
<span class="enscript-comment">/*********************************************************************
* Kext Requests
*********************************************************************/</span>
OSReturn <span class="enscript-function-name">OSKextRequestResource</span>(
    <span class="enscript-type">const</span> <span class="enscript-type">char</span>                    * kextIdentifier,
    <span class="enscript-type">const</span> <span class="enscript-type">char</span>                    * resourceName,
    OSKextRequestResourceCallback   callback,
    <span class="enscript-type">void</span>                          * context,
    OSKextRequestTag              * requestTagOut)
{
    <span class="enscript-keyword">return</span> OSKext::requestResource(kextIdentifier, resourceName,
        callback, context, requestTagOut);
}

<span class="enscript-comment">/*********************************************************************
*********************************************************************/</span>
OSReturn <span class="enscript-function-name">OSKextCancelRequest</span>(
    OSKextRequestTag    requestTag,
    <span class="enscript-type">void</span>             ** contextOut)
{
    <span class="enscript-keyword">return</span> OSKext::cancelRequest(requestTag, contextOut);
}

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PRAGMA_MARK</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> <span class="enscript-variable-name">MIG</span> <span class="enscript-variable-name">Functions</span> &amp; <span class="enscript-variable-name">Wrappers</span>
#<span class="enscript-reference">endif</span>
<span class="enscript-comment">/*********************************************************************
* IMPORTANT: Once we have done the vm_map_copyout(), we *must* return
* KERN_SUCCESS or the kernel map gets messed up (reason as yet
* unknown). We use op_result to return the real result of our work.
*********************************************************************/</span>
kern_return_t <span class="enscript-function-name">kext_request</span>(
    host_priv_t                             hostPriv,
    <span class="enscript-comment">/* in only */</span>  uint32_t                 clientLogSpec,
    <span class="enscript-comment">/* in only */</span>  vm_offset_t              requestIn,
    <span class="enscript-comment">/* in only */</span>  mach_msg_type_number_t   requestLengthIn,
    <span class="enscript-comment">/* out only */</span> vm_offset_t            * responseOut,
    <span class="enscript-comment">/* out only */</span> mach_msg_type_number_t * responseLengthOut,
    <span class="enscript-comment">/* out only */</span> vm_offset_t            * logDataOut,
    <span class="enscript-comment">/* out only */</span> mach_msg_type_number_t * logDataLengthOut,
    <span class="enscript-comment">/* out only */</span> kern_return_t          * op_result)
{
    kern_return_t     result          = KERN_FAILURE;
    vm_map_address_t  map_addr        = 0;     <span class="enscript-comment">// do not free/deallocate
</span>    <span class="enscript-type">char</span>            * request         = NULL;  <span class="enscript-comment">// must vm_deallocate
</span>
    mkext2_header   * mkextHeader     = NULL;  <span class="enscript-comment">// do not release
</span>    <span class="enscript-type">bool</span>              isMkext         = false;

    <span class="enscript-type">char</span>            * response        = NULL;  <span class="enscript-comment">// must kmem_free
</span>    uint32_t          responseLength  = 0;
    <span class="enscript-type">char</span>            * logData         = NULL;  <span class="enscript-comment">// must kmem_free
</span>    uint32_t          logDataLength   = 0;

   <span class="enscript-comment">/* MIG doesn't pass &quot;out&quot; parameters as empty, so clear them immediately
    * just in case, or MIG will try to copy out bogus data.
    */</span>    
    *op_result = KERN_FAILURE;
    *responseOut = NULL;
    *responseLengthOut = 0;
    *logDataOut = NULL;
    *logDataLengthOut = 0;

   <span class="enscript-comment">/* Check for input. Don't discard what isn't there, though.
    */</span>
    <span class="enscript-keyword">if</span> (!requestLengthIn || !requestIn) {
		OSKextLog(<span class="enscript-comment">/* kext */</span> NULL,
            kOSKextLogErrorLevel |
            kOSKextLogIPCFlag,
            <span class="enscript-string">&quot;Invalid request from user space (no data).&quot;</span>);
        *op_result = KERN_INVALID_ARGUMENT;
        <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
    }

   <span class="enscript-comment">/* Once we have done the vm_map_copyout(), we *must* return KERN_SUCCESS
    * or the kernel map gets messed up (reason as yet unknown). We will use
    * op_result to return the real result of our work.
    */</span>
    result = vm_map_copyout(kernel_map, &amp;map_addr, (vm_map_copy_t)requestIn);
    <span class="enscript-keyword">if</span> (result != KERN_SUCCESS) {
        OSKextLog(<span class="enscript-comment">/* kext */</span> NULL,
            kOSKextLogErrorLevel |
            kOSKextLogIPCFlag,
            <span class="enscript-string">&quot;vm_map_copyout() failed for request from user space.&quot;</span>);
        vm_map_copy_discard((vm_map_copy_t)requestIn);
        <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
    }
    request = CAST_DOWN(<span class="enscript-type">char</span> *, map_addr);

   <span class="enscript-comment">/* Check if request is an mkext; this is always a load request
    * and requires root access. If it isn't an mkext, see if it's
    * an XML request, and check the request to see if that requires
    * root access.
    */</span>
    <span class="enscript-keyword">if</span> (requestLengthIn &gt; <span class="enscript-keyword">sizeof</span>(mkext2_header)) {
        mkextHeader = (mkext2_header *)request;
        <span class="enscript-keyword">if</span> (MKEXT_GET_MAGIC(mkextHeader) == MKEXT_MAGIC &amp;&amp;
            MKEXT_GET_SIGNATURE(mkextHeader) == MKEXT_SIGN) {

            isMkext = true;
        }
    }

    <span class="enscript-keyword">if</span> (isMkext) {
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">SECURE_KERNEL</span>
        <span class="enscript-comment">// xxx - something tells me if we have a secure kernel we don't even
</span>        <span class="enscript-comment">// xxx - want to log a message here. :-)
</span>        *op_result = KERN_NOT_SUPPORTED;
        <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
#<span class="enscript-reference">else</span>
        <span class="enscript-comment">// xxx - can we find out if calling task is kextd?
</span>        <span class="enscript-comment">// xxx - can we find the name of the calling task?
</span>        <span class="enscript-keyword">if</span> (hostPriv == HOST_PRIV_NULL) {
            OSKextLog(<span class="enscript-comment">/* kext */</span> NULL,
                kOSKextLogErrorLevel |
                kOSKextLogLoadFlag | kOSKextLogIPCFlag,
                <span class="enscript-string">&quot;Attempt by non-root process to load a kext.&quot;</span>);
            *op_result = kOSKextReturnNotPrivileged;
            <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
        }

        *op_result = OSKext::loadFromMkext((OSKextLogSpec)clientLogSpec,
            request, requestLengthIn,
            &amp;logData, &amp;logDataLength);

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* defined(SECURE_KERNEL) */</span>

    } <span class="enscript-keyword">else</span> {

       <span class="enscript-comment">/* If the request isn't an mkext, then is should be XML. Parse it
        * if possible and hand the request over to OSKext.
        */</span>
        *op_result = OSKext::handleRequest(hostPriv,
            (OSKextLogSpec)clientLogSpec,
            request, requestLengthIn,
            &amp;response, &amp;responseLength,
            &amp;logData, &amp;logDataLength);
    }

    <span class="enscript-keyword">if</span> (response &amp;&amp; responseLength &gt; 0) {
        kern_return_t copyin_result;

        copyin_result = vm_map_copyin(kernel_map,
            CAST_USER_ADDR_T(response), responseLength,
            <span class="enscript-comment">/* src_destroy */</span> false, (vm_map_copy_t *)responseOut);
        <span class="enscript-keyword">if</span> (copyin_result == KERN_SUCCESS) {
            *responseLengthOut = responseLength;
        } <span class="enscript-keyword">else</span> {
            OSKextLog(<span class="enscript-comment">/* kext */</span> NULL,
                kOSKextLogErrorLevel |
                kOSKextLogIPCFlag,
                <span class="enscript-string">&quot;Failed to copy response to request from user space.&quot;</span>);
            *op_result = copyin_result;  <span class="enscript-comment">// xxx - should we map to our own code?
</span>            *responseOut = NULL;
            *responseLengthOut = 0;
            <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
        }
    }

    <span class="enscript-keyword">if</span> (logData &amp;&amp; logDataLength &gt; 0) {
        kern_return_t copyin_result;

        copyin_result = vm_map_copyin(kernel_map,
            CAST_USER_ADDR_T(logData), logDataLength,
            <span class="enscript-comment">/* src_destroy */</span> false, (vm_map_copy_t *)logDataOut);
        <span class="enscript-keyword">if</span> (copyin_result == KERN_SUCCESS) {
            *logDataLengthOut = logDataLength;
        } <span class="enscript-keyword">else</span> {
            OSKextLog(<span class="enscript-comment">/* kext */</span> NULL,
                kOSKextLogErrorLevel |
                kOSKextLogIPCFlag,
                <span class="enscript-string">&quot;Failed to copy log data for request from user space.&quot;</span>);
            *op_result = copyin_result;  <span class="enscript-comment">// xxx - should we map to our own code?
</span>            *logDataOut = NULL;
            *logDataLengthOut = 0;
            <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
        }
    }

<span class="enscript-reference">finish</span>:
    <span class="enscript-keyword">if</span> (request) {
        (<span class="enscript-type">void</span>)vm_deallocate(kernel_map, (vm_offset_t)request, requestLengthIn);
    }
    <span class="enscript-keyword">if</span> (response) {
        <span class="enscript-comment">/* 11981737 - clear uninitialized data in last page */</span>
        kmem_free(kernel_map, (vm_offset_t)response, round_page(responseLength));
    }
    <span class="enscript-keyword">if</span> (logData) {
        <span class="enscript-comment">/* 11981737 - clear uninitialized data in last page */</span>
        kmem_free(kernel_map, (vm_offset_t)logData, round_page(logDataLength));
    }

    <span class="enscript-keyword">return</span> result;
}

<span class="enscript-comment">/*********************************************************************
* Gets the vm_map for the current kext
*********************************************************************/</span>
<span class="enscript-type">extern</span> vm_offset_t segPRELINKB;
<span class="enscript-type">extern</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> segSizePRELINK;
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> kth_started;
<span class="enscript-type">extern</span> vm_map_t g_kext_map;

vm_map_t
<span class="enscript-function-name">kext_get_vm_map</span>(kmod_info_t *info)
{
    vm_map_t kext_map = NULL;

    <span class="enscript-comment">/* Set the vm map */</span>
    <span class="enscript-keyword">if</span> ((info-&gt;address &gt;= segPRELINKB) &amp;&amp; 
            (info-&gt;address &lt; (segPRELINKB + segSizePRELINK)))
    {
        kext_map = kernel_map;
    } <span class="enscript-keyword">else</span> {
        kext_map = g_kext_map;
    }

    <span class="enscript-keyword">return</span> kext_map;
}


#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PRAGMA_MARK</span>
<span class="enscript-comment">/********************************************************************/</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> <span class="enscript-variable-name">Weak</span> <span class="enscript-variable-name">linking</span> <span class="enscript-variable-name">support</span>
<span class="enscript-comment">/********************************************************************/</span>
#<span class="enscript-reference">endif</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">kext_weak_symbol_referenced</span>(<span class="enscript-type">void</span>)
{
    panic(<span class="enscript-string">&quot;A kext referenced an unresolved weak symbol\n&quot;</span>);
}

<span class="enscript-type">const</span> <span class="enscript-type">void</span> *gOSKextUnresolved = (<span class="enscript-type">const</span> <span class="enscript-type">void</span> *)&amp;kext_weak_symbol_referenced;

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PRAGMA_MARK</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> <span class="enscript-variable-name">Kernel</span>-<span class="enscript-variable-name">Internal</span> <span class="enscript-variable-name">C</span> <span class="enscript-variable-name">Functions</span>
#<span class="enscript-reference">endif</span>
<span class="enscript-comment">/*********************************************************************
* Called from startup.c.
*********************************************************************/</span>
<span class="enscript-type">void</span> <span class="enscript-function-name">OSKextRemoveKextBootstrap</span>(<span class="enscript-type">void</span>)
{
    <span class="enscript-reference">OSKext</span>::removeKextBootstrap();
    <span class="enscript-keyword">return</span>;
}

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_DTRACE</span>
<span class="enscript-comment">/*********************************************************************
*********************************************************************/</span>
<span class="enscript-type">void</span> <span class="enscript-function-name">OSKextRegisterKextsWithDTrace</span>(<span class="enscript-type">void</span>)
{
    <span class="enscript-reference">OSKext</span>::registerKextsWithDTrace();
    <span class="enscript-keyword">return</span>;
}
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CONFIG_DTRACE */</span>

<span class="enscript-comment">/*********************************************************************
*********************************************************************/</span>
<span class="enscript-type">void</span> <span class="enscript-function-name">kext_dump_panic_lists</span>(<span class="enscript-type">int</span> (*printf_func)(<span class="enscript-type">const</span> <span class="enscript-type">char</span> * fmt, ...))
{
    <span class="enscript-reference">OSKext</span>::printKextPanicLists(printf_func);
    <span class="enscript-keyword">return</span>;
}

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PRAGMA_MARK</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> <span class="enscript-variable-name">Kmod</span> <span class="enscript-variable-name">Compatibility</span> <span class="enscript-variable-name">Functions</span>
#<span class="enscript-reference">endif</span>
<span class="enscript-comment">/*********************************************************************
**********************************************************************
*                    KMOD COMPATIBILITY FUNCTIONS                    *
*              (formerly in kmod.c, or C++ bridges from)             *
**********************************************************************
**********************************************************************
* These two functions are used in various places in the kernel, but
* are not exported. We might rename them at some point to start with
* kext_ or OSKext.
*
* kmod_panic_dump() must not be called outside of a panic context.
* kmod_dump_log() must not be called in a panic context.
*********************************************************************/</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">kmod_panic_dump</span>(vm_offset_t * addr, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> cnt)
{
    <span class="enscript-type">extern</span> <span class="enscript-type">int</span> kdb_printf(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *format, ...) __printflike(1,2);

    <span class="enscript-reference">OSKext</span>::printKextsInBacktrace(addr, cnt, &amp;kdb_printf,
        <span class="enscript-comment">/* takeLock? */</span> false, false);
    <span class="enscript-keyword">return</span>;
}

<span class="enscript-comment">/********************************************************************/</span>
<span class="enscript-type">void</span> <span class="enscript-function-name">kmod_dump_log</span>(vm_offset_t *addr, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> cnt, boolean_t doUnslide);

<span class="enscript-type">void</span>
<span class="enscript-function-name">kmod_dump_log</span>(
    vm_offset_t * addr,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> cnt,
    boolean_t doUnslide)
{
    <span class="enscript-reference">OSKext</span>::printKextsInBacktrace(addr, cnt, &amp;printf, <span class="enscript-comment">/* lock? */</span> true, doUnslide);
}

<span class="enscript-comment">/*********************************************************************
* Compatibility implementation for kmod_get_info() host_priv routine.
* Only supported on old 32-bit architectures.
*********************************************************************/</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PRAGMA_MARK</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> <span class="enscript-variable-name">Loaded</span> <span class="enscript-variable-name">Kext</span> <span class="enscript-variable-name">Summary</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-type">void</span> 
<span class="enscript-function-name">OSKextLoadedKextSummariesUpdated</span>(<span class="enscript-type">void</span>)
{
    <span class="enscript-comment">// Do nothing.
</span>}

};
</pre>
<hr />
</body></html>