<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>kxld_array.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">kxld_array.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2008 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_KXLD_ARRAY_H_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_KXLD_ARRAY_H_</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/queue.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/types.h&gt;</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">KERNEL</span>
    #include &lt;libkern/kxld_types.h&gt;
#<span class="enscript-reference">else</span> 
    #include <span class="enscript-string">&quot;kxld_types.h&quot;</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">/*******************************************************************************
* This is a resizeable array implementation designed primarily to maximize
* memory reuse.  The array should only be allocated once, but it can be
* initialized many times.  It persists its memory across initializations, and
* reallocates only if it needs to grow the internal array, such that memory
* allocation churn is eliminated.  Growth is accomodated by building a linked
* list of identically sized arrays.  These arrays can be consolidated into
* one large array in the init function.
*
* A technique commonly used in kxld is to make an array of objects that
* themselves contain kxld_arrays.  To minimize memory churn across links, only 
* the individual objects contained in an array should be cleared at the end of
* each link, such that they are in a state ready for reinitialization with the 
* memory they have already allocated.  The array that contains them should not 
* be cleared.  After all links are complete, to ensure that all memory is 
* properly freed, one should call kxld_array_get_slot to walk the entire 
* allocated space of the array and clean up all potential instances contained 
* therein.  Since this technique is somewhat fragile, there are certain 
* requirements that must be met, and guarantees that the array implementation 
* provides.
*
* Requirements:
*   - A newly allocated, uninitialized array object must be zeroed out before
*     it is initialized
*   - The objects stored in the array that will be reused must consider
*     being bzeroed a valid initial state.  Specifially, they must check that
*     pointers they contain are nonnull before they are freed or followed
*     at both construction and destruction time.
*
* Guarantees:
*   - The init function will always bzero newly allocated memory.  If memory
*     is added by resizing, it will bzero only the newly allocated portion.
*   - clear, deinit, and copy are the only functions that will change the
*     contents of initialized memory.
*   - The reset, clear, deinit functions will accept a NULL pointer to an array.
*******************************************************************************/</span>

<span class="enscript-function-name">STAILQ_HEAD</span>(kxld_array_head, kxld_array_pool);

<span class="enscript-type">struct</span> kxld_array {
    <span class="enscript-type">struct</span> kxld_array_head pools;
    size_t itemsize;            <span class="enscript-comment">/* The size of the items that the array contains */</span>
    size_t pool_capacity;       <span class="enscript-comment">/* The size of each pool's internal buffer */</span>
    u_int pool_maxitems;        <span class="enscript-comment">/* The maximum number of items each pool can hold
                                 * given the current size of each pool's buffer.
                                 */</span>
    u_int nitems;               <span class="enscript-comment">/* The current number of items this array contains */</span>
    u_int maxitems;             <span class="enscript-comment">/* The maximum number of items this array can contain */</span>
    u_int npools;               <span class="enscript-comment">/* The number of pools in the pool list */</span>
};

<span class="enscript-type">struct</span> kxld_array_pool {
    STAILQ_ENTRY(kxld_array_pool) entries;
    u_char *buffer;             <span class="enscript-comment">/* The internal memory buffer */</span>
    u_int nitems;               <span class="enscript-comment">/* The number of items the array contains */</span>
};

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> kxld_array KXLDArray;
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> kxld_array_head KXLDArrayHead;
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> kxld_array_pool KXLDArrayPool;

<span class="enscript-comment">/*******************************************************************************
* Constructors and Destructors
*******************************************************************************/</span>

<span class="enscript-comment">/* Initializes the array's capacity to a minimum of nitems * itemsize */</span>
kern_return_t <span class="enscript-function-name">kxld_array_init</span>(KXLDArray *array, size_t itemsize, u_int nitems)
    __attribute__((nonnull, visibility(<span class="enscript-string">&quot;hidden&quot;</span>)));

<span class="enscript-comment">/* Performs a deep copy of the array */</span>
kern_return_t <span class="enscript-function-name">kxld_array_copy</span>(KXLDArray *array, <span class="enscript-type">const</span> KXLDArray *src)
    __attribute__((nonnull, visibility(<span class="enscript-string">&quot;hidden&quot;</span>)));

<span class="enscript-comment">/* Sets the number of items in the array to 0 */</span>
<span class="enscript-type">void</span> <span class="enscript-function-name">kxld_array_reset</span>(KXLDArray *array)
    __attribute__((visibility(<span class="enscript-string">&quot;hidden&quot;</span>)));

<span class="enscript-comment">/* Zeroes out the array and sets nitems to 0 */</span>
<span class="enscript-type">void</span> <span class="enscript-function-name">kxld_array_clear</span>(KXLDArray *array)
    __attribute__((visibility(<span class="enscript-string">&quot;hidden&quot;</span>)));

<span class="enscript-comment">/* Frees the array's internal buffer */</span>
<span class="enscript-type">void</span> <span class="enscript-function-name">kxld_array_deinit</span>(KXLDArray *array)
    __attribute__((visibility(<span class="enscript-string">&quot;hidden&quot;</span>)));

<span class="enscript-comment">/*******************************************************************************
* Accessors 
*******************************************************************************/</span>

<span class="enscript-comment">/* Returns the item at the specified index, or NULL if idx &gt; nitems */</span>
<span class="enscript-type">void</span> *<span class="enscript-function-name">kxld_array_get_item</span>(<span class="enscript-type">const</span> KXLDArray *array, u_int idx)
    __attribute__((pure, nonnull, visibility(<span class="enscript-string">&quot;hidden&quot;</span>)));

<span class="enscript-comment">/* Returns the item at the specified index, or NULL if idx &gt; maxitems */</span>
<span class="enscript-type">void</span> *<span class="enscript-function-name">kxld_array_get_slot</span>(<span class="enscript-type">const</span> KXLDArray *array, u_int idx)
    __attribute__((pure, nonnull, visibility(<span class="enscript-string">&quot;hidden&quot;</span>)));

<span class="enscript-comment">/* Returns the index of a specified item in the array */</span>
kern_return_t <span class="enscript-function-name">kxld_array_get_index</span>(<span class="enscript-type">const</span> KXLDArray *array, <span class="enscript-type">const</span> <span class="enscript-type">void</span> *item, 
    u_int *idx)
    __attribute__((nonnull, visibility(<span class="enscript-string">&quot;hidden&quot;</span>)));

<span class="enscript-comment">/*******************************************************************************
* Modifiers
*******************************************************************************/</span>

<span class="enscript-comment">/* Grows the array to contain a minimum of nitems.  If extra memory is needed,
 * it will allocate a pool and add it to the list of pools maintained by this
 * array.
 */</span>
kern_return_t <span class="enscript-function-name">kxld_array_resize</span>(KXLDArray *array, u_int nitems)
    __attribute__((nonnull, visibility(<span class="enscript-string">&quot;hidden&quot;</span>)));

<span class="enscript-comment">/* Removes an element from the array.  This is only supported for arrays with
 * a single pool.
 */</span>
kern_return_t <span class="enscript-function-name">kxld_array_remove</span>(KXLDArray *array, u_int idx)
    __attribute__((nonnull, visibility(<span class="enscript-string">&quot;hidden&quot;</span>)));

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* _KXLD_ARRAY_H_ */</span>
</pre>
<hr />
</body></html>