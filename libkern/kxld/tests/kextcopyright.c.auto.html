<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>kextcopyright.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">kextcopyright.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2009 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdio.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;CoreFoundation/CoreFoundation.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kxld.h&gt;</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kCFBundleGetInfoStringKey</span> CFSTR(<span class="enscript-string">&quot;CFBundleGetInfoString&quot;</span>)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kNSHumanReadableCopyrightKey</span> CFSTR(<span class="enscript-string">&quot;NSHumanReadableCopyright&quot;</span>)

<span class="enscript-type">const</span> <span class="enscript-type">char</span> *gProgname = NULL;

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">usage</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">printFormat</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">static</span> <span class="enscript-type">char</span> *<span class="enscript-function-name">convert_cfstring</span>(CFStringRef the_string);

<span class="enscript-comment">/******************************************************************************
******************************************************************************/</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">usage</span>(<span class="enscript-type">void</span>)
{
    printf(<span class="enscript-string">&quot;usage: %s [path to kext]\n\n&quot;</span>
           <span class="enscript-string">&quot;This program validates the copyright string in a kext's info &quot;</span>
           <span class="enscript-string">&quot;dictionary.\n\n&quot;</span>, gProgname);

    printFormat();
}

<span class="enscript-comment">/******************************************************************************
******************************************************************************/</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">printFormat</span>(<span class="enscript-type">void</span>)
{
    fprintf(stderr, 
        <span class="enscript-string">&quot;The copyright string should be contained in the NSHumanReadableCopyright key.\n&quot;</span>
        <span class="enscript-string">&quot;It should be of the format:\n&quot;</span>
        <span class="enscript-string">&quot;\tCopyright © [year(s) of publication] Apple Inc. All rights reserved.\n\n&quot;</span>
        <span class="enscript-string">&quot;where [year(s) of publication] is a comma-separated list of years and/or\n&quot;</span>
        <span class="enscript-string">&quot;year ranges, e.g., 2004, 2006-2008.  Years must be four digits.  Year ranges\n&quot;</span>
        <span class="enscript-string">&quot;may not contain spaces and must use four digits for both years.\n\n&quot;</span>
        <span class="enscript-string">&quot;The following are examples of valid copyright strings:\n&quot;</span>
        <span class="enscript-string">&quot;\tCopyright © 2008 Apple Inc. All rights reserved.\n&quot;</span>
        <span class="enscript-string">&quot;\tCopyright © 2004-2008 Apple Inc. All rights reserved.\n&quot;</span>
        <span class="enscript-string">&quot;\tCopyright © 1998,2000-2002,2004,2006-2008 Apple Inc. All rights reserved.\n&quot;</span>);
}

<span class="enscript-comment">/******************************************************************************
******************************************************************************/</span>
<span class="enscript-type">char</span> *
<span class="enscript-function-name">convert_cfstring</span>(CFStringRef the_string)
{
    <span class="enscript-type">char</span> *result = NULL;
    CFDataRef the_data = NULL;
    <span class="enscript-type">const</span> UInt8 *data_bytes = NULL;
    <span class="enscript-type">char</span> *converted_string = NULL;
    u_long converted_len = 0;
    u_long bytes_copied = 0;

    the_data = CFStringCreateExternalRepresentation(kCFAllocatorDefault,
        the_string, kCFStringEncodingUTF8, 0);
    <span class="enscript-keyword">if</span> (!the_data) {
        fprintf(stderr, <span class="enscript-string">&quot;Failed to convert string\n&quot;</span>);
        <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
    }

    data_bytes = CFDataGetBytePtr(the_data);
    <span class="enscript-keyword">if</span> (!data_bytes) {
        fprintf(stderr, <span class="enscript-string">&quot;Failed to get converted string bytes\n&quot;</span>);
        <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
    }

    converted_len = strlen((<span class="enscript-type">const</span> <span class="enscript-type">char</span> *)data_bytes) + 1; <span class="enscript-comment">// +1 for nul
</span>    converted_string = malloc(converted_len);
    <span class="enscript-keyword">if</span> (!converted_string) {
        fprintf(stderr, <span class="enscript-string">&quot;Failed to allocate memory\n&quot;</span>);
        <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
    }

    bytes_copied = strlcpy(converted_string, (<span class="enscript-type">const</span> <span class="enscript-type">char</span> *) data_bytes, 
        converted_len) + 1; <span class="enscript-comment">// +1 for nul
</span>    <span class="enscript-keyword">if</span> (bytes_copied != converted_len) {
        fprintf(stderr, <span class="enscript-string">&quot;Failed to copy converted string\n&quot;</span>);
        <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
    }

    result = converted_string;
<span class="enscript-reference">finish</span>:
    <span class="enscript-keyword">if</span> (the_data) CFRelease(the_data);
    <span class="enscript-keyword">return</span> result;
}

<span class="enscript-comment">/******************************************************************************
******************************************************************************/</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">main</span>(<span class="enscript-type">int</span> argc, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *argv[])
{
    <span class="enscript-type">int</span> result = 1;
    boolean_t infoCopyrightIsValid = false;
    boolean_t readableCopyrightIsValid = false;
    CFURLRef anURL = NULL;                      <span class="enscript-comment">// must release
</span>    CFBundleRef aBundle = NULL;                 <span class="enscript-comment">// must release
</span>    CFDictionaryRef aDict = NULL;               <span class="enscript-comment">// do not release
</span>    CFStringRef infoCopyrightString = NULL;     <span class="enscript-comment">// do not release
</span>    CFStringRef readableCopyrightString = NULL; <span class="enscript-comment">// do not release
</span>    <span class="enscript-type">char</span> *infoStr = NULL;                       <span class="enscript-comment">// must free
</span>    <span class="enscript-type">char</span> *readableStr = NULL;                   <span class="enscript-comment">// must free
</span>
    gProgname = argv[0];

    <span class="enscript-keyword">if</span> (argc != 2) {
        usage();
        <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
    }

    anURL = CFURLCreateFromFileSystemRepresentation(kCFAllocatorDefault,
        (<span class="enscript-type">const</span> UInt8 *) argv[1], strlen(argv[1]), <span class="enscript-comment">/* isDirectory */</span> FALSE);
    <span class="enscript-keyword">if</span> (!anURL) {
        fprintf(stderr, <span class="enscript-string">&quot;Can't create path from %s\n&quot;</span>, argv[1]);
        <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
    }

    aBundle = CFBundleCreate(kCFAllocatorDefault, anURL);
    <span class="enscript-keyword">if</span> (!aBundle) {
        fprintf(stderr, <span class="enscript-string">&quot;Can't create bundle at path %s\n&quot;</span>, argv[1]);
        <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
    }

    aDict = CFBundleGetInfoDictionary(aBundle);
    <span class="enscript-keyword">if</span> (!aDict) {
        fprintf(stderr, <span class="enscript-string">&quot;Can't get info dictionary from bundle\n&quot;</span>);
        <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
    }

    infoCopyrightString = CFDictionaryGetValue(aDict, kCFBundleGetInfoStringKey);
    readableCopyrightString = CFDictionaryGetValue(aDict, kNSHumanReadableCopyrightKey);

    <span class="enscript-keyword">if</span> (!infoCopyrightString &amp;&amp; !readableCopyrightString) {
        fprintf(stderr, <span class="enscript-string">&quot;This kext does not have a value for NSHumanReadableCopyright&quot;</span>);
        <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
    }

    <span class="enscript-keyword">if</span> (infoCopyrightString) {
        fprintf(stderr, <span class="enscript-string">&quot;Warning: This kext has a value for CFBundleGetInfoString.\n&quot;</span>
            <span class="enscript-string">&quot;This key is obsolete, and may be removed from the kext's Info.plist.\n&quot;</span>
            <span class="enscript-string">&quot;It has been replaced by CFBundleVersion and NSHumanReadableCopyright.\n\n&quot;</span>);

        infoStr = convert_cfstring(infoCopyrightString);
        <span class="enscript-keyword">if</span> (!infoStr) <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;

        infoCopyrightIsValid = kxld_validate_copyright_string(infoStr); 
    }

    <span class="enscript-keyword">if</span> (readableCopyrightString) {
        readableStr = convert_cfstring(readableCopyrightString);
        <span class="enscript-keyword">if</span> (!readableStr) <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;

        readableCopyrightIsValid = kxld_validate_copyright_string(readableStr);
    }

    <span class="enscript-keyword">if</span> (!readableCopyrightIsValid) {
        <span class="enscript-keyword">if</span> (infoCopyrightIsValid) {
            fprintf(stderr, <span class="enscript-string">&quot;Warning: The copyright string in NSHumanReadableCopyright is invalid,\n&quot;</span>
                    <span class="enscript-string">&quot;but the string in CFBundleGetInfoString is valid.  CFBundleGetInfoString is\n&quot;</span>
                    <span class="enscript-string">&quot;obsolete.  Please migrate your copyright string to NSHumanReadableCopyright.\n\n&quot;</span>);
        } <span class="enscript-keyword">else</span> {
            fprintf(stderr, <span class="enscript-string">&quot;Error: There is no valid copyright string for this kext.\n\n&quot;</span>);
            printFormat(); 
            <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
        }
    }

    result = 0;
<span class="enscript-reference">finish</span>:
    <span class="enscript-keyword">if</span> (anURL) CFRelease(anURL);
    <span class="enscript-keyword">if</span> (aBundle) CFRelease(aBundle);
    <span class="enscript-keyword">if</span> (infoStr) free(infoStr);
    <span class="enscript-keyword">if</span> (readableStr) free(readableStr);

    <span class="enscript-keyword">return</span> result;
}

</pre>
<hr />
</body></html>