<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>OSAtomicOperations.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">OSAtomicOperations.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000-2015 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/OSAtomic.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/debug.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;machine/atomic.h&gt;</span>

<span class="enscript-type">enum</span> {
	false	= 0,
	true	= 1
};

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">NULL</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">NULL</span> ((void *)0)
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ATOMIC_DEBUG</span> DEBUG

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">ATOMIC_DEBUG</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">ALIGN_TEST</span>(p,t) do{if((uintptr_t)p&amp;(sizeof(t)-1)) panic(<span class="enscript-string">&quot;Unaligned atomic pointer %p\n&quot;</span>,p);}while(0)
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">ALIGN_TEST</span>(p,t) do{}while(0)
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">// 19831745 - start of big hammer!
</span>#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">clang</span> <span class="enscript-variable-name">diagnostic</span> <span class="enscript-variable-name">push</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">clang</span> <span class="enscript-variable-name">diagnostic</span> <span class="enscript-variable-name">ignored</span> <span class="enscript-string">&quot;-Wcast-qual&quot;</span>

<span class="enscript-comment">/*
 * atomic operations
 *	These are _the_ atomic operations, now implemented via compiler built-ins.
 *	It is expected that this C implementation is a candidate for Link-Time-
 *	Optimization inlining, whereas the assembler implementations they replace
 *	were not.
 */</span>

#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">OSCompareAndSwap8</span>
Boolean <span class="enscript-function-name">OSCompareAndSwap8</span>(UInt8 oldValue, UInt8 newValue, <span class="enscript-type">volatile</span> UInt8 *address)
{
	<span class="enscript-keyword">return</span> __c11_atomic_compare_exchange_strong((_Atomic UInt8 *)address, &amp;oldValue, newValue,
			memory_order_acq_rel_smp, memory_order_relaxed);
}

#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">OSCompareAndSwap16</span>
Boolean <span class="enscript-function-name">OSCompareAndSwap16</span>(UInt16 oldValue, UInt16 newValue, <span class="enscript-type">volatile</span> UInt16 *address)
{
	<span class="enscript-keyword">return</span> __c11_atomic_compare_exchange_strong((_Atomic UInt16 *)address, &amp;oldValue, newValue,
			memory_order_acq_rel_smp, memory_order_relaxed);
}

#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">OSCompareAndSwap</span>
Boolean <span class="enscript-function-name">OSCompareAndSwap</span>(UInt32 oldValue, UInt32 newValue, <span class="enscript-type">volatile</span> UInt32 *address)
{
	ALIGN_TEST(address, UInt32);
	<span class="enscript-keyword">return</span> __c11_atomic_compare_exchange_strong((_Atomic UInt32 *)address, &amp;oldValue, newValue,
			memory_order_acq_rel_smp, memory_order_relaxed);
}

#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">OSCompareAndSwap64</span>
Boolean <span class="enscript-function-name">OSCompareAndSwap64</span>(UInt64 oldValue, UInt64 newValue, <span class="enscript-type">volatile</span> UInt64 *address)
{
	<span class="enscript-comment">/*
	 * _Atomic uint64 requires 8-byte alignment on all architectures.
	 * This silences the compiler cast warning.  ALIGN_TEST() verifies
	 * that the cast was legal, if defined.
	 */</span>
	_Atomic UInt64 *aligned_addr = (_Atomic UInt64 *)(uintptr_t)address;

	ALIGN_TEST(address, UInt64);
	<span class="enscript-keyword">return</span> __c11_atomic_compare_exchange_strong(aligned_addr, &amp;oldValue, newValue,
			memory_order_acq_rel_smp, memory_order_relaxed);
}

#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">OSCompareAndSwapPtr</span>
Boolean <span class="enscript-function-name">OSCompareAndSwapPtr</span>(<span class="enscript-type">void</span> *oldValue, <span class="enscript-type">void</span> *newValue, <span class="enscript-type">void</span> * <span class="enscript-type">volatile</span> *address)
{
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">__LP64__</span>
  <span class="enscript-keyword">return</span> OSCompareAndSwap64((UInt64)oldValue, (UInt64)newValue, (<span class="enscript-type">volatile</span> UInt64 *)address);
#<span class="enscript-reference">else</span>
  <span class="enscript-keyword">return</span> OSCompareAndSwap((UInt32)oldValue, (UInt32)newValue, (<span class="enscript-type">volatile</span> UInt32 *)address);
#<span class="enscript-reference">endif</span>
}

SInt8 <span class="enscript-function-name">OSAddAtomic8</span>(SInt32 amount, <span class="enscript-type">volatile</span> SInt8 *address)
{
	<span class="enscript-keyword">return</span> __c11_atomic_fetch_add((_Atomic SInt8*)address, amount, memory_order_relaxed);
}

SInt16 <span class="enscript-function-name">OSAddAtomic16</span>(SInt32 amount, <span class="enscript-type">volatile</span> SInt16 *address)
{
	<span class="enscript-keyword">return</span> __c11_atomic_fetch_add((_Atomic SInt16*)address, amount, memory_order_relaxed);
}

#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">OSAddAtomic</span>
SInt32 <span class="enscript-function-name">OSAddAtomic</span>(SInt32 amount, <span class="enscript-type">volatile</span> SInt32 *address)
{
	ALIGN_TEST(address, UInt32);
	<span class="enscript-keyword">return</span> __c11_atomic_fetch_add((_Atomic SInt32*)address, amount, memory_order_relaxed);
}

#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">OSAddAtomic64</span>
SInt64 <span class="enscript-function-name">OSAddAtomic64</span>(SInt64 amount, <span class="enscript-type">volatile</span> SInt64 *address)
{
	_Atomic SInt64*	aligned_address = (_Atomic SInt64*)(uintptr_t)address;

	ALIGN_TEST(address, SInt64);
	<span class="enscript-keyword">return</span> __c11_atomic_fetch_add(aligned_address, amount, memory_order_relaxed);
}

#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">OSAddAtomicLong</span>
<span class="enscript-type">long</span>
<span class="enscript-function-name">OSAddAtomicLong</span>(<span class="enscript-type">long</span> theAmount, <span class="enscript-type">volatile</span> <span class="enscript-type">long</span> *address)
{
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">__LP64__</span>
	<span class="enscript-keyword">return</span> (<span class="enscript-type">long</span>)OSAddAtomic64((SInt64)theAmount, (SInt64*)address);
#<span class="enscript-reference">else</span>
	<span class="enscript-keyword">return</span> (<span class="enscript-type">long</span>)OSAddAtomic((SInt32)theAmount, address);
#<span class="enscript-reference">endif</span>
}

#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">OSIncrementAtomic</span>
SInt32	OSIncrementAtomic(<span class="enscript-type">volatile</span> SInt32 * value)
{
	<span class="enscript-keyword">return</span> OSAddAtomic(1, value);
}

#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">OSDecrementAtomic</span>
SInt32	OSDecrementAtomic(<span class="enscript-type">volatile</span> SInt32 * value)
{
	<span class="enscript-keyword">return</span> OSAddAtomic(-1, value);
}

#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">OSBitAndAtomic</span>
UInt32	OSBitAndAtomic(UInt32 mask, <span class="enscript-type">volatile</span> UInt32 * value)
{
	<span class="enscript-keyword">return</span> __c11_atomic_fetch_and((_Atomic UInt32*)value, mask, memory_order_relaxed);
}

#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">OSBitOrAtomic</span>
UInt32	OSBitOrAtomic(UInt32 mask, <span class="enscript-type">volatile</span> UInt32 * value)
{
	<span class="enscript-keyword">return</span> __c11_atomic_fetch_or((_Atomic UInt32*)value, mask, memory_order_relaxed);
}

#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">OSBitXorAtomic</span>
UInt32	OSBitXorAtomic(UInt32 mask, <span class="enscript-type">volatile</span> UInt32 * value)
{
	<span class="enscript-keyword">return</span> __c11_atomic_fetch_xor((_Atomic UInt32*)value, mask, memory_order_relaxed);
}

<span class="enscript-type">static</span> Boolean	OSTestAndSetClear(UInt32 bit, Boolean wantSet, <span class="enscript-type">volatile</span> UInt8 * startAddress)
{
	UInt8		mask = 1;
	UInt8		oldValue;
	UInt8		wantValue;
	
	startAddress += (bit / 8);
	mask &lt;&lt;= (7 - (bit % 8));
	wantValue = wantSet ? mask : 0;
	
	<span class="enscript-keyword">do</span> {
		oldValue = *startAddress;
		<span class="enscript-keyword">if</span> ((oldValue &amp; mask) == wantValue) {
			<span class="enscript-keyword">break</span>;
		}
	} <span class="enscript-keyword">while</span> (! __c11_atomic_compare_exchange_strong((_Atomic UInt8 *)startAddress,
		&amp;oldValue, (oldValue &amp; ~mask) | wantValue, memory_order_relaxed, memory_order_relaxed));
	
	<span class="enscript-keyword">return</span> (oldValue &amp; mask) == wantValue;
}

Boolean <span class="enscript-function-name">OSTestAndSet</span>(UInt32 bit, <span class="enscript-type">volatile</span> UInt8 * startAddress)
{
	<span class="enscript-keyword">return</span> OSTestAndSetClear(bit, true, startAddress);
}

Boolean <span class="enscript-function-name">OSTestAndClear</span>(UInt32 bit, <span class="enscript-type">volatile</span> UInt8 * startAddress)
{
	<span class="enscript-keyword">return</span> OSTestAndSetClear(bit, false, startAddress);
}

<span class="enscript-comment">/*
 * silly unaligned versions
 */</span>

SInt8	OSIncrementAtomic8(<span class="enscript-type">volatile</span> SInt8 * value)
{
	<span class="enscript-keyword">return</span> OSAddAtomic8(1, value);
}

SInt8	OSDecrementAtomic8(<span class="enscript-type">volatile</span> SInt8 * value)
{
	<span class="enscript-keyword">return</span> OSAddAtomic8(-1, value);
}

UInt8	OSBitAndAtomic8(UInt32 mask, <span class="enscript-type">volatile</span> UInt8 * value)
{
	<span class="enscript-keyword">return</span> __c11_atomic_fetch_and((_Atomic UInt8 *)value, mask, memory_order_relaxed);
}

UInt8	OSBitOrAtomic8(UInt32 mask, <span class="enscript-type">volatile</span> UInt8 * value)
{
	<span class="enscript-keyword">return</span> __c11_atomic_fetch_or((_Atomic UInt8 *)value, mask, memory_order_relaxed);
}

UInt8	OSBitXorAtomic8(UInt32 mask, <span class="enscript-type">volatile</span> UInt8 * value)
{
	<span class="enscript-keyword">return</span> __c11_atomic_fetch_xor((_Atomic UInt8 *)value, mask, memory_order_relaxed);
}

SInt16	OSIncrementAtomic16(<span class="enscript-type">volatile</span> SInt16 * value)
{
	<span class="enscript-keyword">return</span> OSAddAtomic16(1, value);
}

SInt16	OSDecrementAtomic16(<span class="enscript-type">volatile</span> SInt16 * value)
{
	<span class="enscript-keyword">return</span> OSAddAtomic16(-1, value);
}

UInt16	OSBitAndAtomic16(UInt32 mask, <span class="enscript-type">volatile</span> UInt16 * value)
{
	<span class="enscript-keyword">return</span> __c11_atomic_fetch_and((_Atomic UInt16 *)value, mask, memory_order_relaxed);
}

UInt16	OSBitOrAtomic16(UInt32 mask, <span class="enscript-type">volatile</span> UInt16 * value)
{
	<span class="enscript-keyword">return</span> __c11_atomic_fetch_or((_Atomic UInt16 *)value, mask, memory_order_relaxed);
}

UInt16	OSBitXorAtomic16(UInt32 mask, <span class="enscript-type">volatile</span> UInt16 * value)
{
	<span class="enscript-keyword">return</span> __c11_atomic_fetch_xor((_Atomic UInt16 *)value, mask, memory_order_relaxed);
}

<span class="enscript-comment">// 19831745 - end of big hammer!
</span>#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">clang</span> <span class="enscript-variable-name">diagnostic</span> <span class="enscript-variable-name">pop</span>

</pre>
<hr />
</body></html>