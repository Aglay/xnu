<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>OSDebug.cpp</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">OSDebug.cpp&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2005-2012 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

<span class="enscript-comment">// NOTE:  This file is only c++ so I can get static initialisers going
</span>#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/OSDebug.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOLib.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/cdefs.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdarg.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/mach_types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/kmod.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/locks.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/libkern.h&gt;</span>	// From bsd's libkern directory
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/vm_param.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/kdebug.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/thread.h&gt;</span>

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> etext;
__BEGIN_DECLS
<span class="enscript-comment">// From osmfk/kern/thread.h but considered to be private
</span><span class="enscript-type">extern</span> vm_offset_t <span class="enscript-function-name">min_valid_stack_address</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> vm_offset_t <span class="enscript-function-name">max_valid_stack_address</span>(<span class="enscript-type">void</span>);

<span class="enscript-comment">// From osfmk/kern/printf.c
</span><span class="enscript-type">extern</span> boolean_t doprnt_hide_pointers;

<span class="enscript-comment">// From osfmk/kmod.c
</span><span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">kmod_dump_log</span>(vm_offset_t *addr, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> cnt, boolean_t doUnslide);

<span class="enscript-type">extern</span> addr64_t <span class="enscript-function-name">kvtophys</span>(vm_offset_t va);

__END_DECLS

<span class="enscript-type">extern</span> lck_grp_t *IOLockGroup;

<span class="enscript-type">static</span> lck_mtx_t *sOSReportLock = lck_mtx_alloc_init(IOLockGroup, LCK_ATTR_NULL);

<span class="enscript-comment">/* Use kernel_debug() to log a backtrace */</span> 
<span class="enscript-type">void</span>
<span class="enscript-function-name">trace_backtrace</span>(uint32_t debugid, uint32_t debugid2, uintptr_t size, uintptr_t data) {
	<span class="enscript-type">void</span> *bt[16];
	<span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> cnt = <span class="enscript-keyword">sizeof</span>(bt) / <span class="enscript-keyword">sizeof</span>(bt[0]);
  	<span class="enscript-type">unsigned</span> i;
	<span class="enscript-type">int</span> found = 0;

	OSBacktrace(bt, cnt);	
  
	<span class="enscript-comment">/* find first non-kernel frame */</span>
  	<span class="enscript-keyword">for</span> (i = 3; i &lt; cnt &amp;&amp; bt[i]; i++) {
 		<span class="enscript-keyword">if</span> (bt[i] &gt; (<span class="enscript-type">void</span>*)&amp;etext) {
			found = 1;
  			<span class="enscript-keyword">break</span>;
		}
	}
	<span class="enscript-comment">/* 
	 * if there are non-kernel frames, only log these
	 * otherwise, log everything but the first two
	 */</span>
	<span class="enscript-keyword">if</span> (!found) i=2;

#<span class="enscript-reference">define</span> <span class="enscript-function-name">safe_bt</span>(a) (uintptr_t)(a&lt;cnt ? bt[a] : 0)
	kernel_debug(debugid, data, size, safe_bt(i), safe_bt(i+1), 0);
	kernel_debug(debugid2, safe_bt(i+2), safe_bt(i+3), safe_bt(i+4), safe_bt(i+5), 0);
}

<span class="enscript-comment">/* Report a message with a 4 entry backtrace - very slow */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">OSReportWithBacktrace</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *str, ...)
{
    <span class="enscript-type">char</span> buf[128];
    <span class="enscript-type">void</span> *bt[9];
    <span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> cnt = <span class="enscript-keyword">sizeof</span>(bt) / <span class="enscript-keyword">sizeof</span>(bt[0]);
    va_list listp;

    <span class="enscript-comment">// Ignore the our and our callers stackframes, skipping frames 0 &amp; 1
</span>    (<span class="enscript-type">void</span>) OSBacktrace(bt, cnt);

    va_start(listp, str);
    vsnprintf(buf, <span class="enscript-keyword">sizeof</span>(buf), str, listp);
    va_end(listp);

    lck_mtx_lock(sOSReportLock);
    {
        boolean_t old_doprnt_hide_pointers = doprnt_hide_pointers;
        doprnt_hide_pointers = FALSE;
        printf(<span class="enscript-string">&quot;%s\nBacktrace 0x%lx 0x%lx 0x%lx 0x%lx 0x%lx 0x%lx 0x%lx\n&quot;</span>, buf, 
            (<span class="enscript-type">unsigned</span> <span class="enscript-type">long</span>) VM_KERNEL_UNSLIDE(bt[2]), (<span class="enscript-type">unsigned</span> <span class="enscript-type">long</span>) VM_KERNEL_UNSLIDE(bt[3]), 
            (<span class="enscript-type">unsigned</span> <span class="enscript-type">long</span>) VM_KERNEL_UNSLIDE(bt[4]), (<span class="enscript-type">unsigned</span> <span class="enscript-type">long</span>) VM_KERNEL_UNSLIDE(bt[5]), 
            (<span class="enscript-type">unsigned</span> <span class="enscript-type">long</span>) VM_KERNEL_UNSLIDE(bt[6]), (<span class="enscript-type">unsigned</span> <span class="enscript-type">long</span>) VM_KERNEL_UNSLIDE(bt[7]), 
            (<span class="enscript-type">unsigned</span> <span class="enscript-type">long</span>) VM_KERNEL_UNSLIDE(bt[8]));
        kmod_dump_log((vm_offset_t *) &amp;bt[2], cnt - 2, TRUE);
        doprnt_hide_pointers = old_doprnt_hide_pointers;
    }
    lck_mtx_unlock(sOSReportLock);
}

<span class="enscript-type">static</span> vm_offset_t minstackaddr = min_valid_stack_address();
<span class="enscript-type">static</span> vm_offset_t maxstackaddr = max_valid_stack_address();


#<span class="enscript-reference">if</span> <span class="enscript-variable-name">__x86_64__</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">x86_64_RETURN_OFFSET</span> 8
<span class="enscript-type">static</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">x86_64_validate_raddr</span>(vm_offset_t raddr)
{
	<span class="enscript-keyword">return</span> ((raddr &gt; VM_MIN_KERNEL_AND_KEXT_ADDRESS) &amp;&amp;
	    (raddr &lt; VM_MAX_KERNEL_ADDRESS));
}
<span class="enscript-type">static</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">x86_64_validate_stackptr</span>(vm_offset_t stackptr)
{
	<span class="enscript-comment">/* Existence and alignment check
	 */</span>
	<span class="enscript-keyword">if</span> (!stackptr || (stackptr &amp; 0x7) || !x86_64_validate_raddr(stackptr))
		<span class="enscript-keyword">return</span> 0;
  
	<span class="enscript-comment">/* Is a virtual-&gt;physical translation present?
	 */</span>
	<span class="enscript-keyword">if</span> (!kvtophys(stackptr))
		<span class="enscript-keyword">return</span> 0;
  
	<span class="enscript-comment">/* Check if the return address lies on the same page;
	 * If not, verify that a translation exists.
	 */</span>
	<span class="enscript-keyword">if</span> (((PAGE_SIZE - (stackptr &amp; PAGE_MASK)) &lt; x86_64_RETURN_OFFSET) &amp;&amp;
	    !kvtophys(stackptr + x86_64_RETURN_OFFSET))
		<span class="enscript-keyword">return</span> 0;
	<span class="enscript-keyword">return</span> 1;
}
#<span class="enscript-reference">endif</span>

<span class="enscript-type">void</span>
<span class="enscript-function-name">OSPrintBacktrace</span>(<span class="enscript-type">void</span>)
{
	<span class="enscript-type">void</span> * btbuf[20];
	<span class="enscript-type">int</span> tmp = OSBacktrace(btbuf, 20);
	<span class="enscript-type">int</span> i;
	<span class="enscript-keyword">for</span>(i=0;i&lt;tmp;i++)
	{
		kprintf(<span class="enscript-string">&quot;bt[%.2d] = %p\n&quot;</span>, i, btbuf[i]);
	}
}

<span class="enscript-type">unsigned</span> <span class="enscript-function-name">OSBacktrace</span>(<span class="enscript-type">void</span> **bt, <span class="enscript-type">unsigned</span> maxAddrs)
{
    <span class="enscript-type">unsigned</span> frame;
    <span class="enscript-keyword">if</span> (!current_thread()) <span class="enscript-keyword">return</span> 0;

#<span class="enscript-reference">if</span>   <span class="enscript-variable-name">__x86_64__</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SANE_x86_64_FRAME_SIZE</span> (kernel_stack_size &gt;&gt; 1)
    vm_offset_t stackptr, stackptr_prev, raddr;
    <span class="enscript-type">unsigned</span> frame_index = 0;
<span class="enscript-comment">/* Obtain current frame pointer */</span>

    __asm__ <span class="enscript-type">volatile</span>(<span class="enscript-string">&quot;movq %%rbp, %0&quot;</span> : <span class="enscript-string">&quot;=m&quot;</span> (stackptr)); 

    <span class="enscript-keyword">if</span> (!x86_64_validate_stackptr(stackptr))
	    <span class="enscript-keyword">goto</span> <span class="enscript-reference">pad</span>;

    raddr = *((vm_offset_t *) (stackptr + x86_64_RETURN_OFFSET));

    <span class="enscript-keyword">if</span> (!x86_64_validate_raddr(raddr))
	    <span class="enscript-keyword">goto</span> <span class="enscript-reference">pad</span>;

    bt[frame_index++] = (<span class="enscript-type">void</span> *) raddr;

    <span class="enscript-keyword">for</span> ( ; frame_index &lt; maxAddrs; frame_index++) {
	    stackptr_prev = stackptr;
	    stackptr = *((vm_offset_t *) stackptr_prev);

	    <span class="enscript-keyword">if</span> (!x86_64_validate_stackptr(stackptr))
		    <span class="enscript-keyword">break</span>;
	<span class="enscript-comment">/* Stack grows downwards */</span>
	    <span class="enscript-keyword">if</span> (stackptr &lt; stackptr_prev)
		    <span class="enscript-keyword">break</span>;

	    <span class="enscript-keyword">if</span> ((stackptr - stackptr_prev) &gt; SANE_x86_64_FRAME_SIZE)
		    <span class="enscript-keyword">break</span>;

	    raddr = *((vm_offset_t *) (stackptr + x86_64_RETURN_OFFSET));

	    <span class="enscript-keyword">if</span> (!x86_64_validate_raddr(raddr))
		    <span class="enscript-keyword">break</span>;

	    bt[frame_index] = (<span class="enscript-type">void</span> *) raddr;
    }
<span class="enscript-reference">pad</span>:
    frame = frame_index;

    <span class="enscript-keyword">for</span> ( ; frame_index &lt; maxAddrs; frame_index++)
	    bt[frame_index] = (<span class="enscript-type">void</span> *) 0;
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">error</span> <span class="enscript-variable-name">arch</span>
#<span class="enscript-reference">endif</span>
    <span class="enscript-keyword">return</span> frame;
}
</pre>
<hr />
</body></html>