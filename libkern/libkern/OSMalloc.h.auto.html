<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>OSMalloc.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">OSMalloc.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2003-2004 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">ifndef</span>	<span class="enscript-variable-name">LIBKERN_OSMALLOC_h</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LIBKERN_OSMALLOC_h</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/cdefs.h&gt;</span>

__BEGIN_DECLS

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdint.h&gt;</span>
#<span class="enscript-reference">ifdef</span>  <span class="enscript-variable-name">MACH_KERNEL_PRIVATE</span>     
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/queue.h&gt;</span>  
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">/*!
 * @header
 *
 * @abstract
 * This header declares the OSMalloc memory-allocation KPI.
 *
 * @discussion
 * Kernel extensions can use these functions to allocate and deallocate
 * memory blocks that are tracked under named tags.
 * A kernel extension can create whatever tags it needs,
 * but typically just creates one with its bundle identifier.
 *
 * Tags are required; attempting to use these functions without one
 * will result in a panic.
 *
 * &lt;b&gt;Use Restrictions&lt;/b&gt;
 *
 * None of the OSMalloc functions are safe to call
 * in a primary interrupt handler.
 */</span>
 
#<span class="enscript-reference">ifdef</span>  <span class="enscript-variable-name">MACH_KERNEL_PRIVATE</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">OSMT_MAX_NAME</span>  (64)

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> _OSMallocTag_ {
    queue_chain_t   OSMT_link;
    uint32_t        OSMT_refcnt;
    uint32_t        OSMT_state;
    uint32_t        OSMT_attr;
    <span class="enscript-type">char</span>            OSMT_name[OSMT_MAX_NAME];
} * OSMallocTag;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">OSMT_VALID_MASK</span>   0xFFFF0000
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">OSMT_VALID</span>        0xDEAB0000
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">OSMT_RELEASED</span>     0x00000001

<span class="enscript-comment">/*! @parseOnly */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">OSMT_ATTR_PAGEABLE</span>  0x01

#<span class="enscript-reference">else</span>
<span class="enscript-comment">/*!
 * @typedef OSMallocTag
 *
 * @abstract
 * An opaque type used to track memory allocations.
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> __OSMallocTag__ * OSMallocTag;


<span class="enscript-comment">/*!
 * @typedef OSMallocTag_t
 *
 * @abstract
 * See &lt;code&gt;@link OSMallocTag OSMallocTag@/link&lt;/code&gt;.
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> __OSMallocTag__ * OSMallocTag_t;
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">/*!
 * @define OSMT_DEFAULT
 *
 * @abstract
 * Indicates that an &lt;code&gt;@link OSMallocTag OSMallocTag@/link&lt;/code&gt;
 * be created with default attributes.
 *
 * @discussion
 * An &lt;code&gt;@link OSMallocTag OSMallocTag@/link&lt;/code&gt; created
 * with this attribute allocates all blocks in wired memory.
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">OSMT_DEFAULT</span>   0x00


<span class="enscript-comment">/*!
 * @define OSMT_PAGEABLE
 *
 * @abstract
 * Indicates that an &lt;code&gt;@link OSMallocTag OSMallocTag@/link&lt;/code&gt;
 * should allocate pageable memory when possible.
 *
 * @discussion
 * An &lt;code&gt;@link OSMallocTag OSMallocTag@/link&lt;/code&gt; created
 * with this attribute allocates blocks of a full page size or larger
 * in pageable memory,
 * and blocks smaller than a full page size in wired memory.
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">OSMT_PAGEABLE</span>  0x01


<span class="enscript-comment">/*!
 * @function OSMalloc_Tagalloc
 *
 * @abstract
 * Creates a tag for use with OSMalloc functions.
 *
 * @param name   The name of the tag to create.
 * @param flags  A bitmask that controls allocation behavior; see description.
 *
 * @result
 * An opaque tag to be used with OSMalloc functions for tracking memory usage.
 *
 * @discussion
 * OSMalloc tags can have arbitrary names of a length up to 63 characters.
 * Calling this function twice with the same name
 * creates two tags, which share that name.
 *
 * &lt;code&gt;flags&lt;/code&gt; can be the bitwise OR of the following flags:
 * &lt;ul&gt;
 *    &lt;li&gt;&lt;code&gt;@link OSMT_DEFAULT OSMT_DEFAULT@/link&lt;/code&gt; -
 *        allocations are wired. This is the 'zero' bitmask value and
 *        is overridden by any other flag specified.&lt;/li&gt;
 *    &lt;li&gt;&lt;code&gt;@link OSMT_PAGEABLE OSMT_PAGEABLE@/link&lt;/code&gt; -
 *        allocations of a full page size or greater are pageable;
 *        allocations smaller than a page are wired.&lt;/li&gt;
 * &lt;/ul&gt;
 */</span>
<span class="enscript-type">extern</span> OSMallocTag <span class="enscript-function-name">OSMalloc_Tagalloc</span>(
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> * name,
    uint32_t    flags);


<span class="enscript-comment">/*!
 * @function OSMalloc_Tagfree
 *
 * @abstract
 * Frees a tag used with OSMalloc functions.
 *
 * @param tag  The &lt;code&gt;@link OSMallocTag OSMallocTag@/link&lt;/code&gt; to free.
 *
 * @discussion
 * OSMalloc tags must not be freed
 * while any memory blocks allocated
 * with them still exist.
 * Any OSMalloc function called on those blocks
 * will result in a panic.
 */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">OSMalloc_Tagfree</span>(OSMallocTag tag);


<span class="enscript-comment">/*!
 * @function OSMalloc
 *
 * @abstract
 * Allocates a block of memory associated
 * with a given &lt;code&gt;@link OSMallocTag OSMallocTag@/link&lt;/code&gt;.
 *
 * @param size  The size of the memory block to allocate.
 * @param tag   The &lt;code&gt;@link OSMallocTag OSMallocTag@/link&lt;/code&gt;
 *              under which to allocate the memory.
 *
 * @result
 * A pointer to the memory on success, &lt;code&gt;NULL&lt;/code&gt; on failure.
 *
 * @discussion
 * If &lt;code&gt;tag&lt;/code&gt; was created with the
 * &lt;code&gt;@link OSMT_PAGEABLE OSMT_PAGEABLE@/link&lt;/code&gt;
 * attribute &lt;i&gt;and&lt;/i&gt; &lt;code&gt;size&lt;/code&gt;
 * is a full page or larger, the allocated memory is pageable;
 * otherwise it is wired.
 */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> * <span class="enscript-function-name">OSMalloc</span>(
    uint32_t    size,
    OSMallocTag tag);


<span class="enscript-comment">/*!
 * @function OSMalloc_nowait
 *
 * @abstract
 * Equivalent to &lt;code&gt;@link OSMalloc_noblock OSMalloc_noblock@/link&lt;/code&gt;.
 */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> * <span class="enscript-function-name">OSMalloc_nowait</span>(
    uint32_t    size,
    OSMallocTag tag);


<span class="enscript-comment">/*!
 * @function OSMalloc_noblock
 *
 * @abstract
 * Allocates a block of memory associated
 * with a given &lt;code&gt;@link OSMallocTag OSMallocTag@/link&lt;/code&gt;,
 * returning &lt;code&gt;NULL&lt;/code&gt; if it would block.
 *
 * @param size  The size of the memory block to allocate.
 * @param tag   The &lt;code&gt;@link OSMallocTag OSMallocTag@/link&lt;/code&gt;
 *              under which to allocate the memory.
 *
 * @result
 * A pointer to the memory on success, &lt;code&gt;NULL&lt;/code&gt; on failure
 * or if allocation would block.
 *
 * @discussion
 * If &lt;code&gt;tag&lt;/code&gt; was created with the
 * &lt;code&gt;@link OSMT_PAGEABLE OSMT_PAGEABLE@/link&lt;/code&gt;
 * attribute &lt;i&gt;and&lt;/i&gt; &lt;code&gt;size&lt;/code&gt;
 * is a full page or larger, the allocated memory is pageable;
 * otherwise it is wired.
 *
 * This function is guaranteed not to block.
 */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> * <span class="enscript-function-name">OSMalloc_noblock</span>(
    uint32_t    size,
    OSMallocTag tag);


<span class="enscript-comment">/*!
 * @function OSFree
 *
 * @abstract
 * Frees a block of memory allocated by &lt;code&gt;@link OSMalloc OSMalloc@/link&lt;/code&gt;.
 *
 * @param addr  A pointer to the memory block to free.
 * @param size  The size of the memory block to free.
 * @param tag   The &lt;code&gt;@link OSMallocTag OSMallocTag@/link&lt;/code&gt;
 *              with which &lt;code&gt;addr&lt;/code&gt; was originally allocated.
 */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">OSFree</span>(
    <span class="enscript-type">void</span>      * addr,
    uint32_t    size,
    OSMallocTag tag); 

__END_DECLS

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* LIBKERN_OSMALLOC_h */</span>
</pre>
<hr />
</body></html>