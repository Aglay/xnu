<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>OSSerialize.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">OSSerialize.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/* OSSerialize.h created by rsulack on Wen 25-Nov-1998 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_OS_OSSERIALIZE_H</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_OS_OSSERIALIZE_H</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSObject.h&gt;</span>

class OSCollection;
class OSSet;
class OSDictionary;

<span class="enscript-comment">/*!
 * @header
 *
 * @abstract
 * This header declares the OSSerialize class.
 */</span>
 
 
<span class="enscript-comment">/*!
 * @class OSSerialize
 *
 * @abstract
 * OSSerialize coordinates serialization of Libkern C++ objects
 * into an XML stream.
 *
 * @discussion
 * This class is for the most part internal to the OSContainer classes,
 * used for transferring property tables between the kernel and user space.
 * It should not be used directly.
 * Classes that participate in serialization
 * override the
 * &lt;code&gt;@link
 * //apple_ref/cpp/instm/OSObject/serialize/virtualbool/(OSSerialize*)
 * OSObject::serialize@/link&lt;/code&gt; .
 * function.
 *
 * &lt;b&gt;Use Restrictions&lt;/b&gt;
 *
 * With very few exceptions in the I/O Kit, all Libkern-based C++
 * classes, functions, and macros are &lt;b&gt;unsafe&lt;/b&gt;
 * to use in a primary interrupt context.
 * Consult the I/O Kit documentation related to primary interrupts 
 * for more information.
 *
 * OSSerialize provides no concurrency protection;
 * it's up to the usage context to provide any protection necessary.
 * Some portions of the I/O Kit, such as
 * @link //apple_ref/doc/class/IORegistryEntry IORegistryEntry@/link,
 * handle synchronization via defined member functions
 * for serializing properties.
 */</span>
 
OSObject *
<span class="enscript-function-name">OSUnserializeBinary</span>(<span class="enscript-type">const</span> <span class="enscript-type">void</span> *buffer, size_t bufferSize);

class OSSerialize : public OSObject
{
    OSDeclareDefaultStructors(OSSerialize)
    friend class OSBoolean;

<span class="enscript-reference">protected</span>:
    <span class="enscript-type">char</span>         * data;               <span class="enscript-comment">// container for serialized data
</span>    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>   length;             <span class="enscript-comment">// of serialized data (counting NULL)
</span>    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>   capacity;           <span class="enscript-comment">// of container
</span>    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>   capacityIncrement;  <span class="enscript-comment">// of container
</span>
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>   tag;
    OSDictionary * tags;               <span class="enscript-comment">// tags for all objects seen
</span>
    <span class="enscript-type">struct</span> ExpansionData { };
    
    <span class="enscript-comment">/* Reserved for future use. (Internal use only)  */</span>
    ExpansionData *reserved;

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">XNU_KERNEL_PRIVATE</span>
<span class="enscript-reference">public</span>:
    <span class="enscript-type">typedef</span> <span class="enscript-type">const</span> OSMetaClassBase * (*Editor)(<span class="enscript-type">void</span>                  * reference,
					      OSSerialize           * s, 
					      OSCollection          * container, 
					      <span class="enscript-type">const</span> OSSymbol        * name,
					      <span class="enscript-type">const</span> OSMetaClassBase * value);
#<span class="enscript-reference">else</span>
    <span class="enscript-type">typedef</span> <span class="enscript-type">void</span> * Editor;
#<span class="enscript-reference">endif</span>

<span class="enscript-reference">private</span>:
    bool   binary;
    bool   endCollection;
    Editor editor;
    <span class="enscript-type">void</span> * editRef;

    bool binarySerialize(<span class="enscript-type">const</span> OSMetaClassBase *o);
    bool addBinary(<span class="enscript-type">const</span> <span class="enscript-type">void</span> * data, size_t size);
    bool addBinaryObject(<span class="enscript-type">const</span> OSMetaClassBase * o, uint32_t key, <span class="enscript-type">const</span> <span class="enscript-type">void</span> * _bits, size_t size);

<span class="enscript-reference">public</span>:

   <span class="enscript-comment">/*!
    * @function withCapacity
    *
    * @abstract
    * Creates and initializes an empty OSSerialize object.
    * 
    * @param  capacity The initial size of the XML buffer.
    *
    * @result
    * A new instance of OSSerialize
    * with a retain count of 1;
    * &lt;code&gt;NULL&lt;/code&gt; on failure.
    *
    * @discussion
    * The serializer will grow as needed to accommodate more data.
    */</span>
    <span class="enscript-type">static</span> OSSerialize * withCapacity(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> capacity);

    <span class="enscript-type">static</span> OSSerialize * binaryWithCapacity(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> inCapacity, Editor editor = 0, <span class="enscript-type">void</span> * reference = 0);

   <span class="enscript-comment">/*!
    * @function text
    *
    * @abstract
    * Returns the XML text serialized so far.
    * 
    * @result
    * The nul-terminated XML data serialized so far.
    */</span>
    virtual <span class="enscript-type">char</span> * text() <span class="enscript-type">const</span>;


   <span class="enscript-comment">/*!
    * @function clearText
    *
    * @abstract
    * Resets the OSSerialize object.
    *
    * @discussion
    * This function is a useful optimization if you are serializing
    * the same object repeatedly.
    */</span>
    virtual <span class="enscript-type">void</span> clearText();

    <span class="enscript-comment">// stuff to serialize your object
</span>
   <span class="enscript-comment">/*!
    * @function previouslySerialized
    *
    * @abstract
    * Checks whether the object has already been serialized
    * into the XML stream, emitting a reference if it has.
    *
    * @param object The object to check.
    *
    * @result
    * &lt;code&gt;true&lt;/code&gt; if &lt;code&gt;object&lt;/code&gt; has already been serialized
    * by this OSSerialize object and a reference
    * to it is successfully added to the XML stream,
    * &lt;code&gt;false&lt;/code&gt; otherwise.
    *    
    *
    * @discussion
    * This function both reduces the size of generated XML
    * by emitting shorter references to existing objects with the same
    * value (particularly for OSString, OSSymbol, and OSData),
    * and also preserves instance references
    * so that the user-space I/O Kit library can reconstruct
    * an identical graph of object relationships.
    *
    * All classes that override
    * &lt;code&gt;@link
    * //apple_ref/cpp/instm/OSObject/serialize/virtualbool/(OSSerialize*)
    * OSObject::serialize@/link&lt;/code&gt;.
    * should call this function before doing any actual serialization;
    * if it returns &lt;code&gt;true&lt;/code&gt;, the &lt;code&gt;serialize&lt;/code&gt; implementation
    * can immediately return &lt;code&gt;true&lt;/code&gt;.
    */</span>
    virtual bool previouslySerialized(<span class="enscript-type">const</span> OSMetaClassBase * object);


   <span class="enscript-comment">/*!
    * @function addXMLStartTag
    *
    * @abstract
    * Appends an XML start tag to the XML stream.
    *
    * @param object    The object being serialized.
    * @param tagString The name of the XML tag to emit; for example, &quot;string&quot;.
    *
    * @result
    * &lt;code&gt;true&lt;/code&gt; if an XML start tag for &lt;code&gt;tagString&lt;/code&gt;
    * is successfully added to the XML stream, &lt;code&gt;false&lt;/code&gt; otherwise.
    *    
    * @discussion
    * This function emits the named tag,
    * enclosed within a pair of angle brackets.
    *
    * A class that implements serialization should call this function
    * with the name of the XML tag that best represents the serialized
    * contents of the object.
    * A limited number of tags are supported by the user-space
    * I/O Kit library:
    * &lt;ul&gt;
    * &lt;li&gt;array&lt;/li&gt;
    * &lt;li&gt;dict&lt;/li&gt;
    * &lt;li&gt;integer&lt;/li&gt;
    * &lt;li&gt;key&lt;/li&gt;
    * &lt;li&gt;set&lt;/li&gt;
    * &lt;li&gt;string&lt;/li&gt;
    * &lt;/ul&gt;
    *
    * A call to this function must be balanced with one to
    * &lt;code&gt;@link addXMLEndTag addXMLEndTag@/link&lt;/code&gt;
    * using the same &lt;code&gt;tagString&lt;/code&gt;.
    */</span>
    virtual bool addXMLStartTag(
        <span class="enscript-type">const</span> OSMetaClassBase * object,
        <span class="enscript-type">const</span> <span class="enscript-type">char</span>            * tagString);


   <span class="enscript-comment">/*!
    * @function addXMLEndTag
    *
    * @abstract
    * Appends an XML end tag to the XML stream.
    *
    * @param tagString The name of the XML tag to emit; for example, &quot;string&quot;.
    *
    * @result
    * &lt;code&gt;true&lt;/code&gt; if an XML end tag for &lt;code&gt;tagString&lt;/code&gt;
    * is successfully added to the XML stream, &lt;code&gt;false&lt;/code&gt; otherwise.
    *    
    * @discussion
    * This function emits the named tag,
    * preceded by a slash character to indicate the closing of an entity,
    * all enclosed within a pair of angle brackets.
    *
    * A call to this function must balance an earlier call to
    * &lt;code&gt;@link addXMLStartTag addXMLStartTag@/link&lt;/code&gt;
    * using the same &lt;code&gt;tagString&lt;/code&gt;.
    */</span>
    virtual bool addXMLEndTag(<span class="enscript-type">const</span> <span class="enscript-type">char</span> * tagString);


   <span class="enscript-comment">/*!
    * @function addChar
    *
    * @abstract
    * Appends a single character to the XML stream.
    *
    * @param aChar The character to append to the XML stream.
    *
    * @result
    * &lt;code&gt;true&lt;/code&gt; if &lt;code&gt;char&lt;/code&gt;
    * is successfully added to the XML stream, &lt;code&gt;false&lt;/code&gt; otherwise.
    */</span>
    virtual bool addChar(<span class="enscript-type">const</span> <span class="enscript-type">char</span> aChar);


   <span class="enscript-comment">/*!
    * @function addString
    *
    * @abstract
    * Appends a C string to the XML stream.
    *
    * @param cString The C string to append to the XML stream.
    *
    * @result
    *  &lt;code&gt;true&lt;/code&gt; if &lt;code&gt;cString&lt;/code&gt;
    * is successfully added to the XML stream, &lt;code&gt;false&lt;/code&gt; otherwise.
    */</span>
    virtual bool addString(<span class="enscript-type">const</span> <span class="enscript-type">char</span> * cString);

    <span class="enscript-comment">// stuff you should never have to use (in theory)
</span>
    virtual bool initWithCapacity(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> inCapacity);
    virtual <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> getLength() <span class="enscript-type">const</span>;
    virtual <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> getCapacity() <span class="enscript-type">const</span>;
    virtual <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> getCapacityIncrement() <span class="enscript-type">const</span>;
    virtual <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> setCapacityIncrement(<span class="enscript-type">unsigned</span> increment);
    virtual <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> ensureCapacity(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> newCapacity);
    virtual <span class="enscript-type">void</span> free() APPLE_KEXT_OVERRIDE;

    OSMetaClassDeclareReservedUnused(OSSerialize, 0);
    OSMetaClassDeclareReservedUnused(OSSerialize, 1);
    OSMetaClassDeclareReservedUnused(OSSerialize, 2);
    OSMetaClassDeclareReservedUnused(OSSerialize, 3);
    OSMetaClassDeclareReservedUnused(OSSerialize, 4);
    OSMetaClassDeclareReservedUnused(OSSerialize, 5);
    OSMetaClassDeclareReservedUnused(OSSerialize, 6);
    OSMetaClassDeclareReservedUnused(OSSerialize, 7);
};

<span class="enscript-comment">// xx-review: this whole class seems to be unused!
</span>
<span class="enscript-type">typedef</span> <span class="enscript-function-name">bool</span> (*OSSerializerCallback)(<span class="enscript-type">void</span> * target, <span class="enscript-type">void</span> * ref,
                                     OSSerialize * serializer);

class OSSerializer : public OSObject
{
    OSDeclareDefaultStructors(OSSerializer)

    <span class="enscript-type">void</span> * target;
    <span class="enscript-type">void</span> * ref;
    OSSerializerCallback callback;
    
<span class="enscript-reference">public</span>:

    <span class="enscript-type">static</span> OSSerializer * forTarget(
        <span class="enscript-type">void</span> * target,
        OSSerializerCallback callback,
        <span class="enscript-type">void</span> * ref = 0);

    virtual bool serialize(OSSerialize * serializer) <span class="enscript-type">const</span> APPLE_KEXT_OVERRIDE;
};

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* _OS_OSSERIALIZE_H */</span>
</pre>
<hr />
</body></html>