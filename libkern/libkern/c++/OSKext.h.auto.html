<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>OSKext.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">OSKext.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2008-2012 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_LIBKERN_OSKEXT_H</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_LIBKERN_OSKEXT_H</span>

<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> {
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/thread_call.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/OSKextLibPrivate.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/kernel_mach_header.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/kxld.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/kmod.h&gt;</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">XNU_KERNEL_PRIVATE</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/thread_call.h&gt;</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* XNU_KERNEL_PRIVATE */</span>
}

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/OSKextLib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/OSKextLibPrivate.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSObject.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSContainers.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOLocks.h&gt;</span>

<span class="enscript-comment">/*********************************************************************
* C functions used for callbacks.
*********************************************************************/</span>
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">XNU_KERNEL_PRIVATE</span>
<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> {
<span class="enscript-type">void</span> <span class="enscript-function-name">osdata_kmem_free</span>(<span class="enscript-type">void</span> * ptr, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> length);
<span class="enscript-type">void</span> <span class="enscript-function-name">osdata_phys_free</span>(<span class="enscript-type">void</span> * ptr, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> length);
<span class="enscript-type">void</span> <span class="enscript-function-name">osdata_vm_deallocate</span>(<span class="enscript-type">void</span> * ptr, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> length);
};
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* XNU_KERNEL_PRIVATE */</span>

<span class="enscript-comment">/*********************************************************************
* C Function Prototypes for Friend Declarations.
*********************************************************************/</span>
class OSKext;

<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> {

<span class="enscript-type">void</span> <span class="enscript-function-name">OSKextLog</span>(
    OSKext         * aKext,
    OSKextLogSpec    msgLogSpec,
    <span class="enscript-type">const</span> <span class="enscript-type">char</span>     * format, ...)
        __attribute__((format(printf, 3, 4)));

<span class="enscript-type">void</span> <span class="enscript-function-name">OSKextVLog</span>(
    OSKext         * aKext,
    OSKextLogSpec    msgLogSpec,
    <span class="enscript-type">const</span> <span class="enscript-type">char</span>     * format,
    va_list          srcArgList);

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">XNU_KERNEL_PRIVATE</span>
<span class="enscript-type">void</span> <span class="enscript-function-name">OSKextRemoveKextBootstrap</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">void</span> <span class="enscript-function-name">IOSystemShutdownNotification</span>(<span class="enscript-type">void</span>);

kern_return_t <span class="enscript-function-name">OSRuntimeInitializeCPP</span>(
    kmod_info_t * kmodInfo,
    <span class="enscript-type">void</span> *        data);
kern_return_t <span class="enscript-function-name">OSRuntimeFinalizeCPP</span>(
    kmod_info_t * kmodInfo,
    <span class="enscript-type">void</span>        * data);

kern_return_t <span class="enscript-function-name">is_io_catalog_send_data</span>(
    mach_port_t              masterPort,
    uint32_t                 flag,
    io_buf_ptr_t             inData,
    mach_msg_type_number_t   inDataCount,
    kern_return_t          * result);

<span class="enscript-type">void</span> <span class="enscript-function-name">kmod_dump_log</span>(vm_offset_t*, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>, boolean_t);


#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* XNU_KERNEL_PRIVATE */</span>
};

<span class="enscript-comment">/********************************************************************/</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PRAGMA_MARK</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> -
#<span class="enscript-reference">endif</span>

<span class="enscript-type">struct</span> list_head {
    <span class="enscript-type">struct</span> list_head *prev;
    <span class="enscript-type">struct</span> list_head *next;
};

<span class="enscript-type">struct</span> OSKextGrabPgoStruct {
    bool metadata;
    uint64_t *pSize;
    <span class="enscript-type">char</span> *pBuffer;
    uint64_t bufferSize;
    <span class="enscript-type">int</span> err;
    <span class="enscript-type">struct</span> list_head list_head;
};

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">container_of</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">container_of</span>(ptr,type,member) ((type*)(((uintptr_t)ptr) - offsetof(type, member)))
#<span class="enscript-reference">endif</span>
<span class="enscript-comment">/********************************************************************/</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">XNU_KERNEL_PRIVATE</span>

<span class="enscript-type">struct</span> OSKextAccount
{
    vm_allocation_site_t site;
    uint32_t    	 loadTag;
};

<span class="enscript-type">struct</span> OSKextActiveAccount
{
    uintptr_t       address;
    uintptr_t       address_end;
    OSKextAccount * account;
};
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> OSKextActiveAccount OSKextActiveAccount;

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* XNU_KERNEL_PRIVATE */</span>

<span class="enscript-comment">/*
 * @class OSKext
 */</span>
<span class="enscript-comment">/********************************************************************/</span>
class OSKext : public OSObject
{
    OSDeclareDefaultStructors(OSKext)

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PRAGMA_MARK</span>
<span class="enscript-comment">/**************************************/</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> <span class="enscript-variable-name">Friend</span> <span class="enscript-variable-name">Declarations</span>
<span class="enscript-comment">/**************************************/</span>
#<span class="enscript-reference">endif</span>
    friend class IOCatalogue;
    friend class KLDBootstrap;
    friend class OSMetaClass;

    friend <span class="enscript-type">int</span> OSKextGrabPgoData(uuid_t uuid,
                                 uint64_t *pSize,
                                 <span class="enscript-type">char</span> *pBuffer,
                                 uint64_t bufferSize,
                                 <span class="enscript-type">int</span> wait_for_unload,
                                 <span class="enscript-type">int</span> metadata);

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">XNU_KERNEL_PRIVATE</span>
    friend <span class="enscript-type">void</span> OSKextVLog(
        OSKext         * aKext,
        OSKextLogSpec    msgLogSpec,
        <span class="enscript-type">const</span> <span class="enscript-type">char</span>     * format,
        va_list          srcArgList);

    friend <span class="enscript-type">void</span> OSKextRemoveKextBootstrap(<span class="enscript-type">void</span>);
    friend <span class="enscript-type">void</span> IOSystemShutdownNotification(<span class="enscript-type">void</span>);
    friend OSReturn OSKextUnloadKextWithLoadTag(uint32_t);

    friend kern_return_t kext_request(
        host_priv_t                             hostPriv,
        <span class="enscript-comment">/* in only */</span>  uint32_t                 clientLogSpec,
        <span class="enscript-comment">/* in only */</span>  vm_offset_t              requestIn,
        <span class="enscript-comment">/* in only */</span>  mach_msg_type_number_t   requestLengthIn,
        <span class="enscript-comment">/* out only */</span> vm_offset_t            * responseOut,
        <span class="enscript-comment">/* out only */</span> mach_msg_type_number_t * responseLengthOut,
        <span class="enscript-comment">/* out only */</span> vm_offset_t            * logDataOut,
        <span class="enscript-comment">/* out only */</span> mach_msg_type_number_t * logDataLengthOut,
        <span class="enscript-comment">/* out only */</span> kern_return_t          * op_result);

    friend kxld_addr_t kern_allocate(
        u_long              size,
        KXLDAllocateFlags * flags,
        <span class="enscript-type">void</span>              * user_data);

    friend <span class="enscript-type">void</span> kxld_log_shim(
        KXLDLogSubsystem    subsystem,
        KXLDLogLevel        level,
        <span class="enscript-type">const</span> <span class="enscript-type">char</span>        * format,
        va_list             argList,
        <span class="enscript-type">void</span>              * user_data);

    friend <span class="enscript-type">void</span> _OSKextConsiderUnloads(
        __unused thread_call_param_t p0,
        __unused thread_call_param_t p1);

    friend kern_return_t OSRuntimeInitializeCPP(
        kmod_info_t * kmodInfo,
        <span class="enscript-type">void</span> *        data);
    friend kern_return_t OSRuntimeFinalizeCPP(
        kmod_info_t * kmodInfo,
        <span class="enscript-type">void</span>        * data);

    friend kern_return_t is_io_catalog_send_data(
            mach_port_t              masterPort,
            uint32_t                 flag,
            io_buf_ptr_t             inData,
            mach_msg_type_number_t   inDataCount,
            kern_return_t          * result);

    friend <span class="enscript-type">void</span> kmod_panic_dump(vm_offset_t*, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>);
    friend <span class="enscript-type">void</span> kmod_dump_log(vm_offset_t*, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>, boolean_t);
    friend <span class="enscript-type">void</span> kext_dump_panic_lists(<span class="enscript-type">int</span> (*printf_func)(<span class="enscript-type">const</span> <span class="enscript-type">char</span> * fmt, ...));


#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* XNU_KERNEL_PRIVATE */</span>

<span class="enscript-reference">private</span>:

   <span class="enscript-comment">/*************************
    * Instance variables
    *************************/</span>
    OSDictionary   * infoDict;

    <span class="enscript-type">const</span> OSSymbol * bundleID;
    OSString       * path;               <span class="enscript-comment">// not necessarily correct :-/
</span>    OSString       * executableRelPath;  <span class="enscript-comment">// relative to bundle
</span>
    OSKextVersion    version;            <span class="enscript-comment">// parsed
</span>    OSKextVersion    compatibleVersion;  <span class="enscript-comment">// parsed
</span>
   <span class="enscript-comment">/* These fields are required for tracking loaded kexts and
    * will always have values for a loaded kext.
    */</span>
    OSKextLoadTag    loadTag;            <span class="enscript-comment">// 'id' from old kmod_info; 
</span>                                         <span class="enscript-comment">// kOSKextInvalidLoadTag invalid
</span>    kmod_info_t    * kmod_info;          <span class="enscript-comment">// address into linkedExec./alloced for interface
</span>
    OSArray        * dependencies;       <span class="enscript-comment">// kernel resource does not have any;
</span>                                         <span class="enscript-comment">// links directly to kernel
</span>
   <span class="enscript-comment">/* Only real kexts have these; interface kexts do not.
    */</span>
    OSData         * linkedExecutable;
    OSSet          * metaClasses;           <span class="enscript-comment">// for C++/OSMetaClass kexts
</span>    
   <span class="enscript-comment">/* Only interface kexts have these; non-interface kexts can get at them
    * in the linked Executable.
    */</span>
    OSData         * interfaceUUID;

    <span class="enscript-type">struct</span> {
        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> loggingEnabled:1;

        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> hasAllDependencies:1;
        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> hasBleedthrough:1;

        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> interface:1;
        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> kernelComponent:1;
        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> prelinked:1;
        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> loaded:1;
        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> dtraceInitialized:1;
        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> starting:1;
        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> started:1;
        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> stopping:1;
        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> unloading:1;

        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> autounloadEnabled:1;
        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> delayAutounload:1;    <span class="enscript-comment">// for development
</span>
        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> CPPInitialized:1;
        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> jettisonLinkeditSeg:1;
    } flags;

    <span class="enscript-type">struct</span> list_head pendingPgoHead;
    uuid_t instance_uuid;
    OSKextAccount * account;

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PRAGMA_MARK</span>
<span class="enscript-comment">/**************************************/</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> <span class="enscript-variable-name">Private</span> <span class="enscript-variable-name">Functions</span>
<span class="enscript-comment">/**************************************/</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">XNU_KERNEL_PRIVATE</span>
   <span class="enscript-comment">/* Startup/shutdown phases.
    */</span>
<span class="enscript-reference">public</span>:
    <span class="enscript-type">static</span> <span class="enscript-type">void</span>           initialize(<span class="enscript-type">void</span>);
    <span class="enscript-type">static</span> OSDictionary * copyKexts(<span class="enscript-type">void</span>);
    <span class="enscript-type">static</span> OSReturn       removeKextBootstrap(<span class="enscript-type">void</span>);
    <span class="enscript-type">static</span> <span class="enscript-type">void</span>           willShutdown(<span class="enscript-type">void</span>);  <span class="enscript-comment">// called by IOPMrootDomain on shutdown
</span>#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* XNU_KERNEL_PRIVATE */</span>

<span class="enscript-reference">private</span>:
   <span class="enscript-comment">/* Called by power management at sleep/shutdown.
    */</span>
    <span class="enscript-type">static</span> bool setLoadEnabled(bool flag);
    <span class="enscript-type">static</span> bool setUnloadEnabled(bool flag);
    <span class="enscript-type">static</span> bool setAutounloadsEnabled(bool flag);
    <span class="enscript-type">static</span> bool setKernelRequestsEnabled(bool flag);

    <span class="enscript-comment">// all getters subject to race condition, caller beware
</span>    <span class="enscript-type">static</span> bool getLoadEnabled(<span class="enscript-type">void</span>);
    <span class="enscript-type">static</span> bool getUnloadEnabled(<span class="enscript-type">void</span>);
    <span class="enscript-type">static</span> bool getAutounloadEnabled(<span class="enscript-type">void</span>);
    <span class="enscript-type">static</span> bool getKernelRequestsEnabled(<span class="enscript-type">void</span>);

   <span class="enscript-comment">/* Instance life cycle.
    */</span>
    <span class="enscript-type">static</span> OSKext * withBooterData(
        OSString * deviceTreeName,
        OSData   * booterData);
    virtual bool initWithBooterData(
        OSString * deviceTreeName,
        OSData   * booterData);

    <span class="enscript-type">static</span> OSKext * withPrelinkedInfoDict(
        OSDictionary * infoDict);
    virtual bool initWithPrelinkedInfoDict(
        OSDictionary * infoDict);

    <span class="enscript-type">static</span> OSKext * withMkext2Info(
        OSDictionary * anInfoDict,
        OSData       * mkextData);
    virtual bool initWithMkext2Info(
        OSDictionary * anInfoDict,
        OSData       * mkextData);

    virtual bool setInfoDictionaryAndPath(
        OSDictionary * aDictionary,
        OSString     * aPath);
    virtual bool setExecutable(
        OSData       * anExecutable,
        OSData       * externalData        = NULL,
        bool           externalDataIsMkext = false);
    virtual bool registerIdentifier(<span class="enscript-type">void</span>);

    virtual <span class="enscript-type">void</span> free(<span class="enscript-type">void</span>) APPLE_KEXT_OVERRIDE;

    <span class="enscript-type">static</span> OSReturn removeKext(
        OSKext * aKext,
        bool     terminateServicesAndRemovePersonalitiesFlag = false);

    virtual bool isInExcludeList(<span class="enscript-type">void</span>);

   <span class="enscript-comment">/* Mkexts.
    */</span>
    <span class="enscript-type">static</span> OSReturn readMkextArchive(
        OSData   * mkextData,
        uint32_t * checksumPtr = NULL);
    <span class="enscript-type">static</span> OSReturn readMkext2Archive(
        OSData * mkextData,
        OSDictionary ** mkextPlistOut,
        uint32_t * checksumPtr = NULL);
    virtual OSData * createMkext2FileEntry(
        OSData * mkextData,
        OSNumber * offsetNum,
        <span class="enscript-type">const</span> <span class="enscript-type">char</span> * entryName);
    virtual OSData * extractMkext2FileData(
        UInt8      * data,
        <span class="enscript-type">const</span> <span class="enscript-type">char</span> * name,
        uint32_t     compressedSize,
        uint32_t     fullSize);

   <span class="enscript-comment">/* Dependencies.
    */</span>
    virtual bool resolveDependencies(
        OSArray * loopStack = NULL); <span class="enscript-comment">// priv/prot
</span>    virtual bool addBleedthroughDependencies(OSArray * anArray);
    virtual bool flushDependencies(bool forceFlag = false); <span class="enscript-comment">// priv/prot
</span>    virtual uint32_t  getNumDependencies(<span class="enscript-type">void</span>);
    virtual OSArray * getDependencies(<span class="enscript-type">void</span>);

   <span class="enscript-comment">/* User-space requests (load/generic).
    */</span>
    <span class="enscript-type">static</span> OSReturn loadFromMkext(
        OSKextLogSpec   clientLogSpec,
        <span class="enscript-type">char</span>          * mkextBuffer,
        uint32_t        mkextBufferLength,
        <span class="enscript-type">char</span>         ** logInfoOut,
        uint32_t      * logInfoLengthOut);
    <span class="enscript-type">static</span> OSReturn handleRequest(
        host_priv_t     hostPriv,
        OSKextLogSpec   clientLogSpec,
        <span class="enscript-type">char</span>          * requestBuffer,
        uint32_t        requestLength,
        <span class="enscript-type">char</span>         ** responseOut,
        uint32_t      * responseLengthOut,
        <span class="enscript-type">char</span>         ** logInfoOut,
        uint32_t      * logInfoLengthOut);
    <span class="enscript-type">static</span> OSReturn serializeLogInfo(
        OSArray   * logInfoArray,
        <span class="enscript-type">char</span>     ** logInfoOut,
        uint32_t  * logInfoLengthOut);

   <span class="enscript-comment">/* Loading.
    */</span>
    virtual OSReturn load(
        OSKextExcludeLevel   startOpt         = kOSKextExcludeNone,
        OSKextExcludeLevel   startMatchingOpt = kOSKextExcludeAll,
        OSArray            * personalityNames = NULL); <span class="enscript-comment">// priv/prot
</span>    virtual OSReturn unload(<span class="enscript-type">void</span>);
    virtual OSReturn queueKextNotification(
        <span class="enscript-type">const</span> <span class="enscript-type">char</span> * notificationName,
        OSString   * kextIdentifier);

    <span class="enscript-type">static</span> <span class="enscript-type">void</span> recordIdentifierRequest(
        OSString * kextIdentifier);

    virtual OSReturn slidePrelinkedExecutable(<span class="enscript-type">void</span>);
    virtual OSReturn loadExecutable(<span class="enscript-type">void</span>);
    virtual <span class="enscript-type">void</span>     jettisonLinkeditSegment(<span class="enscript-type">void</span>);
    virtual <span class="enscript-type">void</span>     jettisonDATASegmentPadding(<span class="enscript-type">void</span>);
    <span class="enscript-type">static</span>  <span class="enscript-type">void</span>     considerDestroyingLinkContext(<span class="enscript-type">void</span>);
    virtual OSData * getExecutable(<span class="enscript-type">void</span>);
    virtual <span class="enscript-type">void</span>     setLinkedExecutable(OSData * anExecutable);
    
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_DTRACE</span>
    friend  <span class="enscript-type">void</span> OSKextRegisterKextsWithDTrace(<span class="enscript-type">void</span>);
    <span class="enscript-type">static</span>  <span class="enscript-type">void</span> registerKextsWithDTrace(<span class="enscript-type">void</span>);
    virtual <span class="enscript-type">void</span> registerWithDTrace(<span class="enscript-type">void</span>);
    virtual <span class="enscript-type">void</span> unregisterWithDTrace(<span class="enscript-type">void</span>);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CONFIG_DTRACE */</span>

    virtual OSReturn start(bool startDependenciesFlag = true);
    virtual OSReturn stop(<span class="enscript-type">void</span>);
    virtual OSReturn setVMAttributes(bool protect, bool wire);
    virtual boolean_t segmentShouldBeWired(kernel_segment_command_t *seg);
    virtual OSReturn validateKextMapping(bool startFlag);
    virtual boolean_t verifySegmentMapping(kernel_segment_command_t *seg);

    <span class="enscript-type">static</span> OSArray * copyAllKextPersonalities(
        bool filterSafeBootFlag = false);

    <span class="enscript-type">static</span>  <span class="enscript-type">void</span>  setPrelinkedPersonalities(OSArray * personalitiesArray);

    <span class="enscript-type">static</span>  <span class="enscript-type">void</span>  sendAllKextPersonalitiesToCatalog(
        bool startMatching = false);
    virtual OSReturn  sendPersonalitiesToCatalog(
        bool      startMatching    = false,
        OSArray * personalityNames = NULL);
    
    <span class="enscript-type">static</span> bool canUnloadKextWithIdentifier(
        OSString * kextIdentifier,
        bool       checkClassesFlag = true);

    <span class="enscript-type">static</span> OSReturn autounloadKext(OSKext * aKext);

   <span class="enscript-comment">/* Sync with user space.
    */</span>
    <span class="enscript-type">static</span> OSReturn pingKextd(<span class="enscript-type">void</span>);

   <span class="enscript-comment">/* Getting info about loaded kexts (kextstat).
    */</span>
    <span class="enscript-type">static</span>  OSDictionary * copyLoadedKextInfo(
        OSArray * kextIdentifiers = NULL,
        OSArray * keys = NULL);
    virtual OSDictionary * copyInfo(OSArray * keys = NULL);

   <span class="enscript-comment">/* Logging to user space.
    */</span>
    <span class="enscript-type">static</span> OSKextLogSpec setUserSpaceLogFilter(
        OSKextLogSpec  userLogSpec,
        bool           captureFlag = false);
    <span class="enscript-type">static</span> OSArray * clearUserSpaceLogFilter(<span class="enscript-type">void</span>);
    <span class="enscript-type">static</span> OSKextLogSpec getUserSpaceLogFilter(<span class="enscript-type">void</span>);

   <span class="enscript-comment">/* OSMetaClasses defined by kext.
    */</span>
    virtual OSReturn addClass(
        OSMetaClass * aClass,
        uint32_t     numClasses);
    virtual OSReturn removeClass(
        OSMetaClass * aClass);
    virtual bool    hasOSMetaClassInstances(<span class="enscript-type">void</span>);
    virtual OSSet * getMetaClasses(<span class="enscript-type">void</span>);
    <span class="enscript-type">static</span>  <span class="enscript-type">void</span> reportOSMetaClassInstances(
        <span class="enscript-type">const</span> <span class="enscript-type">char</span>     * kextIdentifier,
        OSKextLogSpec    msgLogSpec);
    virtual <span class="enscript-type">void</span> reportOSMetaClassInstances(
        OSKextLogSpec msgLogSpec);

   <span class="enscript-comment">/* Resource requests and other callback stuff.
    */</span>
    <span class="enscript-type">static</span> OSReturn dispatchResource(OSDictionary * requestDict);

    <span class="enscript-type">static</span> OSReturn dequeueCallbackForRequestTag(
        OSKextRequestTag    requestTag,
        OSDictionary     ** callbackRecordOut);
    <span class="enscript-type">static</span> OSReturn dequeueCallbackForRequestTag(
        OSNumber     *    requestTagNum,
        OSDictionary ** callbackRecordOut);
    <span class="enscript-type">static</span> <span class="enscript-type">void</span> invokeRequestCallback(
        OSDictionary * callbackRecord,
        OSReturn         requestResult);
    virtual <span class="enscript-type">void</span> invokeOrCancelRequestCallbacks(
        OSReturn callbackResult,
        bool     invokeFlag = true);
    virtual uint32_t countRequestCallbacks(<span class="enscript-type">void</span>);

   <span class="enscript-comment">/* panic() support.
    */</span>
    <span class="enscript-type">static</span> <span class="enscript-type">void</span> printKextsInBacktrace(
        vm_offset_t   * addr,
        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>    cnt,
        <span class="enscript-type">int</span>          (* printf_func)(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *fmt, ...),
        bool            lockFlag,
        bool            doUnslide);
    <span class="enscript-type">static</span> boolean_t summaryIsInBacktrace(
        OSKextLoadedKextSummary * summary,
        vm_offset_t             * addr,
        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>              cnt);
    <span class="enscript-type">static</span> <span class="enscript-type">void</span> printSummary(
        OSKextLoadedKextSummary * summary,
        <span class="enscript-type">int</span>                    (* printf_func)(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *fmt, ...),
        bool                      doUnslide);

    <span class="enscript-type">static</span> <span class="enscript-type">int</span> saveLoadedKextPanicListTyped(
        <span class="enscript-type">const</span> <span class="enscript-type">char</span> * prefix,
        <span class="enscript-type">int</span>          invertFlag,
        <span class="enscript-type">int</span>          libsFlag,
        <span class="enscript-type">char</span>       * paniclist,
        uint32_t     list_size);
    <span class="enscript-type">static</span> <span class="enscript-type">void</span> saveLoadedKextPanicList(<span class="enscript-type">void</span>);
    <span class="enscript-type">void</span> savePanicString(bool isLoading);
    <span class="enscript-type">static</span> <span class="enscript-type">void</span> printKextPanicLists(<span class="enscript-type">int</span> (*printf_func)(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *fmt, ...));

   <span class="enscript-comment">/* Kext summary support.
    */</span>
    <span class="enscript-type">static</span> <span class="enscript-type">void</span> updateLoadedKextSummaries(<span class="enscript-type">void</span>);
    <span class="enscript-type">void</span> updateLoadedKextSummary(OSKextLoadedKextSummary *summary);
    <span class="enscript-type">void</span> updateActiveAccount(OSKextActiveAccount *account);

    <span class="enscript-comment">/* C++ Initialization.
     */</span>
    virtual <span class="enscript-type">void</span>               setCPPInitialized(bool initialized=true);



#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PRAGMA_MARK</span>
<span class="enscript-comment">/**************************************/</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> <span class="enscript-variable-name">Public</span> <span class="enscript-variable-name">Functions</span>
<span class="enscript-comment">/**************************************/</span>
#<span class="enscript-reference">endif</span>
<span class="enscript-reference">public</span>:
    <span class="enscript-comment">// caller must release
</span>    <span class="enscript-type">static</span> OSKext * lookupKextWithIdentifier(<span class="enscript-type">const</span> <span class="enscript-type">char</span> * kextIdentifier);
    <span class="enscript-type">static</span> OSKext * lookupKextWithIdentifier(OSString * kextIdentifier);
    <span class="enscript-type">static</span> OSKext * lookupKextWithLoadTag(OSKextLoadTag aTag);
    <span class="enscript-type">static</span> OSKext * lookupKextWithAddress(vm_address_t address);
    <span class="enscript-type">static</span> OSKext * lookupKextWithUUID(uuid_t uuid);

    kernel_section_t *lookupSection(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *segname, <span class="enscript-type">const</span> <span class="enscript-type">char</span>*secname);
    
    <span class="enscript-type">static</span> bool isKextWithIdentifierLoaded(<span class="enscript-type">const</span> <span class="enscript-type">char</span> * kextIdentifier);

    <span class="enscript-type">static</span> OSReturn loadKextWithIdentifier(
        <span class="enscript-type">const</span> <span class="enscript-type">char</span>       * kextIdentifier,
        Boolean            allowDeferFlag      = true,
        Boolean            delayAutounloadFlag = false,
        OSKextExcludeLevel startOpt            = kOSKextExcludeNone,
        OSKextExcludeLevel startMatchingOpt    = kOSKextExcludeAll,
        OSArray          * personalityNames    = NULL);
    <span class="enscript-type">static</span> OSReturn loadKextWithIdentifier(
        OSString         * kextIdentifier,
        Boolean            allowDeferFlag      = true,
        Boolean            delayAutounloadFlag = false,
        OSKextExcludeLevel startOpt            = kOSKextExcludeNone,
        OSKextExcludeLevel startMatchingOpt    = kOSKextExcludeAll,
        OSArray          * personalityNames    = NULL);
    <span class="enscript-type">static</span> OSReturn removeKextWithIdentifier(
        <span class="enscript-type">const</span> <span class="enscript-type">char</span> * kextIdentifier,
        bool         terminateServicesAndRemovePersonalitiesFlag = false);
    <span class="enscript-type">static</span> OSReturn removeKextWithLoadTag(
        OSKextLoadTag loadTag,
        bool          terminateServicesAndRemovePersonalitiesFlag = false);

    <span class="enscript-type">static</span> OSReturn requestResource(
        <span class="enscript-type">const</span> <span class="enscript-type">char</span>                    * kextIdentifier,
        <span class="enscript-type">const</span> <span class="enscript-type">char</span>                    * resourceName,
        OSKextRequestResourceCallback   callback,
        <span class="enscript-type">void</span>                          * context,
        OSKextRequestTag              * requestTagOut);
    <span class="enscript-type">static</span> OSReturn cancelRequest(
        OSKextRequestTag    requestTag,
        <span class="enscript-type">void</span>             ** contextOut); 

    <span class="enscript-type">static</span> <span class="enscript-type">void</span>     considerUnloads(Boolean rescheduleOnlyFlag = false);
    <span class="enscript-type">static</span> <span class="enscript-type">void</span>     flushNonloadedKexts(Boolean flushPrelinkedKexts);
    <span class="enscript-type">static</span> <span class="enscript-type">void</span>     setKextdActive(Boolean active = true);
    <span class="enscript-type">static</span> <span class="enscript-type">void</span>     setDeferredLoadSucceeded(Boolean succeeded = true);
    <span class="enscript-type">static</span> <span class="enscript-type">void</span>     considerRebuildOfPrelinkedKernel(<span class="enscript-type">void</span>);
    <span class="enscript-type">static</span> <span class="enscript-type">void</span>     createExcludeListFromBooterData(
                                            OSDictionary * theDictionary,
                                            OSCollectionIterator * theIterator);
    <span class="enscript-type">static</span> <span class="enscript-type">void</span>     createExcludeListFromPrelinkInfo(OSArray * theInfoArray);

    virtual bool    setAutounloadEnabled(bool flag);

    virtual <span class="enscript-type">const</span> OSSymbol   * getIdentifier(<span class="enscript-type">void</span>);
    virtual <span class="enscript-type">const</span> <span class="enscript-type">char</span>       * getIdentifierCString(<span class="enscript-type">void</span>);
    virtual OSKextVersion      getVersion(<span class="enscript-type">void</span>);
    virtual OSKextVersion      getCompatibleVersion(<span class="enscript-type">void</span>);
    virtual bool               isLibrary(<span class="enscript-type">void</span>);
    virtual bool               isCompatibleWithVersion(OSKextVersion aVersion);
    virtual OSObject         * getPropertyForHostArch(<span class="enscript-type">const</span> <span class="enscript-type">char</span> * key);
        
    virtual OSKextLoadTag      getLoadTag(<span class="enscript-type">void</span>);
    virtual <span class="enscript-type">void</span>               getSizeInfo(uint32_t *loadSize, uint32_t *wiredSize);
    virtual OSData           * copyUUID(<span class="enscript-type">void</span>);
    virtual OSArray          * copyPersonalitiesArray(<span class="enscript-type">void</span>);
    
   <span class="enscript-comment">/* This removes personalities naming the kext (by CFBundleIdentifier),
    * not all personalities defined by the kext (IOPersonalityPublisher or CFBundleIdentifier).
    */</span>
    virtual <span class="enscript-type">void</span>               removePersonalitiesFromCatalog(<span class="enscript-type">void</span>);

   <span class="enscript-comment">/* Converts common string-valued properties to OSSymbols for lower memory consumption.
    */</span>
    <span class="enscript-type">static</span> <span class="enscript-type">void</span> uniquePersonalityProperties(OSDictionary * personalityDict);

    virtual bool               declaresExecutable(<span class="enscript-type">void</span>);     <span class="enscript-comment">// might be missing
</span>    virtual bool               isInterface(<span class="enscript-type">void</span>);
    virtual bool               isKernel(<span class="enscript-type">void</span>);
    virtual bool               isKernelComponent(<span class="enscript-type">void</span>);
    virtual bool               isExecutable(<span class="enscript-type">void</span>);
    virtual bool               isLoadableInSafeBoot(<span class="enscript-type">void</span>);
    virtual bool               isPrelinked(<span class="enscript-type">void</span>);
    virtual bool               isLoaded(<span class="enscript-type">void</span>);
    virtual bool               isStarted(<span class="enscript-type">void</span>);
    virtual bool               isCPPInitialized(<span class="enscript-type">void</span>);
};


#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !_LIBKERN_OSKEXT_H */</span>
</pre>
<hr />
</body></html>