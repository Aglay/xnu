<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>tree.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">tree.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2009-2010 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 *
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 *
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 *
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

<span class="enscript-comment">/*	$NetBSD: tree.h,v 1.13 2006/08/27 22:32:38 christos Exp $	*/</span>
<span class="enscript-comment">/*	$OpenBSD: tree.h,v 1.7 2002/10/17 21:51:54 art Exp $	*/</span>
<span class="enscript-comment">/*
 * Copyright 2002 Niels Provos &lt;<a href="mailto:provos@citi.umich.edu">provos@citi.umich.edu</a>&gt;
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
 * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */</span>

#<span class="enscript-reference">ifndef</span>	<span class="enscript-variable-name">_LIBKERN_TREE_H_</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">_LIBKERN_TREE_H_</span>

<span class="enscript-comment">/*
 * This file defines data structures for different types of trees:
 * splay trees and red-black trees.
 *
 * A splay tree is a self-organizing data structure.  Every operation
 * on the tree causes a splay to happen.  The splay moves the requested
 * node to the root of the tree and partly rebalances it.
 *
 * This has the benefit that request locality causes faster lookups as
 * the requested nodes move to the top of the tree.  On the other hand,
 * every lookup causes memory writes.
 *
 * The Balance Theorem bounds the total access time for m operations
 * and n inserts on an initially empty tree as O((m + n)lg n).  The
 * amortized cost for a sequence of m accesses to a splay tree is O(lg n);
 *
 * A red-black tree is a binary search tree with the node color as an
 * extra attribute.  It fulfills a set of conditions:
 *	- every search path from the root to a leaf consists of the
 *	  same number of black nodes,
 *	- each red node (except for the root) has a black parent,
 *	- each leaf node is black.
 *
 * Every operation on a red-black tree is bounded as O(lg n).
 * The maximum height of a red-black tree is 2lg (n+1).
 */</span>

#<span class="enscript-reference">define</span> <span class="enscript-function-name">SPLAY_HEAD</span>(name, type)						\
<span class="enscript-type">struct</span> name {								\
	<span class="enscript-type">struct</span> type *sph_root; <span class="enscript-comment">/* root of the tree */</span>			\
}

#<span class="enscript-reference">define</span> <span class="enscript-function-name">SPLAY_INITIALIZER</span>(root)						\
	{ NULL }

#<span class="enscript-reference">define</span> <span class="enscript-function-name">SPLAY_INIT</span>(root) do {						\
	(root)-&gt;sph_root = NULL;					\
} <span class="enscript-keyword">while</span> (<span class="enscript-comment">/*CONSTCOND*/</span> 0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">SPLAY_ENTRY</span>(type)						\
<span class="enscript-type">struct</span> {								\
	<span class="enscript-type">struct</span> type *spe_left; <span class="enscript-comment">/* left element */</span>			\
	<span class="enscript-type">struct</span> type *spe_right; <span class="enscript-comment">/* right element */</span>			\
}

#<span class="enscript-reference">define</span> <span class="enscript-function-name">SPLAY_LEFT</span>(elm, field)		(elm)-&gt;field.spe_left
#<span class="enscript-reference">define</span> <span class="enscript-function-name">SPLAY_RIGHT</span>(elm, field)		(elm)-&gt;field.spe_right
#<span class="enscript-reference">define</span> <span class="enscript-function-name">SPLAY_ROOT</span>(head)		(head)-&gt;sph_root
#<span class="enscript-reference">define</span> <span class="enscript-function-name">SPLAY_EMPTY</span>(head)		(SPLAY_ROOT(head) == NULL)

<span class="enscript-comment">/* SPLAY_ROTATE_{LEFT,RIGHT} expect that tmp hold SPLAY_{RIGHT,LEFT} */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">SPLAY_ROTATE_RIGHT</span>(head, tmp, field) do {			\
	SPLAY_LEFT((head)-&gt;sph_root, field) = SPLAY_RIGHT(tmp, field);	\
	SPLAY_RIGHT(tmp, field) = (head)-&gt;sph_root;			\
	(head)-&gt;sph_root = tmp;						\
} <span class="enscript-keyword">while</span> (<span class="enscript-comment">/*CONSTCOND*/</span> 0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">SPLAY_ROTATE_LEFT</span>(head, tmp, field) do {			\
	SPLAY_RIGHT((head)-&gt;sph_root, field) = SPLAY_LEFT(tmp, field);	\
	SPLAY_LEFT(tmp, field) = (head)-&gt;sph_root;			\
	(head)-&gt;sph_root = tmp;						\
} <span class="enscript-keyword">while</span> (<span class="enscript-comment">/*CONSTCOND*/</span> 0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">SPLAY_LINKLEFT</span>(head, tmp, field) do {				\
	SPLAY_LEFT(tmp, field) = (head)-&gt;sph_root;			\
	tmp = (head)-&gt;sph_root;						\
	(head)-&gt;sph_root = SPLAY_LEFT((head)-&gt;sph_root, field);		\
} <span class="enscript-keyword">while</span> (<span class="enscript-comment">/*CONSTCOND*/</span> 0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">SPLAY_LINKRIGHT</span>(head, tmp, field) do {				\
	SPLAY_RIGHT(tmp, field) = (head)-&gt;sph_root;			\
	tmp = (head)-&gt;sph_root;						\
	(head)-&gt;sph_root = SPLAY_RIGHT((head)-&gt;sph_root, field);	\
} <span class="enscript-keyword">while</span> (<span class="enscript-comment">/*CONSTCOND*/</span> 0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">SPLAY_ASSEMBLE</span>(head, node, left, right, field) do {		\
	SPLAY_RIGHT(left, field) = SPLAY_LEFT((head)-&gt;sph_root, field);	\
	SPLAY_LEFT(right, field) = SPLAY_RIGHT((head)-&gt;sph_root, field);\
	SPLAY_LEFT((head)-&gt;sph_root, field) = SPLAY_RIGHT(node, field);	\
	SPLAY_RIGHT((head)-&gt;sph_root, field) = SPLAY_LEFT(node, field);	\
} <span class="enscript-keyword">while</span> (<span class="enscript-comment">/*CONSTCOND*/</span> 0)

<span class="enscript-comment">/* Generates prototypes and inline functions */</span>

#<span class="enscript-reference">define</span> <span class="enscript-function-name">SPLAY_PROTOTYPE</span>(name, type, field, cmp)				\
<span class="enscript-type">void</span> name##_SPLAY(<span class="enscript-type">struct</span> name *, <span class="enscript-type">struct</span> type *);			\
<span class="enscript-type">void</span> name##_SPLAY_MINMAX(<span class="enscript-type">struct</span> name *, <span class="enscript-type">int</span>);				\
<span class="enscript-type">struct</span> type *name##_SPLAY_INSERT(<span class="enscript-type">struct</span> name *, <span class="enscript-type">struct</span> type *);		\
<span class="enscript-type">struct</span> type *name##_SPLAY_REMOVE(<span class="enscript-type">struct</span> name *, <span class="enscript-type">struct</span> type *);		\
									\
<span class="enscript-comment">/* Finds the node with the same key as elm */</span>				\
<span class="enscript-type">static</span> __inline <span class="enscript-type">struct</span> type *						\
name##_SPLAY_FIND(<span class="enscript-type">struct</span> name *head, <span class="enscript-type">struct</span> type *elm)			\
{									\
	<span class="enscript-keyword">if</span> (SPLAY_EMPTY(head))						\
		<span class="enscript-keyword">return</span>(NULL);						\
	name##_SPLAY(head, elm);					\
	<span class="enscript-keyword">if</span> ((cmp)(elm, (head)-&gt;sph_root) == 0)				\
		<span class="enscript-keyword">return</span> (head-&gt;sph_root);				\
	<span class="enscript-keyword">return</span> (NULL);							\
}									\
									\
<span class="enscript-type">static</span> __inline <span class="enscript-type">struct</span> type *						\
name##_SPLAY_NEXT(<span class="enscript-type">struct</span> name *head, <span class="enscript-type">struct</span> type *elm)			\
{									\
	name##_SPLAY(head, elm);					\
	<span class="enscript-keyword">if</span> (SPLAY_RIGHT(elm, field) != NULL) {				\
		elm = SPLAY_RIGHT(elm, field);				\
		<span class="enscript-keyword">while</span> (SPLAY_LEFT(elm, field) != NULL) {		\
			elm = SPLAY_LEFT(elm, field);			\
		}							\
	} <span class="enscript-keyword">else</span>								\
		elm = NULL;						\
	<span class="enscript-keyword">return</span> (elm);							\
}									\
									\
<span class="enscript-type">static</span> __inline <span class="enscript-type">struct</span> type *						\
name##_SPLAY_MIN_MAX(<span class="enscript-type">struct</span> name *head, <span class="enscript-type">int</span> val)			\
{									\
	name##_SPLAY_MINMAX(head, val);					\
        <span class="enscript-keyword">return</span> (SPLAY_ROOT(head));					\
}

<span class="enscript-comment">/* Main splay operation.
 * Moves node close to the key of elm to top
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">SPLAY_GENERATE</span>(name, type, field, cmp)				\
<span class="enscript-type">struct</span> type *								\
name##_SPLAY_INSERT(<span class="enscript-type">struct</span> name *head, <span class="enscript-type">struct</span> type *elm)		\
{									\
    <span class="enscript-keyword">if</span> (SPLAY_EMPTY(head)) {						\
	    SPLAY_LEFT(elm, field) = SPLAY_RIGHT(elm, field) = NULL;	\
    } <span class="enscript-keyword">else</span> {								\
	    <span class="enscript-type">int</span> __comp;							\
	    name##_SPLAY(head, elm);					\
	    __comp = (cmp)(elm, (head)-&gt;sph_root);			\
	    <span class="enscript-keyword">if</span>(__comp &lt; 0) {						\
		    SPLAY_LEFT(elm, field) = SPLAY_LEFT((head)-&gt;sph_root, field);\
		    SPLAY_RIGHT(elm, field) = (head)-&gt;sph_root;		\
		    SPLAY_LEFT((head)-&gt;sph_root, field) = NULL;		\
	    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (__comp &gt; 0) {					\
		    SPLAY_RIGHT(elm, field) = SPLAY_RIGHT((head)-&gt;sph_root, field);\
		    SPLAY_LEFT(elm, field) = (head)-&gt;sph_root;		\
		    SPLAY_RIGHT((head)-&gt;sph_root, field) = NULL;	\
	    } <span class="enscript-keyword">else</span>							\
		    <span class="enscript-keyword">return</span> ((head)-&gt;sph_root);				\
    }									\
    (head)-&gt;sph_root = (elm);						\
    <span class="enscript-keyword">return</span> (NULL);							\
}									\
									\
<span class="enscript-type">struct</span> type *								\
name##_SPLAY_REMOVE(<span class="enscript-type">struct</span> name *head, <span class="enscript-type">struct</span> type *elm)		\
{									\
	<span class="enscript-type">struct</span> type *__tmp;						\
	<span class="enscript-keyword">if</span> (SPLAY_EMPTY(head))						\
		<span class="enscript-keyword">return</span> (NULL);						\
	name##_SPLAY(head, elm);					\
	<span class="enscript-keyword">if</span> ((cmp)(elm, (head)-&gt;sph_root) == 0) {			\
		<span class="enscript-keyword">if</span> (SPLAY_LEFT((head)-&gt;sph_root, field) == NULL) {	\
			(head)-&gt;sph_root = SPLAY_RIGHT((head)-&gt;sph_root, field);\
		} <span class="enscript-keyword">else</span> {						\
			__tmp = SPLAY_RIGHT((head)-&gt;sph_root, field);	\
			(head)-&gt;sph_root = SPLAY_LEFT((head)-&gt;sph_root, field);\
			name##_SPLAY(head, elm);			\
			SPLAY_RIGHT((head)-&gt;sph_root, field) = __tmp;	\
		}							\
		<span class="enscript-keyword">return</span> (elm);						\
	}								\
	<span class="enscript-keyword">return</span> (NULL);							\
}									\
									\
<span class="enscript-type">void</span>									\
name##_SPLAY(<span class="enscript-type">struct</span> name *head, <span class="enscript-type">struct</span> type *elm)			\
{									\
	<span class="enscript-type">struct</span> type __node, *__left, *__right, *__tmp;			\
	<span class="enscript-type">int</span> __comp;							\
\
	SPLAY_LEFT(&amp;__node, field) = SPLAY_RIGHT(&amp;__node, field) = NULL;\
	__left = __right = &amp;__node;					\
\
	<span class="enscript-keyword">while</span> ((__comp = (cmp)(elm, (head)-&gt;sph_root)) != 0) {		\
		<span class="enscript-keyword">if</span> (__comp &lt; 0) {					\
			__tmp = SPLAY_LEFT((head)-&gt;sph_root, field);	\
			<span class="enscript-keyword">if</span> (__tmp == NULL)				\
				<span class="enscript-keyword">break</span>;					\
			<span class="enscript-keyword">if</span> ((cmp)(elm, __tmp) &lt; 0){			\
				SPLAY_ROTATE_RIGHT(head, __tmp, field);	\
				<span class="enscript-keyword">if</span> (SPLAY_LEFT((head)-&gt;sph_root, field) == NULL)\
					<span class="enscript-keyword">break</span>;				\
			}						\
			SPLAY_LINKLEFT(head, __right, field);		\
		} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (__comp &gt; 0) {				\
			__tmp = SPLAY_RIGHT((head)-&gt;sph_root, field);	\
			<span class="enscript-keyword">if</span> (__tmp == NULL)				\
				<span class="enscript-keyword">break</span>;					\
			<span class="enscript-keyword">if</span> ((cmp)(elm, __tmp) &gt; 0){			\
				SPLAY_ROTATE_LEFT(head, __tmp, field);	\
				<span class="enscript-keyword">if</span> (SPLAY_RIGHT((head)-&gt;sph_root, field) == NULL)\
					<span class="enscript-keyword">break</span>;				\
			}						\
			SPLAY_LINKRIGHT(head, __left, field);		\
		}							\
	}								\
	SPLAY_ASSEMBLE(head, &amp;__node, __left, __right, field);		\
}									\
									\
<span class="enscript-comment">/* Splay with either the minimum or the maximum element			\
 * Used to find minimum or maximum element in tree.			\
 */</span>									\
<span class="enscript-type">void</span> name##_SPLAY_MINMAX(<span class="enscript-type">struct</span> name *head, <span class="enscript-type">int</span> __comp) \
{									\
	<span class="enscript-type">struct</span> type __node, *__left, *__right, *__tmp;			\
\
	SPLAY_LEFT(&amp;__node, field) = SPLAY_RIGHT(&amp;__node, field) = NULL;\
	__left = __right = &amp;__node;					\
\
	<span class="enscript-keyword">while</span> (1) {							\
		<span class="enscript-keyword">if</span> (__comp &lt; 0) {					\
			__tmp = SPLAY_LEFT((head)-&gt;sph_root, field);	\
			<span class="enscript-keyword">if</span> (__tmp == NULL)				\
				<span class="enscript-keyword">break</span>;					\
			<span class="enscript-keyword">if</span> (__comp &lt; 0){				\
				SPLAY_ROTATE_RIGHT(head, __tmp, field);	\
				<span class="enscript-keyword">if</span> (SPLAY_LEFT((head)-&gt;sph_root, field) == NULL)\
					<span class="enscript-keyword">break</span>;				\
			}						\
			SPLAY_LINKLEFT(head, __right, field);		\
		} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (__comp &gt; 0) {				\
			__tmp = SPLAY_RIGHT((head)-&gt;sph_root, field);	\
			<span class="enscript-keyword">if</span> (__tmp == NULL)				\
				<span class="enscript-keyword">break</span>;					\
			<span class="enscript-keyword">if</span> (__comp &gt; 0) {				\
				SPLAY_ROTATE_LEFT(head, __tmp, field);	\
				<span class="enscript-keyword">if</span> (SPLAY_RIGHT((head)-&gt;sph_root, field) == NULL)\
					<span class="enscript-keyword">break</span>;				\
			}						\
			SPLAY_LINKRIGHT(head, __left, field);		\
		}							\
	}								\
	SPLAY_ASSEMBLE(head, &amp;__node, __left, __right, field);		\
}

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SPLAY_NEGINF</span>	-1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SPLAY_INF</span>	1

#<span class="enscript-reference">define</span> <span class="enscript-function-name">SPLAY_INSERT</span>(name, x, y)	name##_SPLAY_INSERT(x, y)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">SPLAY_REMOVE</span>(name, x, y)	name##_SPLAY_REMOVE(x, y)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">SPLAY_FIND</span>(name, x, y)		name##_SPLAY_FIND(x, y)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">SPLAY_NEXT</span>(name, x, y)		name##_SPLAY_NEXT(x, y)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">SPLAY_MIN</span>(name, x)		(SPLAY_EMPTY(x) ? NULL	\
					: name##_SPLAY_MIN_MAX(x, SPLAY_NEGINF))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">SPLAY_MAX</span>(name, x)		(SPLAY_EMPTY(x) ? NULL	\
					: name##_SPLAY_MIN_MAX(x, SPLAY_INF))

#<span class="enscript-reference">define</span> <span class="enscript-function-name">SPLAY_FOREACH</span>(x, name, head)					\
	<span class="enscript-keyword">for</span> ((x) = SPLAY_MIN(name, head);				\
	     (x) != NULL;						\
	     (x) = SPLAY_NEXT(name, head, x))

<span class="enscript-comment">/* Macros that define a red-black tree */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_HEAD</span>(name, type)						\
<span class="enscript-type">struct</span> name {								\
	<span class="enscript-type">struct</span> type *rbh_root; <span class="enscript-comment">/* root of the tree */</span>			\
}

#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_INITIALIZER</span>(root)						\
	{ NULL }

#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_INIT</span>(root) do {						\
	(root)-&gt;rbh_root = NULL;					\
} <span class="enscript-keyword">while</span> (<span class="enscript-comment">/*CONSTCOND*/</span> 0)

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">RB_BLACK</span>	0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">RB_RED</span>		1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">RB_PLACEHOLDER</span>	NULL
#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_ENTRY</span>(type)							\
<span class="enscript-type">struct</span> {								\
	<span class="enscript-type">struct</span> type *rbe_left;		<span class="enscript-comment">/* left element */</span>		\
	<span class="enscript-type">struct</span> type *rbe_right;		<span class="enscript-comment">/* right element */</span>		\
	<span class="enscript-type">struct</span> type *rbe_parent;	<span class="enscript-comment">/* parent element */</span>		\
}

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">RB_COLOR_MASK</span>			(uintptr_t)0x1
#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_LEFT</span>(elm, field)		(elm)-&gt;field.rbe_left
#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_RIGHT</span>(elm, field)		(elm)-&gt;field.rbe_right
#<span class="enscript-reference">define</span> <span class="enscript-function-name">_RB_PARENT</span>(elm, field)		(elm)-&gt;field.rbe_parent
#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_ROOT</span>(head)			(head)-&gt;rbh_root
#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_EMPTY</span>(head)			(RB_ROOT(head) == NULL)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_SET</span>(name, elm, parent, field) do {					\
	name##_RB_SETPARENT(elm, parent);					\
	RB_LEFT(elm, field) = RB_RIGHT(elm, field) = NULL;		\
	name##_RB_SETCOLOR(elm, RB_RED);				\
} <span class="enscript-keyword">while</span> (<span class="enscript-comment">/*CONSTCOND*/</span> 0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_SET_BLACKRED</span>(name, black, red, field) do {				\
	name##_RB_SETCOLOR(black,  RB_BLACK);				\
	name##_RB_SETCOLOR(red, RB_RED);					\
} <span class="enscript-keyword">while</span> (<span class="enscript-comment">/*CONSTCOND*/</span> 0)

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">RB_AUGMENT</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_AUGMENT</span>(x) (void)(x)
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_ROTATE_LEFT</span>(name, head, elm, tmp, field) do {			\
	(tmp) = RB_RIGHT(elm, field);					\
	<span class="enscript-keyword">if</span> ((RB_RIGHT(elm, field) = RB_LEFT(tmp, field)) != NULL) {	\
		name##_RB_SETPARENT(RB_LEFT(tmp, field),(elm));		\
	}								\
	RB_AUGMENT(elm);						\
	<span class="enscript-keyword">if</span> (name##_RB_SETPARENT(tmp, name##_RB_GETPARENT(elm)) != NULL) {	\
		<span class="enscript-keyword">if</span> ((elm) == RB_LEFT(name##_RB_GETPARENT(elm), field))	\
			RB_LEFT(name##_RB_GETPARENT(elm), field) = (tmp);	\
		<span class="enscript-keyword">else</span>							\
			RB_RIGHT(name##_RB_GETPARENT(elm), field) = (tmp);	\
	} <span class="enscript-keyword">else</span>								\
		(head)-&gt;rbh_root = (tmp);				\
	RB_LEFT(tmp, field) = (elm);					\
	name##_RB_SETPARENT(elm, (tmp));					\
	RB_AUGMENT(tmp);						\
	<span class="enscript-keyword">if</span> ((name##_RB_GETPARENT(tmp)))					\
		RB_AUGMENT(name##_RB_GETPARENT(tmp));			\
} <span class="enscript-keyword">while</span> (<span class="enscript-comment">/*CONSTCOND*/</span> 0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_ROTATE_RIGHT</span>(name, head, elm, tmp, field) do {			\
	(tmp) = RB_LEFT(elm, field);					\
	<span class="enscript-keyword">if</span> ((RB_LEFT(elm, field) = RB_RIGHT(tmp, field)) != NULL) {	\
		name##_RB_SETPARENT(RB_RIGHT(tmp, field), (elm));		\
	}								\
	RB_AUGMENT(elm);						\
	<span class="enscript-keyword">if</span> (name##_RB_SETPARENT(tmp, name##_RB_GETPARENT(elm)) != NULL) {	\
		<span class="enscript-keyword">if</span> ((elm) == RB_LEFT(name##_RB_GETPARENT(elm), field))	\
			RB_LEFT(name##_RB_GETPARENT(elm), field) = (tmp);	\
		<span class="enscript-keyword">else</span>							\
			RB_RIGHT(name##_RB_GETPARENT(elm), field) = (tmp);	\
	} <span class="enscript-keyword">else</span>								\
		(head)-&gt;rbh_root = (tmp);				\
	RB_RIGHT(tmp, field) = (elm);					\
	name##_RB_SETPARENT(elm, tmp);					\
	RB_AUGMENT(tmp);						\
	<span class="enscript-keyword">if</span> ((name##_RB_GETPARENT(tmp)))					\
		RB_AUGMENT(name##_RB_GETPARENT(tmp));			\
} <span class="enscript-keyword">while</span> (<span class="enscript-comment">/*CONSTCOND*/</span> 0)

<span class="enscript-comment">/* Generates prototypes and inline functions */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_PROTOTYPE</span>(name, type, field, cmp)				\
<span class="enscript-type">void</span> name##_RB_INSERT_COLOR(<span class="enscript-type">struct</span> name *, <span class="enscript-type">struct</span> type *);	\
<span class="enscript-type">void</span> name##_RB_REMOVE_COLOR(<span class="enscript-type">struct</span> name *, <span class="enscript-type">struct</span> type *, <span class="enscript-type">struct</span> type *);\
<span class="enscript-type">struct</span> type *name##_RB_REMOVE(<span class="enscript-type">struct</span> name *, <span class="enscript-type">struct</span> type *);		\
<span class="enscript-type">struct</span> type *name##_RB_INSERT(<span class="enscript-type">struct</span> name *, <span class="enscript-type">struct</span> type *);		\
<span class="enscript-type">struct</span> type *name##_RB_FIND(<span class="enscript-type">struct</span> name *, <span class="enscript-type">struct</span> type *);		\
<span class="enscript-type">struct</span> type *name##_RB_NEXT(<span class="enscript-type">struct</span> type *);				\
<span class="enscript-type">struct</span> type *name##_RB_MINMAX(<span class="enscript-type">struct</span> name *, <span class="enscript-type">int</span>);			\
<span class="enscript-type">struct</span> type *name##_RB_GETPARENT(<span class="enscript-type">struct</span> type*);				\
<span class="enscript-type">struct</span> type *name##_RB_SETPARENT(<span class="enscript-type">struct</span> type*, <span class="enscript-type">struct</span> type*);		\
<span class="enscript-type">int</span> name##_RB_GETCOLOR(<span class="enscript-type">struct</span> type*);					\
<span class="enscript-type">void</span> name##_RB_SETCOLOR(<span class="enscript-type">struct</span> type*,<span class="enscript-type">int</span>);				

<span class="enscript-comment">/* Generates prototypes (with storage class) and inline functions */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_PROTOTYPE_SC</span>(_sc_, name, type, field, cmp)			\
_sc_ <span class="enscript-type">void</span> name##_RB_INSERT_COLOR(<span class="enscript-type">struct</span> name *, <span class="enscript-type">struct</span> type *);		\
_sc_ <span class="enscript-type">void</span> name##_RB_REMOVE_COLOR(<span class="enscript-type">struct</span> name *, <span class="enscript-type">struct</span> type *, <span class="enscript-type">struct</span> type *); \
_sc_ <span class="enscript-type">struct</span> type *name##_RB_REMOVE(<span class="enscript-type">struct</span> name *, <span class="enscript-type">struct</span> type *);	\
_sc_ <span class="enscript-type">struct</span> type *name##_RB_INSERT(<span class="enscript-type">struct</span> name *, <span class="enscript-type">struct</span> type *);	\
_sc_ <span class="enscript-type">struct</span> type *name##_RB_FIND(<span class="enscript-type">struct</span> name *, <span class="enscript-type">struct</span> type *);		\
_sc_ <span class="enscript-type">struct</span> type *name##_RB_NEXT(<span class="enscript-type">struct</span> type *);			\
_sc_ <span class="enscript-type">struct</span> type *name##_RB_MINMAX(<span class="enscript-type">struct</span> name *, <span class="enscript-type">int</span>);			\
_sc_ <span class="enscript-type">struct</span> type *name##_RB_GETPARENT(<span class="enscript-type">struct</span> type*);			\
_sc_ <span class="enscript-type">struct</span> type *name##_RB_SETPARENT(<span class="enscript-type">struct</span> type*, <span class="enscript-type">struct</span> type*);			\
_sc_ <span class="enscript-type">int</span> name##_RB_GETCOLOR(<span class="enscript-type">struct</span> type*);			\
_sc_ <span class="enscript-type">void</span> name##_RB_SETCOLOR(<span class="enscript-type">struct</span> type*,<span class="enscript-type">int</span>);


<span class="enscript-comment">/* Main rb operation.
 * Moves node close to the key of elm to top
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_GENERATE</span>(name, type, field, cmp)				\
<span class="enscript-type">struct</span> type *name##_RB_GETPARENT(<span class="enscript-type">struct</span> type *elm) {				\
	<span class="enscript-type">struct</span> type *parent = _RB_PARENT(elm, field);			\
	<span class="enscript-keyword">if</span>( parent != NULL) {						\
		parent = (<span class="enscript-type">struct</span> type*)((uintptr_t)parent &amp; ~RB_COLOR_MASK);\
		<span class="enscript-keyword">return</span>( (<span class="enscript-type">struct</span> type*) ( (parent == (<span class="enscript-type">struct</span> type*) RB_PLACEHOLDER) ? NULL: parent));\
	}								\
	<span class="enscript-keyword">return</span>((<span class="enscript-type">struct</span> type*)NULL);					\
}									\
<span class="enscript-type">int</span> name##_RB_GETCOLOR(<span class="enscript-type">struct</span> type *elm) {					\
	<span class="enscript-type">int</span> color = 0;							\
	color = (<span class="enscript-type">int</span>)((uintptr_t)_RB_PARENT(elm,field) &amp; RB_COLOR_MASK);\
	<span class="enscript-keyword">return</span>(color);							\
}									\
<span class="enscript-type">void</span> name##_RB_SETCOLOR(<span class="enscript-type">struct</span> type *elm,<span class="enscript-type">int</span> color) {				\
	<span class="enscript-type">struct</span> type *parent = name##_RB_GETPARENT(elm);			\
	<span class="enscript-keyword">if</span>(parent == (<span class="enscript-type">struct</span> type*)NULL) 				\
		parent = (<span class="enscript-type">struct</span> type*) RB_PLACEHOLDER;			\
	_RB_PARENT(elm, field) = (<span class="enscript-type">struct</span> type*)((uintptr_t)parent | (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>)color);\
}									\
<span class="enscript-type">struct</span> type *name##_RB_SETPARENT(<span class="enscript-type">struct</span> type *elm, <span class="enscript-type">struct</span> type *parent) {	\
	<span class="enscript-type">int</span> color = name##_RB_GETCOLOR(elm);					\
	_RB_PARENT(elm, field) = parent;				\
	<span class="enscript-keyword">if</span>(color) name##_RB_SETCOLOR(elm, color);				\
	<span class="enscript-keyword">return</span>(name##_RB_GETPARENT(elm));					\
}									\
									\
<span class="enscript-type">void</span>									\
name##_RB_INSERT_COLOR(<span class="enscript-type">struct</span> name *head, <span class="enscript-type">struct</span> type *elm)		\
{									\
	<span class="enscript-type">struct</span> type *parent, *gparent, *tmp;				\
	<span class="enscript-keyword">while</span> ((parent = name##_RB_GETPARENT(elm)) != NULL &amp;&amp;		\
	    name##_RB_GETCOLOR(parent) == RB_RED) {			\
		gparent = name##_RB_GETPARENT(parent);			\
		<span class="enscript-keyword">if</span> (parent == RB_LEFT(gparent, field)) {		\
			tmp = RB_RIGHT(gparent, field);			\
			<span class="enscript-keyword">if</span> (tmp &amp;&amp; name##_RB_GETCOLOR(tmp) == RB_RED) {	\
				name##_RB_SETCOLOR(tmp,  RB_BLACK);	\
				RB_SET_BLACKRED(name, parent, gparent, field);\
				elm = gparent;				\
				<span class="enscript-keyword">continue</span>;				\
			}						\
			<span class="enscript-keyword">if</span> (RB_RIGHT(parent, field) == elm) {		\
				RB_ROTATE_LEFT(name, head, parent, tmp, field);\
				tmp = parent;				\
				parent = elm;				\
				elm = tmp;				\
			}						\
			RB_SET_BLACKRED(name, parent, gparent, field);	\
			RB_ROTATE_RIGHT(name,head, gparent, tmp, field);	\
		} <span class="enscript-keyword">else</span> {						\
			tmp = RB_LEFT(gparent, field);			\
			<span class="enscript-keyword">if</span> (tmp &amp;&amp; name##_RB_GETCOLOR(tmp) == RB_RED) {	\
				name##_RB_SETCOLOR(tmp,  RB_BLACK);	\
				RB_SET_BLACKRED(name, parent, gparent, field);\
				elm = gparent;				\
				<span class="enscript-keyword">continue</span>;				\
			}						\
			<span class="enscript-keyword">if</span> (RB_LEFT(parent, field) == elm) {		\
				RB_ROTATE_RIGHT(name, head, parent, tmp, field);\
				tmp = parent;				\
				parent = elm;				\
				elm = tmp;				\
			}						\
			RB_SET_BLACKRED(name, parent, gparent, field);	\
			RB_ROTATE_LEFT(name, head, gparent, tmp, field);	\
		}							\
	}								\
	name##_RB_SETCOLOR(head-&gt;rbh_root,  RB_BLACK);			\
}									\
									\
<span class="enscript-type">void</span>									\
name##_RB_REMOVE_COLOR(<span class="enscript-type">struct</span> name *head, <span class="enscript-type">struct</span> type *parent, <span class="enscript-type">struct</span> type *elm) \
{									\
	<span class="enscript-type">struct</span> type *tmp;						\
	<span class="enscript-keyword">while</span> ((elm == NULL || name##_RB_GETCOLOR(elm) == RB_BLACK) &amp;&amp;	\
	    elm != RB_ROOT(head)) {					\
		<span class="enscript-keyword">if</span> (RB_LEFT(parent, field) == elm) {			\
			tmp = RB_RIGHT(parent, field);			\
			<span class="enscript-keyword">if</span> (name##_RB_GETCOLOR(tmp) == RB_RED) {		\
				RB_SET_BLACKRED(name, tmp, parent, field);	\
				RB_ROTATE_LEFT(name, head, parent, tmp, field);\
				tmp = RB_RIGHT(parent, field);		\
			}						\
			<span class="enscript-keyword">if</span> ((RB_LEFT(tmp, field) == NULL ||		\
			    name##_RB_GETCOLOR(RB_LEFT(tmp, field)) == RB_BLACK) &amp;&amp;\
			    (RB_RIGHT(tmp, field) == NULL ||		\
			    name##_RB_GETCOLOR(RB_RIGHT(tmp, field)) == RB_BLACK)) {\
				name##_RB_SETCOLOR(tmp,  RB_RED);		\
				elm = parent;				\
				parent = name##_RB_GETPARENT(elm);		\
			} <span class="enscript-keyword">else</span> {					\
				<span class="enscript-keyword">if</span> (RB_RIGHT(tmp, field) == NULL ||	\
				    name##_RB_GETCOLOR(RB_RIGHT(tmp, field)) == RB_BLACK) {\
					<span class="enscript-type">struct</span> type *oleft;		\
					<span class="enscript-keyword">if</span> ((oleft = RB_LEFT(tmp, field)) \
					    != NULL)			\
						name##_RB_SETCOLOR(oleft,  RB_BLACK);\
					name##_RB_SETCOLOR(tmp, RB_RED);	\
					RB_ROTATE_RIGHT(name, head, tmp, oleft, field);\
					tmp = RB_RIGHT(parent, field);	\
				}					\
				name##_RB_SETCOLOR(tmp, (name##_RB_GETCOLOR(parent)));\
				name##_RB_SETCOLOR(parent, RB_BLACK);	\
				<span class="enscript-keyword">if</span> (RB_RIGHT(tmp, field))		\
					name##_RB_SETCOLOR(RB_RIGHT(tmp, field),RB_BLACK);\
				RB_ROTATE_LEFT(name, head, parent, tmp, field);\
				elm = RB_ROOT(head);			\
				<span class="enscript-keyword">break</span>;					\
			}						\
		} <span class="enscript-keyword">else</span> {						\
			tmp = RB_LEFT(parent, field);			\
			<span class="enscript-keyword">if</span> (name##_RB_GETCOLOR(tmp) == RB_RED) {		\
				RB_SET_BLACKRED(name, tmp, parent, field);	\
				RB_ROTATE_RIGHT(name, head, parent, tmp, field);\
				tmp = RB_LEFT(parent, field);		\
			}						\
			<span class="enscript-keyword">if</span> ((RB_LEFT(tmp, field) == NULL ||		\
			    name##_RB_GETCOLOR(RB_LEFT(tmp, field)) == RB_BLACK) &amp;&amp;\
			    (RB_RIGHT(tmp, field) == NULL ||		\
			    name##_RB_GETCOLOR(RB_RIGHT(tmp, field)) == RB_BLACK)) {\
				name##_RB_SETCOLOR(tmp, RB_RED);		\
				elm = parent;				\
				parent = name##_RB_GETPARENT(elm);		\
			} <span class="enscript-keyword">else</span> {					\
				<span class="enscript-keyword">if</span> (RB_LEFT(tmp, field) == NULL ||	\
				    name##_RB_GETCOLOR(RB_LEFT(tmp, field)) == RB_BLACK) {\
					<span class="enscript-type">struct</span> type *oright;		\
					<span class="enscript-keyword">if</span> ((oright = RB_RIGHT(tmp, field)) \
					    != NULL)			\
						name##_RB_SETCOLOR(oright,  RB_BLACK);\
					name##_RB_SETCOLOR(tmp,  RB_RED);	\
					RB_ROTATE_LEFT(name, head, tmp, oright, field);\
					tmp = RB_LEFT(parent, field);	\
				}					\
				name##_RB_SETCOLOR(tmp,(name##_RB_GETCOLOR(parent)));\
				name##_RB_SETCOLOR(parent, RB_BLACK);	\
				<span class="enscript-keyword">if</span> (RB_LEFT(tmp, field))		\
					name##_RB_SETCOLOR(RB_LEFT(tmp, field), RB_BLACK);\
				RB_ROTATE_RIGHT(name, head, parent, tmp, field);\
				elm = RB_ROOT(head);			\
				<span class="enscript-keyword">break</span>;					\
			}						\
		}							\
	}								\
	<span class="enscript-keyword">if</span> (elm)							\
		name##_RB_SETCOLOR(elm,  RB_BLACK);			\
}									\
									\
<span class="enscript-type">struct</span> type *								\
name##_RB_REMOVE(<span class="enscript-type">struct</span> name *head, <span class="enscript-type">struct</span> type *elm)			\
{									\
	<span class="enscript-type">struct</span> type *child, *parent, *old = elm;			\
	<span class="enscript-type">int</span> color;							\
	<span class="enscript-keyword">if</span> (RB_LEFT(elm, field) == NULL)				\
		child = RB_RIGHT(elm, field);				\
	<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (RB_RIGHT(elm, field) == NULL)				\
		child = RB_LEFT(elm, field);				\
	<span class="enscript-keyword">else</span> {								\
		<span class="enscript-type">struct</span> type *left;					\
		elm = RB_RIGHT(elm, field);				\
		<span class="enscript-keyword">while</span> ((left = RB_LEFT(elm, field)) != NULL)		\
			elm = left;					\
		child = RB_RIGHT(elm, field);				\
		parent = name##_RB_GETPARENT(elm);				\
		color = name##_RB_GETCOLOR(elm);				\
		<span class="enscript-keyword">if</span> (child)						\
			name##_RB_SETPARENT(child, parent);		\
		<span class="enscript-keyword">if</span> (parent) {						\
			<span class="enscript-keyword">if</span> (RB_LEFT(parent, field) == elm)		\
				RB_LEFT(parent, field) = child;		\
			<span class="enscript-keyword">else</span>						\
				RB_RIGHT(parent, field) = child;	\
			RB_AUGMENT(parent);				\
		} <span class="enscript-keyword">else</span>							\
			RB_ROOT(head) = child;				\
		<span class="enscript-keyword">if</span> (name##_RB_GETPARENT(elm) == old)			\
			parent = elm;					\
		(elm)-&gt;field = (old)-&gt;field;				\
		<span class="enscript-keyword">if</span> (name##_RB_GETPARENT(old)) {				\
			<span class="enscript-keyword">if</span> (RB_LEFT(name##_RB_GETPARENT(old), field) == old)\
				RB_LEFT(name##_RB_GETPARENT(old), field) = elm;\
			<span class="enscript-keyword">else</span>						\
				RB_RIGHT(name##_RB_GETPARENT(old), field) = elm;\
			RB_AUGMENT(name##_RB_GETPARENT(old));		\
		} <span class="enscript-keyword">else</span>							\
			RB_ROOT(head) = elm;				\
		name##_RB_SETPARENT(RB_LEFT(old, field), elm);		\
		<span class="enscript-keyword">if</span> (RB_RIGHT(old, field))				\
			name##_RB_SETPARENT(RB_RIGHT(old, field), elm);	\
		<span class="enscript-keyword">if</span> (parent) {						\
			left = parent;					\
			<span class="enscript-keyword">do</span> {						\
				RB_AUGMENT(left);			\
			} <span class="enscript-keyword">while</span> ((left = name##_RB_GETPARENT(left)) != NULL); \
		}							\
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">color</span>;						\
	}								\
	parent = name##_RB_GETPARENT(elm);					\
	color = name##_RB_GETCOLOR(elm);					\
	<span class="enscript-keyword">if</span> (child)							\
		name##_RB_SETPARENT(child, parent);			\
	<span class="enscript-keyword">if</span> (parent) {							\
		<span class="enscript-keyword">if</span> (RB_LEFT(parent, field) == elm)			\
			RB_LEFT(parent, field) = child;			\
		<span class="enscript-keyword">else</span>							\
			RB_RIGHT(parent, field) = child;		\
		RB_AUGMENT(parent);					\
	} <span class="enscript-keyword">else</span>								\
		RB_ROOT(head) = child;					\
<span class="enscript-reference">color</span>:									\
	<span class="enscript-keyword">if</span> (color == RB_BLACK)						\
		name##_RB_REMOVE_COLOR(head, parent, child);		\
	<span class="enscript-keyword">return</span> (old);							\
}									\
									\
<span class="enscript-comment">/* Inserts a node into the RB tree */</span>					\
<span class="enscript-type">struct</span> type *								\
name##_RB_INSERT(<span class="enscript-type">struct</span> name *head, <span class="enscript-type">struct</span> type *elm)			\
{									\
	<span class="enscript-type">struct</span> type *tmp;						\
	<span class="enscript-type">struct</span> type *parent = NULL;					\
	<span class="enscript-type">int</span> comp = 0;							\
	tmp = RB_ROOT(head);						\
	<span class="enscript-keyword">while</span> (tmp) {							\
		parent = tmp;						\
		comp = (cmp)(elm, parent);				\
		<span class="enscript-keyword">if</span> (comp &lt; 0)						\
			tmp = RB_LEFT(tmp, field);			\
		<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (comp &gt; 0)					\
			tmp = RB_RIGHT(tmp, field);			\
		<span class="enscript-keyword">else</span>							\
			<span class="enscript-keyword">return</span> (tmp);					\
	}								\
	RB_SET(name, elm, parent, field);					\
	<span class="enscript-keyword">if</span> (parent != NULL) {						\
		<span class="enscript-keyword">if</span> (comp &lt; 0)						\
			RB_LEFT(parent, field) = elm;			\
		<span class="enscript-keyword">else</span>							\
			RB_RIGHT(parent, field) = elm;			\
		RB_AUGMENT(parent);					\
	} <span class="enscript-keyword">else</span>								\
		RB_ROOT(head) = elm;					\
	name##_RB_INSERT_COLOR(head, elm);				\
	<span class="enscript-keyword">return</span> (NULL);							\
}									\
									\
<span class="enscript-comment">/* Finds the node with the same key as elm */</span>				\
<span class="enscript-type">struct</span> type *								\
name##_RB_FIND(<span class="enscript-type">struct</span> name *head, <span class="enscript-type">struct</span> type *elm)			\
{									\
	<span class="enscript-type">struct</span> type *tmp = RB_ROOT(head);				\
	<span class="enscript-type">int</span> comp;							\
	<span class="enscript-keyword">while</span> (tmp) {							\
		comp = cmp(elm, tmp);					\
		<span class="enscript-keyword">if</span> (comp &lt; 0)						\
			tmp = RB_LEFT(tmp, field);			\
		<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (comp &gt; 0)					\
			tmp = RB_RIGHT(tmp, field);			\
		<span class="enscript-keyword">else</span>							\
			<span class="enscript-keyword">return</span> (tmp);					\
	}								\
	<span class="enscript-keyword">return</span> (NULL);							\
}									\
									\
<span class="enscript-comment">/* ARGSUSED */</span>								\
<span class="enscript-type">struct</span> type *								\
name##_RB_NEXT(<span class="enscript-type">struct</span> type *elm)					\
{									\
	<span class="enscript-keyword">if</span> (RB_RIGHT(elm, field)) {					\
		elm = RB_RIGHT(elm, field);				\
		<span class="enscript-keyword">while</span> (RB_LEFT(elm, field))				\
			elm = RB_LEFT(elm, field);			\
	} <span class="enscript-keyword">else</span> {							\
		<span class="enscript-keyword">if</span> (name##_RB_GETPARENT(elm) &amp;&amp;				\
		    (elm == RB_LEFT(name##_RB_GETPARENT(elm), field)))	\
			elm = name##_RB_GETPARENT(elm);			\
		<span class="enscript-keyword">else</span> {							\
			<span class="enscript-keyword">while</span> (name##_RB_GETPARENT(elm) &amp;&amp;			\
			    (elm == RB_RIGHT(name##_RB_GETPARENT(elm), field)))\
				elm = name##_RB_GETPARENT(elm);		\
			elm = name##_RB_GETPARENT(elm);			\
		}							\
	}								\
	<span class="enscript-keyword">return</span> (elm);							\
}									\
									\
<span class="enscript-type">struct</span> type *								\
name##_RB_MINMAX(<span class="enscript-type">struct</span> name *head, <span class="enscript-type">int</span> val)				\
{									\
	<span class="enscript-type">struct</span> type *tmp = RB_ROOT(head);				\
	<span class="enscript-type">struct</span> type *parent = NULL;					\
	<span class="enscript-keyword">while</span> (tmp) {							\
		parent = tmp;						\
		<span class="enscript-keyword">if</span> (val &lt; 0)						\
			tmp = RB_LEFT(tmp, field);			\
		<span class="enscript-keyword">else</span>							\
			tmp = RB_RIGHT(tmp, field);			\
	}								\
	<span class="enscript-keyword">return</span> (parent);						\
}


#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_PROTOTYPE_PREV</span>(name, type, field, cmp)			\
	RB_PROTOTYPE(name, type, field, cmp)				\
<span class="enscript-type">struct</span> type *name##_RB_PREV(<span class="enscript-type">struct</span> type *);


#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_PROTOTYPE_SC_PREV</span>(_sc_, name, type, field, cmp)		\
	RB_PROTOTYPE_SC(_sc_, name, type, field, cmp)			\
_sc_ <span class="enscript-type">struct</span> type *name##_RB_PREV(<span class="enscript-type">struct</span> type *);

#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_GENERATE_PREV</span>(name, type, field, cmp)			\
	RB_GENERATE(name, type, field, cmp)				\
<span class="enscript-type">struct</span> type *								\
name##_RB_PREV(<span class="enscript-type">struct</span> type *elm)					\
{									\
	<span class="enscript-keyword">if</span> (RB_LEFT(elm, field)) {					\
		elm = RB_LEFT(elm, field);				\
		<span class="enscript-keyword">while</span> (RB_RIGHT(elm, field))				\
			elm = RB_RIGHT(elm, field);			\
	} <span class="enscript-keyword">else</span> {							\
		<span class="enscript-keyword">if</span> (name##_RB_GETPARENT(elm) &amp;&amp;				\
		    (elm == RB_RIGHT(name##_RB_GETPARENT(elm), field)))	\
			elm = name##_RB_GETPARENT(elm);			\
		<span class="enscript-keyword">else</span> {							\
			<span class="enscript-keyword">while</span> (name##_RB_GETPARENT(elm) &amp;&amp;		\
			    (elm == RB_LEFT(name##_RB_GETPARENT(elm), field)))\
				elm = name##_RB_GETPARENT(elm);		\
			elm = name##_RB_GETPARENT(elm);			\
		}							\
	}								\
	<span class="enscript-keyword">return</span> (elm);							\
}									\

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">RB_NEGINF</span>	-1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">RB_INF</span>	1

#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_INSERT</span>(name, x, y)	name##_RB_INSERT(x, y)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_REMOVE</span>(name, x, y)	name##_RB_REMOVE(x, y)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_FIND</span>(name, x, y)	name##_RB_FIND(x, y)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_NEXT</span>(name, x, y)	name##_RB_NEXT(y)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_PREV</span>(name, x, y)	name##_RB_PREV(y)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_MIN</span>(name, x)		name##_RB_MINMAX(x, RB_NEGINF)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_MAX</span>(name, x)		name##_RB_MINMAX(x, RB_INF)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_FOREACH</span>(x, name, head)					\
	<span class="enscript-keyword">for</span> ((x) = RB_MIN(name, head);					\
	     (x) != NULL;						\
	     (x) = name##_RB_NEXT(x))

#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_FOREACH_FROM</span>(x, name, y)                                     \
	<span class="enscript-keyword">for</span> ((x) = (y);                                                 \
	    ((x) != NULL) &amp;&amp; ((y) = name##_RB_NEXT(x), (x) != NULL);    \
            (x) = (y))

#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_FOREACH_REVERSE_FROM</span>(x, name, y)				\
	<span class="enscript-keyword">for</span> ((x) = (y);							\
	    ((x) != NULL) &amp;&amp; ((y) = name##_RB_PREV(x), (x) != NULL);	\
	     (x) = (y))

#<span class="enscript-reference">define</span> <span class="enscript-function-name">RB_FOREACH_SAFE</span>(x, name, head, y)				\
	<span class="enscript-keyword">for</span> ((x) = RB_MIN(name, head);					\
	    ((x) != NULL) &amp;&amp; ((y) = name##_RB_NEXT(x), (x) != NULL);	\
	     (x) = (y))

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* _LIBKERN_TREE_H_ */</span>
</pre>
<hr />
</body></html>