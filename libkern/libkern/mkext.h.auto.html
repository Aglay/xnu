<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>mkext.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">mkext.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2008 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_MKEXT_H_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_MKEXT_H_</span> 1

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/cdefs.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/types.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/machine.h&gt;</span>

<span class="enscript-comment">/*********************************************************************
* Mkext File Format
*
* ALL BINARY VALUES ARE BIG-ENDIAN.
*********************************************************************/</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PRAGMA_MARK</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> <span class="enscript-variable-name">Constants</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MKEXT_MAGIC</span> 0x4D4B5854 <span class="enscript-comment">/* 'MKXT' */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MKEXT_SIGN</span>  0x4D4F5358 <span class="enscript-comment">/* 'MOSX' */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MKEXT_EXTN</span>  <span class="enscript-string">&quot;.mkext&quot;</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MKEXT_VERS_1</span>  (0x01008000)

<span class="enscript-comment">// Used during development/bringup: v 2.0d1
</span>#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MKEXT_VERS_2</span>  (0x02002001)
<span class="enscript-comment">// xxx - Will use this when format is final
</span><span class="enscript-comment">// #define MKEXT_VERS_2  (0x02008000)
</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PRAGMA_MARK</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> <span class="enscript-variable-name">Core</span> <span class="enscript-variable-name">Header</span>
#<span class="enscript-reference">endif</span>
<span class="enscript-comment">/*********************************************************************
* Core Header
*
* All versions of mkext files have this basic header:
*
* - magic &amp; signature - always 'MKXT' and 'MOSX' as defined above.
* - length - the length of the whole file
* - adler32 - checksum from &amp;version to end of file
* - version - a 'vers' style value
* - numkexts - how many kexts are in the archive (only needed in v.1)
* - cputype &amp; cpusubtype - in version 1 could be CPU_TYPE_ANY
*     and CPU_SUBTYPE_MULTIPLE if the archive contained fat kexts;
*     version 2 does not allow this and all kexts must be of a single
*     arch. For either version, mkexts of specific arches can be
*     embedded in a fat Mach-O file to combine them.
*********************************************************************/</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MKEXT_HEADER_CORE</span>      \
    uint32_t      magic;       \
    uint32_t      signature;   \
    uint32_t      length;      \
    uint32_t      adler32;     \
    uint32_t      version;     \
    uint32_t      numkexts;    \
    cpu_type_t    cputype;     \
    cpu_subtype_t cpusubtype;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> mkext_basic_header {
    MKEXT_HEADER_CORE
} mkext_basic_header;

#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT_HDR_CAST</span>(hdr)        ((mkext_basic_header *)(hdr))

#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT_SWAP</span>(num)            OSSwapBigToHostInt32((uint32_t)(num))

#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT_GET_MAGIC</span>(hdr)       (MKEXT_SWAP(MKEXT_HDR_CAST(hdr)-&gt;magic))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT_GET_SIGNATURE</span>(hdr)   (MKEXT_SWAP(MKEXT_HDR_CAST(hdr)-&gt;signature))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT_GET_LENGTH</span>(hdr)      (MKEXT_SWAP(MKEXT_HDR_CAST(hdr)-&gt;length))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT_GET_CHECKSUM</span>(hdr)    (MKEXT_SWAP(MKEXT_HDR_CAST(hdr)-&gt;adler32))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT_GET_VERSION</span>(hdr)     (MKEXT_SWAP(MKEXT_HDR_CAST(hdr)-&gt;version))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT_GET_COUNT</span>(hdr)       (MKEXT_SWAP(MKEXT_HDR_CAST(hdr)-&gt;numkexts))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT_GET_CPUTYPE</span>(hdr)     (MKEXT_SWAP(MKEXT_HDR_CAST(hdr)-&gt;cputype))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT_GET_CPUSUBTYPE</span>(hdr)  (MKEXT_SWAP(MKEXT_HDR_CAST(hdr)-&gt;cpusubtype))

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PRAGMA_MARK</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> <span class="enscript-variable-name">Mkext</span> <span class="enscript-variable-name">Version</span> 2 <span class="enscript-variable-name">Format</span> <span class="enscript-variable-name">Definitions</span>
#<span class="enscript-reference">endif</span>
<span class="enscript-comment">/*********************************************************************
* Mkext Version 2 Format Definitions
*
* The version field here will be some variant of 0x0200....; that is
* the  major version byte will be 0x02.
*
* Version 2 uses zlib for compression, not the lzss compressor used
* by version 1.
*
* In version 2, all executable &amp; resource files are stored in sequence
* followed by the combined info dictionaries of all kexts at the end.
* This XML plist should be nul-terminated and stored at a page-aligned
* offset in the file so that kernel code can unmap it as soon as it's
* parsed.
*
* The info dict for each kext will have inserted into it these
* additional properties:
*
* - _MKEXTBundlePath (string) - full path to the original bundle,
*   relative to volume.
* - _MKEXTExecutable (integer) - offset to the executable entry.
* - _MKEXTResources (dict) - keyed by filename, values integer offsets
*   to file entries.
*
* Mkext2 buffers are used to send load requests to the kernel. When
* this is done, the plist will contain an _MKEXTLoadRequest dictionary
* whose keys are the bundle IDs to load, and whose values are
* dictionaries of flags:
*
* - &quot;Load Kext&quot; - boolean, whether to load the kext or not (default true).
*   May be used to send just personalities for already-loaded kexts,
*   but we do have a mechanism to do that from userland already.
* - &quot;Start Kext&quot; - boolean, whether to start the kext or not
*   (used when debugging). Defaults to true.
* - &quot;Add Personalities&quot; - boolean, whether to send personalities to
*   the IOCatalogue (used when debugging). Defaults to true.
* - &quot;Disable Autounload&quot; - boolean, whether to prevent the reaper
*   thread from unloading the kext, so the dev. has time to set up
*   the debug session. (Predefined window, or maybe this will be a
*   number of seconds to wait.) Defaults to false.
*********************************************************************/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kMKEXTInfoDictionariesKey</span>             <span class="enscript-string">&quot;_MKEXTInfoDictionaries&quot;</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kMKEXTBundlePathKey</span>                   <span class="enscript-string">&quot;_MKEXTBundlePath&quot;</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kMKEXTExecutableRelativePathKey</span>       <span class="enscript-string">&quot;_MKEXTExecutableRelativePath&quot;</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kMKEXTExecutableKey</span>                   <span class="enscript-string">&quot;_MKEXTExecutable&quot;</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kMKEXTLoadRequestKey</span>                  <span class="enscript-string">&quot;_MKEXTLoadRequest&quot;</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kMKEXTLoadRequestLoadKey</span>              <span class="enscript-string">&quot;Load Kext&quot;</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kMKEXTLoadRequestStartKey</span>             <span class="enscript-string">&quot;Start Kext&quot;</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kMKEXTLoadRequestAddPersonalitiesKey</span>  <span class="enscript-string">&quot;Add Personalities&quot;</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kMKEXTLoadRequestDisableAutounloadKey</span> <span class="enscript-string">&quot;Disable Autounload&quot;</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> mkext2_file_entry {
    uint32_t  compressed_size;  <span class="enscript-comment">// if zero, file is not compressed
</span>    uint32_t  full_size;        <span class="enscript-comment">// full size of data w/o this struct
</span>    uint8_t   data[0];          <span class="enscript-comment">// data is inline to this struct
</span>} mkext2_file_entry;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> mkext2_header {
    MKEXT_HEADER_CORE
    uint32_t plist_offset;
    uint32_t plist_compressed_size;
    uint32_t plist_full_size;
} mkext2_header;

#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT2_GET_ENTRY_COMPSIZE</span>(ptr)   MKEXT_SWAP((ptr)-&gt;compressed_size)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT2_GET_ENTRY_FULLSIZE</span>(ptr)   MKEXT_SWAP((ptr)-&gt;full_size)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT2_GET_ENTRY_DATA</span>(ptr)       ((ptr)-&gt;data)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT2_HDR_CAST</span>(hdr)             ((mkext2_header *)(hdr))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT2_GET_PLIST</span>(hdr)            MKEXT_SWAP(MKEXT2_HDR_CAST(hdr)-&gt;plist_offset)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT2_GET_PLIST_COMPSIZE</span>(hdr)   MKEXT_SWAP(MKEXT2_HDR_CAST(hdr)-&gt;plist_compressed_size)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT2_GET_PLIST_FULLSIZE</span>(hdr)   MKEXT_SWAP(MKEXT2_HDR_CAST(hdr)-&gt;plist_full_size)

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PRAGMA_MARK</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> <span class="enscript-variable-name">Mkext</span> <span class="enscript-variable-name">Version</span> 1 <span class="enscript-variable-name">Format</span> <span class="enscript-variable-name">Definitions</span>
#<span class="enscript-reference">endif</span>
<span class="enscript-comment">/*********************************************************************
* Mkext Version 1 Format Definitions
*
* The original mkext format has version 0x01008000 (&quot;1.0&quot;).
*
* In version 1, plists were not nul-terminated, so it's up to the
* reader to add that '\0' on the end if it's needed.
*
* Original bad names preserved for source compatibility.
*********************************************************************/</span>

<span class="enscript-comment">// If all fields are 0 then this file slot is empty
</span><span class="enscript-comment">// If compsize is zero then the file isn't compressed.
</span><span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> mkext_file {
    uint32_t offset;         <span class="enscript-comment">// 4 bytes
</span>    uint32_t compsize;       <span class="enscript-comment">// 4 bytes
</span>    uint32_t realsize;       <span class="enscript-comment">// 4 bytes
</span>    uint32_t modifiedsecs;   <span class="enscript-comment">// 4 bytes; cast to time_t to use
</span>} mkext_file;

<span class="enscript-comment">// The plist file entry is mandatory, but module may be empty
</span><span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> mkext_kext {
    mkext_file plist;        <span class="enscript-comment">// 16 bytes
</span>    mkext_file module;       <span class="enscript-comment">// 16 bytes
</span>} mkext_kext;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> mkext_header {
    MKEXT_HEADER_CORE
    mkext_kext kext[1];    <span class="enscript-comment">// 32 bytes/entry
</span>} mkext_header;

<span class="enscript-type">typedef</span> mkext_header mkext1_header;

#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT1_ENTRY_CAST</span>(ptr)           ((mkext_file *)(ptr))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT1_GET_ENTRY_OFFSET</span>(ptr)     (MKEXT_SWAP(MKEXT1_ENTRY_CAST(ptr)-&gt;offset))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT1_GET_ENTRY_COMPSIZE</span>(ptr)   (MKEXT_SWAP(MKEXT1_ENTRY_CAST(ptr)-&gt;compsize))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT1_GET_ENTRY_FULLSIZE</span>(ptr)   (MKEXT_SWAP(MKEXT1_ENTRY_CAST(ptr)-&gt;realsize))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT1_GET_ENTRY_MODTIME</span>(ptr)    ((time_t)MKEXT_SWAP(MKEXT1_ENTRY_CAST(ptr)-&gt;modifiedsecs))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT1_ENTRY_EXISTS</span>(ptr)         (MKEXT1_GET_ENTRY_OFFSET(ptr)   ||  \
                                          MKEXT1_GET_ENTRY_FULLSIZE(ptr) ||  \
                                          MKEXT_GET_ENTRY_COMPSIZE(ptr)  ||  \
                                          MKEXT_GET_ENTRY_COMPSIZE(ptr))

#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT1_GET_KEXT</span>(hdr, i)          ((mkext_kext *)&amp;(MKEXT1_HDR_CAST(hdr)-&gt;kext[(i)]))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT1_GET_KEXT_PLIST</span>(hdr, i)    (MKEXT1_ENTRY_CAST(&amp;(MKEXT1_GET_KEXT((hdr), (i))-&gt;plist)))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT1_GET_KEXT_EXEC</span>(hdr, i)     (MKEXT1_ENTRY_CAST(&amp;(MKEXT1_GET_KEXT((hdr), (i))-&gt;module)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">MKEXT1_HDR_CAST</span>(hdr)             ((mkext1_header *)(hdr))

<span class="enscript-comment">/* These functions are only used for version 1 mkexts.
 */</span>
__BEGIN_DECLS
u_int8_t *
<span class="enscript-function-name">compress_lzss</span>(u_int8_t * dst, u_int32_t dstlen,
    u_int8_t * src, u_int32_t srclen);

<span class="enscript-type">int</span>
<span class="enscript-function-name">decompress_lzss</span>(u_int8_t * dst, u_int32_t dstlen,
    u_int8_t * src, u_int32_t srclen);

u_int32_t
<span class="enscript-function-name">mkext_adler32</span>(u_int8_t * src, int32_t length);
__END_DECLS

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* _MKEXT_H_ */</span>
</pre>
<hr />
</body></html>