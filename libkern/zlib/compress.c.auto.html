<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>compress.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">compress.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2008 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/* compress.c -- compress a memory buffer
 * Copyright (C) 1995-2003 Jean-loup Gailly.
 * For conditions of distribution and use, see copyright notice in zlib.h
 */</span>

<span class="enscript-comment">/* @(#) $Id$ */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ZLIB_INTERNAL</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">KERNEL</span>
    #include &lt;libkern/zlib.h&gt;
#<span class="enscript-reference">else</span>
    #include <span class="enscript-string">&quot;zlib.h&quot;</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL */</span>

<span class="enscript-comment">/* ===========================================================================
     Compresses the source buffer into the destination buffer. The level
   parameter has the same meaning as in deflateInit.  sourceLen is the byte
   length of the source buffer. Upon entry, destLen is the total size of the
   destination buffer, which must be at least 0.1% larger than sourceLen plus
   12 bytes. Upon exit, destLen is the actual size of the compressed buffer.

     compress2 returns Z_OK if success, Z_MEM_ERROR if there was not enough
   memory, Z_BUF_ERROR if there was not enough room in the output buffer,
   Z_STREAM_ERROR if the level parameter is invalid.
*/</span>
<span class="enscript-type">int</span> ZEXPORT <span class="enscript-function-name">compress2</span> (dest, destLen, source, sourceLen, level)
    Bytef *dest;
    uLongf *destLen;
    <span class="enscript-type">const</span> Bytef *source;
    uLong sourceLen;
    <span class="enscript-type">int</span> level;
{
    z_stream stream;
    <span class="enscript-type">int</span> err;

    stream.next_in = (Bytef*)source;
    stream.avail_in = (uInt)sourceLen;
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">MAXSEG_64K</span>
    <span class="enscript-comment">/* Check for source &gt; 64K on 16-bit machine: */</span>
    <span class="enscript-keyword">if</span> ((uLong)stream.avail_in != sourceLen) <span class="enscript-keyword">return</span> Z_BUF_ERROR;
#<span class="enscript-reference">endif</span>
    stream.next_out = dest;
    stream.avail_out = (uInt)*destLen;
    <span class="enscript-keyword">if</span> ((uLong)stream.avail_out != *destLen) <span class="enscript-keyword">return</span> Z_BUF_ERROR;

    stream.zalloc = (alloc_func)0;
    stream.zfree = (free_func)0;
    stream.opaque = (voidpf)0;

    err = deflateInit(&amp;stream, level);
    <span class="enscript-keyword">if</span> (err != Z_OK) <span class="enscript-keyword">return</span> err;

    err = deflate(&amp;stream, Z_FINISH);
    <span class="enscript-keyword">if</span> (err != Z_STREAM_END) {
        deflateEnd(&amp;stream);
        <span class="enscript-keyword">return</span> err == Z_OK ? Z_BUF_ERROR : err;
    }
    *destLen = stream.total_out;

    err = deflateEnd(&amp;stream);
    <span class="enscript-keyword">return</span> err;
}

<span class="enscript-comment">/* ===========================================================================
 */</span>
<span class="enscript-type">int</span> ZEXPORT <span class="enscript-function-name">compress</span> (dest, destLen, source, sourceLen)
    Bytef *dest;
    uLongf *destLen;
    <span class="enscript-type">const</span> Bytef *source;
    uLong sourceLen;
{
    <span class="enscript-keyword">return</span> compress2(dest, destLen, source, sourceLen, Z_DEFAULT_COMPRESSION);
}

<span class="enscript-comment">/* ===========================================================================
     If the default memLevel or windowBits for deflateInit() is changed, then
   this function needs to be updated.
 */</span>
uLong ZEXPORT <span class="enscript-function-name">compressBound</span> (sourceLen)
    uLong sourceLen;
{
    <span class="enscript-keyword">return</span> sourceLen + (sourceLen &gt;&gt; 12) + (sourceLen &gt;&gt; 14) + 11;
}
</pre>
<hr />
</body></html>