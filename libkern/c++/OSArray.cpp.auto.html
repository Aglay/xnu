<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>OSArray.cpp</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">OSArray.cpp&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/* IOArray.m created by rsulack on Fri 12-Sep-1997 */</span>
<span class="enscript-comment">/* IOArray.cpp converted to C++ by gvdl on Fri 1998-10-30 */</span>


#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSArray.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSDictionary.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSSerialize.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSLib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/OSDebug.h&gt;</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">super</span> OSCollection

<span class="enscript-function-name">OSDefineMetaClassAndStructors</span>(OSArray, OSCollection)
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSArray, 0);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSArray, 1);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSArray, 2);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSArray, 3);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSArray, 4);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSArray, 5);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSArray, 6);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSArray, 7);


#<span class="enscript-reference">define</span> <span class="enscript-function-name">EXT_CAST</span>(obj) \
    reinterpret_cast&lt;OSObject *&gt;(const_cast&lt;OSMetaClassBase *&gt;(obj))

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSArray::initWithCapacity</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> inCapacity)
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> size;

    <span class="enscript-keyword">if</span> (!super::init())
        <span class="enscript-keyword">return</span> false;

    <span class="enscript-comment">// integer overflow check
</span>    <span class="enscript-keyword">if</span> (inCapacity &gt; (UINT_MAX / <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">const</span> OSMetaClassBase*)))
        <span class="enscript-keyword">return</span> false;

    size = <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">const</span> OSMetaClassBase *) * inCapacity;
    array = (<span class="enscript-type">const</span> OSMetaClassBase **) kalloc_container(size);
    <span class="enscript-keyword">if</span> (!array)
        <span class="enscript-keyword">return</span> false;

    count = 0;
    capacity = inCapacity;
    capacityIncrement = (inCapacity)? inCapacity : 16;

    bzero(array, size);
    OSCONTAINER_ACCUMSIZE(size);

    <span class="enscript-keyword">return</span> true;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSArray::initWithObjects</span>(<span class="enscript-type">const</span> OSObject *objects[],
                              <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> theCount,
                              <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> theCapacity)
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> initCapacity;

    <span class="enscript-keyword">if</span> (!theCapacity)
        initCapacity = theCount;
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (theCount &gt; theCapacity)
        <span class="enscript-keyword">return</span> false;
    <span class="enscript-keyword">else</span>
        initCapacity = theCapacity;

    <span class="enscript-keyword">if</span> (!objects || !initWithCapacity(initCapacity))
        <span class="enscript-keyword">return</span> false;

    <span class="enscript-keyword">for</span> ( <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i = 0; i &lt; theCount; i++ ) {
        <span class="enscript-type">const</span> OSMetaClassBase *newObject = *objects++;

        <span class="enscript-keyword">if</span> (!newObject)
            <span class="enscript-keyword">return</span> false;

        array[count++] = newObject;
        newObject-&gt;taggedRetain(OSTypeID(OSCollection));
    }

    <span class="enscript-keyword">return</span> true;	
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSArray::initWithArray</span>(<span class="enscript-type">const</span> OSArray *anArray,
                            <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> theCapacity)
{
    <span class="enscript-keyword">if</span> ( !anArray )
        <span class="enscript-keyword">return</span> false;

    <span class="enscript-keyword">return</span> initWithObjects((<span class="enscript-type">const</span> OSObject **) anArray-&gt;array,
                           anArray-&gt;count, theCapacity);
}

OSArray *<span class="enscript-function-name">OSArray::withCapacity</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> capacity)
{
    OSArray *me = <span class="enscript-keyword">new</span> OSArray;

    <span class="enscript-keyword">if</span> (me &amp;&amp; !me-&gt;initWithCapacity(capacity)) {
        me-&gt;release();
        <span class="enscript-keyword">return</span> 0;
    }

    <span class="enscript-keyword">return</span> me;
}

OSArray *<span class="enscript-function-name">OSArray::withObjects</span>(<span class="enscript-type">const</span> OSObject *objects[],
                              <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> count,
                              <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> capacity)
{
    OSArray *me = <span class="enscript-keyword">new</span> OSArray;

    <span class="enscript-keyword">if</span> (me &amp;&amp; !me-&gt;initWithObjects(objects, count, capacity)) {
        me-&gt;release();
        <span class="enscript-keyword">return</span> 0;
    }

    <span class="enscript-keyword">return</span> me;
}

OSArray *<span class="enscript-function-name">OSArray::withArray</span>(<span class="enscript-type">const</span> OSArray *array,
                            <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> capacity)
{
    OSArray *me = <span class="enscript-keyword">new</span> OSArray;

    <span class="enscript-keyword">if</span> (me &amp;&amp; !me-&gt;initWithArray(array, capacity)) {
        me-&gt;release();
        <span class="enscript-keyword">return</span> 0;
    }

    <span class="enscript-keyword">return</span> me;
}

<span class="enscript-type">void</span> <span class="enscript-function-name">OSArray::free</span>()
{
    <span class="enscript-comment">// Clear immutability - assumes the container is doing the right thing
</span>    (<span class="enscript-type">void</span>) super::setOptions(0, kImmutable);

    flushCollection();

    <span class="enscript-keyword">if</span> (array) {
        kfree(array, <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">const</span> OSMetaClassBase *) * capacity);
        OSCONTAINER_ACCUMSIZE( -(<span class="enscript-keyword">sizeof</span>(<span class="enscript-type">const</span> OSMetaClassBase *) * capacity) );
    }

    <span class="enscript-reference">super</span>::free();
}


<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSArray::getCount</span>() <span class="enscript-type">const</span> { <span class="enscript-keyword">return</span> count; }
<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSArray::getCapacity</span>() <span class="enscript-type">const</span> { <span class="enscript-keyword">return</span> capacity; }
<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSArray::getCapacityIncrement</span>() <span class="enscript-type">const</span> { <span class="enscript-keyword">return</span> capacityIncrement; }
<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSArray::setCapacityIncrement</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> increment)
{
    capacityIncrement = (increment)? increment : 16;

    <span class="enscript-keyword">return</span> capacityIncrement;
}

<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSArray::ensureCapacity</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> newCapacity)
{
    <span class="enscript-type">const</span> OSMetaClassBase **newArray;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> finalCapacity;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> oldSize, newSize;

    <span class="enscript-keyword">if</span> (newCapacity &lt;= capacity)
        <span class="enscript-keyword">return</span> capacity;

    <span class="enscript-comment">// round up
</span>    finalCapacity = (((newCapacity - 1) / capacityIncrement) + 1)
                * capacityIncrement;

    <span class="enscript-comment">// integer overflow check
</span>    <span class="enscript-keyword">if</span> ((finalCapacity &lt; newCapacity) || (finalCapacity &gt; (UINT_MAX / <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">const</span> OSMetaClassBase*))))
        <span class="enscript-keyword">return</span> capacity;

    newSize = <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">const</span> OSMetaClassBase *) * finalCapacity;

    newArray = (<span class="enscript-type">const</span> OSMetaClassBase **) kalloc_container(newSize);
    <span class="enscript-keyword">if</span> (newArray) {
        oldSize = <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">const</span> OSMetaClassBase *) * capacity;

        OSCONTAINER_ACCUMSIZE(((size_t)newSize) - ((size_t)oldSize));

        bcopy(array, newArray, oldSize);
        bzero(&amp;newArray[capacity], newSize - oldSize);
        kfree(array, oldSize);
        array = newArray;
        capacity = finalCapacity;
    }

    <span class="enscript-keyword">return</span> capacity;
}

<span class="enscript-type">void</span> <span class="enscript-function-name">OSArray::flushCollection</span>()
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i;

    haveUpdated();
    <span class="enscript-keyword">for</span> (i = 0; i &lt; count; i++) {
        array[i]-&gt;taggedRelease(OSTypeID(OSCollection));
    }
    count = 0;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSArray::setObject</span>(<span class="enscript-type">const</span> OSMetaClassBase *anObject)
{
    <span class="enscript-keyword">return</span> setObject(count, anObject);
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSArray::setObject</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> index, <span class="enscript-type">const</span> OSMetaClassBase *anObject)
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> newCount = count + 1;

    <span class="enscript-keyword">if</span> ((index &gt; count) || !anObject)
        <span class="enscript-keyword">return</span> false;

    <span class="enscript-comment">// do we need more space?
</span>    <span class="enscript-keyword">if</span> (newCount &gt; capacity &amp;&amp; newCount &gt; ensureCapacity(newCount))
        <span class="enscript-keyword">return</span> false;

    haveUpdated();
    <span class="enscript-keyword">if</span> (index != count) {
        <span class="enscript-keyword">for</span> (i = count; i &gt; index; i--)
            array[i] = array[i-1];
    }
    array[index] = anObject;
    anObject-&gt;taggedRetain(OSTypeID(OSCollection));
    count++;

    <span class="enscript-keyword">return</span> true;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSArray::merge</span>(<span class="enscript-type">const</span> OSArray * otherArray)
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> otherCount = otherArray-&gt;getCount();
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> newCount = count + otherCount;

    <span class="enscript-keyword">if</span> (!otherCount)
        <span class="enscript-keyword">return</span> true;

    <span class="enscript-comment">// do we need more space?
</span>    <span class="enscript-keyword">if</span> (newCount &gt; capacity &amp;&amp; newCount &gt; ensureCapacity(newCount))
        <span class="enscript-keyword">return</span> false;

    haveUpdated();
    <span class="enscript-keyword">for</span> (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i = 0; i &lt; otherCount; i++) {
        <span class="enscript-type">const</span> OSMetaClassBase *newObject = otherArray-&gt;getObject(i);

        array[count++] = newObject;
        newObject-&gt;taggedRetain(OSTypeID(OSCollection));
    }

    <span class="enscript-keyword">return</span> true;
}

<span class="enscript-type">void</span> OSArray::
<span class="enscript-function-name">replaceObject</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> index, <span class="enscript-type">const</span> OSMetaClassBase *anObject)
{
    <span class="enscript-type">const</span> OSMetaClassBase *oldObject;

    <span class="enscript-keyword">if</span> ((index &gt;= count) || !anObject)
        <span class="enscript-keyword">return</span>;

    haveUpdated();
    oldObject = array[index];
    array[index] = anObject;
    anObject-&gt;taggedRetain(OSTypeID(OSCollection));

    oldObject-&gt;taggedRelease(OSTypeID(OSCollection));
}

<span class="enscript-type">void</span> <span class="enscript-function-name">OSArray::removeObject</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> index)
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i;
    <span class="enscript-type">const</span> OSMetaClassBase *oldObject;

    <span class="enscript-keyword">if</span> (index &gt;= count)
        <span class="enscript-keyword">return</span>;

    haveUpdated();
    oldObject = array[index];

    count--;
    <span class="enscript-keyword">for</span> (i = index; i &lt; count; i++)
        array[i] = array[i+1];

    oldObject-&gt;taggedRelease(OSTypeID(OSCollection));
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSArray::isEqualTo</span>(<span class="enscript-type">const</span> OSArray *anArray) <span class="enscript-type">const</span>
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i;
    
    <span class="enscript-keyword">if</span> ( <span class="enscript-keyword">this</span> == anArray )
        <span class="enscript-keyword">return</span> true;
    
    <span class="enscript-keyword">if</span> ( count != anArray-&gt;getCount() )
        <span class="enscript-keyword">return</span> false;

    <span class="enscript-keyword">for</span> ( i = 0; i &lt; count; i++ ) {
        <span class="enscript-keyword">if</span> ( !array[i]-&gt;isEqualTo(anArray-&gt;getObject(i)) )
            <span class="enscript-keyword">return</span> false;
    }

    <span class="enscript-keyword">return</span> true;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSArray::isEqualTo</span>(<span class="enscript-type">const</span> OSMetaClassBase *anObject) <span class="enscript-type">const</span>
{
    OSArray *otherArray;

    otherArray = OSDynamicCast(OSArray, anObject);
    <span class="enscript-keyword">if</span> ( otherArray )
        <span class="enscript-keyword">return</span> isEqualTo(otherArray);
    <span class="enscript-keyword">else</span>
        <span class="enscript-keyword">return</span> false;
}

OSObject *<span class="enscript-function-name">OSArray::getObject</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> index) <span class="enscript-type">const</span>
{
    <span class="enscript-keyword">if</span> (index &gt;= count)
        <span class="enscript-keyword">return</span> 0;
    <span class="enscript-keyword">else</span>
        <span class="enscript-keyword">return</span> (OSObject *) (const_cast&lt;OSMetaClassBase *&gt;(array[index]));
}

OSObject *<span class="enscript-function-name">OSArray::getLastObject</span>() <span class="enscript-type">const</span>
{
    <span class="enscript-keyword">if</span> (count == 0)
        <span class="enscript-keyword">return</span> 0;
    <span class="enscript-keyword">else</span>
        <span class="enscript-keyword">return</span> ( OSObject *) (const_cast&lt;OSMetaClassBase *&gt;(array[count - 1]));
}

<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSArray::getNextIndexOfObject</span>(<span class="enscript-type">const</span> OSMetaClassBase * anObject,
                                            <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> index) <span class="enscript-type">const</span>
{
    <span class="enscript-keyword">while</span> ((index &lt; count) &amp;&amp; (array[index] != anObject))
        index++;
    <span class="enscript-keyword">if</span> (index &gt;= count)
        index = (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>)-1;
    <span class="enscript-keyword">return</span> index;
}

<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSArray::iteratorSize</span>() <span class="enscript-type">const</span>
{
    <span class="enscript-keyword">return</span> <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>);
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSArray::initIterator</span>(<span class="enscript-type">void</span> *inIterator) <span class="enscript-type">const</span>
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> *iteratorP = (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> *) inIterator;

    *iteratorP = 0;
    <span class="enscript-keyword">return</span> true;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSArray::getNextObjectForIterator</span>(<span class="enscript-type">void</span> *inIterator, OSObject **ret) <span class="enscript-type">const</span>
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> *iteratorP = (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> *) inIterator;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> index = (*iteratorP)++;

    <span class="enscript-keyword">if</span> (index &lt; count) {
        *ret = (OSObject *)(const_cast&lt;OSMetaClassBase *&gt; (array[index]));
        <span class="enscript-keyword">return</span> true;
    }
    <span class="enscript-keyword">else</span> {
        *ret = 0;
        <span class="enscript-keyword">return</span> false;
    }
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSArray::serialize</span>(OSSerialize *s) <span class="enscript-type">const</span>
{
    <span class="enscript-keyword">if</span> (s-&gt;previouslySerialized(<span class="enscript-keyword">this</span>)) <span class="enscript-keyword">return</span> true;
    
    <span class="enscript-keyword">if</span> (!s-&gt;addXMLStartTag(<span class="enscript-keyword">this</span>, <span class="enscript-string">&quot;array&quot;</span>)) <span class="enscript-keyword">return</span> false;

    <span class="enscript-keyword">for</span> (<span class="enscript-type">unsigned</span> i = 0; i &lt; count; i++) {
        <span class="enscript-keyword">if</span> (array[i] == NULL || !array[i]-&gt;serialize(s)) <span class="enscript-keyword">return</span> false;
    }

    <span class="enscript-keyword">return</span> s-&gt;addXMLEndTag(<span class="enscript-string">&quot;array&quot;</span>);
}

<span class="enscript-type">unsigned</span> <span class="enscript-function-name">OSArray::setOptions</span>(<span class="enscript-type">unsigned</span> options, <span class="enscript-type">unsigned</span> mask, <span class="enscript-type">void</span> *)
{
    <span class="enscript-type">unsigned</span> old = super::setOptions(options, mask);
    <span class="enscript-keyword">if</span> ((old ^ options) &amp; mask) {

	<span class="enscript-comment">// Value changed need to recurse over all of the child collections
</span>	<span class="enscript-keyword">for</span> ( <span class="enscript-type">unsigned</span> i = 0; i &lt; count; i++ ) {
	    OSCollection *coll = OSDynamicCast(OSCollection, array[i]);
	    <span class="enscript-keyword">if</span> (coll)
		coll-&gt;setOptions(options, mask);
	}
    }

    <span class="enscript-keyword">return</span> old;
}

OSCollection * <span class="enscript-function-name">OSArray::copyCollection</span>(OSDictionary *cycleDict)
{
    <span class="enscript-type">bool</span> allocDict = !cycleDict;
    OSCollection *ret = 0;
    OSArray *newArray = 0;

    <span class="enscript-keyword">if</span> (allocDict) {
	cycleDict = OSDictionary::withCapacity(16);
	<span class="enscript-keyword">if</span> (!cycleDict)
	    <span class="enscript-keyword">return</span> 0;
    }

    <span class="enscript-keyword">do</span> {
	<span class="enscript-comment">// Check for a cycle
</span>	ret = super::copyCollection(cycleDict);
	<span class="enscript-keyword">if</span> (ret)
	    <span class="enscript-keyword">continue</span>;
	
	newArray = OSArray::withArray(<span class="enscript-keyword">this</span>);
	<span class="enscript-keyword">if</span> (!newArray)
	    <span class="enscript-keyword">continue</span>;

	<span class="enscript-comment">// Insert object into cycle Dictionary
</span>	cycleDict-&gt;setObject((<span class="enscript-type">const</span> OSSymbol *) <span class="enscript-keyword">this</span>, newArray);

	<span class="enscript-keyword">for</span> (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i = 0; i &lt; count; i++) {
	    OSCollection *coll =
		OSDynamicCast(OSCollection, EXT_CAST(newArray-&gt;array[i]));

	    <span class="enscript-keyword">if</span> (coll) {
		OSCollection *newColl = coll-&gt;copyCollection(cycleDict);
		<span class="enscript-keyword">if</span> (!newColl)
		    <span class="enscript-keyword">goto</span> <span class="enscript-reference">abortCopy</span>;

		newArray-&gt;replaceObject(i, newColl);
		newColl-&gt;release();
	    };
	};

	ret = newArray;
	newArray = 0;

    } <span class="enscript-keyword">while</span> (false);

<span class="enscript-reference">abortCopy</span>:
    <span class="enscript-keyword">if</span> (newArray)
	newArray-&gt;release();

    <span class="enscript-keyword">if</span> (allocDict)
	cycleDict-&gt;release();

    <span class="enscript-keyword">return</span> ret;
}

</pre>
<hr />
</body></html>