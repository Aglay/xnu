<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>OSSet.cpp</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">OSSet.cpp&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000, 2014 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/* IOSet.m created by rsulack on Thu 11-Jun-1998 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSDictionary.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSArray.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSSerialize.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSSet.h&gt;</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">super</span> OSCollection

<span class="enscript-function-name">OSDefineMetaClassAndStructors</span>(OSSet, OSCollection)
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSSet, 0);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSSet, 1);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSSet, 2);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSSet, 3);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSSet, 4);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSSet, 5);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSSet, 6);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSSet, 7);

#<span class="enscript-reference">define</span> <span class="enscript-function-name">EXT_CAST</span>(obj) \
    reinterpret_cast&lt;OSObject *&gt;(const_cast&lt;OSMetaClassBase *&gt;(obj))

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSSet::initWithCapacity</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> inCapacity)
{
    <span class="enscript-keyword">if</span> ( !super::init() )
        <span class="enscript-keyword">return</span> false;

    members = OSArray::withCapacity(inCapacity);
    <span class="enscript-keyword">if</span> (!members)
        <span class="enscript-keyword">return</span> false;

    <span class="enscript-keyword">return</span> true;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSSet::initWithObjects</span>(<span class="enscript-type">const</span> OSObject *inObjects[],
                              <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> inCount,
                              <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> inCapacity)
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> capacity = inCount;

    <span class="enscript-keyword">if</span> ( inCapacity ) {
        <span class="enscript-keyword">if</span> ( inCount &gt; inCapacity )
            <span class="enscript-keyword">return</span> false;

        capacity = inCapacity;
    }

    <span class="enscript-keyword">if</span> (!inObjects || !initWithCapacity(capacity))
        <span class="enscript-keyword">return</span> false;

    <span class="enscript-keyword">for</span> ( <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i = 0; i &lt; inCount; i++ ) {
<span class="enscript-comment">// xx-review: no test here for failure of setObject()
</span>        <span class="enscript-keyword">if</span> (members-&gt;getCount() &lt; capacity)
            setObject(inObjects[i]);
        <span class="enscript-keyword">else</span>
            <span class="enscript-keyword">return</span> false;
    }

    <span class="enscript-keyword">return</span> true;	
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSSet::initWithArray</span>(<span class="enscript-type">const</span> OSArray *inArray,
                          <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> inCapacity)
{
    <span class="enscript-keyword">if</span> ( !inArray )
        <span class="enscript-keyword">return</span> false;
    
    <span class="enscript-keyword">return</span> initWithObjects((<span class="enscript-type">const</span> OSObject **) inArray-&gt;array,
                           inArray-&gt;count, inCapacity);
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSSet::initWithSet</span>(<span class="enscript-type">const</span> OSSet *inSet,
                        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> inCapacity)
{
    <span class="enscript-keyword">return</span> initWithArray(inSet-&gt;members, inCapacity);
}

OSSet *<span class="enscript-function-name">OSSet::withCapacity</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> capacity)
{
    OSSet *me = <span class="enscript-keyword">new</span> OSSet;

    <span class="enscript-keyword">if</span> (me &amp;&amp; !me-&gt;initWithCapacity(capacity)) {
        me-&gt;release();
        <span class="enscript-keyword">return</span> 0;
    }

    <span class="enscript-keyword">return</span> me;
}

OSSet *<span class="enscript-function-name">OSSet::withObjects</span>(<span class="enscript-type">const</span> OSObject *objects[],
                          <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> count,
                          <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> capacity)
{
    OSSet *me = <span class="enscript-keyword">new</span> OSSet;

    <span class="enscript-keyword">if</span> (me &amp;&amp; !me-&gt;initWithObjects(objects, count, capacity)) {
        me-&gt;release();
        <span class="enscript-keyword">return</span> 0;
    }

    <span class="enscript-keyword">return</span> me;
}

OSSet *<span class="enscript-function-name">OSSet::withArray</span>(<span class="enscript-type">const</span> OSArray *array,
                        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> capacity)
{
    OSSet *me = <span class="enscript-keyword">new</span> OSSet;

    <span class="enscript-keyword">if</span> (me &amp;&amp; !me-&gt;initWithArray(array, capacity)) {
        me-&gt;release();
        <span class="enscript-keyword">return</span> 0;
    }

    <span class="enscript-keyword">return</span> me;
}

OSSet *<span class="enscript-function-name">OSSet::withSet</span>(<span class="enscript-type">const</span> OSSet *set,
                      <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> capacity)
{
    OSSet *me = <span class="enscript-keyword">new</span> OSSet;

    <span class="enscript-keyword">if</span> (me &amp;&amp; !me-&gt;initWithSet(set, capacity)) {
        me-&gt;release();
        <span class="enscript-keyword">return</span> 0;
    }

    <span class="enscript-keyword">return</span> me;
}

<span class="enscript-type">void</span> <span class="enscript-function-name">OSSet::free</span>()
{
    (<span class="enscript-type">void</span>) members-&gt;super::setOptions(0, kImmutable);
    <span class="enscript-keyword">if</span> (members)
        members-&gt;release();

    <span class="enscript-reference">super</span>::free();
}

<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSSet::getCount</span>() <span class="enscript-type">const</span>
{
    <span class="enscript-keyword">return</span> members-&gt;count;
}

<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSSet::getCapacity</span>() <span class="enscript-type">const</span>
{
    <span class="enscript-keyword">return</span> members-&gt;capacity;
}

<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSSet::getCapacityIncrement</span>() <span class="enscript-type">const</span>
{
    <span class="enscript-keyword">return</span> members-&gt;capacityIncrement;
}

<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSSet::setCapacityIncrement</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> increment)
{
    <span class="enscript-keyword">return</span> members-&gt;setCapacityIncrement(increment);
}

<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSSet::ensureCapacity</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> newCapacity)
{
    <span class="enscript-keyword">return</span> members-&gt;ensureCapacity(newCapacity);
}

<span class="enscript-type">void</span> <span class="enscript-function-name">OSSet::flushCollection</span>()
{
    haveUpdated();
    members-&gt;flushCollection();
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSSet::setObject</span>(<span class="enscript-type">const</span> OSMetaClassBase *anObject)
{
    <span class="enscript-keyword">if</span> (containsObject(anObject)) {
        <span class="enscript-keyword">return</span> false;
    } <span class="enscript-keyword">else</span> {
        haveUpdated();
        <span class="enscript-keyword">return</span> members-&gt;setObject(anObject);
    }
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSSet::merge</span>(<span class="enscript-type">const</span> OSArray * array)
{
    <span class="enscript-type">const</span> OSMetaClassBase * anObject = 0;
    <span class="enscript-type">bool</span>                    result   = true;

    <span class="enscript-keyword">for</span> (<span class="enscript-type">int</span> i = 0; (anObject = array-&gt;getObject(i)); i++) {

       <span class="enscript-comment">/* setObject() returns false if the object is already in the set,
        * so we have to check beforehand here with containsObject().
        */</span>
        <span class="enscript-keyword">if</span> (containsObject(anObject)) {
            <span class="enscript-keyword">continue</span>;
        }
        <span class="enscript-keyword">if</span> (!setObject(anObject)) {
            result = false;
        }
    }

    <span class="enscript-keyword">return</span> result;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSSet::merge</span>(<span class="enscript-type">const</span> OSSet * set)
{
    <span class="enscript-keyword">return</span> merge(set-&gt;members);
}

<span class="enscript-type">void</span> <span class="enscript-function-name">OSSet::removeObject</span>(<span class="enscript-type">const</span> OSMetaClassBase *anObject)
{
    <span class="enscript-type">const</span> OSMetaClassBase *probeObject;

    <span class="enscript-keyword">for</span> (<span class="enscript-type">int</span> i = 0; (probeObject = members-&gt;getObject(i)); i++)
        <span class="enscript-keyword">if</span> (probeObject == anObject) {
            haveUpdated();
            members-&gt;removeObject(i);
            <span class="enscript-keyword">return</span>;
        }
}


<span class="enscript-type">bool</span> <span class="enscript-function-name">OSSet::containsObject</span>(<span class="enscript-type">const</span> OSMetaClassBase *anObject) <span class="enscript-type">const</span>
{
    <span class="enscript-keyword">return</span> anObject &amp;&amp; member(anObject);
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSSet::member</span>(<span class="enscript-type">const</span> OSMetaClassBase *anObject) <span class="enscript-type">const</span>
{
    OSMetaClassBase *probeObject;

    <span class="enscript-keyword">for</span> (<span class="enscript-type">int</span> i = 0; (probeObject = members-&gt;getObject(i)); i++)
        <span class="enscript-keyword">if</span> (probeObject == anObject)
            <span class="enscript-keyword">return</span> true;

    <span class="enscript-keyword">return</span> false;
}

OSObject *<span class="enscript-function-name">OSSet::getAnyObject</span>() <span class="enscript-type">const</span>
{
    <span class="enscript-keyword">return</span> members-&gt;getObject(0);
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSSet::isEqualTo</span>(<span class="enscript-type">const</span> OSSet *aSet) <span class="enscript-type">const</span>
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> count;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i;
    <span class="enscript-type">const</span> OSMetaClassBase *obj1;
    <span class="enscript-type">const</span> OSMetaClassBase *obj2;

    <span class="enscript-keyword">if</span> ( <span class="enscript-keyword">this</span> == aSet )
        <span class="enscript-keyword">return</span> true;

    count = members-&gt;count;
    <span class="enscript-keyword">if</span> ( count != aSet-&gt;getCount() )
        <span class="enscript-keyword">return</span> false;

    <span class="enscript-keyword">for</span> ( i = 0; i &lt; count; i++ ) {
        obj1 = aSet-&gt;members-&gt;getObject(i);
	<span class="enscript-keyword">if</span> (containsObject(obj1))
		<span class="enscript-keyword">continue</span>;
        obj2 = members-&gt;getObject(i);
        <span class="enscript-keyword">if</span> ( !obj1 || !obj2 )
                <span class="enscript-keyword">return</span> false;

        <span class="enscript-keyword">if</span> ( !obj1-&gt;isEqualTo(obj2) )
            <span class="enscript-keyword">return</span> false;
    }

    <span class="enscript-keyword">return</span> true;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSSet::isEqualTo</span>(<span class="enscript-type">const</span> OSMetaClassBase *anObject) <span class="enscript-type">const</span>
{
    OSSet *otherSet;

    otherSet = OSDynamicCast(OSSet, anObject);
    <span class="enscript-keyword">if</span> ( otherSet )
        <span class="enscript-keyword">return</span> isEqualTo(otherSet);
    <span class="enscript-keyword">else</span>
        <span class="enscript-keyword">return</span> false;
}

<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSSet::iteratorSize</span>() <span class="enscript-type">const</span>
{
    <span class="enscript-keyword">return</span> <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>);
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSSet::initIterator</span>(<span class="enscript-type">void</span> *inIterator) <span class="enscript-type">const</span>
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> *iteratorP = (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> *) inIterator;

    *iteratorP = 0;
    <span class="enscript-keyword">return</span> true;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSSet::getNextObjectForIterator</span>(<span class="enscript-type">void</span> *inIterator, OSObject **ret) <span class="enscript-type">const</span>
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> *iteratorP = (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> *) inIterator;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> index = (*iteratorP)++;

    <span class="enscript-keyword">if</span> (index &lt; members-&gt;count)
        *ret = members-&gt;getObject(index);
    <span class="enscript-keyword">else</span>
        *ret = 0;

    <span class="enscript-keyword">return</span> (*ret != 0);
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSSet::serialize</span>(OSSerialize *s) <span class="enscript-type">const</span>
{
    <span class="enscript-type">const</span> OSMetaClassBase *o;

    <span class="enscript-keyword">if</span> (s-&gt;previouslySerialized(<span class="enscript-keyword">this</span>)) <span class="enscript-keyword">return</span> true;   
 
    <span class="enscript-keyword">if</span> (!s-&gt;addXMLStartTag(<span class="enscript-keyword">this</span>, <span class="enscript-string">&quot;set&quot;</span>)) <span class="enscript-keyword">return</span> false;

    <span class="enscript-keyword">for</span> (<span class="enscript-type">int</span> i = 0; (o = members-&gt;getObject(i)); i++) {
        <span class="enscript-keyword">if</span> (!o-&gt;serialize(s)) <span class="enscript-keyword">return</span> false;
    }   

    <span class="enscript-keyword">return</span> s-&gt;addXMLEndTag(<span class="enscript-string">&quot;set&quot;</span>);
}

<span class="enscript-type">unsigned</span> <span class="enscript-function-name">OSSet::setOptions</span>(<span class="enscript-type">unsigned</span> options, <span class="enscript-type">unsigned</span> mask, <span class="enscript-type">void</span> *)
{
    <span class="enscript-type">unsigned</span> old = super::setOptions(options, mask);
    <span class="enscript-keyword">if</span> ((old ^ options) &amp; mask)
	members-&gt;setOptions(options, mask);

    <span class="enscript-keyword">return</span> old;
}

OSCollection * <span class="enscript-function-name">OSSet::copyCollection</span>(OSDictionary *cycleDict)
{
    <span class="enscript-type">bool</span> allocDict = !cycleDict;
    OSCollection *ret = 0;
    OSSet *newSet = 0;

    <span class="enscript-keyword">if</span> (allocDict) {
	cycleDict = OSDictionary::withCapacity(16);
	<span class="enscript-keyword">if</span> (!cycleDict)
	    <span class="enscript-keyword">return</span> 0;
    }

    <span class="enscript-keyword">do</span> {
	<span class="enscript-comment">// Check for a cycle
</span>	ret = super::copyCollection(cycleDict);
	<span class="enscript-keyword">if</span> (ret)
	    <span class="enscript-keyword">continue</span>;	<span class="enscript-comment">// Found it
</span>
	newSet = OSSet::withCapacity(members-&gt;capacity);
	<span class="enscript-keyword">if</span> (!newSet)
	    <span class="enscript-keyword">continue</span>;	<span class="enscript-comment">// Couldn't create new set abort
</span>
	<span class="enscript-comment">// Insert object into cycle Dictionary
</span>	cycleDict-&gt;setObject((<span class="enscript-type">const</span> OSSymbol *) <span class="enscript-keyword">this</span>, newSet);

	OSArray *newMembers = newSet-&gt;members;
	newMembers-&gt;capacityIncrement = members-&gt;capacityIncrement;

	<span class="enscript-comment">// Now copy over the contents into the new duplicate
</span>	<span class="enscript-keyword">for</span> (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i = 0; i &lt; members-&gt;count; i++) {
	    OSObject *obj = EXT_CAST(members-&gt;array[i]);
	    OSCollection *coll = OSDynamicCast(OSCollection, obj);
	    <span class="enscript-keyword">if</span> (coll) {
		OSCollection *newColl = coll-&gt;copyCollection(cycleDict);
		<span class="enscript-keyword">if</span> (newColl) {
		    obj = newColl;	<span class="enscript-comment">// Rely on cycleDict ref for a bit
</span>		    newColl-&gt;release();
		}
		<span class="enscript-keyword">else</span>
		    <span class="enscript-keyword">goto</span> <span class="enscript-reference">abortCopy</span>;
	    };
	    newMembers-&gt;setObject(obj);
	};

	ret = newSet;
	newSet = 0;

    } <span class="enscript-keyword">while</span>(false);

<span class="enscript-reference">abortCopy</span>:
    <span class="enscript-keyword">if</span> (newSet)
	newSet-&gt;release();

    <span class="enscript-keyword">if</span> (allocDict)
	cycleDict-&gt;release();

    <span class="enscript-keyword">return</span> ret;
}
</pre>
<hr />
</body></html>