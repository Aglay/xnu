<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>OSData.cpp</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">OSData.cpp&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/* IOData.m created by rsulack on Thu 25-Sep-1997 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSData.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSSerialize.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSLib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSString.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">super</span> OSObject

<span class="enscript-function-name">OSDefineMetaClassAndStructors</span>(OSData, OSObject)
<span class="enscript-function-name">OSMetaClassDefineReservedUsed</span>(OSData, 0);    <span class="enscript-comment">// setDeallocFunction
</span><span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSData, 1);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSData, 2);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSData, 3);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSData, 4);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSData, 5);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSData, 6);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSData, 7);

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">EXTERNAL</span> ((unsigned int) -1)

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSData::initWithCapacity</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> inCapacity)
{
    <span class="enscript-keyword">if</span> (data)
    {
        OSCONTAINER_ACCUMSIZE(-((size_t)capacity));
	<span class="enscript-keyword">if</span> (!inCapacity || (capacity &lt; inCapacity))
	{
	    <span class="enscript-comment">// clean out old data's storage if it isn't big enough
</span>	    kfree(data, capacity);
	    data = 0;
	    capacity = 0;
	}
    }

    <span class="enscript-keyword">if</span> (!super::init())
        <span class="enscript-keyword">return</span> false;

    <span class="enscript-keyword">if</span> (inCapacity &amp;&amp; !data) {
        data = (<span class="enscript-type">void</span> *) kalloc_container(inCapacity);
        <span class="enscript-keyword">if</span> (!data)
            <span class="enscript-keyword">return</span> false;
        capacity = inCapacity;
    }
    OSCONTAINER_ACCUMSIZE(capacity);

    length = 0;
    <span class="enscript-keyword">if</span> (inCapacity &lt; 16)
        capacityIncrement = 16;
    <span class="enscript-keyword">else</span>
        capacityIncrement = inCapacity;

    <span class="enscript-keyword">return</span> true;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSData::initWithBytes</span>(<span class="enscript-type">const</span> <span class="enscript-type">void</span> *bytes, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> inLength)
{
    <span class="enscript-keyword">if</span> ((inLength &amp;&amp; !bytes) || !initWithCapacity(inLength))
        <span class="enscript-keyword">return</span> false;

    <span class="enscript-keyword">if</span> (bytes != data)
	bcopy(bytes, data, inLength);
    length = inLength;

    <span class="enscript-keyword">return</span> true;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSData::initWithBytesNoCopy</span>(<span class="enscript-type">void</span> *bytes, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> inLength)
{
    <span class="enscript-keyword">if</span> (!super::init())
        <span class="enscript-keyword">return</span> false;

    length = inLength;
    capacity = EXTERNAL;
    data = bytes;

    <span class="enscript-keyword">return</span> true;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSData::initWithData</span>(<span class="enscript-type">const</span> OSData *inData)
{
    <span class="enscript-keyword">return</span> initWithBytes(inData-&gt;data, inData-&gt;length);
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSData::initWithData</span>(<span class="enscript-type">const</span> OSData *inData,
                          <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> start, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> inLength)
{
    <span class="enscript-type">const</span> <span class="enscript-type">void</span> *localData = inData-&gt;getBytesNoCopy(start, inLength);

    <span class="enscript-keyword">if</span> (localData)
        <span class="enscript-keyword">return</span> initWithBytes(localData, inLength);
    <span class="enscript-keyword">else</span>
        <span class="enscript-keyword">return</span> false;
}

OSData *<span class="enscript-function-name">OSData::withCapacity</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> inCapacity)
{
    OSData *me = <span class="enscript-keyword">new</span> OSData;

    <span class="enscript-keyword">if</span> (me &amp;&amp; !me-&gt;initWithCapacity(inCapacity)) {
        me-&gt;release();
        <span class="enscript-keyword">return</span> 0;
    }

    <span class="enscript-keyword">return</span> me;
}

OSData *<span class="enscript-function-name">OSData::withBytes</span>(<span class="enscript-type">const</span> <span class="enscript-type">void</span> *bytes, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> inLength)
{
    OSData *me = <span class="enscript-keyword">new</span> OSData;

    <span class="enscript-keyword">if</span> (me &amp;&amp; !me-&gt;initWithBytes(bytes, inLength)) {
        me-&gt;release();
        <span class="enscript-keyword">return</span> 0;
    }
    <span class="enscript-keyword">return</span> me;
}

OSData *<span class="enscript-function-name">OSData::withBytesNoCopy</span>(<span class="enscript-type">void</span> *bytes, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> inLength)
{
    OSData *me = <span class="enscript-keyword">new</span> OSData;

    <span class="enscript-keyword">if</span> (me &amp;&amp; !me-&gt;initWithBytesNoCopy(bytes, inLength)) {
        me-&gt;release();
        <span class="enscript-keyword">return</span> 0;
    }

    <span class="enscript-keyword">return</span> me;
}

OSData *<span class="enscript-function-name">OSData::withData</span>(<span class="enscript-type">const</span> OSData *inData)
{
    OSData *me = <span class="enscript-keyword">new</span> OSData;

    <span class="enscript-keyword">if</span> (me &amp;&amp; !me-&gt;initWithData(inData)) {
        me-&gt;release();
        <span class="enscript-keyword">return</span> 0;
    }

    <span class="enscript-keyword">return</span> me;
}

OSData *<span class="enscript-function-name">OSData::withData</span>(<span class="enscript-type">const</span> OSData *inData,
                         <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> start, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> inLength)
{
    OSData *me = <span class="enscript-keyword">new</span> OSData;

    <span class="enscript-keyword">if</span> (me &amp;&amp; !me-&gt;initWithData(inData, start, inLength)) {
        me-&gt;release();
        <span class="enscript-keyword">return</span> 0;
    }

    <span class="enscript-keyword">return</span> me;
}

<span class="enscript-type">void</span> <span class="enscript-function-name">OSData::free</span>()
{
    <span class="enscript-keyword">if</span> (capacity != EXTERNAL &amp;&amp; data &amp;&amp; capacity) {
        kfree(data, capacity);
        OSCONTAINER_ACCUMSIZE( -((size_t)capacity) );
    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (capacity == EXTERNAL) {
	DeallocFunction freemem = reserved ? reserved-&gt;deallocFunction : NULL;
	<span class="enscript-keyword">if</span> (freemem &amp;&amp; data &amp;&amp; length) {
		freemem(data, length);
	}
    }
    <span class="enscript-keyword">if</span> (reserved) kfree(reserved, <span class="enscript-keyword">sizeof</span>(ExpansionData));
    <span class="enscript-reference">super</span>::free();
}

<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSData::getLength</span>() <span class="enscript-type">const</span> { <span class="enscript-keyword">return</span> length; }
<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSData::getCapacity</span>() <span class="enscript-type">const</span> { <span class="enscript-keyword">return</span> capacity; }

<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSData::getCapacityIncrement</span>() <span class="enscript-type">const</span> 
{ 
    <span class="enscript-keyword">return</span> capacityIncrement; 
}

<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSData::setCapacityIncrement</span>(<span class="enscript-type">unsigned</span> increment) 
{
    <span class="enscript-keyword">return</span> capacityIncrement = increment; 
}

<span class="enscript-comment">// xx-review: does not check for capacity == EXTERNAL
</span>
<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSData::ensureCapacity</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> newCapacity)
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> * newData;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> finalCapacity;

    <span class="enscript-keyword">if</span> (newCapacity &lt;= capacity)
        <span class="enscript-keyword">return</span> capacity;

    finalCapacity = (((newCapacity - 1) / capacityIncrement) + 1)
                * capacityIncrement;

    <span class="enscript-comment">// integer overflow check
</span>    <span class="enscript-keyword">if</span> (finalCapacity &lt; newCapacity)
        <span class="enscript-keyword">return</span> capacity;

    newData = (<span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *) kalloc_container(finalCapacity);

    <span class="enscript-keyword">if</span> ( newData ) {
        bzero(newData + capacity, finalCapacity - capacity);
        <span class="enscript-keyword">if</span> (data) {
            bcopy(data, newData, capacity);
            kfree(data, capacity);
        }
        OSCONTAINER_ACCUMSIZE( ((size_t)finalCapacity) - ((size_t)capacity) );
        data = (<span class="enscript-type">void</span> *) newData;
        capacity = finalCapacity;
    }

    <span class="enscript-keyword">return</span> capacity;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSData::appendBytes</span>(<span class="enscript-type">const</span> <span class="enscript-type">void</span> *bytes, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> inLength)
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> newSize;

    <span class="enscript-keyword">if</span> (!inLength)
        <span class="enscript-keyword">return</span> true;

    <span class="enscript-keyword">if</span> (capacity == EXTERNAL)
        <span class="enscript-keyword">return</span> false;
    
    newSize = length + inLength;
    <span class="enscript-keyword">if</span> ( (newSize &gt; capacity) &amp;&amp; newSize &gt; ensureCapacity(newSize) )
        <span class="enscript-keyword">return</span> false;

    <span class="enscript-keyword">if</span> (bytes)
        bcopy(bytes, &amp;((<span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *)data)[length], inLength);
    <span class="enscript-keyword">else</span>
        bzero(&amp;((<span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *)data)[length], inLength);

    length = newSize;

    <span class="enscript-keyword">return</span> true;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSData::appendByte</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> byte, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> inLength)
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> newSize;

    <span class="enscript-keyword">if</span> (!inLength)
        <span class="enscript-keyword">return</span> true;

    <span class="enscript-keyword">if</span> (capacity == EXTERNAL)
        <span class="enscript-keyword">return</span> false;
    
    newSize = length + inLength;
    <span class="enscript-keyword">if</span> ( (newSize &gt; capacity) &amp;&amp; newSize &gt; ensureCapacity(newSize) )
        <span class="enscript-keyword">return</span> false;

    memset(&amp;((<span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *)data)[length], byte, inLength);
    length = newSize;

    <span class="enscript-keyword">return</span> true;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSData::appendBytes</span>(<span class="enscript-type">const</span> OSData *other)
{
    <span class="enscript-keyword">return</span> appendBytes(other-&gt;data, other-&gt;length);
}

<span class="enscript-type">const</span> <span class="enscript-type">void</span> *<span class="enscript-function-name">OSData::getBytesNoCopy</span>() <span class="enscript-type">const</span>
{
    <span class="enscript-keyword">if</span> (!length)
        <span class="enscript-keyword">return</span> 0;
    <span class="enscript-keyword">else</span>
        <span class="enscript-keyword">return</span> data;
}

<span class="enscript-type">const</span> <span class="enscript-type">void</span> *<span class="enscript-function-name">OSData::getBytesNoCopy</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> start,
                                   <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> inLength) <span class="enscript-type">const</span>
{
    <span class="enscript-type">const</span> <span class="enscript-type">void</span> *outData = 0;

    <span class="enscript-keyword">if</span> (length
    &amp;&amp;  start &lt; length
    &amp;&amp; (start + inLength) &lt;= length)
        outData = (<span class="enscript-type">const</span> <span class="enscript-type">void</span> *) ((<span class="enscript-type">char</span> *) data + start);

    <span class="enscript-keyword">return</span> outData;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSData::isEqualTo</span>(<span class="enscript-type">const</span> OSData *aData) <span class="enscript-type">const</span>
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> len;

    len = aData-&gt;length;
    <span class="enscript-keyword">if</span> ( length != len )
        <span class="enscript-keyword">return</span> false;

    <span class="enscript-keyword">return</span> isEqualTo(aData-&gt;data, len);
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSData::isEqualTo</span>(<span class="enscript-type">const</span> <span class="enscript-type">void</span> *someData, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> inLength) <span class="enscript-type">const</span>
{
    <span class="enscript-keyword">return</span> (length &gt;= inLength) &amp;&amp; (bcmp(data, someData, inLength) == 0);
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSData::isEqualTo</span>(<span class="enscript-type">const</span> OSMetaClassBase *obj) <span class="enscript-type">const</span>
{
    OSData *	otherData;
    OSString *  str;

    <span class="enscript-keyword">if</span> ((otherData = OSDynamicCast(OSData, obj)))
        <span class="enscript-keyword">return</span> isEqualTo(otherData);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> ((str = OSDynamicCast (OSString, obj)))
        <span class="enscript-keyword">return</span> isEqualTo(str);
    <span class="enscript-keyword">else</span>
        <span class="enscript-keyword">return</span> false;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSData::isEqualTo</span>(<span class="enscript-type">const</span> OSString *obj) <span class="enscript-type">const</span>
{
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> * aCString;
    <span class="enscript-type">char</span> * dataPtr;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> checkLen = length;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> stringLen;

    <span class="enscript-keyword">if</span> (!obj)
      <span class="enscript-keyword">return</span> false;

    stringLen = obj-&gt;getLength ();

    dataPtr = (<span class="enscript-type">char</span> *)data;

    <span class="enscript-keyword">if</span> (stringLen != checkLen) {

      <span class="enscript-comment">// check for the fact that OSData may be a buffer that
</span>      <span class="enscript-comment">// that includes a termination byte and will thus have
</span>      <span class="enscript-comment">// a length of the actual string length PLUS 1. In this
</span>      <span class="enscript-comment">// case we verify that the additional byte is a terminator
</span>      <span class="enscript-comment">// and if so count the two lengths as being the same.
</span>
      <span class="enscript-keyword">if</span> ( (checkLen - stringLen) == 1) {
	<span class="enscript-keyword">if</span> (dataPtr[checkLen-1] != 0) <span class="enscript-comment">// non-zero means not a terminator and thus not likely the same
</span>	  <span class="enscript-keyword">return</span> false;
        checkLen--;
      }
      <span class="enscript-keyword">else</span>
	<span class="enscript-keyword">return</span> false;
    }

    aCString = obj-&gt;getCStringNoCopy ();

    <span class="enscript-keyword">for</span> ( <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i=0; i &lt; checkLen; i++ ) {
      <span class="enscript-keyword">if</span> ( *dataPtr++ != aCString[i] ) 
        <span class="enscript-keyword">return</span> false;
    }

   <span class="enscript-keyword">return</span> true;
}

<span class="enscript-comment">//this was taken from CFPropertyList.c 
</span><span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> __CFPLDataEncodeTable[] = <span class="enscript-string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span>;

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSData::serialize</span>(OSSerialize *s) <span class="enscript-type">const</span>
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i;
    <span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *p;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> c;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> serializeLength;

    <span class="enscript-keyword">if</span> (s-&gt;previouslySerialized(<span class="enscript-keyword">this</span>)) <span class="enscript-keyword">return</span> true;

    <span class="enscript-keyword">if</span> (!s-&gt;addXMLStartTag(<span class="enscript-keyword">this</span>, <span class="enscript-string">&quot;data&quot;</span>)) <span class="enscript-keyword">return</span> false;

    serializeLength = length;
    <span class="enscript-keyword">if</span> (reserved &amp;&amp; reserved-&gt;disableSerialization) serializeLength = 0;

    <span class="enscript-keyword">for</span> (i = 0, p = (<span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *)data; i &lt; serializeLength; i++, p++) {
        <span class="enscript-comment">/* 3 bytes are encoded as 4 */</span>
        <span class="enscript-keyword">switch</span> (i % 3) {
	<span class="enscript-keyword">case</span> <span class="enscript-reference">0</span>:
		c = __CFPLDataEncodeTable [ ((p[0] &gt;&gt; 2) &amp; 0x3f)];
		<span class="enscript-keyword">if</span> (!s-&gt;addChar(c)) <span class="enscript-keyword">return</span> false;
		<span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-reference">1</span>:
		c = __CFPLDataEncodeTable [ ((((p[-1] &lt;&lt; 8) | p[0]) &gt;&gt; 4) &amp; 0x3f)];
		<span class="enscript-keyword">if</span> (!s-&gt;addChar(c)) <span class="enscript-keyword">return</span> false;
		<span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-reference">2</span>:
		c = __CFPLDataEncodeTable [ ((((p[-1] &lt;&lt; 8) | p[0]) &gt;&gt; 6) &amp; 0x3f)];
		<span class="enscript-keyword">if</span> (!s-&gt;addChar(c)) <span class="enscript-keyword">return</span> false;
		c = __CFPLDataEncodeTable [ (p[0] &amp; 0x3f)];
		<span class="enscript-keyword">if</span> (!s-&gt;addChar(c)) <span class="enscript-keyword">return</span> false;
		<span class="enscript-keyword">break</span>;
	}
    }
    <span class="enscript-keyword">switch</span> (i % 3) {
    <span class="enscript-keyword">case</span> <span class="enscript-reference">0</span>:
	    <span class="enscript-keyword">break</span>;
    <span class="enscript-keyword">case</span> <span class="enscript-reference">1</span>:
	    c = __CFPLDataEncodeTable [ ((p[-1] &lt;&lt; 4) &amp; 0x30)];
	    <span class="enscript-keyword">if</span> (!s-&gt;addChar(c)) <span class="enscript-keyword">return</span> false;
	    <span class="enscript-keyword">if</span> (!s-&gt;addChar(<span class="enscript-string">'='</span>)) <span class="enscript-keyword">return</span> false;
	    <span class="enscript-keyword">if</span> (!s-&gt;addChar(<span class="enscript-string">'='</span>)) <span class="enscript-keyword">return</span> false;
	    <span class="enscript-keyword">break</span>;
    <span class="enscript-keyword">case</span> <span class="enscript-reference">2</span>:
	    c = __CFPLDataEncodeTable [ ((p[-1] &lt;&lt; 2) &amp; 0x3c)];
	    <span class="enscript-keyword">if</span> (!s-&gt;addChar(c)) <span class="enscript-keyword">return</span> false;
	    <span class="enscript-keyword">if</span> (!s-&gt;addChar(<span class="enscript-string">'='</span>)) <span class="enscript-keyword">return</span> false;
	    <span class="enscript-keyword">break</span>;
    }

    <span class="enscript-keyword">return</span> s-&gt;addXMLEndTag(<span class="enscript-string">&quot;data&quot;</span>);
}

<span class="enscript-type">void</span> <span class="enscript-function-name">OSData::setDeallocFunction</span>(DeallocFunction func)
{
    <span class="enscript-keyword">if</span> (!reserved)
    {
    	reserved = (typeof(reserved)) kalloc_container(<span class="enscript-keyword">sizeof</span>(ExpansionData));
        <span class="enscript-keyword">if</span> (!reserved) <span class="enscript-keyword">return</span>;
        bzero(reserved, <span class="enscript-keyword">sizeof</span>(ExpansionData));
    }
    reserved-&gt;deallocFunction = func;
}

<span class="enscript-type">void</span> <span class="enscript-function-name">OSData::setSerializable</span>(<span class="enscript-type">bool</span> serializable)
{
    <span class="enscript-keyword">if</span> (!reserved)
    {
    	reserved = (typeof(reserved)) kalloc_container(<span class="enscript-keyword">sizeof</span>(ExpansionData));
	<span class="enscript-keyword">if</span> (!reserved) <span class="enscript-keyword">return</span>;
	bzero(reserved, <span class="enscript-keyword">sizeof</span>(ExpansionData));
    }
    reserved-&gt;disableSerialization = (!serializable);
}
</pre>
<hr />
</body></html>