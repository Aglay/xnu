<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>OSString.cpp</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">OSString.cpp&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/* IOString.m created by rsulack on Wed 17-Sep-1997 */</span>
<span class="enscript-comment">/* IOString.cpp converted to C++ on Tue 1998-9-22 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSString.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSSerialize.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSLib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSData.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">super</span> OSObject

<span class="enscript-function-name">OSDefineMetaClassAndStructors</span>(OSString, OSObject)
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSString,  0);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSString,  1);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSString,  2);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSString,  3);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSString,  4);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSString,  5);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSString,  6);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSString,  7);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSString,  8);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSString,  9);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSString, 10);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSString, 11);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSString, 12);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSString, 13);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSString, 14);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSString, 15);

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSString::initWithString</span>(<span class="enscript-type">const</span> OSString *aString)
{
    <span class="enscript-keyword">return</span> initWithCString(aString-&gt;string);
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSString::initWithCString</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *cString)
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>   newLength;
    <span class="enscript-type">char</span>         * newString;

    <span class="enscript-keyword">if</span> (!cString || !super::init()) <span class="enscript-keyword">return</span> false;

    newLength = strlen(cString) + 1;
    newString = (<span class="enscript-type">char</span> *) kalloc_container(newLength);
    <span class="enscript-keyword">if</span> (!newString) <span class="enscript-keyword">return</span> false;

    bcopy(cString, newString, newLength);

    <span class="enscript-keyword">if</span> ( !(flags &amp; kOSStringNoCopy) &amp;&amp; string) {
        kfree(string, (vm_size_t)length);
        OSCONTAINER_ACCUMSIZE(-((size_t)length));
    }
    string = newString;
    length = newLength;
    flags &amp;= ~kOSStringNoCopy;

    OSCONTAINER_ACCUMSIZE(length);

    <span class="enscript-keyword">return</span> true;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSString::initWithStringOfLength</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *cString, size_t inlength)
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>   newLength;
    <span class="enscript-type">char</span>         * newString;

    <span class="enscript-keyword">if</span> (!cString || !super::init()) <span class="enscript-keyword">return</span> false;

    newLength = inlength + 1;
    newString = (<span class="enscript-type">char</span> *) kalloc_container(newLength);
    <span class="enscript-keyword">if</span> (!newString) <span class="enscript-keyword">return</span> false;

    bcopy(cString, newString, inlength);
    newString[inlength] = 0;

    <span class="enscript-keyword">if</span> ( !(flags &amp; kOSStringNoCopy) &amp;&amp; string) {
        kfree(string, (vm_size_t)length);
        OSCONTAINER_ACCUMSIZE(-((size_t)length));
    }

    string = newString;
    length = newLength;
    flags &amp;= ~kOSStringNoCopy;

    OSCONTAINER_ACCUMSIZE(length);

    <span class="enscript-keyword">return</span> true;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSString::initWithCStringNoCopy</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *cString)
{
    <span class="enscript-keyword">if</span> (!cString || !super::init())
        <span class="enscript-keyword">return</span> false;

    length = strlen(cString) + 1;
    flags |= kOSStringNoCopy;
    string = const_cast&lt;<span class="enscript-type">char</span> *&gt;(cString);

    <span class="enscript-keyword">return</span> true;
}

OSString *<span class="enscript-function-name">OSString::withString</span>(<span class="enscript-type">const</span> OSString *aString)
{
    OSString *me = <span class="enscript-keyword">new</span> OSString;

    <span class="enscript-keyword">if</span> (me &amp;&amp; !me-&gt;initWithString(aString)) {
        me-&gt;release();
        <span class="enscript-keyword">return</span> 0;
    }

    <span class="enscript-keyword">return</span> me;
}

OSString *<span class="enscript-function-name">OSString::withCString</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *cString)
{
    OSString *me = <span class="enscript-keyword">new</span> OSString;

    <span class="enscript-keyword">if</span> (me &amp;&amp; !me-&gt;initWithCString(cString)) {
        me-&gt;release();
        <span class="enscript-keyword">return</span> 0;
    }

    <span class="enscript-keyword">return</span> me;
}

OSString *<span class="enscript-function-name">OSString::withCStringNoCopy</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *cString)
{
    OSString *me = <span class="enscript-keyword">new</span> OSString;

    <span class="enscript-keyword">if</span> (me &amp;&amp; !me-&gt;initWithCStringNoCopy(cString)) {
        me-&gt;release();
        <span class="enscript-keyword">return</span> 0;
    }

    <span class="enscript-keyword">return</span> me;
}

OSString *<span class="enscript-function-name">OSString::withStringOfLength</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *cString, size_t length)
{
    OSString *me = <span class="enscript-keyword">new</span> OSString;

    <span class="enscript-keyword">if</span> (me &amp;&amp; !me-&gt;initWithStringOfLength(cString, length)) {
        me-&gt;release();
        <span class="enscript-keyword">return</span> 0;
    }

    <span class="enscript-keyword">return</span> me;
}



<span class="enscript-comment">/* @@@ gvdl */</span>
#<span class="enscript-reference">if</span> 0
OSString *<span class="enscript-function-name">OSString::stringWithFormat</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *format, ...)
{
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">KERNEL</span>			// <span class="enscript-variable-name">mach3xxx</span>
    OSString *me;
    va_list argList;

    <span class="enscript-keyword">if</span> (!format)
        <span class="enscript-keyword">return</span> 0;

    va_start(argList, format);
    me = stringWithCapacity(256);
    me-&gt;length = vsnprintf(me-&gt;string, 256, format, argList);
    me-&gt;length++;	<span class="enscript-comment">// we include the null in the length
</span>    <span class="enscript-keyword">if</span> (me-&gt;Length &gt; 256)
        me-&gt;Length = 256;
    va_end (argList);

    <span class="enscript-keyword">return</span> me;
#<span class="enscript-reference">else</span>
    <span class="enscript-keyword">return</span> 0;
#<span class="enscript-reference">endif</span>
}
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* 0 */</span>

<span class="enscript-type">void</span> <span class="enscript-function-name">OSString::free</span>()
{
    <span class="enscript-keyword">if</span> ( !(flags &amp; kOSStringNoCopy) &amp;&amp; string) {
        kfree(string, (vm_size_t)length);
        OSCONTAINER_ACCUMSIZE(-((size_t)length));
    }

    <span class="enscript-reference">super</span>::free();
}

<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSString::getLength</span>()  <span class="enscript-type">const</span> { <span class="enscript-keyword">return</span> length - 1; }

<span class="enscript-type">const</span> <span class="enscript-type">char</span> *<span class="enscript-function-name">OSString::getCStringNoCopy</span>() <span class="enscript-type">const</span>
{
    <span class="enscript-keyword">return</span> string;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSString::setChar</span>(<span class="enscript-type">char</span> aChar, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> index)
{
    <span class="enscript-keyword">if</span> ( !(flags &amp; kOSStringNoCopy) &amp;&amp; index &lt; length - 1) {
        string[index] = aChar;

        <span class="enscript-keyword">return</span> true;
    }
    <span class="enscript-keyword">else</span>
        <span class="enscript-keyword">return</span> false;
}

<span class="enscript-type">char</span> <span class="enscript-function-name">OSString::getChar</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> index) <span class="enscript-type">const</span>
{
    <span class="enscript-keyword">if</span> (index &lt; length)
        <span class="enscript-keyword">return</span> string[index];
    <span class="enscript-keyword">else</span>
        <span class="enscript-keyword">return</span> <span class="enscript-string">'\0'</span>;
}


<span class="enscript-type">bool</span> <span class="enscript-function-name">OSString::isEqualTo</span>(<span class="enscript-type">const</span> OSString *aString) <span class="enscript-type">const</span>
{
    <span class="enscript-keyword">if</span> (length != aString-&gt;length)
        <span class="enscript-keyword">return</span> false;
    <span class="enscript-keyword">else</span>
        <span class="enscript-keyword">return</span> isEqualTo((<span class="enscript-type">const</span> <span class="enscript-type">char</span> *) aString-&gt;string);
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSString::isEqualTo</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *aCString) <span class="enscript-type">const</span>
{
    <span class="enscript-keyword">return</span> strncmp(string, aCString, length) == 0;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSString::isEqualTo</span>(<span class="enscript-type">const</span> OSMetaClassBase *obj) <span class="enscript-type">const</span>
{
    OSString *	str;
    OSData *    data;

    <span class="enscript-keyword">if</span> ((str = OSDynamicCast(OSString, obj)))
        <span class="enscript-keyword">return</span> isEqualTo(str);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> ((data = OSDynamicCast (OSData, obj)))
        <span class="enscript-keyword">return</span> isEqualTo(data);
    <span class="enscript-keyword">else</span>
        <span class="enscript-keyword">return</span> false;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSString::isEqualTo</span>(<span class="enscript-type">const</span> OSData *obj) <span class="enscript-type">const</span>
{
    <span class="enscript-keyword">if</span> (NULL == obj)
      <span class="enscript-keyword">return</span> false;

    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> dataLen = obj-&gt;getLength ();;
    <span class="enscript-type">char</span> * dataPtr = (<span class="enscript-type">char</span> *) obj-&gt;getBytesNoCopy ();

    <span class="enscript-keyword">if</span> (dataLen != length) {

      <span class="enscript-comment">// check for the fact that OSData may be a buffer that
</span>      <span class="enscript-comment">// that includes a termination byte and will thus have
</span>      <span class="enscript-comment">// a length of the actual string length PLUS 1. In this
</span>      <span class="enscript-comment">// case we verify that the additional byte is a terminator
</span>      <span class="enscript-comment">// and if so count the two lengths as being the same.
</span>
      <span class="enscript-keyword">if</span> ( (dataLen - length) == 1 ) {
	<span class="enscript-keyword">if</span> (dataPtr[dataLen-1] != 0)
	  <span class="enscript-keyword">return</span> false;
	dataLen--;
      }
      <span class="enscript-keyword">else</span>
	<span class="enscript-keyword">return</span> false;
    }

    <span class="enscript-keyword">for</span> ( <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i=0; i &lt; dataLen; i++ ) {
      <span class="enscript-keyword">if</span> ( *dataPtr++ != string[i] )
        <span class="enscript-keyword">return</span> false;
    }

    <span class="enscript-keyword">return</span> true;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSString::serialize</span>(OSSerialize *s) <span class="enscript-type">const</span>
{
    <span class="enscript-type">char</span> *c = string;

    <span class="enscript-keyword">if</span> (s-&gt;previouslySerialized(<span class="enscript-keyword">this</span>)) <span class="enscript-keyword">return</span> true;

    <span class="enscript-keyword">if</span> (!s-&gt;addXMLStartTag(<span class="enscript-keyword">this</span>, <span class="enscript-string">&quot;string&quot;</span>)) <span class="enscript-keyword">return</span> false;
    <span class="enscript-keyword">while</span> (*c) {
        <span class="enscript-keyword">if</span> (*c == <span class="enscript-string">'&lt;'</span>) {
            <span class="enscript-keyword">if</span> (!s-&gt;addString(<span class="enscript-string">&quot;&amp;lt;&quot;</span>)) <span class="enscript-keyword">return</span> false;
        } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (*c == <span class="enscript-string">'&gt;'</span>) {
            <span class="enscript-keyword">if</span> (!s-&gt;addString(<span class="enscript-string">&quot;&amp;gt;&quot;</span>)) <span class="enscript-keyword">return</span> false;
        } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (*c == <span class="enscript-string">'&amp;'</span>) {
            <span class="enscript-keyword">if</span> (!s-&gt;addString(<span class="enscript-string">&quot;&amp;amp;&quot;</span>)) <span class="enscript-keyword">return</span> false;
        } <span class="enscript-keyword">else</span> {
            <span class="enscript-keyword">if</span> (!s-&gt;addChar(*c)) <span class="enscript-keyword">return</span> false;
        }
        c++;
    }   

    <span class="enscript-keyword">return</span> s-&gt;addXMLEndTag(<span class="enscript-string">&quot;string&quot;</span>);
}
</pre>
<hr />
</body></html>