<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>OSDictionary.cpp</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">OSDictionary.cpp&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/* OSDictionary.m created by rsulack on Fri 12-Sep-1997 */</span>
<span class="enscript-comment">/* OSDictionary.cpp converted to C++ by gvdl on Fri 1998-10-30 */</span>
<span class="enscript-comment">/* OSDictionary.cpp rewritten by gvdl on Fri 1998-10-30 */</span>


#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSDictionary.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSArray.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSSymbol.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSSerialize.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSLib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSCollectionIterator.h&gt;</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">super</span> OSCollection

<span class="enscript-function-name">OSDefineMetaClassAndStructors</span>(OSDictionary, OSCollection)
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSDictionary, 0);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSDictionary, 1);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSDictionary, 2);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSDictionary, 3);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSDictionary, 4);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSDictionary, 5);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSDictionary, 6);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(OSDictionary, 7);

#<span class="enscript-reference">define</span> <span class="enscript-function-name">EXT_CAST</span>(obj) \
    reinterpret_cast&lt;OSObject *&gt;(const_cast&lt;OSMetaClassBase *&gt;(obj))

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSDictionary::initWithCapacity</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> inCapacity)
{
    <span class="enscript-keyword">if</span> (!super::init())
        <span class="enscript-keyword">return</span> false;

    <span class="enscript-keyword">if</span> (inCapacity &gt; (UINT_MAX / <span class="enscript-keyword">sizeof</span>(dictEntry)))
        <span class="enscript-keyword">return</span> false;

    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> size = inCapacity * <span class="enscript-keyword">sizeof</span>(dictEntry);
<span class="enscript-comment">//fOptions |= kSort;
</span>
    dictionary = (dictEntry *) kalloc_container(size);
    <span class="enscript-keyword">if</span> (!dictionary)
        <span class="enscript-keyword">return</span> false;

    bzero(dictionary, size);
    OSCONTAINER_ACCUMSIZE(size);

    count = 0;
    capacity = inCapacity;
    capacityIncrement = (inCapacity)? inCapacity : 16;

    <span class="enscript-keyword">return</span> true;	
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSDictionary::initWithObjects</span>(<span class="enscript-type">const</span> OSObject *objects[],
                                   <span class="enscript-type">const</span> OSSymbol *keys[],
                                   <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> theCount,
                                   <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> theCapacity)
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> newCapacity = theCount;

    <span class="enscript-keyword">if</span> (!objects || !keys)
        <span class="enscript-keyword">return</span> false;

    <span class="enscript-keyword">if</span> ( theCapacity ) {
        <span class="enscript-keyword">if</span> (theCount &gt; theCapacity)
            <span class="enscript-keyword">return</span> false;
        
        newCapacity = theCapacity;
    }

    <span class="enscript-keyword">if</span> (!initWithCapacity(newCapacity))
        <span class="enscript-keyword">return</span> false;

    <span class="enscript-keyword">for</span> (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i = 0; i &lt; theCount; i++) {
        <span class="enscript-type">const</span> OSMetaClassBase *newObject = *objects++;

        <span class="enscript-keyword">if</span> (!newObject || !keys[i] || !setObject(keys[i], newObject))
            <span class="enscript-keyword">return</span> false;
    }

    <span class="enscript-keyword">return</span> true;	
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSDictionary::initWithObjects</span>(<span class="enscript-type">const</span> OSObject *objects[],
                                   <span class="enscript-type">const</span> OSString *keys[],
                                   <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> theCount,
                                   <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> theCapacity)
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> newCapacity = theCount;

    <span class="enscript-keyword">if</span> (!objects || !keys)
        <span class="enscript-keyword">return</span> false;

    <span class="enscript-keyword">if</span> ( theCapacity ) {
        <span class="enscript-keyword">if</span> (theCount &gt; theCapacity)
            <span class="enscript-keyword">return</span> false;

        newCapacity = theCapacity;
    }

    <span class="enscript-keyword">if</span> (!initWithCapacity(newCapacity))
        <span class="enscript-keyword">return</span> false;

    <span class="enscript-keyword">for</span> (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i = 0; i &lt; theCount; i++) {
        <span class="enscript-type">const</span> OSSymbol *key = OSSymbol::withString(*keys++);
        <span class="enscript-type">const</span> OSMetaClassBase *newObject = *objects++;

        <span class="enscript-keyword">if</span> (!key)
            <span class="enscript-keyword">return</span> false;

        <span class="enscript-keyword">if</span> (!newObject || !setObject(key, newObject)) {
            key-&gt;release();
            <span class="enscript-keyword">return</span> false;
        }

        key-&gt;release();
    }

    <span class="enscript-keyword">return</span> true;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSDictionary::initWithDictionary</span>(<span class="enscript-type">const</span> OSDictionary *dict,
                                      <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> theCapacity)
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> newCapacity;

    <span class="enscript-keyword">if</span> ( !dict )
        <span class="enscript-keyword">return</span> false;

    newCapacity = dict-&gt;count;

    <span class="enscript-keyword">if</span> ( theCapacity ) {
        <span class="enscript-keyword">if</span> ( dict-&gt;count &gt; theCapacity )
            <span class="enscript-keyword">return</span> false;
        
        newCapacity = theCapacity;
    }

    <span class="enscript-keyword">if</span> (!initWithCapacity(newCapacity))
        <span class="enscript-keyword">return</span> false;

    <span class="enscript-keyword">if</span> ((kSort &amp; fOptions) &amp;&amp; !(kSort &amp; dict-&gt;fOptions)) {
	<span class="enscript-keyword">for</span> (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i = 0; i &lt; dict-&gt;count; i++) {
	    <span class="enscript-keyword">if</span> (!setObject(dict-&gt;dictionary[i].key, dict-&gt;dictionary[i].value)) {
		<span class="enscript-keyword">return</span> false;
	    }
	}
	<span class="enscript-keyword">return</span> true;
    }

    count = dict-&gt;count;
    bcopy(dict-&gt;dictionary, dictionary, count * <span class="enscript-keyword">sizeof</span>(dictEntry));
    <span class="enscript-keyword">for</span> (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i = 0; i &lt; count; i++) {
        dictionary[i].key-&gt;taggedRetain(OSTypeID(OSCollection));
        dictionary[i].value-&gt;taggedRetain(OSTypeID(OSCollection));
    }

    <span class="enscript-keyword">return</span> true;
}

OSDictionary *<span class="enscript-function-name">OSDictionary::withCapacity</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> capacity)
{
    OSDictionary *me = <span class="enscript-keyword">new</span> OSDictionary;

    <span class="enscript-keyword">if</span> (me &amp;&amp; !me-&gt;initWithCapacity(capacity)) {
        me-&gt;release();
        <span class="enscript-keyword">return</span> 0;
    }

    <span class="enscript-keyword">return</span> me;
}

OSDictionary *<span class="enscript-function-name">OSDictionary::withObjects</span>(<span class="enscript-type">const</span> OSObject *objects[],
                                        <span class="enscript-type">const</span> OSSymbol *keys[],
                                        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> count,
                                        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> capacity)
{
    OSDictionary *me = <span class="enscript-keyword">new</span> OSDictionary;

    <span class="enscript-keyword">if</span> (me &amp;&amp; !me-&gt;initWithObjects(objects, keys, count, capacity)) {
        me-&gt;release();
        <span class="enscript-keyword">return</span> 0;
    }

    <span class="enscript-keyword">return</span> me;
}

OSDictionary *<span class="enscript-function-name">OSDictionary::withObjects</span>(<span class="enscript-type">const</span> OSObject *objects[],
                                        <span class="enscript-type">const</span> OSString *keys[],
                                        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> count,
                                        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> capacity)
{
    OSDictionary *me = <span class="enscript-keyword">new</span> OSDictionary;

    <span class="enscript-keyword">if</span> (me &amp;&amp; !me-&gt;initWithObjects(objects, keys, count, capacity)) {
        me-&gt;release();
        <span class="enscript-keyword">return</span> 0;
    }

    <span class="enscript-keyword">return</span> me;
}

OSDictionary *<span class="enscript-function-name">OSDictionary::withDictionary</span>(<span class="enscript-type">const</span> OSDictionary *dict,
                                           <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> capacity)
{
    OSDictionary *me = <span class="enscript-keyword">new</span> OSDictionary;

    <span class="enscript-keyword">if</span> (me &amp;&amp; !me-&gt;initWithDictionary(dict, capacity)) {
        me-&gt;release();
        <span class="enscript-keyword">return</span> 0;
    }

    <span class="enscript-keyword">return</span> me;
}

<span class="enscript-type">void</span> <span class="enscript-function-name">OSDictionary::free</span>()
{
    (<span class="enscript-type">void</span>) super::setOptions(0, kImmutable);
    flushCollection();
    <span class="enscript-keyword">if</span> (dictionary) {
        kfree(dictionary, capacity * <span class="enscript-keyword">sizeof</span>(dictEntry));
        OSCONTAINER_ACCUMSIZE( -(capacity * <span class="enscript-keyword">sizeof</span>(dictEntry)) );
    }

    <span class="enscript-reference">super</span>::free();
}

<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSDictionary::getCount</span>() <span class="enscript-type">const</span> { <span class="enscript-keyword">return</span> count; }
<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSDictionary::getCapacity</span>() <span class="enscript-type">const</span> { <span class="enscript-keyword">return</span> capacity; }

<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSDictionary::getCapacityIncrement</span>() <span class="enscript-type">const</span>
{
    <span class="enscript-keyword">return</span> capacityIncrement;
}

<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSDictionary::setCapacityIncrement</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> increment)
{
    capacityIncrement = (increment)? increment : 16;

    <span class="enscript-keyword">return</span> capacityIncrement;
}

<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSDictionary::ensureCapacity</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> newCapacity)
{
    dictEntry *newDict;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> finalCapacity, oldSize, newSize;

    <span class="enscript-keyword">if</span> (newCapacity &lt;= capacity)
        <span class="enscript-keyword">return</span> capacity;

    <span class="enscript-comment">// round up
</span>    finalCapacity = (((newCapacity - 1) / capacityIncrement) + 1)
                * capacityIncrement;

    <span class="enscript-comment">// integer overflow check
</span>    <span class="enscript-keyword">if</span> (finalCapacity &lt; newCapacity || (finalCapacity &gt; (UINT_MAX / <span class="enscript-keyword">sizeof</span>(dictEntry))))
        <span class="enscript-keyword">return</span> capacity;
    
    newSize = <span class="enscript-keyword">sizeof</span>(dictEntry) * finalCapacity;

    newDict = (dictEntry *) kalloc_container(newSize);
    <span class="enscript-keyword">if</span> (newDict) {
        oldSize = <span class="enscript-keyword">sizeof</span>(dictEntry) * capacity;

        bcopy(dictionary, newDict, oldSize);
        bzero(&amp;newDict[capacity], newSize - oldSize);

        OSCONTAINER_ACCUMSIZE(((size_t)newSize) - ((size_t)oldSize));
        kfree(dictionary, oldSize);

        dictionary = newDict;
        capacity = finalCapacity;
    }

    <span class="enscript-keyword">return</span> capacity;
}

<span class="enscript-type">void</span> <span class="enscript-function-name">OSDictionary::flushCollection</span>()
{
    haveUpdated();

    <span class="enscript-keyword">for</span> (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i = 0; i &lt; count; i++) {
        dictionary[i].key-&gt;taggedRelease(OSTypeID(OSCollection));
        dictionary[i].value-&gt;taggedRelease(OSTypeID(OSCollection));
    }
    count = 0;
}

<span class="enscript-type">bool</span> OSDictionary::
<span class="enscript-function-name">setObject</span>(<span class="enscript-type">const</span> OSSymbol *aKey, <span class="enscript-type">const</span> OSMetaClassBase *anObject)
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i;
    <span class="enscript-type">bool</span> exists;

    <span class="enscript-keyword">if</span> (!anObject || !aKey)
        <span class="enscript-keyword">return</span> false;

    <span class="enscript-comment">// if the key exists, replace the object
</span>
    <span class="enscript-keyword">if</span> (fOptions &amp; kSort) {
    	i = OSSymbol::bsearch(aKey, &amp;dictionary[0], count, <span class="enscript-keyword">sizeof</span>(dictionary[0]));
	exists = (i &lt; count) &amp;&amp; (aKey == dictionary[i].key);
    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">for</span> (exists = false, i = 0; i &lt; count; i++) {
        <span class="enscript-keyword">if</span> ((exists = (aKey == dictionary[i].key))) <span class="enscript-keyword">break</span>;
    }

    <span class="enscript-keyword">if</span> (exists) {
	<span class="enscript-type">const</span> OSMetaClassBase *oldObject = dictionary[i].value;
    
	haveUpdated();
    
	anObject-&gt;taggedRetain(OSTypeID(OSCollection));
	dictionary[i].value = anObject;
    
	oldObject-&gt;taggedRelease(OSTypeID(OSCollection));
	<span class="enscript-keyword">return</span> true;
    }

    <span class="enscript-comment">// add new key, possibly extending our capacity
</span>    <span class="enscript-keyword">if</span> (count &gt;= capacity &amp;&amp; count &gt;= ensureCapacity(count+1))
        <span class="enscript-keyword">return</span> false;

    haveUpdated();

    bcopy(&amp;dictionary[i], &amp;dictionary[i+1], (count - i) * <span class="enscript-keyword">sizeof</span>(dictionary[0]));

    aKey-&gt;taggedRetain(OSTypeID(OSCollection));
    anObject-&gt;taggedRetain(OSTypeID(OSCollection));
    dictionary[i].key = aKey;
    dictionary[i].value = anObject;
    count++;

    <span class="enscript-keyword">return</span> true;
}

<span class="enscript-type">void</span> <span class="enscript-function-name">OSDictionary::removeObject</span>(<span class="enscript-type">const</span> OSSymbol *aKey)
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i;
    <span class="enscript-type">bool</span> exists;

    <span class="enscript-keyword">if</span> (!aKey)
        <span class="enscript-keyword">return</span>;

    <span class="enscript-comment">// if the key exists, remove the object
</span>
    <span class="enscript-keyword">if</span> (fOptions &amp; kSort) {
    	i = OSSymbol::bsearch(aKey, &amp;dictionary[0], count, <span class="enscript-keyword">sizeof</span>(dictionary[0]));
	exists = (i &lt; count) &amp;&amp; (aKey == dictionary[i].key);
    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">for</span> (exists = false, i = 0; i &lt; count; i++) {
        <span class="enscript-keyword">if</span> ((exists = (aKey == dictionary[i].key))) <span class="enscript-keyword">break</span>;
    }

    <span class="enscript-keyword">if</span> (exists) {
	dictEntry oldEntry = dictionary[i];

	haveUpdated();

	count--;
	bcopy(&amp;dictionary[i+1], &amp;dictionary[i], (count - i) * <span class="enscript-keyword">sizeof</span>(dictionary[0]));

	oldEntry.key-&gt;taggedRelease(OSTypeID(OSCollection));
	oldEntry.value-&gt;taggedRelease(OSTypeID(OSCollection));
	<span class="enscript-keyword">return</span>;
    }
}


<span class="enscript-comment">// Returns true on success, false on an error condition.
</span><span class="enscript-type">bool</span> <span class="enscript-function-name">OSDictionary::merge</span>(<span class="enscript-type">const</span> OSDictionary *srcDict)
{
    <span class="enscript-type">const</span> OSSymbol * sym;
    OSCollectionIterator * iter;

    <span class="enscript-keyword">if</span> ( !OSDynamicCast(OSDictionary, srcDict) )
        <span class="enscript-keyword">return</span> false;

    iter = OSCollectionIterator::withCollection(const_cast&lt;OSDictionary *&gt;(srcDict));
    <span class="enscript-keyword">if</span> ( !iter )
        <span class="enscript-keyword">return</span> false;

    <span class="enscript-keyword">while</span> ( (sym = (<span class="enscript-type">const</span> OSSymbol *)iter-&gt;getNextObject()) ) {
        <span class="enscript-type">const</span> OSMetaClassBase * obj;

        obj = srcDict-&gt;getObject(sym);
        <span class="enscript-keyword">if</span> ( !setObject(sym, obj) ) {
            iter-&gt;release();
            <span class="enscript-keyword">return</span> false;
        }
    }
    iter-&gt;release();

    <span class="enscript-keyword">return</span> true;
}

OSObject *<span class="enscript-function-name">OSDictionary::getObject</span>(<span class="enscript-type">const</span> OSSymbol *aKey) <span class="enscript-type">const</span>
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i;
    <span class="enscript-type">bool</span> exists;

    <span class="enscript-keyword">if</span> (!aKey)
        <span class="enscript-keyword">return</span> 0;

    <span class="enscript-comment">// if the key exists, return the object
</span>
    <span class="enscript-keyword">if</span> (fOptions &amp; kSort) {
    	i = OSSymbol::bsearch(aKey, &amp;dictionary[0], count, <span class="enscript-keyword">sizeof</span>(dictionary[0]));
	exists = (i &lt; count) &amp;&amp; (aKey == dictionary[i].key);
    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">for</span> (exists = false, i = 0; i &lt; count; i++) {
        <span class="enscript-keyword">if</span> ((exists = (aKey == dictionary[i].key))) <span class="enscript-keyword">break</span>;
    }

    <span class="enscript-keyword">if</span> (exists) {
	<span class="enscript-keyword">return</span> (const_cast&lt;OSObject *&gt; ((<span class="enscript-type">const</span> OSObject *)dictionary[i].value));
    }

    <span class="enscript-keyword">return</span> 0;
}

<span class="enscript-comment">// Wrapper macros
</span>#<span class="enscript-reference">define</span> <span class="enscript-function-name">OBJECT_WRAP_1</span>(cmd, k)						\
{									\
    <span class="enscript-type">const</span> OSSymbol *tmpKey = k;						\
    OSObject *retObj = cmd(tmpKey);					\
									\
    tmpKey-&gt;release();							\
    <span class="enscript-keyword">return</span> retObj;							\
}

#<span class="enscript-reference">define</span> <span class="enscript-function-name">OBJECT_WRAP_2</span>(cmd, k, o)					\
{									\
    <span class="enscript-type">const</span> OSSymbol *tmpKey = k;						\
    <span class="enscript-type">bool</span> ret = cmd(tmpKey, o);						\
									\
    tmpKey-&gt;release();							\
    <span class="enscript-keyword">return</span> ret;								\
}

#<span class="enscript-reference">define</span> <span class="enscript-function-name">OBJECT_WRAP_3</span>(cmd, k)						\
{									\
    <span class="enscript-type">const</span> OSSymbol *tmpKey = k;						\
    cmd(tmpKey);							\
    tmpKey-&gt;release();							\
}


<span class="enscript-type">bool</span> <span class="enscript-function-name">OSDictionary::setObject</span>(<span class="enscript-type">const</span> OSString *aKey, <span class="enscript-type">const</span> OSMetaClassBase *anObject)
    OBJECT_WRAP_2(setObject, OSSymbol::withString(aKey), anObject)
<span class="enscript-type">bool</span> <span class="enscript-function-name">OSDictionary::setObject</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *aKey, <span class="enscript-type">const</span> OSMetaClassBase *anObject)
    OBJECT_WRAP_2(setObject, OSSymbol::withCString(aKey), anObject)

OSObject *<span class="enscript-function-name">OSDictionary::getObject</span>(<span class="enscript-type">const</span> OSString *aKey) <span class="enscript-type">const</span>
    OBJECT_WRAP_1(getObject, OSSymbol::withString(aKey))
OSObject *<span class="enscript-function-name">OSDictionary::getObject</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *aKey) <span class="enscript-type">const</span>
    OBJECT_WRAP_1(getObject, OSSymbol::withCString(aKey))

<span class="enscript-type">void</span> <span class="enscript-function-name">OSDictionary::removeObject</span>(<span class="enscript-type">const</span> OSString *aKey)
    OBJECT_WRAP_3(removeObject, OSSymbol::withString(aKey))
<span class="enscript-type">void</span> <span class="enscript-function-name">OSDictionary::removeObject</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *aKey)
    OBJECT_WRAP_3(removeObject, OSSymbol::withCString(aKey))

<span class="enscript-type">bool</span>
<span class="enscript-function-name">OSDictionary::isEqualTo</span>(<span class="enscript-type">const</span> OSDictionary *srcDict, <span class="enscript-type">const</span> OSCollection *keys) <span class="enscript-type">const</span>
{
    OSCollectionIterator * iter;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> keysCount;
    <span class="enscript-type">const</span> OSMetaClassBase * obj1;
    <span class="enscript-type">const</span> OSMetaClassBase * obj2;
    OSString * aKey;
    <span class="enscript-type">bool</span> ret;

    <span class="enscript-keyword">if</span> ( <span class="enscript-keyword">this</span> == srcDict )
        <span class="enscript-keyword">return</span> true;

    keysCount = keys-&gt;getCount();
    <span class="enscript-keyword">if</span> ( (count &lt; keysCount) || (srcDict-&gt;getCount() &lt; keysCount) )
        <span class="enscript-keyword">return</span> false;

    iter = OSCollectionIterator::withCollection(keys);
    <span class="enscript-keyword">if</span> ( !iter )
        <span class="enscript-keyword">return</span> false;

    ret = true;
    <span class="enscript-keyword">while</span> ( (aKey = OSDynamicCast(OSString, iter-&gt;getNextObject())) ) {
        obj1 = getObject(aKey);
        obj2 = srcDict-&gt;getObject(aKey);
        <span class="enscript-keyword">if</span> ( !obj1 || !obj2 ) {
            ret = false;
            <span class="enscript-keyword">break</span>;
        }

        <span class="enscript-keyword">if</span> ( !obj1-&gt;isEqualTo(obj2) ) {
            ret = false;
            <span class="enscript-keyword">break</span>;
        }
    }
    iter-&gt;release();

    <span class="enscript-keyword">return</span> ret;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSDictionary::isEqualTo</span>(<span class="enscript-type">const</span> OSDictionary *srcDict) <span class="enscript-type">const</span>
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i;
    <span class="enscript-type">const</span> OSMetaClassBase * obj;
    
    <span class="enscript-keyword">if</span> ( <span class="enscript-keyword">this</span> == srcDict )
        <span class="enscript-keyword">return</span> true;

    <span class="enscript-keyword">if</span> ( count != srcDict-&gt;getCount() )
        <span class="enscript-keyword">return</span> false;

    <span class="enscript-keyword">for</span> ( i = 0; i &lt; count; i++ ) {
        obj = srcDict-&gt;getObject(dictionary[i].key);
        <span class="enscript-keyword">if</span> ( !obj )
            <span class="enscript-keyword">return</span> false;

        <span class="enscript-keyword">if</span> ( !dictionary[i].value-&gt;isEqualTo(obj) )
            <span class="enscript-keyword">return</span> false;
    }
    
    <span class="enscript-keyword">return</span> true;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSDictionary::isEqualTo</span>(<span class="enscript-type">const</span> OSMetaClassBase *anObject) <span class="enscript-type">const</span>
{
    OSDictionary *dict;

    dict = OSDynamicCast(OSDictionary, anObject);
    <span class="enscript-keyword">if</span> ( dict )
        <span class="enscript-keyword">return</span> isEqualTo(dict);
    <span class="enscript-keyword">else</span>
        <span class="enscript-keyword">return</span> false;
}

<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">OSDictionary::iteratorSize</span>() <span class="enscript-type">const</span>
{
    <span class="enscript-keyword">return</span> <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>);
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSDictionary::initIterator</span>(<span class="enscript-type">void</span> *inIterator) <span class="enscript-type">const</span>
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> *iteratorP = (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> *) inIterator;

    *iteratorP = 0;
    <span class="enscript-keyword">return</span> true;
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSDictionary::getNextObjectForIterator</span>(<span class="enscript-type">void</span> *inIterator, OSObject **ret) <span class="enscript-type">const</span>
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> *iteratorP = (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> *) inIterator;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> index = (*iteratorP)++;

    <span class="enscript-keyword">if</span> (index &lt; count)
        *ret = (OSObject *) dictionary[index].key;
    <span class="enscript-keyword">else</span>
        *ret = 0;

    <span class="enscript-keyword">return</span> (*ret != 0);
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">OSDictionary::serialize</span>(OSSerialize *s) <span class="enscript-type">const</span>
{
    <span class="enscript-keyword">if</span> (s-&gt;previouslySerialized(<span class="enscript-keyword">this</span>)) <span class="enscript-keyword">return</span> true;

    <span class="enscript-keyword">if</span> (!s-&gt;addXMLStartTag(<span class="enscript-keyword">this</span>, <span class="enscript-string">&quot;dict&quot;</span>)) <span class="enscript-keyword">return</span> false;

    <span class="enscript-keyword">for</span> (<span class="enscript-type">unsigned</span> i = 0; i &lt; count; i++) {
        <span class="enscript-type">const</span> OSSymbol *key = dictionary[i].key;

        <span class="enscript-comment">// due the nature of the XML syntax, this must be a symbol
</span>        <span class="enscript-keyword">if</span> (!key-&gt;metaCast(<span class="enscript-string">&quot;OSSymbol&quot;</span>)) {
            <span class="enscript-keyword">return</span> false;
        }
        <span class="enscript-keyword">if</span> (!s-&gt;addString(<span class="enscript-string">&quot;&lt;key&gt;&quot;</span>)) <span class="enscript-keyword">return</span> false;
        <span class="enscript-type">const</span> <span class="enscript-type">char</span> *c = key-&gt;getCStringNoCopy();
	<span class="enscript-keyword">while</span> (*c) {
	    <span class="enscript-keyword">if</span> (*c == <span class="enscript-string">'&lt;'</span>) {
		<span class="enscript-keyword">if</span> (!s-&gt;addString(<span class="enscript-string">&quot;&amp;lt;&quot;</span>)) <span class="enscript-keyword">return</span> false;
	    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (*c == <span class="enscript-string">'&gt;'</span>) {
		<span class="enscript-keyword">if</span> (!s-&gt;addString(<span class="enscript-string">&quot;&amp;gt;&quot;</span>)) <span class="enscript-keyword">return</span> false;
	    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (*c == <span class="enscript-string">'&amp;'</span>) {
		<span class="enscript-keyword">if</span> (!s-&gt;addString(<span class="enscript-string">&quot;&amp;amp;&quot;</span>)) <span class="enscript-keyword">return</span> false;
	    } <span class="enscript-keyword">else</span> {
		<span class="enscript-keyword">if</span> (!s-&gt;addChar(*c)) <span class="enscript-keyword">return</span> false;
	    }
	    c++;
	}   
        <span class="enscript-keyword">if</span> (!s-&gt;addXMLEndTag(<span class="enscript-string">&quot;key&quot;</span>)) <span class="enscript-keyword">return</span> false;

        <span class="enscript-keyword">if</span> (!dictionary[i].value-&gt;serialize(s)) <span class="enscript-keyword">return</span> false;
    }

    <span class="enscript-keyword">return</span> s-&gt;addXMLEndTag(<span class="enscript-string">&quot;dict&quot;</span>);
}

<span class="enscript-type">unsigned</span> <span class="enscript-function-name">OSDictionary::setOptions</span>(<span class="enscript-type">unsigned</span> options, <span class="enscript-type">unsigned</span> mask, <span class="enscript-type">void</span> *)
{
    <span class="enscript-type">unsigned</span> old = super::setOptions(options, mask);
    <span class="enscript-keyword">if</span> ((old ^ options) &amp; mask) {

	<span class="enscript-comment">// Value changed need to recurse over all of the child collections
</span>	<span class="enscript-keyword">for</span> ( <span class="enscript-type">unsigned</span> i = 0; i &lt; count; i++ ) {
	    OSCollection *v = OSDynamicCast(OSCollection, dictionary[i].value);
	    <span class="enscript-keyword">if</span> (v)
		v-&gt;setOptions(options, mask);
	}
    }

    <span class="enscript-keyword">return</span> old;
}

OSCollection * <span class="enscript-function-name">OSDictionary::copyCollection</span>(OSDictionary *cycleDict)
{
    <span class="enscript-type">bool</span> allocDict = !cycleDict;
    OSCollection *ret = 0;
    OSDictionary *newDict = 0;

    <span class="enscript-keyword">if</span> (allocDict) {
	cycleDict = OSDictionary::withCapacity(16);
	<span class="enscript-keyword">if</span> (!cycleDict)
	    <span class="enscript-keyword">return</span> 0;
    }

    <span class="enscript-keyword">do</span> {
	<span class="enscript-comment">// Check for a cycle
</span>	ret = super::copyCollection(cycleDict);
	<span class="enscript-keyword">if</span> (ret)
	    <span class="enscript-keyword">continue</span>;
	
	newDict = OSDictionary::withDictionary(<span class="enscript-keyword">this</span>);
	<span class="enscript-keyword">if</span> (!newDict)
	    <span class="enscript-keyword">continue</span>;

	<span class="enscript-comment">// Insert object into cycle Dictionary
</span>	cycleDict-&gt;setObject((<span class="enscript-type">const</span> OSSymbol *) <span class="enscript-keyword">this</span>, newDict);

	<span class="enscript-keyword">for</span> (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i = 0; i &lt; count; i++) {
	    <span class="enscript-type">const</span> OSMetaClassBase *obj = dictionary[i].value;
	    OSCollection *coll = OSDynamicCast(OSCollection, EXT_CAST(obj));

	    <span class="enscript-keyword">if</span> (coll) {
		OSCollection *newColl = coll-&gt;copyCollection(cycleDict);
		<span class="enscript-keyword">if</span> (!newColl)
		    <span class="enscript-keyword">goto</span> <span class="enscript-reference">abortCopy</span>;

		newDict-&gt;dictionary[i].value = newColl;

		coll-&gt;taggedRelease(OSTypeID(OSCollection));
		newColl-&gt;taggedRetain(OSTypeID(OSCollection));
		newColl-&gt;release();
	    };
	}

	ret = newDict;
	newDict = 0;

    } <span class="enscript-keyword">while</span> (false);

<span class="enscript-reference">abortCopy</span>:
    <span class="enscript-keyword">if</span> (newDict)
	newDict-&gt;release();

    <span class="enscript-keyword">if</span> (allocDict)
	cycleDict-&gt;release();

    <span class="enscript-keyword">return</span> ret;
}

</pre>
<hr />
</body></html>