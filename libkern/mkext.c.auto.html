<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>mkext.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">mkext.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000-2004 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdint.h&gt;</span> // For uintptr_t.
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/mkext.h&gt;</span>


#<span class="enscript-reference">define</span> <span class="enscript-variable-name">BASE</span> 65521L <span class="enscript-comment">/* largest prime smaller than 65536 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">NMAX</span> 5552  // the largest n such that 255n(n+1)/2 + (n+1)(BASE-1) &lt;= 2^32-1

#<span class="enscript-reference">define</span> <span class="enscript-function-name">DO1</span>(buf,i)  {s1 += buf[i]; s2 += s1;}
#<span class="enscript-reference">define</span> <span class="enscript-function-name">DO2</span>(buf,i)  DO1(buf,i); DO1(buf,i+1);
#<span class="enscript-reference">define</span> <span class="enscript-function-name">DO4</span>(buf,i)  DO2(buf,i); DO2(buf,i+2);
#<span class="enscript-reference">define</span> <span class="enscript-function-name">DO8</span>(buf,i)  DO4(buf,i); DO4(buf,i+4);
#<span class="enscript-reference">define</span> <span class="enscript-function-name">DO16</span>(buf)   DO8(buf,0); DO8(buf,8);

u_int32_t
<span class="enscript-function-name">mkext_adler32</span>(uint8_t *buf, int32_t len)
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> s1 = 1; <span class="enscript-comment">// adler &amp; 0xffff;
</span>    <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> s2 = 0; <span class="enscript-comment">// (adler &gt;&gt; 16) &amp; 0xffff;
</span>    <span class="enscript-type">int</span> k;


    <span class="enscript-keyword">while</span> (len &gt; 0) {
        k = len &lt; NMAX ? len : NMAX;
        len -= k;
        <span class="enscript-keyword">while</span> (k &gt;= 16) {
            DO16(buf);
	    buf += 16;
            k -= 16;
        }
        <span class="enscript-keyword">if</span> (k != 0) <span class="enscript-keyword">do</span> {
            s1 += *buf++;
	    s2 += s1;
        } <span class="enscript-keyword">while</span> (--k);
        s1 %= BASE;
        s2 %= BASE;
    }
    <span class="enscript-keyword">return</span> (s2 &lt;&lt; 16) | s1;
}


<span class="enscript-comment">/**************************************************************
 LZSS.C -- A Data Compression Program
***************************************************************
    4/6/1989 Haruhiko Okumura
    Use, distribute, and modify this program freely.
    Please send me your improved versions.
        PC-VAN      SCIENCE
        NIFTY-Serve PAF01022
        CompuServe  74050,1022

**************************************************************/</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">N</span>         4096  <span class="enscript-comment">/* size of ring buffer - must be power of 2 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">F</span>         18    <span class="enscript-comment">/* upper limit for match_length */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THRESHOLD</span> 2     <span class="enscript-comment">/* encode string into position and length
                           if match_length is greater than this */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">NIL</span>       N     <span class="enscript-comment">/* index for root of binary search trees */</span>

<span class="enscript-type">struct</span> encode_state {
    <span class="enscript-comment">/*
     * left &amp; right children &amp; parent. These constitute binary search trees.
     */</span>
    <span class="enscript-type">int</span> lchild[N + 1], rchild[N + 257], parent[N + 1];

    <span class="enscript-comment">/* ring buffer of size N, with extra F-1 bytes to aid string comparison */</span>
    u_int8_t text_buf[N + F - 1];

    <span class="enscript-comment">/*
     * match_length of longest match.
     * These are set by the insert_node() procedure.
     */</span>
    <span class="enscript-type">int</span> match_position, match_length;
};


<span class="enscript-type">int</span>
<span class="enscript-function-name">decompress_lzss</span>(u_int8_t *dst, u_int32_t dstlen, u_int8_t *src, u_int32_t srclen)
{
    <span class="enscript-comment">/* ring buffer of size N, with extra F-1 bytes to aid string comparison */</span>
    u_int8_t text_buf[N + F - 1];
    u_int8_t *dststart = dst;
	u_int8_t *dstend = dst + dstlen;
    u_int8_t *srcend = src + srclen;
    <span class="enscript-type">int</span>  i, j, k, r, c;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> flags;
    
    dst = dststart;
    srcend = src + srclen;
    <span class="enscript-keyword">for</span> (i = 0; i &lt; N - F; i++)
        text_buf[i] = <span class="enscript-string">' '</span>;
    r = N - F;
    flags = 0;
    <span class="enscript-keyword">for</span> ( ; ; ) {
        <span class="enscript-keyword">if</span> (((flags &gt;&gt;= 1) &amp; 0x100) == 0) {
            <span class="enscript-keyword">if</span> (src &lt; srcend) c = *src++; <span class="enscript-keyword">else</span> <span class="enscript-keyword">break</span>;
            flags = c | 0xFF00;  <span class="enscript-comment">/* uses higher byte cleverly */</span>
        }   <span class="enscript-comment">/* to count eight */</span>
        <span class="enscript-keyword">if</span> (flags &amp; 1) {
            <span class="enscript-keyword">if</span> (src &lt; srcend) c = *src++; <span class="enscript-keyword">else</span> <span class="enscript-keyword">break</span>;
            *dst++ = c;
			<span class="enscript-keyword">if</span> (dst &gt;= dstend) {
				<span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
			}
            text_buf[r++] = c;
            r &amp;= (N - 1);
        } <span class="enscript-keyword">else</span> {
            <span class="enscript-keyword">if</span> (src &lt; srcend) i = *src++; <span class="enscript-keyword">else</span> <span class="enscript-keyword">break</span>;
            <span class="enscript-keyword">if</span> (src &lt; srcend) j = *src++; <span class="enscript-keyword">else</span> <span class="enscript-keyword">break</span>;
            i |= ((j &amp; 0xF0) &lt;&lt; 4);
            j  =  (j &amp; 0x0F) + THRESHOLD;
            <span class="enscript-keyword">for</span> (k = 0; k &lt;= j; k++) {
                c = text_buf[(i + k) &amp; (N - 1)];
                *dst++ = c;
				<span class="enscript-keyword">if</span> (dst &gt;= dstend) {
					<span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
				}
                text_buf[r++] = c;
                r &amp;= (N - 1);
            }
        }
    }
<span class="enscript-reference">finish</span>:
    <span class="enscript-keyword">return</span> dst - dststart;
}

#<span class="enscript-reference">if</span> !<span class="enscript-variable-name">KERNEL</span>

<span class="enscript-comment">/*
 * initialize state, mostly the trees
 *
 * For i = 0 to N - 1, rchild[i] and lchild[i] will be the right and left 
 * children of node i.  These nodes need not be initialized.  Also, parent[i] 
 * is the parent of node i.  These are initialized to NIL (= N), which stands 
 * for 'not used.'  For i = 0 to 255, rchild[N + i + 1] is the root of the 
 * tree for strings that begin with character i.  These are initialized to NIL. 
 * Note there are 256 trees. */</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">init_state</span>(<span class="enscript-type">struct</span> encode_state *sp)
{
    <span class="enscript-type">int</span>  i;

    bzero(sp, <span class="enscript-keyword">sizeof</span>(*sp));

    <span class="enscript-keyword">for</span> (i = 0; i &lt; N - F; i++)
        sp-&gt;text_buf[i] = <span class="enscript-string">' '</span>;
    <span class="enscript-keyword">for</span> (i = N + 1; i &lt;= N + 256; i++)
        sp-&gt;rchild[i] = NIL;
    <span class="enscript-keyword">for</span> (i = 0; i &lt; N; i++)
        sp-&gt;parent[i] = NIL;
}

<span class="enscript-comment">/*
 * Inserts string of length F, text_buf[r..r+F-1], into one of the trees
 * (text_buf[r]'th tree) and returns the longest-match position and length
 * via the global variables match_position and match_length.
 * If match_length = F, then removes the old node in favor of the new one,
 * because the old one will be deleted sooner. Note r plays double role,
 * as tree node and position in buffer.
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">insert_node</span>(<span class="enscript-type">struct</span> encode_state *sp, <span class="enscript-type">int</span> r)
{
    <span class="enscript-type">int</span>  i, p, cmp;
    u_int8_t  *key;

    cmp = 1;
    key = &amp;sp-&gt;text_buf[r];
    p = N + 1 + key[0];
    sp-&gt;rchild[r] = sp-&gt;lchild[r] = NIL;
    sp-&gt;match_length = 0;
    <span class="enscript-keyword">for</span> ( ; ; ) {
        <span class="enscript-keyword">if</span> (cmp &gt;= 0) {
            <span class="enscript-keyword">if</span> (sp-&gt;rchild[p] != NIL)
                p = sp-&gt;rchild[p];
            <span class="enscript-keyword">else</span> {
                sp-&gt;rchild[p] = r; 
                sp-&gt;parent[r] = p;
                <span class="enscript-keyword">return</span>;
            }
        } <span class="enscript-keyword">else</span> {
            <span class="enscript-keyword">if</span> (sp-&gt;lchild[p] != NIL)
                p = sp-&gt;lchild[p];
            <span class="enscript-keyword">else</span> {
                sp-&gt;lchild[p] = r;
                sp-&gt;parent[r] = p;
                <span class="enscript-keyword">return</span>;
            }
        }
        <span class="enscript-keyword">for</span> (i = 1; i &lt; F; i++) {
            <span class="enscript-keyword">if</span> ((cmp = key[i] - sp-&gt;text_buf[p + i]) != 0)
                <span class="enscript-keyword">break</span>;
        }
        <span class="enscript-keyword">if</span> (i &gt; sp-&gt;match_length) {
            sp-&gt;match_position = p;
            <span class="enscript-keyword">if</span> ((sp-&gt;match_length = i) &gt;= F)
                <span class="enscript-keyword">break</span>;
        }
    }
    sp-&gt;parent[r] = sp-&gt;parent[p];
    sp-&gt;lchild[r] = sp-&gt;lchild[p];
    sp-&gt;rchild[r] = sp-&gt;rchild[p];
    sp-&gt;parent[sp-&gt;lchild[p]] = r;
    sp-&gt;parent[sp-&gt;rchild[p]] = r;
    <span class="enscript-keyword">if</span> (sp-&gt;rchild[sp-&gt;parent[p]] == p)
        sp-&gt;rchild[sp-&gt;parent[p]] = r;
    <span class="enscript-keyword">else</span>
        sp-&gt;lchild[sp-&gt;parent[p]] = r;
    sp-&gt;parent[p] = NIL;  <span class="enscript-comment">/* remove p */</span>
}

<span class="enscript-comment">/* deletes node p from tree */</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">delete_node</span>(<span class="enscript-type">struct</span> encode_state *sp, <span class="enscript-type">int</span> p)
{
    <span class="enscript-type">int</span>  q;
    
    <span class="enscript-keyword">if</span> (sp-&gt;parent[p] == NIL)
        <span class="enscript-keyword">return</span>;  <span class="enscript-comment">/* not in tree */</span>
    <span class="enscript-keyword">if</span> (sp-&gt;rchild[p] == NIL)
        q = sp-&gt;lchild[p];
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (sp-&gt;lchild[p] == NIL)
        q = sp-&gt;rchild[p];
    <span class="enscript-keyword">else</span> {
        q = sp-&gt;lchild[p];
        <span class="enscript-keyword">if</span> (sp-&gt;rchild[q] != NIL) {
            <span class="enscript-keyword">do</span> {
                q = sp-&gt;rchild[q];
            } <span class="enscript-keyword">while</span> (sp-&gt;rchild[q] != NIL);
            sp-&gt;rchild[sp-&gt;parent[q]] = sp-&gt;lchild[q];
            sp-&gt;parent[sp-&gt;lchild[q]] = sp-&gt;parent[q];
            sp-&gt;lchild[q] = sp-&gt;lchild[p];
            sp-&gt;parent[sp-&gt;lchild[p]] = q;
        }
        sp-&gt;rchild[q] = sp-&gt;rchild[p];
        sp-&gt;parent[sp-&gt;rchild[p]] = q;
    }
    sp-&gt;parent[q] = sp-&gt;parent[p];
    <span class="enscript-keyword">if</span> (sp-&gt;rchild[sp-&gt;parent[p]] == p)
        sp-&gt;rchild[sp-&gt;parent[p]] = q;
    <span class="enscript-keyword">else</span>
        sp-&gt;lchild[sp-&gt;parent[p]] = q;
    sp-&gt;parent[p] = NIL;
}

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !KERNEL */</span>

</pre>
<hr />
</body></html>