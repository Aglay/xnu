<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>inet_pton.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">inet_pton.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2004 by Internet Systems Consortium, Inc. (&quot;ISC&quot;)
 * Copyright (c) 1996,1999 by Internet Software Consortium.
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND ISC DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT
 * OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 */</span>
#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">LIBC_SCCS</span>) &amp;&amp; !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">lint</span>)
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> rcsid[] = <span class="enscript-string">&quot;$Id: inet_pton.c,v 1.3.18.2 2005/07/28 07:38:07 marka Exp $&quot;</span>;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* LIBC_SCCS and not lint */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/param.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/socket.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/systm.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/in.h&gt;</span>

<span class="enscript-comment">/*%
 * WARNING: Don't even consider trying to compile this on a system where
 * sizeof(int) &lt; 4.  sizeof(int) &gt; 4 is fine; all the world's not a VAX.
 */</span>

<span class="enscript-type">static</span> <span class="enscript-type">int</span>	inet_pton4(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *src, u_char *dst);
<span class="enscript-type">static</span> <span class="enscript-type">int</span>	inet_pton6(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *src, u_char *dst);

<span class="enscript-comment">/* int
 * inet_pton(af, src, dst)
 *	convert from presentation format (which usually means ASCII printable)
 *	to network format (which is usually some kind of binary format).
 * return:
 *	1 if the address was valid for the specified address family
 *	0 if the address wasn't valid (`dst' is untouched in this case)
 *	-1 if some other error occurred (`dst' is untouched in this case, too)
 * author:
 *	Paul Vixie, 1996.
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">inet_pton</span>(<span class="enscript-type">int</span> af, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *src, <span class="enscript-type">void</span> *dst)
{
	<span class="enscript-keyword">switch</span> (af) {
	<span class="enscript-keyword">case</span> <span class="enscript-reference">AF_INET</span>:
		<span class="enscript-keyword">return</span> (inet_pton4(src, dst));
	<span class="enscript-keyword">case</span> <span class="enscript-reference">AF_INET6</span>:
		<span class="enscript-keyword">return</span> (inet_pton6(src, dst));
	<span class="enscript-reference">default</span>:
		<span class="enscript-keyword">return</span> (-1);
	}
	<span class="enscript-comment">/* NOTREACHED */</span>
}

<span class="enscript-comment">/* int
 * inet_pton4(src, dst)
 *	like inet_aton() but without all the hexadecimal and shorthand.
 * return:
 *	1 if `src' is a valid dotted quad, else 0.
 * notice:
 *	does not touch `dst' unless it's returning 1.
 * author:
 *	Paul Vixie, 1996.
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">inet_pton4</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *src, u_char *dst)
{
	<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> digits[] = <span class="enscript-string">&quot;0123456789&quot;</span>;
	<span class="enscript-type">int</span> saw_digit, octets, ch;
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">NS_INADDRSZ</span>	4
	u_char tmp[NS_INADDRSZ], *tp;

	saw_digit = 0;
	octets = 0;
	*(tp = tmp) = 0;
	<span class="enscript-keyword">while</span> ((ch = *src++) != <span class="enscript-string">'\0'</span>) {
		<span class="enscript-type">const</span> <span class="enscript-type">char</span> *pch;

		<span class="enscript-keyword">if</span> ((pch = strchr(digits, ch)) != NULL) {
			u_int new = *tp * 10 + (pch - digits);

			<span class="enscript-keyword">if</span> (saw_digit &amp;&amp; *tp == 0)
				<span class="enscript-keyword">return</span> (0);
			<span class="enscript-keyword">if</span> (new &gt; 255)
				<span class="enscript-keyword">return</span> (0);
			*tp = new;
			<span class="enscript-keyword">if</span> (!saw_digit) {
				<span class="enscript-keyword">if</span> (++octets &gt; 4)
					<span class="enscript-keyword">return</span> (0);
				saw_digit = 1;
			}
		} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (ch == <span class="enscript-string">'.'</span> &amp;&amp; saw_digit) {
			<span class="enscript-keyword">if</span> (octets == 4)
				<span class="enscript-keyword">return</span> (0);
			*++tp = 0;
			saw_digit = 0;
		} <span class="enscript-keyword">else</span>
			<span class="enscript-keyword">return</span> (0);
	}
	<span class="enscript-keyword">if</span> (octets &lt; 4)
		<span class="enscript-keyword">return</span> (0);
	memcpy(dst, tmp, NS_INADDRSZ);
	<span class="enscript-keyword">return</span> (1);
}

<span class="enscript-comment">/* int
 * inet_pton6(src, dst)
 *	convert presentation level address to network order binary form.
 * return:
 *	1 if `src' is a valid [RFC1884 2.2] address, else 0.
 * notice:
 *	(1) does not touch `dst' unless it's returning 1.
 *	(2) :: in a full address is silently ignored.
 * credit:
 *	inspired by Mark Andrews.
 * author:
 *	Paul Vixie, 1996.
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">inet_pton6</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *src, u_char *dst)
{
	<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> xdigits_l[] = <span class="enscript-string">&quot;0123456789abcdef&quot;</span>,
			  xdigits_u[] = <span class="enscript-string">&quot;0123456789ABCDEF&quot;</span>;
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">NS_IN6ADDRSZ</span>	16
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">NS_INT16SZ</span>	2
	u_char tmp[NS_IN6ADDRSZ], *tp, *endp, *colonp;
	<span class="enscript-type">const</span> <span class="enscript-type">char</span> *xdigits, *curtok;
	<span class="enscript-type">int</span> ch, seen_xdigits;
	u_int val;

	memset((tp = tmp), <span class="enscript-string">'\0'</span>, NS_IN6ADDRSZ);
	endp = tp + NS_IN6ADDRSZ;
	colonp = NULL;
	<span class="enscript-comment">/* Leading :: requires some special handling. */</span>
	<span class="enscript-keyword">if</span> (*src == <span class="enscript-string">':'</span>)
		<span class="enscript-keyword">if</span> (*++src != <span class="enscript-string">':'</span>)
			<span class="enscript-keyword">return</span> (0);
	curtok = src;
	seen_xdigits = 0;
	val = 0;
	<span class="enscript-keyword">while</span> ((ch = *src++) != <span class="enscript-string">'\0'</span>) {
		<span class="enscript-type">const</span> <span class="enscript-type">char</span> *pch;

		<span class="enscript-keyword">if</span> ((pch = strchr((xdigits = xdigits_l), ch)) == NULL)
			pch = strchr((xdigits = xdigits_u), ch);
		<span class="enscript-keyword">if</span> (pch != NULL) {
			val &lt;&lt;= 4;
			val |= (pch - xdigits);
			<span class="enscript-keyword">if</span> (++seen_xdigits &gt; 4)
				<span class="enscript-keyword">return</span> (0);
			<span class="enscript-keyword">continue</span>;
		}
		<span class="enscript-keyword">if</span> (ch == <span class="enscript-string">':'</span>) {
			curtok = src;
			<span class="enscript-keyword">if</span> (!seen_xdigits) {
				<span class="enscript-keyword">if</span> (colonp)
					<span class="enscript-keyword">return</span> (0);
				colonp = tp;
				<span class="enscript-keyword">continue</span>;
			} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (*src == <span class="enscript-string">'\0'</span>) {
				<span class="enscript-keyword">return</span> (0);
			}
			<span class="enscript-keyword">if</span> (tp + NS_INT16SZ &gt; endp)
				<span class="enscript-keyword">return</span> (0);
			*tp++ = (u_char) (val &gt;&gt; 8) &amp; 0xff;
			*tp++ = (u_char) val &amp; 0xff;
			seen_xdigits = 0;
			val = 0;
			<span class="enscript-keyword">continue</span>;
		}
		<span class="enscript-keyword">if</span> (ch == <span class="enscript-string">'.'</span> &amp;&amp; ((tp + NS_INADDRSZ) &lt;= endp) &amp;&amp;
		    inet_pton4(curtok, tp) &gt; 0) {
			tp += NS_INADDRSZ;
			seen_xdigits = 0;
			<span class="enscript-keyword">break</span>;	<span class="enscript-comment">/*%&lt; '\\0' was seen by inet_pton4(). */</span>
		}
		<span class="enscript-keyword">return</span> (0);
	}
	<span class="enscript-keyword">if</span> (seen_xdigits) {
		<span class="enscript-keyword">if</span> (tp + NS_INT16SZ &gt; endp)
			<span class="enscript-keyword">return</span> (0);
		*tp++ = (u_char) (val &gt;&gt; 8) &amp; 0xff;
		*tp++ = (u_char) val &amp; 0xff;
	}
	<span class="enscript-keyword">if</span> (colonp != NULL) {
		<span class="enscript-comment">/*
		 * Since some memmove()'s erroneously fail to handle
		 * overlapping regions, we'll do the shift by hand.
		 */</span>
		<span class="enscript-type">const</span> <span class="enscript-type">int</span> n = tp - colonp;
		<span class="enscript-type">int</span> i;

		<span class="enscript-keyword">if</span> (tp == endp)
			<span class="enscript-keyword">return</span> (0);
		<span class="enscript-keyword">for</span> (i = 1; i &lt;= n; i++) {
			endp[- i] = colonp[n - i];
			colonp[n - i] = 0;
		}
		tp = endp;
	}
	<span class="enscript-keyword">if</span> (tp != endp)
		<span class="enscript-keyword">return</span> (0);
	memcpy(dst, tmp, NS_IN6ADDRSZ);
	<span class="enscript-keyword">return</span> (1);
}
</pre>
<hr />
</body></html>