<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>OSKextVersion.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">OSKextVersion.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000-2008 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/systm.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/OSKextLib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/OSKextLibPrivate.h&gt;</span>
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libc.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/OSKextLib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;System/libkern/OSKextLibPrivate.h&gt;</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/OSKextLibPrivate.h&gt;</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VERS_MAJOR_DIGITS</span>        (4)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VERS_MINOR_DIGITS</span>        (2)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VERS_REVISION_DIGITS</span>     (2)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VERS_STAGE_DIGITS</span>        (1)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VERS_STAGE_LEVEL_DIGITS</span>  (3)

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VERS_MAJOR_MAX</span>           (9999)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VERS_STAGE_LEVEL_MAX</span>      (255)

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VERS_MAJOR_MULT</span>    (100000000)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VERS_MINOR_MULT</span>      (1000000)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VERS_REVISION_MULT</span>     (10000)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VERS_STAGE_MULT</span>         (1000)


<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> {
    kOSKextVersionStageInvalid     = 0,
    kOSKextVersionStageDevelopment = 1,
    kOSKextVersionStageAlpha       = 3,
    kOSKextVersionStageBeta        = 5,
    kOSKextVersionStageCandidate   = 7,
    kOSKextVersionStageRelease     = 9,
} OSKextVersionStage;


<span class="enscript-comment">/*********************************************************************
*********************************************************************/</span>
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">__vers_isdigit</span>(<span class="enscript-type">char</span> c) {
    <span class="enscript-keyword">return</span> (c == <span class="enscript-string">'0'</span> ||
        c == <span class="enscript-string">'1'</span> || c == <span class="enscript-string">'2'</span> || c == <span class="enscript-string">'3'</span> ||
        c == <span class="enscript-string">'4'</span> || c == <span class="enscript-string">'5'</span> || c == <span class="enscript-string">'6'</span> ||
        c == <span class="enscript-string">'7'</span> || c == <span class="enscript-string">'8'</span> || c == <span class="enscript-string">'9'</span>);
}

<span class="enscript-comment">/*********************************************************************
*********************************************************************/</span>
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">__vers_isspace</span>(<span class="enscript-type">char</span> c) {
    <span class="enscript-keyword">return</span> (c == <span class="enscript-string">' '</span> ||
        c == <span class="enscript-string">'\t'</span> ||
        c == <span class="enscript-string">'\r'</span> ||
        c == <span class="enscript-string">'\n'</span>);
}

<span class="enscript-comment">/*********************************************************************
*********************************************************************/</span>
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">__vers_digit_for_char</span>(<span class="enscript-type">char</span> c) {
    <span class="enscript-keyword">switch</span> (c) {
      <span class="enscript-keyword">case</span> <span class="enscript-string">'0'</span>: <span class="enscript-keyword">return</span> 0; <span class="enscript-keyword">break</span>;
      <span class="enscript-keyword">case</span> <span class="enscript-string">'1'</span>: <span class="enscript-keyword">return</span> 1; <span class="enscript-keyword">break</span>;
      <span class="enscript-keyword">case</span> <span class="enscript-string">'2'</span>: <span class="enscript-keyword">return</span> 2; <span class="enscript-keyword">break</span>;
      <span class="enscript-keyword">case</span> <span class="enscript-string">'3'</span>: <span class="enscript-keyword">return</span> 3; <span class="enscript-keyword">break</span>;
      <span class="enscript-keyword">case</span> <span class="enscript-string">'4'</span>: <span class="enscript-keyword">return</span> 4; <span class="enscript-keyword">break</span>;
      <span class="enscript-keyword">case</span> <span class="enscript-string">'5'</span>: <span class="enscript-keyword">return</span> 5; <span class="enscript-keyword">break</span>;
      <span class="enscript-keyword">case</span> <span class="enscript-string">'6'</span>: <span class="enscript-keyword">return</span> 6; <span class="enscript-keyword">break</span>;
      <span class="enscript-keyword">case</span> <span class="enscript-string">'7'</span>: <span class="enscript-keyword">return</span> 7; <span class="enscript-keyword">break</span>;
      <span class="enscript-keyword">case</span> <span class="enscript-string">'8'</span>: <span class="enscript-keyword">return</span> 8; <span class="enscript-keyword">break</span>;
      <span class="enscript-keyword">case</span> <span class="enscript-string">'9'</span>: <span class="enscript-keyword">return</span> 9; <span class="enscript-keyword">break</span>;
      <span class="enscript-reference">default</span>:  <span class="enscript-keyword">return</span> -1; <span class="enscript-keyword">break</span>;
    }

    <span class="enscript-keyword">return</span> -1;
}

<span class="enscript-comment">/*********************************************************************
*********************************************************************/</span>
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">__VERS_isreleasestate</span>(<span class="enscript-type">char</span> c) {
    <span class="enscript-keyword">return</span> (c == <span class="enscript-string">'d'</span> || c == <span class="enscript-string">'a'</span> || c == <span class="enscript-string">'b'</span> || c == <span class="enscript-string">'f'</span>);
}


<span class="enscript-comment">/*********************************************************************
*********************************************************************/</span>
<span class="enscript-type">static</span> OSKextVersionStage <span class="enscript-function-name">__OSKextVersionStageForString</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> ** string_p) {
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> * string;

    <span class="enscript-keyword">if</span> (!string_p || !*string_p) {
        <span class="enscript-keyword">return</span> kOSKextVersionStageInvalid;
    }

    string = *string_p;

    <span class="enscript-keyword">if</span> (__vers_isspace(string[0]) || string[0] == <span class="enscript-string">'\0'</span>) {
        <span class="enscript-keyword">return</span> kOSKextVersionStageRelease;
    } <span class="enscript-keyword">else</span> {
        <span class="enscript-keyword">switch</span> (string[0]) {
          <span class="enscript-keyword">case</span> <span class="enscript-string">'d'</span>:
              <span class="enscript-keyword">if</span> (__vers_isdigit(string[1])) {
                  *string_p = &amp;string[1];
                  <span class="enscript-keyword">return</span> kOSKextVersionStageDevelopment;
              }
              <span class="enscript-keyword">break</span>;
          <span class="enscript-keyword">case</span> <span class="enscript-string">'a'</span>:
              <span class="enscript-keyword">if</span> (__vers_isdigit(string[1])) {
                  *string_p = &amp;string[1];
                  <span class="enscript-keyword">return</span> kOSKextVersionStageAlpha;
              }
              <span class="enscript-keyword">break</span>;
          <span class="enscript-keyword">case</span> <span class="enscript-string">'b'</span>:
              <span class="enscript-keyword">if</span> (__vers_isdigit(string[1])) {
                  *string_p = &amp;string[1];
                  <span class="enscript-keyword">return</span> kOSKextVersionStageBeta;
              }
              <span class="enscript-keyword">break</span>;
          <span class="enscript-keyword">case</span> <span class="enscript-string">'f'</span>:
              <span class="enscript-keyword">if</span> (__vers_isdigit(string[1])) {
                  *string_p = &amp;string[1];
                  <span class="enscript-keyword">return</span> kOSKextVersionStageCandidate;
              } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (string[1] == <span class="enscript-string">'c'</span> &amp;&amp; __vers_isdigit(string[2])) {
                  *string_p = &amp;string[2];
                  <span class="enscript-keyword">return</span> kOSKextVersionStageCandidate;
              } <span class="enscript-keyword">else</span> {
                  <span class="enscript-keyword">return</span> kOSKextVersionStageInvalid;
              }
              <span class="enscript-keyword">break</span>;
          <span class="enscript-reference">default</span>:
              <span class="enscript-keyword">return</span> kOSKextVersionStageInvalid;
              <span class="enscript-keyword">break</span>;
        }
    }

    <span class="enscript-keyword">return</span> kOSKextVersionStageInvalid;
}

<span class="enscript-comment">/*********************************************************************
*********************************************************************/</span>
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> * <span class="enscript-function-name">__OSKextVersionStringForStage</span>(OSKextVersionStage stage)
{
    <span class="enscript-keyword">switch</span> (stage) {
      <span class="enscript-keyword">case</span> <span class="enscript-reference">kOSKextVersionStageInvalid</span>:     <span class="enscript-keyword">return</span> NULL; <span class="enscript-keyword">break</span>;
      <span class="enscript-keyword">case</span> <span class="enscript-reference">kOSKextVersionStageDevelopment</span>: <span class="enscript-keyword">return</span> <span class="enscript-string">&quot;d&quot;</span>; <span class="enscript-keyword">break</span>;
      <span class="enscript-keyword">case</span> <span class="enscript-reference">kOSKextVersionStageAlpha</span>:       <span class="enscript-keyword">return</span> <span class="enscript-string">&quot;a&quot;</span>; <span class="enscript-keyword">break</span>;
      <span class="enscript-keyword">case</span> <span class="enscript-reference">kOSKextVersionStageBeta</span>:        <span class="enscript-keyword">return</span> <span class="enscript-string">&quot;b&quot;</span>; <span class="enscript-keyword">break</span>;
      <span class="enscript-keyword">case</span> <span class="enscript-reference">kOSKextVersionStageCandidate</span>:   <span class="enscript-keyword">return</span> <span class="enscript-string">&quot;f&quot;</span>; <span class="enscript-keyword">break</span>;
      <span class="enscript-keyword">case</span> <span class="enscript-reference">kOSKextVersionStageRelease</span>:     <span class="enscript-keyword">return</span> <span class="enscript-string">&quot;&quot;</span>; <span class="enscript-keyword">break</span>;
    }

    <span class="enscript-keyword">return</span> NULL;
}

<span class="enscript-comment">/*********************************************************************
*********************************************************************/</span>
OSKextVersion <span class="enscript-function-name">OSKextParseVersionString</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> * versionString)
{
    OSKextVersion   result             = -1;
    <span class="enscript-type">int</span>             vers_digit         = -1;
    <span class="enscript-type">int</span>             num_digits_scanned = 0;
    OSKextVersion   vers_major         = 0;
    OSKextVersion   vers_minor         = 0;
    OSKextVersion   vers_revision      = 0;
    OSKextVersion   vers_stage         = 0;
    OSKextVersion   vers_stage_level   = 0;
    <span class="enscript-type">const</span> <span class="enscript-type">char</span>    * current_char_p;

    <span class="enscript-keyword">if</span> (!versionString || *versionString == <span class="enscript-string">'\0'</span>) {
        <span class="enscript-keyword">return</span> -1;
    }

    current_char_p = (<span class="enscript-type">const</span> <span class="enscript-type">char</span> *)&amp;versionString[0];

   <span class="enscript-comment">/*****
    * Check for an initial digit of the major release number.
    */</span>
    vers_major = __vers_digit_for_char(*current_char_p);
    <span class="enscript-keyword">if</span> (vers_major &lt; 0) {
        <span class="enscript-keyword">return</span> -1;
    }

    current_char_p++;
    num_digits_scanned = 1;

   <span class="enscript-comment">/* Complete scan for major version number. Legal characters are
    * any digit, period, any buildstage letter.
    */</span>
    <span class="enscript-keyword">while</span> (num_digits_scanned &lt; VERS_MAJOR_DIGITS) {
        <span class="enscript-keyword">if</span> (__vers_isspace(*current_char_p) || *current_char_p == <span class="enscript-string">'\0'</span>) {
            vers_stage = kOSKextVersionStageRelease;
            <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
        } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (__vers_isdigit(*current_char_p)) {
            vers_digit = __vers_digit_for_char(*current_char_p);
            <span class="enscript-keyword">if</span> (vers_digit &lt; 0) {
                <span class="enscript-keyword">return</span> -1;
            }
            vers_major = (vers_major) * 10 + vers_digit;
            current_char_p++;
            num_digits_scanned++;
        } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (__VERS_isreleasestate(*current_char_p)) {
            <span class="enscript-keyword">goto</span> <span class="enscript-reference">release_state</span>;
        } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (*current_char_p == <span class="enscript-string">'.'</span>) {
            current_char_p++;
            <span class="enscript-keyword">goto</span> <span class="enscript-reference">minor_version</span>;
        } <span class="enscript-keyword">else</span> {
            <span class="enscript-keyword">return</span> -1;
        }
    }

   <span class="enscript-comment">/* Check for too many digits.
    */</span>
    <span class="enscript-keyword">if</span> (num_digits_scanned == VERS_MAJOR_DIGITS) {
         <span class="enscript-keyword">if</span> (*current_char_p == <span class="enscript-string">'.'</span>) {
            current_char_p++;
        } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (__vers_isdigit(*current_char_p)) {
            <span class="enscript-keyword">return</span> -1;
        }
    }

<span class="enscript-reference">minor_version</span>:

    num_digits_scanned = 0;

   <span class="enscript-comment">/* Scan for minor version number. Legal characters are
    * any digit, period, any buildstage letter.
    */</span>
    <span class="enscript-keyword">while</span> (num_digits_scanned &lt; VERS_MINOR_DIGITS) {
        <span class="enscript-keyword">if</span> (__vers_isspace(*current_char_p) || *current_char_p == <span class="enscript-string">'\0'</span>) {
            vers_stage = kOSKextVersionStageRelease;
            <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
        } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (__vers_isdigit(*current_char_p)) {
            vers_digit = __vers_digit_for_char(*current_char_p);
            <span class="enscript-keyword">if</span> (vers_digit &lt; 0) {
                <span class="enscript-keyword">return</span> -1;
            }
            vers_minor = (vers_minor) * 10 + vers_digit;
            current_char_p++;
            num_digits_scanned++;
        } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (__VERS_isreleasestate(*current_char_p)) {
            <span class="enscript-keyword">goto</span> <span class="enscript-reference">release_state</span>;
        } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (*current_char_p == <span class="enscript-string">'.'</span>) {
            current_char_p++;
            <span class="enscript-keyword">goto</span> <span class="enscript-reference">revision</span>;
        } <span class="enscript-keyword">else</span> {
            <span class="enscript-keyword">return</span> -1;
        }
    }

   <span class="enscript-comment">/* Check for too many digits.
    */</span>
    <span class="enscript-keyword">if</span> (num_digits_scanned == VERS_MINOR_DIGITS) {
         <span class="enscript-keyword">if</span> (*current_char_p == <span class="enscript-string">'.'</span>) {
            current_char_p++;
        } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (__vers_isdigit(*current_char_p)) {
            <span class="enscript-keyword">return</span> -1;
        }
    }

<span class="enscript-reference">revision</span>:

    num_digits_scanned = 0;

   <span class="enscript-comment">/* Scan for revision version number. Legal characters are
    * any digit, any buildstage letter (NOT PERIOD).
    */</span>
    <span class="enscript-keyword">while</span> (num_digits_scanned &lt; VERS_REVISION_DIGITS) {
        <span class="enscript-keyword">if</span> (__vers_isspace(*current_char_p) || *current_char_p == <span class="enscript-string">'\0'</span>) {
            vers_stage = kOSKextVersionStageRelease;
            <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
        } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (__vers_isdigit(*current_char_p)) {
            vers_digit = __vers_digit_for_char(*current_char_p);
            <span class="enscript-keyword">if</span> (vers_digit &lt; 0) {
                <span class="enscript-keyword">return</span> -1;
            }
            vers_revision = (vers_revision) * 10 + vers_digit;
            current_char_p++;
            num_digits_scanned++;
        } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (__VERS_isreleasestate(*current_char_p)) {
            <span class="enscript-keyword">goto</span> <span class="enscript-reference">release_state</span>;
        } <span class="enscript-keyword">else</span> {
            <span class="enscript-keyword">return</span> -1;
        }
    }

   <span class="enscript-comment">/* Check for too many digits.
    */</span>
    <span class="enscript-keyword">if</span> (num_digits_scanned == VERS_REVISION_DIGITS) {
         <span class="enscript-keyword">if</span> (*current_char_p == <span class="enscript-string">'.'</span>) {
            current_char_p++;
        } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (__vers_isdigit(*current_char_p)) {
            <span class="enscript-keyword">return</span> -1;
        }
    }

<span class="enscript-reference">release_state</span>:

   <span class="enscript-comment">/*****
    * Check for the release state.
    */</span>
    <span class="enscript-keyword">if</span> (__vers_isspace(*current_char_p) || *current_char_p == <span class="enscript-string">'\0'</span>) {
        vers_stage = kOSKextVersionStageRelease;
        <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
    } <span class="enscript-keyword">else</span> {
        vers_stage = __OSKextVersionStageForString(&amp;current_char_p);
        <span class="enscript-keyword">if</span> (vers_stage == kOSKextVersionStageInvalid) {
            <span class="enscript-keyword">return</span> -1;
        }
    }


<span class="enscript-comment">// stage level
</span>
    num_digits_scanned = 0;

   <span class="enscript-comment">/* Scan for stage level number. Legal characters are
    * any digit only.
    */</span>
    <span class="enscript-keyword">while</span> (num_digits_scanned &lt; VERS_STAGE_LEVEL_DIGITS) {
        <span class="enscript-keyword">if</span> (__vers_isspace(*current_char_p) || *current_char_p == <span class="enscript-string">'\0'</span>) {
            <span class="enscript-keyword">if</span> (num_digits_scanned) {
                <span class="enscript-keyword">goto</span> <span class="enscript-reference">finish</span>;
            } <span class="enscript-keyword">else</span> {
                <span class="enscript-keyword">return</span> -1;
            }
        } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (__vers_isdigit(*current_char_p)) {
            vers_digit = __vers_digit_for_char(*current_char_p);
            <span class="enscript-keyword">if</span> (vers_digit &lt; 0) {
                <span class="enscript-keyword">return</span> -1;
            }
            vers_stage_level = (vers_stage_level) * 10 + vers_digit;
            current_char_p++;
            num_digits_scanned++;
        } <span class="enscript-keyword">else</span> {
            <span class="enscript-keyword">return</span> -1;
        }
    }

   <span class="enscript-comment">/* Check for too many digits.
    */</span>
    <span class="enscript-keyword">if</span> ((num_digits_scanned == VERS_STAGE_LEVEL_DIGITS) &amp;&amp;
        ! (__vers_isspace(*current_char_p) || (*current_char_p == <span class="enscript-string">'\0'</span>))) {

        <span class="enscript-keyword">return</span> -1;
    }

    <span class="enscript-keyword">if</span> (vers_stage_level &gt; VERS_STAGE_LEVEL_MAX) {
        <span class="enscript-keyword">return</span> -1;
    }

<span class="enscript-reference">finish</span>:

    <span class="enscript-keyword">if</span> (vers_stage == kOSKextVersionStageCandidate &amp;&amp; vers_stage_level == 0) {
        <span class="enscript-keyword">return</span> -1;
    }

    result = (vers_major * VERS_MAJOR_MULT) +
             (vers_minor * VERS_MINOR_MULT) +
             (vers_revision * VERS_REVISION_MULT) +
             (vers_stage * VERS_STAGE_MULT) +
             vers_stage_level; 

    <span class="enscript-keyword">return</span> result;
}

<span class="enscript-comment">/*********************************************************************
* This function must be safe to call in panic context.
*********************************************************************/</span>
Boolean <span class="enscript-function-name">OSKextVersionGetString</span>(
    OSKextVersion   aVersion,
    <span class="enscript-type">char</span>          * buffer,
    uint32_t        bufferLength)
{
    <span class="enscript-type">int</span>             cpos = 0;
    OSKextVersion   vers_major = 0;
    OSKextVersion   vers_minor = 0;
    OSKextVersion   vers_revision = 0;
    OSKextVersion   vers_stage = 0;
    OSKextVersion   vers_stage_level = 0;
    <span class="enscript-type">const</span> <span class="enscript-type">char</span>    * stage_string = NULL;  <span class="enscript-comment">// don't free
</span>
   <span class="enscript-comment">/* No buffer or length less than longest possible vers string,
    * return 0.
    */</span>
    <span class="enscript-keyword">if</span> (!buffer || bufferLength &lt; kOSKextVersionMaxLength) {
        <span class="enscript-keyword">return</span> FALSE;
    }

    bzero(buffer, bufferLength * <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">char</span>));

    <span class="enscript-keyword">if</span> (aVersion &lt; 0) {
        strlcpy(buffer, <span class="enscript-string">&quot;(invalid)&quot;</span>, bufferLength);
        <span class="enscript-keyword">return</span> TRUE;
    }
    <span class="enscript-keyword">if</span> (aVersion == 0) {
        strlcpy(buffer, <span class="enscript-string">&quot;(missing)&quot;</span>, bufferLength);
        <span class="enscript-keyword">return</span> TRUE;
    }

    vers_major = aVersion / VERS_MAJOR_MULT;
    <span class="enscript-keyword">if</span> (vers_major &gt; VERS_MAJOR_MAX) {
        strlcpy(buffer, <span class="enscript-string">&quot;(invalid)&quot;</span>, bufferLength);
        <span class="enscript-keyword">return</span> TRUE;
    }

    vers_minor = aVersion - (vers_major * VERS_MAJOR_MULT);
    vers_minor /= VERS_MINOR_MULT;

    vers_revision = aVersion -
        ( (vers_major * VERS_MAJOR_MULT) + (vers_minor * VERS_MINOR_MULT) );
    vers_revision /= VERS_REVISION_MULT;

    vers_stage = aVersion -
        ( (vers_major * VERS_MAJOR_MULT) + (vers_minor * VERS_MINOR_MULT) +
          (vers_revision * VERS_REVISION_MULT));
    vers_stage /= VERS_STAGE_MULT;

    vers_stage_level = aVersion -
        ( (vers_major * VERS_MAJOR_MULT) + (vers_minor * VERS_MINOR_MULT) +
          (vers_revision * VERS_REVISION_MULT) + (vers_stage * VERS_STAGE_MULT));
    <span class="enscript-keyword">if</span> (vers_stage_level &gt; VERS_STAGE_LEVEL_MAX) {
        strlcpy(buffer, <span class="enscript-string">&quot;(invalid)&quot;</span>, bufferLength);
        <span class="enscript-keyword">return</span> TRUE;
    }

    cpos = snprintf(buffer, bufferLength, <span class="enscript-string">&quot;%u&quot;</span>, (uint32_t)vers_major);

   <span class="enscript-comment">/* Always include the minor version; it just looks weird without.
    */</span>
    buffer[cpos] = <span class="enscript-string">'.'</span>;
    cpos++;
    cpos += snprintf(buffer+cpos, bufferLength - cpos, <span class="enscript-string">&quot;%u&quot;</span>, (uint32_t)vers_minor);

   <span class="enscript-comment">/* The revision is displayed only if nonzero.
    */</span>
    <span class="enscript-keyword">if</span> (vers_revision) {
        buffer[cpos] = <span class="enscript-string">'.'</span>;
        cpos++;
        cpos += snprintf(buffer+cpos, bufferLength - cpos, <span class="enscript-string">&quot;%u&quot;</span>,
			(uint32_t)vers_revision);
    }

    stage_string = __OSKextVersionStringForStage(vers_stage);
    <span class="enscript-keyword">if</span> (!stage_string) {
        strlcpy(buffer, <span class="enscript-string">&quot;(invalid)&quot;</span>, bufferLength);
        <span class="enscript-keyword">return</span> TRUE;
    }
    <span class="enscript-keyword">if</span> (stage_string[0]) {
        strlcat(buffer, stage_string, bufferLength);
        cpos += strlen(stage_string);
    }

    <span class="enscript-keyword">if</span> (vers_stage &lt; kOSKextVersionStageRelease) {
        snprintf(buffer+cpos, bufferLength - cpos, <span class="enscript-string">&quot;%u&quot;</span>, (uint32_t)vers_stage_level);
    }

    <span class="enscript-keyword">return</span> TRUE;
}

<span class="enscript-comment">/*********************************************************************
*********************************************************************/</span>
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">KERNEL</span>
OSKextVersion <span class="enscript-function-name">OSKextParseVersionCFString</span>(CFStringRef versionString)
{
    OSKextVersion result = -1;
    <span class="enscript-type">char</span>         versBuffer[kOSKextVersionMaxLength];
    
    <span class="enscript-keyword">if</span> (CFStringGetCString(versionString, versBuffer,
        <span class="enscript-keyword">sizeof</span>(versBuffer), kCFStringEncodingASCII)) {

        result = OSKextParseVersionString(versBuffer);
    }
    <span class="enscript-keyword">return</span> result;
}
#<span class="enscript-reference">endif</span>
</pre>
<hr />
</body></html>