<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>newvers.pl</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">newvers.pl&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">#!/usr/bin/perl
</span><span class="enscript-comment">#
</span><span class="enscript-comment"># This tool is used to stamp kernel version information into files at kernel
</span><span class="enscript-comment"># build time.  Each argument provided on the command line is the path to a file
</span><span class="enscript-comment"># that needs to be updated with the current verison information.  The file
</span><span class="enscript-comment"># xnu/config/MasterVersion is read to determine the version number to use.
</span><span class="enscript-comment"># Each file is read, and all occurrences of the following strings are replaced
</span><span class="enscript-comment"># in-place like so:
</span><span class="enscript-comment">#   ###KERNEL_VERSION_LONG###               1.2.3b4
</span><span class="enscript-comment">#   ###KERNEL_VERSION_SHORT###              1.2.3
</span><span class="enscript-comment">#   ###KERNEL_VERSION_MAJOR###              1
</span><span class="enscript-comment">#   ###KERNEL_VERSION_MINOR###              2
</span><span class="enscript-comment">#   ###KERNEL_VERSION_VARIANT###            3b4
</span><span class="enscript-comment">#   ###KERNEL_VERSION_REVISION###           3
</span><span class="enscript-comment">#   ###KERNEL_VERSION_STAGE###              VERSION_STAGE_BETA	(see libkern/version.h)
</span><span class="enscript-comment">#   ###KERNEL_VERSION_PRERELEASE_LEVEL###   4
</span><span class="enscript-comment">#   ###KERNEL_BUILDER###                    root
</span><span class="enscript-comment">#   ###KERNEL_BUILD_OBJROOT###              xnu/xnu-690.obj~2/RELEASE_PPC
</span><span class="enscript-comment">#   ###KERNEL_BUILD_DATE###                 Sun Oct 24 05:33:28 PDT 2004
</span>
<span class="enscript-keyword">use</span> File::Basename;

<span class="enscript-keyword">use</span> strict;

<span class="enscript-keyword">sub</span> ReadFile {
  <span class="enscript-keyword">my</span> ($fileName) = @_;
  <span class="enscript-keyword">my</span> $data;
  <span class="enscript-keyword">local</span> $/ = <span class="enscript-keyword">undef</span>;   <span class="enscript-comment"># Read complete files
</span>
  <span class="enscript-keyword">if</span> (<span class="enscript-keyword">open</span>(IN, <span class="enscript-string">&quot;&lt;$fileName&quot;</span>)) {
    $data=&lt;IN&gt;;
    <span class="enscript-keyword">close</span> IN;
    <span class="enscript-keyword">return</span> $data;
  }
  <span class="enscript-keyword">die</span> <span class="enscript-string">&quot;newvers: Can't read file \&quot;$fileName\&quot;\n&quot;</span>;
}

<span class="enscript-keyword">sub</span> WriteFile {
  <span class="enscript-keyword">my</span> ($fileName, $data) = @_;

  <span class="enscript-keyword">open</span> (OUT, <span class="enscript-string">&quot;&gt;$fileName&quot;</span>) <span class="enscript-keyword">or</span> <span class="enscript-keyword">die</span> <span class="enscript-string">&quot;newvers: Can't write file \&quot;$fileName\&quot;\n&quot;</span>;
  <span class="enscript-keyword">print</span> OUT  $data;
  <span class="enscript-keyword">close</span>(OUT);
}

<span class="enscript-keyword">die</span>(<span class="enscript-string">&quot;SRCROOT not defined&quot;</span>) <span class="enscript-keyword">unless</span> <span class="enscript-keyword">defined</span>($ENV{<span class="enscript-string">'SRCROOT'</span>});
<span class="enscript-keyword">die</span>(<span class="enscript-string">&quot;OBJROOT not defined&quot;</span>) <span class="enscript-keyword">unless</span> <span class="enscript-keyword">defined</span>($ENV{<span class="enscript-string">'OBJROOT'</span>});

<span class="enscript-keyword">my</span> $versfile = <span class="enscript-string">&quot;MasterVersion&quot;</span>;
$versfile = <span class="enscript-string">&quot;$ENV{'SRCROOT'}/config/$versfile&quot;</span> <span class="enscript-keyword">if</span> ($ENV{<span class="enscript-string">'SRCROOT'</span>});
<span class="enscript-keyword">my</span> $BUILD_SRCROOT=$ENV{<span class="enscript-string">'SRCROOT'</span>};
$BUILD_SRCROOT =~ <span class="enscript-keyword">s</span>,/+$,,;
<span class="enscript-keyword">my</span> $BUILD_OBJROOT=$ENV{<span class="enscript-string">'OBJROOT'</span>};
$BUILD_OBJROOT =~ <span class="enscript-keyword">s</span>,/+$,,;
<span class="enscript-keyword">my</span> $BUILD_OBJPATH=$ENV{<span class="enscript-string">'TARGET'</span>} || $ENV{<span class="enscript-string">'OBJROOT'</span>};
$BUILD_OBJPATH =~ <span class="enscript-keyword">s</span>,/+$,,;
<span class="enscript-keyword">my</span> $BUILD_DATE = <span class="enscript-string">`date`</span>;
$BUILD_DATE =~ <span class="enscript-keyword">s</span>/[\n\t]//g;
<span class="enscript-keyword">my</span> $BUILDER=<span class="enscript-string">`whoami`</span>;
$BUILDER =~ <span class="enscript-keyword">s</span>/[\n\t]//g;
<span class="enscript-keyword">my</span> $RC_STRING = $ENV{<span class="enscript-string">'RC_ProjectNameAndSourceVersion'</span>} . <span class="enscript-string">&quot;~&quot;</span> . $ENV{<span class="enscript-string">'RC_ProjectBuildVersion'</span>} <span class="enscript-keyword">if</span> <span class="enscript-keyword">defined</span>($ENV{<span class="enscript-string">'RC_XBS'</span>});

<span class="enscript-comment"># Handle four scenarios:
</span><span class="enscript-comment"># SRCROOT=/tmp/xnu
</span><span class="enscript-comment"># OBJROOT=/tmp/xnu/BUILD/obj
</span><span class="enscript-comment"># OBJPATH=/tmp/xnu/BUILD/obj/RELEASE_X86_64
</span><span class="enscript-comment">#
</span><span class="enscript-comment"># SRCROOT=/SourceCache/xnu/xnu-2706
</span><span class="enscript-comment"># OBJROOT=/BinaryCache/xnu/xnu-2706~3/Objects
</span><span class="enscript-comment"># OBJPATH=/BinaryCache/xnu/xnu-2706~3/Objects/DEVELOPMENT_X86_64
</span><span class="enscript-comment"># RC_XBS=YES (XBS-16.3+)
</span><span class="enscript-comment"># RC_ProjectNameAndSourceVersion=xnu-2706
</span><span class="enscript-comment"># RC_ProjectBuildVersion=3
</span><span class="enscript-comment">#
</span><span class="enscript-comment"># SRCROOT=/SourceCache/xnu/xnu-2706
</span><span class="enscript-comment"># OBJROOT=/private/var/tmp/xnu/xnu-2706~2
</span><span class="enscript-comment"># OBJPATH=/private/var/tmp/xnu/xnu-2706~2/DEVELOPMENT_ARM_S5L8940X
</span><span class="enscript-comment"># RC_XBS=YES (&lt;XBS-16.3)
</span><span class="enscript-comment"># RC_ProjectNameAndSourceVersion=xnu-2706
</span><span class="enscript-comment"># RC_ProjectBuildVersion=2
</span><span class="enscript-comment">#
</span><span class="enscript-comment"># SRCROOT=/tmp/xnu-2800.0.1_xnu-svn.roots/Sources/xnu-2800.0.1
</span><span class="enscript-comment"># OBJROOT=/private/tmp/xnu-2800.0.1_xnu-svn.roots/BuildRecords/xnu-2800.0.1_install/Objects
</span><span class="enscript-comment"># OBJPATH=/private/tmp/xnu-2800.0.1_xnu-svn.roots/BuildRecords/xnu-2800.0.1_install/Objects/DEVELOPMENT_X86_64
</span><span class="enscript-comment"># RC_XBS=YES (buildit)
</span><span class="enscript-comment"># RC_BUILDIT=YES
</span><span class="enscript-comment"># RC_ProjectNameAndSourceVersion=xnu-2800.0.1
</span><span class="enscript-comment"># RC_ProjectBuildVersion=1
</span><span class="enscript-comment">#
</span><span class="enscript-comment">#
</span><span class="enscript-comment"># If SRCROOT is a strict prefix of OBJPATH, we
</span><span class="enscript-comment"># want to preserve the &quot;interesting&quot; part
</span><span class="enscript-comment"># starting with &quot;xnu&quot;. If it's not a prefix,
</span><span class="enscript-comment"># the basename of OBJROOT itself is &quot;interesting&quot;.
</span><span class="enscript-comment"># Newer versions of XBS just set this to &quot;Objects&quot;, so we
</span><span class="enscript-comment"># need to synthesize the directory name to be more interesting.
</span><span class="enscript-comment">#
</span>
<span class="enscript-keyword">if</span> ($BUILD_OBJPATH =~ <span class="enscript-keyword">m</span>,^$BUILD_SRCROOT/(.*)$,) {
    $BUILD_OBJROOT = basename($BUILD_SRCROOT) . <span class="enscript-string">&quot;/&quot;</span> . $1;
} <span class="enscript-keyword">elsif</span> ($BUILD_OBJPATH =~ <span class="enscript-keyword">m</span>,^$BUILD_OBJROOT/(.*)$,) {
    <span class="enscript-keyword">if</span> (<span class="enscript-keyword">defined</span>($RC_STRING)) {
	$BUILD_OBJROOT = $RC_STRING . <span class="enscript-string">&quot;/&quot;</span> . $1;
    } <span class="enscript-keyword">else</span> {
	$BUILD_OBJROOT = basename($BUILD_OBJROOT) . <span class="enscript-string">&quot;/&quot;</span> . $1;
    }
} <span class="enscript-keyword">else</span> {
    <span class="enscript-comment"># Use original OBJROOT
</span>}

<span class="enscript-keyword">my</span> $rawvers = &amp;ReadFile($versfile);
<span class="enscript-comment">#$rawvers =~ s/\s//g;
</span>($rawvers) = <span class="enscript-keyword">split</span> <span class="enscript-string">&quot;\n&quot;</span>, $rawvers;
<span class="enscript-keyword">my</span> ($VERSION_MAJOR, $VERSION_MINOR, $VERSION_VARIANT) = <span class="enscript-keyword">split</span> /\./, $rawvers;
<span class="enscript-keyword">die</span> <span class="enscript-string">&quot;newvers: Invalid MasterVersion \&quot;$rawvers\&quot;!!! &quot;</span> <span class="enscript-keyword">if</span> (!$VERSION_MAJOR);
$VERSION_MINOR = <span class="enscript-string">&quot;0&quot;</span> <span class="enscript-keyword">unless</span> ($VERSION_MINOR);
$VERSION_VARIANT = <span class="enscript-string">&quot;0&quot;</span> <span class="enscript-keyword">unless</span> ($VERSION_VARIANT);
$VERSION_VARIANT =~ <span class="enscript-keyword">tr</span>/A-Z/a-z/;
$VERSION_VARIANT =~ <span class="enscript-keyword">m</span>/(\d+)((?:d|a|b|r|fc)?)(\d*)/;
<span class="enscript-keyword">my</span> $VERSION_REVISION = $1;
<span class="enscript-keyword">my</span> $stage = $2;
<span class="enscript-keyword">my</span> $VERSION_PRERELEASE_LEVEL = $3;
$VERSION_REVISION =<span class="enscript-string">&quot;0&quot;</span> <span class="enscript-keyword">unless</span> ($VERSION_REVISION);
$stage = <span class="enscript-string">&quot;r&quot;</span> <span class="enscript-keyword">if</span> (!$stage || ($stage <span class="enscript-keyword">eq</span> <span class="enscript-string">&quot;fc&quot;</span>));
$VERSION_PRERELEASE_LEVEL = <span class="enscript-string">&quot;0&quot;</span> <span class="enscript-keyword">unless</span> ($VERSION_PRERELEASE_LEVEL);

<span class="enscript-keyword">my</span> $VERSION_STAGE;
$VERSION_STAGE = <span class="enscript-string">'VERSION_STAGE_DEV'</span>     <span class="enscript-keyword">if</span> ($stage <span class="enscript-keyword">eq</span> <span class="enscript-string">'d'</span>);
$VERSION_STAGE = <span class="enscript-string">'VERSION_STAGE_ALPHA'</span>   <span class="enscript-keyword">if</span> ($stage <span class="enscript-keyword">eq</span> <span class="enscript-string">'a'</span>);
$VERSION_STAGE = <span class="enscript-string">'VERSION_STAGE_BETA'</span>    <span class="enscript-keyword">if</span> ($stage <span class="enscript-keyword">eq</span> <span class="enscript-string">'b'</span>);
$VERSION_STAGE = <span class="enscript-string">'VERSION_STAGE_RELEASE'</span> <span class="enscript-keyword">if</span> ($stage <span class="enscript-keyword">eq</span> <span class="enscript-string">'r'</span>);

<span class="enscript-keyword">my</span> $VERSION_SHORT = <span class="enscript-string">&quot;$VERSION_MAJOR.$VERSION_MINOR.$VERSION_REVISION&quot;</span>;
<span class="enscript-keyword">my</span> $VERSION_LONG = $VERSION_SHORT;
$VERSION_LONG .= <span class="enscript-string">&quot;$stage$VERSION_PRERELEASE_LEVEL&quot;</span> <span class="enscript-keyword">if</span> (($stage <span class="enscript-keyword">ne</span> <span class="enscript-string">&quot;r&quot;</span>) || ($VERSION_PRERELEASE_LEVEL != 0));

<span class="enscript-keyword">my</span> $file;
<span class="enscript-keyword">foreach</span> $file (@ARGV) {
  <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;newvers.pl: Stamping version \&quot;$VERSION_LONG\&quot; into \&quot;$file\&quot; ...&quot;</span>;
  <span class="enscript-keyword">my</span> $data = &amp;ReadFile($file);
  <span class="enscript-keyword">my</span> $count=0;
  $count += $data =~ <span class="enscript-keyword">s</span>/<span class="enscript-comment">###KERNEL_VERSION_LONG###/$VERSION_LONG/g;
</span>  $count += $data =~ <span class="enscript-keyword">s</span>/<span class="enscript-comment">###KERNEL_VERSION_SHORT###/$VERSION_SHORT/g;
</span>  $count += $data =~ <span class="enscript-keyword">s</span>/<span class="enscript-comment">###KERNEL_VERSION_MAJOR###/$VERSION_MAJOR/g;
</span>  $count += $data =~ <span class="enscript-keyword">s</span>/<span class="enscript-comment">###KERNEL_VERSION_MINOR###/$VERSION_MINOR/g;
</span>  $count += $data =~ <span class="enscript-keyword">s</span>/<span class="enscript-comment">###KERNEL_VERSION_VARIANT###/$VERSION_VARIANT/g;
</span>  $count += $data =~ <span class="enscript-keyword">s</span>/<span class="enscript-comment">###KERNEL_VERSION_REVISION###/$VERSION_REVISION/g;
</span>  $count += $data =~ <span class="enscript-keyword">s</span>/<span class="enscript-comment">###KERNEL_VERSION_STAGE###/$VERSION_STAGE/g;
</span>  $count += $data =~ <span class="enscript-keyword">s</span>/<span class="enscript-comment">###KERNEL_VERSION_PRERELEASE_LEVEL###/$VERSION_PRERELEASE_LEVEL/g;
</span>  $count += $data =~ <span class="enscript-keyword">s</span>/<span class="enscript-comment">###KERNEL_BUILDER###/$BUILDER/g;
</span>  $count += $data =~ <span class="enscript-keyword">s</span>/<span class="enscript-comment">###KERNEL_BUILD_OBJROOT###/$BUILD_OBJROOT/g;
</span>  $count += $data =~ <span class="enscript-keyword">s</span>/<span class="enscript-comment">###KERNEL_BUILD_DATE###/$BUILD_DATE/g;
</span>  <span class="enscript-keyword">print</span> <span class="enscript-string">&quot; $count replacements\n&quot;</span>;
  &amp;WriteFile($file, $data);
}

<span class="enscript-keyword">if</span> (0==<span class="enscript-keyword">scalar</span> @ARGV) {
  <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;newvers.pl: read version \&quot;$rawvers\&quot; from \&quot;$versfile\&quot;\n&quot;</span>;
  <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;newvers.pl: ###KERNEL_VERSION_LONG### = $VERSION_LONG\n&quot;</span>;
  <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;newvers.pl: ###KERNEL_VERSION_SHORT### = $VERSION_SHORT\n&quot;</span>;
  <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;newvers.pl: ###KERNEL_VERSION_MAJOR### = $VERSION_MAJOR\n&quot;</span>;
  <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;newvers.pl: ###KERNEL_VERSION_MINOR### = $VERSION_MINOR\n&quot;</span>;
  <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;newvers.pl: ###KERNEL_VERSION_VARIANT### = $VERSION_VARIANT\n&quot;</span>;
  <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;newvers.pl: ###KERNEL_VERSION_REVISION### = $VERSION_REVISION\n&quot;</span>;
  <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;newvers.pl: ###KERNEL_VERSION_STAGE### = $VERSION_STAGE\n&quot;</span>;
  <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;newvers.pl: ###KERNEL_VERSION_PRERELEASE_LEVEL### = $VERSION_PRERELEASE_LEVEL\n&quot;</span>;
  <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;newvers.pl: ###KERNEL_BUILDER### = $BUILDER\n&quot;</span>;
  <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;newvers.pl: ###KERNEL_BUILD_OBJROOT### = $BUILD_OBJROOT\n&quot;</span>;
  <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;newvers.pl: ###KERNEL_BUILD_DATE### = $BUILD_DATE\n&quot;</span>;
}
</pre>
<hr />
</body></html>