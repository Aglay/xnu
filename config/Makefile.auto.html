<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Makefile</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">Makefile&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
export MakeInc_cmd=${<span class="enscript-reference">SRCROOT</span>}/makedefs/MakeInc.cmd
export MakeInc_def=${<span class="enscript-reference">SRCROOT</span>}/makedefs/MakeInc.def
export MakeInc_rule=${<span class="enscript-reference">SRCROOT</span>}/makedefs/MakeInc.rule
export MakeInc_dir=${<span class="enscript-reference">SRCROOT</span>}/makedefs/MakeInc.dir

include $(<span class="enscript-reference">MakeInc_cmd</span>)
include $(<span class="enscript-reference">MakeInc_def</span>)

MD_SUPPORTED_KPI_FILENAME = SupportedKPIs-${<span class="enscript-reference">CURRENT_ARCH_CONFIG_LC</span>}.txt
MI_SUPPORTED_KPI_FILENAME = SupportedKPIs-all-archs.txt

INSTALL_KEXT_DIR = $(<span class="enscript-reference">DSTROOT</span>)$(<span class="enscript-reference">INSTALL_EXTENSIONS_DIR</span>)

KEXT_PLIST_LIST = \
	System.kext/Info.plist \
	System.kext/PlugIns/AppleNMI.kext/Info.plist \
	System.kext/PlugIns/ApplePlatformFamily.kext/Info.plist \
	System.kext/PlugIns/IONVRAMFamily.kext/Info.plist \
	System.kext/PlugIns/IOSystemManagement.kext/Info.plist

SYMBOL_COMPONENT_LIST =	\
        BSDKernel	\
        IOKit		\
        Libkern		\
        Mach		\
        MACFramework	\
        Unsupported	\
        Private

<span class="enscript-comment"># In general you want it to be possible to have a CPU sub-type's symbol exports
</span><span class="enscript-comment"># alias to the parent type's exports. This is a special-case way to handle it
</span><span class="enscript-comment"># for now:
</span>ifeq ($(<span class="enscript-reference">CURRENT_ARCH_CONFIG_LC</span>),x86_64h)
EXPORT_SOURCE_ARCH_CONFIG_LC = x86_64
else
EXPORT_SOURCE_ARCH_CONFIG_LC = $(<span class="enscript-reference">CURRENT_ARCH_CONFIG_LC</span>)
endif

KEXT_MACHO_LIST = $(<span class="enscript-reference">foreach symbolset,$(filter-out Dummy,$(SYMBOL_COMPONENT_LIST)),System.kext/PlugIns/$(symbolset).kext/$(symbolset)</span>)
KEXT_PLIST_LIST += $(<span class="enscript-reference">foreach symbolset,$(filter-out Dummy,$(SYMBOL_COMPONENT_LIST)),System.kext/PlugIns/$(symbolset).kext/Info.plist</span>)

SYMROOT_INSTALL_KEXT_MACHO_FILES = $(<span class="enscript-reference">addprefix $(SYMROOT)/,$(KEXT_MACHO_LIST)</span>)
DSTROOT_INSTALL_KEXT_MACHO_FILES = $(<span class="enscript-reference">addprefix $(INSTALL_KEXT_DIR)/,$(KEXT_MACHO_LIST)</span>)

SYMROOT_INSTALL_KEXT_PLISTS = $(<span class="enscript-reference">addprefix $(SYMROOT)/,$(KEXT_PLIST_LIST)</span>)
DSTROOT_INSTALL_KEXT_PLISTS = $(<span class="enscript-reference">addprefix $(INSTALL_KEXT_DIR)/,$(KEXT_PLIST_LIST)</span>)

EXPORTS_FILES = $(<span class="enscript-reference">foreach symbolset,$(SYMBOL_COMPONENT_LIST),$(symbolset).exports $(symbolset).$(EXPORT_SOURCE_ARCH_CONFIG_LC).exports</span>) Unused.exports

SYMBOL_SET_BUILD = $(<span class="enscript-reference">foreach symbolset, $(SYMBOL_COMPONENT_LIST), $(OBJPATH)/$(symbolset).symbolset</span>)

<span class="enscript-keyword">$(OBJPATH)/allsymbols:</span> $(<span class="enscript-reference">OBJPATH</span>)/$(<span class="enscript-reference">KERNEL_FILE_NAME</span>)
	$(<span class="enscript-reference">_v</span>)$(<span class="enscript-reference">NM</span>) -gj $&lt; &gt; $@

<span class="enscript-keyword">$(SYMBOL_SET_BUILD):</span> $(<span class="enscript-reference">OBJPATH</span>)/%.symbolset :  %.exports %.$(<span class="enscript-reference">EXPORT_SOURCE_ARCH_CONFIG_LC</span>).exports $(<span class="enscript-reference">OBJPATH</span>)/allsymbols $(<span class="enscript-reference">KEXT_CREATE_SYMBOL_SET</span>)
	@echo SYMBOLSET $* <span class="enscript-string">&quot;($(CURRENT_ARCH_CONFIG_LC))&quot;</span>
	$(<span class="enscript-reference">_v</span>)$(<span class="enscript-reference">KEXT_CREATE_SYMBOL_SET</span>)					\
		$(<span class="enscript-reference">ARCH_FLAGS_$(CURRENT_ARCH_CONFIG)</span>)			\
		-import $(<span class="enscript-reference">OBJPATH</span>)/allsymbols				\
		-export $(<span class="enscript-reference">SOURCE</span>)/$*.exports				\
		-export $(<span class="enscript-reference">SOURCE</span>)/$*.$(<span class="enscript-reference">EXPORT_SOURCE_ARCH_CONFIG_LC</span>).exports	\
		-output $@ $(<span class="enscript-reference">_vstdout</span>)

<span class="enscript-keyword">.PHONY:</span> check_all_exports

<span class="enscript-keyword">check_all_exports:</span> $(<span class="enscript-reference">OBJPATH</span>)/allsymbols $(<span class="enscript-reference">KEXT_CREATE_SYMBOL_SET</span>)
	$(<span class="enscript-reference">_v</span>)$(<span class="enscript-reference">KEXT_CREATE_SYMBOL_SET</span>)					\
		$(<span class="enscript-reference">ARCH_FLAGS_$(CURRENT_ARCH_CONFIG)</span>)			\
		-import $(<span class="enscript-reference">OBJPATH</span>)/allsymbols				\
		$(<span class="enscript-reference">foreach symbolset,$(filter-out Private,$(SYMBOL_COMPONENT_LIST)),	\
			-export $(SOURCE)/$(symbolset).exports		\
			-export $(SOURCE)/$(symbolset).$(EXPORT_SOURCE_ARCH_CONFIG_LC).exports</span>)	\
		-output /dev/null $(<span class="enscript-reference">_vstdout</span>)
	$(<span class="enscript-reference">_v</span>)$(<span class="enscript-reference">KEXT_CREATE_SYMBOL_SET</span>)					\
		$(<span class="enscript-reference">ARCH_FLAGS_$(CURRENT_ARCH_CONFIG)</span>)			\
		-import $(<span class="enscript-reference">OBJPATH</span>)/allsymbols				\
		$(<span class="enscript-reference">foreach symbolset,$(filter-out Unsupported,$(SYMBOL_COMPONENT_LIST)),	\
			-export $(SOURCE)/$(symbolset).exports		\
			-export $(SOURCE)/$(symbolset).$(EXPORT_SOURCE_ARCH_CONFIG_LC).exports</span>)	\
		-output /dev/null $(<span class="enscript-reference">_vstdout</span>)

<span class="enscript-keyword">$(OBJPATH)/$(MD_SUPPORTED_KPI_FILENAME):</span> $(<span class="enscript-reference">EXPORTS_FILES</span>)
	@echo SUPPORTED_KPI <span class="enscript-string">&quot;($(CURRENT_ARCH_CONFIG_LC))&quot;</span>
	$(<span class="enscript-reference">_v</span>)$(<span class="enscript-reference">SRCROOT</span>)/config/list_supported.sh $(<span class="enscript-reference">SOURCE</span>) $(<span class="enscript-reference">EXPORT_SOURCE_ARCH_CONFIG_LC</span>) $@

<span class="enscript-keyword">$(OBJPATH)/$(MI_SUPPORTED_KPI_FILENAME):</span> $(<span class="enscript-reference">EXPORTS_FILES</span>)
	@echo SUPPORTED_KPI <span class="enscript-string">&quot;(all)&quot;</span>
	$(<span class="enscript-reference">_v</span>)$(<span class="enscript-reference">SRCROOT</span>)/config/list_supported.sh $(<span class="enscript-reference">SOURCE</span>) all $@

<span class="enscript-keyword">build_symbol_sets:</span> check_all_exports $(<span class="enscript-reference">SYMBOL_SET_BUILD</span>) $(<span class="enscript-reference">OBJPATH</span>)/allsymbols \
			$(<span class="enscript-reference">OBJPATH</span>)/$(<span class="enscript-reference">MD_SUPPORTED_KPI_FILENAME</span>) \
			$(<span class="enscript-reference">OBJPATH</span>)/$(<span class="enscript-reference">MI_SUPPORTED_KPI_FILENAME</span>)

<span class="enscript-keyword">do_config_all::</span>	build_symbol_sets

<span class="enscript-comment"># There's no simple static pattern rule for these paths, so hardcode dependencies in the command list
</span><span class="enscript-keyword">$(SYMROOT_INSTALL_KEXT_MACHO_FILES):</span> ALWAYS
	$(<span class="enscript-reference">_v</span>)$(<span class="enscript-reference">MKDIR</span>) $(<span class="enscript-reference">dir $@</span>)
	$(<span class="enscript-reference">_v</span>)if [ $(<span class="enscript-reference">OBJROOT</span>)/.symbolset.timestamp -nt $@ ]; then		\
		echo INSTALLSYM symbolset $(<span class="enscript-reference">notdir $@</span>) <span class="enscript-string">&quot;($(CURRENT_ARCH_CONFIG_LC))&quot;</span>;	\
		$(<span class="enscript-reference">INSTALL</span>) $(<span class="enscript-reference">EXEC_INSTALL_FLAGS</span>) $(<span class="enscript-reference">OBJPATH</span>)/$(<span class="enscript-reference">@F</span>).symbolset $@;	\
		cmdstatus=$$?;							\
	else									\
		echo INSTALLSYM symbolset $(<span class="enscript-reference">notdir $@</span>) <span class="enscript-string">&quot;($(CURRENT_ARCH_CONFIG_LC))&quot;</span>;	\
		$(<span class="enscript-reference">LIPO</span>) -create $@ $(<span class="enscript-reference">OBJPATH</span>)/$(<span class="enscript-reference">@F</span>).symbolset -output $@ 2&gt;/dev/null || true;	\
		cmdstatus=$$?;							\
	fi;									\
	exit $$cmdstatus

<span class="enscript-keyword">$(SYMROOT_INSTALL_KEXT_PLISTS):</span> $(<span class="enscript-reference">SYMROOT</span>)/% : $(<span class="enscript-reference">SOURCE</span>)/%
	$(<span class="enscript-reference">_v</span>)$(<span class="enscript-reference">MKDIR</span>) $(<span class="enscript-reference">dir $@</span>)
	@echo INSTALLSYM kextplist $*
	$(<span class="enscript-reference">_v</span>)$(<span class="enscript-reference">INSTALL</span>) $(<span class="enscript-reference">DATA_INSTALL_FLAGS</span>) $&lt; $@
	$(<span class="enscript-reference">_v</span>)$(<span class="enscript-reference">NEWVERS</span>) $@ $(<span class="enscript-reference">_vstdout</span>)

<span class="enscript-keyword">$(DSTROOT_INSTALL_KEXT_PLISTS):</span> $(<span class="enscript-reference">INSTALL_KEXT_DIR</span>)/% : $(<span class="enscript-reference">SYMROOT</span>)/%
	$(<span class="enscript-reference">_v</span>)$(<span class="enscript-reference">MKDIR</span>) $(<span class="enscript-reference">dir $@</span>)
	@echo INSTALL kextplist $*
	$(<span class="enscript-reference">_v</span>)$(<span class="enscript-reference">INSTALL</span>) $(<span class="enscript-reference">DATA_INSTALL_FLAGS</span>) $&lt; $@

<span class="enscript-keyword">$(DSTROOT_INSTALL_KEXT_MACHO_FILES):</span> $(<span class="enscript-reference">INSTALL_KEXT_DIR</span>)/% : $(<span class="enscript-reference">SYMROOT</span>)/% ALWAYS
	$(<span class="enscript-reference">_v</span>)$(<span class="enscript-reference">MKDIR</span>) $(<span class="enscript-reference">dir $@</span>)
	@echo INSTALL $(<span class="enscript-reference">notdir $@</span>) <span class="enscript-string">&quot;($(CURRENT_ARCH_CONFIG_LC))&quot;</span>
	$(<span class="enscript-reference">_v</span>)$(<span class="enscript-reference">INSTALL</span>) $(<span class="enscript-reference">EXEC_INSTALL_FLAGS</span>) $&lt; $@

$(<span class="enscript-reference">DSTROOT</span>)/$(<span class="enscript-reference">KRESDIR</span>)/$(<span class="enscript-reference">MD_SUPPORTED_KPI_FILENAME</span>) $(<span class="enscript-reference">DSTROOT</span>)/$(<span class="enscript-reference">KRESDIR</span>)/$(<span class="enscript-reference">MI_SUPPORTED_KPI_FILENAME</span>): $(<span class="enscript-reference">DSTROOT</span>)/$(<span class="enscript-reference">KRESDIR</span>)/% : $(<span class="enscript-reference">OBJPATH</span>)/%
	$(<span class="enscript-reference">_v</span>)$(<span class="enscript-reference">MKDIR</span>) $(<span class="enscript-reference">dir $@</span>)
	@echo INSTALL $*
	$(<span class="enscript-reference">_v</span>)$(<span class="enscript-reference">INSTALL</span>) $(<span class="enscript-reference">INSTALL_FLAGS</span>) $&lt; $@

<span class="enscript-keyword">do_config_install::</span>	$(<span class="enscript-reference">SYMROOT_INSTALL_KEXT_MACHO_FILES</span>) \
				$(<span class="enscript-reference">SYMROOT_INSTALL_KEXT_PLISTS</span>) \
				$(<span class="enscript-reference">DSTROOT_INSTALL_KEXT_MACHO_FILES</span>) \
				$(<span class="enscript-reference">DSTROOT_INSTALL_KEXT_PLISTS</span>) \
				$(<span class="enscript-reference">DSTROOT</span>)/$(<span class="enscript-reference">KRESDIR</span>)/$(<span class="enscript-reference">MD_SUPPORTED_KPI_FILENAME</span>) \
				$(<span class="enscript-reference">DSTROOT</span>)/$(<span class="enscript-reference">KRESDIR</span>)/$(<span class="enscript-reference">MI_SUPPORTED_KPI_FILENAME</span>)

<span class="enscript-keyword">$(OBJPATH)/all-kpi.exp:</span> $(<span class="enscript-reference">EXPORTS_FILES</span>)
	$(<span class="enscript-reference">_v</span>)$(<span class="enscript-reference">SOURCE</span>)/generate_linker_exports.sh $@ $+

<span class="enscript-keyword">do_build_all::</span> $(<span class="enscript-reference">OBJPATH</span>)/all-kpi.exp

include $(<span class="enscript-reference">MakeInc_rule</span>)
include $(<span class="enscript-reference">MakeInc_dir</span>)
</pre>
<hr />
</body></html>