<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>IOPlatformExpert.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">IOPlatformExpert.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 1998-2000 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*
 * Copyright (c) 1998 Apple Computer, Inc.  All rights reserved. 
 *
 * HISTORY
 *
 */</span>


#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_IOKIT_IOPLATFORMEXPERT_H</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_IOKIT_IOPLATFORMEXPERT_H</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">__cplusplus</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOLib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOService.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOInterrupts.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOInterruptController.h&gt;</span>

<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> {
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/OSTypes.h&gt;</span>

<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">PEGetMachineName</span>( <span class="enscript-type">char</span> * name, <span class="enscript-type">int</span> maxLength );
<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">PEGetModelName</span>( <span class="enscript-type">char</span> * name, <span class="enscript-type">int</span> maxLength );
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">PEGetPlatformEpoch</span>( <span class="enscript-type">void</span> );

<span class="enscript-type">enum</span> {
  kPEHaltCPU,
  kPERestartCPU,
  kPEHangCPU,
  kPEUPSDelayHaltCPU,
  kPEPanicRestartCPU,
  kPEPanicSync,
  kPEPagingOff
};
<span class="enscript-type">extern</span> <span class="enscript-function-name">int</span> (*PE_halt_restart)(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> type);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">PEHaltRestart</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> type);

<span class="enscript-comment">// Save the Panic Info.  Returns the number of bytes saved.
</span><span class="enscript-type">extern</span> UInt32 <span class="enscript-function-name">PESavePanicInfo</span>(UInt8 *buffer, UInt32 length);

<span class="enscript-type">extern</span> <span class="enscript-type">long</span> <span class="enscript-function-name">PEGetGMTTimeOfDay</span>( <span class="enscript-type">void</span> );
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">PESetGMTTimeOfDay</span>( <span class="enscript-type">long</span> secs );
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">PEGetUTCTimeOfDay</span>( clock_sec_t * secs, clock_usec_t * usecs );
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">PESetUTCTimeOfDay</span>( clock_sec_t secs, clock_usec_t usecs );

<span class="enscript-comment">/* unless it's a &quot;well-known&quot; property, these will read/write out the value as raw data */</span>

<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">PEWriteNVRAMBooleanProperty</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *symbol, boolean_t value);
<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">PEWriteNVRAMProperty</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *symbol, <span class="enscript-type">const</span> <span class="enscript-type">void</span> *value, <span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> len);

<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">PEReadNVRAMProperty</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *symbol, <span class="enscript-type">void</span> *value, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> *len);

<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">PERemoveNVRAMProperty</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *symbol);

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">__cplusplus</span>
} <span class="enscript-comment">/* extern &quot;C&quot; */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIOPlatformMapperPresentKey</span> <span class="enscript-string">&quot;IOPlatformMapperPresent&quot;</span>


<span class="enscript-type">extern</span> OSSymbol *               gPlatformInterruptControllerName;

<span class="enscript-type">extern</span> <span class="enscript-type">const</span> OSSymbol *		gIOPlatformSleepActionKey;
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> OSSymbol *		gIOPlatformWakeActionKey;
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> OSSymbol *		gIOPlatformQuiesceActionKey;
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> OSSymbol *		gIOPlatformActiveActionKey;
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> OSSymbol *		gIOPlatformHaltRestartActionKey;
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> OSSymbol *		gIOPlatformPanicActionKey;

class IORangeAllocator;
class IONVRAMController;
class IOPMrootDomain;

class IOPlatformExpert : public IOService
{
    OSDeclareDefaultStructors(IOPlatformExpert);

<span class="enscript-reference">private</span>:
    <span class="enscript-type">long</span> _peBootROMType;
    <span class="enscript-type">long</span> _peChipSetType;
    <span class="enscript-type">long</span> _peMachineType;

<span class="enscript-reference">protected</span>:
    IOPMrootDomain * root;
    <span class="enscript-type">int</span> _pePMFeatures;
    <span class="enscript-type">int</span> _pePrivPMFeatures;
    <span class="enscript-type">int</span> _peNumBatteriesSupported;
    OSArray  * thePowerTree;

    bool       searchingForAdditionalParents;
    OSNumber * multipleParentKeyValue;
    <span class="enscript-type">int</span>        numInstancesRegistered;

    <span class="enscript-type">struct</span> ExpansionData { };
    ExpansionData *reserved;

    virtual <span class="enscript-type">void</span> setBootROMType(<span class="enscript-type">long</span> peBootROMType);
    virtual <span class="enscript-type">void</span> setChipSetType(<span class="enscript-type">long</span> peChipSetType);
    virtual <span class="enscript-type">void</span> setMachineType(<span class="enscript-type">long</span> peMachineType);

    virtual bool CheckSubTree (OSArray * inSubTree, IOService * theNub, IOService * theDevice, OSDictionary * theParent);
    virtual bool RegisterServiceInTree (IOService * theService, OSDictionary * theTreeNode, OSDictionary * theTreeParentNode, IOService * theProvider);

    virtual <span class="enscript-type">void</span> PMInstantiatePowerDomains ( <span class="enscript-type">void</span> );

<span class="enscript-reference">public</span>:
    virtual bool attach( IOService * provider ) APPLE_KEXT_OVERRIDE;
    virtual bool start( IOService * provider ) APPLE_KEXT_OVERRIDE;
    virtual bool configure( IOService * provider );
    virtual IOService * createNub( OSDictionary * from );

    virtual bool compareNubName( <span class="enscript-type">const</span> IOService * nub, OSString * name,
				 OSString ** matched = 0 ) <span class="enscript-type">const</span>;
    virtual IOReturn getNubResources( IOService * nub );

    virtual <span class="enscript-type">long</span> getBootROMType(<span class="enscript-type">void</span>);
    virtual <span class="enscript-type">long</span> getChipSetType(<span class="enscript-type">void</span>);
    virtual <span class="enscript-type">long</span> getMachineType(<span class="enscript-type">void</span>);

    virtual bool getModelName( <span class="enscript-type">char</span> * name, <span class="enscript-type">int</span> maxLength );
    virtual bool getMachineName( <span class="enscript-type">char</span> * name, <span class="enscript-type">int</span> maxLength );

    virtual <span class="enscript-type">int</span> haltRestart(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> type);
    virtual <span class="enscript-type">void</span> sleepKernel(<span class="enscript-type">void</span>);

    virtual <span class="enscript-type">long</span> getGMTTimeOfDay( <span class="enscript-type">void</span> );
    virtual <span class="enscript-type">void</span> setGMTTimeOfDay( <span class="enscript-type">long</span> secs );

    virtual IOReturn getConsoleInfo( PE_Video * consoleInfo );
    virtual IOReturn setConsoleInfo( PE_Video * consoleInfo, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> op );

    virtual <span class="enscript-type">void</span> registerNVRAMController( IONVRAMController * nvram );

    virtual IOReturn registerInterruptController(OSSymbol *name, IOInterruptController *interruptController);
    virtual IOInterruptController *lookUpInterruptController(OSSymbol *name);
    virtual <span class="enscript-type">void</span> setCPUInterruptProperties(IOService *service);
    virtual bool atInterruptLevel(<span class="enscript-type">void</span>);

    virtual IOReturn callPlatformFunction(<span class="enscript-type">const</span> OSSymbol *functionName,
					  bool waitForFunction,
					  <span class="enscript-type">void</span> *param1, <span class="enscript-type">void</span> *param2,
					  <span class="enscript-type">void</span> *param3, <span class="enscript-type">void</span> *param4) APPLE_KEXT_OVERRIDE;

    virtual IORangeAllocator * getPhysicalRangeAllocator(<span class="enscript-type">void</span>);

    virtual bool platformAdjustService(IOService *service);

    virtual <span class="enscript-type">void</span> PMRegisterDevice(IOService * theNub, IOService * theDevice);
    virtual <span class="enscript-type">void</span> PMLog ( <span class="enscript-type">const</span> <span class="enscript-type">char</span> *,<span class="enscript-type">unsigned</span> <span class="enscript-type">long</span>, <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span>, <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> );

    virtual bool hasPMFeature (<span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> featureMask);
    virtual bool hasPrivPMFeature (<span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> privFeatureMask);
    virtual <span class="enscript-type">int</span>  numBatteriesSupported (<span class="enscript-type">void</span>);

    virtual IOByteCount savePanicInfo(UInt8 *buffer, IOByteCount length);

    virtual OSString* createSystemSerialNumberString(OSData* myProperty);

    virtual IOReturn deregisterInterruptController(OSSymbol *name);

    virtual <span class="enscript-type">void</span> getUTCTimeOfDay( clock_sec_t * secs, clock_nsec_t * nsecs );
    virtual <span class="enscript-type">void</span> setUTCTimeOfDay( clock_sec_t secs, clock_nsec_t nsecs );

    OSMetaClassDeclareReservedUsed(IOPlatformExpert,  0);
    OSMetaClassDeclareReservedUsed(IOPlatformExpert,  1);
    OSMetaClassDeclareReservedUsed(IOPlatformExpert,  2);
    OSMetaClassDeclareReservedUsed(IOPlatformExpert,  3);
    OSMetaClassDeclareReservedUsed(IOPlatformExpert,  4);
    OSMetaClassDeclareReservedUnused(IOPlatformExpert,  5);
    OSMetaClassDeclareReservedUnused(IOPlatformExpert,  6);
    OSMetaClassDeclareReservedUnused(IOPlatformExpert,  7);
    OSMetaClassDeclareReservedUnused(IOPlatformExpert,  8);
    OSMetaClassDeclareReservedUnused(IOPlatformExpert,  9);
    OSMetaClassDeclareReservedUnused(IOPlatformExpert, 10);
    OSMetaClassDeclareReservedUnused(IOPlatformExpert, 11);
};

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

class IODTNVRAM;

class IODTPlatformExpert : public IOPlatformExpert
{
    OSDeclareAbstractStructors(IODTPlatformExpert);

<span class="enscript-reference">private</span>:
    IODTNVRAM *dtNVRAM;

    <span class="enscript-type">struct</span> ExpansionData { };
    ExpansionData *reserved;

<span class="enscript-reference">public</span>:
    virtual IOService * probe(	IOService * 	provider,
				SInt32 	  *	score ) APPLE_KEXT_OVERRIDE;
    virtual bool configure( IOService * provider ) APPLE_KEXT_OVERRIDE;

    virtual <span class="enscript-type">void</span> processTopLevel( IORegistryEntry * root );
    virtual <span class="enscript-type">const</span> <span class="enscript-type">char</span> * deleteList( <span class="enscript-type">void</span> ) = 0;
    virtual <span class="enscript-type">const</span> <span class="enscript-type">char</span> * excludeList( <span class="enscript-type">void</span> ) = 0;
    virtual IOService * createNub( IORegistryEntry * from );
    virtual bool createNubs( IOService * parent, OSIterator * iter );

    virtual bool compareNubName( <span class="enscript-type">const</span> IOService * nub, OSString * name,
				 OSString ** matched = 0 ) <span class="enscript-type">const</span> APPLE_KEXT_OVERRIDE;

    virtual IOReturn getNubResources( IOService * nub ) APPLE_KEXT_OVERRIDE;

    virtual bool getModelName( <span class="enscript-type">char</span> * name, <span class="enscript-type">int</span> maxLength ) APPLE_KEXT_OVERRIDE;
    virtual bool getMachineName( <span class="enscript-type">char</span> * name, <span class="enscript-type">int</span> maxLength ) APPLE_KEXT_OVERRIDE;
    
    virtual <span class="enscript-type">void</span> registerNVRAMController( IONVRAMController * nvram ) APPLE_KEXT_OVERRIDE;

    virtual <span class="enscript-type">int</span> haltRestart(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> type) APPLE_KEXT_OVERRIDE;

    <span class="enscript-comment">/* virtual */</span> IOReturn readXPRAM(IOByteCount offset, UInt8 * buffer,
				     IOByteCount length);

    <span class="enscript-comment">/* virtual */</span> IOReturn writeXPRAM(IOByteCount offset, UInt8 * buffer,
				      IOByteCount length);

    virtual IOReturn readNVRAMProperty(
	IORegistryEntry * entry,
	<span class="enscript-type">const</span> OSSymbol ** name, OSData ** value );

    virtual IOReturn writeNVRAMProperty(
	IORegistryEntry * entry,
	<span class="enscript-type">const</span> OSSymbol * name, OSData * value );

    <span class="enscript-comment">// This returns a dictionary describing all the NVRAM partitions.
</span>    <span class="enscript-comment">// The keys will be the partitionIDs of the form &quot;0x52,nvram&quot;.
</span>    <span class="enscript-comment">// The values will be OSNumbers of the partition's byte count.
</span>    <span class="enscript-comment">/* virtual */</span> OSDictionary *getNVRAMPartitions(<span class="enscript-type">void</span>);

    <span class="enscript-comment">/* virtual */</span> IOReturn readNVRAMPartition(<span class="enscript-type">const</span> OSSymbol * partitionID,
					      IOByteCount offset, UInt8 * buffer,
					      IOByteCount length);

    <span class="enscript-comment">/* virtual */</span> IOReturn writeNVRAMPartition(<span class="enscript-type">const</span> OSSymbol * partitionID,
					       IOByteCount offset, UInt8 * buffer,
					       IOByteCount length);

    virtual IOByteCount savePanicInfo(UInt8 *buffer, IOByteCount length) APPLE_KEXT_OVERRIDE;
    virtual OSString* createSystemSerialNumberString(OSData* myProperty) APPLE_KEXT_OVERRIDE;

    OSMetaClassDeclareReservedUnused(IODTPlatformExpert,  0);
    OSMetaClassDeclareReservedUnused(IODTPlatformExpert,  1);
    OSMetaClassDeclareReservedUnused(IODTPlatformExpert,  2);
    OSMetaClassDeclareReservedUnused(IODTPlatformExpert,  3);
    OSMetaClassDeclareReservedUnused(IODTPlatformExpert,  4);
    OSMetaClassDeclareReservedUnused(IODTPlatformExpert,  5);
    OSMetaClassDeclareReservedUnused(IODTPlatformExpert,  6);
    OSMetaClassDeclareReservedUnused(IODTPlatformExpert,  7);
};

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

<span class="enscript-comment">/* generic root nub of service tree */</span>

class IOPlatformExpertDevice : public IOService
{
    OSDeclareDefaultStructors(IOPlatformExpertDevice)

<span class="enscript-reference">private</span>:
    IOWorkLoop *workLoop;

    <span class="enscript-type">struct</span> ExpansionData { };
    ExpansionData *reserved;

<span class="enscript-reference">public</span>:
    virtual bool initWithArgs( <span class="enscript-type">void</span> * p1, <span class="enscript-type">void</span> * p2,
					<span class="enscript-type">void</span> * p3, <span class="enscript-type">void</span> *p4 );
    virtual bool compareName( OSString * name, OSString ** matched = 0 ) <span class="enscript-type">const</span> APPLE_KEXT_OVERRIDE;

    virtual IOWorkLoop *getWorkLoop() <span class="enscript-type">const</span> APPLE_KEXT_OVERRIDE;
    virtual IOReturn setProperties( OSObject * properties ) APPLE_KEXT_OVERRIDE;

    virtual <span class="enscript-type">void</span> free() APPLE_KEXT_OVERRIDE;

    virtual IOReturn newUserClient( task_t owningTask, <span class="enscript-type">void</span> * securityID,
                                    UInt32 type,  OSDictionary * properties,
                                    IOUserClient ** handler) APPLE_KEXT_OVERRIDE;


    OSMetaClassDeclareReservedUnused(IOPlatformExpertDevice,  0);
    OSMetaClassDeclareReservedUnused(IOPlatformExpertDevice,  1);
    OSMetaClassDeclareReservedUnused(IOPlatformExpertDevice,  2);
    OSMetaClassDeclareReservedUnused(IOPlatformExpertDevice,  3);
};

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

<span class="enscript-comment">/* generic nub for motherboard devices */</span>

class IOPlatformDevice : public IOService
{
    OSDeclareDefaultStructors(IOPlatformDevice)

    <span class="enscript-type">struct</span> ExpansionData { };
    ExpansionData *reserved;

<span class="enscript-reference">public</span>:
    virtual bool compareName( OSString * name, OSString ** matched = 0 ) <span class="enscript-type">const</span> APPLE_KEXT_OVERRIDE;
    virtual IOService * matchLocation( IOService * client ) APPLE_KEXT_OVERRIDE;
    virtual IOReturn getResources( <span class="enscript-type">void</span> ) APPLE_KEXT_OVERRIDE;

    OSMetaClassDeclareReservedUnused(IOPlatformDevice,  0);
    OSMetaClassDeclareReservedUnused(IOPlatformDevice,  1);
    OSMetaClassDeclareReservedUnused(IOPlatformDevice,  2);
    OSMetaClassDeclareReservedUnused(IOPlatformDevice,  3);
};

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* __cplusplus */</span>

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* ! _IOKIT_IOPLATFORMEXPERT_H */</span>
</pre>
<hr />
</body></html>