<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>IOPMPowerSource.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">IOPMPowerSource.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 1998-2005 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
 
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_IOPMPowerSource_h_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_IOPMPowerSource_h_</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSObject.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/pwr_mgt/IOPM.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOTypes.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOReturn.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOService.h&gt;</span>

<span class="enscript-type">enum</span> {
    kSecondsPerHour = 3600,
    kTenMinutesInSeconds = 600
};

<span class="enscript-comment">/*! @class IOPMPowerSource
 *
 * See IOKit/pwr_mgt/IOPM.h for power source keys relevant to this class. These
 * report-type keys are required for calls to IOPMPowerSource::setReportables(),
 * and they define the IORegistry interface through which data is passed back
 * up to the rest of the system.
 *
 * A subclassing driver that doesn't want to do anything fancy should:
 *   1. Subclass IOPMPowerSource
 *   2. Install its own battery change notifications or polling routine that can
 *          converse with actual battery hardware.
 *   3. When battery state changes, change the relevant member variables
 *          through setCurrentCapacity() style accessors.
 *   4. Call updateStatus() on itself when all such settings have been updated.
 *   
 * The subclass driver should also initially populate its settings and call
 * updateStatus() on launch.
 *
 *
 * Settings:
 *
 * &lt;pre&gt;
 * ExternalConnected
 * Type: bool
 * IORegistry Key: kIOPMPSExternalConnectedKey
 * True if computer is drawing external power 
 *
 * ExternalChargeCapable
 * Type: bool
 * IORegistry Key: kIOPMPSExternalChargeCapableKey
 * True if external power is capable of charging internal battery
 *
 * BatteryInstalled
 * Type: bool
 * IORegistry Key: kIOPMPSBatteryInstalledKey
 * True if a battery is present; false if removed
 *
 * IsCharging
 * Type: bool
 * IORegistry Key: kIOPMPSIsChargingKey
 * True if battery is charging itself from external power
 *
 * AtWarnLevel
 * Type: bool
 * IORegistry Key: kIOPMPSAtWarnLevelKey
 * True if draining battery capacity and past warn level
 *
 * AtCriticalLevel
 * Type: bool
 * IORegistry Key: kIOPMPSAtCriticalLevelKey
 * True if draining battery capacity and past critical level
 *
 * CurrentCapacity
 * MaxCapacity
 * Type: unsigned int
 * IORegistry Key: kIOPMPSCurrentCapacityKey, kIOPMPSMaxCapacityKey
 * Capacity measured in mAh
 *
 * TimeRemaining
 * Type: int
 * IORegistry Key: kIOPMPSTimeRemainingKey
 * Time remaining measured in minutes
 *
 * Amperage
 * Type: int
 * IORegistry Key: kIOPMPSAmperageKey
 * Current is measured in mA
 *
 * Voltage
 * Type: unsigned int
 * IORegistry Key: kIOPMPSVoltageKey
 * Voltage measured in mV
 *
 * CycleCount
 * Type: unsigned int
 * IORegistry Key: kIOPMPSCycleCountKey
 * Number of charge/discharge cycles
 *
 * AdapterInfo
 * Type: int
 * IORegistry Key: kIOPMPSAdapterInfoKey
 * Power adapter information
 *
 * Location
 * Type: int
 * IORegistry Key: kIOPMPSLocationKey
 * Clue about battery's location in machine - Left vs. Right
 *
 * ErrorCondition
 * Type: OSSymbol
 * IORegistry Key: kIOPMPSErrorConditionKey
 * String describing error state of battery
 *
 * Manufacturer
 * Type: OSSymbol
 * IORegistry Key: kIOPMPSManufacturerKey
 * String describing battery manufacturer
 *
 * Manufactured Date
 * Type: unsigned 16-bit bitfield
 * IORegistry Key: kIOPMPSManufactureDateKey
 * Date is published in a bitfield per the Smart Battery Data spec rev 1.1 
 * in section 5.1.26
 *   Bits 0...4 =&gt; day (value 1-31; 5 bits)
 *   Bits 5...8 =&gt; month (value 1-12; 4 bits)
 *   Bits 9...15 =&gt; years since 1980 (value 0-127; 7 bits)
 *
 * Model
 * Type: OSSymbol
 * IORegistry Key: kIOPMPSModelKey
 * String describing model number
 *
 * Serial
 * Type: OSSymbol
 * IORegistry Key: kIOPMPSSerialKey
 * String describing serial number or unique info
 * The serial number published hear bears no correspondence to the Apple serial
 * number printed on each battery. This is a manufacturer serial number with 
 * no correlation to the printed serial number.
 *
 * LegacyIOBatteryInfo
 * Type: OSDictionary
 * IORegistry Key: kIOPMPSLegacyBatteryInfoKey
 * Dictionary conforming to the OS X 10.0-10.4 
 * &lt;/pre&gt;
 */</span>

class IOPMPowerSource : public IOService
{
    OSDeclareDefaultStructors(IOPMPowerSource)

    friend class IOPMPowerSourceList;

 <span class="enscript-reference">protected</span>:

<span class="enscript-comment">/*! @var settingsChangedSinceLastUpdate
 * Used by subclasses to determine if any settings have been modified via the
 * accessors below since last call to update(). true is settings have changed;
 * false otherwise.
 */</span>
    bool settingsChangedSinceUpdate;
    
<span class="enscript-comment">/*! @var properties
 * Stores power source state
 */</span>
    OSDictionary            *properties;

    <span class="enscript-type">const</span> OSSymbol *externalConnectedKey;
    <span class="enscript-type">const</span> OSSymbol *externalChargeCapableKey;
    <span class="enscript-type">const</span> OSSymbol *batteryInstalledKey;
    <span class="enscript-type">const</span> OSSymbol *chargingKey;
    <span class="enscript-type">const</span> OSSymbol *warnLevelKey;
    <span class="enscript-type">const</span> OSSymbol *criticalLevelKey;
    <span class="enscript-type">const</span> OSSymbol *currentCapacityKey;
    <span class="enscript-type">const</span> OSSymbol *maxCapacityKey;
    <span class="enscript-type">const</span> OSSymbol *timeRemainingKey;
    <span class="enscript-type">const</span> OSSymbol *amperageKey;
    <span class="enscript-type">const</span> OSSymbol *voltageKey;
    <span class="enscript-type">const</span> OSSymbol *cycleCountKey;
    <span class="enscript-type">const</span> OSSymbol *adapterInfoKey;
    <span class="enscript-type">const</span> OSSymbol *locationKey;
    <span class="enscript-type">const</span> OSSymbol *errorConditionKey;
    <span class="enscript-type">const</span> OSSymbol *manufacturerKey;
    <span class="enscript-type">const</span> OSSymbol *modelKey;
    <span class="enscript-type">const</span> OSSymbol *serialKey;
    <span class="enscript-type">const</span> OSSymbol *batteryInfoKey;

    <span class="enscript-comment">// Tracking for IOPMPowerSourceList
</span>    IOPMPowerSource         *nextInList;

 <span class="enscript-reference">public</span>:

<span class="enscript-comment">/*! @function powerSource
    @abstract Creates a new IOPMPowerSource nub. Must be attached to IORegistry,
        and registered by provider.
*/</span>
    <span class="enscript-type">static</span> IOPMPowerSource *powerSource(<span class="enscript-type">void</span>);

    virtual bool init(<span class="enscript-type">void</span>) APPLE_KEXT_OVERRIDE;
    
    virtual <span class="enscript-type">void</span> free(<span class="enscript-type">void</span>) APPLE_KEXT_OVERRIDE;

<span class="enscript-comment">/*! @function updateStatus
    @abstract Must be called by physical battery controller when battery state
                has changed significantly.
    @discussion The system will not poll this object for battery updates. Rather \
    the battery's controller must call updateStatus() every time state changes \
    and the settings will be relayed to higher levels of power management. \
    The subclassing driver should override this only if the driver needs to add \
    new settings to the base class.
*/</span>
    virtual <span class="enscript-type">void</span> updateStatus(<span class="enscript-type">void</span>);

<span class="enscript-comment">/* Public accessors for battery state
 */</span>
    bool externalConnected(<span class="enscript-type">void</span>);
    bool externalChargeCapable(<span class="enscript-type">void</span>);
    bool batteryInstalled(<span class="enscript-type">void</span>);
    bool isCharging(<span class="enscript-type">void</span>);
    bool atWarnLevel(<span class="enscript-type">void</span>);
    bool atCriticalLevel(<span class="enscript-type">void</span>);

    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> currentCapacity(<span class="enscript-type">void</span>);
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> maxCapacity(<span class="enscript-type">void</span>);
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> capacityPercentRemaining(<span class="enscript-type">void</span>);
    <span class="enscript-type">int</span> timeRemaining(<span class="enscript-type">void</span>);
    <span class="enscript-type">int</span> amperage(<span class="enscript-type">void</span>);
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> voltage(<span class="enscript-type">void</span>);
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> cycleCount(<span class="enscript-type">void</span>);
    <span class="enscript-type">int</span> adapterInfo(<span class="enscript-type">void</span>);
    <span class="enscript-type">int</span> location(<span class="enscript-type">void</span>);
    
    OSSymbol *errorCondition(<span class="enscript-type">void</span>);
    OSSymbol *manufacturer(<span class="enscript-type">void</span>);
    OSSymbol *model(<span class="enscript-type">void</span>);
    OSSymbol *serial(<span class="enscript-type">void</span>);
    OSDictionary *legacyIOBatteryInfo(<span class="enscript-type">void</span>);
    
    OSObject *getPSProperty(<span class="enscript-type">const</span> OSSymbol *);
    
<span class="enscript-reference">protected</span>:

<span class="enscript-comment">/* Protected &quot;setter&quot; methods for subclasses
 * Subclasses should use these setters to modify all battery properties.
 * 
 * Subclasses must follow all property changes with a call to updateStatus() 
 * to flush settings changes to upper level battery API clients.
 *
 */</span>
    <span class="enscript-type">void</span> setExternalConnected(bool);
    <span class="enscript-type">void</span> setExternalChargeCapable(bool);
    <span class="enscript-type">void</span> setBatteryInstalled(bool);
    <span class="enscript-type">void</span> setIsCharging(bool);
    <span class="enscript-type">void</span> setAtWarnLevel(bool);
    <span class="enscript-type">void</span> setAtCriticalLevel(bool);

    <span class="enscript-type">void</span> setCurrentCapacity(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>);
    <span class="enscript-type">void</span> setMaxCapacity(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>);    
    <span class="enscript-type">void</span> setTimeRemaining(<span class="enscript-type">int</span>);
    <span class="enscript-type">void</span> setAmperage(<span class="enscript-type">int</span>);    
    <span class="enscript-type">void</span> setVoltage(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>);
    <span class="enscript-type">void</span> setCycleCount(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>);
    <span class="enscript-type">void</span> setAdapterInfo(<span class="enscript-type">int</span>);
    <span class="enscript-type">void</span> setLocation(<span class="enscript-type">int</span>);

    <span class="enscript-type">void</span> setErrorCondition(OSSymbol *);
    <span class="enscript-type">void</span> setManufacturer(OSSymbol *);
    <span class="enscript-type">void</span> setModel(OSSymbol *);
    <span class="enscript-type">void</span> setSerial(OSSymbol *);
    <span class="enscript-type">void</span> setLegacyIOBatteryInfo(OSDictionary *);

<span class="enscript-comment">/*! All of these methods funnel through the generic accessor method
   setPSProperty. Caller can pass in any arbitrary OSSymbol key, and
   that value will be stored in the PM settings dictionary, and relayed
   onto the IORegistry at update time.
 */</span>
    <span class="enscript-type">void</span> setPSProperty(<span class="enscript-type">const</span> OSSymbol *, OSObject *);
};

#<span class="enscript-reference">endif</span>
</pre>
<hr />
</body></html>