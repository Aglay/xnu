<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>IOEventSource.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">IOEventSource.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 1998-2000, 2009 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*
Copyright (c) 1998 Apple Computer, Inc.	 All rights reserved.
HISTORY
    1998-7-13	Godfrey van der Linden(gvdl)
	Created.
    1998-10-30	Godfrey van der Linden(gvdl)
	Converted to C++
*/</span>
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_IOKIT_IOEVENTSOURCE_H</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_IOKIT_IOEVENTSOURCE_H</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/cdefs.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSObject.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOLib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/system.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOWorkLoop.h&gt;</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">IOKITSTATS</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOStatisticsPrivate.h&gt;</span>
#<span class="enscript-reference">endif</span>

__BEGIN_DECLS
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/clock_types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/clock.h&gt;</span>
__END_DECLS

<span class="enscript-comment">/*!
    @class IOEventSource : public OSObject
    @abstract Abstract class for all work-loop event sources.
    @discussion The IOEventSource declares the abstract super class that all
event sources must inherit from if an IOWorkLoop is to receive events from them.
&lt;br&gt;&lt;br&gt;
	An event source can represent any event that should cause the work-loop of a
device to wake up and perform work.  Two examples of event sources are the
IOInterruptEventSource which delivers interrupt notifications and IOCommandGate
which delivers command requests.
&lt;br&gt;&lt;br&gt;
	A kernel module can always use the work-loop model for serialising access to
anything at all.  The IOEventSource is used for communicating events to the
work-loop, and the chain of event sources should be used to walk the possible
event sources and demultipex them.  Note a particular instance of an event
source may only be a member of 1 linked list chain.  If you need to move it
between chains than make sure it is removed from the original chain before
attempting to move it.
&lt;br&gt;&lt;br&gt;
	The IOEventSource makes no attempt to maintain the consistency of its internal data across multi-threading.  It is assumed that the user of these basic tools will protect the data that these objects represent in some sort of device wide instance lock.	For example the IOWorkLoop maintains the event chain by using an IOCommandGate and thus single threading access to its state.
&lt;br&gt;&lt;br&gt;
	All subclasses of IOEventSource that wish to perform work on the work-loop thread are expected to implement the checkForWork() member function. As of Mac OS X, 10.7 (Darwin 11), checkForWork is no longer pure virtual, and should not be overridden if there is no work to be done.

&lt;br&gt;&lt;br&gt;
	checkForWork() is the key method in this class.	 It is called by some work-loop when convienient and is expected to evaluate its internal state and determine if an event has occurred since the last call.  In the case of an event having occurred then the instance defined target(owner)/action will be called.	 The action is stored as an ordinary C function pointer but the first parameter is always the owner.  This means that a C++ member function can be used as an action function though this depends on the ABI.
&lt;br&gt;&lt;br&gt;
	Although the eventChainNext variable contains a reference to the next event source in the chain this reference is not retained.  The list 'owner' i.e. the client that creates the event, not the work-loop, is expected to retain the source.
*/</span>
class IOEventSource : public OSObject
{
    OSDeclareAbstractStructors(IOEventSource)
    friend class IOWorkLoop;
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">IOKITSTATS</span>
    friend class IOStatistics;
#<span class="enscript-reference">endif</span>

<span class="enscript-reference">public</span>:
<span class="enscript-comment">/*!
    @typedef Action
    @discussion Placeholder type for C++ function overloading discrimination.
As the all event sources require an action and it has to be stored somewhere
and be of some type, this is that type.
    @param owner
	Target of the function, can be used as a refcon.  The owner is set
during initialisation.	 Note if a C++ function was specified this parameter
is implicitly the first paramter in the target member function's parameter list.
*/</span>
    <span class="enscript-type">typedef</span> <span class="enscript-type">void</span> (*Action)(OSObject *owner, ...);

<span class="enscript-comment">/*! @defined IOEventSourceAction
    @discussion Backward compatibilty define for the old non-class scoped type definition.  See $link IOEventSource::Action */</span>
 #define IOEventSourceAction IOEventSource::Action

<span class="enscript-reference">protected</span>:
<span class="enscript-comment">/*! @var eventChainNext
	The next event source in the event chain. nil at end of chain. */</span>
    IOEventSource *eventChainNext;

<span class="enscript-comment">/*! @var owner The owner object called when an event has been delivered. */</span>
    OSObject *owner;

<span class="enscript-comment">/*! @var action
	The action method called when an event has been delivered */</span>
    Action action;

<span class="enscript-comment">/*! @var enabled
	Is this event source enabled to deliver requests to the work-loop. */</span>
    bool enabled;

<span class="enscript-comment">/*! @var workLoop What is the work-loop for this event source. */</span>
    IOWorkLoop *workLoop;

<span class="enscript-comment">/*! @var refcon What ever the client wants to do, see $link setRefcon. */</span>
    <span class="enscript-type">void</span> *refcon;

<span class="enscript-comment">/*! @struct ExpansionData
    @discussion This structure will be used to expand the capablilties of the IOEventSource in the future.
    */</span>    
    <span class="enscript-type">struct</span> ExpansionData {
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">IOKITSTATS</span>
	    <span class="enscript-type">struct</span> IOEventSourceCounter *counter;
#<span class="enscript-reference">else</span>
	    <span class="enscript-type">void</span> *iokitstatsReserved;
#<span class="enscript-reference">endif</span>
	};

<span class="enscript-comment">/*! @var reserved
    Reserved for future use.  (Internal use only)  */</span>
    ExpansionData *reserved;

<span class="enscript-comment">/*! @function init
    @abstract Primary initialiser for the IOEventSource class.
    @param owner
	Owner of this instance of an event source.  Used as the first parameter
of the action callout.	Owner will generally be an OSObject it doesn't have to
be as no member functions will be called directly in it.  It can just be a
refcon for a client routine.
    @param action
	Pointer to C call out function.	 Action is a pointer to a C function
that gets called when this event source has outstanding work.  It will usually
be called by the checkForWork member function.	The first parameter of the
action call out will always be the owner, this allows C++ member functions to
be used as actions.  Defaults to 0.
    @result true if the inherited classes and this instance initialise
successfully.
*/</span>
    virtual bool init(OSObject *owner, IOEventSource::Action action = 0);

    virtual <span class="enscript-type">void</span> free( <span class="enscript-type">void</span> ) APPLE_KEXT_OVERRIDE;

<span class="enscript-comment">/*! @function checkForWork
    @abstract Virtual member function used by IOWorkLoop for work
scheduling.
    @discussion This function will be called to request a subclass to check
its internal state for any work to do and then to call out the owner/action.
If this event source never performs any work (e.g. IOCommandGate), this
method should not be overridden. NOTE: This method is no longer declared pure
virtual. A default implementation is provided in IOEventSource.
    @result Return true if this function needs to be called again before all its outstanding events have been processed.
        */</span>
    virtual bool checkForWork();

<span class="enscript-comment">/*! @function setWorkLoop
    @abstract Set'ter for $link workLoop variable.
    @param workLoop
	Target work-loop of this event source instance.	 A subclass of
IOWorkLoop that at least reacts to signalWorkAvailable() and onThread functions. 
*/</span>
    virtual <span class="enscript-type">void</span> setWorkLoop(IOWorkLoop *workLoop);

<span class="enscript-comment">/*! @function setNext
    @abstract Set'ter for $link eventChainNext variable.
    @param next
	Pointer to another IOEventSource instance.
*/</span>
    virtual <span class="enscript-type">void</span> setNext(IOEventSource *next);

<span class="enscript-comment">/*! @function getNext
    @abstract Get'ter for $link eventChainNext variable.
    @result value of eventChainNext.
*/</span>
    virtual IOEventSource *getNext() <span class="enscript-type">const</span>;


<span class="enscript-reference">protected</span>:
    <span class="enscript-comment">// Methods to access the IOWorkLoop exported fields
</span>    <span class="enscript-type">void</span> signalWorkAvailable();
    <span class="enscript-type">void</span> openGate();
    <span class="enscript-type">void</span> closeGate();
    bool tryCloseGate();
    <span class="enscript-type">int</span> sleepGate(<span class="enscript-type">void</span> *event, UInt32 type);
	<span class="enscript-type">int</span> sleepGate(<span class="enscript-type">void</span> *event, AbsoluteTime deadline, UInt32 type);
    <span class="enscript-type">void</span> wakeupGate(<span class="enscript-type">void</span> *event, bool oneThread);

<span class="enscript-reference">public</span>:
<span class="enscript-comment">/*! @function setAction
    @abstract Set'ter for $link action variable.
    @param action Pointer to a C function of type IOEventSource::Action. */</span>
    virtual <span class="enscript-type">void</span> setAction(IOEventSource::Action action);

<span class="enscript-comment">/*! @function getAction
    @abstract Get'ter for $link action variable.
    @result value of action. */</span>
    virtual IOEventSource::Action getAction() <span class="enscript-type">const</span>;

<span class="enscript-comment">/*! @function enable
    @abstract Enable event source.
    @discussion A subclass implementation is expected to respect the enabled
state when checkForWork is called.  Calling this function will cause the
work-loop to be signalled so that a checkForWork is performed. */</span>
    virtual <span class="enscript-type">void</span> enable();

<span class="enscript-comment">/*! @function disable
    @abstract Disable event source.
    @discussion A subclass implementation is expected to respect the enabled
state when checkForWork is called. */</span>
    virtual <span class="enscript-type">void</span> disable();

<span class="enscript-comment">/*! @function isEnabled
    @abstract Get'ter for $link enable variable.
    @result true if enabled. */</span>
    virtual bool isEnabled() <span class="enscript-type">const</span>;

<span class="enscript-comment">/*! @function getWorkLoop
    @abstract Get'ter for $link workLoop variable.
    @result value of workLoop. */</span>
    virtual IOWorkLoop *getWorkLoop() <span class="enscript-type">const</span>;

<span class="enscript-comment">/*! @function onThread
    @abstract Convenience function for workLoop-&gt;onThread.
    @result true if called on the work-loop thread.
*/</span>
    virtual bool onThread() <span class="enscript-type">const</span>;

<span class="enscript-reference">private</span>:
    OSMetaClassDeclareReservedUnused(IOEventSource, 0);
    OSMetaClassDeclareReservedUnused(IOEventSource, 1);
    OSMetaClassDeclareReservedUnused(IOEventSource, 2);
    OSMetaClassDeclareReservedUnused(IOEventSource, 3);
    OSMetaClassDeclareReservedUnused(IOEventSource, 4);
    OSMetaClassDeclareReservedUnused(IOEventSource, 5);
    OSMetaClassDeclareReservedUnused(IOEventSource, 6);
    OSMetaClassDeclareReservedUnused(IOEventSource, 7);
};

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !_IOKIT_IOEVENTSOURCE_H */</span>
</pre>
<hr />
</body></html>