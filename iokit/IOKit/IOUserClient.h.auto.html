<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>IOUserClient.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">IOUserClient.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 1998-2000 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

<span class="enscript-comment">/*
 * Changes to this API are expected.
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_IOKIT_IOUSERCLIENT_H</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_IOKIT_IOUSERCLIENT_H</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOTypes.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOService.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/OSMessageNotification.h&gt;</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">IOKITSTATS</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOStatisticsPrivate.h&gt;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_IOUSERCLIENT_SENDASYNCRESULT64WITHOPTIONS_</span>		1

<span class="enscript-type">enum</span> {
    kIOUCTypeMask	= 0x0000000f,
    kIOUCScalarIScalarO = 0,
    kIOUCScalarIStructO = 2,
    kIOUCStructIStructO = 3,
    kIOUCScalarIStructI = 4,

    kIOUCForegroundOnly = 0x00000010,
};

<span class="enscript-comment">/*! @enum
    @abstract Constant to denote a variable length structure argument to IOUserClient.
    @constant kIOUCVariableStructureSize Use in the structures IOExternalMethod, IOExternalAsyncMethod, IOExternalMethodDispatch to specify the size of the structure is variable.
*/</span>
<span class="enscript-type">enum</span> {
    kIOUCVariableStructureSize = 0xffffffff
};


<span class="enscript-type">typedef</span> <span class="enscript-function-name">IOReturn</span> (IOService::*IOMethod)(<span class="enscript-type">void</span> * p1, <span class="enscript-type">void</span> * p2, <span class="enscript-type">void</span> * p3,
                                        <span class="enscript-type">void</span> * p4, <span class="enscript-type">void</span> * p5, <span class="enscript-type">void</span> * p6 );

<span class="enscript-type">typedef</span> <span class="enscript-function-name">IOReturn</span> (IOService::*IOAsyncMethod)(OSAsyncReference asyncRef,
                                        <span class="enscript-type">void</span> * p1, <span class="enscript-type">void</span> * p2, <span class="enscript-type">void</span> * p3,
                                        <span class="enscript-type">void</span> * p4, <span class="enscript-type">void</span> * p5, <span class="enscript-type">void</span> * p6 );

<span class="enscript-type">typedef</span> <span class="enscript-function-name">IOReturn</span> (IOService::*IOTrap)(<span class="enscript-type">void</span> * p1, <span class="enscript-type">void</span> * p2, <span class="enscript-type">void</span> * p3,
                                      <span class="enscript-type">void</span> * p4, <span class="enscript-type">void</span> * p5, <span class="enscript-type">void</span> * p6 );

<span class="enscript-type">struct</span> IOExternalMethod {
    IOService *		object;
    IOMethod		func;
    IOOptionBits	flags;
    IOByteCount		count0;
    IOByteCount		count1;
};

<span class="enscript-type">struct</span> IOExternalAsyncMethod {
    IOService *		object;
    IOAsyncMethod	func;
    IOOptionBits	flags;
    IOByteCount		count0;
    IOByteCount		count1;
};

<span class="enscript-type">struct</span> IOExternalTrap {
    IOService *		object;
    IOTrap		func;
};

<span class="enscript-type">enum</span> {
    kIOUserNotifyMaxMessageSize = 64
};

<span class="enscript-type">enum</span> {
    kIOUserNotifyOptionCanDrop = 0x1 <span class="enscript-comment">/* Fail if queue is full, rather than infinitely queuing. */</span>
};

<span class="enscript-comment">// keys for clientHasPrivilege
</span>#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIOClientPrivilegeAdministrator</span>	<span class="enscript-string">&quot;root&quot;</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIOClientPrivilegeLocalUser</span>	<span class="enscript-string">&quot;local&quot;</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIOClientPrivilegeForeground</span>	<span class="enscript-string">&quot;foreground&quot;</span>

<span class="enscript-comment">/*! @enum
    @abstract Constants to specify the maximum number of scalar arguments in the IOExternalMethodArguments structure. These constants are documentary since the scalarInputCount, scalarOutputCount fields reflect the actual number passed.
    @constant kIOExternalMethodScalarInputCountMax The maximum number of scalars able to passed on input.
    @constant kIOExternalMethodScalarOutputCountMax The maximum number of scalars able to passed on output.
*/</span>
<span class="enscript-type">enum</span> {
    kIOExternalMethodScalarInputCountMax  = 16,
    kIOExternalMethodScalarOutputCountMax = 16,
};


<span class="enscript-type">struct</span> IOExternalMethodArguments
{
    uint32_t		version;

    uint32_t		selector;

    mach_port_t           asyncWakePort;
    io_user_reference_t * asyncReference;
    uint32_t              asyncReferenceCount;

    <span class="enscript-type">const</span> uint64_t *    scalarInput;
    uint32_t		scalarInputCount;

    <span class="enscript-type">const</span> <span class="enscript-type">void</span> *	structureInput;
    uint32_t		structureInputSize;

    IOMemoryDescriptor * structureInputDescriptor;
   
    uint64_t *		scalarOutput;
    uint32_t		scalarOutputCount;

    <span class="enscript-type">void</span> *		structureOutput;
    uint32_t		structureOutputSize;

    IOMemoryDescriptor * structureOutputDescriptor;
    uint32_t		 structureOutputDescriptorSize;

    uint32_t		__reservedA;

    OSObject **         structureVariableOutputData;

    uint32_t		__reserved[30];
};

<span class="enscript-type">typedef</span> <span class="enscript-function-name">IOReturn</span> (*IOExternalMethodAction)(OSObject * target, <span class="enscript-type">void</span> * reference, 
					    IOExternalMethodArguments * arguments);
<span class="enscript-type">struct</span> IOExternalMethodDispatch
{
    IOExternalMethodAction function;
    uint32_t		   checkScalarInputCount;
    uint32_t		   checkStructureInputSize;
    uint32_t		   checkScalarOutputCount;
    uint32_t		   checkStructureOutputSize;
};

<span class="enscript-type">enum</span> {
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IO_EXTERNAL_METHOD_ARGUMENTS_CURRENT_VERSION</span>	2
    kIOExternalMethodArgumentsCurrentVersion = IO_EXTERNAL_METHOD_ARGUMENTS_CURRENT_VERSION
};


<span class="enscript-comment">/*!
    @class IOUserClient
    @abstract   Provides a basis for communication between client applications and I/O Kit objects.
*/</span>


class IOUserClient : public IOService
{
    OSDeclareAbstractStructors(IOUserClient)
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">IOKITSTATS</span>
    friend class IOStatistics;
#<span class="enscript-reference">endif</span>

<span class="enscript-reference">protected</span>:
<span class="enscript-comment">/*! @struct ExpansionData
    @discussion This structure will be used to expand the capablilties of this class in the future.
*/</span>    
    <span class="enscript-type">struct</span> ExpansionData {
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">IOKITSTATS</span>
	    IOUserClientCounter *counter;
#<span class="enscript-reference">else</span>
	    <span class="enscript-type">void</span> *iokitstatsReserved;
#<span class="enscript-reference">endif</span>
    };

<span class="enscript-comment">/*! @var reserved
    Reserved for future use.  (Internal use only) 
*/</span>
    ExpansionData * reserved;

    bool reserve();

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">XNU_KERNEL_PRIVATE</span>
<span class="enscript-reference">public</span>:
#<span class="enscript-reference">else</span>
<span class="enscript-reference">private</span>:
#<span class="enscript-reference">endif</span>
    OSSet * mappings;
    UInt8   sharedInstance;
    UInt8   __reservedA[3];
    <span class="enscript-type">void</span>  * __reserved[7];

<span class="enscript-reference">public</span>:
   virtual IOReturn externalMethod( uint32_t selector, IOExternalMethodArguments * arguments,
					IOExternalMethodDispatch * dispatch = 0, OSObject * target = 0, <span class="enscript-type">void</span> * reference = 0 );

   virtual IOReturn registerNotificationPort(
					mach_port_t port, UInt32 type, io_user_reference_t refCon);

<span class="enscript-reference">private</span>:
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">__LP64__</span>
    OSMetaClassDeclareReservedUnused(IOUserClient, 0);
    OSMetaClassDeclareReservedUnused(IOUserClient, 1);
#<span class="enscript-reference">else</span>
    OSMetaClassDeclareReservedUsed(IOUserClient, 0);
    OSMetaClassDeclareReservedUsed(IOUserClient, 1);
#<span class="enscript-reference">endif</span>
    OSMetaClassDeclareReservedUnused(IOUserClient, 2);
    OSMetaClassDeclareReservedUnused(IOUserClient, 3);
    OSMetaClassDeclareReservedUnused(IOUserClient, 4);
    OSMetaClassDeclareReservedUnused(IOUserClient, 5);
    OSMetaClassDeclareReservedUnused(IOUserClient, 6);
    OSMetaClassDeclareReservedUnused(IOUserClient, 7);
    OSMetaClassDeclareReservedUnused(IOUserClient, 8);
    OSMetaClassDeclareReservedUnused(IOUserClient, 9);
    OSMetaClassDeclareReservedUnused(IOUserClient, 10);
    OSMetaClassDeclareReservedUnused(IOUserClient, 11);
    OSMetaClassDeclareReservedUnused(IOUserClient, 12);
    OSMetaClassDeclareReservedUnused(IOUserClient, 13);
    OSMetaClassDeclareReservedUnused(IOUserClient, 14);
    OSMetaClassDeclareReservedUnused(IOUserClient, 15);

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">XNU_KERNEL_PRIVATE</span>
    <span class="enscript-comment">/* Available within xnu source only */</span>
<span class="enscript-reference">public</span>:
    <span class="enscript-type">static</span> <span class="enscript-type">void</span> initialize( <span class="enscript-type">void</span> );
    <span class="enscript-type">static</span> <span class="enscript-type">void</span> destroyUserReferences( OSObject * obj );
    IOMemoryMap * mapClientMemory64( IOOptionBits type,
                                    task_t task,
                                    IOOptionBits mapFlags = kIOMapAnywhere,
				    mach_vm_address_t atAddress = 0 );
#<span class="enscript-reference">endif</span>

<span class="enscript-reference">protected</span>:
    <span class="enscript-type">static</span> IOReturn sendAsyncResult(OSAsyncReference reference,
                                    IOReturn result, <span class="enscript-type">void</span> *args[], UInt32 numArgs);
    <span class="enscript-type">static</span> <span class="enscript-type">void</span> setAsyncReference(OSAsyncReference asyncRef,
                                  mach_port_t wakePort,
                                  <span class="enscript-type">void</span> *callback, <span class="enscript-type">void</span> *refcon);

    <span class="enscript-type">static</span> IOReturn sendAsyncResult64(OSAsyncReference64 reference,
                                        IOReturn result, io_user_reference_t args[], UInt32 numArgs);

    <span class="enscript-comment">/*! 
        @function sendAsyncResult64WithOptions
        @abstract Send a notification as with sendAsyncResult, but with finite queueing.
        @discussion IOUserClient::sendAsyncResult64() will infitely queue messages if the client
                is not processing them in a timely fashion.  This variant will not, for simple
                handling of situations where clients may be expected to stop processing messages.
     */</span>
    <span class="enscript-type">static</span> IOReturn sendAsyncResult64WithOptions(OSAsyncReference64 reference,
                                        IOReturn result, io_user_reference_t args[], UInt32 numArgs, 
					IOOptionBits options);

    <span class="enscript-type">static</span> <span class="enscript-type">void</span> setAsyncReference64(OSAsyncReference64 asyncRef,
					mach_port_t wakePort,
					mach_vm_address_t callback, io_user_reference_t refcon);

    <span class="enscript-type">static</span> <span class="enscript-type">void</span> setAsyncReference64(OSAsyncReference64 asyncRef,
					mach_port_t wakePort,
					mach_vm_address_t callback, io_user_reference_t refcon,
                    task_t task);

<span class="enscript-reference">public</span>:

    <span class="enscript-type">static</span> IOReturn clientHasAuthorization( task_t task,
                                            IOService * service );

    <span class="enscript-type">static</span> IOReturn clientHasPrivilege( <span class="enscript-type">void</span> * securityToken,
                                        <span class="enscript-type">const</span> <span class="enscript-type">char</span> * privilegeName );

    <span class="enscript-type">static</span> OSObject * copyClientEntitlement( task_t task,
                                             <span class="enscript-type">const</span> <span class="enscript-type">char</span> * entitlement );

    <span class="enscript-comment">/*!
        @function releaseAsyncReference64
	@abstract Release the mach_port_t reference held within the OSAsyncReference64 structure.
	@discussion The OSAsyncReference64 structure passed to async methods holds a reference to the wakeup mach port, which should be released to balance each async method call. Behavior is undefined if these calls are not correctly balanced.
        @param reference The reference passed to the subclass IOAsyncMethod, or externalMethod() in the IOExternalMethodArguments.asyncReference field.
        @result A return code.
    */</span>
    <span class="enscript-type">static</span> IOReturn releaseAsyncReference64(OSAsyncReference64 reference);
    <span class="enscript-comment">/*!
        @function releaseNotificationPort
	@abstract Release the mach_port_t passed to registerNotificationPort().
	@discussion The mach_port_t passed to the registerNotificationPort() methods should be released to balance each call to registerNotificationPort(). Behavior is undefined if these calls are not correctly balanced.
        @param reference The mach_port_t argument previously passed to the subclass implementation of registerNotificationPort().
        @result A return code.
    */</span>
    <span class="enscript-type">static</span> IOReturn releaseNotificationPort(mach_port_t port);

    virtual bool init() APPLE_KEXT_OVERRIDE;
    virtual bool init( OSDictionary * dictionary ) APPLE_KEXT_OVERRIDE;
    <span class="enscript-comment">// Currently ignores the all args, just passes up to IOService::init()
</span>    virtual bool initWithTask(
                    task_t owningTask, <span class="enscript-type">void</span> * securityToken, UInt32 type,
                    OSDictionary * properties);

    virtual bool initWithTask(
                    task_t owningTask, <span class="enscript-type">void</span> * securityToken, UInt32 type);

    virtual <span class="enscript-type">void</span> free() APPLE_KEXT_OVERRIDE;

    virtual IOReturn clientClose( <span class="enscript-type">void</span> );
    virtual IOReturn clientDied( <span class="enscript-type">void</span> );

    virtual IOService * getService( <span class="enscript-type">void</span> );

    virtual IOReturn registerNotificationPort(
		mach_port_t port, UInt32 type, UInt32 refCon );

    virtual IOReturn getNotificationSemaphore( UInt32 notification_type,
                                    semaphore_t * semaphore );

    virtual IOReturn connectClient( IOUserClient * client );

    <span class="enscript-comment">// memory will be released by user client when last map is destroyed
</span>    virtual IOReturn clientMemoryForType( UInt32 type,
			        IOOptionBits * options,
				IOMemoryDescriptor ** memory );

#<span class="enscript-reference">if</span> !<span class="enscript-variable-name">__LP64__</span>
<span class="enscript-reference">private</span>:
	APPLE_KEXT_COMPATIBILITY_VIRTUAL
	IOMemoryMap * mapClientMemory( IOOptionBits type,
                                    task_t task,
                                    IOOptionBits mapFlags = kIOMapAnywhere,
									IOVirtualAddress atAddress = 0 );
#<span class="enscript-reference">endif</span>

    <span class="enscript-type">static</span> IOReturn _sendAsyncResult64(OSAsyncReference64 reference,
                                    IOReturn result, io_user_reference_t args[], UInt32 numArgs, IOOptionBits options);
<span class="enscript-reference">public</span>:

    <span class="enscript-comment">/*!
        @function removeMappingForDescriptor
        Remove the first mapping created from the memory descriptor returned by clientMemoryForType() from IOUserClient's list of mappings. If such a mapping exists, it is retained and the reference currently held by IOUserClient is returned to the caller.
        @param memory The memory descriptor instance previously returned by the implementation of clientMemoryForType().
        @result A reference to the first IOMemoryMap instance found in the list of mappings created by IOUserClient from that passed memory descriptor is returned, or zero if none exist. The caller should release this reference.
    */</span>
    IOMemoryMap * removeMappingForDescriptor(IOMemoryDescriptor * memory);

    <span class="enscript-comment">/*!
        @function exportObjectToClient
        Make an arbitrary OSObject available to the client task.
        @param task The task.
        @param obj The object we want to export to the client.
        @param clientObj Returned value is the client's port name.
    */</span>
    virtual IOReturn exportObjectToClient(task_t task,
				OSObject *obj, io_object_t *clientObj);

    <span class="enscript-comment">// Old methods for accessing method vector backward compatiblility only
</span>    virtual IOExternalMethod *
        getExternalMethodForIndex( UInt32 index )
	APPLE_KEXT_DEPRECATED;
    virtual IOExternalAsyncMethod *
        getExternalAsyncMethodForIndex( UInt32 index )
	APPLE_KEXT_DEPRECATED;

    <span class="enscript-comment">// Methods for accessing method vector.
</span>    virtual IOExternalMethod *
        getTargetAndMethodForIndex( IOService ** targetP, UInt32 index );
    virtual IOExternalAsyncMethod *
        getAsyncTargetAndMethodForIndex( IOService ** targetP, UInt32 index );

    <span class="enscript-comment">// Methods for accessing trap vector - old and new style
</span>    virtual IOExternalTrap *
		getExternalTrapForIndex( UInt32 index )
	APPLE_KEXT_DEPRECATED;

    virtual IOExternalTrap *
      getTargetAndTrapForIndex( IOService **targetP, UInt32 index );
};

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* ! _IOKIT_IOUSERCLIENT_H */</span>

</pre>
<hr />
</body></html>