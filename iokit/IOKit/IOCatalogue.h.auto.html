<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>IOCatalogue.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">IOCatalogue.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 1998-2012 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*
 * Copyright (c) 1998 Apple Inc.  All rights reserved. 
 *
 * HISTORY
 *
 */</span>


#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_IOKIT_IOCATALOGUE_H</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_IOKIT_IOCATALOGUE_H</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSObject.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSCollectionIterator.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSArray.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSDictionary.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOLocks.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/cdefs.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOKitServer.h&gt;</span>

class IOService;

<span class="enscript-comment">/*!
    @class IOCatalogue
    @abstract In-kernel database for IOKit driver personalities.
    @discussion The IOCatalogue is a database which contains all IOKit driver personalities.  IOService uses this resource when matching devices to their associated drivers.
*/</span>
class IOCatalogue : public OSObject
{
    OSDeclareDefaultStructors(IOCatalogue)
    
<span class="enscript-reference">private</span>:
    IORWLock *               lock;
    SInt32                   generation;
    OSDictionary           * personalities;
    OSArray * arrayForPersonality(OSDictionary * dict);
    <span class="enscript-type">void</span> addPersonality(OSDictionary * dict);

<span class="enscript-reference">public</span>:
    <span class="enscript-comment">/*!
        @function initialize
        @abstract Creates and initializes the database object and poputates it with in-kernel driver personalities.
    */</span>
    <span class="enscript-type">static</span> <span class="enscript-type">void</span> initialize( <span class="enscript-type">void</span> );
    
    <span class="enscript-comment">/*!
        @function init
        @abstract Initializes the database object.
        @param initArray  The initial array of driver personalities to populate the database.
    */</span>
    bool init( OSArray * initArray );
    
    <span class="enscript-comment">/*!
        @function free
        @abstract Cleans up the database and deallocates memory allocated at initialization.  This is never called in normal operation of the system.
    */</span>
    <span class="enscript-type">void</span> free( <span class="enscript-type">void</span> ) APPLE_KEXT_OVERRIDE;
    
    <span class="enscript-comment">/*!
        @function findDrivers
        @abstract This is the primary entry point for IOService.
        @param service
        @param generationCount  Returns a reference to the generation count of the database. The generation count increases only when personalities are added to the database *and* IOService matching has been initiated.
        @result Returns an ordered set of driver personalities ranked on probe-scores.  The ordered set must be released by the receiver.
    */</span>
    OSOrderedSet * findDrivers( IOService * service, SInt32 * generationCount );
    
    <span class="enscript-comment">/*!
        @function findDrivers
        @abstract A more general purpose interface which allows one to retreive driver personalities based the intersection of the 'matching' dictionary and the personality's own property list.
        @param matching  A dictionary containing only keys and values which are to be used for matching. For example, a matching dictionary containing 'IOProviderClass'='IOPCIDevice' will return all personalities with an IOProviderClass key and a value of IOPCIDevice.
        @param generationCount  Returns a reference to the current generation of the database. The generation count increases only when personalities are added to the database *and* IOService matching has been initiated.
        @result Returns an ordered set of driver personalities ranked on probe-scores. The ordered set must be released by the receiver.
    */</span>
    OSOrderedSet * findDrivers( OSDictionary * matching, SInt32 * generationCount );
    
    <span class="enscript-comment">/*!
        @function addDrivers
        @abstract Adds an array of driver personalities to the database.
        @param array Array of driver personalities to be added to the database.
        @param doNubMatchng Start matching process after personalities have been added.
        @result Returns true if driver personality was added to the database successfully. Failure is due to a memory allocation failure.
    */</span>
    bool addDrivers( OSArray * array, bool doNubMatching = true );
    
    <span class="enscript-comment">/*!
        @function removeDrivers
        @abstract Remove driver personalities from the database based on matching information provided.
        @param matching  A dictionary whose keys and values are used for matching personalities in the database.  For example, a matching dictionary containing a 'IOProviderClass' key with the value 'IOPCIDevice' will remove all personalities which have the key 'IOProviderClass' equal to 'IOPCIDevice'.
        @param doNubMatchng Start matching process after personalities have been removed.  Matching criteria is based on IOProviderClass of those personalities which were removed.  This is to allow drivers which haven't been matched to match against NUB's which were blocked by the previous personalities. 
        @result Returns true if personality was removed successfully. Failure is due to a memory allocation failure.
    */</span>
    bool removeDrivers( OSDictionary * matching, bool doNubMatching = true );
    
    <span class="enscript-comment">/*!
        @function getGenerationCount
        @abstract Get the current generation count of the database.
    */</span>
    SInt32 getGenerationCount( <span class="enscript-type">void</span> ) <span class="enscript-type">const</span>;

    <span class="enscript-comment">/*!
        @function isModuleLoaded
        @abstract Reports if a kernel module has been loaded.
        @param moduleName  Name of the module.
        @result Returns true if the associated kernel module has been loaded into the kernel.
    */</span>
    bool isModuleLoaded( OSString * moduleName ) <span class="enscript-type">const</span>;

    <span class="enscript-comment">/*!
        @function isModuleLoaded
        @abstract Reports if a kernel module has been loaded.
        @param moduleName  Name of the module.
        @result Returns true if the associated kernel module has been loaded into the kernel.
    */</span>
    bool isModuleLoaded( <span class="enscript-type">const</span> <span class="enscript-type">char</span> * moduleName ) <span class="enscript-type">const</span>;
    
    <span class="enscript-comment">/*!
        @function isModuleLoaded
        @abstract Reports if a kernel module has been loaded for a particular personality.
        @param driver  A driver personality's property list.
        @result Returns true if the associated kernel module has been loaded into the kernel for a particular driver personality on which it depends.
    */</span>
    bool isModuleLoaded( OSDictionary * driver ) <span class="enscript-type">const</span>;
    
    <span class="enscript-comment">/*!
        @function moduleHasLoaded
        @abstract Callback function called after a IOKit dependent kernel module is loaded.
        @param name  Name of the kernel module.
    */</span>
    <span class="enscript-type">void</span> moduleHasLoaded( OSString * name );
    
    <span class="enscript-comment">/*!
        @function moduleHasLoaded
        @abstract Callback function called after a IOKit dependent kernel module is loaded.
        @param name  Name of the kernel module.
    */</span>
    <span class="enscript-type">void</span> moduleHasLoaded( <span class="enscript-type">const</span> <span class="enscript-type">char</span> * name );

    <span class="enscript-comment">/*!
        @function terminateDrivers
        @abstract Terminates all instances of a driver which match the contents of the matching dictionary. Does not unload module.
        @param matching  A dictionary whose keys and values are used for matching personalities in the database.  For example, a matching dictionary containing a 'IOProviderClass' key with the value 'IOPCIDevice' will cause termination for all instances whose personalities have the key 'IOProviderClass' equal to 'IOPCIDevice'.
     */</span>
    IOReturn terminateDrivers( OSDictionary * matching );

    <span class="enscript-comment">/*!
        @function terminateDriversForModule
        @abstract Terminates all instances of a driver which depends on a particular module and unloads the module.
        @param moduleName Name of the module which is used to determine which driver instances to terminate and unload.
        @param unload Flag to cause the actual unloading of the module.
     */</span>
    IOReturn terminateDriversForModule( OSString * moduleName, bool unload = true);

    <span class="enscript-comment">/*!
        @function terminateDriversForModule
        @abstract Terminates all instances of a driver which depends on a particular module and unloads the module.
        @param moduleName Name of the module which is used to determine which driver instances to terminate and unload.
        @param unload Flag to cause the actual unloading of the module.
     */</span>
    IOReturn terminateDriversForModule( <span class="enscript-type">const</span> <span class="enscript-type">char</span> * moduleName, bool unload = true);

    <span class="enscript-comment">/*!
        @function startMatching
        @abstract Starts an IOService matching thread where matching keys and values are provided by the matching dictionary.
        @param matching  A dictionary whose keys and values are used for matching personalities in the database.  For example, a matching dictionary containing a 'IOProviderClass' key with the value 'IOPCIDevice' will start matching for all personalities which have the key 'IOProviderClass' equal to 'IOPCIDevice'.
     */</span>
    bool startMatching( OSDictionary * matching );

    <span class="enscript-comment">/*!
        @function reset
        @abstract Return the Catalogue to its initial state.
        @discussion
        Should only be used by kextd just before it sends all kext personalities down during a rescan.
    */</span>
    <span class="enscript-type">void</span> reset(<span class="enscript-type">void</span>);

    <span class="enscript-comment">/*!
        @function resetAndAddDrivers
        @abstract Replace personalities in IOCatalog with those provided.
        @discussion
        Resets the catalogue with a new set of drivers, preserving matching originals to keep wired memory usage down.
    */</span>
    bool resetAndAddDrivers(OSArray * drivers, bool doNubMatching = true);

    <span class="enscript-comment">/*!
        @function serialize
        @abstract Serializes the catalog for transport to the user.
        @param s The serializer object.
        @result Returns false if unable to serialize database, most likely due to memory shortage.
     */</span>
    virtual bool serialize(OSSerialize * s) <span class="enscript-type">const</span> APPLE_KEXT_OVERRIDE;

    bool serializeData(IOOptionBits kind, OSSerialize * s) <span class="enscript-type">const</span>;

<span class="enscript-comment">/* This stuff is no longer used at all we keep it around for i386
 * binary compatibility only. Symbols are no longer exported.
 */</span>

<span class="enscript-reference">private</span>:

    <span class="enscript-comment">/*!
        @function unloadModule
        @abstract Unloads the reqested module if no driver instances are currently depending on it.
        @param moduleName An OSString containing the name of the module to unload.
     */</span>
    IOReturn unloadModule( OSString * moduleName ) <span class="enscript-type">const</span>;

    IOReturn _removeDrivers(OSDictionary * matching);
    IOReturn _terminateDrivers(OSDictionary * matching);
};

<span class="enscript-type">extern</span> <span class="enscript-type">const</span> OSSymbol * gIOClassKey;
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> OSSymbol * gIOProbeScoreKey;
<span class="enscript-type">extern</span> IOCatalogue    * gIOCatalogue;

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* ! _IOKIT_IOCATALOGUE_H */</span>
</pre>
<hr />
</body></html>