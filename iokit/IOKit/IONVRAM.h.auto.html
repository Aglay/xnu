<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>IONVRAM.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">IONVRAM.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 1998-2006 Apple Computer, Inc. All rights reserved.
 * Copyright (c) 2007-2012 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_IOKIT_IONVRAM_H</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_IOKIT_IONVRAM_H</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">__cplusplus</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOKitKeys.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOService.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IODeviceTreeSupport.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/nvram/IONVRAMController.h&gt;</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* __cplusplus */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIODTNVRAMOFPartitionName</span>       <span class="enscript-string">&quot;common&quot;</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIODTNVRAMXPRAMPartitionName</span>    <span class="enscript-string">&quot;APL,MacOS75&quot;</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIODTNVRAMPanicInfoPartitonName</span> <span class="enscript-string">&quot;APL,OSXPanic&quot;</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIODTNVRAMFreePartitionName</span>     <span class="enscript-string">&quot;wwwwwwwwwwww&quot;</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MIN_SYNC_NOW_INTERVAL</span> 15*60 <span class="enscript-comment">/* Minimum 15 Minutes interval mandated */</span>

<span class="enscript-type">enum</span> {
  kIODTNVRAMImageSize        = 0x2000,
  kIODTNVRAMXPRAMSize        = 0x0100,
  kIODTNVRAMNameRegistrySize = 0x0400
};

<span class="enscript-type">enum</span> {
  kOFVariableTypeBoolean = 1,
  kOFVariableTypeNumber,
  kOFVariableTypeString,
  kOFVariableTypeData
};

<span class="enscript-type">enum</span> {
  kOFVariablePermRootOnly = 0,
  kOFVariablePermUserRead,
  kOFVariablePermUserWrite,
  kOFVariablePermKernelOnly
};

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">__cplusplus</span>

class IODTNVRAM : public IOService
{
  OSDeclareDefaultStructors(IODTNVRAM);
  
<span class="enscript-reference">private</span>:
  IONVRAMController *_nvramController;
  <span class="enscript-type">const</span> OSSymbol    *_registryPropertiesKey;
  UInt8             *_nvramImage;
  __unused bool     _nvramImageDirty;
  UInt32            _ofPartitionOffset;
  UInt32            _ofPartitionSize;
  UInt8             *_ofImage;
  __unused bool     _ofImageDirty;
  OSDictionary      *_ofDict;
  OSDictionary      *_nvramPartitionOffsets;
  OSDictionary      *_nvramPartitionLengths;
  UInt32            _resv0 __unused;
  UInt32            _resv1 __unused;
  IOLock            *_ofLock;
  UInt32            _resv2 __unused;
  UInt32            _resv3 __unused;
  UInt8             *_resv4 __unused;
  UInt32            _piPartitionOffset;
  UInt32            _piPartitionSize;
  UInt8             *_piImage;
  bool              _systemPaniced;
  SInt32            _lastDeviceSync;
  bool              _freshInterval;
  bool              _isProxied;
  
  virtual UInt8 calculatePartitionChecksum(UInt8 *partitionHeader);
  virtual IOReturn initOFVariables(<span class="enscript-type">void</span>);
<span class="enscript-reference">public</span>:
  virtual IOReturn syncOFVariables(<span class="enscript-type">void</span>);
<span class="enscript-reference">private</span>:
  virtual UInt32 getOFVariableType(<span class="enscript-type">const</span> OSSymbol *propSymbol) <span class="enscript-type">const</span>;
  virtual UInt32 getOFVariablePerm(<span class="enscript-type">const</span> OSSymbol *propSymbol) <span class="enscript-type">const</span>;
  virtual bool getOWVariableInfo(UInt32 variableNumber, <span class="enscript-type">const</span> OSSymbol **propSymbol,
				 UInt32 *propType, UInt32 *propOffset);
  virtual bool convertPropToObject(UInt8 *propName, UInt32 propNameLength,
				   UInt8 *propData, UInt32 propDataLength,
				   <span class="enscript-type">const</span> OSSymbol **propSymbol,
				   OSObject **propObject);
  virtual bool convertObjectToProp(UInt8 *buffer, UInt32 *length,
				   <span class="enscript-type">const</span> OSSymbol *propSymbol, OSObject *propObject);
  virtual UInt16 generateOWChecksum(UInt8 *buffer);
  virtual bool validateOWChecksum(UInt8 *buffer);
  virtual <span class="enscript-type">void</span> updateOWBootArgs(<span class="enscript-type">const</span> OSSymbol *key, OSObject *value);
  virtual bool searchNVRAMProperty(<span class="enscript-type">struct</span> IONVRAMDescriptor *hdr,
				   UInt32 *where);
  
  virtual IOReturn readNVRAMPropertyType0(IORegistryEntry *entry,
					  <span class="enscript-type">const</span> OSSymbol **name,
					  OSData **value);
  virtual IOReturn writeNVRAMPropertyType0(IORegistryEntry *entry,
					   <span class="enscript-type">const</span> OSSymbol *name,
					   OSData * value);
  
  virtual OSData *unescapeBytesToData(<span class="enscript-type">const</span> UInt8 *bytes, UInt32 length);
  virtual OSData *escapeDataToData(OSData * value);

  virtual IOReturn readNVRAMPropertyType1(IORegistryEntry *entry,
					  <span class="enscript-type">const</span> OSSymbol **name,
					  OSData **value);
  virtual IOReturn writeNVRAMPropertyType1(IORegistryEntry *entry,
					   <span class="enscript-type">const</span> OSSymbol *name,
					   OSData *value);
  
  <span class="enscript-type">void</span> initNVRAMImage(<span class="enscript-type">void</span>);
  <span class="enscript-type">void</span> initProxyData(<span class="enscript-type">void</span>);
  
<span class="enscript-reference">public</span>:
  virtual bool init(IORegistryEntry *old, <span class="enscript-type">const</span> IORegistryPlane *plane) APPLE_KEXT_OVERRIDE;
  
  virtual <span class="enscript-type">void</span> registerNVRAMController(IONVRAMController *nvram);
  
  virtual <span class="enscript-type">void</span> sync(<span class="enscript-type">void</span>);
  
  virtual bool serializeProperties(OSSerialize *s) <span class="enscript-type">const</span> APPLE_KEXT_OVERRIDE;
  virtual OSObject *copyProperty(<span class="enscript-type">const</span> OSSymbol *aKey) <span class="enscript-type">const</span> APPLE_KEXT_OVERRIDE;
  virtual OSObject *copyProperty(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *aKey) <span class="enscript-type">const</span> APPLE_KEXT_OVERRIDE;
  virtual OSObject *getProperty(<span class="enscript-type">const</span> OSSymbol *aKey) <span class="enscript-type">const</span> APPLE_KEXT_OVERRIDE;
  virtual OSObject *getProperty(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *aKey) <span class="enscript-type">const</span> APPLE_KEXT_OVERRIDE;
  virtual bool setProperty(<span class="enscript-type">const</span> OSSymbol *aKey, OSObject *anObject) APPLE_KEXT_OVERRIDE;
  virtual <span class="enscript-type">void</span> removeProperty(<span class="enscript-type">const</span> OSSymbol *aKey) APPLE_KEXT_OVERRIDE;
  virtual IOReturn setProperties(OSObject *properties) APPLE_KEXT_OVERRIDE;
  
  virtual IOReturn readXPRAM(IOByteCount offset, UInt8 *buffer,
			     IOByteCount length);
  virtual IOReturn writeXPRAM(IOByteCount offset, UInt8 *buffer,
			      IOByteCount length);
  
  virtual IOReturn readNVRAMProperty(IORegistryEntry *entry,
				     <span class="enscript-type">const</span> OSSymbol **name,
				     OSData **value);
  virtual IOReturn writeNVRAMProperty(IORegistryEntry *entry,
				      <span class="enscript-type">const</span> OSSymbol *name,
				      OSData *value);
  
  virtual OSDictionary *getNVRAMPartitions(<span class="enscript-type">void</span>);
  
  virtual IOReturn readNVRAMPartition(<span class="enscript-type">const</span> OSSymbol *partitionID,
				      IOByteCount offset, UInt8 *buffer,
				      IOByteCount length);
  
  virtual IOReturn writeNVRAMPartition(<span class="enscript-type">const</span> OSSymbol *partitionID,
				       IOByteCount offset, UInt8 *buffer,
				       IOByteCount length);  
  
  virtual IOByteCount savePanicInfo(UInt8 *buffer, IOByteCount length);
  virtual bool safeToSync(<span class="enscript-type">void</span>);
  <span class="enscript-type">void</span> syncInternal(bool rateLimit);
};

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* __cplusplus */</span>

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !_IOKIT_IONVRAM_H */</span>
</pre>
<hr />
</body></html>