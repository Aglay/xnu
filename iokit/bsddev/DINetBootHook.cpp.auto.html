<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>DINetBootHook.cpp</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">DINetBootHook.cpp&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2002-2006 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*
 *  DINetBootHook.c
 *  DiskImages
 *
 *  Created by Byron Han on Sat Apr 13 2002.
 *
 *	Revision History
 *
 *	$Log: DINetBootHook.cpp,v $
 *	Revision 1.4  2005/07/29 21:49:57  lindak
 *	Merge of branch &quot;chardonnay&quot; to pick up all chardonnay changes in Leopard
 *	as of xnu-792.7.4
 *
 *	Revision 1.3.1558.1  2005/06/24 01:47:25  lindak
 *	Bringing over all of the Karma changes into chardonnay.
 *	
 *	Revision 1.1.1.1  2005/02/24 21:48:06  akosut
 *	Import xnu-764 from Tiger8A395
 *	
 *	Revision 1.3  2002/06/16 20:36:02  lindak
 *	Merged PR-2957314 into Jaguar (siegmund: netboot kernel code needs to set
 *	com.apple.AppleDiskImageController.load to boolean Yes)
 *	
 *	Revision 1.2.40.2  2002/06/15 03:50:38  dieter
 *	- corrected com.apple.AppleDiskImageController.load string
 *	
 *	Revision 1.2.40.1  2002/06/15 03:01:08  dieter
 *	Bug #: 2957314
 *	- add call to force IOHDIXController to get loaded/matched
 *	
 *	Revision 1.2  2002/05/03 18:08:39  lindak
 *	Merged PR-2909558 into Jaguar (siegmund POST WWDC: add support for NetBoot
 *	over IOHDIXController)
 *	
 *	Revision 1.1.2.1  2002/04/24 22:29:12  dieter
 *	Bug #: 2909558
 *	- added IOHDIXController netboot stubs
 *	
 *	Revision 1.3  2002/04/16 00:41:37  han
 *	migrated code out of here to IOHDIXController's setProperty method
 *	
 *	Revision 1.2  2002/04/14 23:53:53  han
 *	eliminate qDEBUG=1, use emums instead of hard coded string constants
 *	
 *	Revision 1.1  2002/04/14 22:54:42  han
 *	Renamed from DINetBookHook.c.
 *	First stab at implementing this code.
 *	
 *	Revision 1.1  2002/04/13 19:22:28  han
 *	added stub file DINetBookHook.c
 *	
 *
 */</span>
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">qDEBUG</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">qDEBUG</span> 0
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">qDEBUG</span>
#<span class="enscript-reference">warning</span> <span class="enscript-variable-name">qDEBUG</span> <span class="enscript-variable-name">is</span> 1!
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOService.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOLib.h&gt;</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">kIOHDIXControllerClassName</span>	<span class="enscript-string">&quot;IOHDIXController&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">kDIRootImageKey</span>				<span class="enscript-string">&quot;di-root-image&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">kDIRootImageResultKey</span>		<span class="enscript-string">&quot;di-root-image-result&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">kDIRootImageDevNameKey</span>		<span class="enscript-string">&quot;di-root-image-devname&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">kDIRootImageDevTKey</span>			<span class="enscript-string">&quot;di-root-image-devt&quot;</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kDIRootRamFileKey</span>           <span class="enscript-string">&quot;di-root-ram-file&quot;</span>

<span class="enscript-type">static</span> IOService *
<span class="enscript-function-name">di_load_controller</span>( <span class="enscript-type">void</span> )
{
	OSIterator *	controllerIterator 	= 0;
	OSDictionary *	matchDictionary 	= 0;
	IOService *     controller			= 0;

    <span class="enscript-keyword">do</span> {
        <span class="enscript-reference">IOService</span>::getResourceService()-&gt;publishResource(<span class="enscript-string">&quot;com.apple.AppleDiskImageController.load&quot;</span>, kOSBooleanTrue);
        <span class="enscript-reference">IOService</span>::getResourceService()-&gt;waitQuiet();

        <span class="enscript-comment">// first find IOHDIXController
</span>        matchDictionary = IOService::serviceMatching(kIOHDIXControllerClassName);
        <span class="enscript-keyword">if</span> (!matchDictionary)
            <span class="enscript-keyword">break</span>;

        controllerIterator = IOService::getMatchingServices(matchDictionary);
        <span class="enscript-keyword">if</span> (!controllerIterator)
            <span class="enscript-keyword">break</span>;

        controller = OSDynamicCast(IOService, controllerIterator-&gt;getNextObject());
        <span class="enscript-keyword">if</span> (!controller)
            <span class="enscript-keyword">break</span>;

        controller-&gt;retain();
    } <span class="enscript-keyword">while</span> (false);

	<span class="enscript-keyword">if</span> (matchDictionary)	matchDictionary-&gt;release();
	<span class="enscript-keyword">if</span> (controllerIterator)	controllerIterator-&gt;release();

    <span class="enscript-keyword">return</span> controller;
}

<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> {
<span class="enscript-comment">/*
	Name:		di_root_image 
	Function:	mount the disk image returning the dev node
	Parameters:	path	-&gt;		path/url to disk image
				devname	&lt;-		dev node used to set the rootdevice global variable
				dev_p	&lt;-		device number generated from major/minor numbers
	Comments:	
*/</span>
<span class="enscript-type">int</span> <span class="enscript-function-name">di_root_image</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *path, <span class="enscript-type">char</span> devname[], dev_t *dev_p)
{
	IOReturn			res 				= 0;
	IOService		*	controller			= 0;
	OSString		*	pathString			= 0;
	OSNumber		*	myResult			= 0;
	OSString		*	myDevName			= 0;
	OSNumber		*	myDevT				= 0;
	
	<span class="enscript-comment">// sanity check arguments please
</span>	<span class="enscript-keyword">if</span> (devname)		*devname = 0;
	<span class="enscript-keyword">if</span> (dev_p)			*dev_p = 0;
	
	<span class="enscript-keyword">if</span> (!path) 			<span class="enscript-keyword">return</span> kIOReturnBadArgument;
	<span class="enscript-keyword">if</span> (!devname) 		<span class="enscript-keyword">return</span> kIOReturnBadArgument;
	<span class="enscript-keyword">if</span> (!dev_p) 		<span class="enscript-keyword">return</span> kIOReturnBadArgument;

    controller = di_load_controller();
	<span class="enscript-keyword">if</span> (!controller) {
		res = kIOReturnNotFound;
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">NoIOHDIXController</span>;
	}
	
	<span class="enscript-comment">// okay create path object
</span>	pathString = OSString::withCString(path);
	<span class="enscript-keyword">if</span> (!pathString) {
		res = kIOReturnNoMemory;
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">CannotCreatePathOSString</span>;
	}
	
	<span class="enscript-comment">// do it
</span>	<span class="enscript-keyword">if</span> (!controller-&gt;setProperty(kDIRootImageKey, pathString))
		IOLog(<span class="enscript-string">&quot;IOHDIXController::setProperty(%s, %s) failed.\n&quot;</span>, kDIRootImageKey, pathString-&gt;getCStringNoCopy());
	
	myResult = OSDynamicCast(OSNumber, controller-&gt;getProperty(kDIRootImageResultKey));
	res = kIOReturnError;
	<span class="enscript-keyword">if</span> (myResult)
		res = myResult-&gt;unsigned32BitValue();
		
	<span class="enscript-keyword">if</span> (res) {
		IOLog(<span class="enscript-string">&quot;%s is 0x%08X/%d\n&quot;</span>, kDIRootImageResultKey, res, res);
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">di_root_image_FAILED</span>;
	}

	<span class="enscript-comment">// success - grab 
</span>	myDevT = OSDynamicCast(OSNumber, controller-&gt;getProperty(kDIRootImageDevTKey));
	<span class="enscript-keyword">if</span> (myDevT)
		*dev_p = myDevT-&gt;unsigned32BitValue();
	<span class="enscript-keyword">else</span> {
		IOLog(<span class="enscript-string">&quot;could not get %s\n&quot;</span>, kDIRootImageDevTKey);
		res = kIOReturnError;
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">di_root_image_FAILED</span>;
	}
		
	myDevName = OSDynamicCast(OSString, controller-&gt;getProperty(kDIRootImageDevNameKey));
	<span class="enscript-keyword">if</span> (myDevName) {
		<span class="enscript-comment">/* rootdevice is 16 chars in bsd_init.c */</span>
		strlcpy(devname, myDevName-&gt;getCStringNoCopy(), 16);
	} <span class="enscript-keyword">else</span> {
		IOLog(<span class="enscript-string">&quot;could not get %s\n&quot;</span>, kDIRootImageDevNameKey);
		res = kIOReturnError;
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">di_root_image_FAILED</span>;
	}
		

<span class="enscript-reference">di_root_image_FAILED</span>:
<span class="enscript-reference">CannotCreatePathOSString</span>:
<span class="enscript-reference">NoIOHDIXController</span>:

	<span class="enscript-comment">// clean up memory allocations
</span>	<span class="enscript-keyword">if</span> (pathString)			pathString-&gt;release();
    <span class="enscript-keyword">if</span> (controller)         controller-&gt;release();

	<span class="enscript-keyword">return</span> res;
}

<span class="enscript-type">void</span> <span class="enscript-function-name">di_root_ramfile</span>( IORegistryEntry * entry )
{
    OSData *                data;
    IOMemoryDescriptor *    mem;
    uint64_t                dmgSize;
    uint64_t                remain, length;
    OSData *                extentData = 0;
    IOAddressRange *        extentList;
    uint64_t                extentSize;
    uint32_t                extentCount;

    <span class="enscript-keyword">do</span> {
        data = OSDynamicCast(OSData, entry-&gt;getProperty(<span class="enscript-string">&quot;boot-ramdmg-size&quot;</span>));
        <span class="enscript-keyword">if</span> (!data || (data-&gt;getLength() != <span class="enscript-keyword">sizeof</span>(uint64_t)))
            <span class="enscript-keyword">break</span>;  <span class="enscript-comment">// bad disk image size
</span>
        dmgSize = *(uint64_t *) data-&gt;getBytesNoCopy();
        <span class="enscript-keyword">if</span> (!dmgSize)
            <span class="enscript-keyword">break</span>;

        data = OSDynamicCast(OSData, entry-&gt;getProperty(<span class="enscript-string">&quot;boot-ramdmg-extents&quot;</span>));
        <span class="enscript-keyword">if</span> (!data || (data-&gt;getLength() == 0) ||
            ((data-&gt;getLength() &amp; (<span class="enscript-keyword">sizeof</span>(IOAddressRange)-1)) != 0))
            <span class="enscript-keyword">break</span>;  <span class="enscript-comment">// bad extents
</span>
        <span class="enscript-comment">// make modifications to local copy
</span>        extentData  = OSData::withData(data);
        assert(extentData);

        extentList  = (IOAddressRange *) extentData-&gt;getBytesNoCopy();
        extentCount = extentData-&gt;getLength() / <span class="enscript-keyword">sizeof</span>(IOAddressRange);
        extentSize  = 0;
        remain = dmgSize;

        <span class="enscript-comment">// truncate extent length to enclosing disk image
</span>        <span class="enscript-keyword">for</span> (uint32_t i = 0; i &lt; extentCount; i++)
        {
            length = extentList[i].length;
            <span class="enscript-keyword">if</span> (!length) <span class="enscript-keyword">break</span>;
            
            extentSize += length;
            <span class="enscript-keyword">if</span> (length &gt;= remain)
            {
                extentList[i].length = remain;
                extentCount = i + 1;
                <span class="enscript-keyword">break</span>;
            }
            remain -= length;
        }
        <span class="enscript-keyword">if</span> (extentSize &lt; dmgSize)
            <span class="enscript-keyword">break</span>;  <span class="enscript-comment">// not enough extent bytes for enclosing disk image
</span>
        mem = IOMemoryDescriptor::withAddressRanges(
                extentList, extentCount,
                kIODirectionOut | kIOMemoryMapperNone, NULL);
        
        <span class="enscript-keyword">if</span> (mem)
        {
            IOService * controller = di_load_controller();
            <span class="enscript-keyword">if</span> (controller)
            {
                controller-&gt;setProperty(kDIRootRamFileKey, mem);
                controller-&gt;release();
            }
            mem-&gt;release();
        }
    } <span class="enscript-keyword">while</span> (false);
    
    <span class="enscript-keyword">if</span> (extentData)
        extentData-&gt;release();
}

};
</pre>
<hr />
</body></html>