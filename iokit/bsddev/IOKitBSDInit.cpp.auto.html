<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>IOKitBSDInit.cpp</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">IOKitBSDInit.cpp&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 1998-2011 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOBSD.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOLib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOService.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOCatalogue.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IODeviceTreeSupport.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOKitKeys.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOPlatformExpert.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOUserClient.h&gt;</span>

<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> {

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;pexpert/pexpert.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/clock.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;uuid/uuid.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/vnode_internal.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/mount.h&gt;</span>

<span class="enscript-comment">// how long to wait for matching root device, secs
</span>#<span class="enscript-reference">if</span> <span class="enscript-variable-name">DEBUG</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ROOTDEVICETIMEOUT</span>       120
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ROOTDEVICETIMEOUT</span>       60
#<span class="enscript-reference">endif</span>

<span class="enscript-type">int</span> panic_on_exception_triage = 0;

<span class="enscript-type">extern</span> dev_t <span class="enscript-function-name">mdevadd</span>(<span class="enscript-type">int</span> devid, uint64_t base, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> size, <span class="enscript-type">int</span> phys);
<span class="enscript-type">extern</span> dev_t <span class="enscript-function-name">mdevlookup</span>(<span class="enscript-type">int</span> devid);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mdevremoveall</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">di_root_ramfile</span>(IORegistryEntry * entry);


#<span class="enscript-reference">if</span>   <span class="enscript-variable-name">DEVELOPMENT</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IOPOLLED_COREFILE</span>  	1
<span class="enscript-comment">// no sizing
</span>#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIOCoreDumpSize</span>		0ULL
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIOCoreDumpFreeSize</span>	0ULL
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IOPOLLED_COREFILE</span>  	0
#<span class="enscript-reference">endif</span>


#<span class="enscript-reference">if</span> <span class="enscript-variable-name">IOPOLLED_COREFILE</span>
<span class="enscript-type">static</span> <span class="enscript-type">bool</span> 
<span class="enscript-function-name">NewKernelCoreMedia</span>(<span class="enscript-type">void</span> * target, <span class="enscript-type">void</span> * refCon,
		   IOService * newService,
		   IONotifier * notifier);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* IOPOLLED_COREFILE */</span>


kern_return_t
<span class="enscript-function-name">IOKitBSDInit</span>( <span class="enscript-type">void</span> )
{
    <span class="enscript-reference">IOService</span>::publishResource(<span class="enscript-string">&quot;IOBSD&quot;</span>);

    <span class="enscript-keyword">return</span>( kIOReturnSuccess );
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">IOServicePublishResource</span>( <span class="enscript-type">const</span> <span class="enscript-type">char</span> * property, boolean_t value )
{
    <span class="enscript-keyword">if</span> ( value)
        <span class="enscript-reference">IOService</span>::publishResource( property, kOSBooleanTrue );
    <span class="enscript-keyword">else</span>
        <span class="enscript-reference">IOService</span>::getResourceService()-&gt;removeProperty( property );
}

boolean_t
<span class="enscript-function-name">IOServiceWaitForMatchingResource</span>( <span class="enscript-type">const</span> <span class="enscript-type">char</span> * property, uint64_t timeout )
{
    OSDictionary *	dict = 0;
    IOService *         match = 0;
    boolean_t		found = false;
    
    <span class="enscript-keyword">do</span> {
        
        dict = IOService::resourceMatching( property );
        <span class="enscript-keyword">if</span>( !dict)
            <span class="enscript-keyword">continue</span>;
        match = IOService::waitForMatchingService( dict, timeout );
        <span class="enscript-keyword">if</span> ( match)
            found = true;
        
    } <span class="enscript-keyword">while</span>( false );
    
    <span class="enscript-keyword">if</span>( dict)
        dict-&gt;release();
    <span class="enscript-keyword">if</span>( match)
        match-&gt;release();
    
    <span class="enscript-keyword">return</span>( found );
}

boolean_t
<span class="enscript-function-name">IOCatalogueMatchingDriversPresent</span>( <span class="enscript-type">const</span> <span class="enscript-type">char</span> * property )
{
    OSDictionary *	dict = 0;
    OSOrderedSet *	set = 0;
    SInt32		generationCount = 0;
    boolean_t		found = false;
    
    <span class="enscript-keyword">do</span> {
        
        dict = OSDictionary::withCapacity(1);
        <span class="enscript-keyword">if</span>( !dict)
            <span class="enscript-keyword">continue</span>;
        dict-&gt;setObject( property, kOSBooleanTrue );
        set = gIOCatalogue-&gt;findDrivers( dict, &amp;generationCount );
        <span class="enscript-keyword">if</span> ( set &amp;&amp; (set-&gt;getCount() &gt; 0))
            found = true;
        
    } <span class="enscript-keyword">while</span>( false );
    
    <span class="enscript-keyword">if</span>( dict)
        dict-&gt;release();
    <span class="enscript-keyword">if</span>( set)
        set-&gt;release();
    
    <span class="enscript-keyword">return</span>( found );
}

OSDictionary * <span class="enscript-function-name">IOBSDNameMatching</span>( <span class="enscript-type">const</span> <span class="enscript-type">char</span> * name )
{
    OSDictionary *	dict;
    <span class="enscript-type">const</span> OSSymbol *	str = 0;

    <span class="enscript-keyword">do</span> {

	dict = IOService::serviceMatching( gIOServiceKey );
	<span class="enscript-keyword">if</span>( !dict)
	    <span class="enscript-keyword">continue</span>;
        str = OSSymbol::withCString( name );
	<span class="enscript-keyword">if</span>( !str)
	    <span class="enscript-keyword">continue</span>;
        dict-&gt;setObject( kIOBSDNameKey, (OSObject *) str );
        str-&gt;release();

        <span class="enscript-keyword">return</span>( dict );

    } <span class="enscript-keyword">while</span>( false );

    <span class="enscript-keyword">if</span>( dict)
	dict-&gt;release();
    <span class="enscript-keyword">if</span>( str)
	str-&gt;release();

    <span class="enscript-keyword">return</span>( 0 );
}

OSDictionary * <span class="enscript-function-name">IOUUIDMatching</span>( <span class="enscript-type">void</span> )
{
    <span class="enscript-keyword">return</span> IOService::resourceMatching( <span class="enscript-string">&quot;boot-uuid-media&quot;</span> );
}

OSDictionary * <span class="enscript-function-name">IONetworkNamePrefixMatching</span>( <span class="enscript-type">const</span> <span class="enscript-type">char</span> * prefix )
{
    OSDictionary *	 matching;
    OSDictionary *   propDict = 0;
    <span class="enscript-type">const</span> OSSymbol * str      = 0;
	<span class="enscript-type">char</span> networkType[128];
	
    <span class="enscript-keyword">do</span> {
        matching = IOService::serviceMatching( <span class="enscript-string">&quot;IONetworkInterface&quot;</span> );
        <span class="enscript-keyword">if</span> ( matching == 0 )
            <span class="enscript-keyword">continue</span>;

        propDict = OSDictionary::withCapacity(1);
        <span class="enscript-keyword">if</span> ( propDict == 0 )
            <span class="enscript-keyword">continue</span>;

        str = OSSymbol::withCString( prefix );
        <span class="enscript-keyword">if</span> ( str == 0 )
            <span class="enscript-keyword">continue</span>;

        propDict-&gt;setObject( <span class="enscript-string">&quot;IOInterfaceNamePrefix&quot;</span>, (OSObject *) str );
        str-&gt;release();
        str = 0;

		<span class="enscript-comment">// see if we're contrained to netroot off of specific network type
</span>		<span class="enscript-keyword">if</span>(PE_parse_boot_argn( <span class="enscript-string">&quot;network-type&quot;</span>, networkType, 128 ))
		{
			str = OSSymbol::withCString( networkType );
			<span class="enscript-keyword">if</span>(str)
			{
				propDict-&gt;setObject( <span class="enscript-string">&quot;IONetworkRootType&quot;</span>, str);
				str-&gt;release();
				str = 0;
			}
		}

        <span class="enscript-keyword">if</span> ( matching-&gt;setObject( gIOPropertyMatchKey,
                                  (OSObject *) propDict ) != true )
            <span class="enscript-keyword">continue</span>;

        propDict-&gt;release();
        propDict = 0;

        <span class="enscript-keyword">return</span>( matching );

    } <span class="enscript-keyword">while</span> ( false );

    <span class="enscript-keyword">if</span> ( matching ) matching-&gt;release();
    <span class="enscript-keyword">if</span> ( propDict ) propDict-&gt;release();
    <span class="enscript-keyword">if</span> ( str      ) str-&gt;release();

    <span class="enscript-keyword">return</span>( 0 );
}

<span class="enscript-type">static</span> <span class="enscript-type">bool</span> <span class="enscript-function-name">IORegisterNetworkInterface</span>( IOService * netif )
{
    <span class="enscript-comment">// A network interface is typically named and registered
</span>    <span class="enscript-comment">// with BSD after receiving a request from a user space
</span>    <span class="enscript-comment">// &quot;namer&quot;. However, for cases when the system needs to
</span>    <span class="enscript-comment">// root from the network, this registration task must be
</span>    <span class="enscript-comment">// done inside the kernel and completed before the root
</span>    <span class="enscript-comment">// device is handed to BSD.
</span>
    IOService *    stack;
    OSNumber *     zero    = 0;
    OSString *     path    = 0;
    OSDictionary * dict    = 0;
    <span class="enscript-type">char</span> *         pathBuf = 0;
    <span class="enscript-type">int</span>            len;
    <span class="enscript-type">enum</span> { kMaxPathLen = 512 };

    <span class="enscript-keyword">do</span> {
        stack = IOService::waitForService(
                <span class="enscript-reference">IOService</span>::serviceMatching(<span class="enscript-string">&quot;IONetworkStack&quot;</span>) );
        <span class="enscript-keyword">if</span> ( stack == 0 ) <span class="enscript-keyword">break</span>;

        dict = OSDictionary::withCapacity(3);
        <span class="enscript-keyword">if</span> ( dict == 0 ) <span class="enscript-keyword">break</span>;

        zero = OSNumber::withNumber((UInt64) 0, 32);
        <span class="enscript-keyword">if</span> ( zero == 0 ) <span class="enscript-keyword">break</span>;

        pathBuf = (<span class="enscript-type">char</span> *) IOMalloc( kMaxPathLen );
        <span class="enscript-keyword">if</span> ( pathBuf == 0 ) <span class="enscript-keyword">break</span>;

        len = kMaxPathLen;
        <span class="enscript-keyword">if</span> ( netif-&gt;getPath( pathBuf, &amp;len, gIOServicePlane )
             == false ) <span class="enscript-keyword">break</span>;

        path = OSString::withCStringNoCopy( pathBuf );
        <span class="enscript-keyword">if</span> ( path == 0 ) <span class="enscript-keyword">break</span>;

        dict-&gt;setObject( <span class="enscript-string">&quot;IOInterfaceUnit&quot;</span>, zero );
        dict-&gt;setObject( kIOPathMatchKey,   path );

        stack-&gt;setProperties( dict );
    }
    <span class="enscript-keyword">while</span> ( false );

    <span class="enscript-keyword">if</span> ( zero ) zero-&gt;release();
    <span class="enscript-keyword">if</span> ( path ) path-&gt;release();
    <span class="enscript-keyword">if</span> ( dict ) dict-&gt;release();
    <span class="enscript-keyword">if</span> ( pathBuf ) IOFree(pathBuf, kMaxPathLen);

	<span class="enscript-keyword">return</span> ( netif-&gt;getProperty( kIOBSDNameKey ) != 0 );
}

OSDictionary * <span class="enscript-function-name">IOOFPathMatching</span>( <span class="enscript-type">const</span> <span class="enscript-type">char</span> * path, <span class="enscript-type">char</span> * buf, <span class="enscript-type">int</span> maxLen )
{
    OSDictionary *	matching = NULL;
    OSString *		str;
    <span class="enscript-type">char</span> *		comp;
    <span class="enscript-type">int</span>			len;

    <span class="enscript-keyword">do</span> {

	len = strlen( kIODeviceTreePlane <span class="enscript-string">&quot;:&quot;</span> );
	maxLen -= len;
	<span class="enscript-keyword">if</span>( maxLen &lt;= 0)
	    <span class="enscript-keyword">continue</span>;

	strlcpy( buf, kIODeviceTreePlane <span class="enscript-string">&quot;:&quot;</span>, len + 1 );
	comp = buf + len;

	len = strlen( path );
	maxLen -= len;
	<span class="enscript-keyword">if</span>( maxLen &lt;= 0)
	    <span class="enscript-keyword">continue</span>;
	strlcpy( comp, path, len + 1 );

	matching = OSDictionary::withCapacity( 1 );
	<span class="enscript-keyword">if</span>( !matching)
	    <span class="enscript-keyword">continue</span>;

	str = OSString::withCString( buf );
	<span class="enscript-keyword">if</span>( !str)
	    <span class="enscript-keyword">continue</span>;
        matching-&gt;setObject( kIOPathMatchKey, str );
	str-&gt;release();

	<span class="enscript-keyword">return</span>( matching );

    } <span class="enscript-keyword">while</span>( false );

    <span class="enscript-keyword">if</span>( matching)
        matching-&gt;release();

    <span class="enscript-keyword">return</span>( 0 );
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span> didRam = 0;
<span class="enscript-type">enum</span> { kMaxPathBuf = 512, kMaxBootVar = 128 };

kern_return_t <span class="enscript-function-name">IOFindBSDRoot</span>( <span class="enscript-type">char</span> * rootName, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> rootNameSize,
				dev_t * root, u_int32_t * oflags )
{
    mach_timespec_t	t;
    IOService *		service;
    IORegistryEntry *	regEntry;
    OSDictionary *	matching = 0;
    OSString *		iostr;
    OSNumber *		off;
    OSData *		data = 0;

    UInt32		flags = 0;
    <span class="enscript-type">int</span>			mnr, mjr;
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> *        mediaProperty = 0;
    <span class="enscript-type">char</span> *		rdBootVar;
    <span class="enscript-type">char</span> *		str;
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> *	look = 0;
    <span class="enscript-type">int</span>			len;
    <span class="enscript-type">bool</span>		debugInfoPrintedOnce = false;
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> * 	uuidStr = NULL;

    <span class="enscript-type">static</span> <span class="enscript-type">int</span>		mountAttempts = 0;
				
    <span class="enscript-type">int</span> xchar, dchar;
                                    

    <span class="enscript-keyword">if</span>( mountAttempts++)
	IOSleep( 5 * 1000 );

    str = (<span class="enscript-type">char</span> *) IOMalloc( kMaxPathBuf + kMaxBootVar );
    <span class="enscript-keyword">if</span>( !str)
	<span class="enscript-keyword">return</span>( kIOReturnNoMemory );
    rdBootVar = str + kMaxPathBuf;

    <span class="enscript-keyword">if</span> (!PE_parse_boot_argn(<span class="enscript-string">&quot;rd&quot;</span>, rdBootVar, kMaxBootVar )
     &amp;&amp; !PE_parse_boot_argn(<span class="enscript-string">&quot;rootdev&quot;</span>, rdBootVar, kMaxBootVar ))
	rdBootVar[0] = 0;

    <span class="enscript-keyword">do</span> {
	<span class="enscript-keyword">if</span>( (regEntry = IORegistryEntry::fromPath( <span class="enscript-string">&quot;/chosen&quot;</span>, gIODTPlane ))) {
	    di_root_ramfile(regEntry);
            data = OSDynamicCast(OSData, regEntry-&gt;getProperty( <span class="enscript-string">&quot;root-matching&quot;</span> ));
            <span class="enscript-keyword">if</span> (data) {
               matching = OSDynamicCast(OSDictionary, OSUnserializeXML((<span class="enscript-type">char</span> *)data-&gt;getBytesNoCopy()));
                <span class="enscript-keyword">if</span> (matching) {
                    <span class="enscript-keyword">continue</span>;
                }
            }

	    data = (OSData *) regEntry-&gt;getProperty( <span class="enscript-string">&quot;boot-uuid&quot;</span> );
	    <span class="enscript-keyword">if</span>( data) {
		uuidStr = (<span class="enscript-type">const</span> <span class="enscript-type">char</span>*)data-&gt;getBytesNoCopy();
		OSString *uuidString = OSString::withCString( uuidStr );

		<span class="enscript-comment">// match the boot-args boot-uuid processing below
</span>		<span class="enscript-keyword">if</span>( uuidString) {
		    IOLog(<span class="enscript-string">&quot;rooting via boot-uuid from /chosen: %s\n&quot;</span>, uuidStr);
		    <span class="enscript-reference">IOService</span>::publishResource( <span class="enscript-string">&quot;boot-uuid&quot;</span>, uuidString );
		    uuidString-&gt;release();
		    matching = IOUUIDMatching();
		    mediaProperty = <span class="enscript-string">&quot;boot-uuid-media&quot;</span>;
		    regEntry-&gt;release();
		    <span class="enscript-keyword">continue</span>;
		} <span class="enscript-keyword">else</span> {
		    uuidStr = NULL;
		}
	    }
	    regEntry-&gt;release();
	}
    } <span class="enscript-keyword">while</span>( false );

<span class="enscript-comment">//
</span><span class="enscript-comment">//	See if we have a RAMDisk property in /chosen/memory-map.  If so, make it into a device.
</span><span class="enscript-comment">//	It will become /dev/mdx, where x is 0-f. 
</span><span class="enscript-comment">//
</span>
	<span class="enscript-keyword">if</span>(!didRam) {												<span class="enscript-comment">/* Have we already build this ram disk? */</span>
		didRam = 1;												<span class="enscript-comment">/* Remember we did this */</span>
		<span class="enscript-keyword">if</span>((regEntry = IORegistryEntry::fromPath( <span class="enscript-string">&quot;/chosen/memory-map&quot;</span>, gIODTPlane ))) {	<span class="enscript-comment">/* Find the map node */</span>
			data = (OSData *)regEntry-&gt;getProperty(<span class="enscript-string">&quot;RAMDisk&quot;</span>);	<span class="enscript-comment">/* Find the ram disk, if there */</span>
			<span class="enscript-keyword">if</span>(data) {											<span class="enscript-comment">/* We found one */</span>
				uintptr_t *ramdParms;
				ramdParms = (uintptr_t *)data-&gt;getBytesNoCopy();	<span class="enscript-comment">/* Point to the ram disk base and size */</span>
				(<span class="enscript-type">void</span>)mdevadd(-1, ml_static_ptovirt(ramdParms[0]) &gt;&gt; 12, ramdParms[1] &gt;&gt; 12, 0);	<span class="enscript-comment">/* Initialize it and pass back the device number */</span>
			}
			regEntry-&gt;release();								<span class="enscript-comment">/* Toss the entry */</span>
		}
	}
	
<span class="enscript-comment">//
</span><span class="enscript-comment">//	Now check if we are trying to root on a memory device
</span><span class="enscript-comment">//
</span>
	<span class="enscript-keyword">if</span>((rdBootVar[0] == <span class="enscript-string">'m'</span>) &amp;&amp; (rdBootVar[1] == <span class="enscript-string">'d'</span>) &amp;&amp; (rdBootVar[3] == 0)) {
		dchar = xchar = rdBootVar[2];							<span class="enscript-comment">/* Get the actual device */</span>
		<span class="enscript-keyword">if</span>((xchar &gt;= <span class="enscript-string">'0'</span>) &amp;&amp; (xchar &lt;= <span class="enscript-string">'9'</span>)) xchar = xchar - <span class="enscript-string">'0'</span>;	<span class="enscript-comment">/* If digit, convert */</span>
		<span class="enscript-keyword">else</span> {
			xchar = xchar &amp; ~<span class="enscript-string">' '</span>;								<span class="enscript-comment">/* Fold to upper case */</span>
			<span class="enscript-keyword">if</span>((xchar &gt;= <span class="enscript-string">'A'</span>) &amp;&amp; (xchar &lt;= <span class="enscript-string">'F'</span>)) {				<span class="enscript-comment">/* Is this a valid digit? */</span>
				xchar = (xchar &amp; 0xF) + 9;						<span class="enscript-comment">/* Convert the hex digit */</span>
				dchar = dchar | <span class="enscript-string">' '</span>;							<span class="enscript-comment">/* Fold to lower case */</span>
			}
			<span class="enscript-keyword">else</span> xchar = -1;									<span class="enscript-comment">/* Show bogus */</span>
		}
		<span class="enscript-keyword">if</span>(xchar &gt;= 0) {										<span class="enscript-comment">/* Do we have a valid memory device name? */</span>
			*root = mdevlookup(xchar);							<span class="enscript-comment">/* Find the device number */</span>
			<span class="enscript-keyword">if</span>(*root &gt;= 0) {									<span class="enscript-comment">/* Did we find one? */</span>

				rootName[0] = <span class="enscript-string">'m'</span>;								<span class="enscript-comment">/* Build root name */</span>
				rootName[1] = <span class="enscript-string">'d'</span>;								<span class="enscript-comment">/* Build root name */</span>
				rootName[2] = dchar;							<span class="enscript-comment">/* Build root name */</span>
				rootName[3] = 0;								<span class="enscript-comment">/* Build root name */</span>
				IOLog(<span class="enscript-string">&quot;BSD root: %s, major %d, minor %d\n&quot;</span>, rootName, major(*root), minor(*root));
				*oflags = 0;									<span class="enscript-comment">/* Show that this is not network */</span>
				<span class="enscript-keyword">goto</span> <span class="enscript-reference">iofrootx</span>;									<span class="enscript-comment">/* Join common exit... */</span>
			}
			panic(<span class="enscript-string">&quot;IOFindBSDRoot: specified root memory device, %s, has not been configured\n&quot;</span>, rdBootVar);	<span class="enscript-comment">/* Not there */</span>
		}
	}

      <span class="enscript-keyword">if</span>( (!matching) &amp;&amp; rdBootVar[0] ) {
	<span class="enscript-comment">// by BSD name
</span>	look = rdBootVar;
	<span class="enscript-keyword">if</span>( look[0] == <span class="enscript-string">'*'</span>)
	    look++;
    
	<span class="enscript-keyword">if</span> ( strncmp( look, <span class="enscript-string">&quot;en&quot;</span>, strlen( <span class="enscript-string">&quot;en&quot;</span> )) == 0 ) {
	    matching = IONetworkNamePrefixMatching( <span class="enscript-string">&quot;en&quot;</span> );
	} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> ( strncmp( look, <span class="enscript-string">&quot;uuid&quot;</span>, strlen( <span class="enscript-string">&quot;uuid&quot;</span> )) == 0 ) {
            <span class="enscript-type">char</span> *uuid;
            OSString *uuidString;

            uuid = (<span class="enscript-type">char</span> *)IOMalloc( kMaxBootVar );
                  
            <span class="enscript-keyword">if</span> ( uuid ) {
                <span class="enscript-keyword">if</span> (!PE_parse_boot_argn( <span class="enscript-string">&quot;boot-uuid&quot;</span>, uuid, kMaxBootVar )) {
                    panic( <span class="enscript-string">&quot;rd=uuid but no boot-uuid=&lt;value&gt; specified&quot;</span> ); 
                } 
                uuidString = OSString::withCString( uuid );
                <span class="enscript-keyword">if</span> ( uuidString ) {
                    <span class="enscript-reference">IOService</span>::publishResource( <span class="enscript-string">&quot;boot-uuid&quot;</span>, uuidString );
                    uuidString-&gt;release();
                    IOLog( <span class="enscript-string">&quot;\nWaiting for boot volume with UUID %s\n&quot;</span>, uuid );
                    matching = IOUUIDMatching();
                    mediaProperty = <span class="enscript-string">&quot;boot-uuid-media&quot;</span>;
                }
                IOFree( uuid, kMaxBootVar );
            }
	} <span class="enscript-keyword">else</span> {
	    matching = IOBSDNameMatching( look );
	}
    }

    <span class="enscript-keyword">if</span>( !matching) {
	OSString * astring;
	<span class="enscript-comment">// Match any HFS media
</span>	
        matching = IOService::serviceMatching( <span class="enscript-string">&quot;IOMedia&quot;</span> );
        astring = OSString::withCStringNoCopy(<span class="enscript-string">&quot;Apple_HFS&quot;</span>);
        <span class="enscript-keyword">if</span> ( astring ) {
            matching-&gt;setObject(<span class="enscript-string">&quot;Content&quot;</span>, astring);
            astring-&gt;release();
        }
    }

    <span class="enscript-keyword">if</span>( gIOKitDebug &amp; kIOWaitQuietBeforeRoot ) {
    	IOLog( <span class="enscript-string">&quot;Waiting for matching to complete\n&quot;</span> );
    	<span class="enscript-reference">IOService</span>::getPlatform()-&gt;waitQuiet();
    }

    <span class="enscript-keyword">if</span>( true &amp;&amp; matching) {
        OSSerialize * s = OSSerialize::withCapacity( 5 );

        <span class="enscript-keyword">if</span>( matching-&gt;serialize( s )) {
            IOLog( <span class="enscript-string">&quot;Waiting on %s\n&quot;</span>, s-&gt;text() );
            s-&gt;release();
        }
    }

    <span class="enscript-keyword">do</span> {
        t.tv_sec = ROOTDEVICETIMEOUT;
        t.tv_nsec = 0;
	matching-&gt;retain();
        service = IOService::waitForService( matching, &amp;t );
	<span class="enscript-keyword">if</span>( (!service) || (mountAttempts == 10)) {
            PE_display_icon( 0, <span class="enscript-string">&quot;noroot&quot;</span>);
            IOLog( <span class="enscript-string">&quot;Still waiting for root device\n&quot;</span> );

            <span class="enscript-keyword">if</span>( !debugInfoPrintedOnce) {
                debugInfoPrintedOnce = true;
                <span class="enscript-keyword">if</span>( gIOKitDebug &amp; kIOLogDTree) {
                    IOLog(<span class="enscript-string">&quot;\nDT plane:\n&quot;</span>);
                    IOPrintPlane( gIODTPlane );
                }
                <span class="enscript-keyword">if</span>( gIOKitDebug &amp; kIOLogServiceTree) {
                    IOLog(<span class="enscript-string">&quot;\nService plane:\n&quot;</span>);
                    IOPrintPlane( gIOServicePlane );
                }
                <span class="enscript-keyword">if</span>( gIOKitDebug &amp; kIOLogMemory)
                    IOPrintMemory();
            }
	}
    } <span class="enscript-keyword">while</span>( !service);
    matching-&gt;release();

    <span class="enscript-keyword">if</span> ( service &amp;&amp; mediaProperty ) {
        service = (IOService *)service-&gt;getProperty(mediaProperty);
    }

    mjr = 0;
    mnr = 0;

    <span class="enscript-comment">// If the IOService we matched to is a subclass of IONetworkInterface,
</span>    <span class="enscript-comment">// then make sure it has been registered with BSD and has a BSD name
</span>    <span class="enscript-comment">// assigned.
</span>
    <span class="enscript-keyword">if</span> ( service
    &amp;&amp;   service-&gt;metaCast( <span class="enscript-string">&quot;IONetworkInterface&quot;</span> )
    &amp;&amp;   !IORegisterNetworkInterface( service ) )
    {
        service = 0;
    }

    <span class="enscript-keyword">if</span>( service) {

	len = kMaxPathBuf;
	service-&gt;getPath( str, &amp;len, gIOServicePlane );
	IOLog( <span class="enscript-string">&quot;Got boot device = %s\n&quot;</span>, str );

	iostr = (OSString *) service-&gt;getProperty( kIOBSDNameKey );
	<span class="enscript-keyword">if</span>( iostr)
	    strlcpy( rootName, iostr-&gt;getCStringNoCopy(), rootNameSize );
	off = (OSNumber *) service-&gt;getProperty( kIOBSDMajorKey );
	<span class="enscript-keyword">if</span>( off)
	    mjr = off-&gt;unsigned32BitValue();
	off = (OSNumber *) service-&gt;getProperty( kIOBSDMinorKey );
	<span class="enscript-keyword">if</span>( off)
	    mnr = off-&gt;unsigned32BitValue();

	<span class="enscript-keyword">if</span>( service-&gt;metaCast( <span class="enscript-string">&quot;IONetworkInterface&quot;</span> ))
	    flags |= 1;

    } <span class="enscript-keyword">else</span> {

	IOLog( <span class="enscript-string">&quot;Wait for root failed\n&quot;</span> );
        strlcpy( rootName, <span class="enscript-string">&quot;en0&quot;</span>, rootNameSize );
        flags |= 1;
    }

    IOLog( <span class="enscript-string">&quot;BSD root: %s&quot;</span>, rootName );
    <span class="enscript-keyword">if</span>( mjr)
	IOLog(<span class="enscript-string">&quot;, major %d, minor %d\n&quot;</span>, mjr, mnr );
    <span class="enscript-keyword">else</span>
	IOLog(<span class="enscript-string">&quot;\n&quot;</span>);

    *root = makedev( mjr, mnr );
    *oflags = flags;

    IOFree( str,  kMaxPathBuf + kMaxBootVar );

<span class="enscript-reference">iofrootx</span>:
    <span class="enscript-keyword">if</span>( (gIOKitDebug &amp; (kIOLogDTree | kIOLogServiceTree | kIOLogMemory)) &amp;&amp; !debugInfoPrintedOnce) {

	<span class="enscript-reference">IOService</span>::getPlatform()-&gt;waitQuiet();
        <span class="enscript-keyword">if</span>( gIOKitDebug &amp; kIOLogDTree) {
            IOLog(<span class="enscript-string">&quot;\nDT plane:\n&quot;</span>);
            IOPrintPlane( gIODTPlane );
        }
        <span class="enscript-keyword">if</span>( gIOKitDebug &amp; kIOLogServiceTree) {
            IOLog(<span class="enscript-string">&quot;\nService plane:\n&quot;</span>);
            IOPrintPlane( gIOServicePlane );
        }
        <span class="enscript-keyword">if</span>( gIOKitDebug &amp; kIOLogMemory)
            IOPrintMemory();
    }

    <span class="enscript-keyword">return</span>( kIOReturnSuccess );
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">IORamDiskBSDRoot</span>(<span class="enscript-type">void</span>)
{
    <span class="enscript-type">char</span> rdBootVar[kMaxBootVar];
    <span class="enscript-keyword">if</span> (PE_parse_boot_argn(<span class="enscript-string">&quot;rd&quot;</span>, rdBootVar, kMaxBootVar )
     || PE_parse_boot_argn(<span class="enscript-string">&quot;rootdev&quot;</span>, rdBootVar, kMaxBootVar )) {
        <span class="enscript-keyword">if</span>((rdBootVar[0] == <span class="enscript-string">'m'</span>) &amp;&amp; (rdBootVar[1] == <span class="enscript-string">'d'</span>) &amp;&amp; (rdBootVar[3] == 0)) {
            <span class="enscript-keyword">return</span> true;
        }
    }
    <span class="enscript-keyword">return</span> false;
}

<span class="enscript-type">void</span> <span class="enscript-function-name">IOSecureBSDRoot</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> * rootName)
{
}

<span class="enscript-type">void</span> *
<span class="enscript-function-name">IOBSDRegistryEntryForDeviceTree</span>(<span class="enscript-type">char</span> * path)
{
    <span class="enscript-keyword">return</span> (IORegistryEntry::fromPath(path, gIODTPlane));
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">IOBSDRegistryEntryRelease</span>(<span class="enscript-type">void</span> * entry)
{
    IORegistryEntry * regEntry = (IORegistryEntry *)entry;

    <span class="enscript-keyword">if</span> (regEntry)
	regEntry-&gt;release();
    <span class="enscript-keyword">return</span>;
}

<span class="enscript-type">const</span> <span class="enscript-type">void</span> *
<span class="enscript-function-name">IOBSDRegistryEntryGetData</span>(<span class="enscript-type">void</span> * entry, <span class="enscript-type">char</span> * property_name, 
			  <span class="enscript-type">int</span> * packet_length)
{
    OSData *		data;
    IORegistryEntry * 	regEntry = (IORegistryEntry *)entry;

    data = (OSData *) regEntry-&gt;getProperty(property_name);
    <span class="enscript-keyword">if</span> (data) {
	*packet_length = data-&gt;getLength();
        <span class="enscript-keyword">return</span> (data-&gt;getBytesNoCopy());
    }
    <span class="enscript-keyword">return</span> (NULL);
}

kern_return_t <span class="enscript-function-name">IOBSDGetPlatformUUID</span>( uuid_t uuid, mach_timespec_t timeout )
{
    IOService * resources;
    OSString *  string;

    resources = IOService::waitForService( IOService::resourceMatching( kIOPlatformUUIDKey ), ( timeout.tv_sec || timeout.tv_nsec ) ? &amp;timeout : 0 );
    <span class="enscript-keyword">if</span> ( resources == 0 ) <span class="enscript-keyword">return</span> KERN_OPERATION_TIMED_OUT;

    string = ( OSString * ) IOService::getPlatform( )-&gt;getProvider( )-&gt;getProperty( kIOPlatformUUIDKey );
    <span class="enscript-keyword">if</span> ( string == 0 ) <span class="enscript-keyword">return</span> KERN_NOT_SUPPORTED;

    uuid_parse( string-&gt;getCStringNoCopy( ), uuid );

    <span class="enscript-keyword">return</span> KERN_SUCCESS;
}

kern_return_t <span class="enscript-function-name">IOBSDGetPlatformSerialNumber</span>( <span class="enscript-type">char</span> *serial_number_str, u_int32_t len )
{
    OSDictionary * platform_dict;
    IOService *platform;
    OSString *  string;

    <span class="enscript-keyword">if</span> (len &lt; 1) {
	    <span class="enscript-keyword">return</span> 0;
    }
    serial_number_str[0] = <span class="enscript-string">'\0'</span>;

    platform_dict = IOService::serviceMatching( <span class="enscript-string">&quot;IOPlatformExpertDevice&quot;</span> );
    <span class="enscript-keyword">if</span> (platform_dict == NULL) {
	    <span class="enscript-keyword">return</span> KERN_NOT_SUPPORTED;
    }

    platform = IOService::waitForService( platform_dict );
    <span class="enscript-keyword">if</span> (platform) {
	    string = ( OSString * ) platform-&gt;getProperty( kIOPlatformSerialNumberKey );
	    <span class="enscript-keyword">if</span> ( string == 0 ) {
		    <span class="enscript-keyword">return</span> KERN_NOT_SUPPORTED;
	    } <span class="enscript-keyword">else</span> {
		    strlcpy( serial_number_str, string-&gt;getCStringNoCopy( ), len );
	    }
    }
    
    <span class="enscript-keyword">return</span> KERN_SUCCESS;
}

<span class="enscript-type">void</span> <span class="enscript-function-name">IOBSDIterateMediaWithContent</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *content_uuid_cstring, <span class="enscript-type">int</span> (*func)(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *bsd_dev_name, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *uuid_str, <span class="enscript-type">void</span> *arg), <span class="enscript-type">void</span> *arg)
{
    OSDictionary *dictionary;
    OSString *content_uuid_string;

    dictionary = IOService::serviceMatching( <span class="enscript-string">&quot;IOMedia&quot;</span> );
    <span class="enscript-keyword">if</span>( dictionary ) {
	content_uuid_string = OSString::withCString( content_uuid_cstring );
	<span class="enscript-keyword">if</span>( content_uuid_string ) {
	    IOService *service;
	    OSIterator *iter;

	    dictionary-&gt;setObject( <span class="enscript-string">&quot;Content&quot;</span>, content_uuid_string );
	    dictionary-&gt;retain();

	    iter = IOService::getMatchingServices(dictionary);
	    <span class="enscript-keyword">while</span> (iter &amp;&amp; (service = (IOService *)iter-&gt;getNextObject())) {
		    <span class="enscript-keyword">if</span>( service ) {
			    OSString *iostr = (OSString *) service-&gt;getProperty( kIOBSDNameKey );
			    OSString *uuidstr = (OSString *) service-&gt;getProperty( <span class="enscript-string">&quot;UUID&quot;</span> );
			    <span class="enscript-type">const</span> <span class="enscript-type">char</span> *uuid;

			    <span class="enscript-keyword">if</span>( iostr) {
				    <span class="enscript-keyword">if</span> (uuidstr) {
					    uuid = uuidstr-&gt;getCStringNoCopy();
				    } <span class="enscript-keyword">else</span> {
					    uuid = <span class="enscript-string">&quot;00000000-0000-0000-0000-000000000000&quot;</span>;
				    }

				    <span class="enscript-comment">// call the callback
</span>				    <span class="enscript-keyword">if</span> (func &amp;&amp; func(iostr-&gt;getCStringNoCopy(), uuid, arg) == 0) {
					    <span class="enscript-keyword">break</span>;
				    }
			    }
		    }
	    }
	    <span class="enscript-keyword">if</span> (iter)
		    iter-&gt;release();
	    
	    content_uuid_string-&gt;release();
	}
	dictionary-&gt;release();
    }
}


<span class="enscript-type">int</span> <span class="enscript-function-name">IOBSDIsMediaEjectable</span>( <span class="enscript-type">const</span> <span class="enscript-type">char</span> *cdev_name )
{
    <span class="enscript-type">int</span> ret = 0;
    OSDictionary *dictionary;
    OSString *dev_name;

    <span class="enscript-keyword">if</span> (strncmp(cdev_name, <span class="enscript-string">&quot;/dev/&quot;</span>, 5) == 0) {
	    cdev_name += 5;
    }

    dictionary = IOService::serviceMatching( <span class="enscript-string">&quot;IOMedia&quot;</span> );
    <span class="enscript-keyword">if</span>( dictionary ) {
	dev_name = OSString::withCString( cdev_name );
	<span class="enscript-keyword">if</span>( dev_name ) {
	    IOService *service;
	    mach_timespec_t tv = { 5, 0 };    <span class="enscript-comment">// wait up to &quot;timeout&quot; seconds for the device
</span>
	    dictionary-&gt;setObject( kIOBSDNameKey, dev_name );
	    dictionary-&gt;retain();
	    service = IOService::waitForService( dictionary, &amp;tv );
	    <span class="enscript-keyword">if</span>( service ) {
		OSBoolean *ejectable = (OSBoolean *) service-&gt;getProperty( <span class="enscript-string">&quot;Ejectable&quot;</span> );

		<span class="enscript-keyword">if</span>( ejectable ) {
			ret = (<span class="enscript-type">int</span>)ejectable-&gt;getValue();
		}

	    }
	    dev_name-&gt;release();
	}
	dictionary-&gt;release();
    }

    <span class="enscript-keyword">return</span> ret;
}

} <span class="enscript-comment">/* extern &quot;C&quot; */</span>

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/conf.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/vnode.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/vnode_internal.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/fcntl.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOPolledInterface.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOBufferMemoryDescriptor.h&gt;</span>

IOPolledFileIOVars * gIOPolledCoreFileVars;

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">IOPOLLED_COREFILE</span>

<span class="enscript-type">static</span> IOReturn 
<span class="enscript-function-name">IOOpenPolledCoreFile</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> * filename)
{
    IOReturn err;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> debug;

    <span class="enscript-keyword">if</span> (gIOPolledCoreFileVars)                             <span class="enscript-keyword">return</span> (kIOReturnBusy);
    <span class="enscript-keyword">if</span> (!IOPolledInterface::gMetaClass.getInstanceCount()) <span class="enscript-keyword">return</span> (kIOReturnUnsupported);

    debug = 0;
    PE_parse_boot_argn(<span class="enscript-string">&quot;debug&quot;</span>, &amp;debug, <span class="enscript-keyword">sizeof</span> (debug));
    <span class="enscript-keyword">if</span> (DB_DISABLE_LOCAL_CORE &amp; debug)                     <span class="enscript-keyword">return</span> (kIOReturnUnsupported);

    err = IOPolledFileOpen(filename, kIOCoreDumpSize, kIOCoreDumpFreeSize,
			    NULL, 0,
			    &amp;gIOPolledCoreFileVars, NULL, NULL, 0);
    <span class="enscript-keyword">if</span> (kIOReturnSuccess != err)                           <span class="enscript-keyword">return</span> (err);

    err = IOPolledFilePollersSetup(gIOPolledCoreFileVars, kIOPolledPreflightCoreDumpState);
    <span class="enscript-keyword">if</span> (kIOReturnSuccess != err)
    {
	IOPolledFileClose(&amp;gIOPolledCoreFileVars, NULL, NULL, 0, 0, 0);
    }

    <span class="enscript-keyword">return</span> (err);
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> 
<span class="enscript-function-name">IOClosePolledCoreFile</span>(<span class="enscript-type">void</span>)
{
    IOPolledFilePollersClose(gIOPolledCoreFileVars, kIOPolledPostflightState);
    IOPolledFileClose(&amp;gIOPolledCoreFileVars, NULL, NULL, 0, 0, 0);
}

<span class="enscript-type">static</span> thread_call_t gIOOpenPolledCoreFileTC;
<span class="enscript-type">static</span> IONotifier  * gIOPolledCoreFileNotifier;
<span class="enscript-type">static</span> IONotifier  * gIOPolledCoreFileInterestNotifier;

<span class="enscript-type">static</span> IOReturn 
<span class="enscript-function-name">KernelCoreMediaInterest</span>(<span class="enscript-type">void</span> * target, <span class="enscript-type">void</span> * refCon,
			UInt32 messageType, IOService * provider,
			<span class="enscript-type">void</span> * messageArgument, vm_size_t argSize )
{
    <span class="enscript-keyword">if</span> (kIOMessageServiceIsTerminated == messageType)
    {
	gIOPolledCoreFileInterestNotifier-&gt;remove();
	gIOPolledCoreFileInterestNotifier = 0;
	IOClosePolledCoreFile();
    }

    <span class="enscript-keyword">return</span> (kIOReturnSuccess);
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">OpenKernelCoreMedia</span>(thread_call_param_t p0, thread_call_param_t p1)
{
    IOService * newService;
    OSString  * string;
    <span class="enscript-type">char</span>        filename[16];

    newService = (IOService *) p1;
    <span class="enscript-keyword">do</span>
    {
	<span class="enscript-keyword">if</span> (gIOPolledCoreFileVars) <span class="enscript-keyword">break</span>;
	string = OSDynamicCast(OSString, newService-&gt;getProperty(kIOBSDNameKey));
	<span class="enscript-keyword">if</span> (!string) <span class="enscript-keyword">break</span>;
	snprintf(filename, <span class="enscript-keyword">sizeof</span>(filename), <span class="enscript-string">&quot;/dev/%s&quot;</span>, string-&gt;getCStringNoCopy());
	<span class="enscript-keyword">if</span> (kIOReturnSuccess != IOOpenPolledCoreFile(filename)) <span class="enscript-keyword">break</span>;
	gIOPolledCoreFileInterestNotifier = newService-&gt;registerInterest(
				gIOGeneralInterest, &amp;KernelCoreMediaInterest, NULL, 0);
    }
    <span class="enscript-keyword">while</span> (false);

    newService-&gt;release();
}

<span class="enscript-type">static</span> <span class="enscript-type">bool</span> 
<span class="enscript-function-name">NewKernelCoreMedia</span>(<span class="enscript-type">void</span> * target, <span class="enscript-type">void</span> * refCon,
		   IOService * newService,
		   IONotifier * notifier)
{
    <span class="enscript-keyword">do</span>
    {
	<span class="enscript-keyword">if</span> (gIOPolledCoreFileVars)    <span class="enscript-keyword">break</span>;
        <span class="enscript-keyword">if</span> (!gIOOpenPolledCoreFileTC) <span class="enscript-keyword">break</span>;
        newService = newService-&gt;getProvider();
        <span class="enscript-keyword">if</span> (!newService)              <span class="enscript-keyword">break</span>;
        newService-&gt;retain();
	thread_call_enter1(gIOOpenPolledCoreFileTC, newService);
    }
    <span class="enscript-keyword">while</span> (false);

    <span class="enscript-keyword">return</span> (false);
}

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* IOPOLLED_COREFILE */</span>

<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> <span class="enscript-type">void</span> 
<span class="enscript-function-name">IOBSDMountChange</span>(<span class="enscript-type">struct</span> mount * mp, uint32_t op)
{
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">IOPOLLED_COREFILE</span>

    OSDictionary * bsdMatching;
    OSDictionary * mediaMatching;
    OSString     * string;

    <span class="enscript-keyword">if</span> (!gIOPolledCoreFileNotifier) <span class="enscript-keyword">do</span>
    {
	<span class="enscript-keyword">if</span> (!gIOOpenPolledCoreFileTC) gIOOpenPolledCoreFileTC = thread_call_allocate(&amp;OpenKernelCoreMedia, NULL);
	bsdMatching = IOService::serviceMatching(<span class="enscript-string">&quot;IOMediaBSDClient&quot;</span>);
	<span class="enscript-keyword">if</span> (!bsdMatching) <span class="enscript-keyword">break</span>;
	mediaMatching = IOService::serviceMatching(<span class="enscript-string">&quot;IOMedia&quot;</span>);
	string = OSString::withCStringNoCopy(<span class="enscript-string">&quot;5361644D-6163-11AA-AA11-00306543ECAC&quot;</span>);
	<span class="enscript-keyword">if</span> (!string || !mediaMatching) <span class="enscript-keyword">break</span>;
	mediaMatching-&gt;setObject(<span class="enscript-string">&quot;Content&quot;</span>, string);
	string-&gt;release();
	bsdMatching-&gt;setObject(gIOParentMatchKey, mediaMatching);
	mediaMatching-&gt;release();

	gIOPolledCoreFileNotifier = IOService::addMatchingNotification(
						  gIOFirstMatchNotification, bsdMatching, 
						  &amp;NewKernelCoreMedia, NULL, NULL, -1000);
    }
    <span class="enscript-keyword">while</span> (false);

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* IOPOLLED_COREFILE */</span>
}

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> boolean_t 
<span class="enscript-function-name">IOTaskHasEntitlement</span>(task_t task, <span class="enscript-type">const</span> <span class="enscript-type">char</span> * entitlement)
{
    OSObject * obj;
    obj = IOUserClient::copyClientEntitlement(task, entitlement);
    <span class="enscript-keyword">if</span> (!obj) <span class="enscript-keyword">return</span> (false);
    obj-&gt;release();
    <span class="enscript-keyword">return</span> (obj != kOSBooleanFalse);
}

</pre>
<hr />
</body></html>