<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>IODeviceTreeSupport.cpp</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">IODeviceTreeSupport.cpp&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 1998-2006 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IODeviceTreeSupport.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSContainers.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IODeviceMemory.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOService.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOCatalogue.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOLib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOKitKeys.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;pexpert/device_tree.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;machine/machine_routines.h&gt;</span>

<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> {

<span class="enscript-type">int</span> <span class="enscript-function-name">IODTGetLoaderInfo</span>( <span class="enscript-type">const</span> <span class="enscript-type">char</span> *key, <span class="enscript-type">void</span> **infoAddr, <span class="enscript-type">int</span> *infosize );
<span class="enscript-type">void</span> <span class="enscript-function-name">IODTFreeLoaderInfo</span>( <span class="enscript-type">const</span> <span class="enscript-type">char</span> *key, <span class="enscript-type">void</span> *infoAddr, <span class="enscript-type">int</span> infoSize );
<span class="enscript-type">int</span> <span class="enscript-function-name">IODTGetDefault</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *key, <span class="enscript-type">void</span> *infoAddr, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> infoSize );

}

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/assert.h&gt;</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IODTSUPPORTDEBUG</span> 0

<span class="enscript-type">const</span> IORegistryPlane * gIODTPlane;

<span class="enscript-type">static</span> OSArray *	gIODTPHandles;
<span class="enscript-type">static</span> OSArray *	gIODTPHandleMap;

<span class="enscript-type">const</span> OSSymbol *	gIODTNameKey;
<span class="enscript-type">const</span> OSSymbol *	gIODTUnitKey;
<span class="enscript-type">const</span> OSSymbol *	gIODTCompatibleKey;
<span class="enscript-type">const</span> OSSymbol * 	gIODTTypeKey;
<span class="enscript-type">const</span> OSSymbol * 	gIODTModelKey;
<span class="enscript-type">const</span> OSSymbol * 	gIODTTargetTypeKey;

<span class="enscript-type">const</span> OSSymbol * 	gIODTSizeCellKey;
<span class="enscript-type">const</span> OSSymbol * 	gIODTAddressCellKey;
<span class="enscript-type">const</span> OSSymbol * 	gIODTRangeKey;

<span class="enscript-type">const</span> OSSymbol *	gIODTPersistKey;

<span class="enscript-type">const</span> OSSymbol *	gIODTDefaultInterruptController;
<span class="enscript-type">const</span> OSSymbol *	gIODTAAPLInterruptsKey;
<span class="enscript-type">const</span> OSSymbol *	gIODTPHandleKey;
<span class="enscript-type">const</span> OSSymbol *	gIODTInterruptCellKey;
<span class="enscript-type">const</span> OSSymbol *	gIODTInterruptParentKey;
<span class="enscript-type">const</span> OSSymbol *	gIODTNWInterruptMappingKey;

OSDictionary   *	gIODTSharedInterrupts;

<span class="enscript-type">static</span> IORegistryEntry * <span class="enscript-function-name">MakeReferenceTable</span>( DTEntry dtEntry, <span class="enscript-type">bool</span> copy );
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">AddPHandle</span>( IORegistryEntry * regEntry );
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">FreePhysicalMemory</span>( vm_offset_t * range );
<span class="enscript-type">static</span> <span class="enscript-type">bool</span> <span class="enscript-function-name">IODTMapInterruptsSharing</span>( IORegistryEntry * regEntry, OSDictionary * allInts );

IORegistryEntry *
<span class="enscript-function-name">IODeviceTreeAlloc</span>( <span class="enscript-type">void</span> * dtTop )
{
    IORegistryEntry *		parent;
    IORegistryEntry *		child;
    IORegistryIterator *	regIter;
    DTEntryIterator		iter;
    DTEntry			dtChild;
    DTEntry			mapEntry;
    OSArray *			stack;
    OSData *			prop;
    OSDictionary *		allInts;
    vm_offset_t *		dtMap;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>		propSize;
    <span class="enscript-type">bool</span>			intMap;
    <span class="enscript-type">bool</span>			freeDT;

    gIODTPlane = IORegistryEntry::makePlane( kIODeviceTreePlane );

    gIODTNameKey 		= OSSymbol::withCStringNoCopy( <span class="enscript-string">&quot;name&quot;</span> );
    gIODTUnitKey 		= OSSymbol::withCStringNoCopy( <span class="enscript-string">&quot;AAPL,unit-string&quot;</span> );
    gIODTCompatibleKey 	= OSSymbol::withCStringNoCopy( <span class="enscript-string">&quot;compatible&quot;</span> );
    gIODTTypeKey 		= OSSymbol::withCStringNoCopy( <span class="enscript-string">&quot;device_type&quot;</span> );
    gIODTModelKey 		= OSSymbol::withCStringNoCopy( <span class="enscript-string">&quot;model&quot;</span> );
    gIODTTargetTypeKey		= OSSymbol::withCStringNoCopy( <span class="enscript-string">&quot;target-type&quot;</span> );
    gIODTSizeCellKey 	= OSSymbol::withCStringNoCopy( <span class="enscript-string">&quot;#size-cells&quot;</span> );
    gIODTAddressCellKey = OSSymbol::withCStringNoCopy( <span class="enscript-string">&quot;#address-cells&quot;</span> );
    gIODTRangeKey 		= OSSymbol::withCStringNoCopy( <span class="enscript-string">&quot;ranges&quot;</span> );
    gIODTPersistKey		= OSSymbol::withCStringNoCopy( <span class="enscript-string">&quot;IODTPersist&quot;</span> );

    assert(    gIODTPlane &amp;&amp; gIODTCompatibleKey
            &amp;&amp; gIODTTypeKey &amp;&amp; gIODTModelKey
            &amp;&amp; gIODTSizeCellKey &amp;&amp; gIODTAddressCellKey &amp;&amp; gIODTRangeKey
            &amp;&amp; gIODTPersistKey );

    gIODTDefaultInterruptController
		= OSSymbol::withCStringNoCopy(<span class="enscript-string">&quot;IOPrimaryInterruptController&quot;</span>);
    gIODTNWInterruptMappingKey
		= OSSymbol::withCStringNoCopy(<span class="enscript-string">&quot;IONWInterrupts&quot;</span>);

    gIODTAAPLInterruptsKey
		= OSSymbol::withCStringNoCopy(<span class="enscript-string">&quot;AAPL,interrupts&quot;</span>);
    gIODTPHandleKey
		= OSSymbol::withCStringNoCopy(<span class="enscript-string">&quot;AAPL,phandle&quot;</span>);

    gIODTInterruptParentKey
		= OSSymbol::withCStringNoCopy(<span class="enscript-string">&quot;interrupt-parent&quot;</span>);

    gIODTPHandles	= OSArray::withCapacity( 1 );
    gIODTPHandleMap	= OSArray::withCapacity( 1 );

    gIODTInterruptCellKey
		= OSSymbol::withCStringNoCopy(<span class="enscript-string">&quot;#interrupt-cells&quot;</span>);

    assert(    gIODTDefaultInterruptController &amp;&amp; gIODTNWInterruptMappingKey 
	    &amp;&amp; gIODTAAPLInterruptsKey
	    &amp;&amp; gIODTPHandleKey &amp;&amp; gIODTInterruptParentKey
	    &amp;&amp; gIODTPHandles &amp;&amp; gIODTPHandleMap
            &amp;&amp; gIODTInterruptCellKey
	 );

    freeDT = (kSuccess == DTLookupEntry( 0, <span class="enscript-string">&quot;/chosen/memory-map&quot;</span>, &amp;mapEntry ))
	  &amp;&amp; (kSuccess == DTGetProperty( mapEntry,
                <span class="enscript-string">&quot;DeviceTree&quot;</span>, (<span class="enscript-type">void</span> **) &amp;dtMap, &amp;propSize ))
	  &amp;&amp; ((2 * <span class="enscript-keyword">sizeof</span>(uint32_t)) == propSize);

    parent = MakeReferenceTable( (DTEntry)dtTop, freeDT );

    stack = OSArray::withObjects( (<span class="enscript-type">const</span> OSObject **) &amp;parent, 1, 10 );
    DTCreateEntryIterator( (DTEntry)dtTop, &amp;iter );

    <span class="enscript-keyword">do</span> {
        parent = (IORegistryEntry *)stack-&gt;getObject( stack-&gt;getCount() - 1);
        <span class="enscript-comment">//parent-&gt;release();
</span>        stack-&gt;removeObject( stack-&gt;getCount() - 1);

        <span class="enscript-keyword">while</span>( kSuccess == DTIterateEntries( iter, &amp;dtChild) ) {

            child = MakeReferenceTable( dtChild, freeDT );
            child-&gt;attachToParent( parent, gIODTPlane);

            AddPHandle( child );

            <span class="enscript-keyword">if</span>( kSuccess == DTEnterEntry( iter, dtChild)) {
                stack-&gt;setObject( parent);
                parent = child;
            }
            <span class="enscript-comment">// only registry holds retain
</span>            child-&gt;release();
        }

    } <span class="enscript-keyword">while</span>( stack-&gt;getCount()
		&amp;&amp; (kSuccess == DTExitEntry( iter, &amp;dtChild)));

    stack-&gt;release();
    DTDisposeEntryIterator( iter);

    <span class="enscript-comment">// parent is now root of the created tree
</span>
    <span class="enscript-comment">// make root name first compatible entry (purely cosmetic)
</span>    <span class="enscript-keyword">if</span>( (prop = (OSData *) parent-&gt;getProperty( gIODTCompatibleKey))) {
        parent-&gt;setName( parent-&gt;getName(), gIODTPlane );
        parent-&gt;setName( (<span class="enscript-type">const</span> <span class="enscript-type">char</span> *) prop-&gt;getBytesNoCopy() );
    }

    <span class="enscript-comment">// attach tree to meta root
</span>    parent-&gt;attachToParent( IORegistryEntry::getRegistryRoot(), gIODTPlane);
    parent-&gt;release();

    <span class="enscript-keyword">if</span>( freeDT ) {
        <span class="enscript-comment">// free original device tree
</span>        DTInit(0);
        IODTFreeLoaderInfo( <span class="enscript-string">&quot;DeviceTree&quot;</span>,
			    (<span class="enscript-type">void</span> *)dtMap[0], (<span class="enscript-type">int</span>) round_page(dtMap[1]) );
    }

    <span class="enscript-comment">// adjust tree
</span>
    gIODTSharedInterrupts = OSDictionary::withCapacity(4);
    allInts = OSDictionary::withCapacity(4);
    intMap = false;
    regIter = IORegistryIterator::iterateOver( gIODTPlane,
						kIORegistryIterateRecursively );
    assert( regIter &amp;&amp; allInts &amp;&amp; gIODTSharedInterrupts );
    <span class="enscript-keyword">if</span>( regIter &amp;&amp; allInts &amp;&amp; gIODTSharedInterrupts ) {
        <span class="enscript-keyword">while</span>( (child = regIter-&gt;getNextObject())) {
            IODTMapInterruptsSharing( child, allInts );
            <span class="enscript-keyword">if</span>( !intMap &amp;&amp; child-&gt;getProperty( gIODTInterruptParentKey))
                intMap = true;

        }
        regIter-&gt;release();
    }

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">IODTSUPPORTDEBUG</span>
    parent-&gt;setProperty(<span class="enscript-string">&quot;allInts&quot;</span>, allInts);
    parent-&gt;setProperty(<span class="enscript-string">&quot;sharedInts&quot;</span>, gIODTSharedInterrupts);

    regIter = IORegistryIterator::iterateOver( gIODTPlane,
						kIORegistryIterateRecursively );
    <span class="enscript-keyword">if</span> (regIter) {
        <span class="enscript-keyword">while</span>( (child = regIter-&gt;getNextObject())) {
	    OSArray *
	    array = OSDynamicCast(OSArray, child-&gt;getProperty( gIOInterruptSpecifiersKey ));
	    <span class="enscript-keyword">for</span>( UInt32 i = 0; array &amp;&amp; (i &lt; array-&gt;getCount()); i++)
	    {
		IOOptionBits options;
		IOReturn ret = IODTGetInterruptOptions( child, i, &amp;options );
		<span class="enscript-keyword">if</span>( (ret != kIOReturnSuccess) || options)
		    IOLog(<span class="enscript-string">&quot;%s[%ld] %ld (%x)\n&quot;</span>, child-&gt;getName(), i, options, ret);
	    }
	}
        regIter-&gt;release();
    }
#<span class="enscript-reference">endif</span>

    allInts-&gt;release();

    <span class="enscript-keyword">if</span>( intMap)
        <span class="enscript-comment">// set a key in the root to indicate we found NW interrupt mapping
</span>        parent-&gt;setProperty( gIODTNWInterruptMappingKey,
                (OSObject *) gIODTNWInterruptMappingKey );

    <span class="enscript-keyword">return</span>( parent);
}

<span class="enscript-type">int</span> <span class="enscript-function-name">IODTGetLoaderInfo</span>( <span class="enscript-type">const</span> <span class="enscript-type">char</span> *key, <span class="enscript-type">void</span> **infoAddr, <span class="enscript-type">int</span> *infoSize )
{
    IORegistryEntry		*chosen;
    OSData				*propObj;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>		*propPtr;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>		propSize;

    chosen = IORegistryEntry::fromPath( <span class="enscript-string">&quot;/chosen/memory-map&quot;</span>, gIODTPlane );
    <span class="enscript-keyword">if</span> ( chosen == 0 ) <span class="enscript-keyword">return</span> -1;

    propObj = OSDynamicCast( OSData, chosen-&gt;getProperty(key) );
    <span class="enscript-keyword">if</span> ( propObj == 0 ) <span class="enscript-keyword">return</span> -1;

    propSize = propObj-&gt;getLength();
    <span class="enscript-keyword">if</span> ( propSize != (2 * <span class="enscript-keyword">sizeof</span>(UInt32)) ) <span class="enscript-keyword">return</span> -1;
 
    propPtr = (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> *)propObj-&gt;getBytesNoCopy();
    <span class="enscript-keyword">if</span> ( propPtr == 0 ) <span class="enscript-keyword">return</span> -1;

    *infoAddr = (<span class="enscript-type">void</span> *)(uintptr_t) (propPtr[0]);
    *infoSize = (<span class="enscript-type">int</span>)               (propPtr[1]);

    <span class="enscript-keyword">return</span> 0;
}

<span class="enscript-type">void</span> <span class="enscript-function-name">IODTFreeLoaderInfo</span>( <span class="enscript-type">const</span> <span class="enscript-type">char</span> *key, <span class="enscript-type">void</span> *infoAddr, <span class="enscript-type">int</span> infoSize )
{
    vm_offset_t			range[2];
    IORegistryEntry		*chosen;

    range[0] = (vm_offset_t)infoAddr;
    range[1] = (vm_offset_t)infoSize;
    FreePhysicalMemory( range );

    <span class="enscript-keyword">if</span> ( key != 0 ) {
        chosen = IORegistryEntry::fromPath( <span class="enscript-string">&quot;/chosen/memory-map&quot;</span>, gIODTPlane );
        <span class="enscript-keyword">if</span> ( chosen != 0 ) {
            chosen-&gt;removeProperty(key);
        }
    }
}

<span class="enscript-type">int</span> <span class="enscript-function-name">IODTGetDefault</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *key, <span class="enscript-type">void</span> *infoAddr, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> infoSize )
{
    IORegistryEntry		*defaults;
    OSData			*defaultObj;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>		defaultSize;

    defaults = IORegistryEntry::fromPath( <span class="enscript-string">&quot;/defaults&quot;</span>, gIODTPlane );
    <span class="enscript-keyword">if</span> ( defaults == 0 ) <span class="enscript-keyword">return</span> -1;

    defaultObj = OSDynamicCast( OSData, defaults-&gt;getProperty(key) );
    <span class="enscript-keyword">if</span> ( defaultObj == 0 ) <span class="enscript-keyword">return</span> -1;

    defaultSize = defaultObj-&gt;getLength();
    <span class="enscript-keyword">if</span> ( defaultSize &gt; infoSize) <span class="enscript-keyword">return</span> -1;

    memcpy( infoAddr, defaultObj-&gt;getBytesNoCopy(), defaultSize );

    <span class="enscript-keyword">return</span> 0;
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">FreePhysicalMemory</span>( vm_offset_t * range )
{
    vm_offset_t	virt;

    virt = ml_static_ptovirt( range[0] );
    <span class="enscript-keyword">if</span>( virt) {
        ml_static_mfree( virt, range[1] );
    }
}

<span class="enscript-type">static</span> IORegistryEntry *
<span class="enscript-function-name">MakeReferenceTable</span>( DTEntry dtEntry, <span class="enscript-type">bool</span> copy )
{
    IORegistryEntry		*regEntry;
    OSDictionary		*propTable;
    <span class="enscript-type">const</span> OSSymbol		*nameKey;
    OSData				*data;
    <span class="enscript-type">const</span> OSSymbol		*sym;
    DTPropertyIterator	dtIter;
    <span class="enscript-type">void</span>				*prop;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>		propSize;
    <span class="enscript-type">char</span>				*name;
    <span class="enscript-type">char</span>				location[ 32 ];
    <span class="enscript-type">bool</span>				noLocation = true;

    regEntry = <span class="enscript-keyword">new</span> IOService;

    <span class="enscript-keyword">if</span>( regEntry &amp;&amp; (false == regEntry-&gt;init())) {
        regEntry-&gt;release();
        regEntry = 0;
    }

    <span class="enscript-keyword">if</span>( regEntry &amp;&amp;
      (kSuccess == DTCreatePropertyIterator( dtEntry, &amp;dtIter))) {

        propTable = regEntry-&gt;getPropertyTable();

        <span class="enscript-keyword">while</span>( kSuccess == DTIterateProperties( dtIter, &amp;name)) {

            <span class="enscript-keyword">if</span>(  kSuccess != DTGetProperty( dtEntry, name, &amp;prop, &amp;propSize ))
                <span class="enscript-keyword">continue</span>;

            <span class="enscript-keyword">if</span>( copy) {
                nameKey = OSSymbol::withCString(name);
                data = OSData::withBytes(prop, propSize);
            } <span class="enscript-keyword">else</span> {
                nameKey = OSSymbol::withCStringNoCopy(name);
                data = OSData::withBytesNoCopy(prop, propSize);
            }
            assert( nameKey &amp;&amp; data );

            propTable-&gt;setObject( nameKey, data);
            data-&gt;release();
            nameKey-&gt;release();

            <span class="enscript-keyword">if</span>( nameKey == gIODTNameKey ) {
                <span class="enscript-keyword">if</span>( copy)
                    sym = OSSymbol::withCString( (<span class="enscript-type">const</span> <span class="enscript-type">char</span> *) prop);
                <span class="enscript-keyword">else</span>
                    sym = OSSymbol::withCStringNoCopy( (<span class="enscript-type">const</span> <span class="enscript-type">char</span> *) prop);
                regEntry-&gt;setName( sym );
                sym-&gt;release();

            } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span>( nameKey == gIODTUnitKey ) {
                <span class="enscript-comment">// all OF strings are null terminated... except this one
</span>                <span class="enscript-keyword">if</span>( propSize &gt;= (<span class="enscript-type">int</span>) <span class="enscript-keyword">sizeof</span>(location))
                    propSize = <span class="enscript-keyword">sizeof</span>(location) - 1;
                strncpy( location, (<span class="enscript-type">const</span> <span class="enscript-type">char</span> *) prop, propSize );
                location[ propSize ] = 0;
                regEntry-&gt;setLocation( location );
                propTable-&gt;removeObject( gIODTUnitKey );
                noLocation = false;
    
            } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span>(noLocation &amp;&amp; (!strncmp(name, <span class="enscript-string">&quot;reg&quot;</span>, <span class="enscript-keyword">sizeof</span>(<span class="enscript-string">&quot;reg&quot;</span>)))) {
                <span class="enscript-comment">// default location - override later
</span>                snprintf(location, <span class="enscript-keyword">sizeof</span>(location), <span class="enscript-string">&quot;%X&quot;</span>, *((uint32_t *) prop));
                regEntry-&gt;setLocation( location );
            }
        }
        DTDisposePropertyIterator( dtIter);
    }

    <span class="enscript-keyword">return</span>( regEntry);
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">AddPHandle</span>( IORegistryEntry * regEntry )
{
    OSData *	data;

    <span class="enscript-keyword">if</span>( regEntry-&gt;getProperty( gIODTInterruptCellKey)
      &amp;&amp; (data = OSDynamicCast( OSData, regEntry-&gt;getProperty( gIODTPHandleKey )))) {
        <span class="enscript-comment">// a possible interrupt-parent
</span>        gIODTPHandles-&gt;setObject( data );
        gIODTPHandleMap-&gt;setObject( regEntry );
    }
}

<span class="enscript-type">static</span> IORegistryEntry * <span class="enscript-function-name">FindPHandle</span>( UInt32 phandle )
{
    OSData			*data;
    IORegistryEntry *regEntry = 0;
    <span class="enscript-type">int</span>				i;

    <span class="enscript-keyword">for</span>( i = 0; (data = (OSData *)gIODTPHandles-&gt;getObject( i )); i++ ) {
        <span class="enscript-keyword">if</span>( phandle == *((UInt32 *)data-&gt;getBytesNoCopy())) {
            regEntry = (IORegistryEntry *)
            gIODTPHandleMap-&gt;getObject( i );
            <span class="enscript-keyword">break</span>;
        }
    }

    <span class="enscript-keyword">return</span>( regEntry );
}

<span class="enscript-type">static</span> <span class="enscript-type">bool</span> <span class="enscript-function-name">GetUInt32</span>( IORegistryEntry * regEntry, <span class="enscript-type">const</span> OSSymbol * name,
			UInt32 * value )
{
    OSData	*data;

    <span class="enscript-keyword">if</span>( (data = OSDynamicCast( OSData, regEntry-&gt;getProperty( name )))
      &amp;&amp; (4 == data-&gt;getLength())) {
        *value = *((UInt32 *) data-&gt;getBytesNoCopy());
        <span class="enscript-keyword">return</span>( true );
    } <span class="enscript-keyword">else</span>
        <span class="enscript-keyword">return</span>( false );
}

<span class="enscript-type">static</span> IORegistryEntry * <span class="enscript-function-name">IODTFindInterruptParent</span>( IORegistryEntry * regEntry, IOItemCount index )
{
    IORegistryEntry *	parent;
    UInt32		phandle;
    OSData	    *	data;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>	len;

    <span class="enscript-keyword">if</span>( (data = OSDynamicCast( OSData, regEntry-&gt;getProperty( gIODTInterruptParentKey )))
      &amp;&amp; (<span class="enscript-keyword">sizeof</span>(UInt32) &lt;= (len = data-&gt;getLength()))) {
	<span class="enscript-keyword">if</span> (((index + 1) * <span class="enscript-keyword">sizeof</span>(UInt32)) &gt; len)
	    index = 0;
	phandle = ((UInt32 *) data-&gt;getBytesNoCopy())[index];
	parent = FindPHandle( phandle );

    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span>( 0 == regEntry-&gt;getProperty( <span class="enscript-string">&quot;interrupt-controller&quot;</span>))
        parent = regEntry-&gt;getParentEntry( gIODTPlane);
    <span class="enscript-keyword">else</span>
        parent = 0;

    <span class="enscript-keyword">return</span>( parent );
}

<span class="enscript-type">const</span> OSSymbol * <span class="enscript-function-name">IODTInterruptControllerName</span>( IORegistryEntry * regEntry )
{
    <span class="enscript-type">const</span> OSSymbol	*sym;
    UInt32		phandle;
    <span class="enscript-type">bool</span>		ok;
    <span class="enscript-type">char</span> 		buf[48];

    ok = GetUInt32( regEntry, gIODTPHandleKey, &amp;phandle);
    assert( ok );

    <span class="enscript-keyword">if</span>( ok) {
        snprintf(buf, <span class="enscript-keyword">sizeof</span>(buf), <span class="enscript-string">&quot;IOInterruptController%08X&quot;</span>, (uint32_t)phandle);
        sym = OSSymbol::withCString( buf );
    } <span class="enscript-keyword">else</span>
        sym = 0;

    <span class="enscript-keyword">return</span>( sym );
}

#<span class="enscript-reference">define</span> <span class="enscript-function-name">unexpected</span>(a) { kprintf(<span class="enscript-string">&quot;unexpected %s:%d\n&quot;</span>, __FILE__, __LINE__); a; }

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">IODTGetICellCounts</span>( IORegistryEntry * regEntry,
			    UInt32 * iCellCount, UInt32 * aCellCount)
{
    <span class="enscript-keyword">if</span>( !GetUInt32( regEntry, gIODTInterruptCellKey, iCellCount))
        unexpected( *iCellCount = 1 );
    <span class="enscript-keyword">if</span>( !GetUInt32( regEntry, gIODTAddressCellKey, aCellCount))
        *aCellCount = 0;
}

<span class="enscript-type">static</span> UInt32 <span class="enscript-function-name">IODTMapOneInterrupt</span>( IORegistryEntry * regEntry, UInt32 * intSpec, UInt32 index,
				    OSData ** spec, <span class="enscript-type">const</span> OSSymbol ** controller )
{
    IORegistryEntry *parent = 0;
    OSData			*data;
    UInt32			*addrCmp;
    UInt32			*maskCmp;
    UInt32			*map;
    UInt32			*endMap;
    UInt32			acells, icells, pacells, picells, cell;
    UInt32			i, original_icells;
    <span class="enscript-type">bool</span>			cmp, ok = false;

    parent = IODTFindInterruptParent( regEntry, index );    
    IODTGetICellCounts( parent, &amp;icells, &amp;acells );
    addrCmp = 0;
    <span class="enscript-keyword">if</span>( acells) {
        data = OSDynamicCast( OSData, regEntry-&gt;getProperty( <span class="enscript-string">&quot;reg&quot;</span> ));
        <span class="enscript-keyword">if</span>( data &amp;&amp; (data-&gt;getLength() &gt;= (acells * <span class="enscript-keyword">sizeof</span>(UInt32))))
            addrCmp = (UInt32 *) data-&gt;getBytesNoCopy();
    }
    original_icells = icells;
    regEntry = parent;
    
    <span class="enscript-keyword">do</span> {
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">IODTSUPPORTDEBUG</span>
        kprintf (<span class="enscript-string">&quot;IODTMapOneInterrupt: current regEntry name %s\n&quot;</span>, regEntry-&gt;getName());
        kprintf (<span class="enscript-string">&quot;acells - icells: &quot;</span>);
        <span class="enscript-keyword">for</span> (i = 0; i &lt; acells; i++) kprintf (<span class="enscript-string">&quot;0x%08X &quot;</span>, addrCmp[i]);
        kprintf (<span class="enscript-string">&quot;- &quot;</span>);
        <span class="enscript-keyword">for</span> (i = 0; i &lt; icells; i++) kprintf (<span class="enscript-string">&quot;0x%08X &quot;</span>, intSpec[i]);
        kprintf (<span class="enscript-string">&quot;\n&quot;</span>);
#<span class="enscript-reference">endif</span>

        <span class="enscript-keyword">if</span>( parent &amp;&amp; (data = OSDynamicCast( OSData,
            regEntry-&gt;getProperty( <span class="enscript-string">&quot;interrupt-controller&quot;</span>)))) {
            <span class="enscript-comment">// found a controller - don't want to follow cascaded controllers
</span>            parent = 0;
            *spec = OSData::withBytesNoCopy( (<span class="enscript-type">void</span> *) intSpec,
                                            icells * <span class="enscript-keyword">sizeof</span>(UInt32));
            *controller = IODTInterruptControllerName( regEntry );
            ok = (*spec &amp;&amp; *controller);
        } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span>( parent &amp;&amp; (data = OSDynamicCast( OSData,
                    regEntry-&gt;getProperty( <span class="enscript-string">&quot;interrupt-map&quot;</span>)))) {
            <span class="enscript-comment">// interrupt-map
</span>            map = (UInt32 *) data-&gt;getBytesNoCopy();
            endMap = map + (data-&gt;getLength() / <span class="enscript-keyword">sizeof</span>(UInt32));
            data = OSDynamicCast( OSData, regEntry-&gt;getProperty( <span class="enscript-string">&quot;interrupt-map-mask&quot;</span> ));
            <span class="enscript-keyword">if</span>( data &amp;&amp; (data-&gt;getLength() &gt;= ((acells + icells) * <span class="enscript-keyword">sizeof</span>(UInt32))))
                maskCmp = (UInt32 *) data-&gt;getBytesNoCopy();
            <span class="enscript-keyword">else</span>
                maskCmp = 0;

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">IODTSUPPORTDEBUG</span>
            <span class="enscript-keyword">if</span> (maskCmp) {
                kprintf (<span class="enscript-string">&quot;        maskCmp: &quot;</span>);
                <span class="enscript-keyword">for</span> (i = 0; i &lt; acells + icells; i++) {
                    <span class="enscript-keyword">if</span> (i == acells)
                        kprintf (<span class="enscript-string">&quot;- &quot;</span>);
                    kprintf (<span class="enscript-string">&quot;0x%08X &quot;</span>, maskCmp[i]);
                }
                kprintf (<span class="enscript-string">&quot;\n&quot;</span>);
                kprintf (<span class="enscript-string">&quot;         masked: &quot;</span>);
                <span class="enscript-keyword">for</span> (i = 0; i &lt; acells + icells; i++) {
                    <span class="enscript-keyword">if</span> (i == acells)
                        kprintf (<span class="enscript-string">&quot;- &quot;</span>);
                    kprintf (<span class="enscript-string">&quot;0x%08X &quot;</span>, ((i &lt; acells) ? addrCmp[i] : intSpec[i-acells]) &amp; maskCmp[i]);
                }
                kprintf (<span class="enscript-string">&quot;\n&quot;</span>);
            } <span class="enscript-keyword">else</span>
                kprintf (<span class="enscript-string">&quot;no maskCmp\n&quot;</span>);
#<span class="enscript-reference">endif</span>
            <span class="enscript-keyword">do</span> {
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">IODTSUPPORTDEBUG</span>
                kprintf (<span class="enscript-string">&quot;            map: &quot;</span>);
                <span class="enscript-keyword">for</span> (i = 0; i &lt; acells + icells; i++) {
                    <span class="enscript-keyword">if</span> (i == acells)
                        kprintf (<span class="enscript-string">&quot;- &quot;</span>);
                    kprintf (<span class="enscript-string">&quot;0x%08X &quot;</span>, map[i]);
                }
                kprintf (<span class="enscript-string">&quot;\n&quot;</span>);
#<span class="enscript-reference">endif</span>
                <span class="enscript-keyword">for</span>( i = 0, cmp = true; cmp &amp;&amp; (i &lt; (acells + icells)); i++) {
                    cell = (i &lt; acells) ? addrCmp[i] : intSpec[ i - acells ];
                    <span class="enscript-keyword">if</span>( maskCmp)
                        cell &amp;= maskCmp[i];
                    cmp = (cell == map[i]);
                }

                map += acells + icells;
                <span class="enscript-keyword">if</span>( 0 == (parent = FindPHandle( *(map++) )))
                    unexpected(<span class="enscript-keyword">break</span>);

                IODTGetICellCounts( parent, &amp;picells, &amp;pacells );
                <span class="enscript-keyword">if</span>( cmp) {
                    addrCmp = map;
                    intSpec = map + pacells;
                    regEntry = parent;
                } <span class="enscript-keyword">else</span> {
                    map += pacells + picells;
                }
            } <span class="enscript-keyword">while</span>( !cmp &amp;&amp; (map &lt; endMap) );
            <span class="enscript-keyword">if</span> (!cmp)
                parent = 0;
        } 

        <span class="enscript-keyword">if</span>( parent) {
            IODTGetICellCounts( parent, &amp;icells, &amp;acells );
            regEntry = parent;
        }

    } <span class="enscript-keyword">while</span>( parent);

    <span class="enscript-keyword">return</span>( ok ? original_icells : 0 );
}

IOReturn <span class="enscript-function-name">IODTGetInterruptOptions</span>( IORegistryEntry * regEntry, <span class="enscript-type">int</span> source, IOOptionBits * options )
{
    OSArray *	controllers;
    OSArray *	specifiers;
    OSArray *	shared;
    OSObject *	spec;
    OSObject *	oneSpec;

    *options = 0;

    controllers = OSDynamicCast(OSArray, regEntry-&gt;getProperty(gIOInterruptControllersKey));
    specifiers  = OSDynamicCast(OSArray, regEntry-&gt;getProperty(gIOInterruptSpecifiersKey));

    <span class="enscript-keyword">if</span>( !controllers || !specifiers)
        <span class="enscript-keyword">return</span> (kIOReturnNoInterrupt);
    
    shared = (OSArray *) gIODTSharedInterrupts-&gt;getObject(
                        (<span class="enscript-type">const</span> OSSymbol *) controllers-&gt;getObject(source) );
    <span class="enscript-keyword">if</span> (!shared)
        <span class="enscript-keyword">return</span> (kIOReturnSuccess);

    spec = specifiers-&gt;getObject(source);
    <span class="enscript-keyword">if</span> (!spec)
        <span class="enscript-keyword">return</span> (kIOReturnNoInterrupt);

    <span class="enscript-keyword">for</span> (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i = 0;
            (oneSpec = shared-&gt;getObject(i))
            &amp;&amp; (!oneSpec-&gt;isEqualTo(spec));
            i++ )	{}

    <span class="enscript-keyword">if</span> (oneSpec)
        *options = kIODTInterruptShared;

    <span class="enscript-keyword">return</span> (kIOReturnSuccess);
}

<span class="enscript-type">static</span> <span class="enscript-type">bool</span> <span class="enscript-function-name">IODTMapInterruptsSharing</span>( IORegistryEntry * regEntry, OSDictionary * allInts )
{
    IORegistryEntry *	parent;
    OSData *		local;
    OSData *		local2;
    UInt32 *		localBits;
    UInt32 *		localEnd;
    IOItemCount		index;
    OSData * 		map;
    OSObject *		oneMap;
    OSArray *		mapped;
    OSArray *		controllerInts;
    <span class="enscript-type">const</span> OSSymbol *	controller = 0;
    OSArray *		controllers;
    UInt32		skip = 1;
    <span class="enscript-type">bool</span>		ok, nw;

    nw = (0 == (local = OSDynamicCast( OSData,
        regEntry-&gt;getProperty( gIODTAAPLInterruptsKey))));
    <span class="enscript-keyword">if</span>( nw &amp;&amp; (0 == (local = OSDynamicCast( OSData,
        regEntry-&gt;getProperty( <span class="enscript-string">&quot;interrupts&quot;</span>)))))
        <span class="enscript-keyword">return</span>( true );		<span class="enscript-comment">// nothing to see here
</span>
    <span class="enscript-keyword">if</span>( nw &amp;&amp; (parent = regEntry-&gt;getParentEntry( gIODTPlane))) {
        <span class="enscript-comment">// check for bridges on old world
</span>        <span class="enscript-keyword">if</span>( (local2 = OSDynamicCast( OSData,
                parent-&gt;getProperty( gIODTAAPLInterruptsKey)))) {
            local = local2;
            nw = false;
        }
    }

    localBits = (UInt32 *) local-&gt;getBytesNoCopy();
    localEnd = localBits + (local-&gt;getLength() / <span class="enscript-keyword">sizeof</span>(UInt32));
    index = 0;
    mapped = OSArray::withCapacity( 1 );
    controllers = OSArray::withCapacity( 1 );

    ok = (mapped &amp;&amp; controllers);

    <span class="enscript-keyword">if</span>( ok) <span class="enscript-keyword">do</span> {
        <span class="enscript-keyword">if</span>( nw) {
            skip = IODTMapOneInterrupt( regEntry, localBits, index, &amp;map, &amp;controller );
            <span class="enscript-keyword">if</span>( 0 == skip) {
                IOLog(<span class="enscript-string">&quot;%s: error mapping interrupt[%d]\n&quot;</span>,
                        regEntry-&gt;getName(), mapped-&gt;getCount());
                <span class="enscript-keyword">break</span>;
            }
        } <span class="enscript-keyword">else</span> {
            map = OSData::withData( local, mapped-&gt;getCount() * <span class="enscript-keyword">sizeof</span>(UInt32),
				<span class="enscript-keyword">sizeof</span>(UInt32));
            controller = gIODTDefaultInterruptController;
            controller-&gt;retain();
        }

	index++;
        localBits += skip;
        mapped-&gt;setObject( map );
        controllers-&gt;setObject( controller );

        <span class="enscript-keyword">if</span> (allInts)
        {
            controllerInts = (OSArray *) allInts-&gt;getObject( controller );
            <span class="enscript-keyword">if</span> (controllerInts)
	    {
                <span class="enscript-keyword">for</span> (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i = 0; (oneMap = controllerInts-&gt;getObject(i)); i++)
                {
                    <span class="enscript-keyword">if</span> (map-&gt;isEqualTo(oneMap))
                    {
                        controllerInts = (OSArray *) gIODTSharedInterrupts-&gt;getObject( controller );
                        <span class="enscript-keyword">if</span> (controllerInts)
                            controllerInts-&gt;setObject(map);
                        <span class="enscript-keyword">else</span>
                        {
                            controllerInts = OSArray::withObjects( (<span class="enscript-type">const</span> OSObject **) &amp;map, 1, 4 );
                            <span class="enscript-keyword">if</span> (controllerInts)
                            {
                                gIODTSharedInterrupts-&gt;setObject( controller, controllerInts );
                                controllerInts-&gt;release();
                            }
                        }
                        <span class="enscript-keyword">break</span>;
                    }
                }
		<span class="enscript-keyword">if</span> (!oneMap)
                    controllerInts-&gt;setObject(map);
            }
            <span class="enscript-keyword">else</span>
            {
                controllerInts = OSArray::withObjects( (<span class="enscript-type">const</span> OSObject **) &amp;map, 1, 16 );
                <span class="enscript-keyword">if</span> (controllerInts)
                {
                    allInts-&gt;setObject( controller, controllerInts );
                    controllerInts-&gt;release();
                }
            }
        }

        map-&gt;release();
        controller-&gt;release();

    } <span class="enscript-keyword">while</span>( localBits &lt; localEnd);

    ok &amp;= (localBits == localEnd);

    <span class="enscript-keyword">if</span>( ok ) {
        <span class="enscript-comment">// store results
</span>        ok  = regEntry-&gt;setProperty( gIOInterruptControllersKey, controllers);
        ok &amp;= regEntry-&gt;setProperty( gIOInterruptSpecifiersKey, mapped);
    }

    <span class="enscript-keyword">if</span>( controllers)
        controllers-&gt;release();
    <span class="enscript-keyword">if</span>( mapped)
        mapped-&gt;release();

    <span class="enscript-keyword">return</span>( ok );
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">IODTMapInterrupts</span>( IORegistryEntry * regEntry )
{
    <span class="enscript-keyword">return</span>( IODTMapInterruptsSharing( regEntry, 0 ));
}

<span class="enscript-comment">/*
 */</span>

<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> *
<span class="enscript-function-name">CompareKey</span>( OSString * key,
		<span class="enscript-type">const</span> IORegistryEntry * table, <span class="enscript-type">const</span> OSSymbol * propName )
{
    OSObject		*prop;
    OSData			*data;
    OSString		*string;
    <span class="enscript-type">const</span> <span class="enscript-type">char</span>		*ckey;
    UInt32			keyLen;
    UInt32          nlen;
    <span class="enscript-type">const</span> <span class="enscript-type">char</span>		*names;
    <span class="enscript-type">const</span> <span class="enscript-type">char</span>		*lastName;
    <span class="enscript-type">bool</span>			wild;
    <span class="enscript-type">bool</span>			matched;
    <span class="enscript-type">const</span> <span class="enscript-type">char</span>		*result = 0;

    <span class="enscript-keyword">if</span>( 0 == (prop = table-&gt;getProperty( propName )))
	<span class="enscript-keyword">return</span>( 0 );

    <span class="enscript-keyword">if</span>( (data = OSDynamicCast( OSData, prop ))) {
        names = (<span class="enscript-type">const</span> <span class="enscript-type">char</span> *) data-&gt;getBytesNoCopy();
        lastName = names + data-&gt;getLength();
    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span>( (string = OSDynamicCast( OSString, prop ))) {
        names = string-&gt;getCStringNoCopy();
        lastName = names + string-&gt;getLength() + 1;
    } <span class="enscript-keyword">else</span>
		<span class="enscript-keyword">return</span>( 0 );

    ckey = key-&gt;getCStringNoCopy();
    keyLen = key-&gt;getLength();
    wild = (<span class="enscript-string">'*'</span> == key-&gt;getChar( keyLen - 1 ));

    <span class="enscript-keyword">do</span> {
        <span class="enscript-comment">// for each name in the property
</span>        nlen = strnlen(names, lastName - names);
        <span class="enscript-keyword">if</span>( wild)
            matched = ((nlen &gt;= (keyLen - 1)) &amp;&amp; (0 == strncmp(ckey, names, keyLen - 1)));
        <span class="enscript-keyword">else</span>
            matched = (keyLen == nlen) &amp;&amp; (0 == strncmp(ckey, names, keyLen));

        <span class="enscript-keyword">if</span>( matched)
            result = names;

        names = names + nlen + 1;

    } <span class="enscript-keyword">while</span>( (names &lt; lastName) &amp;&amp; (false == matched));

    <span class="enscript-keyword">return</span>( result);
}


<span class="enscript-type">bool</span> <span class="enscript-function-name">IODTCompareNubName</span>( <span class="enscript-type">const</span> IORegistryEntry * regEntry,
			 OSString * name, OSString ** matchingName )
{
    <span class="enscript-type">const</span> <span class="enscript-type">char</span>		*result;
    <span class="enscript-type">bool</span>			matched;

    matched =  (0 != (result = CompareKey( name, regEntry, gIODTNameKey)))
	    || (0 != (result = CompareKey( name, regEntry, gIODTCompatibleKey)))
	    || (0 != (result = CompareKey( name, regEntry, gIODTTypeKey)))
	    || (0 != (result = CompareKey( name, regEntry, gIODTModelKey)));

    <span class="enscript-keyword">if</span>( result &amp;&amp; matchingName)
	*matchingName = OSString::withCString( result );

    <span class="enscript-keyword">return</span>( result != 0 );
}

<span class="enscript-type">bool</span> <span class="enscript-function-name">IODTMatchNubWithKeys</span>( IORegistryEntry * regEntry,
                                    <span class="enscript-type">const</span> <span class="enscript-type">char</span> * keys )
{
    OSObject	*obj;
    <span class="enscript-type">bool</span>		result = false;

    obj = OSUnserialize( keys, 0 );

    <span class="enscript-keyword">if</span>( obj) {
        result = regEntry-&gt;compareNames( obj );
		obj-&gt;release();
    }
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">DEBUG</span>
    <span class="enscript-keyword">else</span> IOLog(<span class="enscript-string">&quot;Couldn't unserialize %s\n&quot;</span>, keys );
#<span class="enscript-reference">endif</span>

    <span class="enscript-keyword">return</span>( result );
}

OSCollectionIterator * <span class="enscript-function-name">IODTFindMatchingEntries</span>( IORegistryEntry * from,
			IOOptionBits options, <span class="enscript-type">const</span> <span class="enscript-type">char</span> * keys )
{
    OSSet					*result = 0;
    IORegistryEntry			*next;
    IORegistryIterator		*iter;
    OSCollectionIterator	*cIter;
    <span class="enscript-type">bool</span>					cmp;
    <span class="enscript-type">bool</span>					minus = options &amp; kIODTExclusive;


    iter = IORegistryIterator::iterateOver( from, gIODTPlane,
		(options &amp; kIODTRecursive) ? kIORegistryIterateRecursively : 0 );
    <span class="enscript-keyword">if</span>( iter) {

        <span class="enscript-keyword">do</span> {

            <span class="enscript-keyword">if</span>( result)
                result-&gt;release();
            result = OSSet::withCapacity( 3 );
            <span class="enscript-keyword">if</span>( !result)
                <span class="enscript-keyword">break</span>;

            iter-&gt;reset();
            <span class="enscript-keyword">while</span>( (next = iter-&gt;getNextObject())) {
    
                <span class="enscript-comment">// Look for existence of a debug property to skip
</span>                <span class="enscript-keyword">if</span>( next-&gt;getProperty(<span class="enscript-string">&quot;AAPL,ignore&quot;</span>))
                    <span class="enscript-keyword">continue</span>;
    
                <span class="enscript-keyword">if</span>( keys) {
                    cmp = IODTMatchNubWithKeys( next, keys );
                    <span class="enscript-keyword">if</span>( (minus &amp;&amp; (false == cmp))
                            || ((false == minus) &amp;&amp; (false != cmp)) )
                        result-&gt;setObject( next);
                } <span class="enscript-keyword">else</span>
                    result-&gt;setObject( next);
            }
        } <span class="enscript-keyword">while</span>( !iter-&gt;isValid());

        iter-&gt;release();
    }

    cIter = OSCollectionIterator::withCollection( result);
    <span class="enscript-keyword">if</span> (result) result-&gt;release();

    <span class="enscript-keyword">return</span>( cIter);
}


<span class="enscript-type">struct</span> IODTPersistent {
    IODTCompareAddressCellFunc	compareFunc;
    IODTNVLocationFunc		locationFunc;
};

<span class="enscript-type">void</span> <span class="enscript-function-name">IODTSetResolving</span>( IORegistryEntry * 	regEntry,
		IODTCompareAddressCellFunc	compareFunc,
		IODTNVLocationFunc		locationFunc )
{
    IODTPersistent	persist;
    OSData			*prop;

    persist.compareFunc = compareFunc;
    persist.locationFunc = locationFunc;
    prop = OSData::withBytes( &amp;persist, <span class="enscript-keyword">sizeof</span>(persist));
    <span class="enscript-keyword">if</span>( !prop)
        <span class="enscript-keyword">return</span>;

    prop-&gt;setSerializable(false);
    regEntry-&gt;setProperty( gIODTPersistKey, prop);
    prop-&gt;release();
    <span class="enscript-keyword">return</span>;
}

#<span class="enscript-reference">if</span>   <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__arm__</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__i386__</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__x86_64__</span>)
<span class="enscript-type">static</span> SInt32 <span class="enscript-function-name">DefaultCompare</span>( UInt32 cellCount, UInt32 left[], UInt32 right[] )
{
	cellCount--;
	<span class="enscript-keyword">return</span>( left[ cellCount ] - right[ cellCount ] ); 
}
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">error</span> <span class="enscript-variable-name">Unknown</span> <span class="enscript-variable-name">architecture</span>.
#<span class="enscript-reference">endif</span>

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">AddLengthToCells</span>( UInt32 numCells, UInt32 *cells, UInt64 offset)
{
    <span class="enscript-keyword">if</span> (numCells == 1)
    {
        cells[0] += (UInt32)offset;
    }
    <span class="enscript-keyword">else</span> {
        UInt64 sum = cells[numCells - 1] + offset;
        cells[numCells - 1] = (UInt32)sum;
        <span class="enscript-keyword">if</span> (sum &gt; UINT32_MAX) {
            cells[numCells - 2] += (UInt32)(sum &gt;&gt; 32);
        }
    }
}

<span class="enscript-type">static</span> IOPhysicalAddress <span class="enscript-function-name">CellsValue</span>( UInt32 numCells, UInt32 *cells)
{
    <span class="enscript-keyword">if</span> (numCells == 1) {
        <span class="enscript-keyword">return</span> IOPhysical32( 0, cells[0] );
    } <span class="enscript-keyword">else</span> {
        <span class="enscript-keyword">return</span> IOPhysical32( cells[numCells - 2], cells[numCells - 1] );
    }
}

<span class="enscript-type">void</span> <span class="enscript-function-name">IODTGetCellCounts</span>( IORegistryEntry * regEntry,
			    UInt32 * sizeCount, UInt32 * addressCount)
{
    <span class="enscript-keyword">if</span>( !GetUInt32( regEntry, gIODTSizeCellKey, sizeCount))
        *sizeCount = 1;
    <span class="enscript-keyword">if</span>( !GetUInt32( regEntry, gIODTAddressCellKey, addressCount))
        *addressCount = 2;
    <span class="enscript-keyword">return</span>;
}

<span class="enscript-comment">// Given addr &amp; len cells from our child, find it in our ranges property, then
</span><span class="enscript-comment">// look in our parent to resolve the base of the range for us.
</span>
<span class="enscript-comment">// Range[]: child-addr  our-addr  child-len
</span><span class="enscript-comment">// #cells:    child       ours     child
</span>
<span class="enscript-type">bool</span> <span class="enscript-function-name">IODTResolveAddressCell</span>( IORegistryEntry * regEntry,
                             UInt32 cellsIn[],
                             IOPhysicalAddress * phys, IOPhysicalLength * lenOut )
{
    IORegistryEntry	*parent;
    OSData		*prop;
    <span class="enscript-comment">// cells in addresses at regEntry
</span>    UInt32		sizeCells, addressCells;
    <span class="enscript-comment">// cells in addresses below regEntry
</span>    UInt32		childSizeCells, childAddressCells;
    UInt32		childCells;
    UInt32		cell[ 8 ], propLen;
    UInt64		offset = 0;
    UInt32		endCell[ 8 ];
    UInt32		*range;
    UInt32		*lookRange;
    UInt32		*startRange;
    UInt32		*endRanges;
    <span class="enscript-type">bool</span>		ok = true;
    SInt64		diff, diff2, endDiff;
    UInt64		len, rangeLen;

    IODTPersistent	*persist;
    IODTCompareAddressCellFunc	compare;

    IODTGetCellCounts( regEntry, &amp;childSizeCells, &amp;childAddressCells );
    childCells = childAddressCells + childSizeCells;

    <span class="enscript-keyword">if</span> (childCells &gt; <span class="enscript-keyword">sizeof</span>(cell)/<span class="enscript-keyword">sizeof</span>(cell[0]))
        panic(<span class="enscript-string">&quot;IODTResolveAddressCell: Invalid device tree (%u,%u)&quot;</span>, (uint32_t)childAddressCells, (uint32_t)childSizeCells);

    bcopy( cellsIn, cell, <span class="enscript-keyword">sizeof</span>(UInt32) * childCells );
    *lenOut = CellsValue( childSizeCells, cellsIn + childAddressCells );

    <span class="enscript-keyword">do</span>
    {
        prop = OSDynamicCast( OSData, regEntry-&gt;getProperty( gIODTRangeKey ));
        <span class="enscript-keyword">if</span>( 0 == prop) {
            <span class="enscript-comment">/* end of the road */</span>
            *phys = CellsValue( childAddressCells, cell );
            *phys += offset;
            <span class="enscript-keyword">break</span>;
        }

        parent = regEntry-&gt;getParentEntry( gIODTPlane );
        IODTGetCellCounts( parent, &amp;sizeCells, &amp;addressCells );

        <span class="enscript-keyword">if</span>( (propLen = prop-&gt;getLength())) {
            <span class="enscript-comment">// search
</span>            startRange = (UInt32 *) prop-&gt;getBytesNoCopy();
            range = startRange;
            endRanges = range + (propLen / <span class="enscript-keyword">sizeof</span>(UInt32));

            prop = (OSData *) regEntry-&gt;getProperty( gIODTPersistKey );
            <span class="enscript-keyword">if</span>( prop) {
                persist = (IODTPersistent *) prop-&gt;getBytesNoCopy();
                compare = persist-&gt;compareFunc;
            } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (addressCells == childAddressCells) {
                compare = DefaultCompare;
            } <span class="enscript-keyword">else</span> {
                panic(<span class="enscript-string">&quot;There is no mixed comparison function yet...&quot;</span>);
            }

            <span class="enscript-keyword">for</span>( ok = false;
                    range &lt; endRanges;
                    range += (childCells + addressCells) ) {

                <span class="enscript-comment">// is cell start within range?
</span>                diff = (*compare)( childAddressCells, cell, range );

                <span class="enscript-keyword">if</span> (childAddressCells &gt; <span class="enscript-keyword">sizeof</span>(endCell)/<span class="enscript-keyword">sizeof</span>(endCell[0]))
                    panic(<span class="enscript-string">&quot;IODTResolveAddressCell: Invalid device tree (%u)&quot;</span>, (uint32_t)childAddressCells);

                bcopy(range, endCell, childAddressCells * <span class="enscript-keyword">sizeof</span>(UInt32));

                rangeLen = CellsValue(childSizeCells, range + childAddressCells + addressCells);
                AddLengthToCells(childAddressCells, endCell, rangeLen);

                diff2 = (*compare)( childAddressCells, cell, endCell );

                <span class="enscript-comment">// if start of cell &lt; start of range, or end of range &gt;= start of cell, skip
</span>                <span class="enscript-keyword">if</span> ((diff &lt; 0) || (diff2 &gt;= 0))
                    <span class="enscript-keyword">continue</span>;

                len = CellsValue(childSizeCells, cell + childAddressCells);
                ok = (0 == len);

                <span class="enscript-keyword">if</span> (!ok)
                {
                    <span class="enscript-comment">// search for cell end
</span>                    bcopy(cell, endCell, childAddressCells * <span class="enscript-keyword">sizeof</span>(UInt32));

                    AddLengthToCells(childAddressCells, endCell, len - 1);

                    <span class="enscript-keyword">for</span>( lookRange = startRange;
                            lookRange &lt; endRanges;
                            lookRange += (childCells + addressCells) )
                    {
                        <span class="enscript-comment">// make sure end of cell &gt;= range start
</span>                        endDiff = (*compare)( childAddressCells, endCell, lookRange );
                        <span class="enscript-keyword">if</span>( endDiff &lt; 0)
                            <span class="enscript-keyword">continue</span>;

                        UInt64 rangeStart = CellsValue(addressCells, range + childAddressCells);
                        UInt64 lookRangeStart = CellsValue(addressCells, lookRange + childAddressCells);
                        <span class="enscript-keyword">if</span> ((endDiff - len + 1 + lookRangeStart) == (diff + rangeStart))
                        {
                            ok = true;
                            <span class="enscript-keyword">break</span>;
                        }
                    }
                    <span class="enscript-keyword">if</span> (!ok)
                        <span class="enscript-keyword">continue</span>;
                }
                offset += diff;
                <span class="enscript-keyword">break</span>;
            }

            <span class="enscript-keyword">if</span> (addressCells + sizeCells &gt; <span class="enscript-keyword">sizeof</span>(cell)/<span class="enscript-keyword">sizeof</span>(cell[0]))
                panic(<span class="enscript-string">&quot;IODTResolveAddressCell: Invalid device tree (%u, %u)&quot;</span>, (uint32_t)addressCells, (uint32_t)sizeCells);

            <span class="enscript-comment">// Get the physical start of the range from our parent
</span>            bcopy( range + childAddressCells, cell, <span class="enscript-keyword">sizeof</span>(UInt32) * addressCells );
            bzero( cell + addressCells, <span class="enscript-keyword">sizeof</span>(UInt32) * sizeCells );

        } <span class="enscript-comment">/* else zero length range =&gt; pass thru to parent */</span>

        regEntry		= parent;
        childSizeCells		= sizeCells;
        childAddressCells	= addressCells;
        childCells		= childAddressCells + childSizeCells;
    }
    <span class="enscript-keyword">while</span>( ok &amp;&amp; regEntry);

    <span class="enscript-keyword">return</span>( ok);
}


OSArray * <span class="enscript-function-name">IODTResolveAddressing</span>( IORegistryEntry * regEntry,
			<span class="enscript-type">const</span> <span class="enscript-type">char</span> * addressPropertyName,
			IODeviceMemory * parent )
{
    IORegistryEntry		*parentEntry;
    OSData				*addressProperty;
    UInt32				sizeCells, addressCells, cells;
    <span class="enscript-type">int</span>					i, num;
    UInt32				*reg;
    IOPhysicalAddress	phys;
    IOPhysicalLength	len;
    OSArray				*array;
    IODeviceMemory		*range;

    parentEntry = regEntry-&gt;getParentEntry( gIODTPlane );
    addressProperty = (OSData *) regEntry-&gt;getProperty( addressPropertyName );
    <span class="enscript-keyword">if</span>( (0 == addressProperty) || (0 == parentEntry))
        <span class="enscript-keyword">return</span>( 0);

    IODTGetCellCounts( parentEntry, &amp;sizeCells, &amp;addressCells );
    <span class="enscript-keyword">if</span>( 0 == sizeCells)
        <span class="enscript-keyword">return</span>( 0);

    cells = sizeCells + addressCells;
    reg = (UInt32 *) addressProperty-&gt;getBytesNoCopy();
    num = addressProperty-&gt;getLength() / (4 * cells);

    array = OSArray::withCapacity( 1 );
    <span class="enscript-keyword">if</span>( 0 == array)
        <span class="enscript-keyword">return</span>( 0);

    <span class="enscript-keyword">for</span>( i = 0; i &lt; num; i++) {
        <span class="enscript-keyword">if</span>( IODTResolveAddressCell( parentEntry, reg, &amp;phys, &amp;len )) {
            range = 0;
            <span class="enscript-keyword">if</span>( parent)
                range = IODeviceMemory::withSubRange( parent,
                        phys - parent-&gt;getPhysicalSegment(0, 0, kIOMemoryMapperNone), len );
            <span class="enscript-keyword">if</span>( 0 == range)
                range = IODeviceMemory::withRange( phys, len );
            <span class="enscript-keyword">if</span>( range)
                array-&gt;setObject( range );
        }
        reg += cells;
    }

    regEntry-&gt;setProperty( gIODeviceMemoryKey, array);
    array-&gt;release();	<span class="enscript-comment">/* ??? */</span>

    <span class="enscript-keyword">return</span>( array);
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">IODTGetNVLocation</span>(
	IORegistryEntry * parent,
	IORegistryEntry * regEntry,
	UInt8 * busNum, UInt8 * deviceNum, UInt8 * functionNum )
{

    OSData			*prop;
    IODTPersistent	*persist;
    UInt32			*cell;

    prop = (OSData *) parent-&gt;getProperty( gIODTPersistKey );
    <span class="enscript-keyword">if</span>( prop) {
        persist = (IODTPersistent *) prop-&gt;getBytesNoCopy();
        (*persist-&gt;locationFunc)( regEntry, busNum, deviceNum, functionNum );
    } <span class="enscript-keyword">else</span> {
        prop = (OSData *) regEntry-&gt;getProperty( <span class="enscript-string">&quot;reg&quot;</span> );
        *functionNum	= 0;
        <span class="enscript-keyword">if</span>( prop) {
            cell = (UInt32 *) prop-&gt;getBytesNoCopy();
            *busNum 	= 3;
            *deviceNum 	= 0x1f &amp; (cell[ 0 ] &gt;&gt; 24);
        } <span class="enscript-keyword">else</span> {
            *busNum 	= 0;
            *deviceNum 	= 0;
        }
    }
    <span class="enscript-keyword">return</span>;
}

<span class="enscript-comment">/*
 * Try to make the same messed up descriptor as Mac OS
 */</span>

IOReturn <span class="enscript-function-name">IODTMakeNVDescriptor</span>( IORegistryEntry * regEntry,
				IONVRAMDescriptor * hdr )
{
    IORegistryEntry		*parent;
    UInt32				level;
    UInt32				bridgeDevices;
    UInt8				busNum;
    UInt8				deviceNum;
    UInt8				functionNum;

    hdr-&gt;format 	= 1;
    hdr-&gt;marker 	= 0;

    <span class="enscript-keyword">for</span>(level = 0, bridgeDevices = 0; 
    	(parent = regEntry-&gt;getParentEntry( gIODTPlane )) &amp;&amp; (level &lt; 7); level++ ) {

        IODTGetNVLocation( parent, regEntry,
			&amp;busNum, &amp;deviceNum, &amp;functionNum );
        <span class="enscript-keyword">if</span>( level)
            bridgeDevices |= ((deviceNum &amp; 0x1f) &lt;&lt; ((level - 1) * 5));
        <span class="enscript-keyword">else</span> {
            hdr-&gt;busNum 	= busNum;
            hdr-&gt;deviceNum 	= deviceNum;
            hdr-&gt;functionNum 	= functionNum;
        }
        regEntry = parent;
    }
    hdr-&gt;bridgeCount 	= level - 2;
    hdr-&gt;bridgeDevices 	= bridgeDevices;

    <span class="enscript-keyword">return</span>( kIOReturnSuccess );
}

OSData * <span class="enscript-function-name">IODTFindSlotName</span>( IORegistryEntry * regEntry, UInt32 deviceNumber )
{
    IORegistryEntry		*parent;
    OSData				*data;
    OSData				*ret = 0;
    UInt32				*bits;
    UInt32				i;
    size_t              nlen;
    <span class="enscript-type">char</span>				*names;
    <span class="enscript-type">char</span>				*lastName;
    UInt32				mask;

    data = (OSData *) regEntry-&gt;getProperty(<span class="enscript-string">&quot;AAPL,slot-name&quot;</span>);
    <span class="enscript-keyword">if</span>( data)
        <span class="enscript-keyword">return</span>( data);
    parent = regEntry-&gt;getParentEntry( gIODTPlane );
    <span class="enscript-keyword">if</span>( !parent)
        <span class="enscript-keyword">return</span>( 0 );
    data = OSDynamicCast( OSData, parent-&gt;getProperty(<span class="enscript-string">&quot;slot-names&quot;</span>));
    <span class="enscript-keyword">if</span>( !data)
        <span class="enscript-keyword">return</span>( 0 );
    <span class="enscript-keyword">if</span>( data-&gt;getLength() &lt;= 4)
        <span class="enscript-keyword">return</span>( 0 );

    bits = (UInt32 *) data-&gt;getBytesNoCopy();
    mask = *bits;
    <span class="enscript-keyword">if</span>( (0 == (mask &amp; (1 &lt;&lt; deviceNumber))))
        <span class="enscript-keyword">return</span>( 0 );

    names = (<span class="enscript-type">char</span> *)(bits + 1);
    lastName = names + (data-&gt;getLength() - 4);

    <span class="enscript-keyword">for</span>( i = 0; (i &lt;= deviceNumber) &amp;&amp; (names &lt; lastName); i++ ) {

        <span class="enscript-keyword">if</span>( mask &amp; (1 &lt;&lt; i)) {
            nlen = 1 + strnlen(names, lastName - names);
            <span class="enscript-keyword">if</span>( i == deviceNumber) {
                data = OSData::withBytesNoCopy(names, nlen);
                <span class="enscript-keyword">if</span>( data) {
                    regEntry-&gt;setProperty(<span class="enscript-string">&quot;AAPL,slot-name&quot;</span>, data);
                    ret = data;
                    data-&gt;release();
                }
            } <span class="enscript-keyword">else</span>
                names += nlen;
        }
    }

    <span class="enscript-keyword">return</span>( ret );
}

<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> IOReturn IONDRVLibrariesInitialize( IOService * provider )
{
    <span class="enscript-keyword">return</span>( kIOReturnUnsupported );
}
</pre>
<hr />
</body></html>