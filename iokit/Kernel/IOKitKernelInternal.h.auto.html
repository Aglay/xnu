<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>IOKitKernelInternal.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">IOKitKernelInternal.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 1998-2000 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>


#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_IOKIT_KERNELINTERNAL_H</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_IOKIT_KERNELINTERNAL_H</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/cdefs.h&gt;</span>

__BEGIN_DECLS

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/vm_pageout.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/memory_object_types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;device/device_port.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IODMACommand.h&gt;</span>

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

#<span class="enscript-reference">if</span> (<span class="enscript-variable-name">KDEBUG_LEVEL</span> &gt;= <span class="enscript-variable-name">KDEBUG_LEVEL_STANDARD</span>)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">IOServiceTrace</span>(csc, a, b, c, d) do {				\
    <span class="enscript-keyword">if</span>(kIOTraceIOService &amp; gIOKitDebug) {				\
	KERNEL_DEBUG_CONSTANT(IODBG_IOSERVICE(csc), a, b, c, d, 0);	\
    }									\
} <span class="enscript-keyword">while</span>(0)

#<span class="enscript-reference">else</span> <span class="enscript-comment">/* (KDEBUG_LEVEL &gt;= KDEBUG_LEVEL_STANDARD) */</span>

#<span class="enscript-reference">define</span> <span class="enscript-function-name">IOServiceTrace</span>(csc, a, b, c, d) do {	\
  (<span class="enscript-type">void</span>)a;					\
  (<span class="enscript-type">void</span>)b;					\
  (<span class="enscript-type">void</span>)c;					\
  (<span class="enscript-type">void</span>)d;					\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* (KDEBUG_LEVEL &gt;= KDEBUG_LEVEL_STANDARD) */</span>

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

<span class="enscript-type">typedef</span> <span class="enscript-function-name">kern_return_t</span> (*IOIteratePageableMapsCallback)(vm_map_t map, <span class="enscript-type">void</span> * ref);

<span class="enscript-type">void</span> <span class="enscript-function-name">IOLibInit</span>(<span class="enscript-type">void</span>);
kern_return_t <span class="enscript-function-name">IOIteratePageableMaps</span>(vm_size_t size,
                    IOIteratePageableMapsCallback callback, <span class="enscript-type">void</span> * ref);
vm_map_t <span class="enscript-function-name">IOPageableMapForAddress</span>(uintptr_t address);

<span class="enscript-type">struct</span> IOMemoryDescriptorMapAllocRef
{
    vm_map_t          map;
    mach_vm_address_t mapped;
    mach_vm_size_t    size;
    vm_prot_t         prot;
    vm_tag_t          tag;
    IOOptionBits      options;
};

kern_return_t 
<span class="enscript-function-name">IOMemoryDescriptorMapAlloc</span>(vm_map_t map, <span class="enscript-type">void</span> * ref);


mach_vm_address_t
<span class="enscript-function-name">IOKernelAllocateWithPhysicalRestrict</span>(mach_vm_size_t size, mach_vm_address_t maxPhys, 
			                mach_vm_size_t alignment, bool contiguous);
<span class="enscript-type">void</span>
<span class="enscript-function-name">IOKernelFreePhysical</span>(mach_vm_address_t address, mach_vm_size_t size);

<span class="enscript-type">extern</span> vm_size_t debug_iomallocpageable_size;

<span class="enscript-comment">// osfmk/device/iokit_rpc.c
</span><span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">IOMapPages</span>(vm_map_t map, mach_vm_address_t va, mach_vm_address_t pa,
                                 mach_vm_size_t length, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> mapFlags);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">IOUnmapPages</span>(vm_map_t map, mach_vm_address_t va, mach_vm_size_t length);

<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">IOProtectCacheMode</span>(vm_map_t map, mach_vm_address_t va,
					mach_vm_size_t length, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> mapFlags);

<span class="enscript-type">extern</span> ppnum_t <span class="enscript-function-name">IOGetLastPageNumber</span>(<span class="enscript-type">void</span>);

<span class="enscript-type">extern</span> ppnum_t gIOLastPage;

<span class="enscript-type">extern</span> IOSimpleLock * gIOPageAllocLock;
<span class="enscript-type">extern</span> queue_head_t   gIOPageAllocList;

<span class="enscript-comment">/* Physical to physical copy (ints must be disabled) */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">bcopy_phys</span>(addr64_t from, addr64_t to, vm_size_t size);

__END_DECLS

#<span class="enscript-reference">define</span> <span class="enscript-function-name">__IODEQUALIFY</span>(type, expr)       			\
   ({ typeof(expr) expr_ = (type)(uintptr_t)(expr);		\
       (type)(uintptr_t)(expr_); })


<span class="enscript-type">struct</span> IODMACommandInternal
{
    IOMDDMAWalkSegmentState      fState;
    IOMDDMACharacteristics       fMDSummary;

    UInt64 fPreparedOffset;
    UInt64 fPreparedLength;

    UInt32 fSourceAlignMask;
	
    UInt8  fCursor;
    UInt8  fCheckAddressing;
    UInt8  fIterateOnly;
    UInt8  fMisaligned;
    UInt8  fMapContig;
    UInt8  fPrepared;
    UInt8  fDoubleBuffer;
    UInt8  fNewMD;
    UInt8  fLocalMapper;
	
    vm_page_t fCopyPageAlloc;
    vm_page_t fCopyNext;
    vm_page_t fNextRemapPage;

    ppnum_t  fCopyPageCount;

    uint64_t  fLocalMapperAlloc;
    uint64_t  fLocalMapperAllocLength;

    class IOBufferMemoryDescriptor * fCopyMD;

    IOService * fDevice;

    <span class="enscript-comment">// IODMAEventSource use
</span>    IOReturn fStatus;
    UInt64   fActualByteCount;
    AbsoluteTime    fTimeStamp;
};

<span class="enscript-type">struct</span> IOMemoryDescriptorDevicePager {
    <span class="enscript-type">void</span> *		         devicePager;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>	     pagerContig:1;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>	     unused:31;
    IOMemoryDescriptor * memory;
};

<span class="enscript-type">struct</span> IOMemoryDescriptorReserved {
    IOMemoryDescriptorDevicePager dp;
    uint64_t                      preparationID;
    <span class="enscript-comment">// for kernel IOMD subclasses... they have no expansion
</span>    uint64_t                      kernReserved[4];
};

<span class="enscript-type">struct</span> iopa_t
{
    IOLock       * lock;
    queue_head_t   list;
    vm_size_t      pagecount;
    vm_size_t      bytecount;
};

<span class="enscript-type">struct</span> iopa_page_t
{
    queue_chain_t link;
    uint64_t      avail;
    uint32_t      signature;
};
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> iopa_page_t iopa_page_t;

<span class="enscript-type">typedef</span> <span class="enscript-function-name">uintptr_t</span> (*iopa_proc_t)(iopa_t * a);

<span class="enscript-type">enum</span>
{
    kIOPageAllocSignature  = 'iopa'
};

<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> <span class="enscript-type">void</span>      iopa_init(iopa_t * a);
<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> uintptr_t iopa_alloc(iopa_t * a, iopa_proc_t alloc, vm_size_t bytes, uint32_t balign);
<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> uintptr_t iopa_free(iopa_t * a, uintptr_t addr, vm_size_t bytes);
<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> uint32_t  gIOPageAllocChunkBytes;

<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> iopa_t    gIOBMDPageAllocator;

<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> <span class="enscript-type">struct</span> timeval gIOLastSleepTime;
<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> <span class="enscript-type">struct</span> timeval gIOLastWakeTime;

<span class="enscript-type">extern</span> clock_sec_t gIOConsoleLockTime;

<span class="enscript-type">extern</span> OSSet * gIORemoveOnReadProperties;

<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> <span class="enscript-type">void</span> IOKitInitializeTime( <span class="enscript-type">void</span> );

<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> OSString * IOCopyLogNameForPID(<span class="enscript-type">int</span> pid);

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__i386__</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__x86_64__</span>)
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">__cplusplus</span>
#<span class="enscript-reference">error</span> <span class="enscript-variable-name">xx</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-type">extern</span> <span class="enscript-type">const</span> OSSymbol * gIOCreateEFIDevicePathSymbol;
<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> <span class="enscript-type">void</span> IOSetKeyStoreData(IOMemoryDescriptor * data);
#<span class="enscript-reference">endif</span>
<span class="enscript-type">extern</span> <span class="enscript-type">const</span>  OSSymbol * gAKSGetKey;

<span class="enscript-type">void</span> <span class="enscript-function-name">IOScreenLockTimeUpdate</span>(clock_sec_t secs);

<span class="enscript-type">void</span>     <span class="enscript-function-name">IOCPUInitialize</span>(<span class="enscript-type">void</span>);
IOReturn <span class="enscript-function-name">IOInstallServicePlatformActions</span>(IOService * service);
IOReturn <span class="enscript-function-name">IORemoveServicePlatformActions</span>(IOService * service);

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* ! _IOKIT_KERNELINTERNAL_H */</span>
</pre>
<hr />
</body></html>