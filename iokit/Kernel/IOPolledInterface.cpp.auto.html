<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>IOPolledInterface.cpp</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">IOPolledInterface.cpp&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2006-2009 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/uio.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/conf.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOLib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOBSD.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOService.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOPlatformExpert.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOPolledInterface.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOHibernatePrivate.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOBufferMemoryDescriptor.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/AppleKeyStoreInterface.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;IOKitKernelInternal.h&quot;</span>


<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

<span class="enscript-function-name">OSDefineMetaClassAndAbstractStructors</span>(IOPolledInterface, OSObject);

<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOPolledInterface, 0);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOPolledInterface, 1);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOPolledInterface, 2);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOPolledInterface, 3);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOPolledInterface, 4);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOPolledInterface, 5);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOPolledInterface, 6);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOPolledInterface, 7);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOPolledInterface, 8);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOPolledInterface, 9);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOPolledInterface, 10);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOPolledInterface, 11);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOPolledInterface, 12);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOPolledInterface, 13);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOPolledInterface, 14);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOPolledInterface, 15);

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">kIOMediaPreferredBlockSizeKey</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIOMediaPreferredBlockSizeKey</span>	<span class="enscript-string">&quot;Preferred Block Size&quot;</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-type">enum</span> { kDefaultIOSize = 128*1024 };

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

<span class="enscript-type">class</span> IOPolledFilePollers : <span class="enscript-type">public</span> OSObject
{
    OSDeclareDefaultStructors(IOPolledFilePollers)

<span class="enscript-type">public</span>:
    IOService                * media;
    OSArray                  * pollers;
    IOBufferMemoryDescriptor * ioBuffer;
    <span class="enscript-type">bool</span>                 abortable;
    <span class="enscript-type">bool</span>                 io;
    IOReturn		 ioStatus;
    uint32_t             openCount;
    uint32_t             openState;

    <span class="enscript-type">static</span> IOPolledFilePollers * copyPollers(IOService * media);
};

<span class="enscript-function-name">OSDefineMetaClassAndStructors</span>(IOPolledFilePollers, OSObject)

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

IOPolledFilePollers *
<span class="enscript-function-name">IOPolledFilePollers::copyPollers</span>(IOService * media)
{
    IOPolledFilePollers * vars;
    IOReturn              err;
    IOService       * service;
    OSObject        * obj;
    IORegistryEntry * next;
    IORegistryEntry * child;

    <span class="enscript-keyword">if</span> ((obj = media-&gt;copyProperty(kIOPolledInterfaceStackKey)))
    {
	<span class="enscript-keyword">return</span> (OSDynamicCast(IOPolledFilePollers, obj));
    }

    <span class="enscript-keyword">do</span>
    {
	vars = OSTypeAlloc(IOPolledFilePollers);
	vars-&gt;init();

	vars-&gt;pollers = OSArray::withCapacity(4);
	<span class="enscript-keyword">if</span> (!vars-&gt;pollers)
	{
	    err = kIOReturnNoMemory;
	    <span class="enscript-keyword">break</span>;
	}

	next = vars-&gt;media = media;
	<span class="enscript-keyword">do</span>
	{
	    IOPolledInterface * poller;
	    OSObject *          obj;

	    obj = next-&gt;getProperty(kIOPolledInterfaceSupportKey);
	    <span class="enscript-keyword">if</span> (kOSBooleanFalse == obj)
	    {
		vars-&gt;pollers-&gt;flushCollection();
		<span class="enscript-keyword">break</span>;
	    }
	    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> ((poller = OSDynamicCast(IOPolledInterface, obj)))
		vars-&gt;pollers-&gt;setObject(poller);

	    <span class="enscript-keyword">if</span> ((service = OSDynamicCast(IOService, next)) 
		&amp;&amp; service-&gt;getDeviceMemory()
		&amp;&amp; !vars-&gt;pollers-&gt;getCount())	<span class="enscript-keyword">break</span>;

	    child = next;
	}
	<span class="enscript-keyword">while</span> ((next = child-&gt;getParentEntry(gIOServicePlane)) 
	       &amp;&amp; child-&gt;isParent(next, gIOServicePlane, true));

	<span class="enscript-keyword">if</span> (!vars-&gt;pollers-&gt;getCount())
	{
	    err = kIOReturnUnsupported;
	    <span class="enscript-keyword">break</span>;
	}
    }
    <span class="enscript-keyword">while</span> (false);

    media-&gt;setProperty(kIOPolledInterfaceStackKey, vars);

    <span class="enscript-keyword">return</span> (vars);
}

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

<span class="enscript-type">static</span> IOReturn 
<span class="enscript-function-name">IOPolledFilePollersIODone</span>(IOPolledFilePollers * vars, <span class="enscript-type">bool</span> abortable);

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

<span class="enscript-type">static</span> IOReturn
<span class="enscript-function-name">IOPolledFilePollersProbe</span>(IOPolledFilePollers * vars)
{
    IOReturn            err = kIOReturnError;
    int32_t		idx;
    IOPolledInterface * poller;

    <span class="enscript-keyword">for</span> (idx = vars-&gt;pollers-&gt;getCount() - 1; idx &gt;= 0; idx--)
    {
        poller = (IOPolledInterface *) vars-&gt;pollers-&gt;getObject(idx);
        err = poller-&gt;probe(vars-&gt;media);
        <span class="enscript-keyword">if</span> (err)
        {
            HIBLOG(<span class="enscript-string">&quot;IOPolledInterface::probe[%d] 0x%x\n&quot;</span>, idx, err);
            <span class="enscript-keyword">break</span>;
        }
    }

    <span class="enscript-keyword">return</span> (err);
}

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

IOReturn
<span class="enscript-function-name">IOPolledFilePollersOpen</span>(IOPolledFileIOVars * filevars, uint32_t state, <span class="enscript-type">bool</span> abortable)
{

    IOPolledFilePollers      * vars = filevars-&gt;pollers;
    IOBufferMemoryDescriptor * ioBuffer;
    IOPolledInterface        * poller;
    IOService                * next;
    IOReturn                   err = kIOReturnError;
    int32_t		       idx;

    vars-&gt;abortable = abortable;
    ioBuffer = 0;

    <span class="enscript-keyword">if</span> (kIOPolledAfterSleepState == state)
    {
        vars-&gt;ioStatus = 0;
	vars-&gt;io = false;
    }
    (<span class="enscript-type">void</span>) IOPolledFilePollersIODone(vars, false);

    <span class="enscript-keyword">if</span> ((kIOPolledPreflightState == state) || (kIOPolledPreflightCoreDumpState == state))
    {
        ioBuffer = vars-&gt;ioBuffer;
        <span class="enscript-keyword">if</span> (!ioBuffer)
        {
	    vars-&gt;ioBuffer = ioBuffer = IOBufferMemoryDescriptor::withOptions(kIODirectionInOut, 
							    2 * kDefaultIOSize, page_size);
	    <span class="enscript-keyword">if</span> (!ioBuffer) <span class="enscript-keyword">return</span> (kIOReturnNoMemory);
        }
    }

    <span class="enscript-keyword">for</span> (idx = vars-&gt;pollers-&gt;getCount() - 1; idx &gt;= 0; idx--)
    {
        poller = (IOPolledInterface *) vars-&gt;pollers-&gt;getObject(idx);
        err = poller-&gt;open(state, ioBuffer);
        <span class="enscript-keyword">if</span> ((kIOReturnSuccess != err) &amp;&amp; (kIOPolledPreflightCoreDumpState == state))
        {
	    err = poller-&gt;open(kIOPolledPreflightState, ioBuffer);
        }
        <span class="enscript-keyword">if</span> (kIOReturnSuccess != err)
        {
            HIBLOG(<span class="enscript-string">&quot;IOPolledInterface::open[%d] 0x%x\n&quot;</span>, idx, err);
            <span class="enscript-keyword">break</span>;
        }
    }
    <span class="enscript-keyword">if</span> (kIOReturnSuccess == err)
    {
        next = vars-&gt;media;
	<span class="enscript-keyword">while</span> (next)
	{
	    next-&gt;setProperty(kIOPolledInterfaceActiveKey, kOSBooleanTrue);
	    next = next-&gt;getProvider();
	}
    }

    <span class="enscript-keyword">return</span> (err);
}

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

IOReturn
<span class="enscript-function-name">IOPolledFilePollersClose</span>(IOPolledFileIOVars * filevars, uint32_t state)
{
    IOPolledFilePollers * vars = filevars-&gt;pollers;
    IOPolledInterface * poller;
    IORegistryEntry *   next;
    IOReturn            err;
    int32_t		idx;

    (<span class="enscript-type">void</span>) IOPolledFilePollersIODone(vars, false);

    <span class="enscript-keyword">if</span> (kIOPolledPostflightState == state)
    {
	vars-&gt;openCount--;
	<span class="enscript-keyword">if</span> (vars-&gt;openCount) 
	{
	    <span class="enscript-comment">// 21207427
</span>            IOPolledFilePollersOpen(filevars, vars-&gt;openState, vars-&gt;abortable);
	    <span class="enscript-keyword">return</span> (kIOReturnSuccess);
	}
    }

    <span class="enscript-keyword">for</span> (idx = 0, err = kIOReturnSuccess;
         (poller = (IOPolledInterface *) vars-&gt;pollers-&gt;getObject(idx));
         idx++)
    {
        err = poller-&gt;close(state);
        <span class="enscript-keyword">if</span> (err) HIBLOG(<span class="enscript-string">&quot;IOPolledInterface::close[%d] 0x%x\n&quot;</span>, idx, err);
    }

    <span class="enscript-keyword">if</span> (kIOPolledPostflightState == state)
    {   
	next = vars-&gt;media;
	<span class="enscript-keyword">while</span> (next)
	{
	    next-&gt;removeProperty(kIOPolledInterfaceActiveKey);
	    next = next-&gt;getParentEntry(gIOServicePlane);
	}

	<span class="enscript-keyword">if</span> (vars-&gt;ioBuffer)
	{
	    vars-&gt;ioBuffer-&gt;release();
	    vars-&gt;ioBuffer = 0;
	}
    }
    <span class="enscript-keyword">return</span> (err);
}
<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

IOMemoryDescriptor *
<span class="enscript-function-name">IOPolledFileGetIOBuffer</span>(IOPolledFileIOVars * vars)
{
    <span class="enscript-keyword">return</span> (vars-&gt;pollers-&gt;ioBuffer);
}

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

<span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">IOPolledIOComplete</span>(<span class="enscript-type">void</span> *   target,
		   <span class="enscript-type">void</span> *   parameter,
		   IOReturn status,
		   UInt64   actualByteCount)
{
    IOPolledFilePollers * vars = (IOPolledFilePollers *) parameter;

    vars-&gt;ioStatus = status;
}

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

<span class="enscript-type">static</span> IOReturn
<span class="enscript-function-name">IOStartPolledIO</span>(IOPolledFilePollers * vars, 
                    uint32_t operation, uint32_t bufferOffset, 
		    uint64_t deviceOffset, uint64_t length)
{
    IOReturn            err;
    IOPolledInterface * poller;
    IOPolledCompletion  completion;

    err = vars-&gt;ioStatus;
    <span class="enscript-keyword">if</span> (kIOReturnSuccess != err) <span class="enscript-keyword">return</span> (err);

    completion.target    = 0;
    completion.action    = &amp;IOPolledIOComplete;
    completion.parameter = vars;

    vars-&gt;ioStatus = -1;

    poller = (IOPolledInterface *) vars-&gt;pollers-&gt;getObject(0);
    err = poller-&gt;startIO(operation, bufferOffset, deviceOffset, length, completion);
    <span class="enscript-keyword">if</span> (err)
        HIBLOG(<span class="enscript-string">&quot;IOPolledInterface::startIO[%d] 0x%x\n&quot;</span>, 0, err);

    <span class="enscript-keyword">return</span> (err);
}

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

<span class="enscript-type">static</span> IOReturn
<span class="enscript-function-name">IOPolledFilePollersIODone</span>(IOPolledFilePollers * vars, <span class="enscript-type">bool</span> abortable)
{
    IOReturn            err = kIOReturnSuccess;
    int32_t		idx = 0;
    IOPolledInterface * poller;
    AbsoluteTime        deadline;

    <span class="enscript-keyword">if</span> (!vars-&gt;io) <span class="enscript-keyword">return</span> (kIOReturnSuccess);

    abortable &amp;= vars-&gt;abortable;

    clock_interval_to_deadline(2000, kMillisecondScale, &amp;deadline);

    <span class="enscript-keyword">while</span> (-1 == vars-&gt;ioStatus)
    {
        <span class="enscript-keyword">for</span> (idx = 0; 
	    (poller = (IOPolledInterface *) vars-&gt;pollers-&gt;getObject(idx));
             idx++)
        {
	    IOReturn newErr;
            newErr = poller-&gt;checkForWork();
	    <span class="enscript-keyword">if</span> ((newErr == kIOReturnAborted) &amp;&amp; !abortable)
		newErr = kIOReturnSuccess;
	    <span class="enscript-keyword">if</span> (kIOReturnSuccess == err)
		err = newErr;
        }
        <span class="enscript-keyword">if</span> ((false) &amp;&amp; (kIOReturnSuccess == err) &amp;&amp; (mach_absolute_time() &gt; AbsoluteTime_to_scalar(&amp;deadline)))
    	{
	    HIBLOG(<span class="enscript-string">&quot;IOPolledInterface::forced timeout\n&quot;</span>);
	    vars-&gt;ioStatus = kIOReturnTimeout;
    	}
    }
    vars-&gt;io = false;

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">HIBERNATION</span>
    <span class="enscript-keyword">if</span> ((kIOReturnSuccess == err) &amp;&amp; abortable &amp;&amp; hibernate_should_abort())
    {
        err = kIOReturnAborted;
	HIBLOG(<span class="enscript-string">&quot;IOPolledInterface::checkForWork sw abort\n&quot;</span>);
    }
#<span class="enscript-reference">endif</span>

    <span class="enscript-keyword">if</span> (err)
    {
	HIBLOG(<span class="enscript-string">&quot;IOPolledInterface::checkForWork[%d] 0x%x\n&quot;</span>, idx, err);
    }
    <span class="enscript-keyword">else</span> 
    {
	err = vars-&gt;ioStatus;
	<span class="enscript-keyword">if</span> (kIOReturnSuccess != err) HIBLOG(<span class="enscript-string">&quot;IOPolledInterface::ioStatus 0x%x\n&quot;</span>, err);
    }

    <span class="enscript-keyword">return</span> (err);
}

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>
<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

<span class="enscript-type">struct</span> _OpenFileContext
{
    OSData * extents;
    uint64_t size;
};

<span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">file_extent_callback</span>(<span class="enscript-type">void</span> * ref, uint64_t start, uint64_t length)
{
    _OpenFileContext * ctx = (_OpenFileContext *) ref;
    IOPolledFileExtent extent;

    extent.start  = start;
    extent.length = length;
    ctx-&gt;extents-&gt;appendBytes(&amp;extent, <span class="enscript-keyword">sizeof</span>(extent));
    ctx-&gt;size += length;
}

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

<span class="enscript-type">static</span> IOService * 
<span class="enscript-function-name">IOCopyMediaForDev</span>(dev_t device)
{
    OSDictionary * matching;
    OSNumber *     num;
    OSIterator *   iter;
    IOService *    result = 0;

    matching = IOService::serviceMatching(<span class="enscript-string">&quot;IOMedia&quot;</span>);
    <span class="enscript-keyword">if</span> (!matching)
        <span class="enscript-keyword">return</span> (0);
    <span class="enscript-keyword">do</span>
    {
        num = OSNumber::withNumber(major(device), 32);
        <span class="enscript-keyword">if</span> (!num)
            <span class="enscript-keyword">break</span>;
        matching-&gt;setObject(kIOBSDMajorKey, num);
        num-&gt;release();
        num = OSNumber::withNumber(minor(device), 32);
        <span class="enscript-keyword">if</span> (!num)
            <span class="enscript-keyword">break</span>;
        matching-&gt;setObject(kIOBSDMinorKey, num);
        num-&gt;release();
        <span class="enscript-keyword">if</span> (!num)
            <span class="enscript-keyword">break</span>;
        iter = IOService::getMatchingServices(matching);
        <span class="enscript-keyword">if</span> (iter)
        {
            result = (IOService *) iter-&gt;getNextObject();
            result-&gt;retain();
            iter-&gt;release();
        }
    }
    <span class="enscript-keyword">while</span> (false);
    matching-&gt;release();

    <span class="enscript-keyword">return</span> (result);
}

<span class="enscript-type">static</span> IOReturn 
<span class="enscript-function-name">IOGetVolumeCryptKey</span>(dev_t block_dev,  OSString ** pKeyUUID, 
		    uint8_t * volumeCryptKey, size_t keySize)
{
    IOReturn         err;
    IOService *      part;
    OSString *       keyUUID = 0;
    OSString *       keyStoreUUID = 0;
    uuid_t           volumeKeyUUID;
    aks_volume_key_t vek;

    <span class="enscript-type">static</span> IOService * sKeyStore;

    part = IOCopyMediaForDev(block_dev);
    <span class="enscript-keyword">if</span> (!part) <span class="enscript-keyword">return</span> (kIOReturnNotFound);

    err = part-&gt;callPlatformFunction(PLATFORM_FUNCTION_GET_MEDIA_ENCRYPTION_KEY_UUID, false, 
				      (<span class="enscript-type">void</span> *) &amp;keyUUID, (<span class="enscript-type">void</span> *) &amp;keyStoreUUID, NULL, NULL);
    <span class="enscript-keyword">if</span> ((kIOReturnSuccess == err) &amp;&amp; keyUUID &amp;&amp; keyStoreUUID)
    {
<span class="enscript-comment">//            IOLog(&quot;got volume key %s\n&quot;, keyStoreUUID-&gt;getCStringNoCopy());
</span>
	<span class="enscript-keyword">if</span> (!sKeyStore)
	    sKeyStore = (IOService *) IORegistryEntry::fromPath(AKS_SERVICE_PATH, gIOServicePlane);
	<span class="enscript-keyword">if</span> (sKeyStore)
	    err = uuid_parse(keyStoreUUID-&gt;getCStringNoCopy(), volumeKeyUUID);
	<span class="enscript-keyword">else</span>
	    err = kIOReturnNoResources;
	<span class="enscript-keyword">if</span> (kIOReturnSuccess == err)    
	    err = sKeyStore-&gt;callPlatformFunction(gAKSGetKey, true, volumeKeyUUID, &amp;vek, NULL, NULL);
	<span class="enscript-keyword">if</span> (kIOReturnSuccess != err)    
	    IOLog(<span class="enscript-string">&quot;volume key err 0x%x\n&quot;</span>, err);
	<span class="enscript-keyword">else</span>
	{
	    <span class="enscript-keyword">if</span> (vek.key.keybytecount &lt; keySize) keySize = vek.key.keybytecount;
	    bcopy(&amp;vek.key.keybytes[0], volumeCryptKey, keySize);
	}
	bzero(&amp;vek, <span class="enscript-keyword">sizeof</span>(vek));

    }
    part-&gt;release();
    <span class="enscript-keyword">if</span> (pKeyUUID) *pKeyUUID = keyUUID;

    <span class="enscript-keyword">return</span> (err);
}

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

IOReturn
<span class="enscript-function-name">IOPolledFileOpen</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> * filename,
		 uint64_t setFileSize, uint64_t fsFreeSize,
		 <span class="enscript-type">void</span> * write_file_addr, size_t write_file_len,
		 IOPolledFileIOVars ** fileVars,
		 OSData ** imagePath,
		 uint8_t * volumeCryptKey, size_t keySize)
{
    IOReturn             err = kIOReturnSuccess;
    IOPolledFileIOVars * vars;
    _OpenFileContext     ctx;
    OSData *             extentsData;
    OSNumber *           num;
    IOService *          part = 0;
    dev_t                block_dev;
    dev_t                image_dev;
    AbsoluteTime         startTime, endTime;
    uint64_t             nsec;

    vars = IONew(IOPolledFileIOVars, 1);
    <span class="enscript-keyword">if</span> (!vars) <span class="enscript-keyword">return</span> (kIOReturnNoMemory);
    bzero(vars, <span class="enscript-keyword">sizeof</span>(*vars));
    vars-&gt;allocated = true;

    <span class="enscript-keyword">do</span>
    {
    	extentsData = OSData::withCapacity(32);
   	ctx.extents = extentsData;
	ctx.size    = 0;
	clock_get_uptime(&amp;startTime);

	vars-&gt;fileRef = kern_open_file_for_direct_io(filename, 
                                                     (write_file_addr != NULL) || (0 != setFileSize),
						     &amp;file_extent_callback, &amp;ctx, 
						     setFileSize,
						     fsFreeSize,
						     <span class="enscript-comment">// write file:
</span>                                                     0, write_file_addr, write_file_len,
                                                     <span class="enscript-comment">// results
</span>						     &amp;block_dev,
						     &amp;image_dev,
                                                     &amp;vars-&gt;block0,
                                                     &amp;vars-&gt;maxiobytes,
                                                     &amp;vars-&gt;flags);
#<span class="enscript-reference">if</span> 0
	uint32_t msDelay = (131071 &amp; random());
	HIBLOG(<span class="enscript-string">&quot;sleep %d\n&quot;</span>, msDelay);
	IOSleep(msDelay);
#<span class="enscript-reference">endif</span>
        clock_get_uptime(&amp;endTime);
        SUB_ABSOLUTETIME(&amp;endTime, &amp;startTime);
        absolutetime_to_nanoseconds(endTime, &amp;nsec);

	<span class="enscript-keyword">if</span> (!vars-&gt;fileRef) err = kIOReturnNoSpace;

        HIBLOG(<span class="enscript-string">&quot;kern_open_file_for_direct_io took %qd ms\n&quot;</span>, nsec / 1000000ULL);
	<span class="enscript-keyword">if</span> (kIOReturnSuccess != err) <span class="enscript-keyword">break</span>;

	HIBLOG(<span class="enscript-string">&quot;Opened file %s, size %qd, extents %ld, maxio %qx ssd %d\n&quot;</span>, filename, ctx.size, 
                    (extentsData-&gt;getLength() / <span class="enscript-keyword">sizeof</span>(IOPolledFileExtent)) - 1,
                    vars-&gt;maxiobytes, kIOPolledFileSSD &amp; vars-&gt;flags);
	assert(!vars-&gt;block0);
	<span class="enscript-keyword">if</span> (extentsData-&gt;getLength() &lt; <span class="enscript-keyword">sizeof</span>(IOPolledFileExtent))
	{
	    err = kIOReturnNoSpace;
	    <span class="enscript-keyword">break</span>;
	}

	vars-&gt;fileSize = ctx.size;
	vars-&gt;extentMap = (IOPolledFileExtent *) extentsData-&gt;getBytesNoCopy();

        part = IOCopyMediaForDev(image_dev);
        <span class="enscript-keyword">if</span> (!part)
        {
            err = kIOReturnNotFound;
            <span class="enscript-keyword">break</span>;
	}

	<span class="enscript-keyword">if</span> (!(vars-&gt;pollers = IOPolledFilePollers::copyPollers(part))) <span class="enscript-keyword">break</span>;

	<span class="enscript-keyword">if</span> ((num = OSDynamicCast(OSNumber, part-&gt;getProperty(kIOMediaPreferredBlockSizeKey))))
               vars-&gt;blockSize = num-&gt;unsigned32BitValue();
	<span class="enscript-keyword">if</span> (vars-&gt;blockSize &lt; 4096) vars-&gt;blockSize = 4096;

        HIBLOG(<span class="enscript-string">&quot;polled file major %d, minor %d, blocksize %ld, pollers %d\n&quot;</span>,
               major(image_dev), minor(image_dev), (<span class="enscript-type">long</span>)vars-&gt;blockSize, 
               vars-&gt;pollers-&gt;pollers-&gt;getCount());

        OSString * keyUUID = NULL;
        <span class="enscript-keyword">if</span> (volumeCryptKey)
        {
            err = IOGetVolumeCryptKey(block_dev, &amp;keyUUID, volumeCryptKey, keySize);
        }

	*fileVars    = vars;
	vars-&gt;fileExtents = extentsData;
    
	<span class="enscript-comment">// make imagePath
</span>	OSData * data;
	<span class="enscript-keyword">if</span> (imagePath)
	{
#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__i386__</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__x86_64__</span>)
	    <span class="enscript-type">char</span> str2[24 + <span class="enscript-keyword">sizeof</span>(uuid_string_t) + 2];

            <span class="enscript-keyword">if</span> (keyUUID)
                snprintf(str2, <span class="enscript-keyword">sizeof</span>(str2), <span class="enscript-string">&quot;%qx:%s&quot;</span>, 
                                vars-&gt;extentMap[0].start, keyUUID-&gt;getCStringNoCopy());
            <span class="enscript-keyword">else</span>
                snprintf(str2, <span class="enscript-keyword">sizeof</span>(str2), <span class="enscript-string">&quot;%qx&quot;</span>, vars-&gt;extentMap[0].start);

	    err = IOService::getPlatform()-&gt;callPlatformFunction(
						gIOCreateEFIDevicePathSymbol, false,
						(<span class="enscript-type">void</span> *) part, (<span class="enscript-type">void</span> *) str2,
						(<span class="enscript-type">void</span> *) (uintptr_t) true, (<span class="enscript-type">void</span> *) &amp;data);
#<span class="enscript-reference">else</span>
	    data = 0;
	    err = kIOReturnSuccess;
#<span class="enscript-reference">endif</span>
	    <span class="enscript-keyword">if</span> (kIOReturnSuccess != err)
	    {
		HIBLOG(<span class="enscript-string">&quot;error 0x%x getting path\n&quot;</span>, err);
		<span class="enscript-keyword">break</span>;
	    }
	    *imagePath = data;
	}
    }
    <span class="enscript-keyword">while</span> (false);

    <span class="enscript-keyword">if</span> (kIOReturnSuccess != err)
    {
        HIBLOG(<span class="enscript-string">&quot;error 0x%x opening polled file\n&quot;</span>, err);
    	IOPolledFileClose(&amp;vars, 0, 0, 0, 0, 0);
    }

    <span class="enscript-keyword">if</span> (part) part-&gt;release();

    <span class="enscript-keyword">return</span> (err);
}

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

IOReturn
<span class="enscript-function-name">IOPolledFileClose</span>(IOPolledFileIOVars ** pVars,
		  off_t write_offset, <span class="enscript-type">void</span> * addr, size_t write_length,
		  off_t discard_offset, off_t discard_end)
{
    IOPolledFileIOVars * vars;

    vars = *pVars;
    <span class="enscript-keyword">if</span> (!vars) <span class="enscript-keyword">return</span>(kIOReturnSuccess);

    <span class="enscript-keyword">if</span> (vars-&gt;fileRef)
    {
	kern_close_file_for_direct_io(vars-&gt;fileRef, write_offset, addr, write_length, 
				      discard_offset, discard_end);
	vars-&gt;fileRef = NULL;
    }
    <span class="enscript-keyword">if</span> (vars-&gt;fileExtents) 
    {
    	vars-&gt;fileExtents-&gt;release();
    	vars-&gt;fileExtents = 0;
    }
    <span class="enscript-keyword">if</span> (vars-&gt;pollers) 
    {
    	vars-&gt;pollers-&gt;release();
    	vars-&gt;pollers = 0;
    }

    <span class="enscript-keyword">if</span> (vars-&gt;allocated) IODelete(vars, IOPolledFileIOVars, 1);
    <span class="enscript-keyword">else</span>                 bzero(vars, <span class="enscript-keyword">sizeof</span>(IOPolledFileIOVars));
    *pVars = NULL;

    <span class="enscript-keyword">return</span> (kIOReturnSuccess);
}

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

IOReturn
<span class="enscript-function-name">IOPolledFilePollersSetup</span>(IOPolledFileIOVars * vars,
		         uint32_t openState)
{
    IOReturn err;

    err = kIOReturnSuccess;
    <span class="enscript-keyword">do</span>
    {
        <span class="enscript-keyword">if</span> (!vars-&gt;pollers-&gt;openCount)
        {
	    err = IOPolledFilePollersProbe(vars-&gt;pollers);
	    <span class="enscript-keyword">if</span> (kIOReturnSuccess != err) <span class="enscript-keyword">break</span>;
	    err = IOPolledFilePollersOpen(vars, openState, false);
	    <span class="enscript-keyword">if</span> (kIOReturnSuccess != err) <span class="enscript-keyword">break</span>;
	    vars-&gt;pollers-&gt;openState = openState;
	}
	vars-&gt;pollers-&gt;openCount++;
	vars-&gt;pollers-&gt;io  = false;
	vars-&gt;buffer       = (uint8_t *) vars-&gt;pollers-&gt;ioBuffer-&gt;getBytesNoCopy();
	vars-&gt;bufferHalf   = 0;
	vars-&gt;bufferOffset = 0;
	vars-&gt;bufferSize   = (vars-&gt;pollers-&gt;ioBuffer-&gt;getLength() &gt;&gt; 1);

        <span class="enscript-keyword">if</span> (vars-&gt;maxiobytes &lt; vars-&gt;bufferSize) vars-&gt;bufferSize = vars-&gt;maxiobytes;
    }
    <span class="enscript-keyword">while</span> (false);

    <span class="enscript-keyword">if</span> (kIOReturnSuccess != err) HIBLOG(<span class="enscript-string">&quot;IOPolledFilePollersSetup(%d) error 0x%x\n&quot;</span>, openState, err);

    <span class="enscript-keyword">return</span> (err);
}


<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

IOReturn
<span class="enscript-function-name">IOPolledFileSeek</span>(IOPolledFileIOVars * vars, uint64_t position)
{
    IOPolledFileExtent * extentMap;

    extentMap = vars-&gt;extentMap;

    vars-&gt;position = position;

    <span class="enscript-keyword">while</span> (position &gt;= extentMap-&gt;length)
    {
	position -= extentMap-&gt;length;
	extentMap++;
    }

    vars-&gt;currentExtent   = extentMap;
    vars-&gt;extentRemaining = extentMap-&gt;length - position;
    vars-&gt;extentPosition  = vars-&gt;position - position;

    <span class="enscript-keyword">if</span> (vars-&gt;bufferSize &lt;= vars-&gt;extentRemaining)
	vars-&gt;bufferLimit = vars-&gt;bufferSize;
    <span class="enscript-keyword">else</span>
	vars-&gt;bufferLimit = vars-&gt;extentRemaining;

    <span class="enscript-keyword">return</span> (kIOReturnSuccess);
}

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

IOReturn
<span class="enscript-function-name">IOPolledFileWrite</span>(IOPolledFileIOVars * vars,
                    <span class="enscript-type">const</span> uint8_t * bytes, IOByteCount size,
                    IOPolledFileCryptVars * cryptvars)
{
    IOReturn    err = kIOReturnSuccess;
    IOByteCount copy;
    <span class="enscript-type">bool</span>	flush = false;

    <span class="enscript-keyword">do</span>
    {
	<span class="enscript-keyword">if</span> (!bytes &amp;&amp; !size)
	{
	    <span class="enscript-comment">// seek to end of block &amp; flush
</span>	    size = vars-&gt;position &amp; (vars-&gt;blockSize - 1);
	    <span class="enscript-keyword">if</span> (size)
		size = vars-&gt;blockSize - size;
	    flush = true;
            <span class="enscript-comment">// use some garbage for the fill
</span>            bytes = vars-&gt;buffer + vars-&gt;bufferOffset;
	}

	copy = vars-&gt;bufferLimit - vars-&gt;bufferOffset;
	<span class="enscript-keyword">if</span> (copy &gt; size)
	    copy = size;
	<span class="enscript-keyword">else</span>
	    flush = true;

	<span class="enscript-keyword">if</span> (bytes)
	{
	    bcopy(bytes, vars-&gt;buffer + vars-&gt;bufferHalf + vars-&gt;bufferOffset, copy);
	    bytes += copy;
	}
        <span class="enscript-keyword">else</span>
	    bzero(vars-&gt;buffer + vars-&gt;bufferHalf + vars-&gt;bufferOffset, copy);
        
	size -= copy;
	vars-&gt;bufferOffset += copy;
	vars-&gt;position += copy;

	<span class="enscript-keyword">if</span> (flush &amp;&amp; vars-&gt;bufferOffset)
	{
	    uint64_t offset = (vars-&gt;position - vars-&gt;bufferOffset 
				- vars-&gt;extentPosition + vars-&gt;currentExtent-&gt;start);
	    uint32_t length = (vars-&gt;bufferOffset);

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CRYPTO</span>
            <span class="enscript-keyword">if</span> (cryptvars &amp;&amp; vars-&gt;encryptStart
                &amp;&amp; (vars-&gt;position &gt; vars-&gt;encryptStart)
                &amp;&amp; ((vars-&gt;position - length) &lt; vars-&gt;encryptEnd))
            {
                AbsoluteTime startTime, endTime;

                uint64_t encryptLen, encryptStart;
                encryptLen = vars-&gt;position - vars-&gt;encryptStart;
                <span class="enscript-keyword">if</span> (encryptLen &gt; length)
                    encryptLen = length;
                encryptStart = length - encryptLen;
                <span class="enscript-keyword">if</span> (vars-&gt;position &gt; vars-&gt;encryptEnd)
                    encryptLen -= (vars-&gt;position - vars-&gt;encryptEnd);

                clock_get_uptime(&amp;startTime);

                <span class="enscript-comment">// encrypt the buffer
</span>                aes_encrypt_cbc(vars-&gt;buffer + vars-&gt;bufferHalf + encryptStart,
                                &amp;cryptvars-&gt;aes_iv[0],
                                encryptLen / AES_BLOCK_SIZE,
                                vars-&gt;buffer + vars-&gt;bufferHalf + encryptStart,
                                &amp;cryptvars-&gt;ctx.encrypt);
    
                clock_get_uptime(&amp;endTime);
                ADD_ABSOLUTETIME(&amp;vars-&gt;cryptTime, &amp;endTime);
                SUB_ABSOLUTETIME(&amp;vars-&gt;cryptTime, &amp;startTime);
                vars-&gt;cryptBytes += encryptLen;

                <span class="enscript-comment">// save initial vector for following encrypts
</span>                bcopy(vars-&gt;buffer + vars-&gt;bufferHalf + encryptStart + encryptLen - AES_BLOCK_SIZE,
                        &amp;cryptvars-&gt;aes_iv[0],
                        AES_BLOCK_SIZE);
            }
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CRYPTO */</span>

	    err = IOPolledFilePollersIODone(vars-&gt;pollers, true);
	    <span class="enscript-keyword">if</span> (kIOReturnSuccess != err)
		<span class="enscript-keyword">break</span>;

<span class="enscript-function-name">if</span> (vars-&gt;position &amp; (vars-&gt;blockSize - 1)) HIBLOG(<span class="enscript-string">&quot;misaligned file pos %qx\n&quot;</span>, vars-&gt;position);
<span class="enscript-comment">//if (length != vars-&gt;bufferSize) HIBLOG(&quot;short write of %qx ends@ %qx\n&quot;, length, offset + length);
</span>
	    err = IOStartPolledIO(vars-&gt;pollers, kIOPolledWrite, vars-&gt;bufferHalf, offset, length);
            <span class="enscript-keyword">if</span> (kIOReturnSuccess != err)
                <span class="enscript-keyword">break</span>;
	    vars-&gt;pollers-&gt;io = true;

	    vars-&gt;extentRemaining -= vars-&gt;bufferOffset;
	    <span class="enscript-keyword">if</span> (!vars-&gt;extentRemaining)
	    {
		vars-&gt;currentExtent++;
		vars-&gt;extentRemaining = vars-&gt;currentExtent-&gt;length;
		vars-&gt;extentPosition  = vars-&gt;position;
	    }

	    vars-&gt;bufferHalf = vars-&gt;bufferHalf ? 0 : vars-&gt;bufferSize;
	    vars-&gt;bufferOffset = 0;
	    <span class="enscript-keyword">if</span> (vars-&gt;bufferSize &lt;= vars-&gt;extentRemaining)
		vars-&gt;bufferLimit = vars-&gt;bufferSize;
	    <span class="enscript-keyword">else</span>
		vars-&gt;bufferLimit = vars-&gt;extentRemaining;

	    <span class="enscript-keyword">if</span> (!vars-&gt;extentRemaining)
	    {
		err = kIOReturnOverrun;
		<span class="enscript-keyword">break</span>;
	    }

	    flush = false;
	}
    }
    <span class="enscript-keyword">while</span> (size);

    <span class="enscript-keyword">return</span> (err);
}

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

IOReturn
<span class="enscript-function-name">IOPolledFileRead</span>(IOPolledFileIOVars * vars,
                    uint8_t * bytes, IOByteCount size,
                    IOPolledFileCryptVars * cryptvars)
{
    IOReturn    err = kIOReturnSuccess;
    IOByteCount copy;

<span class="enscript-comment">//    bytesWritten += size;
</span>
    <span class="enscript-keyword">do</span>
    {
	copy = vars-&gt;bufferLimit - vars-&gt;bufferOffset;
	<span class="enscript-keyword">if</span> (copy &gt; size)
	    copy = size;

	<span class="enscript-keyword">if</span> (bytes)
	{
	    bcopy(vars-&gt;buffer + vars-&gt;bufferHalf + vars-&gt;bufferOffset, bytes, copy);
	    bytes += copy;
	}
	size -= copy;
	vars-&gt;bufferOffset += copy;
<span class="enscript-comment">//	vars-&gt;position += copy;
</span>
	<span class="enscript-keyword">if</span> ((vars-&gt;bufferOffset == vars-&gt;bufferLimit) &amp;&amp; (vars-&gt;position &lt; vars-&gt;readEnd))
	{
	    <span class="enscript-keyword">if</span> (!vars-&gt;pollers-&gt;io) cryptvars = 0;
	    err = IOPolledFilePollersIODone(vars-&gt;pollers, true);
	    <span class="enscript-keyword">if</span> (kIOReturnSuccess != err)
		<span class="enscript-keyword">break</span>;

<span class="enscript-function-name">if</span> (vars-&gt;position &amp; (vars-&gt;blockSize - 1)) HIBLOG(<span class="enscript-string">&quot;misaligned file pos %qx\n&quot;</span>, vars-&gt;position);

	    vars-&gt;position        += vars-&gt;lastRead;
	    vars-&gt;extentRemaining -= vars-&gt;lastRead;
	    vars-&gt;bufferLimit      = vars-&gt;lastRead;

	    <span class="enscript-keyword">if</span> (!vars-&gt;extentRemaining)
	    {
		vars-&gt;currentExtent++;
		vars-&gt;extentRemaining = vars-&gt;currentExtent-&gt;length;
		vars-&gt;extentPosition  = vars-&gt;position;
                <span class="enscript-keyword">if</span> (!vars-&gt;extentRemaining)
                {
                    err = kIOReturnOverrun;
                    <span class="enscript-keyword">break</span>;
                }
	    }

	    uint64_t length;
	    uint64_t lastReadLength = vars-&gt;lastRead;
	    uint64_t offset = (vars-&gt;position 
				- vars-&gt;extentPosition + vars-&gt;currentExtent-&gt;start);
	    <span class="enscript-keyword">if</span> (vars-&gt;extentRemaining &lt;= vars-&gt;bufferSize)
		length = vars-&gt;extentRemaining;
	    <span class="enscript-keyword">else</span>
		length = vars-&gt;bufferSize;
	    <span class="enscript-keyword">if</span> ((length + vars-&gt;position) &gt; vars-&gt;readEnd)
	    	length = vars-&gt;readEnd - vars-&gt;position;

	    vars-&gt;lastRead = length;
	    <span class="enscript-keyword">if</span> (length)
	    {
<span class="enscript-comment">//if (length != vars-&gt;bufferSize) HIBLOG(&quot;short read of %qx ends@ %qx\n&quot;, length, offset + length);
</span>		err = IOStartPolledIO(vars-&gt;pollers, kIOPolledRead, vars-&gt;bufferHalf, offset, length);
		<span class="enscript-keyword">if</span> (kIOReturnSuccess != err)
		    <span class="enscript-keyword">break</span>;
		vars-&gt;pollers-&gt;io = true;
	    }

	    vars-&gt;bufferHalf = vars-&gt;bufferHalf ? 0 : vars-&gt;bufferSize;
	    vars-&gt;bufferOffset = 0;

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CRYPTO</span>
            <span class="enscript-keyword">if</span> (cryptvars)
            {
                uint8_t thisVector[AES_BLOCK_SIZE];
                AbsoluteTime startTime, endTime;

                <span class="enscript-comment">// save initial vector for following decrypts
</span>                bcopy(&amp;cryptvars-&gt;aes_iv[0], &amp;thisVector[0], AES_BLOCK_SIZE);
                bcopy(vars-&gt;buffer + vars-&gt;bufferHalf + lastReadLength - AES_BLOCK_SIZE, 
                        &amp;cryptvars-&gt;aes_iv[0], AES_BLOCK_SIZE);

                <span class="enscript-comment">// decrypt the buffer
</span>                clock_get_uptime(&amp;startTime);

                aes_decrypt_cbc(vars-&gt;buffer + vars-&gt;bufferHalf,
                                &amp;thisVector[0],
                                lastReadLength / AES_BLOCK_SIZE,
                                vars-&gt;buffer + vars-&gt;bufferHalf,
                                &amp;cryptvars-&gt;ctx.decrypt);

                clock_get_uptime(&amp;endTime);
                ADD_ABSOLUTETIME(&amp;vars-&gt;cryptTime, &amp;endTime);
                SUB_ABSOLUTETIME(&amp;vars-&gt;cryptTime, &amp;startTime);
                vars-&gt;cryptBytes += lastReadLength;
            }
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CRYPTO */</span>
	}
    }
    <span class="enscript-keyword">while</span> (size);

    <span class="enscript-keyword">return</span> (err);
}

<span class="enscript-comment">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span>

</pre>
<hr />
</body></html>