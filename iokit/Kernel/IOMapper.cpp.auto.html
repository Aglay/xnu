<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>IOMapper.cpp</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">IOMapper.cpp&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 1998-2004 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOLib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOMapper.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IODMACommand.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSData.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/OSDebug.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;IOKitKernelInternal.h&quot;</span>

__BEGIN_DECLS
<span class="enscript-type">extern</span> ppnum_t <span class="enscript-function-name">pmap_find_phys</span>(pmap_t pmap, addr64_t va);
__END_DECLS

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">super</span> IOService
<span class="enscript-function-name">OSDefineMetaClassAndAbstractStructors</span>(IOMapper, IOService);

<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOMapper, 0);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOMapper, 1);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOMapper, 2);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOMapper, 3);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOMapper, 4);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOMapper, 5);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOMapper, 6);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOMapper, 7);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOMapper, 8);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOMapper, 9);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOMapper, 10);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOMapper, 11);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOMapper, 12);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOMapper, 13);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOMapper, 14);
<span class="enscript-function-name">OSMetaClassDefineReservedUnused</span>(IOMapper, 15);

IOMapper * IOMapper::gSystem = (IOMapper *) IOMapper::kUnknown;

<span class="enscript-type">class</span> IOMapperLock {
    IOLock *fWaitLock;
<span class="enscript-type">public</span>:
    IOMapperLock() { fWaitLock = IOLockAlloc(); };
    ~IOMapperLock() { IOLockFree(fWaitLock); };

    <span class="enscript-type">void</span> lock()   { IOLockLock(fWaitLock); };
    <span class="enscript-type">void</span> unlock() { IOLockUnlock(fWaitLock); };
    <span class="enscript-type">void</span> sleep(<span class="enscript-type">void</span> *event)  { IOLockSleep(fWaitLock, event, THREAD_UNINT); };
    <span class="enscript-type">void</span> wakeup(<span class="enscript-type">void</span> *event) { IOLockWakeup(fWaitLock, event, false); };
};

<span class="enscript-type">static</span> IOMapperLock sMapperLock;

<span class="enscript-type">bool</span> <span class="enscript-function-name">IOMapper::start</span>(IOService *provider)
{
    OSObject * obj;
    <span class="enscript-keyword">if</span> (!super::start(provider))
        <span class="enscript-keyword">return</span> false;

    <span class="enscript-keyword">if</span> (!initHardware(provider))
        <span class="enscript-keyword">return</span> false;

    fPageSize = getPageSize();

    <span class="enscript-keyword">if</span> (fIsSystem) { 
        sMapperLock.lock();
        <span class="enscript-reference">IOMapper</span>::gSystem = <span class="enscript-keyword">this</span>;
        sMapperLock.wakeup(&amp;IOMapper::gSystem);
        sMapperLock.unlock();
    }

    <span class="enscript-keyword">if</span> (provider)
    {
    	obj = provider-&gt;getProperty(<span class="enscript-string">&quot;iommu-id&quot;</span>);
	<span class="enscript-keyword">if</span> (!obj)
	    obj = provider-&gt;getProperty(<span class="enscript-string">&quot;AAPL,phandle&quot;</span>);
	<span class="enscript-keyword">if</span> (obj)
	    setProperty(gIOMapperIDKey, obj);
    }
    <span class="enscript-keyword">return</span> true;
}

<span class="enscript-type">void</span> <span class="enscript-function-name">IOMapper::free</span>()
{
    <span class="enscript-reference">super</span>::free();
}

<span class="enscript-type">void</span> <span class="enscript-function-name">IOMapper::setMapperRequired</span>(<span class="enscript-type">bool</span> hasMapper)
{
    <span class="enscript-keyword">if</span> (hasMapper)
        <span class="enscript-reference">IOMapper</span>::gSystem = (IOMapper *) kHasMapper;
    <span class="enscript-keyword">else</span> {
        sMapperLock.lock();
        <span class="enscript-reference">IOMapper</span>::gSystem = (IOMapper *) kNoMapper;
        sMapperLock.unlock();
        sMapperLock.wakeup(&amp;IOMapper::gSystem);
    }
}

<span class="enscript-type">void</span> <span class="enscript-function-name">IOMapper::waitForSystemMapper</span>()
{
    sMapperLock.lock();
    <span class="enscript-keyword">while</span> ((uintptr_t) IOMapper::gSystem &amp; kWaitMask)
    {
		OSReportWithBacktrace(<span class="enscript-string">&quot;waitForSystemMapper&quot;</span>);
        sMapperLock.sleep(&amp;IOMapper::gSystem);
    }
    sMapperLock.unlock();
}

IOMapper * <span class="enscript-function-name">IOMapper::copyMapperForDevice</span>(IOService * device)
{
    <span class="enscript-keyword">return</span> copyMapperForDeviceWithIndex(device, 0);
}

IOMapper * <span class="enscript-function-name">IOMapper::copyMapperForDeviceWithIndex</span>(IOService * device, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> index)
{
    OSData *data;
    OSObject * obj;
    IOMapper * mapper = NULL;
    OSDictionary * matching;
    
    obj = device-&gt;copyProperty(<span class="enscript-string">&quot;iommu-parent&quot;</span>);
    <span class="enscript-keyword">if</span> (!obj)
        <span class="enscript-keyword">return</span> (NULL);

    <span class="enscript-keyword">if</span> ((mapper = OSDynamicCast(IOMapper, obj)))
        <span class="enscript-keyword">return</span> (mapper);

    <span class="enscript-keyword">if</span> ((data = OSDynamicCast(OSData, obj)))
    {
        <span class="enscript-keyword">if</span> (index &gt;= data-&gt;getLength() / <span class="enscript-keyword">sizeof</span>(UInt32))
            <span class="enscript-keyword">goto</span> <span class="enscript-reference">done</span>;
        
        data = OSData::withBytesNoCopy((UInt32 *)data-&gt;getBytesNoCopy() + index, <span class="enscript-keyword">sizeof</span>(UInt32));
        <span class="enscript-keyword">if</span> (!data)
            <span class="enscript-keyword">goto</span> <span class="enscript-reference">done</span>;

        matching = IOService::propertyMatching(gIOMapperIDKey, data);
        data-&gt;release();
    }
    <span class="enscript-keyword">else</span>
        matching = IOService::propertyMatching(gIOMapperIDKey, obj);

    <span class="enscript-keyword">if</span> (matching)
    {
        mapper = OSDynamicCast(IOMapper, IOService::waitForMatchingService(matching));
            matching-&gt;release();
    }

<span class="enscript-reference">done</span>:
    <span class="enscript-keyword">if</span> (obj)
            obj-&gt;release();
    <span class="enscript-keyword">return</span> (mapper);
}

__BEGIN_DECLS

<span class="enscript-comment">// These are C accessors to the system mapper for non-IOKit clients
</span>ppnum_t <span class="enscript-function-name">IOMapperIOVMAlloc</span>(<span class="enscript-type">unsigned</span> pages)
{
    IOReturn ret;
    uint64_t dmaAddress, dmaLength;

    <span class="enscript-reference">IOMapper</span>::checkForSystemMapper();

    ret = kIOReturnUnsupported;
    <span class="enscript-keyword">if</span> (IOMapper::gSystem)
    {
        ret = IOMapper::gSystem-&gt;iovmMapMemory(
        		NULL, 0, ptoa_64(pages), 
        		(kIODMAMapReadAccess | kIODMAMapWriteAccess),
        		NULL, NULL, NULL,
        		&amp;dmaAddress, &amp;dmaLength);
    }

    <span class="enscript-keyword">if</span> (kIOReturnSuccess == ret) <span class="enscript-keyword">return</span> (atop_64(dmaAddress));
    <span class="enscript-keyword">return</span> (0);
}

<span class="enscript-type">void</span> <span class="enscript-function-name">IOMapperIOVMFree</span>(ppnum_t addr, <span class="enscript-type">unsigned</span> pages)
{
    <span class="enscript-keyword">if</span> (IOMapper::gSystem)
    {
        <span class="enscript-reference">IOMapper</span>::gSystem-&gt;iovmUnmapMemory(NULL, NULL, ptoa_64(addr), ptoa_64(pages));
    }
}

ppnum_t <span class="enscript-function-name">IOMapperInsertPage</span>(ppnum_t addr, <span class="enscript-type">unsigned</span> offset, ppnum_t page)
{
    <span class="enscript-keyword">if</span> (!IOMapper::gSystem) <span class="enscript-keyword">return</span> (page);
    <span class="enscript-keyword">if</span> (!addr) panic(<span class="enscript-string">&quot;!addr&quot;</span>);
    <span class="enscript-reference">IOMapper</span>::gSystem-&gt;iovmInsert((kIODMAMapReadAccess | kIODMAMapWriteAccess),
				  ptoa_64(addr), ptoa_64(offset), ptoa_64(page), ptoa_64(1));
    <span class="enscript-keyword">return</span> (addr + offset);
}

<span class="enscript-comment">/////////////////////////////////////////////////////////////////////////////
</span><span class="enscript-comment">//
</span><span class="enscript-comment">//
</span><span class="enscript-comment">//	IOLib.h APIs
</span><span class="enscript-comment">//
</span><span class="enscript-comment">//
</span><span class="enscript-comment">/////////////////////////////////////////////////////////////////////////////
</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;machine/machine_routines.h&gt;</span>

UInt8 <span class="enscript-function-name">IOMappedRead8</span>(IOPhysicalAddress address)
{
    <span class="enscript-reference">IOMapper</span>::checkForSystemMapper();

    <span class="enscript-keyword">if</span> (IOMapper::gSystem) {
        addr64_t addr = IOMapper::gSystem-&gt;mapToPhysicalAddress(address);
        <span class="enscript-keyword">return</span> (UInt8) ml_phys_read_byte_64(addr);
    }
    <span class="enscript-keyword">else</span>
        <span class="enscript-keyword">return</span> (UInt8) ml_phys_read_byte((vm_offset_t) address);
}

UInt16 <span class="enscript-function-name">IOMappedRead16</span>(IOPhysicalAddress address)
{
    <span class="enscript-reference">IOMapper</span>::checkForSystemMapper();

    <span class="enscript-keyword">if</span> (IOMapper::gSystem) {
        addr64_t addr = IOMapper::gSystem-&gt;mapToPhysicalAddress(address);
        <span class="enscript-keyword">return</span> (UInt16) ml_phys_read_half_64(addr);
    }
    <span class="enscript-keyword">else</span>
        <span class="enscript-keyword">return</span> (UInt16) ml_phys_read_half((vm_offset_t) address);
}

UInt32 <span class="enscript-function-name">IOMappedRead32</span>(IOPhysicalAddress address)
{
    <span class="enscript-reference">IOMapper</span>::checkForSystemMapper();

    <span class="enscript-keyword">if</span> (IOMapper::gSystem) {
        addr64_t addr = IOMapper::gSystem-&gt;mapToPhysicalAddress(address);
	<span class="enscript-keyword">return</span> (UInt32) ml_phys_read_word_64(addr);
    }
    <span class="enscript-keyword">else</span>
        <span class="enscript-keyword">return</span> (UInt32) ml_phys_read_word((vm_offset_t) address);
}

UInt64 <span class="enscript-function-name">IOMappedRead64</span>(IOPhysicalAddress address)
{
    <span class="enscript-reference">IOMapper</span>::checkForSystemMapper();

    <span class="enscript-keyword">if</span> (IOMapper::gSystem) {
        addr64_t addr = IOMapper::gSystem-&gt;mapToPhysicalAddress(address);
        <span class="enscript-keyword">return</span> (UInt64) ml_phys_read_double_64(addr);
    }
    <span class="enscript-keyword">else</span>
        <span class="enscript-keyword">return</span> (UInt64) ml_phys_read_double((vm_offset_t) address);
}

<span class="enscript-type">void</span> <span class="enscript-function-name">IOMappedWrite8</span>(IOPhysicalAddress address, UInt8 value)
{
    <span class="enscript-reference">IOMapper</span>::checkForSystemMapper();

    <span class="enscript-keyword">if</span> (IOMapper::gSystem) {
        addr64_t addr = IOMapper::gSystem-&gt;mapToPhysicalAddress(address);
        ml_phys_write_byte_64(addr, value);
    }
    <span class="enscript-keyword">else</span>
        ml_phys_write_byte((vm_offset_t) address, value);
}

<span class="enscript-type">void</span> <span class="enscript-function-name">IOMappedWrite16</span>(IOPhysicalAddress address, UInt16 value)
{
    <span class="enscript-reference">IOMapper</span>::checkForSystemMapper();

    <span class="enscript-keyword">if</span> (IOMapper::gSystem) {
        addr64_t addr = IOMapper::gSystem-&gt;mapToPhysicalAddress(address);
        ml_phys_write_half_64(addr, value);
    }
    <span class="enscript-keyword">else</span>
        ml_phys_write_half((vm_offset_t) address, value);
}

<span class="enscript-type">void</span> <span class="enscript-function-name">IOMappedWrite32</span>(IOPhysicalAddress address, UInt32 value)
{
    <span class="enscript-reference">IOMapper</span>::checkForSystemMapper();

    <span class="enscript-keyword">if</span> (IOMapper::gSystem) {
        addr64_t addr = IOMapper::gSystem-&gt;mapToPhysicalAddress(address);
        ml_phys_write_word_64(addr, value);
    }
    <span class="enscript-keyword">else</span>
        ml_phys_write_word((vm_offset_t) address, value);
}

<span class="enscript-type">void</span> <span class="enscript-function-name">IOMappedWrite64</span>(IOPhysicalAddress address, UInt64 value)
{
    <span class="enscript-reference">IOMapper</span>::checkForSystemMapper();

    <span class="enscript-keyword">if</span> (IOMapper::gSystem) {
        addr64_t addr = IOMapper::gSystem-&gt;mapToPhysicalAddress(address);
        ml_phys_write_double_64(addr, value);
    }
    <span class="enscript-keyword">else</span>
        ml_phys_write_double((vm_offset_t) address, value);
}

__END_DECLS
</pre>
<hr />
</body></html>