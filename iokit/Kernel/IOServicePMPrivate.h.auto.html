<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>IOServicePMPrivate.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">IOServicePMPrivate.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2007 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_IOKIT_IOSERVICEPMPRIVATE_H</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_IOKIT_IOSERVICEPMPRIVATE_H</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOCommand.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;IOKit/IOEventSource.h&gt;</span>

<span class="enscript-comment">//******************************************************************************
</span><span class="enscript-comment">// PM command types
</span><span class="enscript-comment">//******************************************************************************
</span>
<span class="enscript-type">enum</span> {
    <span class="enscript-comment">/* Command Types */</span>
    kIOPMRequestTypeInvalid                     = 0x00,
    kIOPMRequestTypePMStop                      = 0x01,
    kIOPMRequestTypeAddPowerChild1              = 0x02,
    kIOPMRequestTypeAddPowerChild2              = 0x03,
    kIOPMRequestTypeAddPowerChild3              = 0x04,
    kIOPMRequestTypeRegisterPowerDriver         = 0x05,
    kIOPMRequestTypeAdjustPowerState            = 0x06,
    kIOPMRequestTypePowerDomainWillChange       = 0x07,
    kIOPMRequestTypePowerDomainDidChange        = 0x08,
    kIOPMRequestTypePowerOverrideOnPriv         = 0x09,
    kIOPMRequestTypePowerOverrideOffPriv        = 0x0A,
    kIOPMRequestTypeActivityTickle              = 0x0B,
    kIOPMRequestTypeRequestPowerState           = 0x0C,
    kIOPMRequestTypeSynchronizePowerTree        = 0x0D,
    kIOPMRequestTypeRequestPowerStateOverride   = 0x0E,
    kIOPMRequestTypeSetIdleTimerPeriod          = 0x0F,
    kIOPMRequestTypeIgnoreIdleTimer             = 0x10,
    kIOPMRequestTypeQuiescePowerTree            = 0x11,

    <span class="enscript-comment">/* Reply Types */</span>
    kIOPMRequestTypeReplyStart                  = 0x80,
    kIOPMRequestTypeAckPowerChange              = 0x81,
    kIOPMRequestTypeAckSetPowerState            = 0x82,
    kIOPMRequestTypeAllowPowerChange            = 0x83,
    kIOPMRequestTypeCancelPowerChange           = 0x84,
    kIOPMRequestTypeInterestChanged             = 0x85,
    kIOPMRequestTypeIdleCancel                  = 0x86,
    kIOPMRequestTypeChildNotifyDelayCancel      = 0x87
};

<span class="enscript-comment">//******************************************************************************
</span><span class="enscript-comment">// PM actions - For root domain only
</span><span class="enscript-comment">//******************************************************************************
</span>
<span class="enscript-type">struct</span> IOPMActions;

<span class="enscript-type">typedef</span> <span class="enscript-type">void</span>
(*IOPMActionPowerChangeStart)(
    <span class="enscript-type">void</span> *                  target,
    IOService *             service,
    IOPMActions *           actions,
    IOPMPowerStateIndex     powerState,
    IOPMPowerChangeFlags *  changeFlags,
    IOPMRequestTag          requestTag );

<span class="enscript-type">typedef</span> <span class="enscript-type">void</span>
(*IOPMActionPowerChangeDone)(
    <span class="enscript-type">void</span> *                  target,
    IOService *             service,
    IOPMActions *           actions,
    IOPMPowerStateIndex     powerState,
    IOPMPowerChangeFlags    changeFlags,
    IOPMRequestTag          requestTag );

<span class="enscript-type">typedef</span> <span class="enscript-type">void</span>
(*IOPMActionPowerChangeOverride)(
    <span class="enscript-type">void</span> *                  target,
    IOService *             service,
    IOPMActions *           actions,
    IOPMPowerStateIndex *   powerState,
    IOPMPowerChangeFlags *  changeFlags,
    IOPMRequestTag          requestTag );

<span class="enscript-type">typedef</span> <span class="enscript-type">void</span>
(*IOPMActionActivityTickle)(
    <span class="enscript-type">void</span> *                  target,
    IOService *             service,
    IOPMActions *           actions );

<span class="enscript-type">typedef</span> <span class="enscript-type">void</span>
(*IOPMActionUpdatePowerClient)(
    <span class="enscript-type">void</span> *                  target,
    IOService *             service,
    IOPMActions *           actions,
    <span class="enscript-type">const</span> OSSymbol *        powerClient,
    IOPMPowerStateIndex     oldPowerState,
    IOPMPowerStateIndex     newPowerState
);

<span class="enscript-type">struct</span> IOPMActions {
    <span class="enscript-type">void</span> *                          target;
    uint32_t                        parameter;
    IOPMActionPowerChangeStart      actionPowerChangeStart;
    IOPMActionPowerChangeDone       actionPowerChangeDone;
    IOPMActionPowerChangeOverride   actionPowerChangeOverride;
    IOPMActionActivityTickle        actionActivityTickle;
    IOPMActionUpdatePowerClient     actionUpdatePowerClient;
};

<span class="enscript-comment">// IOPMActions parameter flags
</span><span class="enscript-type">enum</span> {
    kPMActionsFlagIsDisplayWrangler = 0x00000100,
    kPMActionsFlagIsGraphicsDevice  = 0x00000200,
    kPMActionsFlagIsAudioDevice     = 0x00000400,
    kPMActionsFlagLimitPower        = 0x00000800,
    kPMActionsPCIBitNumberMask      = 0x000000ff
};

<span class="enscript-comment">//******************************************************************************
</span><span class="enscript-comment">// Internal concise representation of IOPMPowerState
</span><span class="enscript-type">struct</span> IOPMPSEntry
{
    IOPMPowerFlags      capabilityFlags;
    IOPMPowerFlags      outputPowerFlags;
    IOPMPowerFlags      inputPowerFlags;
    uint32_t            staticPower;
    uint32_t            settleUpTime;
    uint32_t            settleDownTime;
    IOPMPowerStateIndex stateOrder;
    IOPMPowerStateIndex stateOrderToIndex;
};

<span class="enscript-comment">//******************************************************************************
</span><span class="enscript-comment">// IOServicePM
</span><span class="enscript-comment">//******************************************************************************
</span>
class IOServicePM : public OSObject
{
    friend class IOService;
    friend class IOPMWorkQueue;

    OSDeclareDefaultStructors( IOServicePM )

<span class="enscript-reference">private</span>:
    <span class="enscript-comment">// Link IOServicePM objects on IOPMWorkQueue.
</span>    queue_chain_t           WorkChain;

    <span class="enscript-comment">// Queue of IOPMRequest objects.
</span>    queue_head_t            RequestHead;

    <span class="enscript-comment">// IOService creator and owner.
</span>    IOService *             Owner;

    <span class="enscript-comment">// List of interested drivers (protected by PMLock).
</span>    IOPMinformeeList *      InterestedDrivers;

    <span class="enscript-comment">// How long to wait for controlling driver to acknowledge.
</span>    IOReturn                DriverTimer;

    <span class="enscript-comment">// Current power management machine state.
</span>    uint32_t                MachineState;

    thread_call_t           AckTimer;
    thread_call_t           SettleTimer;
    thread_call_t           IdleTimer;
    thread_call_t           WatchdogTimer;
    thread_call_t           SpinDumpTimer;

    <span class="enscript-comment">// Settle time after changing power state.
</span>    uint32_t                SettleTimeUS;
    uint32_t                IdleTimerGeneration;

    <span class="enscript-comment">// The flags describing current change note.
</span>    IOPMPowerChangeFlags    HeadNoteChangeFlags;

    <span class="enscript-comment">// The new power state number being changed to.
</span>    IOPMPowerStateIndex     HeadNotePowerState;

    <span class="enscript-comment">// Points to the entry in the power state array.
</span>    IOPMPSEntry *           HeadNotePowerArrayEntry;

    <span class="enscript-comment">// Power flags supplied by all parents (domain).
</span>    IOPMPowerFlags          HeadNoteDomainFlags;

    <span class="enscript-comment">// Power flags supplied by domain accounting for parent changes.
</span>    IOPMPowerFlags          HeadNoteDomainTargetFlags;

    <span class="enscript-comment">// Connection attached to the changing parent.
</span>    IOPowerConnection *     HeadNoteParentConnection;

    <span class="enscript-comment">// Power flags supplied by the changing parent.
</span>    IOPMPowerFlags          HeadNoteParentFlags;

    <span class="enscript-comment">// Number of acks still outstanding.
</span>    uint32_t                HeadNotePendingAcks;

    <span class="enscript-comment">// PM state lock.
</span>    IOLock *                PMLock;

    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>            InitialPowerChange          :1;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>            InitialSetPowerState        :1;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>            DeviceOverrideEnabled       :1;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>            DoNotPowerDown              :1;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>            ParentsKnowState            :1;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>            StrictTreeOrder             :1;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>            IdleTimerStopped            :1;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>            AdjustPowerScheduled        :1;

    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>            IsPreChange                 :1;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>            DriverCallBusy              :1;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>            PCDFunctionOverride         :1;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>            IdleTimerIgnored            :1;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>            HasAdvisoryDesire           :1;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>            AdvisoryTickleUsed          :1;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>            ResetPowerStateOnWake       :1;

    <span class="enscript-comment">// Time of last device activity.
</span>    AbsoluteTime            DeviceActiveTimestamp;
    AbsoluteTime            MaxPowerStateEntryTime;
    AbsoluteTime            MaxPowerStateExitTime;

    <span class="enscript-comment">// Used to protect activity flag.
</span>    IOLock *                ActivityLock;

    <span class="enscript-comment">// Idle timer's period in seconds.
</span>    <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span>           IdleTimerPeriod;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span>           IdleTimerMinPowerState;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span>           NextIdleTimerPeriod;
    AbsoluteTime            IdleTimerStartTime;

    <span class="enscript-comment">// Power state desired by a subclassed device object.
</span>    IOPMPowerStateIndex     DeviceDesire;

    <span class="enscript-comment">// This is the power state we desire currently.
</span>    IOPMPowerStateIndex     DesiredPowerState;

    <span class="enscript-comment">// This is what our parent thinks our need is.
</span>    IOPMPowerFlags          PreviousRequestPowerFlags;

    <span class="enscript-comment">// Cache result from getName(), used in logging.
</span>    <span class="enscript-type">const</span> <span class="enscript-type">char</span> *            Name;

    <span class="enscript-comment">// Number of power states in the power array.
</span>    IOPMPowerStateIndex     NumberOfPowerStates;

    <span class="enscript-comment">// Ordered highest power state in the power array.
</span>    IOPMPowerStateIndex     HighestPowerState;

    <span class="enscript-comment">// Power state array.
</span>    IOPMPSEntry *           PowerStates;

    <span class="enscript-comment">// The controlling driver.
</span>    IOService *             ControllingDriver;

    <span class="enscript-comment">// Our current power state.
</span>    IOPMPowerStateIndex     CurrentPowerState;

    <span class="enscript-comment">// Logical OR of power flags for each power domain parent.
</span>    IOPMPowerFlags          ParentsCurrentPowerFlags;

    <span class="enscript-comment">// The highest power state we can achieve in current power domain.
</span>    IOPMPowerStateIndex     MaxPowerState;

    <span class="enscript-comment">// Logical OR of all output power flags in the power state array.
</span>    IOPMPowerFlags          MergedOutputPowerFlags;

    <span class="enscript-comment">// OSArray which manages responses from notified apps and clients.
</span>    OSArray *               ResponseArray;
    OSArray *               NotifyClientArray;

    <span class="enscript-comment">// Used to uniquely identify power management notification to apps and clients.
</span>    UInt16                  SerialNumber;

    <span class="enscript-comment">// Used to communicate desired function to tellClientsWithResponse().
</span>    <span class="enscript-comment">// This is used because it avoids changing the signatures of the affected virtual methods.
</span>    <span class="enscript-type">int</span>                     OutOfBandParameter;

    AbsoluteTime            DriverCallStartTime;
    IOPMPowerFlags          CurrentCapabilityFlags;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span>           CurrentPowerConsumption;
    IOPMPowerStateIndex     TempClampPowerState;
    OSArray *               NotifyChildArray;
    OSDictionary *          PowerClients;
    thread_call_t           DriverCallEntry;
    <span class="enscript-type">void</span> *                  DriverCallParamPtr;
    IOItemCount             DriverCallParamCount;
    IOItemCount             DriverCallParamSlots;
    uint32_t                DriverCallReason;
    uint32_t                OutOfBandMessage;
    uint32_t                TempClampCount;
    uint32_t                OverrideMaxPowerState;
    uint32_t                DeviceUsablePowerState;

    <span class="enscript-comment">// Protected by ActivityLock - BEGIN
</span>    IOPMPowerStateIndex     ActivityTicklePowerState;
    IOPMPowerStateIndex     AdvisoryTicklePowerState;
    uint32_t                ActivityTickleCount;
    uint32_t                DeviceWasActive     : 1;
    uint32_t                AdvisoryTickled     : 1;
    <span class="enscript-comment">// Protected by ActivityLock - END
</span>
    uint32_t                WaitReason;
    uint32_t                SavedMachineState;

    <span class="enscript-comment">// Protected by PMLock - BEGIN
</span>    <span class="enscript-type">struct</span> {
        uint32_t            PMStop              : 1;
        uint32_t            PMDriverCallWait    : 1;
    } LockedFlags;

    queue_head_t            PMDriverCallQueue;
    OSSet *                 InsertInterestSet;
    OSSet *                 RemoveInterestSet;

    <span class="enscript-comment">// IOReporter Data
</span>    uint32_t                ReportClientCnt;
    <span class="enscript-type">void</span> *                  ReportBuf;
    <span class="enscript-comment">// Protected by PMLock - END
</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PM_VARS_SUPPORT</span>
    IOPMprot *              PMVars;
#<span class="enscript-reference">endif</span>

    IOPMActions             PMActions;

    <span class="enscript-comment">// Serialize IOServicePM state for debug output.
</span>    IOReturn gatedSerialize( OSSerialize * s ) <span class="enscript-type">const</span>;
    virtual bool serialize( OSSerialize * s ) <span class="enscript-type">const</span> APPLE_KEXT_OVERRIDE;

    <span class="enscript-comment">// PM log and trace
</span>    <span class="enscript-type">void</span> pmPrint( uint32_t event, uintptr_t param1, uintptr_t param2 ) <span class="enscript-type">const</span>;
    <span class="enscript-type">void</span> pmTrace( uint32_t event, uintptr_t param1, uintptr_t param2 ) <span class="enscript-type">const</span>;
};

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fOwner</span>                      pwrMgt-&gt;Owner
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fInterestedDrivers</span>          pwrMgt-&gt;InterestedDrivers
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fDriverTimer</span>                pwrMgt-&gt;DriverTimer
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fMachineState</span>               pwrMgt-&gt;MachineState
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fAckTimer</span>                   pwrMgt-&gt;AckTimer
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fSettleTimer</span>                pwrMgt-&gt;SettleTimer
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fIdleTimer</span>                  pwrMgt-&gt;IdleTimer
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fWatchdogTimer</span>              pwrMgt-&gt;WatchdogTimer
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fSpinDumpTimer</span>              pwrMgt-&gt;SpinDumpTimer
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fSettleTimeUS</span>               pwrMgt-&gt;SettleTimeUS
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fIdleTimerGeneration</span>        pwrMgt-&gt;IdleTimerGeneration
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fHeadNoteChangeFlags</span>        pwrMgt-&gt;HeadNoteChangeFlags
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fHeadNotePowerState</span>         pwrMgt-&gt;HeadNotePowerState
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fHeadNotePowerArrayEntry</span>    pwrMgt-&gt;HeadNotePowerArrayEntry
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fHeadNoteDomainFlags</span>        pwrMgt-&gt;HeadNoteDomainFlags
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fHeadNoteDomainTargetFlags</span>  pwrMgt-&gt;HeadNoteDomainTargetFlags
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fHeadNoteParentConnection</span>   pwrMgt-&gt;HeadNoteParentConnection
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fHeadNoteParentFlags</span>        pwrMgt-&gt;HeadNoteParentFlags
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fHeadNotePendingAcks</span>        pwrMgt-&gt;HeadNotePendingAcks
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fPMLock</span>                     pwrMgt-&gt;PMLock
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fInitialPowerChange</span>         pwrMgt-&gt;InitialPowerChange
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fInitialSetPowerState</span>       pwrMgt-&gt;InitialSetPowerState
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fDeviceOverrideEnabled</span>      pwrMgt-&gt;DeviceOverrideEnabled
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fDoNotPowerDown</span>             pwrMgt-&gt;DoNotPowerDown
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fParentsKnowState</span>           pwrMgt-&gt;ParentsKnowState
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fStrictTreeOrder</span>            pwrMgt-&gt;StrictTreeOrder
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fIdleTimerStopped</span>           pwrMgt-&gt;IdleTimerStopped
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fAdjustPowerScheduled</span>       pwrMgt-&gt;AdjustPowerScheduled
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fIsPreChange</span>                pwrMgt-&gt;IsPreChange
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fDriverCallBusy</span>             pwrMgt-&gt;DriverCallBusy
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fPCDFunctionOverride</span>        pwrMgt-&gt;PCDFunctionOverride
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fIdleTimerIgnored</span>           pwrMgt-&gt;IdleTimerIgnored
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fHasAdvisoryDesire</span>          pwrMgt-&gt;HasAdvisoryDesire
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fAdvisoryTickleUsed</span>         pwrMgt-&gt;AdvisoryTickleUsed
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fResetPowerStateOnWake</span>      pwrMgt-&gt;ResetPowerStateOnWake
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fDeviceActiveTimestamp</span>      pwrMgt-&gt;DeviceActiveTimestamp
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fMaxPowerStateEntryTime</span>     pwrMgt-&gt;MaxPowerStateEntryTime
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fMaxPowerStateExitTime</span>      pwrMgt-&gt;MaxPowerStateExitTime
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fActivityLock</span>               pwrMgt-&gt;ActivityLock
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fIdleTimerPeriod</span>            pwrMgt-&gt;IdleTimerPeriod
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fIdleTimerMinPowerState</span>     pwrMgt-&gt;IdleTimerMinPowerState
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fNextIdleTimerPeriod</span>        pwrMgt-&gt;NextIdleTimerPeriod
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fIdleTimerStartTime</span>         pwrMgt-&gt;IdleTimerStartTime
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fDeviceDesire</span>               pwrMgt-&gt;DeviceDesire
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fDesiredPowerState</span>          pwrMgt-&gt;DesiredPowerState
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fPreviousRequestPowerFlags</span>  pwrMgt-&gt;PreviousRequestPowerFlags
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fName</span>                       pwrMgt-&gt;Name
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fNumberOfPowerStates</span>        pwrMgt-&gt;NumberOfPowerStates
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fHighestPowerState</span>          pwrMgt-&gt;HighestPowerState
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fPowerStates</span>                pwrMgt-&gt;PowerStates
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fControllingDriver</span>          pwrMgt-&gt;ControllingDriver
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fCurrentPowerState</span>          pwrMgt-&gt;CurrentPowerState
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fParentsCurrentPowerFlags</span>   pwrMgt-&gt;ParentsCurrentPowerFlags
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fMaxPowerState</span>              pwrMgt-&gt;MaxPowerState
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fMergedOutputPowerFlags</span>     pwrMgt-&gt;MergedOutputPowerFlags
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fResponseArray</span>              pwrMgt-&gt;ResponseArray
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fNotifyClientArray</span>          pwrMgt-&gt;NotifyClientArray
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fSerialNumber</span>               pwrMgt-&gt;SerialNumber
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fOutOfBandParameter</span>         pwrMgt-&gt;OutOfBandParameter
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fDriverCallStartTime</span>        pwrMgt-&gt;DriverCallStartTime
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fCurrentCapabilityFlags</span>     pwrMgt-&gt;CurrentCapabilityFlags
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fCurrentPowerConsumption</span>    pwrMgt-&gt;CurrentPowerConsumption
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fTempClampPowerState</span>        pwrMgt-&gt;TempClampPowerState
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fNotifyChildArray</span>           pwrMgt-&gt;NotifyChildArray
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fPowerClients</span>               pwrMgt-&gt;PowerClients
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fDriverCallEntry</span>            pwrMgt-&gt;DriverCallEntry
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fDriverCallParamPtr</span>         pwrMgt-&gt;DriverCallParamPtr
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fDriverCallParamCount</span>       pwrMgt-&gt;DriverCallParamCount
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fDriverCallParamSlots</span>       pwrMgt-&gt;DriverCallParamSlots
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fDriverCallReason</span>           pwrMgt-&gt;DriverCallReason
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fOutOfBandMessage</span>           pwrMgt-&gt;OutOfBandMessage
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fTempClampCount</span>             pwrMgt-&gt;TempClampCount
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fOverrideMaxPowerState</span>      pwrMgt-&gt;OverrideMaxPowerState
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fDeviceUsablePowerState</span>     pwrMgt-&gt;DeviceUsablePowerState
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fActivityTicklePowerState</span>   pwrMgt-&gt;ActivityTicklePowerState
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fAdvisoryTicklePowerState</span>   pwrMgt-&gt;AdvisoryTicklePowerState
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fActivityTickleCount</span>        pwrMgt-&gt;ActivityTickleCount
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fDeviceWasActive</span>            pwrMgt-&gt;DeviceWasActive
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fAdvisoryTickled</span>            pwrMgt-&gt;AdvisoryTickled
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fWaitReason</span>                 pwrMgt-&gt;WaitReason
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fSavedMachineState</span>          pwrMgt-&gt;SavedMachineState
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fLockedFlags</span>                pwrMgt-&gt;LockedFlags
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fPMDriverCallQueue</span>          pwrMgt-&gt;PMDriverCallQueue
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fInsertInterestSet</span>          pwrMgt-&gt;InsertInterestSet
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fRemoveInterestSet</span>          pwrMgt-&gt;RemoveInterestSet
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fReportClientCnt</span>            pwrMgt-&gt;ReportClientCnt
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fReportBuf</span>                  pwrMgt-&gt;ReportBuf
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fPMVars</span>                     pwrMgt-&gt;PMVars
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fPMActions</span>                  pwrMgt-&gt;PMActions

#<span class="enscript-reference">define</span> <span class="enscript-function-name">StateOrder</span>(state)           (((state) &lt; fNumberOfPowerStates)               \
                                    ? pwrMgt-&gt;PowerStates[(state)].stateOrder       \
                                    : (state))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">StateMax</span>(a,b)               (StateOrder((a)) &lt; StateOrder((b)) ? (b) : (a))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">StateMin</span>(a,b)               (StateOrder((a)) &lt; StateOrder((b)) ? (a) : (b))

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kPowerStateZero</span>             (0)

<span class="enscript-comment">/*
When an IOService is waiting for acknowledgement to a power change
notification from an interested driver or the controlling driver,
the ack timer is ticking every tenth of a second.
(100000000 nanoseconds are one tenth of a second).
*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ACK_TIMER_PERIOD</span>            100000000

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">WATCHDOG_TIMER_PERIOD</span>       (300)   // 300 secs

<span class="enscript-comment">// Max wait time in microseconds for kernel priority and capability clients
</span><span class="enscript-comment">// with async message handlers to acknowledge.
</span><span class="enscript-comment">//
</span>#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kPriorityClientMaxWait</span>      (90 * 1000 * 1000)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kCapabilityClientMaxWait</span>    (240 * 1000 * 1000)

<span class="enscript-comment">// Attributes describing a power state change.
</span><span class="enscript-comment">// See IOPMPowerChangeFlags data type.
</span><span class="enscript-comment">//
</span>#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIOPMParentInitiated</span>        0x0001  // power change initiated by our  parent
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIOPMSelfInitiated</span>          0x0002  // power change initiated by this device
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIOPMNotDone</span>                0x0004  // we couldn't make this change
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIOPMDomainWillChange</span>       0x0008  // change started by PowerDomainWillChangeTo
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIOPMDomainDidChange</span>        0x0010  // change started by PowerDomainDidChangeTo
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIOPMDomainPowerDrop</span>        0x0020  // Domain is lowering power
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIOPMIgnoreChildren</span>         0x0040  // Ignore children and driver power desires
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIOPMSkipAskPowerDown</span>       0x0080  // skip the ask app phase
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIOPMSynchronize</span>            0x0100  // change triggered by power tree re-sync
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIOPMSyncNoChildNotify</span>      0x0200  // sync root domain only, not entire tree
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIOPMSyncTellPowerDown</span>      0x0400  // send the ask/will power off messages
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIOPMSyncCancelPowerDown</span>    0x0800  // sleep cancel for maintenance wake
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIOPMInitialPowerChange</span>     0x1000  // set for initial power change
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIOPMRootChangeUp</span>           0x2000  // Root power domain change up
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIOPMRootChangeDown</span>         0x4000  // Root power domain change down
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIOPMExpireIdleTimer</span>        0x8000  // Accelerate idle timer expiration

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kIOPMRootBroadcastFlags</span>     (kIOPMSynchronize  | \
                                     kIOPMRootChangeUp | kIOPMRootChangeDown)

<span class="enscript-comment">// Activity tickle request flags
</span>#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kTickleTypePowerDrop</span>        0x01
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kTickleTypePowerRise</span>        0x02
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kTickleTypeActivity</span>         0x04
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kTickleTypeAdvisory</span>         0x08

<span class="enscript-type">enum</span> {
    kDriverCallInformPreChange,
    kDriverCallInformPostChange,
    kDriverCallSetPowerState,
    kRootDomainInformPreChange
};

<span class="enscript-type">struct</span> DriverCallParam {
    OSObject *  Target;
    IOReturn    Result;
};

<span class="enscript-comment">// values of OutOfBandParameter
</span><span class="enscript-type">enum</span> {
    kNotifyApps,
    kNotifyPriority,
    kNotifyCapabilityChangeApps,
    kNotifyCapabilityChangePriority
};

<span class="enscript-type">typedef</span> <span class="enscript-function-name">bool</span> (*IOPMMessageFilter)(
        <span class="enscript-type">void</span> * target, <span class="enscript-type">void</span> * object, <span class="enscript-type">void</span> * arg1, <span class="enscript-type">void</span> * arg2, <span class="enscript-type">void</span> * arg3 );

<span class="enscript-comment">// used for applyToInterested
</span><span class="enscript-type">struct</span> IOPMInterestContext {
    OSArray *               responseArray;
    OSArray *               notifyClients;
    uint16_t                serialNumber;
    uint8_t                 isPreChange;
    uint8_t                 enableTracing;
    uint32_t                maxTimeRequested;
    uint32_t                messageType;
    uint32_t                notifyType;
    IOService *             us;
    IOPMPowerStateIndex     stateNumber;
    IOPMPowerFlags          stateFlags;
    IOPMPowerChangeFlags    changeFlags;
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> *            errorLog;
    IOPMMessageFilter       messageFilter;
};

<span class="enscript-comment">// assertPMDriverCall() options
</span><span class="enscript-type">enum</span> {
    kIOPMADC_NoInactiveCheck = 1
};

<span class="enscript-comment">//******************************************************************************
</span><span class="enscript-comment">// PM Statistics &amp; Diagnostics
</span><span class="enscript-comment">//******************************************************************************
</span>
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> OSSymbol *gIOPMStatsApplicationResponseTimedOut;
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> OSSymbol *gIOPMStatsApplicationResponseCancel;
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> OSSymbol *gIOPMStatsApplicationResponseSlow;
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> OSSymbol *gIOPMStatsApplicationResponsePrompt;
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> OSSymbol *gIOPMStatsDriverPSChangeSlow;

<span class="enscript-comment">//******************************************************************************
</span><span class="enscript-comment">// IOPMRequest
</span><span class="enscript-comment">//******************************************************************************
</span>
class IOPMRequest : public IOCommand
{
    OSDeclareDefaultStructors( IOPMRequest )

<span class="enscript-reference">protected</span>:
    IOService *          fTarget;           <span class="enscript-comment">// request target
</span>    IOPMRequest *        fRequestNext;      <span class="enscript-comment">// the next request in the chain
</span>    IOPMRequest *        fRequestRoot;      <span class="enscript-comment">// the root request in the call tree
</span>    IOItemCount          fWorkWaitCount;    <span class="enscript-comment">// execution blocked if non-zero
</span>    IOItemCount          fFreeWaitCount;    <span class="enscript-comment">// completion blocked if non-zero
</span>    uint32_t             fRequestType;      <span class="enscript-comment">// request type
</span>    bool                 fIsQuiesceBlocker;

    IOPMCompletionAction fCompletionAction;
    <span class="enscript-type">void</span> *               fCompletionTarget;
    <span class="enscript-type">void</span> *               fCompletionParam;

<span class="enscript-reference">public</span>:
    uint32_t             fRequestTag;
    <span class="enscript-type">void</span> *               fArg0;
    <span class="enscript-type">void</span> *               fArg1;
    <span class="enscript-type">void</span> *               fArg2;

    inline bool          isWorkBlocked( <span class="enscript-type">void</span> ) <span class="enscript-type">const</span>
    {
        <span class="enscript-keyword">return</span> (fWorkWaitCount != 0);
    }

    inline bool          isFreeBlocked( <span class="enscript-type">void</span> ) <span class="enscript-type">const</span>
    {
        <span class="enscript-keyword">return</span> (fFreeWaitCount != 0);
    }

    inline IOPMRequest * getNextRequest( <span class="enscript-type">void</span> ) <span class="enscript-type">const</span>
    {
        <span class="enscript-keyword">return</span> fRequestNext;
    }

    inline IOPMRequest * getRootRequest( <span class="enscript-type">void</span> ) <span class="enscript-type">const</span>
    {
        <span class="enscript-keyword">if</span> (fRequestRoot) <span class="enscript-keyword">return</span> fRequestRoot;
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">NOT_READY</span>
        <span class="enscript-keyword">if</span> (fCompletionAction) <span class="enscript-keyword">return</span> (IOPMRequest *) this;
#<span class="enscript-reference">endif</span>
        <span class="enscript-keyword">return</span> 0;
    }

    inline uint32_t      getType( <span class="enscript-type">void</span> ) <span class="enscript-type">const</span>
    {
        <span class="enscript-keyword">return</span> fRequestType;
    }

    inline bool          isReplyType( <span class="enscript-type">void</span> ) <span class="enscript-type">const</span>
    {
        <span class="enscript-keyword">return</span> (fRequestType &gt; kIOPMRequestTypeReplyStart);
    }

    inline IOService *   getTarget( <span class="enscript-type">void</span> ) <span class="enscript-type">const</span>
    {
        <span class="enscript-keyword">return</span> fTarget;
    }

    inline bool          isQuiesceBlocker( <span class="enscript-type">void</span> ) <span class="enscript-type">const</span>
    {
        <span class="enscript-keyword">return</span> fIsQuiesceBlocker;
    }

    inline bool          isQuiesceType( <span class="enscript-type">void</span> ) <span class="enscript-type">const</span>
    {
        <span class="enscript-keyword">return</span> ((kIOPMRequestTypeQuiescePowerTree == fRequestType) &amp;&amp;
                (fCompletionAction != 0) &amp;&amp; (fCompletionTarget != 0));
    }

    inline <span class="enscript-type">void</span>          installCompletionAction(
                            <span class="enscript-type">void</span> *               target,
                            IOPMCompletionAction action,
                            <span class="enscript-type">void</span> *               param )
    {
        fCompletionTarget = target;
        fCompletionAction = action;
        fCompletionParam  = param;
    }

    <span class="enscript-type">static</span> IOPMRequest * create( <span class="enscript-type">void</span> );
    bool   init( IOService * owner, IOOptionBits type );
    <span class="enscript-type">void</span>   reset( <span class="enscript-type">void</span> );
    bool   attachNextRequest( IOPMRequest * next );
    bool   detachNextRequest( <span class="enscript-type">void</span> );
    bool   attachRootRequest( IOPMRequest * root );
    bool   detachRootRequest( <span class="enscript-type">void</span> );
};

<span class="enscript-comment">//******************************************************************************
</span><span class="enscript-comment">// IOPMRequestQueue
</span><span class="enscript-comment">//******************************************************************************
</span>
class IOPMRequestQueue : public IOEventSource
{
    OSDeclareDefaultStructors( IOPMRequestQueue )

<span class="enscript-reference">public</span>:
    <span class="enscript-type">typedef</span> bool (*Action)( IOService *, IOPMRequest *, IOPMRequestQueue * );

<span class="enscript-reference">protected</span>:
    queue_head_t    fQueue;
    IOLock *        fLock;

    <span class="enscript-type">enum</span> { kMaxDequeueCount = 256 };

    virtual bool checkForWork( <span class="enscript-type">void</span> ) APPLE_KEXT_OVERRIDE;
    virtual <span class="enscript-type">void</span> free( <span class="enscript-type">void</span> ) APPLE_KEXT_OVERRIDE;
    virtual bool init( IOService * inOwner, Action inAction );

<span class="enscript-reference">public</span>:
    <span class="enscript-type">static</span>  IOPMRequestQueue * create( IOService * inOwner, Action inAction );
    <span class="enscript-type">void</span>    queuePMRequest( IOPMRequest * request );
    <span class="enscript-type">void</span>    queuePMRequestChain( IOPMRequest ** requests, IOItemCount count );
};

<span class="enscript-comment">//******************************************************************************
</span><span class="enscript-comment">// IOPMWorkQueue
</span><span class="enscript-comment">//******************************************************************************
</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">WORK_QUEUE_STATS</span>    1

class IOPMWorkQueue : public IOEventSource
{
    OSDeclareDefaultStructors( IOPMWorkQueue )

<span class="enscript-reference">public</span>:
    <span class="enscript-type">typedef</span> bool (*Action)( IOService *, IOPMRequest *, IOPMWorkQueue * );

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">WORK_QUEUE_STATS</span>
    uint64_t            fStatCheckForWork;
    uint64_t            fStatScanEntries;
    uint64_t            fStatQueueEmpty;
    uint64_t            fStatNoWorkDone;
#<span class="enscript-reference">endif</span>

<span class="enscript-reference">protected</span>:
    queue_head_t        fWorkQueue;
    Action              fInvokeAction;
    Action              fRetireAction;
    uint32_t            fQueueLength;
    uint32_t            fConsumerCount;
    <span class="enscript-type">volatile</span> uint32_t   fProducerCount;
    IOPMRequest *       fQuiesceRequest;
    AbsoluteTime        fQuiesceStartTime;
    AbsoluteTime        fQuiesceFinishTime;

    virtual bool checkForWork( <span class="enscript-type">void</span> ) APPLE_KEXT_OVERRIDE;
    virtual bool init( IOService * inOwner, Action invoke, Action retire );
    bool    checkRequestQueue( queue_head_t * queue, bool * empty );

<span class="enscript-reference">public</span>:
    <span class="enscript-type">static</span>  IOPMWorkQueue * create( IOService * inOwner, Action invoke, Action retire );
    bool    queuePMRequest( IOPMRequest * request, IOServicePM * pwrMgt );
    <span class="enscript-type">void</span>    signalWorkAvailable( <span class="enscript-type">void</span> );
    <span class="enscript-type">void</span>    incrementProducerCount( <span class="enscript-type">void</span> );
    <span class="enscript-type">void</span>    attachQuiesceRequest( IOPMRequest * quiesceRequest );
    <span class="enscript-type">void</span>    finishQuiesceRequest( IOPMRequest * quiesceRequest );
};

<span class="enscript-comment">//******************************************************************************
</span><span class="enscript-comment">// IOPMCompletionQueue
</span><span class="enscript-comment">//******************************************************************************
</span>
class IOPMCompletionQueue : public IOEventSource
{
    OSDeclareDefaultStructors( IOPMCompletionQueue )

<span class="enscript-reference">public</span>:
    <span class="enscript-type">typedef</span> bool (*Action)( IOService *, IOPMRequest *, IOPMCompletionQueue * );

<span class="enscript-reference">protected</span>:
    queue_head_t    fQueue;

    virtual bool checkForWork( <span class="enscript-type">void</span> ) APPLE_KEXT_OVERRIDE;
    virtual bool init( IOService * inOwner, Action inAction );

<span class="enscript-reference">public</span>:
    <span class="enscript-type">static</span>  IOPMCompletionQueue * create( IOService * inOwner, Action inAction );
    bool    queuePMRequest( IOPMRequest * request );
};

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !_IOKIT_IOSERVICEPMPRIVATE_H */</span>
</pre>
<hr />
</body></html>