<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>TestCollections.cpp</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">TestCollections.cpp&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 1998-2000 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">DEBUG</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;Tests.h&quot;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSArray.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSSet.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSDictionary.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSString.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSSymbol.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSCollectionIterator.h&gt;</span>

<span class="enscript-type">void</span> <span class="enscript-function-name">testArray</span>()
{
    <span class="enscript-type">bool</span> res = true;
    <span class="enscript-type">void</span> *spaceCheck, *spaceCheck2 , *spaceCheck3;
    <span class="enscript-type">int</span> i, j, count, count2;
    OSObject *cache[numStrCache], *str, *sym;
    OSArray *array1, *array2;

    <span class="enscript-comment">// Do first test without memory leak tests to initialise the metaclass
</span>    array1 = OSArray::withCapacity(1);
    TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;0a&quot;</span>, array1);
    <span class="enscript-keyword">if</span> (array1)
        array1-&gt;release();

    <span class="enscript-comment">// Grow the symbol pool to maximum
</span>    <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++)
        cache[i] = (OSObject *) OSSymbol::withCStringNoCopy(strCache[i]);
    <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++)
        cache[i]-&gt;release();

    <span class="enscript-comment">// Create and destroy an array
</span>    spaceCheck = checkPointSpace();
    array1 = OSArray::withCapacity(1);
    TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;1a&quot;</span>, array1);
    <span class="enscript-keyword">if</span> (array1) {
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;1b&quot;</span>, !array1-&gt;getCount());
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;1c&quot;</span>, 1 == array1-&gt;getCapacity());
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;1d&quot;</span>, 1 == array1-&gt;getCapacityIncrement());
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;1e&quot;</span>, 4 == array1-&gt;setCapacityIncrement(4));
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;1f&quot;</span>, 4 == array1-&gt;getCapacityIncrement());
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;1g&quot;</span>, 8 == array1-&gt;ensureCapacity(5));

        spaceCheck2 = checkPointSpace();
        cache[0] = IOString::withCStringNoCopy(strCache[0]);

        spaceCheck3 = checkPointSpace();
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;1h&quot;</span>, array1-&gt;setObject(cache[0]));
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;1i&quot;</span>, cache[0] == array1-&gt;getObject(0));
        cache[0]-&gt;release();
        res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(A)1j&quot;</span>, spaceCheck3, 0);

        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;1k&quot;</span>, 1 == array1-&gt;getCount());
        array1-&gt;flushCollection();
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;1l&quot;</span>, !array1-&gt;getCount());
        res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(A)1m&quot;</span>, spaceCheck2, 0);

        array1-&gt;release();
    }
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(A)1&quot;</span>, spaceCheck, 0);

    <span class="enscript-comment">// Check the creation of a sizable OSArray from an array of IOObjects
</span>    <span class="enscript-comment">// Also check indexing into the array.
</span>    spaceCheck = checkPointSpace();
    <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++)
        cache[i] = OSString::withCStringNoCopy(strCache[i]);
    array1 = OSArray::withObjects(cache, numStrCache, numStrCache);
    TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;2a&quot;</span>, array1);
    <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++)
        cache[i]-&gt;release();
    <span class="enscript-keyword">if</span> (array1) {
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;2b&quot;</span>, numStrCache == (<span class="enscript-type">int</span>) array1-&gt;getCount());
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;2c&quot;</span>, numStrCache == (<span class="enscript-type">int</span>) array1-&gt;getCapacity());
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;2d&quot;</span>,
                    numStrCache == (<span class="enscript-type">int</span>) array1-&gt;getCapacityIncrement());

        <span class="enscript-keyword">for</span> (i = 0; (str = array1-&gt;getObject(i)); i++) {
            <span class="enscript-keyword">if</span> (str != cache[i]) {
                verPrintf((<span class="enscript-string">&quot;testArray(A) test 2e%d failed\n&quot;</span>, i));
                res = false;
            }
        }
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;2f&quot;</span>, numStrCache == i);
        array1-&gt;release();
    }
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(A)2&quot;</span>, spaceCheck, 0);

    <span class="enscript-comment">// Test array creation from another array by both the setObject method
</span>    <span class="enscript-comment">// and the withArray factory.  And test __takeObject code first
</span>    <span class="enscript-comment">// with tail removal then with head removal
</span>    spaceCheck = checkPointSpace();
    <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++)
        cache[i] = OSString::withCStringNoCopy(strCache[i]);
    array1 = OSArray::withObjects(cache, numStrCache, numStrCache);
    TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;3a&quot;</span>, array1);
    <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++)
        cache[i]-&gt;release();
    array2 = 0;
    <span class="enscript-keyword">if</span> (array1) {
        array2 = OSArray::withCapacity(1);
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;3b&quot;</span>, array2);
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;3c&quot;</span>, !array2-&gt;getCount());
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;3d&quot;</span>, array2-&gt;setObject(array1));
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;3e&quot;</span>, array1-&gt;getCount() == array2-&gt;getCount());
    }
    <span class="enscript-keyword">if</span> (array2) {
        count = 0;
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;3f&quot;</span>, numStrCache == (<span class="enscript-type">int</span>) array2-&gt;getCount());
        <span class="enscript-keyword">for</span> (i = array2-&gt;getCount(); (str = array2-&gt;__takeObject(--i)); ) {
            <span class="enscript-keyword">if</span> (str != cache[i]) {
                verPrintf((<span class="enscript-string">&quot;testArray(A) test 3g%d failed\n&quot;</span>, i));
                res = false;
            }
            count += ((<span class="enscript-type">int</span>) array2-&gt;getCount() == i);
            str-&gt;release();
        }
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;3h&quot;</span>, count == numStrCache);
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;3i&quot;</span>, -1 == i);
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;3j&quot;</span>, !array2-&gt;getCount());

        spaceCheck2 = checkPointSpace();
        array2-&gt;flushCollection();
        res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(A)3k&quot;</span>, spaceCheck2, 0);

        array2-&gt;release();
        array2 = 0;
    }
    <span class="enscript-keyword">if</span> (array1) {
        array2 = OSArray::withArray(array1, numStrCache - 1);
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;3l&quot;</span>, !array2);
        array2 = OSArray::withArray(array1, array1-&gt;getCount());
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;3m&quot;</span>, array2);
        array1-&gt;release();
    }
    <span class="enscript-keyword">if</span> (array2) {
        count = 0;
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;3o&quot;</span>, numStrCache == (<span class="enscript-type">int</span>) array2-&gt;getCount());
        <span class="enscript-keyword">for</span> (i = 0; (str = array2-&gt;__takeObject(0)); i++) {
            count += (str == cache[i]);
            str-&gt;release();
        }
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;3p&quot;</span>, count == numStrCache);
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;3q&quot;</span>, !array2-&gt;getCount());
        array2-&gt;release();
        array2 = 0;
    }
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(A)3&quot;</span>, spaceCheck, 0);

    <span class="enscript-comment">// Test object replacement from one array to another
</span>    spaceCheck = checkPointSpace();
    array1 = OSArray::withCapacity(numStrCache);
    TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;4a&quot;</span>, array1);
    <span class="enscript-keyword">if</span> (array1) {
        count = count2 = 0;
        <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++) {
            str = OSString::withCStringNoCopy(strCache[i]);
            count += array1-&gt;setObject(str);
            count2 += (str == array1-&gt;lastObject());
            str-&gt;release();
        }
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;4b&quot;</span>, numStrCache == (<span class="enscript-type">int</span>) array1-&gt;getCount());
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;4c&quot;</span>, count == numStrCache);
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;4d&quot;</span>, count2 == numStrCache);
    }
    array2 = OSArray::withCapacity(1);
    TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;4e&quot;</span>, array2);
    <span class="enscript-keyword">if</span> (array2) {
        count = count2 = 0;
        str = (OSObject *) OSSymbol::withCStringNoCopy(strCache[0]);
        <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++) {
            sym = (OSObject *) OSSymbol::withCStringNoCopy(strCache[i]);
            count += array2-&gt;setObject(sym, 0);
            count2 += (str == array2-&gt;lastObject());
            sym-&gt;release();
        }
        str-&gt;release();
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;4f&quot;</span>, numStrCache == (<span class="enscript-type">int</span>) array2-&gt;getCount());
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;4g&quot;</span>, count == numStrCache);
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;4h&quot;</span>, count2 == numStrCache);
    }
    <span class="enscript-keyword">if</span> (array1 &amp;&amp; array2) {

        count = count2 = 0;
        <span class="enscript-keyword">for</span> (i = array1-&gt;getCount() - 1; (sym = array2-&gt;__takeObject(0)); i--) {
            str = array1-&gt;replaceObject(sym, i);
            count  += (str != 0);
            count2 += (sym != str);
            <span class="enscript-keyword">if</span> (str)
                str-&gt;release();
            <span class="enscript-keyword">if</span> (sym)
                sym-&gt;release();
        }
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;4k&quot;</span>, numStrCache == (<span class="enscript-type">int</span>) array1-&gt;getCount());
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;4l&quot;</span>, count == numStrCache);
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;4m&quot;</span>, count2 == numStrCache);
        array1-&gt;release();
        array2-&gt;release();
    }
    <span class="enscript-keyword">else</span> {
        <span class="enscript-keyword">if</span> (array1) array1-&gt;release();
        <span class="enscript-keyword">if</span> (array2) array2-&gt;release();
    }
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(A)4&quot;</span>, spaceCheck, 0);

    <span class="enscript-comment">// Test array duplicate removal
</span>    spaceCheck = checkPointSpace();
    array1 = OSArray::withCapacity(numStrCache);
    TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;5a&quot;</span>, array1);
    <span class="enscript-keyword">if</span> (array1) {
        <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++) {
            sym = (OSObject *) OSSymbol::withCStringNoCopy(strCache[i]);
            count += array1-&gt;setObject(sym);
            sym-&gt;release();
        }
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;5b&quot;</span>, numStrCache == (<span class="enscript-type">int</span>) array1-&gt;getCount());

        <span class="enscript-comment">// remove duplicates
</span>        <span class="enscript-keyword">for</span> (i = 0; (sym = array1-&gt;getObject(i)); )
            <span class="enscript-keyword">if</span> (sym-&gt;getRetainCount() == 1)
                i++;
            <span class="enscript-keyword">else</span> {
                <span class="enscript-comment">//sym = array1-&gt;__takeObject(i);
</span>                <span class="enscript-comment">//sym-&gt;release();
</span>                array1-&gt;removeObject(i);
            }
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;5c&quot;</span>, numStrCache != (<span class="enscript-type">int</span>) array1-&gt;getCount());

        <span class="enscript-comment">// check to see that all symbols are really there
</span>        <span class="enscript-keyword">for</span> (count = 0, i = 0; i &lt; numStrCache; i++) {
            sym = (OSObject *) OSSymbol::withCStringNoCopy(strCache[i]);
            <span class="enscript-keyword">for</span> (count2 = false, j = 0; (str = array1-&gt;getObject(j)); j++)
                <span class="enscript-keyword">if</span> (str == sym) {
                    count2 = true;
                    <span class="enscript-keyword">break</span>;
                }
            count += count2;
            sym-&gt;release();
        }
        TEST_ASSERT(<span class="enscript-string">'A'</span>, <span class="enscript-string">&quot;5c&quot;</span>, count == numStrCache);
        array1-&gt;release();
    }
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(S)5&quot;</span>, spaceCheck, 0);

    <span class="enscript-keyword">if</span> (res)
        verPrintf((<span class="enscript-string">&quot;testArray: All OSArray Tests passed\n&quot;</span>));
    <span class="enscript-keyword">else</span>
        logPrintf((<span class="enscript-string">&quot;testArray: Some OSArray Tests failed\n&quot;</span>));
}

<span class="enscript-type">void</span> <span class="enscript-function-name">testSet</span>()
{
    <span class="enscript-type">bool</span> res = true;
    <span class="enscript-type">void</span> *spaceCheck, *spaceCheck2 , *spaceCheck3;
    <span class="enscript-type">int</span> i, count, count2;
    OSObject *cache[numStrCache], *str, *sym;
    OSSet *set1, *set2;
    OSArray *array;

    <span class="enscript-comment">// Do first test without memory leak tests to initialise the metaclass
</span>    set1 = OSSet::withCapacity(1);
    TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;0a&quot;</span>, set1);
    <span class="enscript-keyword">if</span> (set1)
        set1-&gt;release();

    <span class="enscript-comment">// Grow the symbol pool to maximum
</span>    <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++)
        cache[i] = (OSObject *) OSSymbol::withCStringNoCopy(strCache[i]);
    <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++)
        cache[i]-&gt;release();

    <span class="enscript-comment">// Create and destroy an set
</span>    spaceCheck = checkPointSpace();
    set1 = OSSet::withCapacity(1);
    TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;1a&quot;</span>, set1);
    <span class="enscript-keyword">if</span> (set1) {
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;1b&quot;</span>, !set1-&gt;getCount());
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;1c&quot;</span>, 1 == set1-&gt;getCapacity());
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;1d&quot;</span>, 1 == set1-&gt;getCapacityIncrement());
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;1e&quot;</span>, 4 == set1-&gt;setCapacityIncrement(4));
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;1f&quot;</span>, 4 == set1-&gt;getCapacityIncrement());
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;1g&quot;</span>, 8 == set1-&gt;ensureCapacity(5));

        spaceCheck2 = checkPointSpace();
        cache[0] = IOString::withCStringNoCopy(strCache[0]);

        spaceCheck3 = checkPointSpace();
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;1h&quot;</span>, set1-&gt;setObject(cache[0]));
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;1i&quot;</span>, set1-&gt;containsObject(cache[0]));
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;1j&quot;</span>, cache[0] == set1-&gt;getAnyObject());
        cache[0]-&gt;release();
        res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(S)1k&quot;</span>, spaceCheck3, 0);

        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;1l&quot;</span>, 1 == set1-&gt;getCount());
        set1-&gt;flushCollection();
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;1m&quot;</span>, !set1-&gt;getCount());
        res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(S)1n&quot;</span>, spaceCheck2, 0);

        set1-&gt;release();
    }
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(S)1&quot;</span>, spaceCheck, 0);

    <span class="enscript-comment">// Check the creation of a sizable OSSet from an set of IOObjects
</span>    <span class="enscript-comment">// Also check member test of set.
</span>    spaceCheck = checkPointSpace();
    <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++)
        cache[i] = OSString::withCStringNoCopy(strCache[i]);
    set1 = OSSet::withObjects(cache, numStrCache, numStrCache);
    TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;2a&quot;</span>, set1);
    <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++)
        cache[i]-&gt;release();
    <span class="enscript-keyword">if</span> (set1) {
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;2b&quot;</span>, numStrCache == (<span class="enscript-type">int</span>) set1-&gt;getCount());
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;2c&quot;</span>, numStrCache == (<span class="enscript-type">int</span>) set1-&gt;getCapacity());
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;2d&quot;</span>,
                    numStrCache == (<span class="enscript-type">int</span>) set1-&gt;getCapacityIncrement());

        count = 0;
        <span class="enscript-keyword">for</span> (i = set1-&gt;getCount(); --i &gt;= 0; )
            count += set1-&gt;member(cache[i]);

        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;2e&quot;</span>, numStrCache == count);
        set1-&gt;release();
    }
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(S)2&quot;</span>, spaceCheck, 0);

    <span class="enscript-comment">// Test set creation from another set by both the setObject method
</span>    <span class="enscript-comment">// and the withArray factory.  And test __takeObject code first
</span>    <span class="enscript-comment">// with tail removal then with head removal
</span>    spaceCheck = checkPointSpace();
    <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++)
        cache[i] = OSString::withCStringNoCopy(strCache[i]);
    set1 = OSSet::withObjects(cache, numStrCache, numStrCache);
    TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;3a&quot;</span>, set1);
    <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++)
        cache[i]-&gt;release();
    set2 = 0;
    <span class="enscript-keyword">if</span> (set1) {
        set2 = OSSet::withCapacity(set1-&gt;getCount());
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;3b&quot;</span>, set2);
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;3c&quot;</span>, !set2-&gt;getCount());
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;3d&quot;</span>, set2-&gt;setObject(set1));
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;3e&quot;</span>, set1-&gt;getCount() == set2-&gt;getCount());
    }
    <span class="enscript-keyword">if</span> (set2) {
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;3f&quot;</span>, numStrCache == (<span class="enscript-type">int</span>) set2-&gt;getCount());
        count = count2 = 0;
        <span class="enscript-keyword">while</span> ( (str = set2-&gt;getAnyObject()) ) {
            count  += set2-&gt;__takeObject(str);
            count2 += set1-&gt;member(str);
            str-&gt;release();
        }
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;3g&quot;</span>, !set2-&gt;getCount());
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;3h&quot;</span>, numStrCache == count);
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;3i&quot;</span>, numStrCache == count2);

        spaceCheck2 = checkPointSpace();
        set2-&gt;flushCollection();
        res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(S)3j&quot;</span>, spaceCheck2, 0);

        set2-&gt;release();
        set2 = 0;
    }
    <span class="enscript-keyword">if</span> (set1) {
        set2 = OSSet::withSet(set1, numStrCache - 1);
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;3k&quot;</span>, !set2);
        set2 = OSSet::withSet(set1, set1-&gt;getCount());
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;3l&quot;</span>, set2);
        set1-&gt;release();
    }
    <span class="enscript-keyword">if</span> (set2) {
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;3m&quot;</span>, numStrCache == (<span class="enscript-type">int</span>) set2-&gt;getCount());
        i = count = count2 = 0;
        <span class="enscript-keyword">while</span> ( (str = set2-&gt;getAnyObject()) ) {
            count  += set2-&gt;__takeObject(str);
            count2 += (cache[i++] == str);
            str-&gt;release();
        }
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;3n&quot;</span>, !set2-&gt;getCount());
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;3o&quot;</span>, numStrCache == count);
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;3p&quot;</span>, numStrCache == count2);

        set2-&gt;release();
        set2 = 0;
    }
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(S)3&quot;</span>, spaceCheck, 0);

    <span class="enscript-comment">// Test duplicate removal
</span>    spaceCheck = checkPointSpace();
    set2 = 0;
    set1 = OSSet::withCapacity(numStrCache);
    TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;4a&quot;</span>, set1);
    <span class="enscript-keyword">if</span> (set1) {
        count = 0;
        <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++) {
            sym = (OSObject *) OSSymbol::withCStringNoCopy(strCache[i]);
            count += set1-&gt;setObject(sym);
            sym-&gt;release();
        }
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;4b&quot;</span>, numStrCache != (<span class="enscript-type">int</span>) set1-&gt;getCount());
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;4c&quot;</span>, count == (<span class="enscript-type">int</span>) set1-&gt;getCount());

        count = count2 = 0;
        <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++) {
            sym = (OSObject *) OSSymbol::withCStringNoCopy(strCache[i]);
            count += set1-&gt;member(sym);
            count2 += sym-&gt;getRetainCount();
            sym-&gt;release();
        }
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;4d&quot;</span>, count  == numStrCache);
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;4e&quot;</span>, count2 == numStrCache * 2);

        set2 = OSSet::withSet(set1, 2 * set1-&gt;getCount());
    }
    TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;4f&quot;</span>, set2);
    <span class="enscript-keyword">if</span> (set2) {
        set2-&gt;setObject(set1);
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;4g&quot;</span>, set1-&gt;getCount() == set2-&gt;getCount());
        set1-&gt;release();
        set2-&gt;release();
    }
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(S)4&quot;</span>, spaceCheck, 0);

    <span class="enscript-comment">// Test array duplicate removal
</span>    spaceCheck = checkPointSpace();
    array = OSArray::withCapacity(numStrCache);
    <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++) {
        sym = (OSObject *) OSSymbol::withCStringNoCopy(strCache[i]);
        count += array-&gt;setObject(sym);
        sym-&gt;release();
    }
    set1 = OSSet::withArray(array, numStrCache);
    TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;5a&quot;</span>, set1);
    <span class="enscript-keyword">if</span> (set1) {
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;5b&quot;</span>, array-&gt;getCount() != set1-&gt;getCount());
        array-&gt;release();

        count = count2 = set1-&gt;getCount();
        <span class="enscript-keyword">while</span> ( (sym = set1-&gt;getAnyObject()) ) {
            count  -= set1-&gt;__takeObject(sym);
            count2 -= sym-&gt;getRetainCount();
            sym-&gt;release();
        }
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;5c&quot;</span>, !count);
        TEST_ASSERT(<span class="enscript-string">'S'</span>, <span class="enscript-string">&quot;5d&quot;</span>, !count2);
        set1-&gt;release();
    }
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(S)5&quot;</span>, spaceCheck, 0);

    <span class="enscript-keyword">if</span> (res)
        verPrintf((<span class="enscript-string">&quot;testSet: All OSSet Tests passed\n&quot;</span>));
    <span class="enscript-keyword">else</span>
        logPrintf((<span class="enscript-string">&quot;testSet: Some OSSet Tests failed\n&quot;</span>));
}

<span class="enscript-type">void</span> <span class="enscript-function-name">testDictionary</span>()
{
    <span class="enscript-type">bool</span> res = true;
    <span class="enscript-type">void</span> *spaceCheck, *spaceCheck2, *spaceCheck3;
    OSObject *cache[numStrCache];
    OSString *str;
    <span class="enscript-type">const</span> OSSymbol *symCache[numStrCache], *sym;
    OSDictionary *dict1, *dict2;
    <span class="enscript-type">int</span> i, numSymbols, count1, count2;

    <span class="enscript-comment">// Do first test without memory leak tests to initialise the metaclass
</span>    dict1 = OSDictionary::withCapacity(1);
    TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;0a&quot;</span>, dict1);
    <span class="enscript-keyword">if</span> (dict1)
        dict1-&gt;release();

    <span class="enscript-comment">// Grow the symbol pool to maximum
</span>    <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++)
        symCache[i] = OSSymbol::withCStringNoCopy(strCache[i]);
    <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++)
        symCache[i]-&gt;release();

    <span class="enscript-comment">// Create and destroy a dictionary
</span>    spaceCheck = checkPointSpace();
    dict1 = OSDictionary::withCapacity(1);
    TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;1a&quot;</span>, dict1);
    <span class="enscript-keyword">if</span> (dict1) {
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;1b&quot;</span>, !dict1-&gt;getCount());
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;1c&quot;</span>, 1 == dict1-&gt;getCapacity());
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;1d&quot;</span>, 1 == dict1-&gt;getCapacityIncrement());
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;1e&quot;</span>, 4 == dict1-&gt;setCapacityIncrement(4));
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;1f&quot;</span>, 4 == dict1-&gt;getCapacityIncrement());
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;1g&quot;</span>, 8 == dict1-&gt;ensureCapacity(5));

        spaceCheck2 = checkPointSpace();
        sym = OSSymbol::withCStringNoCopy(strCache[0]);

        spaceCheck3 = checkPointSpace();
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;1h&quot;</span>, dict1-&gt;setObject((OSObject *) sym, sym));
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;1i&quot;</span>, (OSObject *) sym == dict1-&gt;getObject(sym));
        sym-&gt;release();
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;1i&quot;</span>, 2 == sym-&gt;getRetainCount());
        res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(D)1j&quot;</span>, spaceCheck3, 0);

        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;1k&quot;</span>, 1 == dict1-&gt;getCount());
        dict1-&gt;flushCollection();
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;1l&quot;</span>, !dict1-&gt;getCount());
        res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(D)1m&quot;</span>, spaceCheck2, 0);

        dict1-&gt;release();
    }
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(D)1&quot;</span>, spaceCheck, 0);

    <span class="enscript-comment">// Check the creation of a sizable OSDictionary from an array of IOObjects
</span>    <span class="enscript-comment">// Also check indexing into the array.
</span>    spaceCheck = checkPointSpace();
    <span class="enscript-keyword">for</span> (i = 0, numSymbols = 0; i &lt; numStrCache; i++) {
        sym = OSSymbol::withCStringNoCopy(strCache[i]);
        <span class="enscript-keyword">if</span> (1 == sym-&gt;getRetainCount())
            symCache[numSymbols++] = sym;
        <span class="enscript-keyword">else</span>
            sym-&gt;release();
    }
    dict1 = OSDictionary::withObjects(
                    (OSObject **) symCache, symCache, numSymbols, numSymbols);
    TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;2a&quot;</span>, dict1);
    count1 = count2 = 0;
    <span class="enscript-keyword">for</span> (i = 0; i &lt; numSymbols; i++)
        count1 += (symCache[i]-&gt;getRetainCount() == 3);
    TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;2b&quot;</span>, count1 == numSymbols);
    <span class="enscript-keyword">if</span> (dict1) {
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;2c&quot;</span>, numSymbols == (<span class="enscript-type">int</span>) dict1-&gt;getCount());
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;2d&quot;</span>, numSymbols == (<span class="enscript-type">int</span>) dict1-&gt;getCapacity());
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;2e&quot;</span>,
                    numSymbols == (<span class="enscript-type">int</span>) dict1-&gt;getCapacityIncrement());

        <span class="enscript-keyword">for</span> (i = dict1-&gt;getCount(); --i &gt;= 0; ) {
            str = (OSString *) dict1-&gt;getObject(symCache[i]);
            <span class="enscript-keyword">if</span> (str != (OSString *) symCache[i]) {
                verPrintf((<span class="enscript-string">&quot;testDictionary(D) test 2f%d failed\n&quot;</span>, i));
                res = false;
            }
        }
        dict1-&gt;release();
    }
    count1 = count2 = 0;
    <span class="enscript-keyword">for</span> (i = 0; i &lt; numSymbols; i++) {
        count1 += (symCache[i]-&gt;getRetainCount() == 1);
        symCache[i]-&gt;release();
    }
    TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;2g&quot;</span>, count1 == numSymbols);
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(D)2&quot;</span>, spaceCheck, 0);

    <span class="enscript-comment">// Check the creation of a sizable Dictionary from an array of IOStrings
</span>    <span class="enscript-comment">// Also check searching dictionary use OSString for a key.
</span>    spaceCheck = checkPointSpace();
    <span class="enscript-keyword">for</span> (i = 0, numSymbols = 0; i &lt; numStrCache; i++) {
        sym = OSSymbol::withCStringNoCopy(strCache[i]);
        <span class="enscript-keyword">if</span> (1 == sym-&gt;getRetainCount()) {
            cache[numSymbols] = OSString::withCStringNoCopy(strCache[i]);
            symCache[numSymbols] = sym;
            numSymbols++;
        }
        <span class="enscript-keyword">else</span>
            sym-&gt;release();
    }
    dict1 = OSDictionary::withObjects((OSObject **) symCache,
                                      (OSString **) cache,
                                      numSymbols, numSymbols);
    TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;3a&quot;</span>, dict1);
    count1 = count2 = 0;
    <span class="enscript-keyword">for</span> (i = 0; i &lt; numSymbols; i++) {
        count1 += (symCache[i]-&gt;getRetainCount() == 3);
        count2 += (cache[i]-&gt;getRetainCount() == 1);
    }
    TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;3b&quot;</span>, count1 == numSymbols);
    TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;3c&quot;</span>, count2 == numSymbols);
    <span class="enscript-keyword">if</span> (dict1) {
        count1 = count2 = 0;
        <span class="enscript-keyword">for</span> (i = 0; i &lt; numSymbols; i++) {
            str = (OSString *) cache[i];
            count1 += (symCache[i] == (<span class="enscript-type">const</span> OSSymbol *) dict1-&gt;getObject(str));
            count2 += (symCache[i]-&gt;getRetainCount() == 3);
        }
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;3d&quot;</span>, count1 == numSymbols);
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;3e&quot;</span>, count2 == numSymbols);

        count1 = count2 = 0;
        <span class="enscript-keyword">for</span> (i = 0; i &lt; numSymbols; i++) {
            <span class="enscript-type">const</span> <span class="enscript-type">char</span> *cStr = ((OSString *) cache[i])-&gt;getCStringNoCopy();

            count1 += (symCache[i] == (<span class="enscript-type">const</span> OSSymbol *) dict1-&gt;getObject(cStr));
            count2 += (symCache[i]-&gt;getRetainCount() == 3);
        }
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;3f&quot;</span>, count1 == numSymbols);
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;3g&quot;</span>, count2 == numSymbols);

        dict1-&gt;release();
    }
    count1 = count2 = 0;
    <span class="enscript-keyword">for</span> (i = 0; i &lt; numSymbols; i++) {
        count1 += (symCache[i]-&gt;getRetainCount() == 1);
        count2 += (cache[i]-&gt;getRetainCount() == 1);
        symCache[i]-&gt;release();
        cache[i]-&gt;release();
    }
    TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;3h&quot;</span>, count1 == numSymbols);
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(D)3&quot;</span>, spaceCheck, 0);

    <span class="enscript-comment">// Check the creation of a small dictionary then grow it one item at a time
</span>    <span class="enscript-comment">// Create a new dictionary from the old dictionary.
</span>    <span class="enscript-comment">// Finally remove each item permanently.
</span>    spaceCheck = checkPointSpace();
    <span class="enscript-keyword">for</span> (i = 0, numSymbols = 0; i &lt; numStrCache; i++) {
        sym = OSSymbol::withCStringNoCopy(strCache[i]);
        <span class="enscript-keyword">if</span> (1 == sym-&gt;getRetainCount()) {
            cache[numSymbols] = OSString::withCStringNoCopy(strCache[i]);
            symCache[numSymbols] = sym;
            numSymbols++;
        }
        <span class="enscript-keyword">else</span>
            sym-&gt;release();
    }
    dict2 = 0;
    dict1 = OSDictionary::withCapacity(1);
    TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;4a&quot;</span>, dict1);
    <span class="enscript-keyword">if</span> (dict1) {
        count1 = count2 = 0;
        <span class="enscript-keyword">for</span> (i = 0; i &lt; numSymbols; i++) {
            sym = symCache[i];
            count1 += ((OSObject *) sym == dict1-&gt;setObject((OSObject *) sym,
                                               sym-&gt;getCStringNoCopy()));
            count2 += (sym-&gt;getRetainCount() == 3);
        }
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;4b&quot;</span>, numSymbols == (<span class="enscript-type">int</span>) dict1-&gt;getCount());
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;4c&quot;</span>, numSymbols == count1);
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;4d&quot;</span>, numSymbols == count2);

        dict2 = OSDictionary::withDictionary(dict1, numSymbols-1);
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;4b&quot;</span>, !dict2);
        dict2 = OSDictionary::withDictionary(dict1, numSymbols);
    }
    TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;4e&quot;</span>, dict2);
    <span class="enscript-keyword">if</span> (dict2) {
        dict1-&gt;release(); dict1 = 0;

        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;4f&quot;</span>, numSymbols == (<span class="enscript-type">int</span>) dict2-&gt;getCount());

        count1 = count2 = 0;
        <span class="enscript-keyword">for</span> (i = 0; i &lt; numSymbols; i++) {
            OSObject *replacedObject;

            sym = symCache[i];
            str = (OSString *) cache[i];
            replacedObject = dict2-&gt;setObject(str, str);
            count1 += ((OSString *) sym == replacedObject);
            replacedObject-&gt;release();
            count2 += (sym-&gt;getRetainCount() == 2);
            str-&gt;release();
        }
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;4g&quot;</span>, numSymbols == count1);
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;4h&quot;</span>, numSymbols == count2);

        count1 = count2 = 0;
        <span class="enscript-keyword">for</span> (i = 0; i &lt; numSymbols; i++) {
            sym = symCache[i];
            str = (OSString *) cache[i];
            count1 += (str == dict2-&gt;__takeObject(sym));
            str-&gt;release();
            count2 += (sym-&gt;getRetainCount() == 1);
            sym-&gt;release();
        }
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;4i&quot;</span>, numSymbols == count1);
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;4j&quot;</span>, numSymbols == count2);
        TEST_ASSERT(<span class="enscript-string">'D'</span>, <span class="enscript-string">&quot;4k&quot;</span>, !dict2-&gt;getCount());
        dict2-&gt;release(); dict2 = 0;
    }
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (dict1)
        dict1-&gt;release();
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(D)4&quot;</span>, spaceCheck, 0);

    <span class="enscript-keyword">if</span> (res)
        verPrintf((<span class="enscript-string">&quot;testDictionary: All OSDictionary Tests passed\n&quot;</span>));
    <span class="enscript-keyword">else</span>
        logPrintf((<span class="enscript-string">&quot;testDictionary: Some OSDictionary Tests failed\n&quot;</span>));
}

<span class="enscript-type">void</span> <span class="enscript-function-name">testIterator</span>()
{
    <span class="enscript-type">bool</span> res = true;
    <span class="enscript-type">void</span> *spaceCheck;
    OSObject *cache[numStrCache];
    OSString *str = 0;
    <span class="enscript-type">const</span> OSSymbol *symCache[numStrCache], *sym;
    OSDictionary *dict;
    OSSet *set;
    OSArray *array, *bigReturn;
    OSCollectionIterator *iter1, *iter2;
    <span class="enscript-type">int</span> i, numSymbols, count1, count2, count3;

    <span class="enscript-comment">// Setup symbol and string pools
</span>    <span class="enscript-keyword">for</span> (i = 0, numSymbols = 0; i &lt; numStrCache; i++) {
        sym = OSSymbol::withCStringNoCopy(strCache[i]);
        <span class="enscript-keyword">if</span> (1 == sym-&gt;getRetainCount()) {
            cache[numSymbols] = OSString::withCStringNoCopy(strCache[i]);
            symCache[numSymbols] = sym;
            numSymbols++;
        }
        <span class="enscript-keyword">else</span>
            sym-&gt;release();
    }

    <span class="enscript-comment">// Test the array iterator
</span>    spaceCheck = checkPointSpace();
    iter1 = iter2 = 0;
    array = OSArray::withCapacity(numSymbols);
    TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;1a&quot;</span>, array);
    <span class="enscript-keyword">if</span> (array) {
        count1 = count2 = 0;
        <span class="enscript-keyword">for</span> (i = numSymbols; --i &gt;= 0; )
            count1 += array-&gt;setObject(cache[i], 0);
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;1b&quot;</span>, count1 == numSymbols);

        iter1 = OSCollectionIterator::withCollection(array);
        iter2 = OSCollectionIterator::withCollection(array);
    }
    TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;1c&quot;</span>, iter1);
    TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;1d&quot;</span>, iter2);
    <span class="enscript-keyword">if</span> (iter1 &amp;&amp; iter2) {
        count1 = count2 = count3 = 0;
        <span class="enscript-keyword">for</span> (i = 0; (str = (IOString *) iter1-&gt;getNextObject()); i++) {
            bigReturn = iter2-&gt;nextEntries();
            count1 += (bigReturn-&gt;getCount() == 1);
            count2 += (cache[i] == bigReturn-&gt;getObject(0));
            count3 += (cache[i] == str);
        }
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;1e&quot;</span>, count1 == numSymbols);
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;1f&quot;</span>, count2 == numSymbols);
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;1g&quot;</span>, count3 == numSymbols);
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;1h&quot;</span>, iter1-&gt;valid());
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;1i&quot;</span>, iter2-&gt;valid());

        iter1-&gt;reset();
        str = (OSString *) array-&gt;__takeObject(0);
        array-&gt;setObject(str, 0);
        str-&gt;release();
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;1j&quot;</span>, !iter1-&gt;getNextObject());
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;1k&quot;</span>, !iter1-&gt;valid());

        iter1-&gt;reset();
        count1 = count2 = count3 = 0;
        <span class="enscript-keyword">for</span> (i = 0; ; i++) {
            <span class="enscript-keyword">if</span> (i &amp; 1)
                str = (OSString *) iter1-&gt;getNextObject();
            <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> ( (bigReturn = iter1-&gt;nextEntries()) )
                str = (OSString *) bigReturn-&gt;getObject(0);
            <span class="enscript-keyword">else</span>
                str = 0;

            <span class="enscript-keyword">if</span> (!str)
                <span class="enscript-keyword">break</span>;
            count1 += (cache[i] == str);
        }
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;1l&quot;</span>, count1 == numSymbols);
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;1m&quot;</span>, i == numSymbols);
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;1n&quot;</span>, iter1-&gt;valid());

        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;1o&quot;</span>, 3 == array-&gt;getRetainCount());
        array-&gt;release();
    }

    <span class="enscript-keyword">if</span> (iter1) iter1-&gt;release();
    <span class="enscript-keyword">if</span> (iter2) iter2-&gt;release();
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(I)1&quot;</span>, spaceCheck, 0);

    <span class="enscript-comment">// Test the set iterator
</span>    spaceCheck = checkPointSpace();
    iter1 = 0;
    set = OSSet::withCapacity(numSymbols);
    TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;2a&quot;</span>, set);
    <span class="enscript-keyword">if</span> (set) {
        count1 = count2 = 0;
        <span class="enscript-keyword">for</span> (i = 0; i &lt; numSymbols; i++)
            count1 += set-&gt;setObject(cache[i]);
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;2b&quot;</span>, count1 == numSymbols);

        iter1 = OSCollectionIterator::withCollection(set);
        iter2 = OSCollectionIterator::withCollection(set);
    }
    TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;2c&quot;</span>, iter1);
    TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;2d&quot;</span>, iter2);
    <span class="enscript-keyword">if</span> (iter1 &amp;&amp; iter2) {
        count1 = count2 = count3 = 0;
        <span class="enscript-keyword">for</span> (i = 0; (str = (IOString *) iter1-&gt;getNextObject()); i++) {
            bigReturn = iter2-&gt;nextEntries();
            count1 += (bigReturn-&gt;getCount() == 1);
            count2 += (cache[i] == bigReturn-&gt;getObject(0));
            count3 += (cache[i] == str);
        }
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;2e&quot;</span>, count1 == numSymbols);
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;2f&quot;</span>, count2 == numSymbols);
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;2g&quot;</span>, count3 == numSymbols);
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;2h&quot;</span>, iter1-&gt;valid());
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;2i&quot;</span>, iter2-&gt;valid());

        iter1-&gt;reset();
        count1 = count2 = count3 = 0;
        <span class="enscript-keyword">for</span> (i = 0; ; i++) {
            <span class="enscript-keyword">if</span> (i &amp; 1)
                str = (OSString *) iter1-&gt;getNextObject();
            <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> ( (bigReturn = iter1-&gt;nextEntries()) )
                str = (OSString *) bigReturn-&gt;getObject(0);
            <span class="enscript-keyword">else</span>
                str = 0;

            <span class="enscript-keyword">if</span> (!str)
                <span class="enscript-keyword">break</span>;
            count1 += (cache[i] == str);
        }
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;2l&quot;</span>, count1 == numSymbols);
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;2m&quot;</span>, i == numSymbols);
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;2n&quot;</span>, iter1-&gt;valid());

        iter1-&gt;reset();
        str = (OSString *) set-&gt;getAnyObject();
        (<span class="enscript-type">void</span>) set-&gt;__takeObject(str);
        set-&gt;setObject(str);
        str-&gt;release();
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;2j&quot;</span>, !iter1-&gt;getNextObject());
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;2k&quot;</span>, !iter1-&gt;valid());

        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;2o&quot;</span>, 3 == set-&gt;getRetainCount());
        set-&gt;release();
    }

    <span class="enscript-keyword">if</span> (iter1) iter1-&gt;release();
    <span class="enscript-keyword">if</span> (iter2) iter2-&gt;release();
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(I)2&quot;</span>, spaceCheck, 0);

    <span class="enscript-comment">// Test the dictionary iterator
</span>    spaceCheck = checkPointSpace();
    iter1 = 0;
    dict = OSDictionary::withCapacity(numSymbols);
    TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;3a&quot;</span>, dict);
    <span class="enscript-keyword">if</span> (dict) {
        count1 = count2 = 0;
        <span class="enscript-keyword">for</span> (i = 0; i &lt; numSymbols; i++)
            count1 += (0 != dict-&gt;setObject(cache[i], symCache[i]));
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;3b&quot;</span>, count1 == numSymbols);

        iter1 = OSCollectionIterator::withCollection(dict);
        iter2 = OSCollectionIterator::withCollection(dict);
    }
    TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;3c&quot;</span>, iter1);
    TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;3d&quot;</span>, iter2);
    <span class="enscript-keyword">if</span> (iter1 &amp;&amp; iter2) {
        count1 = count2 = count3 = 0;
        <span class="enscript-keyword">for</span> (i = 0; (sym = (<span class="enscript-type">const</span> IOSymbol *) iter1-&gt;getNextObject()); i++) {
            bigReturn = iter2-&gt;nextEntries();
            count1 += (bigReturn-&gt;getCount() == 2);
            count2 += (cache[i] == bigReturn-&gt;getObject(1));
            count3 += (symCache[i] == sym);
        }
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;3e&quot;</span>, count1 == numSymbols);
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;3f&quot;</span>, count2 == numSymbols);
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;3g&quot;</span>, count3 == numSymbols);
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;3h&quot;</span>, iter1-&gt;valid());
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;3i&quot;</span>, iter2-&gt;valid());

        iter1-&gt;reset();
        count1 = count2 = count3 = 0;
        i = 0;
        <span class="enscript-keyword">for</span> (i = 0; ; i++) {
            <span class="enscript-keyword">if</span> (i &amp; 1) {
                sym = (<span class="enscript-type">const</span> OSSymbol *) iter1-&gt;getNextObject();
                str = 0;
            }
            <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> ( (bigReturn = iter1-&gt;nextEntries()) ) {
                sym = (<span class="enscript-type">const</span> OSSymbol *) bigReturn-&gt;getObject(0);
                str = (OSString *) bigReturn-&gt;getObject(1);
            }
            <span class="enscript-keyword">else</span>
                sym = 0;

            <span class="enscript-keyword">if</span> (!sym)
                <span class="enscript-keyword">break</span>;

            count1 += (symCache[i] == sym);
            count2 += (!str || cache[i] == str);
        }
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;3l&quot;</span>, count1 == numSymbols);
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;3m&quot;</span>, count2 == numSymbols);
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;3n&quot;</span>, i == numSymbols);
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;3o&quot;</span>, iter1-&gt;valid());

        iter1-&gt;reset();
        str = (OSString *) dict-&gt;__takeObject(symCache[numSymbols-1]);
        dict-&gt;setObject(str, symCache[numSymbols-1]);
        str-&gt;release();
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;3j&quot;</span>, !iter1-&gt;getNextObject());
        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;3k&quot;</span>, !iter1-&gt;valid());

        TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;3p&quot;</span>, 3 == dict-&gt;getRetainCount());
        dict-&gt;release();
    }

    <span class="enscript-keyword">if</span> (iter1) iter1-&gt;release();
    <span class="enscript-keyword">if</span> (iter2) iter2-&gt;release();
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(I)3&quot;</span>, spaceCheck, 0);

    count1 = count2 = count3 = 0;
    <span class="enscript-keyword">for</span> (i = 0; i &lt; numSymbols; i++) {
        count1 += (1 == cache[i]-&gt;getRetainCount());
        count2 += (1 == symCache[i]-&gt;getRetainCount());
        cache[i]-&gt;release();
        symCache[i]-&gt;release();
    }
    TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;4a&quot;</span>, count1 == numSymbols);
    TEST_ASSERT(<span class="enscript-string">'I'</span>, <span class="enscript-string">&quot;4b&quot;</span>, count2 == numSymbols);

    <span class="enscript-keyword">if</span> (res)
        verPrintf((<span class="enscript-string">&quot;testIterator: All OSCollectionIterator Tests passed\n&quot;</span>));
    <span class="enscript-keyword">else</span>
        logPrintf((<span class="enscript-string">&quot;testIterator: Some OSCollectionIterator Tests failed\n&quot;</span>));
}

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* DEBUG */</span>
</pre>
<hr />
</body></html>