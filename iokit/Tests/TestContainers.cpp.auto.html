<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>TestContainers.cpp</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">TestContainers.cpp&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 1998-2000 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">DEBUG</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;Tests.h&quot;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSData.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSString.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/c++/OSSymbol.h&gt;</span>

<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC00[] = <span class="enscript-string">&quot;The quick brown fox jumps over the lazy dog.  &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC01[] = <span class="enscript-string">&quot;The quick brown fox &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC02[] = <span class="enscript-string">&quot;jumps over the &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC03[] = <span class="enscript-string">&quot;lazy dog.  \n&quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC04[] = <span class="enscript-string">&quot;The &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC05[] = <span class="enscript-string">&quot;quick &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC06[] = <span class="enscript-string">&quot;brown &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC07[] = <span class="enscript-string">&quot;fox &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC08[] = <span class="enscript-string">&quot;jumps &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC09[] = <span class="enscript-string">&quot;over &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC10[] = <span class="enscript-string">&quot;the &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC11[] = <span class="enscript-string">&quot;lazy &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC12[] = <span class="enscript-string">&quot;dog.  \n&quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC13[] = <span class="enscript-string">&quot;Now is the time for all good &quot;</span>
                               <span class="enscript-string">&quot;men to come to the aid of the party  \n&quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC14[] = <span class="enscript-string">&quot;Now is the time for &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC15[] = <span class="enscript-string">&quot;all good men to come &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC16[] = <span class="enscript-string">&quot;to the aid of the party  \n&quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC17[] = <span class="enscript-string">&quot;Now &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC18[] = <span class="enscript-string">&quot;is &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC19[] = <span class="enscript-string">&quot;the &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC20[] = <span class="enscript-string">&quot;time &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC21[] = <span class="enscript-string">&quot;for &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC22[] = <span class="enscript-string">&quot;all &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC23[] = <span class="enscript-string">&quot;good &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC24[] = <span class="enscript-string">&quot;men &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC25[] = <span class="enscript-string">&quot;to &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC26[] = <span class="enscript-string">&quot;come &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC27[] = <span class="enscript-string">&quot;to &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC28[] = <span class="enscript-string">&quot;the &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC29[] = <span class="enscript-string">&quot;aid &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC30[] = <span class="enscript-string">&quot;of &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC31[] = <span class="enscript-string">&quot;the &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC32[] = <span class="enscript-string">&quot;party.  \n&quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC33[] = <span class="enscript-string">&quot;Frank Burns eats worms.  \n&quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC34[] = <span class="enscript-string">&quot;Frank Burns &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC35[] = <span class="enscript-string">&quot;eats worms.  \n&quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC36[] = <span class="enscript-string">&quot;Frank &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC37[] = <span class="enscript-string">&quot;Burns &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC38[] = <span class="enscript-string">&quot;eats &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC39[] = <span class="enscript-string">&quot;worms.  \n&quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC40[] = <span class="enscript-string">&quot;Tired eyes?  Stiff neck?  Tight shoulders?  &quot;</span>
                              <span class="enscript-string">&quot;Aching back?  The right moves can help &quot;</span>
                              <span class="enscript-string">&quot;prevent these kinds of problem.  &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC41[] = <span class="enscript-string">&quot;Tired eyes?  Stiff neck?  &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC42[] = <span class="enscript-string">&quot;Tight shoulders?  Aching back?  &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC43[] = <span class="enscript-string">&quot;The right moves can help prevent &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC44[] = <span class="enscript-string">&quot;these kinds of problem.  &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC45[] = <span class="enscript-string">&quot;Tired &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC46[] = <span class="enscript-string">&quot;eyes?  &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC47[] = <span class="enscript-string">&quot;Stiff &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC48[] = <span class="enscript-string">&quot;neck?  &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC49[] = <span class="enscript-string">&quot;Tight &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC50[] = <span class="enscript-string">&quot;shoulders?  &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC51[] = <span class="enscript-string">&quot;Aching &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC52[] = <span class="enscript-string">&quot;back?  &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC53[] = <span class="enscript-string">&quot;The &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC54[] = <span class="enscript-string">&quot;right &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC55[] = <span class="enscript-string">&quot;moves &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC56[] = <span class="enscript-string">&quot;can &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC57[] = <span class="enscript-string">&quot;help &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC58[] = <span class="enscript-string">&quot;prevent &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC59[] = <span class="enscript-string">&quot;these &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC60[] = <span class="enscript-string">&quot;kinds &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC61[] = <span class="enscript-string">&quot;of &quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> testC62[] = <span class="enscript-string">&quot;problem.  &quot;</span>;

<span class="enscript-type">const</span> <span class="enscript-type">char</span> *strCache[] = {
    testC00, testC01, testC02, testC03, testC04, testC05, testC06, testC07,
    testC08, testC09, testC10, testC11, testC12, testC13, testC14, testC15,
    testC16, testC17, testC18, testC19, testC20, testC21, testC22, testC23,
    testC24, testC25, testC26, testC27, testC28, testC29, testC30, testC31,
    testC32, testC33, testC34, testC35, testC36, testC37, testC38, testC39, 
    testC40, testC41, testC42, testC43, testC44, testC45, testC46, testC47, 
    testC48, testC49, testC50, testC51, testC52, testC53, testC54, testC55, 
    testC56, testC57, testC58, testC59, testC60, testC61, testC62, 
};
<span class="enscript-type">const</span> <span class="enscript-type">int</span> numStrCache = ((<span class="enscript-type">int</span>) (<span class="enscript-keyword">sizeof</span>(strCache)/<span class="enscript-keyword">sizeof</span>(strCache[0])));

<span class="enscript-type">void</span> <span class="enscript-function-name">testData</span>()
{
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DATA_SIZE_1</span>	 256
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DATA_SIZE_2</span>	 512
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DATA_SIZE_3</span>	1024
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DATA_SIZE_4</span>	8192
    
    OSData *test1, *test2, *test3;
    <span class="enscript-type">void</span> *spaceCheck;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> len;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i;
    <span class="enscript-type">bool</span> res = true;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span> testData[DATA_SIZE_4/<span class="enscript-keyword">sizeof</span>(<span class="enscript-type">short</span>)], *cp;

    <span class="enscript-comment">// very first test initialises the OSMetaClass cache.
</span>    test1 = OSData::withCapacity(DATA_SIZE_1);
    TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;0a&quot;</span>, test1);
    <span class="enscript-keyword">if</span> (test1)
        test1-&gt;release();

    <span class="enscript-keyword">for</span> (i = 0; i &lt; <span class="enscript-keyword">sizeof</span>(testData)/<span class="enscript-keyword">sizeof</span>(<span class="enscript-type">short</span>); i++)
        testData[i] = (<span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>) i;

    <span class="enscript-comment">// Check empty data allocation
</span>    spaceCheck = checkPointSpace();
    test1 = OSData::withCapacity(DATA_SIZE_1);
    TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;1a&quot;</span>, test1);
    <span class="enscript-keyword">if</span> (test1) {
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;1b&quot;</span>, !test1-&gt;getLength());
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;1c&quot;</span>, test1-&gt;getCapacity() == DATA_SIZE_1);
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;1d&quot;</span>, !test1-&gt;getBytesNoCopy());
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;1e&quot;</span>, !test1-&gt;getBytesNoCopy(10, DATA_SIZE_1 - 10));
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;1f&quot;</span>, test1-&gt;appendBytes(spaceCheck, 0));
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;1g&quot;</span>, !test1-&gt;getLength());
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;1h&quot;</span>, test1-&gt;getCapacity() == DATA_SIZE_1);
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;1i&quot;</span>, !test1-&gt;getBytesNoCopy());
        test1-&gt;release();
    }
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(d)1&quot;</span>, spaceCheck, 0);

    <span class="enscript-comment">// Check appending to empty data allocation 
</span>    spaceCheck = checkPointSpace();
    test1 = OSData::withCapacity(DATA_SIZE_1);
    TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;2a&quot;</span>, test1);
    <span class="enscript-keyword">if</span> (test1) {
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;2b&quot;</span>, !test1-&gt;getLength());
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;2c&quot;</span>, !test1-&gt;getBytesNoCopy());
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;2d&quot;</span>, test1-&gt;appendBytes(testData, DATA_SIZE_1));
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;2e&quot;</span>, test1-&gt;getLength() == DATA_SIZE_1);
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;2f&quot;</span>, test1-&gt;getBytesNoCopy());
        cp = (<span class="enscript-type">unsigned</span> <span class="enscript-type">short</span> *) test1-&gt;getBytesNoCopy();
        <span class="enscript-keyword">for</span> (i = 0; cp &amp;&amp; i &lt; (DATA_SIZE_1/<span class="enscript-keyword">sizeof</span>(<span class="enscript-type">short</span>)); i++) {
            TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;2g&quot;</span>, *cp++ == testData[i]);
            <span class="enscript-keyword">if</span> (*cp != testData[i])
                <span class="enscript-keyword">break</span>;
        }
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;2h&quot;</span>, test1-&gt;getBytesNoCopy(10, DATA_SIZE_1-10));
        cp = (<span class="enscript-type">unsigned</span> <span class="enscript-type">short</span> *) test1-&gt;getBytesNoCopy(10, DATA_SIZE_1 - 10);
        <span class="enscript-keyword">for</span> (i = 5; cp &amp;&amp; i &lt; (DATA_SIZE_1/<span class="enscript-keyword">sizeof</span>(<span class="enscript-type">short</span>)) - 5; i++) {
            TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;2i&quot;</span>, *cp++ == testData[i]);
            <span class="enscript-keyword">if</span> (*cp != testData[i])
                <span class="enscript-keyword">break</span>;
        }
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;2j&quot;</span>, test1-&gt;isEqualTo(testData, DATA_SIZE_1));
        test1-&gt;release();
    }
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(d)2&quot;</span>, spaceCheck, 0);

    <span class="enscript-comment">// Check data allocation from some constant data
</span>    spaceCheck = checkPointSpace();
    test1 = OSData::withBytes(testData, <span class="enscript-keyword">sizeof</span>(testData));
    TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;3a&quot;</span>, test1);
    <span class="enscript-keyword">if</span> (test1) {
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;3b&quot;</span>, test1-&gt;getLength() == <span class="enscript-keyword">sizeof</span>(testData));
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;3c&quot;</span>, test1-&gt;getCapacity() == <span class="enscript-keyword">sizeof</span>(testData));
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;3d&quot;</span>, test1-&gt;getBytesNoCopy());
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;3e&quot;</span>, test1-&gt;getBytesNoCopy(10, <span class="enscript-keyword">sizeof</span>(testData)-10));
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;3f&quot;</span>, test1-&gt;appendBytes(spaceCheck, 0));
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;3g&quot;</span>, test1-&gt;getLength() == <span class="enscript-keyword">sizeof</span>(testData));
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;3h&quot;</span>, test1-&gt;getCapacity() == <span class="enscript-keyword">sizeof</span>(testData));
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;3i&quot;</span>, test1-&gt;getBytesNoCopy());
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;3j&quot;</span>, test1-&gt;getBytesNoCopy(10, <span class="enscript-keyword">sizeof</span>(testData)-10));
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;3k&quot;</span>, !test1-&gt;appendBytes(testData, 10));
        test1-&gt;release();
    }
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(d)3&quot;</span>, spaceCheck, 0);

    <span class="enscript-comment">// Check and continious addition of more data
</span>    spaceCheck = checkPointSpace();
    test1 = OSData::withCapacity(DATA_SIZE_4);
    test2 = OSData::withBytesNoCopy(testData, DATA_SIZE_3);
    len = DATA_SIZE_3;
    TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;4a&quot;</span>, (test1 &amp;&amp; test2));
    <span class="enscript-keyword">if</span> (test1 &amp;&amp; test2) {
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;4b&quot;</span>, !test1-&gt;getLength());
        <span class="enscript-keyword">for</span> (i = 0; i &lt; DATA_SIZE_4; i += DATA_SIZE_3)
            TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;4c&quot;</span>, test1-&gt;appendBytes(test2));
        TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;4d&quot;</span>, !test1-&gt;appendBytes(test2));
        <span class="enscript-keyword">for</span> (i = 0; i &lt; DATA_SIZE_4; i += DATA_SIZE_3) {

            TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;4e&quot;</span>, test2-&gt;isEqualTo(
                                        test1-&gt;getBytesNoCopy(i, DATA_SIZE_3),
                                        DATA_SIZE_3));

            test3 = OSData::withData(test1, i, DATA_SIZE_3);
            TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;4f&quot;</span>, test3);
            <span class="enscript-keyword">if</span> (test3) {
                TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;4g&quot;</span>, test2-&gt;isEqualTo(test3));
                test3-&gt;release();
            }

            test3 = OSData::withData(test1, i, len);
            TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;4i&quot;</span>, test3);
            <span class="enscript-keyword">if</span> (test3) {
                TEST_ASSERT(<span class="enscript-string">'d'</span>, <span class="enscript-string">&quot;4j&quot;</span>, test2-&gt;isEqualTo(test3));
                test3-&gt;release();
            }
        }
        test1-&gt;release();
        test2-&gt;release();
    }
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(d)3&quot;</span>, spaceCheck, 0);

    <span class="enscript-keyword">if</span> (res)
        verPrintf((<span class="enscript-string">&quot;testData: All OSData Tests passed\n&quot;</span>));
    <span class="enscript-keyword">else</span>
        logPrintf((<span class="enscript-string">&quot;testData: Some OSData Tests failed\n&quot;</span>));
#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">DATA_SIZE_4</span>
#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">DATA_SIZE_3</span>
#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">DATA_SIZE_2</span>
#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">DATA_SIZE_1</span>
}

<span class="enscript-type">void</span> <span class="enscript-function-name">testString</span>()
{
    OSString *test1, *test2;
    <span class="enscript-type">void</span> *spaceCheck;
    <span class="enscript-type">int</span> i;
    <span class="enscript-type">char</span> c;
    <span class="enscript-type">bool</span> res = true;

    <span class="enscript-comment">// very first test initialises the OSMetaClass cache.
</span>    test1 = OSString::withCStringNoCopy(testC00);
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;0a&quot;</span>, test1);
    <span class="enscript-keyword">if</span> (test1)
        test1-&gt;release();

    <span class="enscript-comment">// Check c string allocation
</span>    spaceCheck = checkPointSpace();
    test1 = OSString::withCString(testC00);
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;1a&quot;</span>, test1);
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;1b&quot;</span>, testC00 != test1-&gt;getCStringNoCopy());
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;1c&quot;</span>, strcmp(testC00, test1-&gt;getCStringNoCopy()) == 0);
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;1d&quot;</span>, strlen(testC00) == test1-&gt;getLength());
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;1e&quot;</span>, test1-&gt;isEqualTo(testC00));
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;1f&quot;</span>, !test1-&gt;isEqualTo(testC01));
    <span class="enscript-keyword">if</span> (test1) test1-&gt;release();
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(s)1&quot;</span>, spaceCheck, 0);

    <span class="enscript-comment">// Check c string no allocation
</span>    spaceCheck = checkPointSpace();
    test1 = OSString::withCStringNoCopy(testC00);
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;2a&quot;</span>, test1);
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;2b&quot;</span>, testC00 == test1-&gt;getCStringNoCopy());
    <span class="enscript-keyword">if</span> (test1) test1-&gt;release();
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(s)2&quot;</span>, spaceCheck, 0);

    <span class="enscript-comment">// Check string from other string generation
</span>    spaceCheck = checkPointSpace();
    test1 = OSString::withCStringNoCopy(testC00);
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;3a&quot;</span>, test1);
    test2 = OSString::withString(test1);
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;3b&quot;</span>, test2);
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;3c&quot;</span>, test1 != test2);
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;3d&quot;</span>, test1-&gt;isEqualTo(test2));
    <span class="enscript-keyword">if</span> (test1) test1-&gt;release();
    <span class="enscript-keyword">if</span> (test2) test2-&gt;release();
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(s)3&quot;</span>, spaceCheck, 0);

    <span class="enscript-comment">// Check string comparison functionality no copy
</span>    spaceCheck = checkPointSpace();
    test1 = OSString::withCStringNoCopy(testC00);
    test2 = OSString::withCStringNoCopy(testC01);
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;4a&quot;</span>, test1 &amp;&amp; test2);
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;4b&quot;</span>, !test1-&gt;isEqualTo(test2));
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;4c&quot;</span>, !test1-&gt;isEqualTo(testC01));
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;4d&quot;</span>, test1-&gt;isEqualTo(testC00));
    <span class="enscript-keyword">if</span> (test1) test1-&gt;release();
    <span class="enscript-keyword">if</span> (test2) test2-&gt;release();
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(s)4&quot;</span>, spaceCheck, 0);

    <span class="enscript-comment">// Check string comparison functionality with copy
</span>    spaceCheck = checkPointSpace();
    test1 = OSString::withCString(testC00);
    test2 = OSString::withCString(testC01);
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;5a&quot;</span>, test1 &amp;&amp; test2);
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;5b&quot;</span>, !test1-&gt;isEqualTo(test2));
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;5c&quot;</span>, !test1-&gt;isEqualTo(testC01));
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;5d&quot;</span>, test1-&gt;isEqualTo(testC00));
    <span class="enscript-keyword">if</span> (test1) test1-&gt;release();
    <span class="enscript-keyword">if</span> (test2) test2-&gt;release();
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(s)5&quot;</span>, spaceCheck, 0);

    <span class="enscript-comment">// Check string inplace modifications
</span>    spaceCheck = checkPointSpace();
    test1 = OSString::withCString(testC00);
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;6a&quot;</span>, test1);
    <span class="enscript-keyword">for</span> (i = 0; (c = test1-&gt;getChar(i)); i++)
        <span class="enscript-keyword">if</span> (c != testC00[i]) {
            verPrintf((<span class="enscript-string">&quot;testString(s) test 6b failed\n&quot;</span>)); res = false;
            <span class="enscript-keyword">break</span>;
        }
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;6c&quot;</span>, !c);
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;6d&quot;</span>, test1-&gt;setChar(<span class="enscript-string">' '</span>, 0));
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;6e&quot;</span>, !test1-&gt;isEqualTo(testC00));
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;6f&quot;</span>, test1-&gt;setChar(<span class="enscript-string">'T'</span>, 0));
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;6g&quot;</span>, !test1-&gt;setChar(<span class="enscript-string">' '</span>, <span class="enscript-keyword">sizeof</span>(testC00)));
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;6h&quot;</span>, test1-&gt;isEqualTo(testC00));
    <span class="enscript-keyword">if</span> (test1) test1-&gt;release();
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(s)6&quot;</span>, spaceCheck, 0);

    <span class="enscript-comment">// Check const string fail inplace modifications
</span>    spaceCheck = checkPointSpace();
    test1 = OSString::withCStringNoCopy(testC00);
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;7a&quot;</span>, test1);
    <span class="enscript-keyword">for</span> (i = 0; (c = test1-&gt;getChar(i)); i++)
        <span class="enscript-keyword">if</span> (c != testC00[i]) {
            verPrintf((<span class="enscript-string">&quot;testString(s) test 7b failed\n&quot;</span>)); res = false;
            <span class="enscript-keyword">break</span>;
        }
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;7c&quot;</span>, !c);
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;7d&quot;</span>, !test1-&gt;setChar(<span class="enscript-string">' '</span>, 0));
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;7e&quot;</span>, test1-&gt;isEqualTo(testC00));
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;7f&quot;</span>, !test1-&gt;setChar(<span class="enscript-string">' '</span>, <span class="enscript-keyword">sizeof</span>(testC00)));
    TEST_ASSERT(<span class="enscript-string">'s'</span>, <span class="enscript-string">&quot;7g&quot;</span>, test1-&gt;isEqualTo(testC00));
    <span class="enscript-keyword">if</span> (test1) test1-&gt;release();
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(s)7&quot;</span>, spaceCheck, 0);

    <span class="enscript-keyword">if</span> (res)
        verPrintf((<span class="enscript-string">&quot;testString: All OSString Tests passed\n&quot;</span>));
    <span class="enscript-keyword">else</span>
        logPrintf((<span class="enscript-string">&quot;testString: Some OSString Tests failed\n&quot;</span>));
}

<span class="enscript-type">void</span> <span class="enscript-function-name">testSymbol</span>()
{
    <span class="enscript-type">bool</span> res = true;
    <span class="enscript-type">int</span> i, j;
    <span class="enscript-type">int</span> countDups;
    <span class="enscript-type">const</span> OSSymbol *cache[numStrCache];
    <span class="enscript-type">void</span> *spaceCheck;

    <span class="enscript-comment">// very first test initialises the OSMetaClass cache.
</span>    cache[0] = IOSymbol::withCStringNoCopy(testC00);
    TEST_ASSERT(<span class="enscript-string">'u'</span>, <span class="enscript-string">&quot;0a&quot;</span>, cache[0]);
    <span class="enscript-keyword">if</span> (cache[0])
        cache[0]-&gt;release();

    spaceCheck = checkPointSpace();

    <span class="enscript-comment">// Setup the symbol cache, make sure it grows the symbol unique'ing
</span>    <span class="enscript-comment">// hash table.  Also determine that the symbol is created ok and that
</span>    <span class="enscript-comment">// it is indeed equal to the creating cString by strcmp.
</span>    <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++) {
        cache[i] = OSSymbol::withCStringNoCopy(strCache[i]);
        <span class="enscript-keyword">if</span> (!cache[i]) {
            verPrintf((<span class="enscript-string">&quot;testSymbol(u) test 1a%d failed\n&quot;</span>, i)); res = false;
        }
        <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!cache[i]-&gt;isEqualTo(strCache[i])) {
            verPrintf((<span class="enscript-string">&quot;testSymbol(u) test 1b%d failed\n&quot;</span>, i)); res = false;
        }
    }

    <span class="enscript-comment">// The strCache does have some duplicates in it, mostly 'the'.  Make
</span>    <span class="enscript-comment">// sure that we wind them and that different cache entries really are
</span>    <span class="enscript-comment">// different by strcmp.  Fundamental to OSSymbol semantics.
</span>    countDups = 0;
    <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++)
        <span class="enscript-keyword">for</span> (j = i+1; j &lt; numStrCache; j++) {
            <span class="enscript-keyword">if</span> (cache[i] != cache[j] &amp;&amp; cache[i]-&gt;isEqualTo(cache[j])) {
                verPrintf((<span class="enscript-string">&quot;testSymbol(u) test 2a%d,%d failed\n&quot;</span>, i, j));
                res = false;
            }
            <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (cache[i] == cache[j]) {
                <span class="enscript-keyword">if</span> (cache[i]-&gt;getRetainCount() == 1) {
                    verPrintf((<span class="enscript-string">&quot;testSymbol(u) test 2b%d,%d failed\n&quot;</span>, i, j));
                    res = false;
                }
                countDups++;
            }
        }
    TEST_ASSERT(<span class="enscript-string">'u'</span>, <span class="enscript-string">&quot;2c&quot;</span>, countDups);

    <span class="enscript-comment">// Clear out the cache and check that the unique'ing hashtable has grown
</span>    <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++) {
        <span class="enscript-keyword">if</span> (cache[i]) {
            cache[i]-&gt;release();
            cache[i] = 0;
        }
    }
    <span class="enscript-comment">// As of 1998-11-17 the hash growth is 364.
</span>    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(u)3&quot;</span>, spaceCheck, 972);
    logSpace();

    <span class="enscript-comment">// Check for leaks by repeating the cacheing and freeing
</span>    spaceCheck = checkPointSpace();
    <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++)
        cache[i] = OSSymbol::withCString(strCache[i]);
    <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++) {
        <span class="enscript-keyword">if</span> (cache[i]) {
            cache[i]-&gt;release();
            cache[i] = 0;
        }
    }
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(u)4&quot;</span>, spaceCheck, 0);

    <span class="enscript-comment">// Check that the OSString based symbol constructors work
</span>    <span class="enscript-comment">// and that they don't leak, and finally double check that while
</span>    <span class="enscript-comment">// the cache is active the symbol semantics still work.
</span>    spaceCheck = checkPointSpace();
    <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++) {
        OSString *tmpStr;

        tmpStr = (i&amp;1)
               ? OSString::withCString(strCache[i])
               : OSString::withCStringNoCopy(strCache[i]);
        <span class="enscript-keyword">if</span> (tmpStr) {
            cache[i] = OSSymbol::withString(tmpStr);
            <span class="enscript-keyword">if</span> (!cache[i]) {
                verPrintf((<span class="enscript-string">&quot;testSymbol(u) test 5a%d failed\n&quot;</span>, i));
                res = false;
            }
            tmpStr-&gt;release();
        }
    }

    <span class="enscript-keyword">for</span> (i = 0; i &lt; numStrCache; i++) {
        <span class="enscript-keyword">if</span> (cache[i]) {
            <span class="enscript-type">const</span> OSSymbol *tmpSymb;

            tmpSymb = OSSymbol::withCStringNoCopy(strCache[i]);
            <span class="enscript-keyword">if</span> (cache[i] != tmpSymb) {
                verPrintf((<span class="enscript-string">&quot;testSymbol(u) test 5b%d failed\n&quot;</span>, i));
                res = false;
            }
            tmpSymb-&gt;release();
            cache[i]-&gt;release();
            cache[i] = 0;
        }
        <span class="enscript-keyword">else</span> {
            verPrintf((<span class="enscript-string">&quot;testSymbol(u) test 5c%d failed\n&quot;</span>, i));
            res = false;
        }
    }
    res = res &amp;&amp; checkSpace(<span class="enscript-string">&quot;(u)5&quot;</span>, spaceCheck, 0);

    <span class="enscript-keyword">if</span> (res)
        verPrintf((<span class="enscript-string">&quot;testSymbol: All OSSymbol Tests passed\n&quot;</span>));
    <span class="enscript-keyword">else</span>
        logPrintf((<span class="enscript-string">&quot;testSymbol: Some OSSymbol Tests failed\n&quot;</span>));
}

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* DEBUG */</span>
</pre>
<hr />
</body></html>