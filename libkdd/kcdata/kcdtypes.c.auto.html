<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>kcdtypes.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">kcdtypes.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2015 Apple Inc. All rights reserved.
 *
 * @APPLE_LICENSE_HEADER_START@
 *
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this
 * file.
 *
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 *
 * @APPLE_LICENSE_HEADER_END@
 */</span>


#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;Kernel/kern/kern_cdata.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;Kernel/kern/debug.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/time.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdlib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stddef.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;assert.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/mach_time.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/proc_info.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;corpses/task_corpse.h&gt;</span>

<span class="enscript-comment">/*!
 * @function kcdata_get_typedescription
 *
 * @abstract
 * Search the known type definitions for type with id type_id.
 *
 * @param type_id
 * A unsinged int type specified by the KCDATA.
 *
 * @param buffer
 * pointer to data area where type definition will be saved. 
 *
 * @param buffer_size
 * size of the buffer provided.
 *
 * @return struct kcdata_type_definition *
 * pointer to a malloc'ed buffer holding the type definition and each subtype defintion for its fields.
 * It may return NULL if no type with id == type_id is found.
 * Note: The caller is responsible to free() the memory when its no longer used.
 *
 * @discussion
 * This function queries the known type definitions table. If found the defintion data is returned
 * else NULL is returned. It is advised to cache the return value from this function since the data
 * is always going to be the same for same type_id. The definition setup requires memory on heap.
 * The caller should make sure to free() the data once its done with using it.
 *
 */</span>
<span class="enscript-type">struct</span> kcdata_type_definition *<span class="enscript-function-name">kcdata_get_typedescription</span>(<span class="enscript-type">unsigned</span> type_id, uint8_t *buffer, uint32_t buffer_size);



<span class="enscript-comment">/* forward declarations for helper routines */</span>
<span class="enscript-type">static</span> uint32_t <span class="enscript-function-name">get_kctype_subtype_size</span>(kctype_subtype_t type);
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">setup_subtype_description</span>(kcdata_subtype_descriptor_t desc, kctype_subtype_t type, uint32_t offset, <span class="enscript-type">char</span> *name);
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">setup_subtype_array_description</span>(kcdata_subtype_descriptor_t desc, kctype_subtype_t type, uint32_t offset, uint32_t count, <span class="enscript-type">char</span> *name);
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">setup_type_definition</span>(<span class="enscript-type">struct</span> kcdata_type_definition *d, uint32_t type, uint32_t num_elems, <span class="enscript-type">char</span> *name);

<span class="enscript-type">struct</span> kcdata_type_definition *<span class="enscript-function-name">kcdata_get_typedescription</span>(<span class="enscript-type">unsigned</span> type_id, uint8_t *buffer, uint32_t buffer_size)
{
	<span class="enscript-type">int</span> i = 0;
#<span class="enscript-reference">define</span> <span class="enscript-function-name">_STR_VALUE</span>(x)  #x
#<span class="enscript-reference">define</span> <span class="enscript-function-name">_SUBTYPE</span>(t, s, f)     setup_subtype_description(&amp;subtypes[i++], (t), offsetof(s,f), _STR_VALUE(f))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">_SUBTYPE_ARRAY</span>(t, s, f, c)   setup_subtype_array_description(&amp;subtypes[i++], (t), offsetof(s,f), (c), _STR_VALUE(f))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">_STRINGTYPE</span>(f)        setup_subtype_array_description(&amp;subtypes[i++], KC_ST_CHAR, 0, UINT16_MAX, f)


    
    <span class="enscript-keyword">if</span> (buffer_size &lt; <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">struct</span> kcdata_type_definition) || buffer == NULL)
        <span class="enscript-keyword">return</span> NULL;
    
	<span class="enscript-type">struct</span> kcdata_type_definition *retval = (<span class="enscript-type">struct</span> kcdata_type_definition *)&amp;buffer[0];
	kcdata_subtype_descriptor_t subtypes = (kcdata_subtype_descriptor_t)&amp;buffer[<span class="enscript-keyword">sizeof</span>(<span class="enscript-type">struct</span> kcdata_type_definition)];
	<span class="enscript-keyword">switch</span> (type_id) {

        <span class="enscript-keyword">case</span> <span class="enscript-reference">KCDATA_TYPE_STRING_DESC</span>: {
            i = 0;
            setup_subtype_array_description(&amp;subtypes[i++], KC_ST_CHAR, 0, KCDATA_DESC_MAXLEN, <span class="enscript-string">&quot;desc&quot;</span>);
            setup_subtype_array_description(&amp;subtypes[i++], KC_ST_CHAR, KCDATA_DESC_MAXLEN, UINT16_MAX, <span class="enscript-string">&quot;data&quot;</span>);
            setup_type_definition(retval, type_id, i, <span class="enscript-string">&quot;string_desc&quot;</span>);
            <span class="enscript-keyword">break</span>;
        }
            
		<span class="enscript-keyword">case</span> <span class="enscript-reference">KCDATA_TYPE_UINT32_DESC</span>: {
			i = 0;
			setup_subtype_array_description(&amp;subtypes[i++], KC_ST_CHAR, 0, KCDATA_DESC_MAXLEN, <span class="enscript-string">&quot;desc&quot;</span>);
			setup_subtype_description(&amp;subtypes[i++], KC_ST_UINT32, KCDATA_DESC_MAXLEN, <span class="enscript-string">&quot;data&quot;</span>);
			setup_type_definition(retval, type_id, i, <span class="enscript-string">&quot;uint32_desc&quot;</span>);
			<span class="enscript-keyword">break</span>;
		}
			
		<span class="enscript-keyword">case</span> <span class="enscript-reference">KCDATA_TYPE_UINT64_DESC</span>: {
			i = 0;
			setup_subtype_array_description(&amp;subtypes[i++], KC_ST_CHAR, 0, KCDATA_DESC_MAXLEN, <span class="enscript-string">&quot;desc&quot;</span>);
			setup_subtype_description(&amp;subtypes[i++], KC_ST_UINT64, KCDATA_DESC_MAXLEN, <span class="enscript-string">&quot;data&quot;</span>);
			setup_type_definition(retval, type_id, i, <span class="enscript-string">&quot;uint64_desc&quot;</span>);
			<span class="enscript-keyword">break</span>;
		}
        
        <span class="enscript-keyword">case</span> <span class="enscript-reference">KCDATA_TYPE_INT32_DESC</span>: {
            i = 0;
            setup_subtype_array_description(&amp;subtypes[i++], KC_ST_CHAR, 0, KCDATA_DESC_MAXLEN, <span class="enscript-string">&quot;desc&quot;</span>);
            setup_subtype_description(&amp;subtypes[i++], KC_ST_INT32, KCDATA_DESC_MAXLEN, <span class="enscript-string">&quot;data&quot;</span>);
            setup_type_definition(retval, type_id, i, <span class="enscript-string">&quot;int32_desc&quot;</span>);
            <span class="enscript-keyword">break</span>;
        }
            
        <span class="enscript-keyword">case</span> <span class="enscript-reference">KCDATA_TYPE_INT64_DESC</span>: {
            i = 0;
            setup_subtype_array_description(&amp;subtypes[i++], KC_ST_CHAR, 0, KCDATA_DESC_MAXLEN, <span class="enscript-string">&quot;desc&quot;</span>);
            setup_subtype_description(&amp;subtypes[i++], KC_ST_INT64, KCDATA_DESC_MAXLEN, <span class="enscript-string">&quot;data&quot;</span>);
            setup_type_definition(retval, type_id, i, <span class="enscript-string">&quot;int64_desc&quot;</span>);
            <span class="enscript-keyword">break</span>;
        }

		<span class="enscript-keyword">case</span> <span class="enscript-reference">KCDATA_TYPE_CONTAINER_BEGIN</span> :{
			i = 0;
			setup_subtype_description(&amp;subtypes[i++], KC_ST_UINT32, 0, <span class="enscript-string">&quot;kcContainerType&quot;</span>);
			setup_type_definition(retval, type_id, i, <span class="enscript-string">&quot;container_begin&quot;</span>);
			<span class="enscript-keyword">break</span>;
		}
            
        <span class="enscript-keyword">case</span> <span class="enscript-reference">KCDATA_TYPE_LIBRARY_LOADINFO</span>: {
            i = 0;
            _SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> dyld_uuid_info_32, imageLoadAddress);
            _SUBTYPE_ARRAY(KC_ST_UINT8, <span class="enscript-type">struct</span> dyld_uuid_info_32, imageUUID, 16);
            setup_type_definition(retval, type_id, i, <span class="enscript-string">&quot;dyld_load_info&quot;</span>);
            <span class="enscript-keyword">break</span>;
            
        }
        
        <span class="enscript-keyword">case</span> <span class="enscript-reference">KCDATA_TYPE_LIBRARY_LOADINFO64</span>: <span class="enscript-comment">/* fall through */</span>
        <span class="enscript-keyword">case</span> <span class="enscript-reference">STACKSHOT_KCTYPE_SHAREDCACHE_LOADINFO</span>: {
            i = 0;
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> dyld_uuid_info_64, imageLoadAddress);
            _SUBTYPE_ARRAY(KC_ST_UINT8, <span class="enscript-type">struct</span> dyld_uuid_info_64, imageUUID, 16);
            setup_type_definition(retval, type_id, i, <span class="enscript-string">&quot;dyld_load_info&quot;</span>);
            <span class="enscript-keyword">break</span>;
        }
            
        <span class="enscript-keyword">case</span> <span class="enscript-reference">KCDATA_TYPE_TIMEBASE</span>: {
            i = 0;
            _SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> mach_timebase_info, numer);
            _SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> mach_timebase_info, denom);
            setup_type_definition(retval, type_id, i, <span class="enscript-string">&quot;mach_timebase_info&quot;</span>);
        }

        <span class="enscript-keyword">case</span> <span class="enscript-reference">KCDATA_TYPE_MACH_ABSOLUTE_TIME</span>:
            setup_type_definition(retval, type_id, 1, <span class="enscript-string">&quot;mach_absolute_time&quot;</span>);
            setup_subtype_description(&amp;subtypes[0], KC_ST_UINT64, 0, <span class="enscript-string">&quot;mach_absolute_time&quot;</span>);
            <span class="enscript-keyword">break</span>;
        
        <span class="enscript-keyword">case</span> <span class="enscript-reference">KCDATA_TYPE_TIMEVAL</span>: {
            i = 0;
            _SUBTYPE(KC_ST_INT64, <span class="enscript-type">struct</span> timeval64, tv_sec);
            _SUBTYPE(KC_ST_INT64, <span class="enscript-type">struct</span> timeval64, tv_usec);
            setup_type_definition(retval, type_id, i, <span class="enscript-string">&quot;timeval&quot;</span>);
        }

	<span class="enscript-keyword">case</span> <span class="enscript-reference">KCDATA_TYPE_USECS_SINCE_EPOCH</span>:
            setup_type_definition(retval, type_id, 1, <span class="enscript-string">&quot;usecs_since_epoch&quot;</span>);
            setup_subtype_description(&amp;subtypes[0], KC_ST_UINT64, 0, <span class="enscript-string">&quot;usecs_since_epoch&quot;</span>);
            <span class="enscript-keyword">break</span>;


            <span class="enscript-comment">/* stackshot specific types */</span>
		<span class="enscript-keyword">case</span> <span class="enscript-reference">STACKSHOT_KCTYPE_IOSTATS</span>: {
			i = 0;
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> io_stats_snapshot, ss_disk_reads_count);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> io_stats_snapshot, ss_disk_reads_size);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> io_stats_snapshot, ss_disk_writes_count);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> io_stats_snapshot, ss_disk_writes_size);
            _SUBTYPE_ARRAY(KC_ST_UINT64, <span class="enscript-type">struct</span> io_stats_snapshot, ss_io_priority_count, STACKSHOT_IO_NUM_PRIORITIES);
            _SUBTYPE_ARRAY(KC_ST_UINT64, <span class="enscript-type">struct</span> io_stats_snapshot, ss_io_priority_size, STACKSHOT_IO_NUM_PRIORITIES);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> io_stats_snapshot, ss_paging_count);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> io_stats_snapshot, ss_paging_size);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> io_stats_snapshot, ss_non_paging_count);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> io_stats_snapshot, ss_non_paging_size);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> io_stats_snapshot, ss_data_count);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> io_stats_snapshot, ss_data_size);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> io_stats_snapshot, ss_metadata_count);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> io_stats_snapshot, ss_metadata_size);

			setup_type_definition(retval, type_id, i, <span class="enscript-string">&quot;io_statistics&quot;</span>);
			<span class="enscript-keyword">break</span>;
		}
			
		<span class="enscript-keyword">case</span> <span class="enscript-reference">STACKSHOT_KCTYPE_GLOBAL_MEM_STATS</span>       :
		{   i = 0;
            _SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> mem_and_io_snapshot, snapshot_magic);
			_SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> mem_and_io_snapshot, free_pages);
			_SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> mem_and_io_snapshot, active_pages);
			_SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> mem_and_io_snapshot, inactive_pages);
			_SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> mem_and_io_snapshot, purgeable_pages);
			_SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> mem_and_io_snapshot, wired_pages);
			_SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> mem_and_io_snapshot, speculative_pages);
			_SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> mem_and_io_snapshot, throttled_pages);
			_SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> mem_and_io_snapshot, filebacked_pages);
			_SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> mem_and_io_snapshot, compressions);
			_SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> mem_and_io_snapshot, decompressions);
			_SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> mem_and_io_snapshot, compressor_size);
			_SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> mem_and_io_snapshot, busy_buffer_count);
			_SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> mem_and_io_snapshot, pages_wanted);
			_SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> mem_and_io_snapshot, pages_reclaimed);
            _SUBTYPE(KC_ST_UINT8, <span class="enscript-type">struct</span> mem_and_io_snapshot, pages_wanted_reclaimed_valid);
			setup_type_definition(retval, type_id, i, <span class="enscript-string">&quot;mem_and_io_snapshot&quot;</span>);
			<span class="enscript-keyword">break</span>;
		}
			
        <span class="enscript-keyword">case</span> <span class="enscript-reference">STACKSHOT_KCCONTAINER_TASK</span>:
            setup_type_definition(retval, type_id, 0, <span class="enscript-string">&quot;task_snapshots&quot;</span>);
            <span class="enscript-keyword">break</span>;

        <span class="enscript-keyword">case</span> <span class="enscript-reference">STACKSHOT_KCCONTAINER_THREAD</span>:
            setup_type_definition(retval, type_id, 0, <span class="enscript-string">&quot;thread_snapshots&quot;</span>);
            <span class="enscript-keyword">break</span>;

			
		<span class="enscript-keyword">case</span> <span class="enscript-reference">STACKSHOT_KCTYPE_TASK_SNAPSHOT</span>: {
			i = 0;
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> task_snapshot_v2, ts_unique_pid);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> task_snapshot_v2, ts_ss_flags);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> task_snapshot_v2, ts_user_time_in_terminated_threads);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> task_snapshot_v2, ts_system_time_in_terminated_threads);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> task_snapshot_v2, ts_p_start_sec);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> task_snapshot_v2, ts_task_size);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> task_snapshot_v2, ts_max_resident_size);
			_SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> task_snapshot_v2, ts_suspend_count);
			_SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> task_snapshot_v2, ts_faults);
			_SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> task_snapshot_v2, ts_pageins);
			_SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> task_snapshot_v2, ts_cow_faults);
			_SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> task_snapshot_v2, ts_was_throttled);
			_SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> task_snapshot_v2, ts_did_throttle);
			_SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> task_snapshot_v2, ts_latency_qos);
			_SUBTYPE(KC_ST_INT32, <span class="enscript-type">struct</span> task_snapshot_v2, ts_pid);
            _SUBTYPE_ARRAY(KC_ST_CHAR, <span class="enscript-type">struct</span> task_snapshot_v2, ts_p_comm, 32);
			setup_type_definition(retval, type_id, i, <span class="enscript-string">&quot;task_snapshot&quot;</span>);
			<span class="enscript-keyword">break</span>;
		}
            
		<span class="enscript-keyword">case</span> <span class="enscript-reference">STACKSHOT_KCTYPE_THREAD_SNAPSHOT</span>: {
			i = 0;
			
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> thread_snapshot_v2, ths_thread_id);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> thread_snapshot_v2, ths_wait_event);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> thread_snapshot_v2, ths_continuation);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> thread_snapshot_v2, ths_total_syscalls);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> thread_snapshot_v2, ths_voucher_identifier);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> thread_snapshot_v2, ths_dqserialnum);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> thread_snapshot_v2, ths_user_time);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> thread_snapshot_v2, ths_sys_time);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> thread_snapshot_v2, ths_ss_flags);
			_SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> thread_snapshot_v2, ths_last_run_time);
			_SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> thread_snapshot_v2, ths_state);
			_SUBTYPE(KC_ST_UINT32, <span class="enscript-type">struct</span> thread_snapshot_v2, ths_sched_flags);
			_SUBTYPE(KC_ST_INT16, <span class="enscript-type">struct</span> thread_snapshot_v2, ths_base_priority);
			_SUBTYPE(KC_ST_INT16, <span class="enscript-type">struct</span> thread_snapshot_v2, ths_sched_priority);
			_SUBTYPE(KC_ST_UINT8, <span class="enscript-type">struct</span> thread_snapshot_v2, ths_eqos);
			_SUBTYPE(KC_ST_UINT8, <span class="enscript-type">struct</span> thread_snapshot_v2, ths_rqos);
			_SUBTYPE(KC_ST_UINT8, <span class="enscript-type">struct</span> thread_snapshot_v2, ths_rqos_override);
			_SUBTYPE(KC_ST_UINT8, <span class="enscript-type">struct</span> thread_snapshot_v2, ths_io_tier);
			
			setup_type_definition(retval, type_id, i, <span class="enscript-string">&quot;thread_snapshot&quot;</span>);
			<span class="enscript-keyword">break</span>;
		}

			
		<span class="enscript-keyword">case</span> <span class="enscript-reference">STASKSHOT_KCTYPE_DONATING_PIDS</span>:
			setup_type_definition(retval, type_id, 1, <span class="enscript-string">&quot;donating_pids&quot;</span>);
			setup_subtype_description(&amp;subtypes[0], KC_ST_INT32, 0, <span class="enscript-string">&quot;pid&quot;</span>);
			<span class="enscript-keyword">break</span>;
            
        <span class="enscript-keyword">case</span> <span class="enscript-reference">STACKSHOT_KCTYPE_THREAD_NAME</span>:{
            i = 0;
            setup_subtype_array_description(&amp;subtypes[i++], KC_ST_CHAR, 0, 64, <span class="enscript-string">&quot;pth_name&quot;</span>);
            setup_type_definition(retval, type_id, i, <span class="enscript-string">&quot;pth_name&quot;</span>);
            <span class="enscript-keyword">break</span>;
        }
            
		<span class="enscript-keyword">case</span> <span class="enscript-reference">STACKSHOT_KCTYPE_KERN_STACKFRAME</span>        :
			setup_type_definition(retval, type_id, 2, <span class="enscript-string">&quot;kernel_stack_frames&quot;</span>);
			setup_subtype_description(&amp;subtypes[0], KC_ST_UINT32, 0, <span class="enscript-string">&quot;lr&quot;</span>);
			setup_subtype_description(&amp;subtypes[1], KC_ST_UINT32, <span class="enscript-keyword">sizeof</span>(uint32_t), <span class="enscript-string">&quot;sp&quot;</span>);
			<span class="enscript-keyword">break</span>;
            
		<span class="enscript-keyword">case</span> <span class="enscript-reference">STACKSHOT_KCTYPE_KERN_STACKFRAME64</span>      :
			setup_type_definition(retval, type_id, 2, <span class="enscript-string">&quot;kernel_stack_frames&quot;</span>);
			setup_subtype_description(&amp;subtypes[0], KC_ST_UINT64, 0, <span class="enscript-string">&quot;lr&quot;</span>);
			setup_subtype_description(&amp;subtypes[1], KC_ST_UINT64, <span class="enscript-keyword">sizeof</span>(uint64_t), <span class="enscript-string">&quot;sp&quot;</span>);
			<span class="enscript-keyword">break</span>;
			
		<span class="enscript-keyword">case</span> <span class="enscript-reference">STACKSHOT_KCTYPE_USER_STACKFRAME</span>        :
			setup_type_definition(retval, type_id, 2, <span class="enscript-string">&quot;user_stack_frames&quot;</span>);
			setup_subtype_description(&amp;subtypes[0], KC_ST_UINT32, 0, <span class="enscript-string">&quot;lr&quot;</span>);
			setup_subtype_description(&amp;subtypes[1], KC_ST_UINT32, <span class="enscript-keyword">sizeof</span>(uint32_t), <span class="enscript-string">&quot;sp&quot;</span>);
			<span class="enscript-keyword">break</span>;
			
		<span class="enscript-keyword">case</span> <span class="enscript-reference">STACKSHOT_KCTYPE_USER_STACKFRAME64</span>      :
			setup_type_definition(retval, type_id, 2, <span class="enscript-string">&quot;user_stack_frames&quot;</span>);
			setup_subtype_description(&amp;subtypes[0], KC_ST_UINT64, 0, <span class="enscript-string">&quot;lr&quot;</span>);
			setup_subtype_description(&amp;subtypes[1], KC_ST_UINT64, <span class="enscript-keyword">sizeof</span>(uint64_t), <span class="enscript-string">&quot;sp&quot;</span>);
			<span class="enscript-keyword">break</span>;
        
        <span class="enscript-keyword">case</span> <span class="enscript-reference">STACKSHOT_KCTYPE_BOOTARGS</span>: {
            i = 0;
            _STRINGTYPE(<span class="enscript-string">&quot;boot_args&quot;</span>);
            setup_type_definition(retval, type_id, i, <span class="enscript-string">&quot;boot_args&quot;</span>);
            <span class="enscript-keyword">break</span>;
        }
        
        <span class="enscript-keyword">case</span> <span class="enscript-reference">STACKSHOT_KCTYPE_OSVERSION</span>: {
            i = 0;
            _STRINGTYPE(<span class="enscript-string">&quot;osversion&quot;</span>);
            setup_type_definition(retval, type_id, i, <span class="enscript-string">&quot;osversion&quot;</span>);
            <span class="enscript-keyword">break</span>;
        }

	<span class="enscript-keyword">case</span> <span class="enscript-reference">STACKSHOT_KCTYPE_KERN_PAGE_SIZE</span>: {
		i = 0;
		setup_subtype_description(&amp;subtypes[i++], KC_ST_UINT32, 0, <span class="enscript-string">&quot;kernel_page_size&quot;</span>);
		setup_type_definition(retval, type_id, i, <span class="enscript-string">&quot;kernel_page_size&quot;</span>);
		<span class="enscript-keyword">break</span>;
	}

	<span class="enscript-keyword">case</span> <span class="enscript-reference">STACKSHOT_KCTYPE_JETSAM_LEVEL</span>: {
		i = 0;
		setup_subtype_description(&amp;subtypes[i++], KC_ST_UINT32, 0, <span class="enscript-string">&quot;jetsam_level&quot;</span>);
		setup_type_definition(retval, type_id, i, <span class="enscript-string">&quot;jetsam_level&quot;</span>);
		<span class="enscript-keyword">break</span>;
	}

			<span class="enscript-comment">/* crashinfo types */</span>
        <span class="enscript-keyword">case</span> <span class="enscript-reference">TASK_CRASHINFO_BSDINFOWITHUNIQID</span>:
        {   i = 0;
            _SUBTYPE_ARRAY(KC_ST_UINT8, <span class="enscript-type">struct</span> proc_uniqidentifierinfo, p_uuid, 16);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> proc_uniqidentifierinfo, p_uniqueid);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> proc_uniqidentifierinfo, p_puniqueid);
            <span class="enscript-comment">/* Ignore the p_reserve fields */</span>
            setup_type_definition(retval, type_id, i, <span class="enscript-string">&quot;proc_uniqidentifierinfo&quot;</span>);
            <span class="enscript-keyword">break</span>;
        }
            
        <span class="enscript-keyword">case</span> <span class="enscript-reference">TASK_CRASHINFO_PID</span>:{
            setup_subtype_description(&amp;subtypes[0], KC_ST_INT32, 0, <span class="enscript-string">&quot;pid&quot;</span>);
            setup_type_definition(retval, type_id, 1, <span class="enscript-string">&quot;pid&quot;</span>);
            <span class="enscript-keyword">break</span>;
        }

        <span class="enscript-keyword">case</span> <span class="enscript-reference">TASK_CRASHINFO_PPID</span>:{
            setup_subtype_description(&amp;subtypes[0], KC_ST_INT32, 0, <span class="enscript-string">&quot;ppid&quot;</span>);
            setup_type_definition(retval, type_id, 1, <span class="enscript-string">&quot;ppid&quot;</span>);
            <span class="enscript-keyword">break</span>;
        }
            
        <span class="enscript-keyword">case</span> <span class="enscript-reference">TASK_CRASHINFO_RUSAGE_INFO</span>: {
            i = 0;
            _SUBTYPE_ARRAY(KC_ST_UINT8, <span class="enscript-type">struct</span> rusage_info_v3, ri_uuid, 16);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_user_time);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_system_time);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_pkg_idle_wkups);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_interrupt_wkups);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_pageins);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_wired_size);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_resident_size);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_phys_footprint);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_proc_start_abstime);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_proc_exit_abstime);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_child_user_time);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_child_system_time);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_child_pkg_idle_wkups);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_child_interrupt_wkups);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_child_pageins);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_child_elapsed_abstime);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_diskio_bytesread);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_diskio_byteswritten);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_cpu_time_qos_default);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_cpu_time_qos_maintenance);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_cpu_time_qos_background);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_cpu_time_qos_utility);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_cpu_time_qos_legacy);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_cpu_time_qos_user_initiated);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_cpu_time_qos_user_interactive);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_billed_system_time);
            _SUBTYPE(KC_ST_UINT64, <span class="enscript-type">struct</span> rusage_info_v3, ri_serviced_system_time);
            setup_type_definition(retval, type_id, i, <span class="enscript-string">&quot;rusage_info&quot;</span>);
        }
            
        <span class="enscript-keyword">case</span> <span class="enscript-reference">TASK_CRASHINFO_PROC_NAME</span>: {
            i = 0;
            _STRINGTYPE(<span class="enscript-string">&quot;p_comm&quot;</span>);
            setup_type_definition(retval, type_id, i, <span class="enscript-string">&quot;p_comm&quot;</span>);
        }
            
        <span class="enscript-keyword">case</span> <span class="enscript-reference">TASK_CRASHINFO_USERSTACK</span>: {
            i = 0;
            setup_subtype_description(&amp;subtypes[0], KC_ST_UINT64, 0, <span class="enscript-string">&quot;userstack_ptr&quot;</span>);
            setup_type_definition(retval, type_id, 1, <span class="enscript-string">&quot;userstack_ptr&quot;</span>);
            <span class="enscript-keyword">break</span>;
        }
            
        <span class="enscript-keyword">case</span> <span class="enscript-reference">TASK_CRASHINFO_ARGSLEN</span>: {
            i = 0;
            setup_subtype_description(&amp;subtypes[0], KC_ST_INT32, 0, <span class="enscript-string">&quot;p_argslen&quot;</span>);
            setup_type_definition(retval, type_id, 1, <span class="enscript-string">&quot;p_argslen&quot;</span>);
            <span class="enscript-keyword">break</span>;
        }
        
        <span class="enscript-keyword">case</span> <span class="enscript-reference">TASK_CRASHINFO_PROC_PATH</span>: {
            i = 0;
            _STRINGTYPE(<span class="enscript-string">&quot;p_path&quot;</span>);
            setup_type_definition(retval, type_id, i, <span class="enscript-string">&quot;p_path&quot;</span>);
        }
            
        <span class="enscript-keyword">case</span> <span class="enscript-reference">TASK_CRASHINFO_PROC_CSFLAGS</span>:{
            setup_subtype_description(&amp;subtypes[0], KC_ST_UINT32, 0, <span class="enscript-string">&quot;p_csflags&quot;</span>);
            setup_type_definition(retval, type_id, 1, <span class="enscript-string">&quot;p_csflags&quot;</span>);
            <span class="enscript-keyword">break</span>;
        }
            
        <span class="enscript-keyword">case</span> <span class="enscript-reference">TASK_CRASHINFO_PROC_STATUS</span>: {
            setup_subtype_description(&amp;subtypes[0], KC_ST_UINT8, 0, <span class="enscript-string">&quot;p_status&quot;</span>);
            setup_type_definition(retval, type_id, 1, <span class="enscript-string">&quot;p_status&quot;</span>);
            <span class="enscript-keyword">break</span>;
        }
            
        <span class="enscript-keyword">case</span> <span class="enscript-reference">TASK_CRASHINFO_UID</span>:{
            setup_subtype_description(&amp;subtypes[0], KC_ST_INT32, 0, <span class="enscript-string">&quot;uid&quot;</span>);
            setup_type_definition(retval, type_id, 1, <span class="enscript-string">&quot;uid&quot;</span>);
            <span class="enscript-keyword">break</span>;
        }
            
        <span class="enscript-keyword">case</span> <span class="enscript-reference">TASK_CRASHINFO_GID</span>:{
            setup_subtype_description(&amp;subtypes[0], KC_ST_INT32, 0, <span class="enscript-string">&quot;gid&quot;</span>);
            setup_type_definition(retval, type_id, 1, <span class="enscript-string">&quot;gid&quot;</span>);
            <span class="enscript-keyword">break</span>;
        }
            
        <span class="enscript-keyword">case</span> <span class="enscript-reference">TASK_CRASHINFO_PROC_ARGC</span>:{
            setup_subtype_description(&amp;subtypes[0], KC_ST_INT32, 0, <span class="enscript-string">&quot;argc&quot;</span>);
            setup_type_definition(retval, type_id, 1, <span class="enscript-string">&quot;argc&quot;</span>);
            <span class="enscript-keyword">break</span>;
        }
            
        <span class="enscript-keyword">case</span> <span class="enscript-reference">TASK_CRASHINFO_PROC_FLAGS</span>:{
            setup_subtype_description(&amp;subtypes[0], KC_ST_UINT32, 0, <span class="enscript-string">&quot;p_flags&quot;</span>);
            setup_type_definition(retval, type_id, 1, <span class="enscript-string">&quot;p_flags&quot;</span>);
            <span class="enscript-keyword">break</span>;
        }
            
        <span class="enscript-keyword">case</span> <span class="enscript-reference">TASK_CRASHINFO_CPUTYPE</span>:{
            setup_subtype_description(&amp;subtypes[0], KC_ST_INT32, 0, <span class="enscript-string">&quot;cputype&quot;</span>);
            setup_type_definition(retval, type_id, 1, <span class="enscript-string">&quot;cputype&quot;</span>);
            <span class="enscript-keyword">break</span>;
        }
            
        <span class="enscript-keyword">case</span> <span class="enscript-reference">TASK_CRASHINFO_RESPONSIBLE_PID</span>:{
            setup_subtype_description(&amp;subtypes[0], KC_ST_INT32, 0, <span class="enscript-string">&quot;responsible_pid&quot;</span>);
            setup_type_definition(retval, type_id, 1, <span class="enscript-string">&quot;responsible_pid&quot;</span>);
            <span class="enscript-keyword">break</span>;
        }
            
        <span class="enscript-keyword">case</span> <span class="enscript-reference">TASK_CRASHINFO_DIRTY_FLAGS</span>:{
            setup_subtype_description(&amp;subtypes[0], KC_ST_UINT32, 0, <span class="enscript-string">&quot;dirty_flags&quot;</span>);
            setup_type_definition(retval, type_id, 1, <span class="enscript-string">&quot;dirty_flags&quot;</span>);
            <span class="enscript-keyword">break</span>;
        }
            
        <span class="enscript-keyword">case</span> <span class="enscript-reference">TASK_CRASHINFO_CRASHED_THREADID</span>: {
            setup_subtype_description(&amp;subtypes[0], KC_ST_UINT64, 0, <span class="enscript-string">&quot;crashed_threadid&quot;</span>);
            setup_type_definition(retval, type_id, 1, <span class="enscript-string">&quot;crashed_threadid&quot;</span>);
            <span class="enscript-keyword">break</span>;
        }

		<span class="enscript-reference">default</span>:
			retval = NULL;
			<span class="enscript-keyword">break</span>;
	}
	
    assert(retval == NULL || (buffer_size &gt; <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">struct</span> kcdata_type_definition) + (retval-&gt;kct_num_elements * <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">struct</span> kcdata_subtype_descriptor))));
	<span class="enscript-keyword">return</span> retval;
}


<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">setup_type_definition</span>(<span class="enscript-type">struct</span> kcdata_type_definition *d, uint32_t type, uint32_t num_elems, <span class="enscript-type">char</span> *name)
{
    d-&gt;kct_type_identifier = type;
    d-&gt;kct_num_elements = num_elems;
    memcpy(d-&gt;kct_name, name, <span class="enscript-keyword">sizeof</span>(d-&gt;kct_name));
    d-&gt;kct_name[<span class="enscript-keyword">sizeof</span>(d-&gt;kct_name) - 1] = <span class="enscript-string">'\0'</span>;
}

<span class="enscript-type">static</span> uint32_t <span class="enscript-function-name">get_kctype_subtype_size</span>(kctype_subtype_t type){
    <span class="enscript-keyword">switch</span> (type) {
        <span class="enscript-keyword">case</span> <span class="enscript-reference">KC_ST_CHAR</span>:
        <span class="enscript-keyword">case</span> <span class="enscript-reference">KC_ST_INT8</span>:
        <span class="enscript-keyword">case</span> <span class="enscript-reference">KC_ST_UINT8</span>:
            <span class="enscript-keyword">return</span> <span class="enscript-keyword">sizeof</span>(uint8_t);
            <span class="enscript-keyword">break</span>;
        <span class="enscript-keyword">case</span> <span class="enscript-reference">KC_ST_INT16</span>:
        <span class="enscript-keyword">case</span> <span class="enscript-reference">KC_ST_UINT16</span>:
            <span class="enscript-keyword">return</span> <span class="enscript-keyword">sizeof</span>(uint16_t);
            <span class="enscript-keyword">break</span>;
        <span class="enscript-keyword">case</span> <span class="enscript-reference">KC_ST_INT32</span>:
        <span class="enscript-keyword">case</span> <span class="enscript-reference">KC_ST_UINT32</span>:
            <span class="enscript-keyword">return</span> <span class="enscript-keyword">sizeof</span>(uint32_t);
            <span class="enscript-keyword">break</span>;
        <span class="enscript-keyword">case</span> <span class="enscript-reference">KC_ST_INT64</span>:
        <span class="enscript-keyword">case</span> <span class="enscript-reference">KC_ST_UINT64</span>:
            <span class="enscript-keyword">return</span> <span class="enscript-keyword">sizeof</span>(uint64_t);
            <span class="enscript-keyword">break</span>;
            
        <span class="enscript-reference">default</span>:
            assert(0);
            <span class="enscript-keyword">break</span>;
    }
    <span class="enscript-keyword">return</span> 0;
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">setup_subtype_array_description</span>(kcdata_subtype_descriptor_t desc, kctype_subtype_t type, uint32_t offset, uint32_t count, <span class="enscript-type">char</span> *name)
{
    desc-&gt;kcs_flags = KCS_SUBTYPE_FLAGS_ARRAY;
    desc-&gt;kcs_elem_type = type;
    desc-&gt;kcs_elem_offset = offset;
    desc-&gt;kcs_elem_size = KCS_SUBTYPE_PACK_SIZE(count, get_kctype_subtype_size(type));
    memcpy(desc-&gt;kcs_name, name, <span class="enscript-keyword">sizeof</span>(desc-&gt;kcs_name));
    desc-&gt;kcs_name[<span class="enscript-keyword">sizeof</span>(desc-&gt;kcs_name) - 1] = <span class="enscript-string">'\0'</span>;
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">setup_subtype_description</span>(kcdata_subtype_descriptor_t desc, kctype_subtype_t type, uint32_t offset, <span class="enscript-type">char</span> *name)
{
    desc-&gt;kcs_flags = KCS_SUBTYPE_FLAGS_NONE;
    desc-&gt;kcs_elem_type = type;
    desc-&gt;kcs_elem_offset = offset;
    desc-&gt;kcs_elem_size = get_kctype_subtype_size(type);
    memcpy(desc-&gt;kcs_name, name, <span class="enscript-keyword">sizeof</span>(desc-&gt;kcs_name));
    desc-&gt;kcs_name[<span class="enscript-keyword">sizeof</span>(desc-&gt;kcs_name) - 1] = <span class="enscript-string">'\0'</span>;
}

</pre>
<hr />
</body></html>