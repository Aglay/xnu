<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>blist.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">blist.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 1998 Matthew Dillon.  Terms of use and redistribution in all
 * forms are covered by the BSD copyright in the file &quot;/usr/src/COPYRIGHT&quot;.
 *
 * Implements bitmap resource lists.
 *
 *	Usage:
 *		blist = blist_create(blocks)
 *		(void)  blist_destroy(blist)
 *		blkno = blist_alloc(blist, count)
 *		(void)  blist_free(blist, blkno, count)
 *		(void)  blist_resize(&amp;blist, count, freeextra)
 *		
 *
 *	Notes:
 *		on creation, the entire list is marked reserved.  You should
 *		first blist_free() the sections you want to make available
 *		for allocation before doing general blist_alloc()/free()
 *		ops.
 *
 *		SWAPBLK_NONE is returned on failure.  This module is typically
 *		capable of managing up to (2^31) blocks per blist, though
 *		the memory utilization would be insane if you actually did
 *		that.  Managing something like 512MB worth of 4K blocks 
 *		eats around 32 KBytes of memory. 
 *
 * $FreeBSD: src/sys/sys/blist.h,v 1.2 1999/08/28 00:51:33 peter Exp $
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_SYS_BLIST_H_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_SYS_BLIST_H_</span>

#<span class="enscript-reference">define</span> <span class="enscript-function-name">LOG2</span>(v)		(((u_daddr_t)(v) &gt;= 0x80000000U) ? 31 : \
			((u_daddr_t)(v) &gt;= 0x40000000U) ? 30 : \
			((u_daddr_t)(v) &gt;= 0x20000000U) ? 29 : \
			((u_daddr_t)(v) &gt;= 0x10000000U) ? 28 : \
			((u_daddr_t)(v) &gt;= 0x08000000U) ? 27 : \
			((u_daddr_t)(v) &gt;= 0x04000000U) ? 26 : \
			((u_daddr_t)(v) &gt;= 0x02000000U) ? 25 : \
			((u_daddr_t)(v) &gt;= 0x01000000U) ? 24 : \
			((u_daddr_t)(v) &gt;= 0x00800000U) ? 23 : \
			((u_daddr_t)(v) &gt;= 0x00400000U) ? 22 : \
			((u_daddr_t)(v) &gt;= 0x00200000U) ? 21 : \
			((u_daddr_t)(v) &gt;= 0x00100000U) ? 20 : \
			((u_daddr_t)(v) &gt;= 0x00080000U) ? 19 : \
			((u_daddr_t)(v) &gt;= 0x00040000U) ? 18 : \
			((u_daddr_t)(v) &gt;= 0x00020000U) ? 17 : \
			((u_daddr_t)(v) &gt;= 0x00010000U) ? 16 : \
			((u_daddr_t)(v) &gt;= 0x00008000U) ? 15 : \
			((u_daddr_t)(v) &gt;= 0x00004000U) ? 14 : \
			((u_daddr_t)(v) &gt;= 0x00002000U) ? 13 : \
			((u_daddr_t)(v) &gt;= 0x00001000U) ? 12 : \
			((u_daddr_t)(v) &gt;= 0x00000800U) ? 11 : \
			((u_daddr_t)(v) &gt;= 0x00000400U) ? 10 : \
			((u_daddr_t)(v) &gt;= 0x00000200U) ? 9 : \
			((u_daddr_t)(v) &gt;= 0x00000100U) ? 8 : \
			((u_daddr_t)(v) &gt;= 0x00000080U) ? 7 : \
			((u_daddr_t)(v) &gt;= 0x00000040U) ? 6 : \
			((u_daddr_t)(v) &gt;= 0x00000020U) ? 5 : \
			((u_daddr_t)(v) &gt;= 0x00000010U) ? 4 : \
			((u_daddr_t)(v) &gt;= 0x00000008U) ? 3 : \
			((u_daddr_t)(v) &gt;= 0x00000004U) ? 2 : \
			((u_daddr_t)(v) &gt;= 0x00000002U) ? 1 : 0)

<span class="enscript-comment">/*
 * blmeta and bl_bitmap_t MUST be a power of 2 in size.
 */</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> blmeta {
	<span class="enscript-type">union</span> {
	    daddr_t	bmu_avail;	<span class="enscript-comment">/* space available under us	*/</span>
	    u_daddr_t	bmu_bitmap;	<span class="enscript-comment">/* bitmap if we are a leaf	*/</span>
	} u;
	daddr_t		bm_bighint;	<span class="enscript-comment">/* biggest contiguous block hint*/</span>
} blmeta_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> blist {
	daddr_t		bl_blocks;	<span class="enscript-comment">/* area of coverage		*/</span>
	daddr_t		bl_radix;	<span class="enscript-comment">/* coverage radix		*/</span>
	daddr_t		bl_skip;	<span class="enscript-comment">/* starting skip		*/</span>
	daddr_t		bl_free;	<span class="enscript-comment">/* number of free blocks	*/</span>
	blmeta_t	*bl_root;	<span class="enscript-comment">/* root of radix tree		*/</span>
	daddr_t		bl_rootblks;	<span class="enscript-comment">/* daddr_t blks allocated for tree */</span>
} *blist_t;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">BLIST_META_RADIX</span>	16
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">BLIST_META_RADIX_SHIFT</span>	LOG2(BLIST_META_RADIX)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">BLIST_BMAP_RADIX</span>	(sizeof(u_daddr_t)*8)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">BLIST_BMAP_RADIX_SHIFT</span>	LOG2(BLIST_BMAP_RADIX)

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">BLIST_MAX_ALLOC</span>		BLIST_BMAP_RADIX

<span class="enscript-type">extern</span> blist_t <span class="enscript-function-name">blist_create</span>(daddr_t blocks);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">blist_destroy</span>(blist_t blist);
<span class="enscript-type">extern</span> daddr_t <span class="enscript-function-name">blist_alloc</span>(blist_t blist, daddr_t count);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">blist_free</span>(blist_t blist, daddr_t blkno, daddr_t count);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">blist_print</span>(blist_t blist);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">blist_resize</span>(blist_t *pblist, daddr_t count, <span class="enscript-type">int</span> freenew);

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* _SYS_BLIST_H_ */</span>
</pre>
<hr />
</body></html>