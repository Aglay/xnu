<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>mptcp.d</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">mptcp.d&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
/*
 * Copyright (c) 2013-2014 Apple Computer, Inc.  All Rights Reserved.
 *
 * @APPLE_LICENSE_HEADER_START@
 *
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this
 * file.
 *
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 *
 * @APPLE_LICENSE_HEADER_END@
 */

#pragma D depends_on library darwin.d
#pragma D depends_on library socket.d
#pragma D depends_on module mach_kernel
#pragma D depends_on provider mptcp
#pragma D depends_on provider ip

/*
 * MPTCP Protocol Control Block.
 */
inline int MPTCPS_CLOSED                = 0;
#pragma D binding &quot;1.0&quot; MPTCPS_CLOSED
inline int MPTCPS_LISTEN                = 1;
#pragma D binding &quot;1.0&quot; MPTCPS_LISTEN
inline int MPTCPS_ESTABLISHED           = 2;
#pragma D binding &quot;1.0&quot; MPTCPS_ESTABLISHED
inline int MPTCPS_CLOSE_WAIT            = 3;
#pragma D binding &quot;1.0&quot; MPTCPS_CLOSE_WAIT
inline int MPTCPS_FIN_WAIT_1            = 4;
#pragma D binding &quot;1.0&quot; MPTCPS_FIN_WAIT_1
inline int MPTCPS_CLOSING               = 5;
#pragma D binding &quot;1.0&quot; MPTCPS_CLOSING
inline int MPTCPS_LAST_ACK              = 6;
#pragma D binding &quot;1.0&quot; MPTCPS_LAST_ACK
inline int MPTCPS_FIN_WAIT_2            = 7;
#pragma D binding &quot;1.0&quot; MPTCPS_FIN_WAIT_2
inline int MPTCPS_TIME_WAIT             = 8;
#pragma D binding &quot;1.0&quot; MPTCPS_TIME_WAIT
inline int MPTCPS_FASTCLOSE_WAIT        = 9;
#pragma D binding &quot;1.0&quot; MPTCPS_FASTCLOSE_WAIT
inline int MPTCPS_TERMINATE		= 10;
#pragma D binding &quot;1.0&quot; MPTCPS_TERMINATE

typedef uint64_t mptcp_key_t;
typedef uint32_t mptcp_token_t;

typedef struct mptsinfo {
	string		state;
	uint32_t	flags;
	uint32_t	vers;
	uint32_t	error;
	mptcp_key_t	localkey;
	mptcp_key_t	remotekey;
	mptcp_token_t	localtoken;
	mptcp_token_t	remotetoken;
	int		rxtshift;
	uint32_t	rxtstart;
	uint64_t	rtseq;
	uint32_t	timervals;
	uint32_t	timewait;
	uint64_t	snduna;
	uint64_t	sndnxt;
	uint64_t	sndmax;
	uint64_t	local_idsn;
	uint32_t	sndwnd;
	uint64_t	rcvnxt;
	uint64_t	rcvatmark;
	uint64_t	remote_idsn;
	uint32_t	rcvwnd;
	struct mptcb	*mptcb;
} mptsinfo_t;

#pragma D binding &quot;1.0&quot; translator
translator mptsinfo_t &lt; struct mptcb *T &gt; {
	state        = T-&gt;mpt_state == MPTCPS_CLOSED ? &quot;state-closed&quot; :
		       T-&gt;mpt_state == MPTCPS_LISTEN ? &quot;state-listen&quot; :
		       T-&gt;mpt_state == MPTCPS_ESTABLISHED ?
		           &quot;state-established&quot; :
		       T-&gt;mpt_state == MPTCPS_CLOSE_WAIT ? &quot;state-close-wait&quot; :
		       T-&gt;mpt_state == MPTCPS_FIN_WAIT_1 ? &quot;state-fin-wait-1&quot; :
		       T-&gt;mpt_state == MPTCPS_CLOSING ? &quot;state-closing&quot; :
		       T-&gt;mpt_state == MPTCPS_LAST_ACK ? &quot;state-last-ack&quot; :
		       T-&gt;mpt_state == MPTCPS_FIN_WAIT_2 ? &quot;state-fin-wait-2&quot; :
		       T-&gt;mpt_state == MPTCPS_TIME_WAIT ? &quot;state-time-wait&quot; :
		       T-&gt;mpt_state == MPTCPS_FASTCLOSE_WAIT ?
		           &quot;state-fastclose-wait&quot; :
		       T-&gt;mpt_state == MPTCPS_TERMINATE ?
		           &quot;state-terminate&quot; :
		       &quot;&lt;unknown&gt;&quot;;
	flags        = T-&gt;mpt_flags;
	vers         = T-&gt;mpt_version;
	error        = T-&gt;mpt_softerror;
	localkey     = T-&gt;mpt_localkey ? *T-&gt;mpt_localkey : 0;
	remotekey    = T-&gt;mpt_remotekey;
	localtoken   = T-&gt;mpt_localtoken;
	remotetoken  = T-&gt;mpt_remotetoken;
	rxtshift     = T-&gt;mpt_rxtshift;
	rxtstart     = T-&gt;mpt_rxtstart;
	rtseq	     = T-&gt;mpt_rtseq;
	timervals    = T-&gt;mpt_timer_vals;
	timewait     = T-&gt;mpt_timewait;
	snduna       = T-&gt;mpt_snduna;
	sndnxt	     = T-&gt;mpt_sndnxt;
	sndmax	     = T-&gt;mpt_sndmax;
	local_idsn   = T-&gt;mpt_local_idsn;
	sndwnd	     = T-&gt;mpt_sndwnd;
	rcvnxt	     = T-&gt;mpt_rcvnxt;
	rcvatmark    = T-&gt;mpt_rcvatmark;
	remote_idsn  = T-&gt;mpt_remote_idsn;
	rcvwnd       = T-&gt;mpt_rcvwnd;
	mptcb	     = T;
};

/*
 * Multipath Control Block.
 */
inline int MPPCB_STATE_INUSE	= 1;
#pragma D binding &quot;1.0&quot; MPPCB_STATE_INUSE
inline int MPPCB_STATE_DEAD	= 2;
#pragma D binding &quot;1.0&quot; MPPCB_STATE_DEAD

typedef struct mppsinfo {
	string		state;
	uint32_t	flags;
	struct mppcb	*mppcb;
} mppsinfo_t;

#pragma D binding &quot;1.0&quot; translator
translator mppsinfo_t &lt; struct mppcb *T&gt; {
	state  = T ? 
	    T-&gt;mpp_state == MPPCB_STATE_INUSE ? &quot;state-inuse&quot; :
	    T-&gt;mpp_state == MPPCB_STATE_DEAD ? &quot;state-dead&quot; :
	    &quot;&lt;unknown&gt;&quot; : &quot;&lt;null&gt;&quot;;
	flags  = T-&gt;mpp_flags;
	mppcb  = T;
};

/*
 * MPTCP Session.
 */
typedef struct mptsesinfo {
	uint16_t	numflows;
	uint16_t	nummpcapflows;
	sae_connid_t	connid_last;
	uint8_t		flags;
	struct mptses	*mptses;
} mptsesinfo_t;

#pragma D binding &quot;1.0&quot; translator
translator mptsesinfo_t &lt; struct mptses *T &gt; {
	numflows      = T-&gt;mpte_numflows;
	nummpcapflows = T-&gt;mpte_nummpcapflows;
	connid_last   = T-&gt;mpte_connid_last;
	flags         = T-&gt;mpte_flags;
	mptses	      = T;
};

/*
 * MPTCP Subflow.
 */
inline int MPTSF_ATTACHED       = 0x00001;
#pragma D binding &quot;1.0&quot; MPTSF_ATTACHED
inline int MPTSF_CONNECTING     = 0x00002;
#pragma D binding &quot;1.0&quot; MPTSF_CONNECTING
inline int MPTSF_CONNECT_PENDING= 0x00004;
#pragma D binding &quot;1.0&quot; MPTSF_CONNECT_PENDING
inline int MPTSF_CONNECTED      = 0x00008;
#pragma D binding &quot;1.0&quot; MPTSF_CONNECTED
inline int MPTSF_DISCONNECTING  = 0x00010;
#pragma D binding &quot;1.0&quot; MPTSF_DISCONNECTING
inline int MPTSF_DISCONNECTED   = 0x00020;
#pragma D binding &quot;1.0&quot; MPTSF_DISCONNECTED
inline int MPTSF_MP_CAPABLE     = 0x00040;
#pragma D binding &quot;1.0&quot; MPTSF_MP_CAPABLE
inline int MPTSF_MP_READY       = 0x00080;
#pragma D binding &quot;1.0&quot; MPTSF_MP_READY
inline int MPTSF_MP_DEGRADED    = 0x00100;
#pragma D binding &quot;1.0&quot; MPTSF_MP_DEGRADED
inline int MPTSF_SUSPENDED      = 0x00200;
#pragma D binding &quot;1.0&quot; MPTSF_SUSPENDED
inline int MPTSF_BOUND_IF       = 0x00400;
#pragma D binding &quot;1.0&quot; MPTSF_BOUND_IF
inline int MPTSF_BOUND_IP       = 0x00800;
#pragma D binding &quot;1.0&quot; MPTSF_BOUND_IP
inline int MPTSF_BOUND_PORT     = 0x01000;
#pragma D binding &quot;1.0&quot; MPTSF_BOUND_PORT
inline int MPTSF_PREFERRED      = 0x02000;
#pragma D binding &quot;1.0&quot; MPTSF_PREFERRED
inline int MPTSF_SOPT_OLDVAL    = 0x04000;
#pragma D binding &quot;1.0&quot; MPTSF_SOPT_OLDVAL
inline int MPTSF_SOPT_INPROG    = 0x08000;
#pragma D binding &quot;1.0&quot; MPTSF_SOPT_INPROG
inline int MPTSF_DELETEOK       = 0x10000;
#pragma D binding &quot;1.0&quot; MPTSF_DELETEOK
inline int MPTSF_FAILINGOVER    = 0x20000;
#pragma D binding &quot;1.0&quot; MPTSF_FAILINGOVER
inline int MPTSF_ACTIVE         = 0x40000;
#pragma D binding &quot;1.0&quot; MPTSF_ACTIVE
inline int MPTSF_MPCAP_CTRSET   = 0x80000;
#pragma D binding &quot;1.0&quot; MPTSF_MPCAP_CTRSET
inline int MPTSF_FASTJ_SEND	= 0x100000;
#pragma D binding &quot;1.0&quot; MPTSF_FASTJ_SEND

typedef struct mptsubinfo {
	uint32_t	flags;
	uint32_t	evctl;
	uint32_t	family;
	sae_connid_t	connid;
	uint32_t	rank;
	int32_t		error;
	uint64_t	sndnxt;
	struct mptsub	*mptsub;
} mptsubinfo_t;

#pragma D binding &quot;1.0&quot; translator
translator mptsubinfo_t &lt; struct mptsub *T &gt; {
	flags   = T-&gt;mpts_flags;
	evctl   = T-&gt;mpts_evctl;
	family  = T-&gt;mpts_family;
	connid  = T-&gt;mpts_connid;
	rank    = T-&gt;mpts_rank;
	error   = T-&gt;mpts_soerror;
	sndnxt  = T-&gt;mpts_sndnxt;
	mptsub  = T;
};
</pre>
<hr />
</body></html>