<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>instr_size.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">instr_size.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * CDDL HEADER START
 *
 * The contents of this file are subject to the terms of the
 * Common Development and Distribution License, Version 1.0 only
 * (the &quot;License&quot;).  You may not use this file except in compliance
 * with the License.
 *
 * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE
 * or <a href="http://www.opensolaris.org/os/licensing.">http://www.opensolaris.org/os/licensing.</a>
 * See the License for the specific language governing permissions
 * and limitations under the License.
 *
 * When distributing Covered Code, include this CDDL HEADER in each
 * file and include the License file at usr/src/OPENSOLARIS.LICENSE.
 * If applicable, add the following below this CDDL HEADER, with the
 * fields enclosed by brackets &quot;[]&quot; replaced with your own identifying
 * information: Portions Copyright [yyyy] [name of copyright owner]
 *
 * CDDL HEADER END
 */</span>
<span class="enscript-comment">/*
 * Copyright 2005 Sun Microsystems, Inc.  All rights reserved.
 * Use is subject to license terms.
 */</span>

<span class="enscript-comment">/*	Copyright (c) 1988 AT&amp;T	*/</span>
<span class="enscript-comment">/*	  All Rights Reserved	*/</span>


<span class="enscript-comment">/*
 * #pragma ident	&quot;@(#)instr_size.c	1.14	05/07/08 SMI&quot;
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/dtrace.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/dtrace_glue.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/dis_tables.h&gt;</span>

<span class="enscript-comment">/*
 * This subsystem (with the minor exception of the instr_size() function) is
 * is called from DTrace probe context.  This imposes several requirements on
 * the implementation:
 *
 * 1. External subsystems and functions may not be referenced.  The one current
 *    exception is for cmn_err, but only to signal the detection of table
 *    errors.  Assuming the tables are correct, no combination of input is to
 *    trigger a cmn_err call.
 *
 * 2. These functions can't be allowed to be traced.  To prevent this,
 *    all functions in the probe path (everything except instr_size()) must
 *    have names that begin with &quot;dtrace_&quot;.
 */</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> dis_isize {
	DIS_ISIZE_INSTR,
	DIS_ISIZE_OPERAND
} dis_isize_t;


<span class="enscript-comment">/*
 * get a byte from instruction stream
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">dtrace_dis_get_byte</span>(<span class="enscript-type">void</span> *p)
{
	<span class="enscript-type">int</span> ret;
	uchar_t **instr = p;

	ret = **instr;
	*instr += 1;

	<span class="enscript-keyword">return</span> (ret);
}

<span class="enscript-comment">/*
 * Returns either the size of a given instruction, in bytes, or the size of that
 * instruction's memory access (if any), depending on the value of `which'.
 * If a programming error in the tables is detected, the system will panic to
 * ease diagnosis.  Invalid instructions will not be flagged.  They will appear
 * to have an instruction size between 1 and the actual size, and will be
 * reported as having no memory impact.
 */</span>
<span class="enscript-comment">/* ARGSUSED2 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">dtrace_dis_isize</span>(uchar_t *instr, dis_isize_t which, model_t model, <span class="enscript-type">int</span> *rmindex)
{
	<span class="enscript-type">int</span> sz;
	dis86_t	x;
	uint_t mode = SIZE32;

	mode = (model == DATAMODEL_LP64) ? SIZE64 : SIZE32;

	x.d86_data = (<span class="enscript-type">void</span> **)&amp;instr;
	x.d86_get_byte = dtrace_dis_get_byte;
	x.d86_check_func = NULL;

	<span class="enscript-keyword">if</span> (dtrace_disx86(&amp;x, mode) != 0)
		<span class="enscript-keyword">return</span> (-1);

	<span class="enscript-keyword">if</span> (which == DIS_ISIZE_INSTR)
		sz = x.d86_len;		<span class="enscript-comment">/* length of the instruction */</span>
	<span class="enscript-keyword">else</span>
		sz = x.d86_memsize;	<span class="enscript-comment">/* length of memory operand */</span>

	<span class="enscript-keyword">if</span> (rmindex != NULL)
		*rmindex = x.d86_rmindex;
	<span class="enscript-keyword">return</span> (sz);
}

<span class="enscript-type">int</span>
<span class="enscript-function-name">dtrace_instr_size_isa</span>(uchar_t *instr, model_t model, <span class="enscript-type">int</span> *rmindex)
{
	<span class="enscript-keyword">return</span> (dtrace_dis_isize(instr, DIS_ISIZE_INSTR, model, rmindex));
}

<span class="enscript-type">int</span>
<span class="enscript-function-name">dtrace_instr_size</span>(uchar_t *instr)
{
	<span class="enscript-keyword">return</span> (dtrace_dis_isize(instr, DIS_ISIZE_INSTR, DATAMODEL_NATIVE,
	    NULL));
}
</pre>
<hr />
</body></html>