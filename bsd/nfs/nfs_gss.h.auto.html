<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>nfs_gss.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">nfs_gss.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2007-2015 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_NFS_NFS_GSS_H_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_NFS_NFS_GSS_H_</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;gssd/gssd_mach.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/param.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;nfs/nfs_ioctl.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/crypto/des.h&gt;</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">RPCSEC_GSS</span>			6
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">RPCSEC_GSS_VERS_1</span>		1

<span class="enscript-type">enum</span> rpcsec_gss_proc {
	RPCSEC_GSS_DATA			= 0,
	RPCSEC_GSS_INIT			= 1,
	RPCSEC_GSS_CONTINUE_INIT	= 2,
	RPCSEC_GSS_DESTROY		= 3
};

<span class="enscript-type">enum</span> rpcsec_gss_service {
	RPCSEC_GSS_SVC_NONE		= 1,	<span class="enscript-comment">// sec=krb5
</span>	RPCSEC_GSS_SVC_INTEGRITY	= 2,	<span class="enscript-comment">// sec=krb5i
</span>	RPCSEC_GSS_SVC_PRIVACY		= 3,	<span class="enscript-comment">// sec=krb5p
</span>};

<span class="enscript-comment">/* encoded krb5 OID */</span>
<span class="enscript-type">extern</span> u_char krb5_mech[11];

<span class="enscript-comment">/*
 * GSS-API things
 */</span>
<span class="enscript-type">typedef</span> uint32_t OM_uint32;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_S_COMPLETE</span>			0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_S_CONTINUE_NEEDED</span>		1

<span class="enscript-comment">/*
 * Some &quot;helper&quot; definitions to make the status code macros obvious.
 * From gssapi.h:
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_C_CALLING_ERROR_OFFSET</span> 24
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_C_ROUTINE_ERROR_OFFSET</span> 16
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_C_SUPPLEMENTARY_OFFSET</span> 0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_C_CALLING_ERROR_MASK</span> ((OM_uint32) 0377ul)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_C_ROUTINE_ERROR_MASK</span> ((OM_uint32) 0377ul)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_C_SUPPLEMENTARY_MASK</span> ((OM_uint32) 0177777ul)

<span class="enscript-comment">/*
 * The macros that test status codes for error conditions.  Note that the
 * GSS_ERROR() macro has changed slightly from the V1 GSSAPI so that it now
 * evaluates its argument only once.
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">GSS_CALLING_ERROR</span>(x) \
	((x) &amp; (GSS_C_CALLING_ERROR_MASK &lt;&lt; GSS_C_CALLING_ERROR_OFFSET))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">GSS_ROUTINE_ERROR</span>(x) \
	((x) &amp; (GSS_C_ROUTINE_ERROR_MASK &lt;&lt; GSS_C_ROUTINE_ERROR_OFFSET))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">GSS_SUPPLEMENTARY_INFO</span>(x) \
	((x) &amp; (GSS_C_SUPPLEMENTARY_MASK &lt;&lt; GSS_C_SUPPLEMENTARY_OFFSET))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">GSS_ERROR</span>(x) \
	((x) &amp; ((GSS_C_CALLING_ERROR_MASK &lt;&lt; GSS_C_CALLING_ERROR_OFFSET) | \
		(GSS_C_ROUTINE_ERROR_MASK &lt;&lt; GSS_C_ROUTINE_ERROR_OFFSET)))

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_MAXSEQ</span>			0x80000000	// The biggest sequence number
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_SVC_MAXCONTEXTS</span>		500000		// Max contexts supported
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_SVC_SEQWINDOW</span>		256		// Server's sequence window
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_CLNT_SEQLISTMAX</span>		32		// Max length of req seq num list

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SKEYLEN</span>	8			// length of DES key
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SKEYLEN3</span> 24			// length of DES3 keyboard
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MAX_SKEYLEN</span>	SKEYLEN3

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_MAX_NEG_CACHE_ENTRIES</span> 16
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_NEG_CACHE_TO</span> 3
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_PRINT_DELAY</span>	 (8 * 3600)	// Wait day before printing the same error message

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
	uint32_t type; 		<span class="enscript-comment">// See defines below
</span>	uint32_t keybytes; 	<span class="enscript-comment">// Session key length bytes;
</span>	uint32_t hash_len;
	u_char   skey[MAX_SKEYLEN];	   	<span class="enscript-comment">// Session key;
</span>	<span class="enscript-type">union</span> {
		<span class="enscript-type">struct</span> {
			des_cblock  *key;
			des_cbc_key_schedule gss_sched;
			des_cbc_key_schedule gss_sched_Ke;
		} des;
		<span class="enscript-type">struct</span> {
			des_cblock		(*key)[3];
			des_cblock		ckey[3];
			des3_cbc_key_schedule	gss_sched;
		} des3;
	} ks_u;
} gss_key_info;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">NFS_GSS_0DES</span>	0 // Not DES or uninitialized
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">NFS_GSS_1DES</span>	1 // Single DES with DES_MAC_MD5
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">NFS_GSS_3DES</span>	2 // Triple EDE DES KD with SHA1

<span class="enscript-comment">/*
 * The client's RPCSEC_GSS context information
 */</span>
<span class="enscript-type">struct</span> nfs_gss_clnt_ctx {
	lck_mtx_t		*gss_clnt_mtx;
	thread_t		gss_clnt_thread;	<span class="enscript-comment">// Thread creating context
</span>	TAILQ_ENTRY(nfs_gss_clnt_ctx)	gss_clnt_entries;
	uint32_t		gss_clnt_flags;		<span class="enscript-comment">// Flag bits - see below
</span>	int32_t			gss_clnt_refcnt;	<span class="enscript-comment">// Reference count
</span>	kauth_cred_t		gss_clnt_cred;		<span class="enscript-comment">// Owner of this context
</span>	uint8_t			*gss_clnt_principal;	<span class="enscript-comment">// Principal to use for this credential
</span>	uint32_t		gss_clnt_prinlen;	<span class="enscript-comment">// Length of principal
</span>	gssd_nametype		gss_clnt_prinnt;	<span class="enscript-comment">// Name type of principal
</span>	<span class="enscript-type">char</span>			*gss_clnt_display;	<span class="enscript-comment">// display name of principal
</span>	uint32_t		gss_clnt_proc;		<span class="enscript-comment">// Current GSS proc for cred
</span>	uint32_t		gss_clnt_seqnum;	<span class="enscript-comment">// GSS sequence number
</span>	uint32_t		gss_clnt_service;	<span class="enscript-comment">// Indicates krb5, krb5i or krb5p
</span>	uint8_t			*gss_clnt_handle;	<span class="enscript-comment">// Identifies server context
</span>	uint32_t		gss_clnt_handle_len;	<span class="enscript-comment">// Size of server's ctx handle
</span>	time_t			gss_clnt_nctime;	<span class="enscript-comment">// When context was put in the negative cache
</span>	uint32_t		gss_clnt_seqwin;	<span class="enscript-comment">// Server's seq num window
</span>	uint32_t		*gss_clnt_seqbits;	<span class="enscript-comment">// Bitmap to track seq numbers in use
</span>	mach_port_t		gss_clnt_mport;		<span class="enscript-comment">// Mach port for gssd upcall
</span>	uint8_t			*gss_clnt_verf;		<span class="enscript-comment">// RPC verifier from server
</span>	uint8_t			*gss_clnt_svcname;	<span class="enscript-comment">// Service name e.g. &quot;nfs/big.apple.com&quot;
</span>	uint32_t		gss_clnt_svcnamlen;	<span class="enscript-comment">// Service name length
</span>	gssd_nametype		gss_clnt_svcnt;		<span class="enscript-comment">// Service name type
</span>	gssd_cred		gss_clnt_cred_handle;	<span class="enscript-comment">// Opaque cred handle from gssd
</span>	gssd_ctx		gss_clnt_context;	<span class="enscript-comment">// Opaque context handle from gssd
</span>	uint8_t			*gss_clnt_token;	<span class="enscript-comment">// GSS token exchanged via gssd &amp; server
</span>	uint32_t		gss_clnt_tokenlen;	<span class="enscript-comment">// Length of token
</span>	gss_key_info		*gss_clnt_kinfo;		<span class="enscript-comment">// GSS key info
</span>	uint32_t		gss_clnt_gssd_flags;	<span class="enscript-comment">// Special flag bits to gssd
</span>	uint32_t		gss_clnt_major;		<span class="enscript-comment">// GSS major result from gssd or server
</span>	uint32_t		gss_clnt_minor;		<span class="enscript-comment">// GSS minor result from gssd or server
</span>	time_t			gss_clnt_ptime;		<span class="enscript-comment">// When last error message was printed
</span>};

<span class="enscript-comment">/*
 * gss_clnt_flags
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_CTX_COMPLETE</span>	0x00000001	// Context is complete
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_CTX_INVAL</span>		0x00000002	// Context is invalid
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_CTX_STICKY</span>		0x00000004	// Context has been set by user
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_NEEDSEQ</span>		0x00000008	// Need a sequence number
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_NEEDCTX</span>		0x00000010	// Need the context
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_CTX_DESTROY</span>		0x00000020	// Context is being destroyed, don't cache

<span class="enscript-comment">/*
 * The server's RPCSEC_GSS context information
 */</span>
<span class="enscript-type">struct</span> nfs_gss_svc_ctx {
	lck_mtx_t		*gss_svc_mtx;
	LIST_ENTRY(nfs_gss_svc_ctx)	gss_svc_entries;
	uint32_t		gss_svc_handle;		<span class="enscript-comment">// Identifies server context to client
</span>	uint32_t		gss_svc_refcnt;		<span class="enscript-comment">// Reference count
</span>	uint32_t		gss_svc_proc;		<span class="enscript-comment">// Current GSS proc from cred
</span>	uid_t			gss_svc_uid;		<span class="enscript-comment">// UID of this user
</span>	gid_t			gss_svc_gids[NGROUPS];	<span class="enscript-comment">// GIDs of this user
</span>	uint32_t		gss_svc_ngroups;	<span class="enscript-comment">// Count of gids
</span>	uint64_t		gss_svc_incarnation;	<span class="enscript-comment">// Delete ctx if we exceed this + ttl value
</span>	uint32_t		gss_svc_seqmax;		<span class="enscript-comment">// Current max GSS sequence number
</span>	uint32_t		gss_svc_seqwin;		<span class="enscript-comment">// GSS sequence number window
</span>	uint32_t		*gss_svc_seqbits;	<span class="enscript-comment">// Bitmap to track seq numbers
</span>	gssd_cred		gss_svc_cred_handle;	<span class="enscript-comment">// Opaque cred handle from gssd
</span>	gssd_ctx		gss_svc_context;	<span class="enscript-comment">// Opaque context handle from gssd
</span>	u_char			*gss_svc_token;		<span class="enscript-comment">// GSS token exchanged via gssd &amp; client
</span>	uint32_t		gss_svc_tokenlen;	<span class="enscript-comment">// Length of token
</span>	gss_key_info		gss_svc_kinfo;		<span class="enscript-comment">// Session key info
</span>	uint32_t		gss_svc_major;		<span class="enscript-comment">// GSS major result from gssd
</span>	uint32_t		gss_svc_minor;		<span class="enscript-comment">// GSS minor result from gssd
</span>};

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SVC_CTX_HASHSZ</span>	64
#<span class="enscript-reference">define</span> <span class="enscript-function-name">SVC_CTX_HASH</span>(handle)	((handle) % SVC_CTX_HASHSZ)
<span class="enscript-function-name">LIST_HEAD</span>(nfs_gss_svc_ctx_hashhead, nfs_gss_svc_ctx);

<span class="enscript-comment">/*
 * Macros to manipulate bits in the sequence window
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">win_getbit</span>(bits, bit)      ((bits[(bit) / 32] &amp;   (1 &lt;&lt; (bit) % 32)) != 0)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">win_setbit</span>(bits, bit)   do { bits[(bit) / 32] |=  (1 &lt;&lt; (bit) % 32); } while (0)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">win_resetbit</span>(bits, bit) do { bits[(bit) / 32] &amp;= ~(1 &lt;&lt; (bit) % 32); } while (0)

<span class="enscript-comment">/*
 * Server context stale times
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_CTX_PEND</span>		5 		// seconds
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_CTX_EXPIRE</span>		(8 * 3600)	// seconds
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_CTX_TTL_MIN</span>		1		// seconds
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">GSS_TIMER_PERIOD</span>	300		// seconds
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MSECS_PER_SEC</span>		1000

#<span class="enscript-reference">define</span> <span class="enscript-function-name">auth_is_kerberized</span>(auth) \
	(auth == RPCAUTH_KRB5 || \
	 auth == RPCAUTH_KRB5I || \
	 auth == RPCAUTH_KRB5P)

__BEGIN_DECLS

<span class="enscript-type">void</span>	nfs_gss_init(<span class="enscript-type">void</span>);
uid_t	nfs_cred_getasid2uid(kauth_cred_t);
<span class="enscript-type">int</span>	nfs_gss_clnt_cred_put(<span class="enscript-type">struct</span> nfsreq *, <span class="enscript-type">struct</span> nfsm_chain *, mbuf_t);
<span class="enscript-type">int</span>	nfs_gss_clnt_verf_get(<span class="enscript-type">struct</span> nfsreq *, <span class="enscript-type">struct</span> nfsm_chain *,
		uint32_t, uint32_t, uint32_t *);
<span class="enscript-type">void</span>	nfs_gss_clnt_rpcdone(<span class="enscript-type">struct</span> nfsreq *);
<span class="enscript-type">int</span>	nfs_gss_clnt_args_restore(<span class="enscript-type">struct</span> nfsreq *);
<span class="enscript-type">int</span>	nfs_gss_clnt_ctx_renew(<span class="enscript-type">struct</span> nfsreq *);
<span class="enscript-type">void</span>	nfs_gss_clnt_ctx_ref(<span class="enscript-type">struct</span> nfsreq *, <span class="enscript-type">struct</span> nfs_gss_clnt_ctx *);
<span class="enscript-type">void</span>	nfs_gss_clnt_ctx_unref(<span class="enscript-type">struct</span> nfsreq *);
<span class="enscript-type">void</span>	nfs_gss_clnt_ctx_unmount(<span class="enscript-type">struct</span> nfsmount *);
<span class="enscript-type">int</span>	nfs_gss_clnt_ctx_remove(<span class="enscript-type">struct</span> nfsmount *, kauth_cred_t);
<span class="enscript-type">int</span>	nfs_gss_clnt_ctx_set_principal(<span class="enscript-type">struct</span> nfsmount *, vfs_context_t, uint8_t *, uint32_t, uint32_t);
<span class="enscript-type">int</span>	nfs_gss_clnt_ctx_get_principal(<span class="enscript-type">struct</span> nfsmount *, vfs_context_t, <span class="enscript-type">struct</span> user_nfs_gss_principal *);
<span class="enscript-type">int</span>	nfs_gss_svc_cred_get(<span class="enscript-type">struct</span> nfsrv_descript *, <span class="enscript-type">struct</span> nfsm_chain *);
<span class="enscript-type">int</span>	nfs_gss_svc_verf_put(<span class="enscript-type">struct</span> nfsrv_descript *, <span class="enscript-type">struct</span> nfsm_chain *);
<span class="enscript-type">int</span>	nfs_gss_svc_ctx_init(<span class="enscript-type">struct</span> nfsrv_descript *, <span class="enscript-type">struct</span> nfsrv_sock *, mbuf_t *);
<span class="enscript-type">int</span>	nfs_gss_svc_prepare_reply(<span class="enscript-type">struct</span> nfsrv_descript *, <span class="enscript-type">struct</span> nfsm_chain *);
<span class="enscript-type">int</span>	nfs_gss_svc_protect_reply(<span class="enscript-type">struct</span> nfsrv_descript *, mbuf_t);
<span class="enscript-type">void</span>	nfs_gss_svc_ctx_deref(<span class="enscript-type">struct</span> nfs_gss_svc_ctx *);
<span class="enscript-type">void</span>	nfs_gss_svc_cleanup(<span class="enscript-type">void</span>);

__END_DECLS
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* _NFS_NFS_GSS_H_ */</span>
</pre>
<hr />
</body></html>