<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>FileIDsServices.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">FileIDsServices.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000-2005 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;../../hfs_macos_defs.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;../../hfs_format.h&quot;</span>

#<span class="enscript-reference">include</span>	<span class="enscript-string">&quot;../headers/FileMgrInternal.h&quot;</span>
#<span class="enscript-reference">include</span>	<span class="enscript-string">&quot;../headers/HFSUnicodeWrappers.h&quot;</span>
#<span class="enscript-reference">include</span>	<span class="enscript-string">&quot;../headers/CatalogPrivate.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/kernel.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/malloc.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/libkern.h&gt;</span>


<span class="enscript-type">struct</span> ExtentsRecBuffer {
	ExtentKey	extentKey;
	ExtentRecord	extentData;
};
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> ExtentsRecBuffer ExtentsRecBuffer;


<span class="enscript-type">static</span> u_int32_t <span class="enscript-function-name">CheckExtents</span>( <span class="enscript-type">void</span> *extents, u_int32_t blocks, Boolean isHFSPlus );
<span class="enscript-type">static</span> OSErr  <span class="enscript-function-name">DeleteExtents</span>( ExtendedVCB *vcb, u_int32_t fileNumber, <span class="enscript-type">int</span> quitEarly, u_int8_t forkType, Boolean isHFSPlus );
<span class="enscript-type">static</span> OSErr  <span class="enscript-function-name">MoveExtents</span>( ExtendedVCB *vcb, u_int32_t srcFileID, u_int32_t destFileID, <span class="enscript-type">int</span> quitEarly, u_int8_t forkType, Boolean isHFSPlus );

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_HFS_STD</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span>  <span class="enscript-function-name">CopyCatalogNodeInfo</span>( CatalogRecord *src, CatalogRecord *dest );
#<span class="enscript-reference">endif</span>

<span class="enscript-type">static</span> <span class="enscript-type">void</span>  <span class="enscript-function-name">CopyBigCatalogNodeInfo</span>( CatalogRecord *src, CatalogRecord *dest );
<span class="enscript-type">static</span> <span class="enscript-type">void</span>  <span class="enscript-function-name">CopyExtentInfo</span>( ExtentKey *key, ExtentRecord *data, ExtentsRecBuffer *buffer, u_int16_t bufferCount );

<span class="enscript-comment">/* 
 * This function moves the overflow extents associated with srcID into the file associated with dstID.
 * We should have already verified that 'srcID' has overflow extents. So now we move all of the overflow
 * extent records.
 */</span>
OSErr <span class="enscript-function-name">MoveData</span>( ExtendedVCB *vcb, HFSCatalogNodeID srcID, HFSCatalogNodeID destID, <span class="enscript-type">int</span> rsrc) { 
	
	OSErr		err;
	
	<span class="enscript-comment">/* 
	 * Only the source file should have extents, so we just track those.
	 * We operate on the fork represented by the open FD that was used to call into this
	 * function
	 */</span>
	<span class="enscript-keyword">if</span> (rsrc) {		
		<span class="enscript-comment">/* Copy the extent overflow blocks. */</span>
		err = MoveExtents( vcb, srcID, destID, 1, (u_int8_t)0xff, 1);
		<span class="enscript-keyword">if</span> ( err != noErr ) {
			<span class="enscript-keyword">if</span> ( err != dskFulErr ) {
				<span class="enscript-keyword">return</span>( err );
			}
			<span class="enscript-comment">/* 
			 * In case of error, we would have probably run into problems
			 * growing the extents b-tree.  Since the move is actually a copy + delete
			 * just delete the new entries. Same for below.
			 */</span>
			err = DeleteExtents( vcb, destID, 1, (u_int8_t)0xff, 1); 
			ReturnIfError( err ); <span class="enscript-comment">//	we are doomed. Just QUIT!
</span>			<span class="enscript-keyword">goto</span> <span class="enscript-reference">FlushAndReturn</span>;
		}
	}
	<span class="enscript-keyword">else</span> {		
		<span class="enscript-comment">/* Copy the extent overflow blocks. */</span>
		err = MoveExtents( vcb, srcID, destID, 1, 0, 1);
		<span class="enscript-keyword">if</span> ( err != noErr ) {
			<span class="enscript-keyword">if</span> ( err != dskFulErr ) {
				<span class="enscript-keyword">return</span>( err );
			}
			err = DeleteExtents( vcb, destID, 1, 0, 1); 
			ReturnIfError( err ); <span class="enscript-comment">//	we are doomed. Just QUIT!
</span>			<span class="enscript-keyword">goto</span> <span class="enscript-reference">FlushAndReturn</span>;
		}
	}
	
<span class="enscript-reference">FlushAndReturn</span>:
	<span class="enscript-comment">/* Write out the catalog and extent overflow B-Tree changes */</span>
	err = FlushCatalog( vcb );
	err = FlushExtentFile( vcb );
	
	<span class="enscript-keyword">return</span>( err );
}


OSErr <span class="enscript-function-name">ExchangeFileIDs</span>( ExtendedVCB *vcb, ConstUTF8Param srcName, ConstUTF8Param destName, HFSCatalogNodeID srcID, HFSCatalogNodeID destID, u_int32_t srcHint, u_int32_t destHint )
{
	CatalogKey	srcKey;		<span class="enscript-comment">// 518 bytes
</span>	CatalogKey	destKey;	<span class="enscript-comment">// 518 bytes
</span>	CatalogRecord	srcData;	<span class="enscript-comment">// 520 bytes
</span>	CatalogRecord	destData;	<span class="enscript-comment">// 520 bytes
</span>	CatalogRecord	swapData;	<span class="enscript-comment">// 520 bytes
</span>	int16_t		numSrcExtentBlocks;
	int16_t		numDestExtentBlocks;
	OSErr		err;
	Boolean		isHFSPlus = ( vcb-&gt;vcbSigWord == kHFSPlusSigWord );

	err = BuildCatalogKeyUTF8(vcb, srcID, srcName, kUndefinedStrLen, &amp;srcKey, NULL);
	ReturnIfError(err);

	err = BuildCatalogKeyUTF8(vcb, destID, destName, kUndefinedStrLen, &amp;destKey, NULL);
	ReturnIfError(err);

	<span class="enscript-keyword">if</span> ( isHFSPlus )
	{
		<span class="enscript-comment">//--	Step 1: Check the catalog nodes for extents
</span>		
		<span class="enscript-comment">//--	locate the source file, test for extents in extent file, and copy the cat record for later
</span>		err = LocateCatalogNodeByKey( vcb, srcHint, &amp;srcKey, &amp;srcData, &amp;srcHint );
		ReturnIfError( err );
	
		<span class="enscript-keyword">if</span> ( srcData.recordType != kHFSPlusFileRecord )
			<span class="enscript-keyword">return</span>( cmFThdDirErr );					<span class="enscript-comment">//	Error &quot;cmFThdDirErr = it is a directory&quot;
</span>			
		<span class="enscript-comment">//--	Check if there are any extents in the source file
</span>		<span class="enscript-comment">//€€	I am only checling the extents in the low 32 bits, routine will fail if files extents after 2 gig are in overflow
</span>		numSrcExtentBlocks = CheckExtents( srcData.hfsPlusFile.dataFork.extents, srcData.hfsPlusFile.dataFork.totalBlocks, isHFSPlus );
		<span class="enscript-keyword">if</span> ( numSrcExtentBlocks == 0 )					<span class="enscript-comment">//	then check the resource fork extents
</span>			numSrcExtentBlocks = CheckExtents( srcData.hfsPlusFile.resourceFork.extents, srcData.hfsPlusFile.resourceFork.totalBlocks, isHFSPlus );

		<span class="enscript-comment">//--	Check if there are any extents in the destination file
</span>		err = LocateCatalogNodeByKey( vcb, destHint, &amp;destKey, &amp;destData, &amp;destHint );
		ReturnIfError( err );
	
		<span class="enscript-keyword">if</span> ( destData.recordType != kHFSPlusFileRecord )
			<span class="enscript-keyword">return</span>( cmFThdDirErr );					<span class="enscript-comment">//	Error &quot;cmFThdDirErr = it is a directory&quot;
</span>
		numDestExtentBlocks = CheckExtents( destData.hfsPlusFile.dataFork.extents, destData.hfsPlusFile.dataFork.totalBlocks, isHFSPlus );
		<span class="enscript-keyword">if</span> ( numDestExtentBlocks == 0 )					<span class="enscript-comment">//	then check the resource fork extents
</span>			numDestExtentBlocks = CheckExtents( destData.hfsPlusFile.resourceFork.extents, destData.hfsPlusFile.resourceFork.totalBlocks, isHFSPlus );

		<span class="enscript-comment">//--	Step 2: Exchange the Extent key in the extent file
</span>		
		<span class="enscript-comment">//--	Exchange the extents key in the extent file
</span>		err = DeleteExtents( vcb, kHFSBogusExtentFileID, 0, 0, isHFSPlus );
		ReturnIfError( err );
		
		<span class="enscript-keyword">if</span> ( numSrcExtentBlocks &amp;&amp; numDestExtentBlocks )	<span class="enscript-comment">//	if both files have extents
</span>		{
			<span class="enscript-comment">//--	Change the source extents file ids to our known bogus value
</span>			err = MoveExtents( vcb, srcData.hfsPlusFile.fileID, kHFSBogusExtentFileID, 0,0, isHFSPlus );
			<span class="enscript-keyword">if</span> ( err != noErr )
			{
				<span class="enscript-keyword">if</span> ( err != dskFulErr ) {
					<span class="enscript-keyword">return</span>( err );
                }
				<span class="enscript-keyword">else</span> {
                    err = DeleteExtents( vcb, kHFSBogusExtentFileID, 0, 0, isHFSPlus );
                    ReturnIfError( err );					<span class="enscript-comment">//	we are doomed. Just QUIT!
</span>                    
                    err = FlushCatalog( vcb );   			<span class="enscript-comment">//	flush the catalog
</span>                    err = FlushExtentFile( vcb );			<span class="enscript-comment">//	flush the extent file (unneeded for common case, but it's cheap)
</span>                    <span class="enscript-keyword">return</span>( dskFulErr );
                }
			}
			
			<span class="enscript-comment">//--	Change the destination extents file id's to the source id's
</span>			err = MoveExtents( vcb, destData.hfsPlusFile.fileID, srcData.hfsPlusFile.fileID, 0, 0, isHFSPlus );
			<span class="enscript-keyword">if</span> ( err != noErr )
			{
				<span class="enscript-keyword">if</span> ( err != dskFulErr )
					<span class="enscript-keyword">return</span>( err );

<span class="enscript-reference">ExUndo2aPlus</span>:	err = DeleteExtents( vcb, srcData.hfsPlusFile.fileID, 0, 0, isHFSPlus );
				ReturnIfError( err );					<span class="enscript-comment">//	we are doomed. Just QUIT!
</span>
                err = MoveExtents( vcb, kHFSBogusExtentFileID, srcData.hfsPlusFile.fileID, 0, 0, isHFSPlus );	<span class="enscript-comment">//	Move the extents back
</span>				ReturnIfError( err );					<span class="enscript-comment">//	we are doomed. Just QUIT!
</span>					
                err = DeleteExtents( vcb, kHFSBogusExtentFileID, 0, 0, isHFSPlus );
                ReturnIfError( err );					<span class="enscript-comment">//	we are doomed. Just QUIT!
</span>                    
                err = FlushCatalog( vcb );   			<span class="enscript-comment">//	flush the catalog
</span>                err = FlushExtentFile( vcb );			<span class="enscript-comment">//	flush the extent file (unneeded for common case, but it's cheap)
</span>                <span class="enscript-keyword">return</span>( dskFulErr );

			}
			
			<span class="enscript-comment">//--	Change the bogus extents file id's to the dest id's
</span>            err = MoveExtents( vcb, kHFSBogusExtentFileID, destData.hfsPlusFile.fileID, 0, 0, isHFSPlus );
			<span class="enscript-keyword">if</span> ( err != noErr )
			{
				<span class="enscript-keyword">if</span> ( err != dskFulErr )
					<span class="enscript-keyword">return</span>( err );

				err = DeleteExtents( vcb, destData.hfsPlusFile.fileID, 0, 0, isHFSPlus );
				ReturnIfError( err );					<span class="enscript-comment">//	we are doomed. Just QUIT!
</span>
				err = MoveExtents( vcb, srcData.hfsPlusFile.fileID, destData.hfsPlusFile.fileID, 0, 0, isHFSPlus );	<span class="enscript-comment">//	Move the extents back
</span>				ReturnIfError( err );					<span class="enscript-comment">//	we are doomed. Just QUIT!
</span>					
				<span class="enscript-keyword">goto</span> <span class="enscript-reference">ExUndo2aPlus</span>;
			}
			
		}
		<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> ( numSrcExtentBlocks )	<span class="enscript-comment">//	just the source file has extents
</span>		{
			err = MoveExtents( vcb, srcData.hfsPlusFile.fileID, destData.hfsPlusFile.fileID, 0, 0, isHFSPlus );
			<span class="enscript-keyword">if</span> ( err != noErr )
			{
				<span class="enscript-keyword">if</span> ( err != dskFulErr )
					<span class="enscript-keyword">return</span>( err );

				err = DeleteExtents( vcb, srcData.hfsPlusFile.fileID, 0, 0, isHFSPlus );
				ReturnIfError( err );					<span class="enscript-comment">//	we are doomed. Just QUIT!
</span>
				<span class="enscript-keyword">goto</span> <span class="enscript-reference">FlushAndReturn</span>;
			}
		}
		<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> ( numDestExtentBlocks )	<span class="enscript-comment">//	just the destination file has extents
</span>		{
			err = MoveExtents( vcb, destData.hfsPlusFile.fileID, srcData.hfsPlusFile.fileID, 0, 0, isHFSPlus );
			<span class="enscript-keyword">if</span> ( err != noErr )
			{
				<span class="enscript-keyword">if</span> ( err != dskFulErr )
					<span class="enscript-keyword">return</span>( err );

				err = DeleteExtents( vcb, destData.hfsPlusFile.fileID, 0, 0, isHFSPlus );
				ReturnIfError( err );					<span class="enscript-comment">//	we are doomed. Just QUIT!
</span>
				<span class="enscript-keyword">goto</span> <span class="enscript-reference">FlushAndReturn</span>;
			}
		}

		<span class="enscript-comment">//--	Step 3: Change the data in the catalog nodes
</span>		
		<span class="enscript-comment">//--	find the source cnode and put dest info in it
</span>		err = LocateCatalogNodeByKey( vcb, srcHint, &amp;srcKey, &amp;srcData, &amp;srcHint );
		<span class="enscript-keyword">if</span> ( err != noErr )
			<span class="enscript-keyword">return</span>( cmBadNews );
		
		BlockMoveData( &amp;srcData, &amp;swapData, <span class="enscript-keyword">sizeof</span>(CatalogRecord) );
		CopyBigCatalogNodeInfo( &amp;destData, &amp;srcData );
		
		err = ReplaceBTreeRecord( vcb-&gt;catalogRefNum, &amp;srcKey, srcHint, &amp;srcData, <span class="enscript-keyword">sizeof</span>(HFSPlusCatalogFile), &amp;srcHint );
		ReturnIfError( err );

		<span class="enscript-comment">//	find the destination cnode and put source info in it		
</span>		err = LocateCatalogNodeByKey( vcb, destHint, &amp;destKey, &amp;destData, &amp;destHint );
		<span class="enscript-keyword">if</span> ( err != noErr )
			<span class="enscript-keyword">return</span>( cmBadNews );
			
		CopyBigCatalogNodeInfo( &amp;swapData, &amp;destData );
		err = ReplaceBTreeRecord( vcb-&gt;catalogRefNum, &amp;destKey, destHint, &amp;destData, <span class="enscript-keyword">sizeof</span>(HFSPlusCatalogFile), &amp;destHint );
		ReturnIfError( err );
	}
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_HFS_STD</span>
	<span class="enscript-keyword">else</span>		<span class="enscript-comment">//	HFS	//
</span>	{
		<span class="enscript-comment">//--	Step 1: Check the catalog nodes for extents
</span>		
		<span class="enscript-comment">//--	locate the source file, test for extents in extent file, and copy the cat record for later
</span>		err = LocateCatalogNodeByKey( vcb, srcHint, &amp;srcKey, &amp;srcData, &amp;srcHint );
		ReturnIfError( err );
	
		<span class="enscript-keyword">if</span> ( srcData.recordType != kHFSFileRecord )
			<span class="enscript-keyword">return</span>( cmFThdDirErr );					<span class="enscript-comment">//	Error &quot;cmFThdDirErr = it is a directory&quot;
</span>			
		<span class="enscript-comment">//--	Check if there are any extents in the source file
</span>		numSrcExtentBlocks = CheckExtents( srcData.hfsFile.dataExtents, srcData.hfsFile.dataPhysicalSize / vcb-&gt;blockSize, isHFSPlus );
		<span class="enscript-keyword">if</span> ( numSrcExtentBlocks == 0 )					<span class="enscript-comment">//	then check the resource fork extents
</span>			numSrcExtentBlocks = CheckExtents( srcData.hfsFile.rsrcExtents, srcData.hfsFile.rsrcPhysicalSize / vcb-&gt;blockSize, isHFSPlus );
		
		
		<span class="enscript-comment">//€€	Do we save the found source node for later use?
</span>		
				
		<span class="enscript-comment">//--	Check if there are any extents in the destination file
</span>		err = LocateCatalogNodeByKey( vcb, destHint, &amp;destKey, &amp;destData, &amp;destHint );
		ReturnIfError( err );
	
		<span class="enscript-keyword">if</span> ( destData.recordType != kHFSFileRecord )
			<span class="enscript-keyword">return</span>( cmFThdDirErr );					<span class="enscript-comment">//	Error &quot;cmFThdDirErr = it is a directory&quot;
</span>
		numDestExtentBlocks = CheckExtents( destData.hfsFile.dataExtents, destData.hfsFile.dataPhysicalSize / vcb-&gt;blockSize, isHFSPlus );
		<span class="enscript-keyword">if</span> ( numDestExtentBlocks == 0 )					<span class="enscript-comment">//	then check the resource fork extents
</span>			numDestExtentBlocks = CheckExtents( destData.hfsFile.rsrcExtents, destData.hfsFile.rsrcPhysicalSize / vcb-&gt;blockSize, isHFSPlus );
			
		<span class="enscript-comment">//€€	Do we save the found destination node for later use?
</span>

		<span class="enscript-comment">//--	Step 2: Exchange the Extent key in the extent file
</span>		
		<span class="enscript-comment">//--	Exchange the extents key in the extent file
</span>        err = DeleteExtents( vcb, kHFSBogusExtentFileID, 0, 0, isHFSPlus );
		ReturnIfError( err );
		
		<span class="enscript-keyword">if</span> ( numSrcExtentBlocks &amp;&amp; numDestExtentBlocks )	<span class="enscript-comment">//	if both files have extents
</span>		{
			<span class="enscript-comment">//--	Change the source extents file ids to our known bogus value
</span>        err = MoveExtents( vcb, srcData.hfsFile.fileID, kHFSBogusExtentFileID, 0, 0, isHFSPlus );
			<span class="enscript-keyword">if</span> ( err != noErr )
			{
				<span class="enscript-keyword">if</span> ( err != dskFulErr )
					<span class="enscript-keyword">return</span>( err );

<span class="enscript-reference">ExUndo1a</span>:		err = DeleteExtents( vcb, kHFSBogusExtentFileID, 0, 0, isHFSPlus );
				ReturnIfError( err );					<span class="enscript-comment">//	we are doomed. Just QUIT!
</span>
				err = FlushCatalog( vcb );   			<span class="enscript-comment">//	flush the catalog
</span>				err = FlushExtentFile( vcb );			<span class="enscript-comment">//	flush the extent file (unneeded for common case, but it's cheap)			
</span>				<span class="enscript-keyword">return</span>( dskFulErr );
			}
			
			<span class="enscript-comment">//--	Change the destination extents file id's to the source id's
</span>			err = MoveExtents( vcb, destData.hfsFile.fileID, srcData.hfsFile.fileID, 0, 0, isHFSPlus );
			<span class="enscript-keyword">if</span> ( err != noErr )
			{
				<span class="enscript-keyword">if</span> ( err != dskFulErr )
					<span class="enscript-keyword">return</span>( err );

<span class="enscript-reference">ExUndo2a</span>:		err = DeleteExtents( vcb, srcData.hfsFile.fileID, 0, 0, isHFSPlus );
				ReturnIfError( err );					<span class="enscript-comment">//	we are doomed. Just QUIT!
</span>
                err = MoveExtents( vcb, kHFSBogusExtentFileID, srcData.hfsFile.fileID, 0, 0, isHFSPlus );	<span class="enscript-comment">//	Move the extents back
</span>				ReturnIfError( err );					<span class="enscript-comment">//	we are doomed. Just QUIT!
</span>					
				<span class="enscript-keyword">goto</span> <span class="enscript-reference">ExUndo1a</span>;
			}
			
			<span class="enscript-comment">//--	Change the bogus extents file id's to the dest id's
</span>            err = MoveExtents( vcb, kHFSBogusExtentFileID, destData.hfsFile.fileID, 0, 0, isHFSPlus );
			<span class="enscript-keyword">if</span> ( err != noErr )
			{
				<span class="enscript-keyword">if</span> ( err != dskFulErr )
					<span class="enscript-keyword">return</span>( err );

				err = DeleteExtents( vcb, destData.hfsFile.fileID, 0, 0, isHFSPlus );
				ReturnIfError( err );					<span class="enscript-comment">//	we are doomed. Just QUIT!
</span>
				err = MoveExtents( vcb, srcData.hfsFile.fileID, destData.hfsFile.fileID, 0, 0, isHFSPlus );	<span class="enscript-comment">//	Move the extents back
</span>				ReturnIfError( err );					<span class="enscript-comment">//	we are doomed. Just QUIT!
</span>					
				<span class="enscript-keyword">goto</span> <span class="enscript-reference">ExUndo2a</span>;
			}
			
		}
		<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> ( numSrcExtentBlocks )	<span class="enscript-comment">//	just the source file has extents
</span>		{
			err = MoveExtents( vcb, srcData.hfsFile.fileID, destData.hfsFile.fileID, 0, 0, isHFSPlus );
			<span class="enscript-keyword">if</span> ( err != noErr )
			{
				<span class="enscript-keyword">if</span> ( err != dskFulErr )
					<span class="enscript-keyword">return</span>( err );

				err = DeleteExtents( vcb, srcData.hfsFile.fileID, 0, 0, isHFSPlus );
				ReturnIfError( err );					<span class="enscript-comment">//	we are doomed. Just QUIT!
</span>
				<span class="enscript-keyword">goto</span> <span class="enscript-reference">FlushAndReturn</span>;
			}
		}
		<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> ( numDestExtentBlocks )	<span class="enscript-comment">//	just the destination file has extents
</span>		{
			err = MoveExtents( vcb, destData.hfsFile.fileID, srcData.hfsFile.fileID, 0, 0, isHFSPlus );
			<span class="enscript-keyword">if</span> ( err != noErr )
			{
				<span class="enscript-keyword">if</span> ( err != dskFulErr )
					<span class="enscript-keyword">return</span>( err );

				err = DeleteExtents( vcb, destData.hfsFile.fileID, 0, 0, isHFSPlus );
				ReturnIfError( err );					<span class="enscript-comment">//	we are doomed. Just QUIT!
</span>
				<span class="enscript-keyword">goto</span> <span class="enscript-reference">FlushAndReturn</span>;
			}
		}

		<span class="enscript-comment">//--	Step 3: Change the data in the catalog nodes
</span>		
		<span class="enscript-comment">//--	find the source cnode and put dest info in it
</span>		err = LocateCatalogNodeByKey( vcb, srcHint, &amp;srcKey, &amp;srcData, &amp;srcHint );
		<span class="enscript-keyword">if</span> ( err != noErr )
			<span class="enscript-keyword">return</span>( cmBadNews );
		
		BlockMoveData( &amp;srcData, &amp;swapData, <span class="enscript-keyword">sizeof</span>(CatalogRecord) );
		<span class="enscript-comment">//€€	Asm source copies from the saved dest catalog node
</span>		CopyCatalogNodeInfo( &amp;destData, &amp;srcData );
		
		err = ReplaceBTreeRecord( vcb-&gt;catalogRefNum, &amp;srcKey, srcHint, &amp;srcData, <span class="enscript-keyword">sizeof</span>(HFSCatalogFile), &amp;srcHint );
		ReturnIfError( err );

		
		<span class="enscript-comment">//	find the destination cnode and put source info in it		
</span>		err = LocateCatalogNodeByKey( vcb, destHint, &amp;destKey, &amp;destData, &amp;destHint );
		<span class="enscript-keyword">if</span> ( err != noErr )
			<span class="enscript-keyword">return</span>( cmBadNews );
			
		CopyCatalogNodeInfo( &amp;swapData, &amp;destData );
		err = ReplaceBTreeRecord( vcb-&gt;catalogRefNum, &amp;destKey, destHint, &amp;destData, <span class="enscript-keyword">sizeof</span>(HFSCatalogFile), &amp;destHint );
		ReturnIfError( err );
	}
#<span class="enscript-reference">endif</span>

	err = noErr;

	<span class="enscript-comment">//--	Step 4: Error Handling section
</span>

<span class="enscript-reference">FlushAndReturn</span>:
	err = FlushCatalog( vcb );   			<span class="enscript-comment">//	flush the catalog
</span>	err = FlushExtentFile( vcb );			<span class="enscript-comment">//	flush the extent file (unneeded for common case, but it's cheap)			
</span>	<span class="enscript-keyword">return</span>( err );
}


#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_HFS_STD</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span>  <span class="enscript-function-name">CopyCatalogNodeInfo</span>( CatalogRecord *src, CatalogRecord *dest )
{
	dest-&gt;hfsFile.dataLogicalSize	= src-&gt;hfsFile.dataLogicalSize;
	dest-&gt;hfsFile.dataPhysicalSize = src-&gt;hfsFile.dataPhysicalSize;
	dest-&gt;hfsFile.rsrcLogicalSize	= src-&gt;hfsFile.rsrcLogicalSize;
	dest-&gt;hfsFile.rsrcPhysicalSize = src-&gt;hfsFile.rsrcPhysicalSize;
	dest-&gt;hfsFile.modifyDate = src-&gt;hfsFile.modifyDate;
	BlockMoveData( src-&gt;hfsFile.dataExtents, dest-&gt;hfsFile.dataExtents, <span class="enscript-keyword">sizeof</span>(HFSExtentRecord) );
	BlockMoveData( src-&gt;hfsFile.rsrcExtents, dest-&gt;hfsFile.rsrcExtents, <span class="enscript-keyword">sizeof</span>(HFSExtentRecord) );
}
#<span class="enscript-reference">endif</span>

<span class="enscript-type">static</span> <span class="enscript-type">void</span>  <span class="enscript-function-name">CopyBigCatalogNodeInfo</span>( CatalogRecord *src, CatalogRecord *dest )
{
	BlockMoveData( &amp;src-&gt;hfsPlusFile.dataFork, &amp;dest-&gt;hfsPlusFile.dataFork, <span class="enscript-keyword">sizeof</span>(HFSPlusForkData) );
	BlockMoveData( &amp;src-&gt;hfsPlusFile.resourceFork, &amp;dest-&gt;hfsPlusFile.resourceFork, <span class="enscript-keyword">sizeof</span>(HFSPlusForkData) );
	dest-&gt;hfsPlusFile.contentModDate = src-&gt;hfsPlusFile.contentModDate;
}


<span class="enscript-type">static</span> OSErr  <span class="enscript-function-name">MoveExtents</span>( ExtendedVCB *vcb, u_int32_t srcFileID, u_int32_t destFileID, <span class="enscript-type">int</span> quitEarly, u_int8_t forkType, Boolean isHFSPlus )
{
	FCB *				fcb;
	ExtentsRecBuffer	extentsBuffer[kNumExtentsToCache];
	ExtentKey *			extentKeyPtr;
	ExtentRecord		extentData;
	<span class="enscript-type">struct</span> BTreeIterator *btIterator = NULL;
	<span class="enscript-type">struct</span> BTreeIterator *tmpIterator = NULL;
	FSBufferDescriptor	btRecord;
	u_int16_t			btKeySize;
	u_int16_t			btRecordSize;
	int16_t				i, j;
	OSErr				err;
	
	MALLOC (btIterator, <span class="enscript-type">struct</span> BTreeIterator*, <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">struct</span> BTreeIterator), M_TEMP, M_WAITOK);
	<span class="enscript-keyword">if</span> (btIterator == NULL) {
		<span class="enscript-keyword">return</span> memFullErr;  <span class="enscript-comment">// translates to ENOMEM
</span>	}


	MALLOC (tmpIterator, <span class="enscript-type">struct</span> BTreeIterator*, <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">struct</span> BTreeIterator), M_TEMP, M_WAITOK);
	<span class="enscript-keyword">if</span> (tmpIterator == NULL) {	
		FREE (btIterator, M_TEMP);	
		<span class="enscript-keyword">return</span> memFullErr;  <span class="enscript-comment">// translates to ENOMEM
</span>	}

	bzero(btIterator, <span class="enscript-keyword">sizeof</span>(*btIterator));
	bzero (tmpIterator, <span class="enscript-keyword">sizeof</span>(*tmpIterator));


	fcb = GetFileControlBlock(vcb-&gt;extentsRefNum);
	
	(<span class="enscript-type">void</span>) BTInvalidateHint(btIterator);
	extentKeyPtr = (ExtentKey*) &amp;btIterator-&gt;key;
	btRecord.bufferAddress = &amp;extentData;
	btRecord.itemCount = 1;

	<span class="enscript-comment">//--	Collect the extent records
</span>
	<span class="enscript-comment">//
</span>	<span class="enscript-comment">//	A search on the following key will cause the BTree to be positioned immediately
</span>	<span class="enscript-comment">//	before the first extent record for file #srcFileID, but not actually positioned
</span>	<span class="enscript-comment">//	on any record.  This is because there cannot be an extent record with FABN = 0
</span>	<span class="enscript-comment">//	(the first extent of the fork, which would be in the catalog entry, not an extent
</span>	<span class="enscript-comment">//	record).
</span>	<span class="enscript-comment">//
</span>	<span class="enscript-comment">//	Using BTIterateRecord with kBTreeNextRecord will then get that first extent record.
</span>	<span class="enscript-comment">//
</span>	<span class="enscript-keyword">if</span> (isHFSPlus) {
		btRecord.itemSize = <span class="enscript-keyword">sizeof</span>(HFSPlusExtentRecord);
		btKeySize = <span class="enscript-keyword">sizeof</span>(HFSPlusExtentKey);

		extentKeyPtr-&gt;hfsPlus.keyLength	 = kHFSPlusExtentKeyMaximumLength;
		extentKeyPtr-&gt;hfsPlus.forkType	 = forkType;
		extentKeyPtr-&gt;hfsPlus.pad		 = 0;
		extentKeyPtr-&gt;hfsPlus.fileID	 = srcFileID;
		extentKeyPtr-&gt;hfsPlus.startBlock = 0;
	}
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_HFS_STD</span>
	<span class="enscript-keyword">else</span> {
		btRecord.itemSize = <span class="enscript-keyword">sizeof</span>(HFSExtentRecord);
		btKeySize = <span class="enscript-keyword">sizeof</span>(HFSExtentKey);

		extentKeyPtr-&gt;hfs.keyLength	 = kHFSExtentKeyMaximumLength;
		extentKeyPtr-&gt;hfs.forkType	 = 0;
		extentKeyPtr-&gt;hfs.fileID	 = srcFileID;
		extentKeyPtr-&gt;hfs.startBlock = 0;
	}
#<span class="enscript-reference">else</span>
    <span class="enscript-keyword">else</span> {
        <span class="enscript-keyword">return</span> cmBadNews;
    }
#<span class="enscript-reference">endif</span>
	
	<span class="enscript-comment">//
</span>	<span class="enscript-comment">//	We do an initial BTSearchRecord to position the BTree's iterator just before any extent
</span>	<span class="enscript-comment">//	records for srcFileID.  We then do a few BTIterateRecord and BTInsertRecord of those found
</span>	<span class="enscript-comment">//	records, but with destFileID as the file number in the key.  Keep doing this sequence of
</span>	<span class="enscript-comment">//	BTIterateRecord and BTInsertRecord until we find an extent for another file, or there are
</span>	<span class="enscript-comment">//	no more extent records in the tree.
</span>	<span class="enscript-comment">//
</span>	<span class="enscript-comment">//	Basically, we're copying records kNumExtentsToCache at a time.  The copies have their file ID
</span>	<span class="enscript-comment">//	set to destFileID.
</span>	<span class="enscript-comment">//
</span>	<span class="enscript-comment">//	This depends on BTInsertRecord not effecting the iterator used by BTIterateRecord.  If it
</span>	<span class="enscript-comment">//	_did_ effect the iterator, then we would need to do a BTSearchRecord before each series
</span>	<span class="enscript-comment">//	of BTIterateRecord.  We'd need to set up the key for BTSearchRecord to find the last record
</span>	<span class="enscript-comment">//	we found, so that BTIterateRecord would get the next one (the first we haven't processed).
</span>	<span class="enscript-comment">//
</span>
	err = BTSearchRecord(fcb, btIterator, &amp;btRecord, &amp;btRecordSize, btIterator);
	
	<span class="enscript-comment">//	We expect a btNotFound here, since there shouldn't be an extent record with FABN = 0.
</span>	<span class="enscript-keyword">if</span> (err != btNotFound)
	{
		<span class="enscript-keyword">if</span> ( DEBUG_BUILD )
			DebugStr(<span class="enscript-string">&quot;Unexpected error from SearchBTreeRecord&quot;</span>);
		
		<span class="enscript-keyword">if</span> (err == noErr)			<span class="enscript-comment">//	If we found such a bogus extent record, then the tree is really messed up
</span>			err = cmBadNews;		<span class="enscript-comment">//	so return an error that conveys the disk is hosed.
</span>		
		FREE (tmpIterator, M_TEMP);	
		FREE (btIterator, M_TEMP);
		<span class="enscript-keyword">return</span> err;
	}

	<span class="enscript-keyword">do</span>
	{
		btRecord.bufferAddress = &amp;extentData;
		btRecord.itemCount = 1;

		<span class="enscript-keyword">for</span> ( i=0 ; i&lt;kNumExtentsToCache ; i++ )
		{
			HFSCatalogNodeID	foundFileID = 0;
			
			err = BTIterateRecord(fcb, kBTreeNextRecord, btIterator, &amp;btRecord, &amp;btRecordSize);
			<span class="enscript-keyword">if</span> ( err == btNotFound )		<span class="enscript-comment">//	Did we run out of extent records in the extents tree?
</span>				<span class="enscript-keyword">break</span>;						<span class="enscript-comment">//	if xkrFNum(A0) is cleared on this error, then this test is bogus!
</span>			<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> ( err != noErr ) {
				FREE (btIterator, M_TEMP);
				FREE (tmpIterator, M_TEMP);
				<span class="enscript-keyword">return</span>( err );				<span class="enscript-comment">//	must be ioError
</span>			}
            <span class="enscript-keyword">if</span> (isHFSPlus) {
                foundFileID = extentKeyPtr-&gt;hfsPlus.fileID;
            }
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_HFS_STD</span>
            <span class="enscript-keyword">else</span> {
                foundFileID = extentKeyPtr-&gt;hfs.fileID;
            }
#<span class="enscript-reference">endif</span>
			<span class="enscript-keyword">if</span> ( foundFileID == srcFileID ) {
				<span class="enscript-comment">/* Check if we need to quit early. */</span>
				<span class="enscript-keyword">if</span> (quitEarly &amp;&amp; isHFSPlus) {
					<span class="enscript-keyword">if</span> (extentKeyPtr-&gt;hfsPlus.forkType != forkType) {
						<span class="enscript-keyword">break</span>;
					}
				}
				CopyExtentInfo(extentKeyPtr, &amp;extentData, extentsBuffer, i);
			}
			<span class="enscript-keyword">else</span>{
				<span class="enscript-comment">/* The fileID's are of a different file.  We're done here. */</span>
				<span class="enscript-keyword">break</span>;
			}
		}
		
		
		
		<span class="enscript-comment">//--	edit each extent key, and reinsert each extent record in the extent file
</span>		<span class="enscript-keyword">if</span> (isHFSPlus)
			btRecordSize = <span class="enscript-keyword">sizeof</span>(HFSPlusExtentRecord);
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_HFS_STD</span>
		<span class="enscript-keyword">else</span>
			btRecordSize = <span class="enscript-keyword">sizeof</span>(HFSExtentRecord);
#<span class="enscript-reference">endif</span>
        
		<span class="enscript-keyword">for</span> ( j=0 ; j&lt;i ; j++ )
		{

			<span class="enscript-keyword">if</span> (isHFSPlus)
				extentsBuffer[j].extentKey.hfsPlus.fileID = destFileID;	<span class="enscript-comment">//	change only the id in the key to dest ID
</span>#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_HFS_STD</span>
			<span class="enscript-keyword">else</span>
				extentsBuffer[j].extentKey.hfs.fileID = destFileID;	<span class="enscript-comment">//	change only the id in the key to dest ID
</span>#<span class="enscript-reference">endif</span>
            
			<span class="enscript-comment">// get iterator and buffer descriptor ready...
</span>			(<span class="enscript-type">void</span>) BTInvalidateHint(tmpIterator);
			BlockMoveData(&amp;(extentsBuffer[j].extentKey), &amp;tmpIterator-&gt;key, btKeySize);
			btRecord.bufferAddress = &amp;(extentsBuffer[j].extentData);

			err = BTInsertRecord(fcb, tmpIterator, &amp;btRecord, btRecordSize);
			<span class="enscript-keyword">if</span> ( err != noErr ) {								
				<span class="enscript-comment">/* Parse the error and free iterators */</span>
				FREE (btIterator, M_TEMP);
				FREE (tmpIterator, M_TEMP);
				<span class="enscript-keyword">if</span> ( err == btExists )
				{
					<span class="enscript-keyword">if</span> ( DEBUG_BUILD ) {
						DebugStr(<span class="enscript-string">&quot;Can't insert record -- already exists&quot;</span>); 
					}
					<span class="enscript-keyword">return</span>( cmBadNews );
				}
				<span class="enscript-keyword">else</span> {
					<span class="enscript-keyword">return</span>( err );
				}			
			}
		}

		<span class="enscript-comment">//--	okay, done with this buffered batch, go get the next set of extent records
</span>		<span class="enscript-comment">//	If our buffer is not full, we must be done, or recieved an error
</span>		
		<span class="enscript-keyword">if</span> ( i != kNumExtentsToCache )			<span class="enscript-comment">//	if the buffer is not full, we must be done
</span>		{
			err = DeleteExtents( vcb, srcFileID, quitEarly, forkType, isHFSPlus );	<span class="enscript-comment">//	Now delete all the extent entries with the sourceID
</span>			<span class="enscript-keyword">if</span> ( DEBUG_BUILD &amp;&amp; err != noErr )
				DebugStr(<span class="enscript-string">&quot;Error from DeleteExtents&quot;</span>);
			<span class="enscript-keyword">break</span>;									<span class="enscript-comment">//	we're done!
</span>		}
	} <span class="enscript-keyword">while</span> ( true );
	
	FREE (tmpIterator, M_TEMP);
	FREE (btIterator, M_TEMP);

	<span class="enscript-keyword">return</span>( err );
}


<span class="enscript-type">static</span> <span class="enscript-type">void</span>  <span class="enscript-function-name">CopyExtentInfo</span>( ExtentKey *key, ExtentRecord *data, ExtentsRecBuffer *buffer, u_int16_t bufferCount )
{
	BlockMoveData( key, &amp;(buffer[bufferCount].extentKey), <span class="enscript-keyword">sizeof</span>( ExtentKey ) );
	BlockMoveData( data, &amp;(buffer[bufferCount].extentData), <span class="enscript-keyword">sizeof</span>( ExtentRecord ) );
}


<span class="enscript-comment">//--	Delete all extents in extent file that have the ID given.
</span><span class="enscript-type">static</span> OSErr  <span class="enscript-function-name">DeleteExtents</span>( ExtendedVCB *vcb, u_int32_t fileID, <span class="enscript-type">int</span> quitEarly,  u_int8_t forkType, Boolean isHFSPlus )
{
	FCB *				fcb;
	ExtentKey *			extentKeyPtr;
	ExtentRecord		extentData;
	<span class="enscript-type">struct</span> BTreeIterator *btIterator = NULL;
	<span class="enscript-type">struct</span> BTreeIterator *tmpIterator = NULL;
	FSBufferDescriptor	btRecord;
	u_int16_t			btRecordSize;
	OSErr				err;

	MALLOC (btIterator, <span class="enscript-type">struct</span> BTreeIterator*, <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">struct</span> BTreeIterator),
			M_TEMP, M_WAITOK | M_ZERO);

	MALLOC (tmpIterator, <span class="enscript-type">struct</span> BTreeIterator*, <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">struct</span> BTreeIterator),
			M_TEMP, M_WAITOK | M_ZERO);

	fcb = GetFileControlBlock(vcb-&gt;extentsRefNum);

	(<span class="enscript-type">void</span>) BTInvalidateHint(btIterator);
	extentKeyPtr = (ExtentKey*) &amp;btIterator-&gt;key;
	btRecord.bufferAddress = &amp;extentData;
	btRecord.itemCount = 1;

	<span class="enscript-comment">//	The algorithm is to position the BTree just before any extent records for fileID.
</span>	<span class="enscript-comment">//	Then just keep getting successive records.  If the record is still for fileID,
</span>	<span class="enscript-comment">//	then delete it.
</span>	
	<span class="enscript-keyword">if</span> (isHFSPlus) {
		btRecord.itemSize = <span class="enscript-keyword">sizeof</span>(HFSPlusExtentRecord);

		extentKeyPtr-&gt;hfsPlus.keyLength	 = kHFSPlusExtentKeyMaximumLength;
		extentKeyPtr-&gt;hfsPlus.forkType	 = forkType;
		extentKeyPtr-&gt;hfsPlus.pad		 = 0;
		extentKeyPtr-&gt;hfsPlus.fileID	 = fileID;
		extentKeyPtr-&gt;hfsPlus.startBlock = 0;
	}
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_HFS_STD</span>
	<span class="enscript-keyword">else</span> {
		btRecord.itemSize = <span class="enscript-keyword">sizeof</span>(HFSExtentRecord);

		extentKeyPtr-&gt;hfs.keyLength	 = kHFSExtentKeyMaximumLength;
		extentKeyPtr-&gt;hfs.forkType	 = forkType;
		extentKeyPtr-&gt;hfs.fileID	 = fileID;
		extentKeyPtr-&gt;hfs.startBlock = 0;
	}
#<span class="enscript-reference">else</span> 
	<span class="enscript-keyword">else</span> {
		err = cmBadNews;
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">exit</span>;
	}
#<span class="enscript-reference">endif</span>

	err = BTSearchRecord(fcb, btIterator, &amp;btRecord, &amp;btRecordSize, btIterator);
	<span class="enscript-keyword">if</span> ( err != btNotFound )
	{
		<span class="enscript-keyword">if</span> (err == noErr) {		<span class="enscript-comment">//	Did we find a bogus extent record?
</span>			err = cmBadNews;	<span class="enscript-comment">//	Yes, so indicate things are messed up.
</span>		}

		<span class="enscript-keyword">goto</span> <span class="enscript-reference">exit</span>;
	}

	<span class="enscript-keyword">do</span>
	{
		HFSCatalogNodeID	foundFileID = 0;

		err = BTIterateRecord(fcb, kBTreeNextRecord, btIterator, &amp;btRecord, &amp;btRecordSize);
		<span class="enscript-keyword">if</span> ( err != noErr )
		{
			<span class="enscript-keyword">if</span> (err == btNotFound)	<span class="enscript-comment">//	If we hit the end of the BTree
</span>				err = noErr;		<span class="enscript-comment">//		then it's OK
</span>				
			<span class="enscript-keyword">break</span>;					<span class="enscript-comment">//	We're done now.
</span>		}
        <span class="enscript-keyword">if</span> (isHFSPlus) {
            foundFileID = extentKeyPtr-&gt;hfsPlus.fileID;
        }
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_HFS_STD</span>
        <span class="enscript-keyword">else</span> {
            foundFileID = extentKeyPtr-&gt;hfs.fileID;
        }
#<span class="enscript-reference">endif</span>
        
		<span class="enscript-keyword">if</span> ( foundFileID != fileID ) {
			<span class="enscript-keyword">break</span>;					<span class="enscript-comment">//	numbers don't match, we must be done
</span>		}
		<span class="enscript-keyword">if</span> (quitEarly &amp;&amp; isHFSPlus) {
			<span class="enscript-comment">/* If we're only deleting one type of fork, then quit early if it doesn't match */</span>
			<span class="enscript-keyword">if</span> (extentKeyPtr-&gt;hfsPlus.forkType != forkType) {
				<span class="enscript-keyword">break</span>;
			}
		}
		
		*tmpIterator = *btIterator;
		err = BTDeleteRecord( fcb, tmpIterator );
		<span class="enscript-keyword">if</span> (err != noErr)
			<span class="enscript-keyword">break</span>;
	}	<span class="enscript-keyword">while</span> ( true );

<span class="enscript-reference">exit</span>:
	
	FREE (tmpIterator, M_TEMP);
	FREE (btIterator, M_TEMP);

	<span class="enscript-keyword">return</span>( err );
}


<span class="enscript-comment">//	Check if there are extents represented in the extents overflow file.
</span><span class="enscript-type">static</span> u_int32_t  <span class="enscript-function-name">CheckExtents</span>( <span class="enscript-type">void</span> *extents, u_int32_t totalBlocks, Boolean isHFSPlus )
{
	u_int32_t		extentAllocationBlocks;
	u_int16_t		i;


	<span class="enscript-keyword">if</span> ( totalBlocks == 0 )
		<span class="enscript-keyword">return</span>( 0 );
		
	extentAllocationBlocks = 0;
	
	<span class="enscript-keyword">if</span> ( isHFSPlus )
	{
		<span class="enscript-keyword">for</span> ( i = 0 ; i &lt; kHFSPlusExtentDensity ; i++ )
		{
			extentAllocationBlocks += ((HFSPlusExtentDescriptor *)extents)[i].blockCount;
			<span class="enscript-keyword">if</span> ( extentAllocationBlocks &gt;= totalBlocks )		<span class="enscript-comment">//	greater than or equal (extents can add past eof if 'Close&quot; crashes w/o truncating new clump)
</span>				<span class="enscript-keyword">return</span>( 0 );
		}
	}
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_HFS_STD</span>
	<span class="enscript-keyword">else</span>
	{
		<span class="enscript-keyword">for</span> ( i = 0 ; i &lt; kHFSExtentDensity ; i++ )
		{
			extentAllocationBlocks += ((HFSExtentDescriptor *)extents)[i].blockCount;
			<span class="enscript-keyword">if</span> ( extentAllocationBlocks &gt;= totalBlocks )		<span class="enscript-comment">//	greater than or equal (extents can add past eof if 'Close&quot; crashes w/o truncating new clump)
</span>				<span class="enscript-keyword">return</span>( 0 );
		}
	}
#<span class="enscript-reference">endif</span>
	
	<span class="enscript-keyword">return</span>( extentAllocationBlocks );
}
</pre>
<hr />
</body></html>