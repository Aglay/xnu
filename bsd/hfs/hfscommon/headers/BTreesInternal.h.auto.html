<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>BTreesInternal.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">BTreesInternal.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000-2014 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*
	File:		BTreesInternal.h

	Contains:	IPI to File Manager B-tree

	Version:	HFS Plus 1.0

	Copyright:	© 1996-1998 by Apple Computer, Inc., all rights reserved.

	File Ownership:

		DRI:				Don Brady

		Other Contact:		Mark Day

		Technology:			File Systems

	Writers:

		(msd)	Mark Day
		(DSH)	Deric Horn
		(djb)	Don Brady

	Change History (most recent first):
	
	  &lt;RHAP&gt;	 9/22/99	ser		Added prototypes for BTGetLastSync and BTSetLastSync
	  &lt;RHAP&gt;	 6/22/98	djb		Add ERR_BASE to btree error codes to make them negative (for MacOS X only).

	   &lt;CS7&gt;	 7/28/97	msd		Add enum for fsBTTimeOutErr.
	   &lt;CS6&gt;	 7/25/97	DSH		Added heuristicHint as parameter to BTSearchRecord.
	   &lt;CS5&gt;	 7/24/97	djb		Add blockReadFromDisk flag to BlockDescriptor. Callbacks now use
									a file refNum instead of an FCB.
	   &lt;CS4&gt;	 7/16/97	DSH		FilesInternal.i renamed FileMgrInternal.i to avoid name
									collision
	   &lt;CS3&gt;	  6/2/97	DSH		Added SetEndOfForkProc() prototype, so Attributes.c can call it
									directly.
	   &lt;CS2&gt;	 5/19/97	djb		kMaxKeyLength is now 520.
	   &lt;CS1&gt;	 4/28/97	djb		first checked in

	  &lt;HFS6&gt;	 3/17/97	DSH		Remove Key Comparison prototype, already in FilesInternal.h.
	  &lt;HFS5&gt;	 2/19/97	djb		Add SetBlockSizeProcPtr. Add blockSize field to BlockDescriptor.
									Remove E_ type error enums.
	  &lt;HFS4&gt;	 1/27/97	djb		Include Types.h and FilesInternal.h.
	  &lt;HFS3&gt;	 1/13/97	djb		Added kBTreeCurrentRecord for BTIterateRecord.
	  &lt;HFS2&gt;	  1/3/97	djb		Added support for large keys.
	  &lt;HFS1&gt;	12/19/96	djb		first checked in

*/</span>

#<span class="enscript-reference">ifndef</span>	<span class="enscript-variable-name">__BTREESINTERNAL__</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">__BTREESINTERNAL__</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/appleapiopts.h&gt;</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">__APPLE_API_PRIVATE</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">__FILEMGRINTERNAL__</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;FileMgrInternal.h&quot;</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-type">enum</span> {
	fsBTInvalidHeaderErr			= btBadHdr,
	fsBTBadRotateErr				= dsBadRotate,
	fsBTInvalidNodeErr				= btBadNode,
	fsBTRecordTooLargeErr			= btNoFit,
	fsBTRecordNotFoundErr			= btNotFound,
	fsBTDuplicateRecordErr			= btExists,
	fsBTFullErr						= btNoSpaceAvail,

	fsBTInvalidFileErr				= ERR_BASE + 0x0302,	<span class="enscript-comment">/* no BTreeCB has been allocated for fork*/</span>
	fsBTrFileAlreadyOpenErr			= ERR_BASE + 0x0303,
	fsBTInvalidIteratorErr			= ERR_BASE + 0x0308,
	fsBTEmptyErr					= ERR_BASE + 0x030A,
	fsBTNoMoreMapNodesErr			= ERR_BASE + 0x030B,
	fsBTBadNodeSize					= ERR_BASE + 0x030C,
	fsBTBadNodeType					= ERR_BASE + 0x030D,
	fsBTInvalidKeyLengthErr			= ERR_BASE + 0x030E,
	fsBTStartOfIterationErr			= ERR_BASE + 0x0353,
	fsBTEndOfIterationErr			= ERR_BASE + 0x0354,
	fsBTUnknownVersionErr			= ERR_BASE + 0x0355,
	fsBTTreeTooDeepErr				= ERR_BASE + 0x0357,
	fsIteratorExitedScopeErr		= ERR_BASE + 0x0A02,	<span class="enscript-comment">/* iterator exited the scope*/</span>
	fsIteratorScopeExceptionErr		= ERR_BASE + 0x0A03,	<span class="enscript-comment">/* iterator is undefined due to error or movement of scope locality*/</span>
	fsUnknownIteratorMovementErr	= ERR_BASE + 0x0A04,	<span class="enscript-comment">/* iterator movement is not defined*/</span>
	fsInvalidIterationMovmentErr	= ERR_BASE + 0x0A05,	<span class="enscript-comment">/* iterator movement is invalid in current context*/</span>
	fsClientIDMismatchErr			= ERR_BASE + 0x0A06,	<span class="enscript-comment">/* wrong client process ID*/</span>
	fsEndOfIterationErr				= ERR_BASE + 0x0A07,	<span class="enscript-comment">/* there were no objects left to return on iteration*/</span>
	fsBTTimeOutErr					= ERR_BASE + 0x0A08		<span class="enscript-comment">/* BTree scan interrupted -- no time left for physical I/O */</span>
};

<span class="enscript-type">struct</span> BlockDescriptor{
	<span class="enscript-type">void</span>		*buffer;
	<span class="enscript-type">void</span>		*blockHeader;
	daddr64_t	 blockNum;	<span class="enscript-comment">/* logical block number (used by hfs_swap_BTNode) */</span>
	ByteCount	 blockSize;
	Boolean		 blockReadFromDisk;
	Byte         isModified;             <span class="enscript-comment">// XXXdbg - for journaling
</span>	Byte		 reserved[2];
};
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> BlockDescriptor BlockDescriptor;
<span class="enscript-type">typedef</span> BlockDescriptor *BlockDescPtr;


<span class="enscript-type">struct</span> FSBufferDescriptor {
	<span class="enscript-type">void</span> *		bufferAddress;
	ByteCount	itemSize;
	ItemCount	itemCount;
};
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> FSBufferDescriptor FSBufferDescriptor;

<span class="enscript-type">typedef</span> FSBufferDescriptor *FSBufferDescriptorPtr;


<span class="enscript-comment">/*
	Fork Level Access Method Block get options
*/</span>
<span class="enscript-type">enum</span> {
		kGetBlock			= 0x00000000,
		kGetBlockHint		= 0x00000001,	<span class="enscript-comment">// if set, the block is being looked up using hint
</span>		kForceReadBlock		= 0x00000002,	<span class="enscript-comment">//€€ how does this relate to Read/Verify? Do we need this?
</span>		kGetEmptyBlock		= 0x00000008
};
<span class="enscript-type">typedef</span> u_int32_t	GetBlockOptions;

<span class="enscript-comment">/*
	Fork Level Access Method Block release options
*/</span>
<span class="enscript-type">enum</span> {
		kReleaseBlock		= 0x00000000,
		kForceWriteBlock	= 0x00000001,
		kMarkBlockDirty		= 0x00000002,
		kTrashBlock			= 0x00000004,
		kLockTransaction    = 0x00000100
};
<span class="enscript-type">typedef</span> u_int32_t	ReleaseBlockOptions;

<span class="enscript-type">typedef</span>	u_int64_t	FSSize;
<span class="enscript-type">typedef</span>	u_int32_t	ForkBlockNumber;

<span class="enscript-comment">/*============================================================================
	Fork Level Buffered I/O Access Method
============================================================================*/</span>

<span class="enscript-type">typedef</span>	OSStatus	(* GetBlockProcPtr)		(FileReference				 fileRefNum,
											 u_int32_t					 blockNum,
											 GetBlockOptions			 options,
											 BlockDescriptor			*block );
							 

<span class="enscript-type">typedef</span>	OSStatus	(* ReleaseBlockProcPtr)	(FileReference				 fileRefNum,
											 BlockDescPtr				 blockPtr,
											 ReleaseBlockOptions		 options );

<span class="enscript-type">typedef</span>	OSStatus	(* SetEndOfForkProcPtr)	(FileReference				 fileRefNum,
											 FSSize						 minEOF,
											 FSSize						 maxEOF );
								 
<span class="enscript-type">typedef</span>	OSStatus	(* SetBlockSizeProcPtr)	(FileReference				 fileRefNum,
											 ByteCount					 blockSize,
											 ItemCount					 minBlockCount );

OSStatus		SetEndOfForkProc ( FileReference fileRefNum, FSSize minEOF, FSSize maxEOF );


<span class="enscript-comment">/*
	B*Tree Information Version
*/</span>

<span class="enscript-type">enum</span> BTreeInformationVersion{
	kBTreeInfoVersion	= 0
};

<span class="enscript-comment">/*
	B*Tree Iteration Operation Constants
*/</span>

<span class="enscript-type">enum</span> BTreeIterationOperations{
	kBTreeFirstRecord,
	kBTreeNextRecord,
	kBTreePrevRecord,
	kBTreeLastRecord,
	kBTreeCurrentRecord
};
<span class="enscript-type">typedef</span> u_int16_t BTreeIterationOperation;


<span class="enscript-comment">/*
	Btree types: 0 is HFS CAT/EXT file, 1~127 are AppleShare B*Tree files, 128~254 unused
	hfsBtreeType	EQU		0			; control file
	validBTType		EQU		$80			; user btree type starts from 128
	userBT1Type		EQU		$FF			; 255 is our Btree type. Used by BTInit and BTPatch
*/</span>

<span class="enscript-type">enum</span> BTreeTypes{
	kHFSBTreeType			=   0,		<span class="enscript-comment">// control file
</span>	kUserBTreeType			= 128,		<span class="enscript-comment">// user btree type starts from 128
</span>	kReservedBTreeType		= 255		<span class="enscript-comment">//
</span>};

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">kBTreeHeaderUserBytes</span>	128


<span class="enscript-type">typedef</span> BTreeKey *BTreeKeyPtr;


<span class="enscript-comment">/*
	BTreeInfoRec Structure - for BTGetInformation
*/</span>
<span class="enscript-type">struct</span> BTreeInfoRec{
	u_int16_t			version;
	u_int16_t			nodeSize;
	u_int16_t			maxKeyLength;
	u_int16_t			treeDepth;
	u_int32_t			lastfsync;		<span class="enscript-comment">/* Last time that this was fsynced  */</span>
	ItemCount			numRecords;
	ItemCount			numNodes;
	ItemCount			numFreeNodes;
	u_int8_t			keyCompareType;
	u_int8_t			reserved[3];
};
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> BTreeInfoRec BTreeInfoRec;
<span class="enscript-type">typedef</span> BTreeInfoRec *BTreeInfoPtr;

<span class="enscript-comment">/*
	BTreeHint can never be exported to the outside. Use u_int32_t BTreeHint[4],
	u_int8_t BTreeHint[16], etc.
 */</span>
<span class="enscript-type">struct</span> BTreeHint{
	ItemCount				writeCount;
	u_int32_t				nodeNum;			<span class="enscript-comment">// node the key was last seen in
</span>	u_int16_t				index;				<span class="enscript-comment">// index then key was last seen at
</span>	u_int16_t				reserved1;
	u_int32_t				reserved2;
};
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> BTreeHint BTreeHint;
<span class="enscript-type">typedef</span> BTreeHint *BTreeHintPtr;

<span class="enscript-comment">/*
	BTree Iterator
*/</span>
<span class="enscript-type">struct</span> BTreeIterator{
	BTreeHint				hint;
	u_int16_t				version;
	u_int16_t				reserved;
	u_int32_t				hitCount;			<span class="enscript-comment">// Total number of leaf records hit
</span>	u_int32_t				maxLeafRecs;		<span class="enscript-comment">// Max leaf records over iteration
</span>	BTreeKey				key;
};
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> BTreeIterator BTreeIterator;
<span class="enscript-type">typedef</span> BTreeIterator *BTreeIteratorPtr;


<span class="enscript-comment">/*============================================================================
	B*Tree SPI
============================================================================*/</span>

<span class="enscript-comment">/*
	Key Comparison Function ProcPtr Type - for BTOpenPath
*/</span>
<span class="enscript-comment">//typedef int32_t 				(* KeyCompareProcPtr)(BTreeKeyPtr a, BTreeKeyPtr b);
</span>

<span class="enscript-type">typedef</span> <span class="enscript-function-name">int32_t</span> (* IterateCallBackProcPtr)(BTreeKeyPtr key, <span class="enscript-type">void</span> * record, <span class="enscript-type">void</span> * state);


<span class="enscript-type">extern</span> OSStatus	BTOpenPath(FCB *filePtr, KeyCompareProcPtr keyCompareProc);

<span class="enscript-type">extern</span> OSStatus	BTClosePath			(FCB		 				*filePtr );


<span class="enscript-type">extern</span> OSStatus	BTSearchRecord		(FCB		 				*filePtr,
									 BTreeIterator				*searchIterator,
									 FSBufferDescriptor			*btRecord,
									 u_int16_t					*recordLen,
									 BTreeIterator				*resultIterator );

<span class="enscript-type">extern</span> OSStatus	BTIterateRecord		(FCB		 				*filePtr,
									 BTreeIterationOperation	 operation,
									 BTreeIterator				*iterator,
									 FSBufferDescriptor			*btRecord,
									 u_int16_t					*recordLen );


<span class="enscript-type">extern</span> OSStatus <span class="enscript-function-name">BTIterateRecords</span>(FCB *filePtr, BTreeIterationOperation operation, BTreeIterator *iterator,
		 IterateCallBackProcPtr	 callBackProc, <span class="enscript-type">void</span> * callBackState);

<span class="enscript-type">extern</span> OSStatus	BTInsertRecord		(FCB		 				*filePtr,
									 BTreeIterator				*iterator,
									 FSBufferDescriptor			*btrecord,
									 u_int16_t					 recordLen );

<span class="enscript-type">extern</span> OSStatus	BTReplaceRecord		(FCB		 				*filePtr,
									 BTreeIterator				*iterator,
									 FSBufferDescriptor			*btRecord,
									 u_int16_t					 recordLen );

<span class="enscript-type">extern</span> OSStatus	BTUpdateRecord		(FCB		 				*filePtr,
									 BTreeIterator				*iterator,
									 IterateCallBackProcPtr		 callBackProc,
									 <span class="enscript-type">void</span>						*callBackState );

<span class="enscript-type">extern</span> OSStatus	BTDeleteRecord		(FCB		 				*filePtr,
									 BTreeIterator				*iterator );

<span class="enscript-type">extern</span> OSStatus	BTGetInformation	(FCB		 				*filePtr,
									 u_int16_t					 vers,
									 BTreeInfoRec				*info );

<span class="enscript-type">extern</span> OSStatus <span class="enscript-function-name">BTIsDirty</span>(FCB *filePtr);

<span class="enscript-type">extern</span> OSStatus	BTFlushPath			(FCB		 				*filePtr );

<span class="enscript-type">extern</span> OSStatus <span class="enscript-function-name">BTReloadData</span>		(FCB *filePtr);

<span class="enscript-type">extern</span> OSStatus	BTInvalidateHint	(BTreeIterator				*iterator );

<span class="enscript-type">extern</span> OSStatus	BTGetLastSync		(FCB		 				*filePtr,
									 u_int32_t					*lastfsync );

<span class="enscript-type">extern</span> OSStatus	BTSetLastSync		(FCB		 				*filePtr,
									 u_int32_t					lastfsync );

<span class="enscript-type">extern</span> OSStatus	BTHasContiguousNodes(FCB		 				*filePtr);

<span class="enscript-type">extern</span> OSStatus <span class="enscript-function-name">BTGetUserData</span>(FCB *filePtr, <span class="enscript-type">void</span> * dataPtr, <span class="enscript-type">int</span> dataSize);

<span class="enscript-type">extern</span> OSStatus <span class="enscript-function-name">BTSetUserData</span>(FCB *filePtr, <span class="enscript-type">void</span> * dataPtr, <span class="enscript-type">int</span> dataSize);

<span class="enscript-comment">/* B-tree node reserve routines. */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">BTReserveSetup</span>(<span class="enscript-type">void</span>);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span>  <span class="enscript-function-name">BTReserveSpace</span>(FCB *file, <span class="enscript-type">int</span> operations, <span class="enscript-type">void</span> * data);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span>  <span class="enscript-function-name">BTReleaseReserve</span>(FCB *file, <span class="enscript-type">void</span> * data);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span>  <span class="enscript-function-name">BTZeroUnusedNodes</span>(FCB *file);

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* __APPLE_API_PRIVATE */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL */</span>
#<span class="enscript-reference">endif</span> // <span class="enscript-variable-name">__BTREESINTERNAL__</span>
</pre>
<hr />
</body></html>