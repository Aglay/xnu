<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>policy_check.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">policy_check.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/param.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/systm.h&gt;</span>		<span class="enscript-comment">/* XXX printf() */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/fcntl.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/file.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/kauth.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/mount.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/msg.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/proc.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/socketvar.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/vnode.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;security/mac.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;security/mac_policy.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/OSDebug.h&gt;</span>	<span class="enscript-comment">/* OSBPrintBacktrace */</span>


<span class="enscript-comment">/* forward declaration; see bsd_init.c */</span>
errno_t <span class="enscript-function-name">check_policy_init</span>(<span class="enscript-type">int</span>);
<span class="enscript-type">int</span> <span class="enscript-function-name">get_thread_lock_count</span>(thread_t th);         <span class="enscript-comment">/* forced forward */</span>

<span class="enscript-comment">/*
 * Policy flags used when the policy is enabled
 *
 * Note:	CHECK_POLICY_CHECK is probably not very useful unless you
 *		are kernel debugging and set a breakpoint.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CHECK_POLICY_CHECK</span>	0x00000001	<span class="enscript-comment">/* Check on calls */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CHECK_POLICY_FAIL</span>	0x00000002	<span class="enscript-comment">/* EPERM on fails */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CHECK_POLICY_BACKTRACE</span>	0x00000004	<span class="enscript-comment">/* Show call stack on fails */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CHECK_POLICY_PANIC</span>	0x00000008	<span class="enscript-comment">/* Panic on fails */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CHECK_POLICY_PERIODIC</span>	0x00000010	<span class="enscript-comment">/* Show fails periodically */</span>

<span class="enscript-type">static</span> <span class="enscript-type">int</span> policy_flags = 0;


#<span class="enscript-reference">define</span> <span class="enscript-function-name">CHECK_SET_HOOK</span>(x)	.mpo_##x = (mpo_##x##_t *)common_hook,

<span class="enscript-comment">/*
 * Init; currently, we only print our arrival notice.
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">hook_policy_init</span>(<span class="enscript-type">struct</span> mac_policy_conf *mpc)
{
	printf(<span class="enscript-string">&quot;Policy '%s' = '%s' ready\n&quot;</span>, mpc-&gt;mpc_name, mpc-&gt;mpc_fullname);
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">hook_policy_initbsd</span>(<span class="enscript-type">struct</span> mac_policy_conf *mpc)
{
	<span class="enscript-comment">/* called with policy_grab_exclusive mutex held; exempt */</span>
	printf(<span class="enscript-string">&quot;hook_policy_initbsd: %s\n&quot;</span>, mpc-&gt;mpc_name);
}


<span class="enscript-comment">/* Implementation */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CLASS_PERIOD_LIMIT</span>	10000
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CLASS_PERIOD_MULT</span>	20

<span class="enscript-type">static</span> <span class="enscript-type">int</span> policy_check_event = 1;
<span class="enscript-type">static</span> <span class="enscript-type">int</span> policy_check_period = 1;
<span class="enscript-type">static</span> <span class="enscript-type">int</span> policy_check_next = CLASS_PERIOD_MULT;


<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">common_hook</span>(<span class="enscript-type">void</span>)
{
	<span class="enscript-type">int</span>	i;
	<span class="enscript-type">int</span>	rv = 0;

	<span class="enscript-keyword">if</span> ((i = get_thread_lock_count(current_thread())) != 0) {
		<span class="enscript-comment">/*
		 * fail the MACF check if we hold a lock; this assumes a
		 * a non-void (authorization) MACF hook.
		 */</span>
		<span class="enscript-keyword">if</span> (policy_flags &amp; CHECK_POLICY_FAIL)
			rv = EPERM;

		<span class="enscript-comment">/*
		 * display a backtrace if we hold a lock and we are not
		 * going to panic
		 */</span>
		<span class="enscript-keyword">if</span> ((policy_flags &amp; (CHECK_POLICY_BACKTRACE | CHECK_POLICY_PANIC)) == CHECK_POLICY_BACKTRACE) {
			<span class="enscript-keyword">if</span> (policy_flags &amp; CHECK_POLICY_PERIODIC) {
			    <span class="enscript-comment">/* at exponentially increasing intervals */</span>
			    <span class="enscript-keyword">if</span> (!(policy_check_event % policy_check_period)) {
				<span class="enscript-keyword">if</span> (policy_check_event &lt;= policy_check_next || policy_check_period == CLASS_PERIOD_LIMIT) {
					<span class="enscript-comment">/*
					 * According to Derek, we could
					 * technically get a symbolicated name
					 * here, if we refactered some code
					 * and set the &quot;keepsyms=1&quot; boot
					 * argument...
					 */</span>
					OSReportWithBacktrace(<span class="enscript-string">&quot;calling MACF hook with mutex count %d (event %d) &quot;</span>, i, policy_check_event);
				}
			    } <span class="enscript-keyword">else</span> {
				<span class="enscript-keyword">if</span> (policy_check_period &lt; CLASS_PERIOD_LIMIT) {
					policy_check_next *= CLASS_PERIOD_MULT;
					policy_check_period *= CLASS_PERIOD_MULT;
				}
			    }
			} <span class="enscript-keyword">else</span> {
				<span class="enscript-comment">/* always */</span>
				OSReportWithBacktrace(<span class="enscript-string">&quot;calling MACF hook with mutex count %d (event %d) &quot;</span>, i, policy_check_event);
			}
		}

		<span class="enscript-comment">/* Panic */</span>
		<span class="enscript-keyword">if</span> (policy_flags &amp; CHECK_POLICY_PANIC)
			panic(<span class="enscript-string">&quot;calling MACF hook with mutex count %d\n&quot;</span>, i);

		<span class="enscript-comment">/* count for non-fatal tracing */</span>
		policy_check_event++;
	}

	<span class="enscript-keyword">return</span> rv;
}

#<span class="enscript-reference">if</span> (<span class="enscript-variable-name">MAC_POLICY_OPS_VERSION</span> != 37)
# <span class="enscript-reference">error</span> <span class="enscript-string">&quot;struct mac_policy_ops doesn't match definition in mac_policy.h&quot;</span>
#<span class="enscript-reference">endif</span>
<span class="enscript-comment">/*
 * Policy hooks; one per possible hook
 *
 * Please note that this struct initialization should be kept in sync with
 * security/mac_policy.h (mac_policy_ops struct definition).
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">struct</span> mac_policy_ops policy_ops = {
	CHECK_SET_HOOK(audit_check_postselect)
	CHECK_SET_HOOK(audit_check_preselect)

	CHECK_SET_HOOK(bpfdesc_label_associate)
	CHECK_SET_HOOK(bpfdesc_label_destroy)
	CHECK_SET_HOOK(bpfdesc_label_init)
	CHECK_SET_HOOK(bpfdesc_check_receive)

	CHECK_SET_HOOK(cred_check_label_update_execve)
	CHECK_SET_HOOK(cred_check_label_update)
	CHECK_SET_HOOK(cred_check_visible)
	CHECK_SET_HOOK(cred_label_associate_fork)
	CHECK_SET_HOOK(cred_label_associate_kernel)
	CHECK_SET_HOOK(cred_label_associate)
	CHECK_SET_HOOK(cred_label_associate_user)
	CHECK_SET_HOOK(cred_label_destroy)
	CHECK_SET_HOOK(cred_label_externalize_audit)
	CHECK_SET_HOOK(cred_label_externalize)
	CHECK_SET_HOOK(cred_label_init)
	CHECK_SET_HOOK(cred_label_internalize)
	CHECK_SET_HOOK(cred_label_update_execve)
	CHECK_SET_HOOK(cred_label_update)

	CHECK_SET_HOOK(devfs_label_associate_device)
	CHECK_SET_HOOK(devfs_label_associate_directory)
	CHECK_SET_HOOK(devfs_label_copy)
	CHECK_SET_HOOK(devfs_label_destroy)
	CHECK_SET_HOOK(devfs_label_init)
	CHECK_SET_HOOK(devfs_label_update)

	CHECK_SET_HOOK(file_check_change_offset)
	CHECK_SET_HOOK(file_check_create)
	CHECK_SET_HOOK(file_check_dup)
	CHECK_SET_HOOK(file_check_fcntl)
	CHECK_SET_HOOK(file_check_get_offset)
	CHECK_SET_HOOK(file_check_get)
	CHECK_SET_HOOK(file_check_inherit)
	CHECK_SET_HOOK(file_check_ioctl)
	CHECK_SET_HOOK(file_check_lock)
	CHECK_SET_HOOK(file_check_mmap_downgrade)
	CHECK_SET_HOOK(file_check_mmap)
	CHECK_SET_HOOK(file_check_receive)
	CHECK_SET_HOOK(file_check_set)
	CHECK_SET_HOOK(file_label_init)
	CHECK_SET_HOOK(file_label_destroy)
	CHECK_SET_HOOK(file_label_associate)

	CHECK_SET_HOOK(ifnet_check_label_update)
	CHECK_SET_HOOK(ifnet_check_transmit)
	CHECK_SET_HOOK(ifnet_label_associate)
	CHECK_SET_HOOK(ifnet_label_copy)
	CHECK_SET_HOOK(ifnet_label_destroy)
	CHECK_SET_HOOK(ifnet_label_externalize)
	CHECK_SET_HOOK(ifnet_label_init)
	CHECK_SET_HOOK(ifnet_label_internalize)
	CHECK_SET_HOOK(ifnet_label_update)
	CHECK_SET_HOOK(ifnet_label_recycle)

	CHECK_SET_HOOK(inpcb_check_deliver)
	CHECK_SET_HOOK(inpcb_label_associate)
	CHECK_SET_HOOK(inpcb_label_destroy)
	CHECK_SET_HOOK(inpcb_label_init)
	CHECK_SET_HOOK(inpcb_label_recycle)
	CHECK_SET_HOOK(inpcb_label_update)

	CHECK_SET_HOOK(iokit_check_device)

	CHECK_SET_HOOK(ipq_label_associate)
	CHECK_SET_HOOK(ipq_label_compare)
	CHECK_SET_HOOK(ipq_label_destroy)
	CHECK_SET_HOOK(ipq_label_init)
	CHECK_SET_HOOK(ipq_label_update)

	.mpo_reserved1 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved2 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved3 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved4 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved5 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved6 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved7 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved8 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved9 = (mpo_reserved_hook_t *)common_hook,

	CHECK_SET_HOOK(mbuf_label_associate_bpfdesc)
	CHECK_SET_HOOK(mbuf_label_associate_ifnet)
	CHECK_SET_HOOK(mbuf_label_associate_inpcb)
	CHECK_SET_HOOK(mbuf_label_associate_ipq)
	CHECK_SET_HOOK(mbuf_label_associate_linklayer)
	CHECK_SET_HOOK(mbuf_label_associate_multicast_encap)
	CHECK_SET_HOOK(mbuf_label_associate_netlayer)
	CHECK_SET_HOOK(mbuf_label_associate_socket)
	CHECK_SET_HOOK(mbuf_label_copy)
	CHECK_SET_HOOK(mbuf_label_destroy)
	CHECK_SET_HOOK(mbuf_label_init)

	CHECK_SET_HOOK(mount_check_fsctl)
	CHECK_SET_HOOK(mount_check_getattr)
	CHECK_SET_HOOK(mount_check_label_update)
	CHECK_SET_HOOK(mount_check_mount)
	CHECK_SET_HOOK(mount_check_remount)
	CHECK_SET_HOOK(mount_check_setattr)
	CHECK_SET_HOOK(mount_check_stat)
	CHECK_SET_HOOK(mount_check_umount)
	CHECK_SET_HOOK(mount_label_associate)
	CHECK_SET_HOOK(mount_label_destroy)
	CHECK_SET_HOOK(mount_label_externalize)
	CHECK_SET_HOOK(mount_label_init)
	CHECK_SET_HOOK(mount_label_internalize)

	CHECK_SET_HOOK(netinet_fragment)
	CHECK_SET_HOOK(netinet_icmp_reply)
	CHECK_SET_HOOK(netinet_tcp_reply)

	CHECK_SET_HOOK(pipe_check_ioctl)
	CHECK_SET_HOOK(pipe_check_kqfilter)
	CHECK_SET_HOOK(pipe_check_label_update)
	CHECK_SET_HOOK(pipe_check_read)
	CHECK_SET_HOOK(pipe_check_select)
	CHECK_SET_HOOK(pipe_check_stat)
	CHECK_SET_HOOK(pipe_check_write)
	CHECK_SET_HOOK(pipe_label_associate)
	CHECK_SET_HOOK(pipe_label_copy)
	CHECK_SET_HOOK(pipe_label_destroy)
	CHECK_SET_HOOK(pipe_label_externalize)
	CHECK_SET_HOOK(pipe_label_init)
	CHECK_SET_HOOK(pipe_label_internalize)
	CHECK_SET_HOOK(pipe_label_update)

	CHECK_SET_HOOK(policy_destroy)
	<span class="enscript-comment">/* special hooks for policy init's */</span>
	.mpo_policy_init = hook_policy_init,
	.mpo_policy_initbsd = hook_policy_initbsd,
	CHECK_SET_HOOK(policy_syscall)

	CHECK_SET_HOOK(system_check_sysctlbyname)
	CHECK_SET_HOOK(proc_check_inherit_ipc_ports)
	CHECK_SET_HOOK(vnode_check_rename)
	CHECK_SET_HOOK(kext_check_query)
	CHECK_SET_HOOK(iokit_check_nvram_get)
	CHECK_SET_HOOK(iokit_check_nvram_set)
	CHECK_SET_HOOK(iokit_check_nvram_delete)
	CHECK_SET_HOOK(proc_check_expose_task)
	CHECK_SET_HOOK(proc_check_set_host_special_port)
	CHECK_SET_HOOK(proc_check_set_host_exception_port)
	.mpo_reserved11 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved12 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved13 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved14 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved15 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved16 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved17 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved18 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved19 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved20 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved21 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved22 = (mpo_reserved_hook_t *)common_hook,

	CHECK_SET_HOOK(posixsem_check_create)
	CHECK_SET_HOOK(posixsem_check_open)
	CHECK_SET_HOOK(posixsem_check_post)
	CHECK_SET_HOOK(posixsem_check_unlink)
	CHECK_SET_HOOK(posixsem_check_wait)
	CHECK_SET_HOOK(posixsem_label_associate)
	CHECK_SET_HOOK(posixsem_label_destroy)
	CHECK_SET_HOOK(posixsem_label_init)
	CHECK_SET_HOOK(posixshm_check_create)
	CHECK_SET_HOOK(posixshm_check_mmap)
	CHECK_SET_HOOK(posixshm_check_open)
	CHECK_SET_HOOK(posixshm_check_stat)
	CHECK_SET_HOOK(posixshm_check_truncate)
	CHECK_SET_HOOK(posixshm_check_unlink)
	CHECK_SET_HOOK(posixshm_label_associate)
	CHECK_SET_HOOK(posixshm_label_destroy)
	CHECK_SET_HOOK(posixshm_label_init)

	CHECK_SET_HOOK(proc_check_debug)
	CHECK_SET_HOOK(proc_check_fork)
	CHECK_SET_HOOK(proc_check_get_task_name)
	CHECK_SET_HOOK(proc_check_get_task)
	CHECK_SET_HOOK(proc_check_getaudit)
	CHECK_SET_HOOK(proc_check_getauid)
	CHECK_SET_HOOK(proc_check_getlcid)
	CHECK_SET_HOOK(proc_check_mprotect)
	CHECK_SET_HOOK(proc_check_sched)
	CHECK_SET_HOOK(proc_check_setaudit)
	CHECK_SET_HOOK(proc_check_setauid)
	CHECK_SET_HOOK(proc_check_setlcid)
	CHECK_SET_HOOK(proc_check_signal)
	CHECK_SET_HOOK(proc_check_wait)
	CHECK_SET_HOOK(proc_label_destroy)
	CHECK_SET_HOOK(proc_label_init)

	CHECK_SET_HOOK(socket_check_accept)
	CHECK_SET_HOOK(socket_check_accepted)
	CHECK_SET_HOOK(socket_check_bind)
	CHECK_SET_HOOK(socket_check_connect)
	CHECK_SET_HOOK(socket_check_create)
	CHECK_SET_HOOK(socket_check_deliver)
	CHECK_SET_HOOK(socket_check_kqfilter)
	CHECK_SET_HOOK(socket_check_label_update)
	CHECK_SET_HOOK(socket_check_listen)
	CHECK_SET_HOOK(socket_check_receive)
	CHECK_SET_HOOK(socket_check_received)
	CHECK_SET_HOOK(socket_check_select)
	CHECK_SET_HOOK(socket_check_send)
	CHECK_SET_HOOK(socket_check_stat)
	CHECK_SET_HOOK(socket_check_setsockopt)
	CHECK_SET_HOOK(socket_check_getsockopt)
	CHECK_SET_HOOK(socket_label_associate_accept)
	CHECK_SET_HOOK(socket_label_associate)
	CHECK_SET_HOOK(socket_label_copy)
	CHECK_SET_HOOK(socket_label_destroy)
	CHECK_SET_HOOK(socket_label_externalize)
	CHECK_SET_HOOK(socket_label_init)
	CHECK_SET_HOOK(socket_label_internalize)
	CHECK_SET_HOOK(socket_label_update)

	CHECK_SET_HOOK(socketpeer_label_associate_mbuf)
	CHECK_SET_HOOK(socketpeer_label_associate_socket)
	CHECK_SET_HOOK(socketpeer_label_destroy)
	CHECK_SET_HOOK(socketpeer_label_externalize)
	CHECK_SET_HOOK(socketpeer_label_init)

	CHECK_SET_HOOK(system_check_acct)
	CHECK_SET_HOOK(system_check_audit)
	CHECK_SET_HOOK(system_check_auditctl)
	CHECK_SET_HOOK(system_check_auditon)
	CHECK_SET_HOOK(system_check_host_priv)
	CHECK_SET_HOOK(system_check_nfsd)
	CHECK_SET_HOOK(system_check_reboot)
	CHECK_SET_HOOK(system_check_settime)
	CHECK_SET_HOOK(system_check_swapoff)
	CHECK_SET_HOOK(system_check_swapon)
	.mpo_reserved31 = (mpo_reserved_hook_t *)common_hook,

	CHECK_SET_HOOK(sysvmsg_label_associate)
	CHECK_SET_HOOK(sysvmsg_label_destroy)
	CHECK_SET_HOOK(sysvmsg_label_init)
	CHECK_SET_HOOK(sysvmsg_label_recycle)
	CHECK_SET_HOOK(sysvmsq_check_enqueue)
	CHECK_SET_HOOK(sysvmsq_check_msgrcv)
	CHECK_SET_HOOK(sysvmsq_check_msgrmid)
	CHECK_SET_HOOK(sysvmsq_check_msqctl)
	CHECK_SET_HOOK(sysvmsq_check_msqget)
	CHECK_SET_HOOK(sysvmsq_check_msqrcv)
	CHECK_SET_HOOK(sysvmsq_check_msqsnd)
	CHECK_SET_HOOK(sysvmsq_label_associate)
	CHECK_SET_HOOK(sysvmsq_label_destroy)
	CHECK_SET_HOOK(sysvmsq_label_init)
	CHECK_SET_HOOK(sysvmsq_label_recycle)
	CHECK_SET_HOOK(sysvsem_check_semctl)
	CHECK_SET_HOOK(sysvsem_check_semget)
	CHECK_SET_HOOK(sysvsem_check_semop)
	CHECK_SET_HOOK(sysvsem_label_associate)
	CHECK_SET_HOOK(sysvsem_label_destroy)
	CHECK_SET_HOOK(sysvsem_label_init)
	CHECK_SET_HOOK(sysvsem_label_recycle)
	CHECK_SET_HOOK(sysvshm_check_shmat)
	CHECK_SET_HOOK(sysvshm_check_shmctl)
	CHECK_SET_HOOK(sysvshm_check_shmdt)
	CHECK_SET_HOOK(sysvshm_check_shmget)
	CHECK_SET_HOOK(sysvshm_label_associate)
	CHECK_SET_HOOK(sysvshm_label_destroy)
	CHECK_SET_HOOK(sysvshm_label_init)
	CHECK_SET_HOOK(sysvshm_label_recycle)

	.mpo_reserved23 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved24 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved25 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved26 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved27 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved28 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved29 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved30 = (mpo_reserved_hook_t *)common_hook,

	CHECK_SET_HOOK(iokit_check_hid_control)

	CHECK_SET_HOOK(vnode_check_access)
	CHECK_SET_HOOK(vnode_check_chdir)
	CHECK_SET_HOOK(vnode_check_chroot)
	CHECK_SET_HOOK(vnode_check_create)
	CHECK_SET_HOOK(vnode_check_deleteextattr)
	CHECK_SET_HOOK(vnode_check_exchangedata)
	CHECK_SET_HOOK(vnode_check_exec)
	CHECK_SET_HOOK(vnode_check_getattrlist)
	CHECK_SET_HOOK(vnode_check_getextattr)
	CHECK_SET_HOOK(vnode_check_ioctl)
	CHECK_SET_HOOK(vnode_check_kqfilter)
	CHECK_SET_HOOK(vnode_check_label_update)
	CHECK_SET_HOOK(vnode_check_link)
	CHECK_SET_HOOK(vnode_check_listextattr)
	CHECK_SET_HOOK(vnode_check_lookup)
	CHECK_SET_HOOK(vnode_check_open)
	CHECK_SET_HOOK(vnode_check_read)
	CHECK_SET_HOOK(vnode_check_readdir)
	CHECK_SET_HOOK(vnode_check_readlink)
	CHECK_SET_HOOK(vnode_check_rename_from)
	CHECK_SET_HOOK(vnode_check_rename_to)
	CHECK_SET_HOOK(vnode_check_revoke)
	CHECK_SET_HOOK(vnode_check_select)
	CHECK_SET_HOOK(vnode_check_setattrlist)
	CHECK_SET_HOOK(vnode_check_setextattr)
	CHECK_SET_HOOK(vnode_check_setflags)
	CHECK_SET_HOOK(vnode_check_setmode)
	CHECK_SET_HOOK(vnode_check_setowner)
	CHECK_SET_HOOK(vnode_check_setutimes)
	CHECK_SET_HOOK(vnode_check_stat)
	CHECK_SET_HOOK(vnode_check_truncate)
	CHECK_SET_HOOK(vnode_check_unlink)
	CHECK_SET_HOOK(vnode_check_write)
	CHECK_SET_HOOK(vnode_label_associate_devfs)
	CHECK_SET_HOOK(vnode_label_associate_extattr)
	CHECK_SET_HOOK(vnode_label_associate_file)
	CHECK_SET_HOOK(vnode_label_associate_pipe)
	CHECK_SET_HOOK(vnode_label_associate_posixsem)
	CHECK_SET_HOOK(vnode_label_associate_posixshm)
	CHECK_SET_HOOK(vnode_label_associate_singlelabel)
	CHECK_SET_HOOK(vnode_label_associate_socket)
	CHECK_SET_HOOK(vnode_label_copy)
	CHECK_SET_HOOK(vnode_label_destroy)
	CHECK_SET_HOOK(vnode_label_externalize_audit)
	CHECK_SET_HOOK(vnode_label_externalize)
	CHECK_SET_HOOK(vnode_label_init)
	CHECK_SET_HOOK(vnode_label_internalize)
	CHECK_SET_HOOK(vnode_label_recycle)
	CHECK_SET_HOOK(vnode_label_store)
	CHECK_SET_HOOK(vnode_label_update_extattr)
	CHECK_SET_HOOK(vnode_label_update)
	CHECK_SET_HOOK(vnode_notify_create)
	CHECK_SET_HOOK(vnode_check_signature)
	CHECK_SET_HOOK(vnode_check_uipc_bind)
	CHECK_SET_HOOK(vnode_check_uipc_connect)

	CHECK_SET_HOOK(proc_check_run_cs_invalid)
	CHECK_SET_HOOK(proc_check_suspend_resume)

	CHECK_SET_HOOK(thread_userret)

	CHECK_SET_HOOK(iokit_check_set_properties)

	CHECK_SET_HOOK(system_check_chud)

	CHECK_SET_HOOK(vnode_check_searchfs)

	CHECK_SET_HOOK(priv_check)
	CHECK_SET_HOOK(priv_grant)

	CHECK_SET_HOOK(proc_check_map_anon)

	CHECK_SET_HOOK(vnode_check_fsgetpath)

	CHECK_SET_HOOK(iokit_check_open)

	CHECK_SET_HOOK(proc_check_ledger)

	CHECK_SET_HOOK(vnode_notify_rename)

	.mpo_reserved32 = (mpo_reserved_hook_t *)common_hook,
	.mpo_reserved33 = (mpo_reserved_hook_t *)common_hook,

	CHECK_SET_HOOK(system_check_kas_info)

	CHECK_SET_HOOK(proc_check_cpumon)

	CHECK_SET_HOOK(vnode_notify_open)

	CHECK_SET_HOOK(system_check_info)

	CHECK_SET_HOOK(pty_notify_grant)
	CHECK_SET_HOOK(pty_notify_close)

	CHECK_SET_HOOK(vnode_find_sigs)


	CHECK_SET_HOOK(kext_check_load)
	CHECK_SET_HOOK(kext_check_unload)

	CHECK_SET_HOOK(proc_check_proc_info)

	CHECK_SET_HOOK(vnode_notify_link)

	CHECK_SET_HOOK(iokit_check_filter_properties)
	CHECK_SET_HOOK(iokit_check_get_property)
};

<span class="enscript-comment">/*
 * Policy definition
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">struct</span> mac_policy_conf policy_conf = {
	.mpc_name               = <span class="enscript-string">&quot;CHECK&quot;</span>,
	.mpc_fullname           = <span class="enscript-string">&quot;Check Assumptions Policy&quot;</span>,
	.mpc_field_off          = NULL,		<span class="enscript-comment">/* no label slot */</span>
	.mpc_labelnames         = NULL,		<span class="enscript-comment">/* no policy label names */</span>
	.mpc_labelname_count    = 0,		<span class="enscript-comment">/* count of label names is 0 */</span>
	.mpc_ops                = &amp;policy_ops,	<span class="enscript-comment">/* policy operations */</span>
	.mpc_loadtime_flags     = 0,
	.mpc_runtime_flags      = 0,
};

<span class="enscript-type">static</span> mac_policy_handle_t policy_handle;

<span class="enscript-comment">/*
 * Init routine; for a loadable policy, this would be called during the KEXT
 * initialization; we're going to call this from bsd_init() if the boot
 * argument for checking is present.
 */</span>
errno_t
<span class="enscript-function-name">check_policy_init</span>(<span class="enscript-type">int</span> flags)
{
	<span class="enscript-comment">/* Only instantiate the module if we have been asked to do checking */</span>
	<span class="enscript-keyword">if</span> (!flags)
		<span class="enscript-keyword">return</span> 0;

	policy_flags = flags;

	<span class="enscript-keyword">return</span> mac_policy_register(&amp;policy_conf, &amp;policy_handle, NULL);
}
</pre>
<hr />
</body></html>