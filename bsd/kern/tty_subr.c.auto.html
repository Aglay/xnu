<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>tty_subr.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">tty_subr.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000-2006 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/* Copyright (c) 1997 Apple Computer, Inc. All Rights Reserved */</span>
<span class="enscript-comment">/*
 * Copyright (c) 1993, 1994 Theo de Raadt
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice unmodified, this list of conditions, and the following
 *    disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 */</span>

<span class="enscript-comment">/*
 * We use the NetBSD based clist system, it is much more efficient than the
 * old style clist stuff used by free bsd.
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/param.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/systm.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/ioctl.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/tty.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/malloc.h&gt;</span>


<span class="enscript-comment">/*
 * At compile time, choose:
 * There are two ways the TTY_QUOTE bit can be stored. If QBITS is
 * defined we allocate an array of bits -- 1/8th as much memory but
 * setbit(), clrbit(), and isset() take more cpu. If QBITS is
 * undefined, we just use an array of bytes.
 * 
 * If TTY_QUOTE functionality isn't required by a line discipline,
 * it can free c_cq and set it to NULL. This speeds things up,
 * and also does not use any extra memory. This is useful for (say)
 * a SLIP line discipline that wants a 32K ring buffer for data
 * but doesn't need quoting.
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">QBITS</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">QBITS</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">QMEM</span>(n)		((((n)-1)/NBBY)+1)
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">QMEM</span>(n)		(n)
#<span class="enscript-reference">endif</span>


<span class="enscript-comment">/*
 * Initialize clists.
 */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">cinit</span>(<span class="enscript-type">void</span>)
{
}

<span class="enscript-comment">/*
 * Initialize a particular clist. Ok, they are really ring buffers,
 * of the specified length, with/without quoting support.
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">clalloc</span>(<span class="enscript-type">struct</span> clist *clp, <span class="enscript-type">int</span> size, <span class="enscript-type">int</span> quot)
{
	MALLOC_ZONE(clp-&gt;c_cs, u_char *, size, M_TTYS, M_WAITOK);
	<span class="enscript-keyword">if</span> (!clp-&gt;c_cs)
		<span class="enscript-keyword">return</span> (-1);
	bzero(clp-&gt;c_cs, size);

	<span class="enscript-keyword">if</span>(quot) {
		MALLOC_ZONE(clp-&gt;c_cq, u_char *, QMEM(size), M_TTYS, M_WAITOK);
		<span class="enscript-keyword">if</span> (!clp-&gt;c_cq) {
			FREE_ZONE(clp-&gt;c_cs, size, M_TTYS);
			<span class="enscript-keyword">return</span> (-1);
		}
		bzero(clp-&gt;c_cs, QMEM(size));
	} <span class="enscript-keyword">else</span>
		clp-&gt;c_cq = (u_char *)0;

	clp-&gt;c_cf = clp-&gt;c_cl = (u_char *)0;
	clp-&gt;c_ce = clp-&gt;c_cs + size;
	clp-&gt;c_cn = size;
	clp-&gt;c_cc = 0;
	<span class="enscript-keyword">return</span> (0);
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">clfree</span>(<span class="enscript-type">struct</span> clist *clp)
{
	<span class="enscript-keyword">if</span>(clp-&gt;c_cs)
		FREE_ZONE(clp-&gt;c_cs, clp-&gt;c_cn, M_TTYS);
	<span class="enscript-keyword">if</span>(clp-&gt;c_cq)
		FREE_ZONE(clp-&gt;c_cq, QMEM(clp-&gt;c_cn), M_TTYS);
	clp-&gt;c_cs = clp-&gt;c_cq = (u_char *)0;
}


<span class="enscript-comment">/*
 * Get a character from a clist.
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">getc</span>(<span class="enscript-type">struct</span> clist *clp)
{
	<span class="enscript-type">int</span> c = -1;

	<span class="enscript-keyword">if</span> (clp-&gt;c_cc == 0)
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">out</span>;

	c = *clp-&gt;c_cf &amp; 0xff;
	<span class="enscript-keyword">if</span> (clp-&gt;c_cq) {
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">QBITS</span>
		<span class="enscript-keyword">if</span> (isset(clp-&gt;c_cq, clp-&gt;c_cf - clp-&gt;c_cs) )
			c |= TTY_QUOTE;
#<span class="enscript-reference">else</span>
		<span class="enscript-keyword">if</span> (*(clp-&gt;c_cf - clp-&gt;c_cs + clp-&gt;c_cq))
			c |= TTY_QUOTE;
#<span class="enscript-reference">endif</span>
	}
	<span class="enscript-keyword">if</span> (++clp-&gt;c_cf == clp-&gt;c_ce)
		clp-&gt;c_cf = clp-&gt;c_cs;
	<span class="enscript-keyword">if</span> (--clp-&gt;c_cc == 0)
		clp-&gt;c_cf = clp-&gt;c_cl = (u_char *)0;
<span class="enscript-reference">out</span>:
	<span class="enscript-keyword">return</span> c;
}

<span class="enscript-comment">/*
 * Copy clist to buffer.
 * Return number of bytes moved.
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">q_to_b</span>(<span class="enscript-type">struct</span> clist *clp, u_char *cp, <span class="enscript-type">int</span> count)
{
	<span class="enscript-type">int</span> cc;
	u_char *p = cp;

	<span class="enscript-comment">/* optimize this while loop */</span>
	<span class="enscript-keyword">while</span> (count &gt; 0 &amp;&amp; clp-&gt;c_cc &gt; 0) {
		cc = clp-&gt;c_cl - clp-&gt;c_cf;
		<span class="enscript-keyword">if</span> (clp-&gt;c_cf &gt;= clp-&gt;c_cl)
			cc = clp-&gt;c_ce - clp-&gt;c_cf;
		<span class="enscript-keyword">if</span> (cc &gt; count)
			cc = count;
		bcopy(clp-&gt;c_cf, p, cc);
		count -= cc;
		p += cc;
		clp-&gt;c_cc -= cc;
		clp-&gt;c_cf += cc;
		<span class="enscript-keyword">if</span> (clp-&gt;c_cf == clp-&gt;c_ce)
			clp-&gt;c_cf = clp-&gt;c_cs;
	}
	<span class="enscript-keyword">if</span> (clp-&gt;c_cc == 0)
		clp-&gt;c_cf = clp-&gt;c_cl = (u_char *)0;
	<span class="enscript-keyword">return</span> p - cp;
}

<span class="enscript-comment">/*
 * Return count of contiguous characters in clist.
 * Stop counting if flag&amp;character is non-null.
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">ndqb</span>(<span class="enscript-type">struct</span> clist *clp, <span class="enscript-type">int</span> flag)
{
	<span class="enscript-type">int</span> count = 0;
	<span class="enscript-type">register</span> <span class="enscript-type">int</span> i;
	<span class="enscript-type">register</span> <span class="enscript-type">int</span> cc;

	<span class="enscript-keyword">if</span> ((cc = clp-&gt;c_cc) == 0)
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">out</span>;

	<span class="enscript-keyword">if</span> (flag == 0) {
		count = clp-&gt;c_cl - clp-&gt;c_cf;
		<span class="enscript-keyword">if</span> (count &lt;= 0)
			count = clp-&gt;c_ce - clp-&gt;c_cf;
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">out</span>;
	}

	i = clp-&gt;c_cf - clp-&gt;c_cs;
	<span class="enscript-keyword">if</span> (flag &amp; TTY_QUOTE) {
		<span class="enscript-keyword">while</span> (cc-- &gt; 0 &amp;&amp; !(clp-&gt;c_cs[i++] &amp; (flag &amp; ~TTY_QUOTE) ||
		    isset(clp-&gt;c_cq, i))) {
			count++;
			<span class="enscript-keyword">if</span> (i == clp-&gt;c_cn)
				<span class="enscript-keyword">break</span>;
		}
	} <span class="enscript-keyword">else</span> {
		<span class="enscript-keyword">while</span> (cc-- &gt; 0 &amp;&amp; !(clp-&gt;c_cs[i++] &amp; flag)) {
			count++;
			<span class="enscript-keyword">if</span> (i == clp-&gt;c_cn)
				<span class="enscript-keyword">break</span>;
		}
	}
<span class="enscript-reference">out</span>:
	<span class="enscript-keyword">return</span> count;
}

<span class="enscript-comment">/*
 * Flush count bytes from clist.
 */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">ndflush</span>(<span class="enscript-type">struct</span> clist *clp, <span class="enscript-type">int</span> count)
{
	<span class="enscript-type">int</span> cc;

	<span class="enscript-keyword">if</span> (count == clp-&gt;c_cc) {
		clp-&gt;c_cc = 0;
		clp-&gt;c_cf = clp-&gt;c_cl = (u_char *)0;
		<span class="enscript-keyword">return</span>;
	}
	<span class="enscript-comment">/* optimize this while loop */</span>
	<span class="enscript-keyword">while</span> (count &gt; 0 &amp;&amp; clp-&gt;c_cc &gt; 0) {
		cc = clp-&gt;c_cl - clp-&gt;c_cf;
		<span class="enscript-keyword">if</span> (clp-&gt;c_cf &gt;= clp-&gt;c_cl)
			cc = clp-&gt;c_ce - clp-&gt;c_cf;
		<span class="enscript-keyword">if</span> (cc &gt; count)
			cc = count;
		count -= cc;
		clp-&gt;c_cc -= cc;
		clp-&gt;c_cf += cc;
		<span class="enscript-keyword">if</span> (clp-&gt;c_cf == clp-&gt;c_ce)
			clp-&gt;c_cf = clp-&gt;c_cs;
	}
	<span class="enscript-keyword">if</span> (clp-&gt;c_cc == 0)
		clp-&gt;c_cf = clp-&gt;c_cl = (u_char *)0;
}

<span class="enscript-comment">/*
 * Put a character into the output queue.
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">putc</span>(<span class="enscript-type">int</span> c, <span class="enscript-type">struct</span> clist *clp)
{
	<span class="enscript-type">register</span> <span class="enscript-type">int</span> i;

	<span class="enscript-keyword">if</span> (clp-&gt;c_cc == 0) {
		<span class="enscript-keyword">if</span> (!clp-&gt;c_cs) {
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">DIAGNOSTIC</span>
			<span class="enscript-comment">//printf(&quot;putc: required clalloc\n&quot;);
</span>#<span class="enscript-reference">endif</span>
			<span class="enscript-keyword">if</span>(clalloc(clp, 1024, 1)) {
<span class="enscript-reference">out</span>:
				<span class="enscript-keyword">return</span> -1;
			}
		}
		clp-&gt;c_cf = clp-&gt;c_cl = clp-&gt;c_cs;
	}

	<span class="enscript-keyword">if</span> (clp-&gt;c_cc == clp-&gt;c_cn)
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">out</span>;

	*clp-&gt;c_cl = c &amp; 0xff;
	i = clp-&gt;c_cl - clp-&gt;c_cs;
	<span class="enscript-keyword">if</span> (clp-&gt;c_cq) {
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">QBITS</span>
		<span class="enscript-keyword">if</span> (c &amp; TTY_QUOTE)
			setbit(clp-&gt;c_cq, i); 
		<span class="enscript-keyword">else</span>
			clrbit(clp-&gt;c_cq, i);
#<span class="enscript-reference">else</span>
		q = clp-&gt;c_cq + i;
		*q = (c &amp; TTY_QUOTE) ? 1 : 0;
#<span class="enscript-reference">endif</span>
	}
	clp-&gt;c_cc++;
	clp-&gt;c_cl++;
	<span class="enscript-keyword">if</span> (clp-&gt;c_cl == clp-&gt;c_ce)
		clp-&gt;c_cl = clp-&gt;c_cs;
	<span class="enscript-keyword">return</span> 0;
}

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">QBITS</span>
<span class="enscript-comment">/*
 * optimized version of
 *
 * for (i = 0; i &lt; len; i++)
 *	clrbit(cp, off + len);
 */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">clrbits</span>(u_char *cp, <span class="enscript-type">int</span> off, <span class="enscript-type">int</span> len)
{
	<span class="enscript-type">int</span> sby, sbi, eby, ebi;
	<span class="enscript-type">register</span> <span class="enscript-type">int</span> i;
	u_char mask;

	<span class="enscript-keyword">if</span>(len==1) {
		clrbit(cp, off);
		<span class="enscript-keyword">return</span>;
	}

	sby = off / NBBY;
	sbi = off % NBBY;
	eby = (off+len) / NBBY;
	ebi = (off+len) % NBBY;
	<span class="enscript-keyword">if</span> (sby == eby) {
		mask = ((1 &lt;&lt; (ebi - sbi)) - 1) &lt;&lt; sbi;
		cp[sby] &amp;= ~mask;
	} <span class="enscript-keyword">else</span> {
		mask = (1&lt;&lt;sbi) - 1;
		cp[sby++] &amp;= mask;

		mask = (1&lt;&lt;ebi) - 1;
		<span class="enscript-comment">/* handle remainder bits, if any, for a non-0 ebi value */</span>
		<span class="enscript-keyword">if</span> (mask)
			cp[eby] &amp;= ~mask;

		<span class="enscript-keyword">for</span> (i = sby; i &lt; eby; i++)
			cp[i] = 0x00;
	}
}
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">/*
 * Copy buffer to clist.
 * Return number of bytes not transfered.
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">b_to_q</span>(<span class="enscript-type">const</span> u_char *cp, <span class="enscript-type">int</span> count, <span class="enscript-type">struct</span> clist *clp)
{
	<span class="enscript-type">int</span> cc;
	<span class="enscript-type">const</span> u_char *p = cp;

	<span class="enscript-keyword">if</span> (count &lt;= 0)
		<span class="enscript-keyword">return</span> 0;


	<span class="enscript-keyword">if</span> (clp-&gt;c_cc == 0) {
		<span class="enscript-keyword">if</span> (!clp-&gt;c_cs) {
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">DIAGNOSTIC</span>
			printf(<span class="enscript-string">&quot;b_to_q: required clalloc\n&quot;</span>);
#<span class="enscript-reference">endif</span>
			<span class="enscript-keyword">if</span>(clalloc(clp, 1024, 1))
				<span class="enscript-keyword">goto</span> <span class="enscript-reference">out</span>;
		}
		clp-&gt;c_cf = clp-&gt;c_cl = clp-&gt;c_cs;
	}

	<span class="enscript-keyword">if</span> (clp-&gt;c_cc == clp-&gt;c_cn)
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">out</span>;

	<span class="enscript-comment">/* optimize this while loop */</span>
	<span class="enscript-keyword">while</span> (count &gt; 0 &amp;&amp; clp-&gt;c_cc &lt; clp-&gt;c_cn) {
		cc = clp-&gt;c_ce - clp-&gt;c_cl;
		<span class="enscript-keyword">if</span> (clp-&gt;c_cf &gt; clp-&gt;c_cl)
			cc = clp-&gt;c_cf - clp-&gt;c_cl;
		<span class="enscript-keyword">if</span> (cc &gt; count)
			cc = count;
		bcopy(p, clp-&gt;c_cl, cc);
		<span class="enscript-keyword">if</span> (clp-&gt;c_cq) {
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">QBITS</span>
			clrbits(clp-&gt;c_cq, clp-&gt;c_cl - clp-&gt;c_cs, cc);
#<span class="enscript-reference">else</span>
			bzero(clp-&gt;c_cl - clp-&gt;c_cs + clp-&gt;c_cq, cc);
#<span class="enscript-reference">endif</span>
		}
		p += cc;
		count -= cc;
		clp-&gt;c_cc += cc;
		clp-&gt;c_cl += cc;
		<span class="enscript-keyword">if</span> (clp-&gt;c_cl == clp-&gt;c_ce)
			clp-&gt;c_cl = clp-&gt;c_cs;
	}
<span class="enscript-reference">out</span>:
	<span class="enscript-keyword">return</span> count;
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span> cc;

<span class="enscript-comment">/*
 * Given a non-NULL pointer into the clist return the pointer
 * to the next character in the list or return NULL if no more chars.
 *
 * Callers must not allow getc's to happen between firstc's and getc's
 * so that the pointer becomes invalid.  Note that interrupts are NOT
 * masked.
 */</span>
u_char *
<span class="enscript-function-name">nextc</span>(<span class="enscript-type">struct</span> clist *clp, u_char *cp, <span class="enscript-type">int</span> *c)
{
	<span class="enscript-keyword">if</span> (clp-&gt;c_cf == cp) {
		<span class="enscript-comment">/*
		 * First time initialization.
		 */</span>
		cc = clp-&gt;c_cc;
	}
	<span class="enscript-keyword">if</span> (cc == 0 || cp == NULL)
		<span class="enscript-keyword">return</span> NULL;
	<span class="enscript-keyword">if</span> (--cc == 0)
		<span class="enscript-keyword">return</span> NULL;
	<span class="enscript-keyword">if</span> (++cp == clp-&gt;c_ce)
		cp = clp-&gt;c_cs;
	*c = *cp &amp; 0xff;
	<span class="enscript-keyword">if</span> (clp-&gt;c_cq) {
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">QBITS</span>
		<span class="enscript-keyword">if</span> (isset(clp-&gt;c_cq, cp - clp-&gt;c_cs))
			*c |= TTY_QUOTE;
#<span class="enscript-reference">else</span>
		<span class="enscript-keyword">if</span> (*(clp-&gt;c_cf - clp-&gt;c_cs + clp-&gt;c_cq))
			*c |= TTY_QUOTE;
#<span class="enscript-reference">endif</span>
	}
	<span class="enscript-keyword">return</span> cp;
}

<span class="enscript-comment">/*
 * Given a non-NULL pointer into the clist return the pointer
 * to the first character in the list or return NULL if no more chars.
 *
 * Callers must not allow getc's to happen between firstc's and getc's
 * so that the pointer becomes invalid.  Note that interrupts are NOT
 * masked.
 *
 * *c is set to the NEXT character
 */</span>
u_char *
<span class="enscript-function-name">firstc</span>(<span class="enscript-type">struct</span> clist *clp, <span class="enscript-type">int</span> *c)
{
	u_char *cp;

	cc = clp-&gt;c_cc;
	<span class="enscript-keyword">if</span> (cc == 0)
		<span class="enscript-keyword">return</span> NULL;
	cp = clp-&gt;c_cf;
	*c = *cp &amp; 0xff;
	<span class="enscript-keyword">if</span>(clp-&gt;c_cq) {
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">QBITS</span>
		<span class="enscript-keyword">if</span> (isset(clp-&gt;c_cq, cp - clp-&gt;c_cs))
			*c |= TTY_QUOTE;
#<span class="enscript-reference">else</span>
		<span class="enscript-keyword">if</span> (*(cp - clp-&gt;c_cs + clp-&gt;c_cq))
			*c |= TTY_QUOTE;
#<span class="enscript-reference">endif</span>
	}
	<span class="enscript-keyword">return</span> clp-&gt;c_cf;
}

<span class="enscript-comment">/*
 * Remove the last character in the clist and return it.
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">unputc</span>(<span class="enscript-type">struct</span> clist *clp)
{
	<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> c = -1;

	<span class="enscript-keyword">if</span> (clp-&gt;c_cc == 0)
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">out</span>;

	<span class="enscript-keyword">if</span> (clp-&gt;c_cl == clp-&gt;c_cs)
		clp-&gt;c_cl = clp-&gt;c_ce - 1;
	<span class="enscript-keyword">else</span>
		--clp-&gt;c_cl;
	clp-&gt;c_cc--;

	c = *clp-&gt;c_cl &amp; 0xff;
	<span class="enscript-keyword">if</span> (clp-&gt;c_cq) {
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">QBITS</span>
		<span class="enscript-keyword">if</span> (isset(clp-&gt;c_cq, clp-&gt;c_cl - clp-&gt;c_cs))
			c |= TTY_QUOTE;
#<span class="enscript-reference">else</span>
		<span class="enscript-keyword">if</span> (*(clp-&gt;c_cf - clp-&gt;c_cs + clp-&gt;c_cq))
			c |= TTY_QUOTE;
#<span class="enscript-reference">endif</span>
	}
	<span class="enscript-keyword">if</span> (clp-&gt;c_cc == 0)
		clp-&gt;c_cf = clp-&gt;c_cl = (u_char *)0;
<span class="enscript-reference">out</span>:
	<span class="enscript-keyword">return</span> c;
}

<span class="enscript-comment">/*
 * Put the chars in the from queue on the end of the to queue.
 */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">catq</span>(<span class="enscript-type">struct</span> clist *from, <span class="enscript-type">struct</span> clist *to)
{
	<span class="enscript-type">int</span> c;

	<span class="enscript-keyword">while</span> ((c = getc(from)) != -1)
		putc(c, to);
}
</pre>
<hr />
</body></html>