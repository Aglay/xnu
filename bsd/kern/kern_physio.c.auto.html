<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>kern_physio.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">kern_physio.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000-2004 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*-
 * Copyright (c) 1982, 1986, 1990, 1993
 *	The Regents of the University of California.  All rights reserved.
 * (c) UNIX System Laboratories, Inc.
 * All or some portions of this file are derived from material licensed
 * to the University of California by American Telephone and Telegraph
 * Co. or Unix System Laboratories, Inc. and are reproduced herein with
 * the permission of UNIX System Laboratories, Inc.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *	This product includes software developed by the University of
 *	California, Berkeley and its contributors.
 * 4. Neither the name of the University nor the names of its contributors
 *    may be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 *	from: @(#)kern_physio.c	8.1 (Berkeley) 6/10/93
 */</span>
<span class="enscript-comment">/*
 * HISTORY
 * 27-July-97  Umesh Vaishampayan  (<a href="mailto:umeshv@apple.com">umeshv@apple.com</a>)
 *	Allow physio() to kernel space.
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/param.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/systm.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/buf_internal.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/conf.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/proc_internal.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/uio_internal.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/assert.h&gt;</span>

<span class="enscript-type">int</span>
<span class="enscript-function-name">physio</span>( <span class="enscript-type">void</span> (*f_strategy)(buf_t), 
	buf_t bp,
	dev_t dev,
	<span class="enscript-type">int</span> flags,
	u_int (*f_minphys)(buf_t),
	<span class="enscript-type">struct</span> uio *uio,
	<span class="enscript-type">int</span> blocksize)
{
	<span class="enscript-type">struct</span> proc *p = current_proc();
	<span class="enscript-type">int</span> error, i, buf_allocated, todo, iosize;
	<span class="enscript-type">int</span> orig_bflags = 0;
	int64_t done;

	error = 0;
	flags &amp;= B_READ | B_WRITE;
	buf_allocated = 0;

	<span class="enscript-comment">/*
	 * [check user read/write access to the data buffer]
	 *
	 * Check each iov one by one.  Note that we know if we're reading or
	 * writing, so we ignore the uio's rw parameter.  Also note that if
	 * we're doing a read, that's a *write* to user-space.
	 */</span>
	<span class="enscript-keyword">for</span> (i = 0; i &lt; uio-&gt;uio_iovcnt; i++) {
		<span class="enscript-keyword">if</span> (UIO_SEG_IS_USER_SPACE(uio-&gt;uio_segflg)) {
			user_addr_t base;
			user_size_t len;
			
			<span class="enscript-keyword">if</span> (uio_getiov(uio, i, &amp;base, &amp;len) ||
				!useracc(base,
					len,
		    		(flags == B_READ) ? B_WRITE : B_READ))
			<span class="enscript-keyword">return</span> (EFAULT);
		}
	}
	<span class="enscript-comment">/*
	 * Make sure we have a buffer, creating one if necessary.
	 */</span>
	<span class="enscript-keyword">if</span> (bp == NULL) {
		bp = buf_alloc((vnode_t)0);
		buf_allocated = 1;
	} <span class="enscript-keyword">else</span>
	        orig_bflags = buf_flags(bp);
	<span class="enscript-comment">/*
	 * at this point we should have a buffer
	 * that is marked BL_BUSY... we either 
	 * acquired it via buf_alloc, or it was
	 * passed into us... if it was passed
	 * in, it needs to already be owned by
	 * the caller (i.e. BL_BUSY is set)
	 */</span>
	assert(bp-&gt;b_lflags &amp; BL_BUSY);

	<span class="enscript-comment">/*
	 * [set up the fixed part of the buffer for a transfer]
	 */</span>
	bp-&gt;b_dev = dev;
	bp-&gt;b_proc = p;

	<span class="enscript-comment">/*
	 * [mark the buffer busy for physical I/O]
	 * (i.e. set B_PHYS (because it's an I/O to user
	 * memory, and B_RAW, because B_RAW is to be
	 * &quot;Set by physio for raw transfers.&quot;, in addition
	 * to the read/write flag.)
	 */</span>
        buf_setflags(bp, B_PHYS | B_RAW);

	<span class="enscript-comment">/*
	 * [while there is data to transfer and no I/O error]
	 * Note that I/O errors are handled with a 'goto' at the bottom
	 * of the 'while' loop.
	 */</span>
	<span class="enscript-keyword">while</span> (uio_resid(uio) &gt; 0) {
			
			<span class="enscript-keyword">if</span> ( (iosize = uio_curriovlen(uio)) &gt; MAXPHYSIO_WIRED)
			        iosize = MAXPHYSIO_WIRED;
			<span class="enscript-comment">/*
			 * make sure we're set to issue a fresh I/O
			 * in the right direction
			 */</span>
			buf_reset(bp, flags);

			<span class="enscript-comment">/* [set up the buffer for a maximum-sized transfer] */</span>
 			buf_setblkno(bp, uio_offset(uio) / blocksize);
			buf_setcount(bp, iosize);
			buf_setdataptr(bp, (uintptr_t)CAST_DOWN(caddr_t, uio_curriovbase(uio)));
			
			<span class="enscript-comment">/*
			 * [call f_minphys to bound the tranfer size]
			 * and remember the amount of data to transfer,
			 * for later comparison.
			 */</span>
			(*f_minphys)(bp);
			todo = buf_count(bp);

			<span class="enscript-comment">/*
			 * [lock the part of the user address space involved
			 *    in the transfer]
			 */</span>

			<span class="enscript-keyword">if</span>(UIO_SEG_IS_USER_SPACE(uio-&gt;uio_segflg)) {
				error = vslock(CAST_USER_ADDR_T(buf_dataptr(bp)),
					       (user_size_t)todo);
				<span class="enscript-keyword">if</span> (error)
					<span class="enscript-keyword">goto</span> <span class="enscript-reference">done</span>;
			}
			
			<span class="enscript-comment">/* [call f_strategy to start the transfer] */</span>
			(*f_strategy)(bp);


			<span class="enscript-comment">/* [wait for the transfer to complete] */</span>
			error = (<span class="enscript-type">int</span>)buf_biowait(bp);

			<span class="enscript-comment">/*
			 * [unlock the part of the address space previously
			 *    locked]
			 */</span>
			<span class="enscript-keyword">if</span>(UIO_SEG_IS_USER_SPACE(uio-&gt;uio_segflg))
				vsunlock(CAST_USER_ADDR_T(buf_dataptr(bp)),
					 (user_size_t)todo,
					 (flags &amp; B_READ));

			<span class="enscript-comment">/*
			 * [deduct the transfer size from the total number
			 *    of data to transfer]
			 */</span>
			done = buf_count(bp) - buf_resid(bp);
			uio_update(uio, done);

			<span class="enscript-comment">/*
			 * Now, check for an error.
			 * Also, handle weird end-of-disk semantics.
			 */</span>
			<span class="enscript-keyword">if</span> (error || done &lt; todo)
				<span class="enscript-keyword">goto</span> <span class="enscript-reference">done</span>;
	}

<span class="enscript-reference">done</span>:
	<span class="enscript-keyword">if</span> (buf_allocated)
	        buf_free(bp);
	<span class="enscript-keyword">else</span>
		buf_setflags(bp, orig_bflags);

	<span class="enscript-keyword">return</span> (error);
}

<span class="enscript-comment">/*
 * Leffler, et al., says on p. 231:
 * &quot;The minphys() routine is called by physio() to adjust the
 * size of each I/O transfer before the latter is passed to
 * the strategy routine...&quot; 
 *
 * so, just adjust the buffer's count accounting to MAXPHYS here,
 * and return the new count;
 */</span>
u_int
<span class="enscript-function-name">minphys</span>(<span class="enscript-type">struct</span> buf *bp)
{

	buf_setcount(bp, min(MAXPHYS, buf_count(bp)));
        <span class="enscript-keyword">return</span> buf_count(bp);
}
</pre>
<hr />
</body></html>