<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>subr_prf.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">subr_prf.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000-2006 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/* Copyright (c) 1995 NeXT Computer, Inc. All Rights Reserved */</span>
<span class="enscript-comment">/*-
 * Copyright (c) 1986, 1988, 1991, 1993
 *	The Regents of the University of California.  All rights reserved.
 * (c) UNIX System Laboratories, Inc.
 * All or some portions of this file are derived from material licensed
 * to the University of California by American Telephone and Telegraph
 * Co. or Unix System Laboratories, Inc. and are reproduced herein with
 * the permission of UNIX System Laboratories, Inc.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *	This product includes software developed by the University of
 *	California, Berkeley and its contributors.
 * 4. Neither the name of the University nor the names of its contributors
 *    may be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 *	@(#)subr_prf.c	8.4 (Berkeley) 5/4/95
 */</span>
<span class="enscript-comment">/* HISTORY
 * 22-Sep-1997 Umesh Vaishampayan (<a href="mailto:umeshv@apple.com">umeshv@apple.com</a>)
 *	Cleaned up m68k crud. Fixed vlog() to do logpri() for ppc, too.
 *
 * 17-July-97  Umesh Vaishampayan (<a href="mailto:umeshv@apple.com">umeshv@apple.com</a>)
 *	Eliminated multiple definition of constty which is defined
 *	in bsd/dev/XXX/cons.c
 *
 * 26-MAR-1997 Umesh Vaishampayan (<a href="mailto:umeshv@NeXT.com">umeshv@NeXT.com</a>
 * 	Fixed tharshing format in many functions. Cleanup.
 * 
 * 17-Jun-1995 Mac Gillon (mgillon) at NeXT
 *	Purged old history
 *	New version based on 4.4 and NS3.3
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/param.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/systm.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/conf.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/reboot.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/msgbuf.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/proc_internal.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/ioctl.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/tty.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/file_internal.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/tprintf.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/syslog.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdarg.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/malloc.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/lock.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/subr_prf.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/cpu_number.h&gt;</span>	<span class="enscript-comment">/* for cpu_number() */</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;machine/spl.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/libkern.h&gt;</span>

<span class="enscript-comment">/* for vaddlog(): the following are implemented in osfmk/kern/printf.c  */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">bsd_log_lock</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">bsd_log_unlock</span>(<span class="enscript-type">void</span>);

<span class="enscript-comment">/* Keep this around only because it's exported */</span>
<span class="enscript-type">void</span> <span class="enscript-function-name">_printf</span>(<span class="enscript-type">int</span>, <span class="enscript-type">struct</span> tty *, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *, ...);

<span class="enscript-type">struct</span> snprintf_arg {
	<span class="enscript-type">char</span> *str;
	size_t remain;
};


<span class="enscript-comment">/*
 * In case console is off,
 * panicstr contains argument to last
 * call to panic.
 */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span>	*panicstr;

<span class="enscript-type">extern</span>	<span class="enscript-type">void</span> cnputc(<span class="enscript-type">char</span>);		<span class="enscript-comment">/* standard console putc */</span>
<span class="enscript-function-name">void</span>	(*v_putc)(<span class="enscript-type">char</span>) = cnputc;	<span class="enscript-comment">/* routine to putc on virtual console */</span>

<span class="enscript-type">extern</span>	<span class="enscript-type">struct</span> tty cons;		<span class="enscript-comment">/* standard console tty */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span>	tty *constty;		<span class="enscript-comment">/* pointer to console &quot;window&quot; tty */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>  <span class="enscript-function-name">__doprnt</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *fmt,
					 va_list    argp,
					 <span class="enscript-type">void</span>       (*)(<span class="enscript-type">int</span>, <span class="enscript-type">void</span> *),
					 <span class="enscript-type">void</span>       *arg,
					 <span class="enscript-type">int</span>        radix,
					 <span class="enscript-type">int</span>        is_log);

<span class="enscript-comment">/*
 *	Record cpu that panic'd and lock around panic data
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">printn</span>(uint32_t n, <span class="enscript-type">int</span> b, <span class="enscript-type">int</span> flags, <span class="enscript-type">struct</span> tty *ttyp, <span class="enscript-type">int</span> zf, <span class="enscript-type">int</span> fld_size);

<span class="enscript-type">extern</span>	<span class="enscript-type">void</span> logwakeup(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span>	<span class="enscript-type">void</span> halt_cpu(<span class="enscript-type">void</span>);

<span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">snprintf_func</span>(<span class="enscript-type">int</span> ch, <span class="enscript-type">void</span> *arg);

<span class="enscript-type">struct</span> putchar_args {
	<span class="enscript-type">int</span> flags;
	<span class="enscript-type">struct</span> tty *tty;
};
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">putchar</span>(<span class="enscript-type">int</span> c, <span class="enscript-type">void</span> *arg);


<span class="enscript-comment">/*
 * Uprintf prints to the controlling terminal for the current process.
 * It may block if the tty queue is overfull.  No message is printed if
 * the queue does not clear in a reasonable time.
 */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">uprintf</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *fmt, ...)
{
	<span class="enscript-type">struct</span> proc *p = current_proc();
	<span class="enscript-type">struct</span> putchar_args pca;
	va_list ap;
	<span class="enscript-type">struct</span> session *sessp;
	
	sessp = proc_session(p);

	<span class="enscript-keyword">if</span> (p-&gt;p_flag &amp; P_CONTROLT &amp;&amp; sessp != SESSION_NULL &amp;&amp; sessp-&gt;s_ttyvp) {
		pca.flags = TOTTY;
		pca.tty   = SESSION_TP(sessp);
		<span class="enscript-keyword">if</span> (pca.tty != NULL)
			tty_lock(pca.tty);
		va_start(ap, fmt);
		__doprnt(fmt, ap, putchar, &amp;pca, 10, FALSE);
		va_end(ap);
		<span class="enscript-keyword">if</span> (pca.tty != NULL)
		tty_unlock(pca.tty);
	}
	<span class="enscript-keyword">if</span> (sessp != SESSION_NULL)
		session_rele(sessp);
}

tpr_t
<span class="enscript-function-name">tprintf_open</span>(<span class="enscript-type">struct</span> proc *p)
{
	<span class="enscript-type">struct</span> session * sessp;

	sessp = proc_session(p);

	<span class="enscript-keyword">if</span> (p-&gt;p_flag &amp; P_CONTROLT &amp;&amp; sessp-&gt;s_ttyvp) {
		<span class="enscript-keyword">return</span> ((tpr_t)sessp);
	}
	<span class="enscript-keyword">if</span> (sessp != SESSION_NULL)
		session_rele(sessp);

	<span class="enscript-keyword">return</span> ((tpr_t) NULL);
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">tprintf_close</span>(tpr_t sessp)
{
	<span class="enscript-keyword">if</span> (sessp)
		session_rele((<span class="enscript-type">struct</span> session *) sessp);
}

<span class="enscript-comment">/*
 * tprintf prints on the controlling terminal associated
 * with the given session.
 *
 * NOTE:	No one else should call this function!!!
 */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">tprintf</span>(tpr_t tpr, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *fmt, ...)
{
	<span class="enscript-type">struct</span> session *sess = (<span class="enscript-type">struct</span> session *)tpr;
	<span class="enscript-type">struct</span> tty *tp = TTY_NULL;
	<span class="enscript-type">int</span> flags = TOLOG;
	va_list ap;
	<span class="enscript-type">struct</span> putchar_args pca;

	logpri(LOG_INFO);

	<span class="enscript-keyword">if</span> (sess &amp;&amp; (tp = SESSION_TP(sess)) != TTY_NULL) {
		<span class="enscript-comment">/* ttycheckoutq(), tputchar() require a locked tp */</span>
		tty_lock(tp);
		<span class="enscript-keyword">if</span>(ttycheckoutq(tp, 0)) {
			flags |= TOTTY;
			<span class="enscript-comment">/* going to the tty; leave locked */</span>
		} <span class="enscript-keyword">else</span> {
			<span class="enscript-comment">/* not going to the tty... */</span>
			tty_unlock(tp);
			tp = TTY_NULL;
		}
	}
	
	pca.flags = flags;
	pca.tty   = tp;
	va_start(ap, fmt);
	__doprnt(fmt, ap, putchar, &amp;pca, 10, FALSE);
	va_end(ap);

	<span class="enscript-keyword">if</span> (tp != NULL)
		tty_unlock(tp);	<span class="enscript-comment">/* lock/unlock is guarded by tp, above */</span>

	logwakeup();
}

<span class="enscript-comment">/*
 * Ttyprintf displays a message on a tty; it should be used only by
 * the tty driver, or anything that knows the underlying tty will not
 * be revoke(2)'d away.  Other callers should use tprintf.
 *
 * Locks:	It is assumed that the tty_lock() is held over the call
 *		to this function.  Ensuring this is the responsibility
 *		of the caller.
 */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">ttyprintf</span>(<span class="enscript-type">struct</span> tty *tp, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *fmt, ...)
{
	va_list ap;

	<span class="enscript-keyword">if</span> (tp != NULL) {
		<span class="enscript-type">struct</span> putchar_args pca;
		pca.flags = TOTTY;
		pca.tty   = tp;
		
		va_start(ap, fmt);
		__doprnt(fmt, ap, putchar, &amp;pca, 10, TRUE);
		va_end(ap);
	}
}


<span class="enscript-type">extern</span>	<span class="enscript-type">int</span> log_open;


<span class="enscript-type">void</span>
<span class="enscript-function-name">logpri</span>(<span class="enscript-type">int</span> level)
{
	<span class="enscript-type">struct</span> putchar_args pca;
	pca.flags = TOLOG;
	pca.tty   = NULL;
	
	putchar(<span class="enscript-string">'&lt;'</span>, &amp;pca);
	printn((uint32_t)level, 10, TOLOG, (<span class="enscript-type">struct</span> tty *)0, 0, 0);
	putchar(<span class="enscript-string">'&gt;'</span>, &amp;pca);
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">_logtime</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *fmt, ...)
{
	va_list ap;
	va_start(ap, fmt);
	vaddlog(fmt, ap);
	va_end(ap);
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">logtime</span>(time_t secs)
{
	_logtime(<span class="enscript-string">&quot;         0 [Time %ld] [Message &quot;</span>, secs);
}

<span class="enscript-type">int</span>
<span class="enscript-function-name">vaddlog</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *fmt, va_list ap)
{
	<span class="enscript-type">struct</span> putchar_args pca;

	pca.flags = TOLOGLOCKED;
	pca.tty   = NULL;

	<span class="enscript-keyword">if</span> (!log_open) {
		pca.flags |= TOCONS;
	}

	bsd_log_lock();
	__doprnt(fmt, ap, putchar, &amp;pca, 10, TRUE);
	bsd_log_unlock();
	
	logwakeup();
	<span class="enscript-keyword">return</span> 0;
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">_printf</span>(<span class="enscript-type">int</span> flags, <span class="enscript-type">struct</span> tty *ttyp, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *format, ...)
{
	va_list ap;
	<span class="enscript-type">struct</span> putchar_args pca;

	pca.flags = flags;
	pca.tty   = ttyp;

	<span class="enscript-keyword">if</span> (ttyp != NULL) {
		tty_lock(ttyp);
	
		va_start(ap, format);
		__doprnt(format, ap, putchar, &amp;pca, 10, TRUE);
		va_end(ap);

		tty_unlock(ttyp);
	}
}

<span class="enscript-type">int</span>
<span class="enscript-function-name">prf</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *fmt, va_list ap, <span class="enscript-type">int</span> flags, <span class="enscript-type">struct</span> tty *ttyp)
{
	<span class="enscript-type">struct</span> putchar_args pca;

	pca.flags = flags;
	pca.tty   = ttyp;

	__doprnt(fmt, ap, putchar, &amp;pca, 10, TRUE);

	<span class="enscript-keyword">return</span> 0;
}

<span class="enscript-comment">/*
 * Printn prints a number n in base b.
 * We don't use recursion to avoid deep kernel stacks.
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">printn</span>(uint32_t n, <span class="enscript-type">int</span> b, <span class="enscript-type">int</span> flags, <span class="enscript-type">struct</span> tty *ttyp, <span class="enscript-type">int</span> zf, <span class="enscript-type">int</span> fld_size)
{
	<span class="enscript-type">char</span> prbuf[11];
	<span class="enscript-type">char</span> *cp;
	<span class="enscript-type">struct</span> putchar_args pca;

	pca.flags = flags;
	pca.tty   = ttyp;

	<span class="enscript-keyword">if</span> (b == 10 &amp;&amp; (<span class="enscript-type">int</span>)n &lt; 0) {
		putchar(<span class="enscript-string">'-'</span>, &amp;pca);
		n = (<span class="enscript-type">unsigned</span>)(-(<span class="enscript-type">int</span>)n);
	}
	cp = prbuf;
	<span class="enscript-keyword">do</span> {
		*cp++ = <span class="enscript-string">&quot;0123456789abcdef&quot;</span>[n%b];
		n /= b;
	} <span class="enscript-keyword">while</span> (n);
	<span class="enscript-keyword">if</span> (fld_size) {
		<span class="enscript-keyword">for</span> (fld_size -= cp - prbuf; fld_size &gt; 0; fld_size--)
			<span class="enscript-keyword">if</span> (zf)
				putchar(<span class="enscript-string">'0'</span>, &amp;pca);
			<span class="enscript-keyword">else</span>
				putchar(<span class="enscript-string">' '</span>, &amp;pca);
	}
	<span class="enscript-keyword">do</span>
		putchar(*--cp, &amp;pca);
	<span class="enscript-keyword">while</span> (cp &gt; prbuf);
}



<span class="enscript-comment">/*
 * Warn that a system table is full.
 */</span>
<span class="enscript-type">void</span> <span class="enscript-function-name">tablefull</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *tab)
{
	log(LOG_ERR, <span class="enscript-string">&quot;%s: table is full\n&quot;</span>, tab);
}

<span class="enscript-comment">/*
 * Print a character on console or users terminal.
 * If destination is console then the last MSGBUFS characters
 * are saved in msgbuf for inspection later.
 *
 * Locks:	If TOTTY is set, we assume that the tty lock is held
 *		over the call to this function.
 */</span>
<span class="enscript-comment">/*ARGSUSED*/</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">putchar</span>(<span class="enscript-type">int</span> c, <span class="enscript-type">void</span> *arg)
{
	<span class="enscript-type">struct</span> putchar_args *pca = arg;
	<span class="enscript-type">char</span> **sp = (<span class="enscript-type">char</span>**) pca-&gt;tty;

	<span class="enscript-keyword">if</span> (panicstr)
		constty = 0;
	<span class="enscript-keyword">if</span> ((pca-&gt;flags &amp; TOCONS) &amp;&amp; pca-&gt;tty == NULL &amp;&amp; constty) {
		pca-&gt;tty = constty;
		pca-&gt;flags |= TOTTY;
	}
	<span class="enscript-keyword">if</span> ((pca-&gt;flags &amp; TOTTY) &amp;&amp; pca-&gt;tty &amp;&amp; tputchar(c, pca-&gt;tty) &lt; 0 &amp;&amp;
	    (pca-&gt;flags &amp; TOCONS) &amp;&amp; pca-&gt;tty == constty)
		constty = 0;
	<span class="enscript-keyword">if</span> ((pca-&gt;flags &amp; TOLOG) &amp;&amp; c != <span class="enscript-string">'\0'</span> &amp;&amp; c != <span class="enscript-string">'\r'</span> &amp;&amp; c != 0177)
		log_putc(c);
	<span class="enscript-keyword">if</span> ((pca-&gt;flags &amp; TOLOGLOCKED) &amp;&amp; c != <span class="enscript-string">'\0'</span> &amp;&amp; c != <span class="enscript-string">'\r'</span> &amp;&amp; c != 0177)
		log_putc_locked(c);
	<span class="enscript-keyword">if</span> ((pca-&gt;flags &amp; TOCONS) &amp;&amp; constty == 0 &amp;&amp; c != <span class="enscript-string">'\0'</span>)
		(*v_putc)(c);
	<span class="enscript-keyword">if</span> (pca-&gt;flags &amp; TOSTR) {
		**sp = c;
		(*sp)++;
	}
}

<span class="enscript-type">int</span>
<span class="enscript-function-name">vprintf</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *fmt, va_list ap)
{
	<span class="enscript-type">struct</span> putchar_args pca;

	pca.flags = TOLOG | TOCONS;
	pca.tty   = NULL;
	__doprnt(fmt, ap, putchar, &amp;pca, 10, TRUE);
	<span class="enscript-keyword">return</span> 0;
}


<span class="enscript-comment">/*
 * Scaled down version of vsprintf(3).
 *
 * Deprecation Warning:
 *	vsprintf() is being deprecated. Please use vsnprintf() instead. 
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">vsprintf</span>(<span class="enscript-type">char</span> *buf, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *cfmt, va_list ap)
{
	<span class="enscript-type">int</span> retval;
	<span class="enscript-type">struct</span> snprintf_arg info;

	info.str = buf;
	info.remain = 999999;

	retval = __doprnt(cfmt, ap, snprintf_func, &amp;info, 10, FALSE);
	<span class="enscript-keyword">if</span> (info.remain &gt;= 1) {
		*info.str++ = <span class="enscript-string">'\0'</span>;
	}
	<span class="enscript-keyword">return</span> 0;
}

<span class="enscript-comment">/*
 * Scaled down version of snprintf(3).
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">snprintf</span>(<span class="enscript-type">char</span> *str, size_t size, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *format, ...)
{
	<span class="enscript-type">int</span> retval;
	va_list ap;

	va_start(ap, format);
	retval = vsnprintf(str, size, format, ap);
	va_end(ap);
	<span class="enscript-keyword">return</span>(retval);
}

<span class="enscript-comment">/*
 * Scaled down version of vsnprintf(3).
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">vsnprintf</span>(<span class="enscript-type">char</span> *str, size_t size, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *format, va_list ap)
{
	<span class="enscript-type">struct</span> snprintf_arg info;
	<span class="enscript-type">int</span> retval;

	info.str = str;
	info.remain = size;
	retval = __doprnt(format, ap, snprintf_func, &amp;info, 10, FALSE);
	<span class="enscript-keyword">if</span> (info.remain &gt;= 1)
		*info.str++ = <span class="enscript-string">'\0'</span>;
	<span class="enscript-keyword">return</span> retval;
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">snprintf_func</span>(<span class="enscript-type">int</span> ch, <span class="enscript-type">void</span> *arg)
{
	<span class="enscript-type">struct</span> snprintf_arg *<span class="enscript-type">const</span> info = arg;

	<span class="enscript-keyword">if</span> (info-&gt;remain &gt;= 2) {
		*info-&gt;str++ = ch;
		info-&gt;remain--;
	}
}

<span class="enscript-type">int</span>
<span class="enscript-function-name">kvprintf</span>(<span class="enscript-type">char</span> <span class="enscript-type">const</span> *fmt, <span class="enscript-type">void</span> (*func)(<span class="enscript-type">int</span>, <span class="enscript-type">void</span>*), <span class="enscript-type">void</span> *arg, <span class="enscript-type">int</span> radix, va_list ap)
{
	__doprnt(fmt, ap, func, arg, radix, TRUE);
	<span class="enscript-keyword">return</span> 0;
}

</pre>
<hr />
</body></html>