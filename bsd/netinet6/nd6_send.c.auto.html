<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>nd6_send.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">nd6_send.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2013 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 *
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 *
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 *
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/malloc.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/proc.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/sysctl.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/syslog.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/crypto/sha1.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/if.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/in.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet6/in6_var.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/ip6.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet6/ip6_var.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet6/nd6.h&gt;</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_MACF</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/kauth.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;security/mac_framework.h&gt;</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-function-name">SYSCTL_DECL</span>(_net_inet6);	<span class="enscript-comment">/* Note: Not in any common header. */</span>

<span class="enscript-function-name">SYSCTL_NODE</span>(_net_inet6, OID_AUTO, send, CTLFLAG_RW | CTLFLAG_LOCKED, 0,
	<span class="enscript-string">&quot;IPv6 Secure Neighbor Discovery&quot;</span>);

<span class="enscript-type">static</span> <span class="enscript-type">int</span> nd6_send_opmode = ND6_SEND_OPMODE_DISABLED;

<span class="enscript-function-name">SYSCTL_INT</span>(_net_inet6_send, OID_AUTO, opstate, CTLFLAG_RD | CTLFLAG_LOCKED,
	&amp;nd6_send_opstate, 0, <span class="enscript-string">&quot;current SEND operating state&quot;</span>);

<span class="enscript-type">int</span> nd6_send_opstate = ND6_SEND_OPMODE_DISABLED;
<span class="enscript-function-name">SYSCTL_INT</span>(_net_inet6_send, OID_AUTO, opmode, CTLFLAG_RW | CTLFLAG_LOCKED,
	&amp;nd6_send_opmode, 0, <span class="enscript-string">&quot;configured SEND operating mode&quot;</span>);

<span class="enscript-type">static</span> <span class="enscript-type">int</span> sysctl_cga_parameters SYSCTL_HANDLER_ARGS;

<span class="enscript-function-name">SYSCTL_PROC</span>(_net_inet6_send, OID_AUTO, cga_parameters,
	CTLTYPE_OPAQUE | CTLFLAG_RW | CTLFLAG_LOCKED, 0, 0,
	sysctl_cga_parameters, <span class="enscript-string">&quot;S,nd6_send_nodecfg&quot;</span>, <span class="enscript-string">&quot;&quot;</span>);

<span class="enscript-comment">/*
 * The size of the buffer is sufficient to contain a public key, its size in
 * machine binary type for the kernel, and the CGA precalc for the global
 * scope. This interface is not a public API, so we don't anticipate that the
 * userland and the kernel will be mismatched between ILP32 and LP64.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">SYSCTL_CGA_PARAMETERS_BUFFER_SIZE</span> \
	2 * (<span class="enscript-keyword">sizeof</span> (u_int16_t) + IN6_CGA_KEY_MAXSIZE) + \
	<span class="enscript-keyword">sizeof</span> (<span class="enscript-type">struct</span> in6_cga_prepare)

<span class="enscript-type">static</span> <span class="enscript-type">int</span>
sysctl_cga_parameters SYSCTL_HANDLER_ARGS
{
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">unused</span>(<span class="enscript-variable-name">oidp</span>, <span class="enscript-variable-name">arg1</span>)
	u_int namelen;
	<span class="enscript-type">char</span> *oldp, *newp;
	<span class="enscript-type">const</span> <span class="enscript-type">char</span> *fin;
	<span class="enscript-type">struct</span> in6_cga_nodecfg cfg;
	<span class="enscript-type">struct</span> iovec *iov;
	<span class="enscript-type">int</span> error;
	<span class="enscript-type">char</span> *buffer;
	u_int16_t u16;
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_MACF</span>
	kauth_cred_t cred;
#<span class="enscript-reference">endif</span>

	namelen = arg2;
	<span class="enscript-keyword">if</span> (namelen != 0) {
		log(LOG_ERR, <span class="enscript-string">&quot;%s: name length err [len=%u]\n&quot;</span>, __func__,
		    namelen);
		<span class="enscript-keyword">return</span> (EINVAL);
	}

	<span class="enscript-keyword">if</span> (req-&gt;newlen &gt; SYSCTL_CGA_PARAMETERS_BUFFER_SIZE) {
		log(LOG_ERR, <span class="enscript-string">&quot;%s: input buffer size error [len=%u]\n&quot;</span>, __func__,
		    req-&gt;newlen);
		<span class="enscript-keyword">return</span> (EINVAL);
	}

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_MACF</span>
	cred = kauth_cred_proc_ref(current_proc());
	error = mac_system_check_info(cred, <span class="enscript-string">&quot;net.inet6.send.cga_parameters&quot;</span>);
	kauth_cred_unref(&amp;cred);
	<span class="enscript-keyword">if</span> (error != 0) {
		log(LOG_ERR, <span class="enscript-string">&quot;%s: mac_system_check_info denied.\n&quot;</span>, __func__);
		<span class="enscript-keyword">return</span> (EPERM);
	}
#<span class="enscript-reference">endif</span>

	MALLOC(buffer, <span class="enscript-type">char</span> *, SYSCTL_CGA_PARAMETERS_BUFFER_SIZE, M_IP6CGA,
	    M_WAITOK);
	<span class="enscript-keyword">if</span> (buffer == NULL) {
		log(LOG_ERR, <span class="enscript-string">&quot;%s: could not allocate marshaling buffer.\n&quot;</span>,
		    __func__);
		<span class="enscript-keyword">return</span> (ENOMEM);
	}

	in6_cga_node_lock();

	<span class="enscript-keyword">if</span> (req-&gt;oldptr != USER_ADDR_NULL &amp;&amp; req-&gt;oldlen &gt; 0) {
		oldp = buffer;
		fin = &amp;buffer[SYSCTL_CGA_PARAMETERS_BUFFER_SIZE];
		<span class="enscript-keyword">if</span> (req-&gt;oldlen &lt; SYSCTL_CGA_PARAMETERS_BUFFER_SIZE)
			fin = &amp;buffer[req-&gt;oldlen];

		in6_cga_query(&amp;cfg);
		iov = &amp;cfg.cga_pubkey;
		<span class="enscript-keyword">if</span> (iov-&gt;iov_len &gt; 0) {
			VERIFY(iov-&gt;iov_len &lt; UINT16_MAX);

			<span class="enscript-keyword">if</span> (&amp;oldp[<span class="enscript-keyword">sizeof</span> (cfg.cga_prepare)] &lt;= fin)
				bcopy(&amp;cfg.cga_prepare, oldp,
				    <span class="enscript-keyword">sizeof</span> (cfg.cga_prepare));
			oldp += <span class="enscript-keyword">sizeof</span> (cfg.cga_prepare);

			<span class="enscript-keyword">if</span> (&amp;oldp[<span class="enscript-keyword">sizeof</span> (u16)] &lt; fin) {
				u16 = (u_int16_t) iov-&gt;iov_len;
				bcopy(&amp;u16, oldp, <span class="enscript-keyword">sizeof</span> (u16));
			}
			oldp += <span class="enscript-keyword">sizeof</span> (u16);

			<span class="enscript-keyword">if</span> (&amp;oldp[iov-&gt;iov_len] &lt; fin)
				bcopy(iov-&gt;iov_base, oldp, iov-&gt;iov_len);
			oldp += iov-&gt;iov_len;

			<span class="enscript-keyword">if</span> (oldp &gt; fin) {
				req-&gt;oldlen = oldp - buffer;
				log(LOG_ERR, <span class="enscript-string">&quot;%s: marshalled data too large.\n&quot;</span>,
				    __func__);
				error = ENOMEM;
				<span class="enscript-keyword">goto</span> <span class="enscript-reference">done</span>;
			}
		}

		error = SYSCTL_OUT(req, buffer, oldp - buffer);
		<span class="enscript-keyword">if</span> (error)
			<span class="enscript-keyword">goto</span> <span class="enscript-reference">done</span>;
	}

	<span class="enscript-keyword">if</span> (req-&gt;newptr == USER_ADDR_NULL)
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">done</span>;

	error = proc_suser(current_proc());
	<span class="enscript-keyword">if</span> (error)
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">done</span>;

	<span class="enscript-keyword">if</span> (req-&gt;newlen == 0) {
		in6_cga_stop();
		nd6_send_opstate = ND6_SEND_OPMODE_DISABLED;
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">done</span>;
	}

	error = SYSCTL_IN(req, buffer, req-&gt;newlen);
	<span class="enscript-keyword">if</span> (error)
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">done</span>;

	newp = buffer;
	fin = &amp;buffer[req-&gt;newlen];

	bzero(&amp;cfg, <span class="enscript-keyword">sizeof</span> cfg);

	<span class="enscript-keyword">if</span> (&amp;newp[<span class="enscript-keyword">sizeof</span> (cfg.cga_prepare)] &lt;= fin)
		bcopy(newp, &amp;cfg.cga_prepare, <span class="enscript-keyword">sizeof</span> (cfg.cga_prepare));
	newp += <span class="enscript-keyword">sizeof</span> (cfg.cga_prepare);

	iov = &amp;cfg.cga_privkey;
	<span class="enscript-keyword">if</span> (&amp;newp[<span class="enscript-keyword">sizeof</span> (u16)] &lt; fin) {
		bcopy(newp, &amp;u16, <span class="enscript-keyword">sizeof</span> (u16));
		iov-&gt;iov_len = u16;

		<span class="enscript-keyword">if</span> (iov-&gt;iov_len &gt; IN6_CGA_KEY_MAXSIZE) {
			error = EINVAL;
			<span class="enscript-keyword">goto</span> <span class="enscript-reference">done</span>;
		}
	}
	newp += <span class="enscript-keyword">sizeof</span> (u16);

	iov-&gt;iov_base = newp;
	newp += iov-&gt;iov_len;

	iov = &amp;cfg.cga_pubkey;
	<span class="enscript-keyword">if</span> (&amp;newp[<span class="enscript-keyword">sizeof</span> (u16)] &lt; fin) {
		bcopy(newp, &amp;u16, <span class="enscript-keyword">sizeof</span> (u16));
		iov-&gt;iov_len = u16;

		<span class="enscript-keyword">if</span> (iov-&gt;iov_len &gt; IN6_CGA_KEY_MAXSIZE) {
			error = EINVAL;
			<span class="enscript-keyword">goto</span> <span class="enscript-reference">done</span>;
		}
	}
	newp += <span class="enscript-keyword">sizeof</span> (u16);

	iov-&gt;iov_base = newp;
	newp += iov-&gt;iov_len;

	<span class="enscript-keyword">if</span> (newp &gt; fin) {
		log(LOG_ERR, <span class="enscript-string">&quot;%s: input too large [octets=%ld].\n&quot;</span>, __func__,
		    newp - fin);
		error = ENOMEM;
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">done</span>;
	}

	error = in6_cga_start(&amp;cfg);
	<span class="enscript-keyword">if</span> (!error)
		nd6_send_opstate = nd6_send_opmode;
	<span class="enscript-keyword">else</span>
		log(LOG_ERR, <span class="enscript-string">&quot;%s: in6_cga_start error=%d.\n&quot;</span>, __func__,
		    error);

<span class="enscript-reference">done</span>:
	in6_cga_node_unlock();
	FREE(buffer, M_IP6CGA);
	<span class="enscript-keyword">return</span> (error);
}

<span class="enscript-comment">/* End of file */</span>
</pre>
<hr />
</body></html>