<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>ipcomp_output.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">ipcomp_output.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*	$FreeBSD: src/sys/netinet6/ipcomp_output.c,v 1.1.2.2 2001/07/03 11:01:54 ume Exp $	*/</span>
<span class="enscript-comment">/*	$KAME: ipcomp_output.c,v 1.23 2001/01/23 08:59:37 itojun Exp $	*/</span>

<span class="enscript-comment">/*
 * Copyright (C) 1999 WIDE Project.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. Neither the name of the project nor the names of its contributors
 *    may be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE PROJECT AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE PROJECT OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 */</span>

<span class="enscript-comment">/*
 * RFC2393 IP payload compression protocol (IPComp).
 */</span>


#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/param.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/systm.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/malloc.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/mbuf.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/domain.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/protosw.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/socket.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/errno.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/time.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/kernel.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/syslog.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/if.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/route.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/zlib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/cpu_number.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/locks.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/in.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/in_systm.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/in_var.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/ip.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/ip_var.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/ip_ecn.h&gt;</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET6</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/ip6.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet6/ip6_var.h&gt;</span>
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet6/ipcomp.h&gt;</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET6</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet6/ipcomp6.h&gt;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet6/ipsec.h&gt;</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET6</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet6/ipsec6.h&gt;</span>
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netkey/key.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netkey/keydb.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/net_osdep.h&gt;</span>


<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">ipcomp_output</span>(<span class="enscript-type">struct</span> mbuf *, u_char *, <span class="enscript-type">struct</span> mbuf *,
	<span class="enscript-type">int</span>, <span class="enscript-type">struct</span> secasvar *sav);

<span class="enscript-comment">/*
 * Modify the packet so that the payload is compressed.
 * The mbuf (m) must start with IPv4 or IPv6 header.
 * On failure, free the given mbuf and return non-zero.
 *
 * on invocation:
 *	m   nexthdrp md
 *	v   v        v
 *	IP ......... payload
 * during the encryption:
 *	m   nexthdrp mprev md
 *	v   v        v     v
 *	IP ............... ipcomp payload
 *	                   &lt;-----&gt;&lt;-----&gt;
 *	                   complen  plen
 *	&lt;-&gt; hlen
 *	&lt;-----------------&gt; compoff
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">ipcomp_output</span>(m, nexthdrp, md, af, sav)
	<span class="enscript-type">struct</span> mbuf *m;
	u_char *nexthdrp;
	<span class="enscript-type">struct</span> mbuf *md;
	<span class="enscript-type">int</span> af;
	<span class="enscript-type">struct</span> secasvar *sav;
{
	<span class="enscript-type">struct</span> mbuf *n;
	<span class="enscript-type">struct</span> mbuf *md0;
	<span class="enscript-type">struct</span> mbuf *mcopy;
	<span class="enscript-type">struct</span> mbuf *mprev;
	<span class="enscript-type">struct</span> ipcomp *ipcomp;
	<span class="enscript-type">const</span> <span class="enscript-type">struct</span> ipcomp_algorithm *algo;
	u_int16_t cpi;		<span class="enscript-comment">/* host order */</span>
	size_t plen0, plen;	<span class="enscript-comment">/*payload length to be compressed*/</span>
	size_t compoff;
	<span class="enscript-type">int</span> afnumber;
	<span class="enscript-type">int</span> error = 0;
	<span class="enscript-type">struct</span> ipsecstat *stat;

	<span class="enscript-keyword">switch</span> (af) {
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET</span>
	<span class="enscript-keyword">case</span> <span class="enscript-reference">AF_INET</span>:
		afnumber = 4;
		stat = &amp;ipsecstat;
		<span class="enscript-keyword">break</span>;
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET6</span>
	<span class="enscript-keyword">case</span> <span class="enscript-reference">AF_INET6</span>:
		afnumber = 6;
		stat = &amp;ipsec6stat;
		<span class="enscript-keyword">break</span>;
#<span class="enscript-reference">endif</span>
	<span class="enscript-reference">default</span>:
		ipseclog((LOG_ERR, <span class="enscript-string">&quot;ipcomp_output: unsupported af %d\n&quot;</span>, af));
		<span class="enscript-keyword">return</span> 0;	<span class="enscript-comment">/* no change at all */</span>
	}

	<span class="enscript-comment">/* grab parameters */</span>
	algo = ipcomp_algorithm_lookup(sav-&gt;alg_enc);
	<span class="enscript-keyword">if</span> ((ntohl(sav-&gt;spi) &amp; ~0xffff) != 0 || !algo) {
		IPSEC_STAT_INCREMENT(stat-&gt;out_inval);
		m_freem(m);
		<span class="enscript-keyword">return</span> EINVAL;
	}
	<span class="enscript-keyword">if</span> ((sav-&gt;flags &amp; SADB_X_EXT_RAWCPI) == 0)
		cpi = sav-&gt;alg_enc;
	<span class="enscript-keyword">else</span>
		cpi = ntohl(sav-&gt;spi) &amp; 0xffff;

	<span class="enscript-comment">/* compute original payload length */</span>
	plen = 0;
	<span class="enscript-keyword">for</span> (n = md; n; n = n-&gt;m_next)
		plen += n-&gt;m_len;

	<span class="enscript-comment">/* if the payload is short enough, we don't need to compress */</span>
	<span class="enscript-keyword">if</span> (plen &lt; algo-&gt;minplen)
		<span class="enscript-keyword">return</span> 0;

	<span class="enscript-comment">/*
	 * retain the original packet for two purposes:
	 * (1) we need to backout our changes when compression is not necessary.
	 * (2) byte lifetime computation should use the original packet.
	 *     see RFC2401 page 23.
	 * compromise two m_copym().  we will be going through every byte of
	 * the payload during compression process anyways.
	 */</span>
	mcopy = m_copym(m, 0, M_COPYALL, M_NOWAIT);
	<span class="enscript-keyword">if</span> (mcopy == NULL) {
		error = ENOBUFS;
		<span class="enscript-keyword">return</span> 0;
	}
	md0 = m_copym(md, 0, M_COPYALL, M_NOWAIT);
	<span class="enscript-keyword">if</span> (md0 == NULL) {
		m_freem(mcopy);
		error = ENOBUFS;
		<span class="enscript-keyword">return</span> 0;
	}
	plen0 = plen;

	<span class="enscript-comment">/* make the packet over-writable */</span>
	<span class="enscript-keyword">for</span> (mprev = m; mprev &amp;&amp; mprev-&gt;m_next != md; mprev = mprev-&gt;m_next)
		;
	<span class="enscript-keyword">if</span> (mprev == NULL || mprev-&gt;m_next != md) {
		ipseclog((LOG_DEBUG, <span class="enscript-string">&quot;ipcomp%d_output: md is not in chain\n&quot;</span>,
		    afnumber));
		IPSEC_STAT_INCREMENT(stat-&gt;out_inval);
		m_freem(m);
		m_freem(md0);
		m_freem(mcopy);
		<span class="enscript-keyword">return</span> EINVAL;
	}
	mprev-&gt;m_next = NULL;
	<span class="enscript-keyword">if</span> ((md = ipsec_copypkt(md)) == NULL) {
		m_freem(m);
		m_freem(md0);
		m_freem(mcopy);
		error = ENOBUFS;
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">fail</span>;
	}
	mprev-&gt;m_next = md;

	<span class="enscript-comment">/* compress data part */</span>
	<span class="enscript-keyword">if</span> ((*algo-&gt;compress)(m, md, &amp;plen) || mprev-&gt;m_next == NULL) {
		ipseclog((LOG_ERR, <span class="enscript-string">&quot;packet compression failure\n&quot;</span>));
		m = NULL;
		m_freem(md0);
		m_freem(mcopy);
		IPSEC_STAT_INCREMENT(stat-&gt;out_inval);
		error = EINVAL;
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">fail</span>;
	}
	IPSEC_STAT_INCREMENT(stat-&gt;out_comphist[sav-&gt;alg_enc]);
	md = mprev-&gt;m_next;

	<span class="enscript-comment">/*
	 * if the packet became bigger, meaningless to use IPComp.
	 * we've only wasted our cpu time.
	 */</span>
	<span class="enscript-keyword">if</span> (plen0 &lt; plen) {
		m_freem(md);
		m_freem(mcopy);
		mprev-&gt;m_next = md0;
		<span class="enscript-keyword">return</span> 0;
	}

	<span class="enscript-comment">/*
	 * no need to backout change beyond here.
	 */</span>
	m_freem(md0);
	md0 = NULL;

	m-&gt;m_pkthdr.len -= plen0;
	m-&gt;m_pkthdr.len += plen;

    {
	<span class="enscript-comment">/*
	 * insert IPComp header.
	 */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET</span>
	<span class="enscript-type">struct</span> ip *ip = NULL;
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET6</span>
	<span class="enscript-type">struct</span> ip6_hdr *ip6 = NULL;
#<span class="enscript-reference">endif</span>
	size_t hlen = 0;	<span class="enscript-comment">/*ip header len*/</span>
	size_t complen = <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">struct</span> ipcomp);

	<span class="enscript-keyword">switch</span> (af) {
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET</span>
	<span class="enscript-keyword">case</span> <span class="enscript-reference">AF_INET</span>:
		ip = mtod(m, <span class="enscript-type">struct</span> ip *);
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">_IP_VHL</span>
		hlen = IP_VHL_HL(ip-&gt;ip_vhl) &lt;&lt; 2;
#<span class="enscript-reference">else</span>
		hlen = ip-&gt;ip_hl &lt;&lt; 2;
#<span class="enscript-reference">endif</span>
		<span class="enscript-keyword">break</span>;
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET6</span>
	<span class="enscript-keyword">case</span> <span class="enscript-reference">AF_INET6</span>:
		ip6 = mtod(m, <span class="enscript-type">struct</span> ip6_hdr *);
		hlen = <span class="enscript-keyword">sizeof</span>(*ip6);
		<span class="enscript-keyword">break</span>;
#<span class="enscript-reference">endif</span>
	}

	compoff = m-&gt;m_pkthdr.len - plen;

	<span class="enscript-comment">/*
	 * grow the mbuf to accomodate ipcomp header.
	 * before: IP ... payload
	 * after:  IP ... ipcomp payload
	 */</span>
	<span class="enscript-keyword">if</span> (M_LEADINGSPACE(md) &lt; complen) {
		MGET(n, M_DONTWAIT, MT_DATA);
		<span class="enscript-keyword">if</span> (!n) {
			m_freem(m);
			error = ENOBUFS;
			<span class="enscript-keyword">goto</span> <span class="enscript-reference">fail</span>;
		}
		n-&gt;m_len = complen;
		mprev-&gt;m_next = n;
		n-&gt;m_next = md;
		m-&gt;m_pkthdr.len += complen;
		ipcomp = mtod(n, <span class="enscript-type">struct</span> ipcomp *);
	} <span class="enscript-keyword">else</span> {
		md-&gt;m_len += complen;
		md-&gt;m_data -= complen;
		m-&gt;m_pkthdr.len += complen;
		ipcomp = mtod(md, <span class="enscript-type">struct</span> ipcomp *);
	}
	
	bzero(ipcomp, <span class="enscript-keyword">sizeof</span>(*ipcomp));
	ipcomp-&gt;comp_nxt = *nexthdrp;
	*nexthdrp = IPPROTO_IPCOMP;
	ipcomp-&gt;comp_cpi = htons(cpi);
	<span class="enscript-keyword">switch</span> (af) {
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET</span>
	<span class="enscript-keyword">case</span> <span class="enscript-reference">AF_INET</span>:
		<span class="enscript-keyword">if</span> (compoff + complen + plen &lt; IP_MAXPACKET)
			ip-&gt;ip_len = htons(compoff + complen + plen);
		<span class="enscript-keyword">else</span> {
			ipseclog((LOG_ERR,
			    <span class="enscript-string">&quot;IPv4 ESP output: size exceeds limit\n&quot;</span>));
			IPSEC_STAT_INCREMENT(ipsecstat.out_inval);
			m_freem(m);
			error = EMSGSIZE;
			<span class="enscript-keyword">goto</span> <span class="enscript-reference">fail</span>;
		}
		<span class="enscript-keyword">break</span>;
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET6</span>
	<span class="enscript-keyword">case</span> <span class="enscript-reference">AF_INET6</span>:
		<span class="enscript-comment">/* total packet length will be computed in ip6_output() */</span>
		<span class="enscript-keyword">break</span>;
#<span class="enscript-reference">endif</span>
	}
    }

	<span class="enscript-keyword">if</span> (!m) {
		ipseclog((LOG_DEBUG,
		    <span class="enscript-string">&quot;NULL mbuf after compression in ipcomp%d_output&quot;</span>,
		    afnumber));
		IPSEC_STAT_INCREMENT(stat-&gt;out_inval);
	}
		IPSEC_STAT_INCREMENT(stat-&gt;out_success);

	<span class="enscript-comment">/* compute byte lifetime against original packet */</span>
	key_sa_recordxfer(sav, mcopy);
	m_freem(mcopy);

	<span class="enscript-keyword">return</span> 0;

<span class="enscript-reference">fail</span>:
#<span class="enscript-reference">if</span> 1
	<span class="enscript-keyword">return</span> error;
#<span class="enscript-reference">else</span>
	panic(<span class="enscript-string">&quot;something bad in ipcomp_output&quot;</span>);
#<span class="enscript-reference">endif</span>
}

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">ipcomp4_output</span>(m, sav)
	<span class="enscript-type">struct</span> mbuf *m;
	<span class="enscript-type">struct</span> secasvar *sav;
{
	<span class="enscript-type">struct</span> ip *ip;
	<span class="enscript-keyword">if</span> (m-&gt;m_len &lt; <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">struct</span> ip)) {
		ipseclog((LOG_DEBUG, <span class="enscript-string">&quot;ipcomp4_output: first mbuf too short\n&quot;</span>));
		IPSEC_STAT_INCREMENT(ipsecstat.out_inval);
		m_freem(m);
		<span class="enscript-keyword">return</span> 0;
	}
	ip = mtod(m, <span class="enscript-type">struct</span> ip *);
	<span class="enscript-comment">/* XXX assumes that m-&gt;m_next points to payload */</span>
	<span class="enscript-keyword">return</span> ipcomp_output(m, &amp;ip-&gt;ip_p, m-&gt;m_next, AF_INET, sav);
}
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/*INET*/</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET6</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">ipcomp6_output</span>(m, nexthdrp, md, sav)
	<span class="enscript-type">struct</span> mbuf *m;
	u_char *nexthdrp;
	<span class="enscript-type">struct</span> mbuf *md;
	<span class="enscript-type">struct</span> secasvar *sav;
{
	<span class="enscript-keyword">if</span> (m-&gt;m_len &lt; <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">struct</span> ip6_hdr)) {
		ipseclog((LOG_DEBUG, <span class="enscript-string">&quot;ipcomp6_output: first mbuf too short\n&quot;</span>));
		IPSEC_STAT_INCREMENT(ipsec6stat.out_inval);
		m_freem(m);
		<span class="enscript-keyword">return</span> 0;
	}
	<span class="enscript-keyword">return</span> ipcomp_output(m, nexthdrp, md, AF_INET6, sav);
}
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/*INET6*/</span>
</pre>
<hr />
</body></html>