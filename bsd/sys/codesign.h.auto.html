<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>codesign.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">codesign.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2006 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_SYS_CODESIGN_H_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_SYS_CODESIGN_H_</span>

<span class="enscript-comment">/* code signing attributes of a process */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CS_VALID</span>		0x0000001	<span class="enscript-comment">/* dynamically valid */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CS_ADHOC</span>		0x0000002	<span class="enscript-comment">/* ad hoc signed */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CS_GET_TASK_ALLOW</span>	0x0000004	<span class="enscript-comment">/* has get-task-allow entitlement */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CS_INSTALLER</span>		0x0000008	<span class="enscript-comment">/* has installer entitlement */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CS_HARD</span>			0x0000100	<span class="enscript-comment">/* don't load invalid pages */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CS_KILL</span>			0x0000200	<span class="enscript-comment">/* kill process if it becomes invalid */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CS_CHECK_EXPIRATION</span>	0x0000400	<span class="enscript-comment">/* force expiration checking */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CS_RESTRICT</span>		0x0000800	<span class="enscript-comment">/* tell dyld to treat restricted */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CS_ENFORCEMENT</span>		0x0001000	<span class="enscript-comment">/* require enforcement */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CS_REQUIRE_LV</span>		0x0002000	<span class="enscript-comment">/* require library validation */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CS_ENTITLEMENTS_VALIDATED</span>	0x0004000

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CS_ALLOWED_MACHO</span>	0x00ffffe

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CS_EXEC_SET_HARD</span>	0x0100000	<span class="enscript-comment">/* set CS_HARD on any exec'ed process */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CS_EXEC_SET_KILL</span>	0x0200000	<span class="enscript-comment">/* set CS_KILL on any exec'ed process */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CS_EXEC_SET_ENFORCEMENT</span>	0x0400000	<span class="enscript-comment">/* set CS_ENFORCEMENT on any exec'ed process */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CS_EXEC_SET_INSTALLER</span>	0x0800000	<span class="enscript-comment">/* set CS_INSTALLER on any exec'ed process */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CS_KILLED</span>		0x1000000	<span class="enscript-comment">/* was killed by kernel for invalidity */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CS_DYLD_PLATFORM</span>	0x2000000	<span class="enscript-comment">/* dyld used to load this is a platform binary */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CS_PLATFORM_BINARY</span>	0x4000000	<span class="enscript-comment">/* this is a platform binary */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CS_PLATFORM_PATH</span>	0x8000000	<span class="enscript-comment">/* platform binary by the fact of path (osx only) */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CS_ENTITLEMENT_FLAGS</span>	(CS_GET_TASK_ALLOW | CS_INSTALLER)

<span class="enscript-comment">/* MAC flags used by F_ADDFILESIGS_* */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MAC_VNODE_CHECK_DYLD_SIM</span> 0x1   <span class="enscript-comment">/* tells the MAC framework that dyld-sim is being loaded */</span>

<span class="enscript-comment">/* csops  operations */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CS_OPS_STATUS</span>		0	<span class="enscript-comment">/* return status */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CS_OPS_MARKINVALID</span>	1	<span class="enscript-comment">/* invalidate process */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CS_OPS_MARKHARD</span>		2	<span class="enscript-comment">/* set HARD flag */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CS_OPS_MARKKILL</span>		3	<span class="enscript-comment">/* set KILL flag (sticky) */</span>
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL_PRIVATE</span>
<span class="enscript-comment">/* CS_OPS_PIDPATH		4	*/</span>
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CS_OPS_CDHASH</span>		5	<span class="enscript-comment">/* get code directory hash */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CS_OPS_PIDOFFSET</span>	6	<span class="enscript-comment">/* get offset of active Mach-o slice */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CS_OPS_ENTITLEMENTS_BLOB</span> 7	<span class="enscript-comment">/* get entitlements blob */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CS_OPS_MARKRESTRICT</span>	8	<span class="enscript-comment">/* set RESTRICT flag (sticky) */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CS_OPS_SET_STATUS</span>	9	<span class="enscript-comment">/* set codesign flags */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CS_OPS_BLOB</span>		10	<span class="enscript-comment">/* get codesign blob */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CS_OPS_IDENTITY</span>		11	<span class="enscript-comment">/* get codesign identity */</span>

<span class="enscript-comment">/*
 * Magic numbers used by Code Signing
 */</span>
<span class="enscript-type">enum</span> {
	CSMAGIC_REQUIREMENT = 0xfade0c00,		<span class="enscript-comment">/* single Requirement blob */</span>
	CSMAGIC_REQUIREMENTS = 0xfade0c01,		<span class="enscript-comment">/* Requirements vector (internal requirements) */</span>
	CSMAGIC_CODEDIRECTORY = 0xfade0c02,		<span class="enscript-comment">/* CodeDirectory blob */</span>
	CSMAGIC_EMBEDDED_SIGNATURE = 0xfade0cc0, <span class="enscript-comment">/* embedded form of signature data */</span>
	CSMAGIC_EMBEDDED_SIGNATURE_OLD = 0xfade0b02,	<span class="enscript-comment">/* XXX */</span>
	CSMAGIC_EMBEDDED_ENTITLEMENTS = 0xfade7171,	<span class="enscript-comment">/* embedded entitlements */</span>
	CSMAGIC_DETACHED_SIGNATURE = 0xfade0cc1, <span class="enscript-comment">/* multi-arch collection of embedded signatures */</span>
	CSMAGIC_BLOBWRAPPER = 0xfade0b01,	<span class="enscript-comment">/* CMS Signature, among other things */</span>
	
	CS_SUPPORTSSCATTER = 0x20100,
	CS_SUPPORTSTEAMID = 0x20200,

	CSSLOT_CODEDIRECTORY = 0,				<span class="enscript-comment">/* slot index for CodeDirectory */</span>
	CSSLOT_INFOSLOT = 1,
	CSSLOT_REQUIREMENTS = 2,
	CSSLOT_RESOURCEDIR = 3,
	CSSLOT_APPLICATION = 4,
	CSSLOT_ENTITLEMENTS = 5,

	CSSLOT_SIGNATURESLOT = 0x10000,			<span class="enscript-comment">/* CMS Signature */</span>

	CSTYPE_INDEX_REQUIREMENTS = 0x00000002,		<span class="enscript-comment">/* compat with amfi */</span>
	CSTYPE_INDEX_ENTITLEMENTS = 0x00000005,		<span class="enscript-comment">/* compat with amfi */</span>

	CS_HASHTYPE_SHA1 = 1,
	CS_HASHTYPE_SHA256 = 2,
	CS_HASHTYPE_SHA256_TRUNCATED = 3,

	CS_SHA1_LEN = 20,
	CS_SHA256_TRUNCATED_LEN = 20,

	CS_CDHASH_LEN = 20,
	CS_HASH_MAX_SIZE = 32, <span class="enscript-comment">/* max size of the hash we'll support */</span>
};


#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KERNEL_HAVE_CS_CODEDIRECTORY</span> 1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KERNEL_CS_CODEDIRECTORY_HAVE_PLATFORM</span> 1

<span class="enscript-comment">/*
 * C form of a CodeDirectory.
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> __CodeDirectory {
	uint32_t magic;					<span class="enscript-comment">/* magic number (CSMAGIC_CODEDIRECTORY) */</span>
	uint32_t length;				<span class="enscript-comment">/* total length of CodeDirectory blob */</span>
	uint32_t version;				<span class="enscript-comment">/* compatibility version */</span>
	uint32_t flags;					<span class="enscript-comment">/* setup and mode flags */</span>
	uint32_t hashOffset;			<span class="enscript-comment">/* offset of hash slot element at index zero */</span>
	uint32_t identOffset;			<span class="enscript-comment">/* offset of identifier string */</span>
	uint32_t nSpecialSlots;			<span class="enscript-comment">/* number of special hash slots */</span>
	uint32_t nCodeSlots;			<span class="enscript-comment">/* number of ordinary (code) hash slots */</span>
	uint32_t codeLimit;				<span class="enscript-comment">/* limit to main image signature range */</span>
	uint8_t hashSize;				<span class="enscript-comment">/* size of each hash in bytes */</span>
	uint8_t hashType;				<span class="enscript-comment">/* type of hash (cdHashType* constants) */</span>
	uint8_t platform;				<span class="enscript-comment">/* platform identifier; zero if not platform binary */</span>
	uint8_t	pageSize;				<span class="enscript-comment">/* log2(page size in bytes); 0 =&gt; infinite */</span>
	uint32_t spare2;				<span class="enscript-comment">/* unused (must be zero) */</span>
	<span class="enscript-comment">/* Version 0x20100 */</span>
	uint32_t scatterOffset;				<span class="enscript-comment">/* offset of optional scatter vector */</span>
	<span class="enscript-comment">/* Version 0x20200 */</span>
	uint32_t teamOffset;				<span class="enscript-comment">/* offset of optional team identifier */</span>
	<span class="enscript-comment">/* followed by dynamic content as located by offset fields above */</span>
} CS_CodeDirectory;

<span class="enscript-comment">/*
 * Structure of an embedded-signature SuperBlob
 */</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> __BlobIndex {
	uint32_t type;					<span class="enscript-comment">/* type of entry */</span>
	uint32_t offset;				<span class="enscript-comment">/* offset of entry */</span>
} CS_BlobIndex;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> __SC_SuperBlob {
	uint32_t magic;					<span class="enscript-comment">/* magic number */</span>
	uint32_t length;				<span class="enscript-comment">/* total length of SuperBlob */</span>
	uint32_t count;					<span class="enscript-comment">/* number of index entries following */</span>
	CS_BlobIndex index[];			<span class="enscript-comment">/* (count) entries */</span>
	<span class="enscript-comment">/* followed by Blobs in no particular order as indicated by offsets in index */</span>
} CS_SuperBlob;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KERNEL_HAVE_CS_GENERICBLOB</span> 1
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> __SC_GenericBlob {
	uint32_t magic;				<span class="enscript-comment">/* magic number */</span>
	uint32_t length;			<span class="enscript-comment">/* total length of blob */</span>
	<span class="enscript-type">char</span> data[];
} CS_GenericBlob;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> __SC_Scatter {
	uint32_t count;			<span class="enscript-comment">// number of pages; zero for sentinel (only)
</span>	uint32_t base;			<span class="enscript-comment">// first page number
</span>	uint64_t targetOffset;		<span class="enscript-comment">// offset in target
</span>	uint64_t spare;			<span class="enscript-comment">// reserved
</span>} SC_Scatter;


#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">KERNEL</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/message.h&gt;</span>

__BEGIN_DECLS
<span class="enscript-comment">/* code sign operations */</span>
<span class="enscript-type">int</span> <span class="enscript-function-name">csops</span>(pid_t pid, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>  ops, <span class="enscript-type">void</span> * useraddr, size_t usersize);
<span class="enscript-type">int</span> <span class="enscript-function-name">csops_audittoken</span>(pid_t pid, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>  ops, <span class="enscript-type">void</span> * useraddr, size_t usersize, audit_token_t * token);
__END_DECLS

#<span class="enscript-reference">else</span> <span class="enscript-comment">/* !KERNEL */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/cdefs.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/_types/_off_t.h&gt;</span>

<span class="enscript-type">struct</span> vnode;
<span class="enscript-type">struct</span> cs_blob;
<span class="enscript-type">struct</span> fileglob;

__BEGIN_DECLS
<span class="enscript-type">int</span>	cs_enforcement(<span class="enscript-type">struct</span> proc *);
<span class="enscript-type">int</span>	cs_require_lv(<span class="enscript-type">struct</span> proc *);
uint32_t <span class="enscript-function-name">cs_entitlement_flags</span>(<span class="enscript-type">struct</span> proc *p);
<span class="enscript-type">int</span>	cs_entitlements_blob_get(<span class="enscript-type">struct</span> proc *, <span class="enscript-type">void</span> **, size_t *);
<span class="enscript-type">int</span>	cs_restricted(<span class="enscript-type">struct</span> proc *);
uint8_t * <span class="enscript-function-name">cs_get_cdhash</span>(<span class="enscript-type">struct</span> proc *);

<span class="enscript-type">struct</span> cs_blob * <span class="enscript-function-name">csproc_get_blob</span>(<span class="enscript-type">struct</span> proc *);
<span class="enscript-type">struct</span> cs_blob * <span class="enscript-function-name">csvnode_get_blob</span>(<span class="enscript-type">struct</span> vnode *, off_t);
<span class="enscript-type">void</span>		 csvnode_print_debug(<span class="enscript-type">struct</span> vnode *);

<span class="enscript-type">const</span> <span class="enscript-type">char</span> *	csblob_get_teamid(<span class="enscript-type">struct</span> cs_blob *);
<span class="enscript-type">const</span> <span class="enscript-type">char</span> *	csblob_get_identity(<span class="enscript-type">struct</span> cs_blob *);
<span class="enscript-type">const</span> uint8_t *	csblob_get_cdhash(<span class="enscript-type">struct</span> cs_blob *);
<span class="enscript-type">int</span>		csblob_get_platform_binary(<span class="enscript-type">struct</span> cs_blob *);
<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> 	csblob_get_flags(<span class="enscript-type">struct</span> cs_blob *blob);
<span class="enscript-type">int</span>		csblob_get_entitlements(<span class="enscript-type">struct</span> cs_blob *, <span class="enscript-type">void</span> **, size_t *);
<span class="enscript-type">const</span> CS_GenericBlob *
		csblob_find_blob(<span class="enscript-type">struct</span> cs_blob *, uint32_t, uint32_t);
<span class="enscript-type">const</span> CS_GenericBlob *
		csblob_find_blob_bytes(<span class="enscript-type">const</span> uint8_t *, size_t, uint32_t, uint32_t);

<span class="enscript-comment">/*
 * Mostly convenience functions below
 */</span>

<span class="enscript-type">const</span> 	<span class="enscript-type">char</span> * csproc_get_teamid(<span class="enscript-type">struct</span> proc *);
<span class="enscript-type">const</span> 	<span class="enscript-type">char</span> * csvnode_get_teamid(<span class="enscript-type">struct</span> vnode *, off_t);
<span class="enscript-type">int</span> 	csproc_get_platform_binary(<span class="enscript-type">struct</span> proc *);
<span class="enscript-type">const</span> 	<span class="enscript-type">char</span> * csfg_get_teamid(<span class="enscript-type">struct</span> fileglob *);
<span class="enscript-type">int</span>	csfg_get_path(<span class="enscript-type">struct</span> fileglob *, <span class="enscript-type">char</span> *, <span class="enscript-type">int</span> *);
<span class="enscript-type">int</span> 	csfg_get_platform_binary(<span class="enscript-type">struct</span> fileglob *);
uint8_t * <span class="enscript-function-name">csfg_get_cdhash</span>(<span class="enscript-type">struct</span> fileglob *, uint64_t, size_t *);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> cs_debug;

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">XNU_KERNEL_PRIVATE</span>

<span class="enscript-type">void</span>	cs_init(<span class="enscript-type">void</span>);
<span class="enscript-type">int</span>	cs_allow_invalid(<span class="enscript-type">struct</span> proc *);
<span class="enscript-type">int</span>	cs_invalid_page(addr64_t);
<span class="enscript-type">int</span>	csproc_get_platform_path(<span class="enscript-type">struct</span> proc *);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> cs_validation;
#<span class="enscript-reference">if</span> !<span class="enscript-variable-name">SECURE_KERNEL</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> cs_enforcement_panic;
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* XNU_KERNEL_PRIVATE */</span>


__END_DECLS



#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL */</span>

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* _SYS_CODESIGN_H_ */</span>
</pre>
<hr />
</body></html>