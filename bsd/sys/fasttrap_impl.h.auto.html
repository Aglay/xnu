<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>fasttrap_impl.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">fasttrap_impl.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * CDDL HEADER START
 *
 * The contents of this file are subject to the terms of the
 * Common Development and Distribution License (the &quot;License&quot;).
 * You may not use this file except in compliance with the License.
 *
 * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE
 * or <a href="http://www.opensolaris.org/os/licensing.">http://www.opensolaris.org/os/licensing.</a>
 * See the License for the specific language governing permissions
 * and limitations under the License.
 *
 * When distributing Covered Code, include this CDDL HEADER in each
 * file and include the License file at usr/src/OPENSOLARIS.LICENSE.
 * If applicable, add the following below this CDDL HEADER, with the
 * fields enclosed by brackets &quot;[]&quot; replaced with your own identifying
 * information: Portions Copyright [yyyy] [name of copyright owner]
 *
 * CDDL HEADER END
 */</span>

<span class="enscript-comment">/*
 * Copyright 2008 Sun Microsystems, Inc.  All rights reserved.
 * Use is subject to license terms.
 */</span>

#<span class="enscript-reference">ifndef</span>	<span class="enscript-variable-name">_FASTTRAP_IMPL_H</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">_FASTTRAP_IMPL_H</span>

<span class="enscript-comment">/*
 * #pragma ident	&quot;@(#)fasttrap_impl.h	1.14	08/04/09 SMI&quot;
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/dtrace.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/proc.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/user.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/fasttrap.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/fasttrap_isa.h&gt;</span>

<span class="enscript-comment">/* Solaris proc_t is the struct. Darwin's proc_t is a pointer to it. */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">proc_t</span> struct proc <span class="enscript-comment">/* Steer clear of the Darwin typedef for proc_t */</span>

#<span class="enscript-reference">ifdef</span>	<span class="enscript-variable-name">__cplusplus</span>
<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> {
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">/*
 * Fasttrap Providers, Probes and Tracepoints
 *
 * Each Solaris process can have multiple providers -- the pid provider as
 * well as any number of user-level statically defined tracing (USDT)
 * providers. Those providers are each represented by a fasttrap_provider_t.
 * All providers for a given process have a pointer to a shared
 * fasttrap_proc_t. The fasttrap_proc_t has two states: active or defunct.
 * When the count of active providers goes to zero it becomes defunct; a
 * provider drops its active count when it is removed individually or as part
 * of a mass removal when a process exits or performs an exec.
 *
 * Each probe is represented by a fasttrap_probe_t which has a pointer to
 * its associated provider as well as a list of fasttrap_id_tp_t structures
 * which are tuples combining a fasttrap_id_t and a fasttrap_tracepoint_t.
 * A fasttrap_tracepoint_t represents the actual point of instrumentation
 * and it contains two lists of fasttrap_id_t structures (to be fired pre-
 * and post-instruction emulation) that identify the probes attached to the
 * tracepoint. Tracepoints also have a pointer to the fasttrap_proc_t for the
 * process they trace which is used when looking up a tracepoint both when a
 * probe fires and when enabling and disabling probes.
 *
 * It's important to note that probes are preallocated with the necessary
 * number of tracepoints, but that tracepoints can be shared by probes and
 * swapped between probes. If a probe's preallocated tracepoint is enabled
 * (and, therefore, the associated probe is enabled), and that probe is
 * then disabled, ownership of that tracepoint may be exchanged for an
 * unused tracepoint belonging to another probe that was attached to the
 * enabled tracepoint.
 */</span>

<span class="enscript-comment">/*
 * APPLE NOTE: All kmutex_t's have been converted to lck_mtx_t
 */</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> fasttrap_proc {
	pid_t ftpc_pid;				<span class="enscript-comment">/* process ID for this proc */</span>
	uint64_t ftpc_acount;			<span class="enscript-comment">/* count of active providers */</span>
	uint64_t ftpc_rcount;			<span class="enscript-comment">/* count of extant providers */</span>
	lck_mtx_t ftpc_mtx;			<span class="enscript-comment">/* lock on all but acount */</span>
	<span class="enscript-type">struct</span> fasttrap_proc *ftpc_next;	<span class="enscript-comment">/* next proc in hash chain */</span>
} fasttrap_proc_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> fasttrap_provider {
	pid_t ftp_pid;				<span class="enscript-comment">/* process ID for this prov */</span>
	fasttrap_provider_type_t ftp_provider_type;	<span class="enscript-comment">/* type of this provider (usdt, pid, objc, oneshot) */</span>
	<span class="enscript-type">char</span> ftp_name[DTRACE_PROVNAMELEN];	<span class="enscript-comment">/* prov name (w/o the pid) */</span>
	dtrace_provider_id_t ftp_provid;	<span class="enscript-comment">/* DTrace provider handle */</span>
	uint_t ftp_marked;			<span class="enscript-comment">/* mark for possible removal */</span>
	uint_t ftp_retired;			<span class="enscript-comment">/* mark when retired */</span>
	lck_mtx_t ftp_mtx;			<span class="enscript-comment">/* provider lock */</span>
	lck_mtx_t ftp_cmtx;			<span class="enscript-comment">/* lock on creating probes */</span>
	uint64_t ftp_rcount;			<span class="enscript-comment">/* enabled probes ref count */</span>
	uint64_t ftp_ccount;			<span class="enscript-comment">/* consumers creating probes */</span>
	uint64_t ftp_mcount;			<span class="enscript-comment">/* meta provider count */</span>
	fasttrap_proc_t *ftp_proc;		<span class="enscript-comment">/* shared proc for all provs */</span>
	<span class="enscript-type">struct</span> fasttrap_provider *ftp_next;	<span class="enscript-comment">/* next prov in hash chain */</span>
} fasttrap_provider_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> fasttrap_id fasttrap_id_t;
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> fasttrap_probe fasttrap_probe_t;
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> fasttrap_tracepoint fasttrap_tracepoint_t;

<span class="enscript-type">struct</span> fasttrap_id {
	fasttrap_probe_t *fti_probe;		<span class="enscript-comment">/* referrring probe */</span>
	fasttrap_id_t *fti_next;		<span class="enscript-comment">/* enabled probe list on tp */</span>
	fasttrap_probe_type_t fti_ptype;	<span class="enscript-comment">/* probe type */</span>
};

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> fasttrap_id_tp {
	fasttrap_id_t fit_id;
	fasttrap_tracepoint_t *fit_tp;
} fasttrap_id_tp_t;

<span class="enscript-type">struct</span> fasttrap_probe {
	dtrace_id_t ftp_id;			<span class="enscript-comment">/* DTrace probe identifier */</span>
	pid_t ftp_pid;				<span class="enscript-comment">/* pid for this probe */</span>
	fasttrap_provider_t *ftp_prov;		<span class="enscript-comment">/* this probe's provider */</span>
	user_addr_t ftp_faddr;			<span class="enscript-comment">/* associated function's addr */</span>
	size_t ftp_fsize;			<span class="enscript-comment">/* associated function's size */</span>
	uint64_t ftp_gen;			<span class="enscript-comment">/* modification generation */</span>
	uint64_t ftp_ntps;			<span class="enscript-comment">/* number of tracepoints */</span>
	uint8_t *ftp_argmap;			<span class="enscript-comment">/* native to translated args */</span>
	uint8_t ftp_nargs;			<span class="enscript-comment">/* translated argument count */</span>
	uint8_t ftp_enabled;			<span class="enscript-comment">/* is this probe enabled */</span>
	<span class="enscript-type">char</span> *ftp_xtypes;			<span class="enscript-comment">/* translated types index */</span>
	<span class="enscript-type">char</span> *ftp_ntypes;			<span class="enscript-comment">/* native types index */</span>
	fasttrap_id_tp_t ftp_tps[1];		<span class="enscript-comment">/* flexible array */</span>
};

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">FASTTRAP_ID_INDEX</span>(id)	\
((fasttrap_id_tp_t *)(((<span class="enscript-type">char</span> *)(id) - offsetof(fasttrap_id_tp_t, fit_id))) - \
&amp;(id)-&gt;fti_probe-&gt;ftp_tps[0])

<span class="enscript-type">struct</span> fasttrap_tracepoint {
	fasttrap_proc_t *ftt_proc;		<span class="enscript-comment">/* associated process struct */</span>
	user_addr_t ftt_pc;			<span class="enscript-comment">/* address of tracepoint */</span>
	pid_t ftt_pid;				<span class="enscript-comment">/* pid of tracepoint */</span>
	fasttrap_machtp_t ftt_mtp;		<span class="enscript-comment">/* ISA-specific portion */</span>
	fasttrap_id_t *ftt_ids;			<span class="enscript-comment">/* NULL-terminated list */</span>
	fasttrap_id_t *ftt_retids;		<span class="enscript-comment">/* NULL-terminated list */</span>
	fasttrap_tracepoint_t *ftt_next;	<span class="enscript-comment">/* link in global hash */</span>
};

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> fasttrap_bucket {
	lck_mtx_t ftb_mtx;			<span class="enscript-comment">/* bucket lock */</span>
	<span class="enscript-type">void</span> *ftb_data;				<span class="enscript-comment">/* data payload */</span>

	uint8_t ftb_pad[64 - <span class="enscript-keyword">sizeof</span> (lck_mtx_t) - <span class="enscript-keyword">sizeof</span> (<span class="enscript-type">void</span> *)];
} fasttrap_bucket_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> fasttrap_hash {
	ulong_t fth_nent;			<span class="enscript-comment">/* power-of-2 num. of entries */</span>
	ulong_t fth_mask;			<span class="enscript-comment">/* fth_nent - 1 */</span>
	fasttrap_bucket_t *fth_table;		<span class="enscript-comment">/* array of buckets */</span>
} fasttrap_hash_t;

<span class="enscript-comment">/*
 * If at some future point these assembly functions become observable by
 * DTrace, then these defines should become separate functions so that the
 * fasttrap provider doesn't trigger probes during internal operations.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">fasttrap_copyout</span>	copyout
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">fasttrap_fuword32</span>	fuword32
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">fasttrap_suword32</span>	suword32

<span class="enscript-comment">/*
 * APPLE NOTE: xnu supports both 32bit and 64bit user processes.
 * We need to make size explicit.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">fasttrap_fuword64</span>	fuword64
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">fasttrap_suword64</span>	suword64
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fasttrap_fuword64_noerr</span>	fuword64_noerr
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fasttrap_fuword32_noerr</span>	fuword32_noerr

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">fasttrap_sigtrap</span>(proc_t *, uthread_t, user_addr_t);

<span class="enscript-type">extern</span> dtrace_id_t 		fasttrap_probe_id;
<span class="enscript-type">extern</span> fasttrap_hash_t		fasttrap_tpoints;

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">FASTTRAP_TPOINTS_INDEX</span>(pid, pc) \
	(((pc) / <span class="enscript-keyword">sizeof</span> (fasttrap_instr_t) + (pid)) &amp; fasttrap_tpoints.fth_mask)

<span class="enscript-comment">/*
 * Must be implemented by fasttrap_isa.c
 */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">fasttrap_tracepoint_init</span>(proc_t *, fasttrap_tracepoint_t *,
    user_addr_t, fasttrap_probe_type_t);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">fasttrap_tracepoint_install</span>(proc_t *, fasttrap_tracepoint_t *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">fasttrap_tracepoint_remove</span>(proc_t *, fasttrap_tracepoint_t *);

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__x86_64__</span>)
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">fasttrap_pid_probe</span>(x86_saved_state_t *regs);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">fasttrap_return_probe</span>(x86_saved_state_t* regs);
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">error</span> <span class="enscript-variable-name">architecture</span> <span class="enscript-variable-name">not</span> <span class="enscript-variable-name">supported</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-type">extern</span> uint64_t <span class="enscript-function-name">fasttrap_pid_getarg</span>(<span class="enscript-type">void</span> *, dtrace_id_t, <span class="enscript-type">void</span> *, <span class="enscript-type">int</span>, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> uint64_t <span class="enscript-function-name">fasttrap_usdt_getarg</span>(<span class="enscript-type">void</span> *, dtrace_id_t, <span class="enscript-type">void</span> *, <span class="enscript-type">int</span>, <span class="enscript-type">int</span>);

#<span class="enscript-reference">ifdef</span>	<span class="enscript-variable-name">__cplusplus</span>
}
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">proc_t</span>

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* _FASTTRAP_IMPL_H */</span>
</pre>
<hr />
</body></html>