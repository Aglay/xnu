<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>sem_internal.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">sem_internal.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000-2007 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*
 * NOTICE: This file was modified by SPARTA, Inc. in 2005 to introduce
 * support for mandatory and extensible security protections.  This notice
 * is included in support of clause 2.2 (b) of the Apple Public License,
 * Version 2.0.
 */</span>
<span class="enscript-comment">/*	$NetBSD: sem.h,v 1.5 1994/06/29 06:45:15 cgd Exp $	*/</span>

<span class="enscript-comment">/*
 * SVID compatible sem_internal.h file
 *
 * Author:  Daniel Boulet
 */</span>
<span class="enscript-comment">/*
 * John Bellardo modified the implementation for Darwin. 12/2000
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_SYS_SEM__INTERNALH_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_SYS_SEM__INTERNALH_</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/sem.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/cdefs.h&gt;</span>


<span class="enscript-comment">/*
 * This structure is variant for 64 bits because of sem_otime and sem_ctime.
 */</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">__DARWIN_ALIGN_NATURAL</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">options</span> <span class="enscript-variable-name">align</span>=<span class="enscript-variable-name">natural</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-type">struct</span> user_semid_ds {
	<span class="enscript-type">struct</span> ipc_perm sem_perm;	<span class="enscript-comment">/* [XSI] operation permission struct */</span>
	<span class="enscript-type">struct</span> sem	*sem_base;	<span class="enscript-comment">/* 32 bit base ptr for semaphore set */</span>
	<span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	sem_nsems;	<span class="enscript-comment">/* [XSI] number of sems in set */</span>
	user_time_t	sem_otime;	<span class="enscript-comment">/* [XSI] last operation time */</span>
	__int32_t	sem_pad1;	<span class="enscript-comment">/* RESERVED: DO NOT USE! */</span>
	user_time_t	sem_ctime;	<span class="enscript-comment">/* [XSI] last change time */</span>
    					<span class="enscript-comment">/* Times measured in secs since */</span>
    					<span class="enscript-comment">/* 00:00:00 GMT, Jan. 1, 1970 */</span>
	__int32_t	sem_pad2;	<span class="enscript-comment">/* RESERVED: DO NOT USE! */</span>
	__int32_t	sem_pad3[4];	<span class="enscript-comment">/* RESERVED: DO NOT USE! */</span>
};

#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">pack</span>(4)
<span class="enscript-type">struct</span> user64_semid_ds {
	<span class="enscript-type">struct</span> ipc_perm sem_perm;	<span class="enscript-comment">/* [XSI] operation permission struct */</span>
	int32_t	sem_base;	<span class="enscript-comment">/* 32 bit base ptr for semaphore set */</span>
	<span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	sem_nsems;	<span class="enscript-comment">/* [XSI] number of sems in set */</span>
	user64_time_t	sem_otime;	<span class="enscript-comment">/* [XSI] last operation time */</span>
	int32_t	sem_pad1;	<span class="enscript-comment">/* RESERVED: DO NOT USE! */</span>
	user64_time_t	sem_ctime;	<span class="enscript-comment">/* [XSI] last change time */</span>
    					<span class="enscript-comment">/* Times measured in secs since */</span>
    					<span class="enscript-comment">/* 00:00:00 GMT, Jan. 1, 1970 */</span>
	int32_t	sem_pad2;	<span class="enscript-comment">/* RESERVED: DO NOT USE! */</span>
	int32_t	sem_pad3[4];	<span class="enscript-comment">/* RESERVED: DO NOT USE! */</span>
};

<span class="enscript-type">struct</span> user32_semid_ds {
	<span class="enscript-type">struct</span> ipc_perm sem_perm;	<span class="enscript-comment">/* [XSI] operation permission struct */</span>
	int32_t	sem_base;	<span class="enscript-comment">/* 32 bit base ptr for semaphore set */</span>
	<span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	sem_nsems;	<span class="enscript-comment">/* [XSI] number of sems in set */</span>
	user32_time_t	sem_otime;	<span class="enscript-comment">/* [XSI] last operation time */</span>
	int32_t	sem_pad1;	<span class="enscript-comment">/* RESERVED: DO NOT USE! */</span>
	user32_time_t	sem_ctime;	<span class="enscript-comment">/* [XSI] last change time */</span>
    					<span class="enscript-comment">/* Times measured in secs since */</span>
    					<span class="enscript-comment">/* 00:00:00 GMT, Jan. 1, 1970 */</span>
	int32_t	sem_pad2;	<span class="enscript-comment">/* RESERVED: DO NOT USE! */</span>
	int32_t	sem_pad3[4];	<span class="enscript-comment">/* RESERVED: DO NOT USE! */</span>
};
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">pack</span>()

<span class="enscript-type">union</span> user_semun {
	user_addr_t	buf;		<span class="enscript-comment">/* buffer for IPC_STAT &amp; IPC_SET */</span>
	user_addr_t	array;		<span class="enscript-comment">/* array for GETALL &amp; SETALL */</span>
};
<span class="enscript-type">typedef</span> <span class="enscript-type">union</span> user_semun user_semun_t;

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">__DARWIN_ALIGN_NATURAL</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">options</span> <span class="enscript-variable-name">align</span>=<span class="enscript-variable-name">reset</span>
#<span class="enscript-reference">endif</span>


<span class="enscript-comment">/*
 * Kernel implementation stuff
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SEMVMX</span>	32767		<span class="enscript-comment">/* semaphore maximum value */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SEMAEM</span>	16384		<span class="enscript-comment">/* adjust on exit max value */</span>

<span class="enscript-comment">/*
 * Configuration parameters.  SEMMNI, SEMMNS, and SEMMNU are hard limits.
 * The code dynamically allocates enough memory to satisfy the current
 * demand in even increments of SEMMNI_INC, SEMMNS_INC, and SEMMNU_INC.
 * The code will never allocate more than the hard limits.  The *_INC's
 * are defined in the kernel section of the header.
 */</span>
<span class="enscript-comment">/*
 * Configuration parameters
 */</span>
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">SEMMNS</span>			<span class="enscript-comment">/* # of semaphores in system */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SEMMNS</span>	(1048576/sizeof(struct sem))
#<span class="enscript-reference">endif</span>				<span class="enscript-comment">/* no more than 1M of semaphore data */</span>
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">SEMMNI</span>			<span class="enscript-comment">/* # of semaphore identifiers */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SEMMNI</span>	SEMMNS		<span class="enscript-comment">/* max of 1 for each semaphore */</span>
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">SEMUME</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SEMUME</span>	10		<span class="enscript-comment">/* max # of undo entries per process */</span>
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">SEMMNU</span>			<span class="enscript-comment">/* # of undo structures in system */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SEMMNU</span>	SEMMNS		<span class="enscript-comment">/* 1 for each semaphore.  This is quite large */</span>
#<span class="enscript-reference">endif</span>				<span class="enscript-comment">/* This should be max 1 for each process */</span>

<span class="enscript-comment">/* shouldn't need tuning */</span>
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">SEMMAP</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SEMMAP</span>	30		<span class="enscript-comment">/* # of entries in semaphore map */</span>
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">SEMMSL</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SEMMSL</span>	SEMMNS		<span class="enscript-comment">/* max # of semaphores per id */</span>
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">SEMOPM</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SEMOPM</span>	5		<span class="enscript-comment">/* max # of operations per semop call */</span>
#<span class="enscript-reference">endif</span>


<span class="enscript-comment">/*
 * Undo structure (internal: one per process)
 */</span>
<span class="enscript-type">struct</span> sem_undo {
	<span class="enscript-type">int</span> 	un_next_idx;	<span class="enscript-comment">/* index of next active undo structure */</span>
	<span class="enscript-type">struct</span>	proc *un_proc;		<span class="enscript-comment">/* owner of this structure */</span>
	<span class="enscript-type">short</span>	un_cnt;			<span class="enscript-comment">/* # of active entries */</span>
	<span class="enscript-type">struct</span> undo {
		<span class="enscript-type">short</span>	une_adjval;	<span class="enscript-comment">/* adjust on exit values */</span>
		<span class="enscript-type">short</span>	une_num;	<span class="enscript-comment">/* semaphore # */</span>
		<span class="enscript-type">int</span>	une_id;		<span class="enscript-comment">/* semid */</span>
		<span class="enscript-type">struct</span> undo *une_next;	<span class="enscript-comment">/* next undo entry */</span>
	} *un_ent;			<span class="enscript-comment">/* undo entries */</span>
};

<span class="enscript-comment">/*
 * semaphore info struct (internal; for administrative limits and ipcs)
 */</span>
<span class="enscript-type">struct</span> seminfo {
	<span class="enscript-type">int</span>	semmap,		<span class="enscript-comment">/* # of entries in semaphore map */</span>
		semmni,		<span class="enscript-comment">/* # of semaphore identifiers */</span>
		semmns,		<span class="enscript-comment">/* # of semaphores in system */</span>
		semmnu,		<span class="enscript-comment">/* # of undo structures in system */</span>
		semmsl,		<span class="enscript-comment">/* max # of semaphores per id */</span>
		semopm,		<span class="enscript-comment">/* max # of operations per semop call */</span>
		semume,		<span class="enscript-comment">/* max # of undo entries per process */</span>
		semusz,		<span class="enscript-comment">/* size in bytes of undo structure */</span>
		semvmx,		<span class="enscript-comment">/* semaphore maximum value */</span>
		semaem;		<span class="enscript-comment">/* adjust on exit max value */</span>
};
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> seminfo	seminfo;

<span class="enscript-comment">/*
 * Kernel wrapper for the user-level structure
 */</span>
<span class="enscript-type">struct</span> semid_kernel {
	<span class="enscript-type">struct</span>	user_semid_ds u;
	<span class="enscript-type">struct</span>	label *label;	<span class="enscript-comment">/* MAC framework label */</span>
};


<span class="enscript-comment">/* internal &quot;mode&quot; bits */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">SEM_ALLOC</span>	01000	<span class="enscript-comment">/* semaphore is allocated */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">SEM_DEST</span>	02000	<span class="enscript-comment">/* semaphore will be destroyed on last detach */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SEMMNI_INC</span>	8	<span class="enscript-comment">/* increment value for semaphore identifiers */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SEMMNS_INC</span>	64	<span class="enscript-comment">/* increment value for semaphores */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SEMMNU_INC</span>	32	<span class="enscript-comment">/* increment value for undo structures */</span>

<span class="enscript-comment">/*
 * Due to the way semaphore memory is allocated, we have to ensure that
 * SEMUSZ is properly aligned.
 *
 * We are not doing strange semaphore memory allocation anymore, so
 * these macros are no longer needed.
 */</span>

<span class="enscript-comment">/*
 * #define SEM_ALIGN(bytes) (((bytes) + (sizeof(long) - 1)) &amp; ~(sizeof(long) - 1))
 */</span>

<span class="enscript-comment">/* actual size of an undo structure */</span>
<span class="enscript-comment">/*
 * #define SEMUSZ	SEM_ALIGN(offsetof(struct sem_undo, un_ent[SEMUME]))
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SEMUSZ</span>		sizeof(struct sem_undo)

<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> semid_kernel	*sema;		<span class="enscript-comment">/* semaphore id pool */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> sem		*sem_pool;	<span class="enscript-comment">/* semaphore pool */</span>
<span class="enscript-comment">/* This is now a struct sem_undo with the new memory allocation 
 * extern int	*semu;		// undo structure pool
 */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> sem_undo	*semu;		<span class="enscript-comment">/* undo structure pool */</span>

<span class="enscript-comment">/*
 * Macro to find a particular sem_undo vector
 */</span>
<span class="enscript-comment">/* Until we can initialize seminfo.semusz to SEMUSZ, we hard code the size macro
 * in SEMU.  This should be fixed when (if) we implement dynamic pool sizes
 *
 * #define SEMU(ix)     ((struct sem_undo *)(((intptr_t)semu)+ix * seminfo.semusz))
 */</span>
<span class="enscript-comment">/*
 * This macro doesn't work because we are using a staticly allocated array
 * for semu now.
 * #define SEMU(ix)        ((struct sem_undo *)(((intptr_t)semu)+ix * SEMUSZ)) 
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">SEMU</span>(ix)        (&amp;semu[ix])


<span class="enscript-comment">/*
 * Process sem_undo vectors at proc exit.
 */</span>
<span class="enscript-type">void</span>	semexit(<span class="enscript-type">struct</span> proc *p);

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !_SYS_SEM__INTERNALH_ */</span>
</pre>
<hr />
</body></html>