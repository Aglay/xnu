<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>decmpfs.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">decmpfs.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2008 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_SYS_DECMPFS_H_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_SYS_DECMPFS_H_</span> 1

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/kernel_types.h&gt;</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MAX_DECMPFS_XATTR_SIZE</span> 3802

<span class="enscript-comment">/*
 NOTE:  decmpfs can only be used by thread-safe filesystems
 */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DECMPFS_MAGIC</span> 0x636d7066 <span class="enscript-comment">/* cmpf */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DECMPFS_XATTR_NAME</span> <span class="enscript-string">&quot;com.apple.decmpfs&quot;</span> <span class="enscript-comment">/* extended attribute to use for decmpfs */</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> <span class="enscript-function-name">__attribute__</span>((packed)) {
    <span class="enscript-comment">/* this structure represents the xattr on disk; the fields below are little-endian */</span>
    uint32_t compression_magic;
    uint32_t compression_type;     <span class="enscript-comment">/* see the enum below */</span>
    uint64_t uncompressed_size;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> attr_bytes[0];   <span class="enscript-comment">/* the bytes of the attribute after the header */</span>
} decmpfs_disk_header;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> <span class="enscript-function-name">__attribute__</span>((packed)) {
    <span class="enscript-comment">/* this structure represents the xattr in memory; the fields below are host-endian */</span>
    uint32_t attr_size;
    uint32_t compression_magic;
    uint32_t compression_type;
    uint64_t uncompressed_size;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> attr_bytes[0];   <span class="enscript-comment">/* the bytes of the attribute after the header */</span>
} decmpfs_header;

<span class="enscript-comment">/* compression_type values */</span>
<span class="enscript-type">enum</span> {
    CMP_Type1       = 1, <span class="enscript-comment">/* uncompressed data in xattr */</span>
    
    <span class="enscript-comment">/* additional types defined in AppleFSCompression project */</span>
    
    CMP_MAX         = 255 <span class="enscript-comment">/* Highest compression_type supported */</span>
};

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
    <span class="enscript-type">void</span> *buf;
    user_ssize_t size;
} decmpfs_vector;

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">KERNEL</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">XNU_KERNEL_PRIVATE</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/locks.h&gt;</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> decmpfs_cnode {
    uint8_t cmp_state;
    uint8_t cmp_minimal_xattr;       <span class="enscript-comment">/* if non-zero, this file's com.apple.decmpfs xattr contained only the minimal decmpfs_disk_header */</span>
    uint32_t cmp_type;
    uint32_t lockcount;
    <span class="enscript-type">void</span>    *lockowner;              <span class="enscript-comment">/* cnode's lock owner (if a thread is currently holding an exclusive lock) */</span>
    uint64_t uncompressed_size __attribute__((aligned(8)));
    uint64_t decompression_flags;
    lck_rw_t compressed_data_lock;
} decmpfs_cnode;

<span class="enscript-comment">/* return values from decmpfs_file_is_compressed */</span>
<span class="enscript-type">enum</span> {
    FILE_TYPE_UNKNOWN      = 0,
    FILE_IS_NOT_COMPRESSED = 1,
    FILE_IS_COMPRESSED     = 2,
    FILE_IS_CONVERTING     = 3  <span class="enscript-comment">/* file is converting from compressed to decompressed */</span>
};

<span class="enscript-comment">/* vfs entrypoints */</span>
<span class="enscript-type">extern</span> vfs_context_t decmpfs_ctx;

<span class="enscript-comment">/* client filesystem entrypoints */</span>
<span class="enscript-type">void</span> <span class="enscript-function-name">decmpfs_init</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">void</span> <span class="enscript-function-name">decmpfs_cnode_init</span>(decmpfs_cnode *cp);
<span class="enscript-type">void</span> <span class="enscript-function-name">decmpfs_cnode_destroy</span>(decmpfs_cnode *cp);

<span class="enscript-type">int</span> <span class="enscript-function-name">decmpfs_hides_rsrc</span>(vfs_context_t ctx, decmpfs_cnode *cp);
<span class="enscript-type">int</span> <span class="enscript-function-name">decmpfs_hides_xattr</span>(vfs_context_t ctx, decmpfs_cnode *cp, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *xattr);

boolean_t <span class="enscript-function-name">decmpfs_trylock_compressed_data</span>(decmpfs_cnode *cp, <span class="enscript-type">int</span> exclusive);
<span class="enscript-type">void</span> <span class="enscript-function-name">decmpfs_lock_compressed_data</span>(decmpfs_cnode *cp, <span class="enscript-type">int</span> exclusive);
<span class="enscript-type">void</span> <span class="enscript-function-name">decmpfs_unlock_compressed_data</span>(decmpfs_cnode *cp, <span class="enscript-type">int</span> exclusive);

uint32_t <span class="enscript-function-name">decmpfs_cnode_get_vnode_state</span>(decmpfs_cnode *cp);
<span class="enscript-type">void</span> <span class="enscript-function-name">decmpfs_cnode_set_vnode_state</span>(decmpfs_cnode *cp, uint32_t state, <span class="enscript-type">int</span> skiplock);
uint64_t <span class="enscript-function-name">decmpfs_cnode_get_vnode_cached_size</span>(decmpfs_cnode *cp);

<span class="enscript-type">int</span> <span class="enscript-function-name">decmpfs_file_is_compressed</span>(vnode_t vp, decmpfs_cnode *cp);
errno_t <span class="enscript-function-name">decmpfs_validate_compressed_file</span>(vnode_t vp, decmpfs_cnode *cp);
<span class="enscript-type">int</span> <span class="enscript-function-name">decmpfs_decompress_file</span>(vnode_t vp, decmpfs_cnode *cp, off_t toSize, <span class="enscript-type">int</span> truncate_okay, <span class="enscript-type">int</span> skiplock);  <span class="enscript-comment">/* if toSize == -1, decompress the entire file */</span>
<span class="enscript-type">int</span> <span class="enscript-function-name">decmpfs_free_compressed_data</span>(vnode_t vp, decmpfs_cnode *cp);
<span class="enscript-type">int</span> <span class="enscript-function-name">decmpfs_update_attributes</span>(vnode_t vp, <span class="enscript-type">struct</span> vnode_attr *vap);
<span class="enscript-comment">/* the following two routines will set *is_compressed to 0 if the file was converted from compressed to decompressed before data could be fetched from the decompressor */</span>
errno_t <span class="enscript-function-name">decmpfs_pagein_compressed</span>(<span class="enscript-type">struct</span> vnop_pagein_args *ap, <span class="enscript-type">int</span> *is_compressed, decmpfs_cnode *cp);
errno_t <span class="enscript-function-name">decmpfs_read_compressed</span>(<span class="enscript-type">struct</span> vnop_read_args *ap, <span class="enscript-type">int</span> *is_compressed, decmpfs_cnode *cp);

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* XNU_KERNEL_PRIVATE */</span>

<span class="enscript-comment">/* types shared between the kernel and kexts */</span>
<span class="enscript-type">typedef</span> <span class="enscript-function-name">int</span> (*decmpfs_validate_compressed_file_func)(vnode_t vp, vfs_context_t ctx, decmpfs_header *hdr);
<span class="enscript-type">typedef</span> <span class="enscript-function-name">void</span> (*decmpfs_adjust_fetch_region_func)(vnode_t vp, vfs_context_t ctx, decmpfs_header *hdr, off_t *offset, user_ssize_t *size);
<span class="enscript-type">typedef</span> <span class="enscript-function-name">int</span> (*decmpfs_fetch_uncompressed_data_func)(vnode_t vp, vfs_context_t ctx, decmpfs_header *hdr, off_t offset, user_ssize_t size, <span class="enscript-type">int</span> nvec, decmpfs_vector *vec, uint64_t *bytes_read);
<span class="enscript-type">typedef</span> <span class="enscript-function-name">int</span> (*decmpfs_free_compressed_data_func)(vnode_t vp, vfs_context_t ctx, decmpfs_header *hdr);
<span class="enscript-type">typedef</span> <span class="enscript-function-name">uint64_t</span> (*decmpfs_get_decompression_flags_func)(vnode_t vp, vfs_context_t ctx, decmpfs_header *hdr); <span class="enscript-comment">// returns flags from the DECMPFS_FLAGS enumeration below
</span>
<span class="enscript-type">enum</span> {
    DECMPFS_FLAGS_FORCE_FLUSH_ON_DECOMPRESS = 1 &lt;&lt; 0,
};

<span class="enscript-comment">/* Versions that are supported for binary compatibility */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DECMPFS_REGISTRATION_VERSION_V1</span> 1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DECMPFS_REGISTRATION_VERSION_V3</span> 3

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DECMPFS_REGISTRATION_VERSION</span> (DECMPFS_REGISTRATION_VERSION_V3)

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
    <span class="enscript-type">int</span>                                   decmpfs_registration;
    decmpfs_validate_compressed_file_func validate;
    decmpfs_adjust_fetch_region_func      adjust_fetch;
    decmpfs_fetch_uncompressed_data_func  fetch;
    decmpfs_free_compressed_data_func     free_data;
    decmpfs_get_decompression_flags_func  get_flags;
} decmpfs_registration;

<span class="enscript-comment">/* hooks for kexts to call */</span>
errno_t <span class="enscript-function-name">register_decmpfs_decompressor</span>(uint32_t compression_type, decmpfs_registration *registration);
errno_t <span class="enscript-function-name">unregister_decmpfs_decompressor</span>(uint32_t compression_type, decmpfs_registration *registration);

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL */</span>

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* _SYS_DECMPFS_H_ */</span>
</pre>
<hr />
</body></html>