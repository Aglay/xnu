<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>dtrace_glue.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">dtrace_glue.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2005-2006 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_DTRACE_GLUE_H</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_DTRACE_GLUE_H</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL_BUILD</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/libkern.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/locks.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/thread_call.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/thread.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;machine/machine_routines.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/syslog.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/ucred.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdarg.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/kmod.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/OSAtomic.h&gt;</span>

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__i386__</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__x86_64__</span>)
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/mp.h&gt;</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">/*
 * cmn_err
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CE_CONT</span>		0	<span class="enscript-comment">/* continuation		*/</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CE_NOTE</span>		1	<span class="enscript-comment">/* notice		*/</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CE_WARN</span>		2	<span class="enscript-comment">/* warning		*/</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CE_PANIC</span>	3	<span class="enscript-comment">/* panic		*/</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CE_IGNORE</span>	4	<span class="enscript-comment">/* print nothing	*/</span>

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">cmn_err</span>( <span class="enscript-type">int</span>, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *, ... );

<span class="enscript-comment">/*
 * pid/proc
 */</span>

<span class="enscript-comment">/* Solaris proc_t is the struct. Darwin's proc_t is a pointer to it. */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">proc_t</span> struct proc <span class="enscript-comment">/* Steer clear of the Darwin typedef for proc_t */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">curproc</span> ((struct proc *)current_proc()) <span class="enscript-comment">/* Called from probe context, must blacklist */</span>

proc_t* <span class="enscript-function-name">sprlock</span>(pid_t pid);
<span class="enscript-type">void</span> <span class="enscript-function-name">sprunlock</span>(proc_t *p);

<span class="enscript-comment">/*
 * uread/uwrite
 */</span>

<span class="enscript-type">int</span> <span class="enscript-function-name">uread</span>(proc_t *p, <span class="enscript-type">void</span> *buf, user_size_t len, user_addr_t a);
<span class="enscript-type">int</span> <span class="enscript-function-name">uwrite</span>(proc_t *p, <span class="enscript-type">void</span> *buf, user_size_t len, user_addr_t a);

<span class="enscript-comment">/*
 * fuword / suword
 */</span>

<span class="enscript-type">int</span> <span class="enscript-function-name">fuword8</span>(user_addr_t, uint8_t *);
<span class="enscript-type">int</span> <span class="enscript-function-name">fuword16</span>(user_addr_t, uint16_t *);
<span class="enscript-type">int</span> <span class="enscript-function-name">fuword32</span>(user_addr_t, uint32_t *);
<span class="enscript-type">int</span> <span class="enscript-function-name">fuword64</span>(user_addr_t, uint64_t *);

<span class="enscript-type">void</span> <span class="enscript-function-name">fuword8_noerr</span>(user_addr_t, uint8_t *);
<span class="enscript-type">void</span> <span class="enscript-function-name">fuword16_noerr</span>(user_addr_t, uint16_t *);
<span class="enscript-type">void</span> <span class="enscript-function-name">fuword32_noerr</span>(user_addr_t, uint32_t *);
<span class="enscript-type">void</span> <span class="enscript-function-name">fuword64_noerr</span>(user_addr_t, uint64_t *);

<span class="enscript-type">int</span> <span class="enscript-function-name">suword64</span>(user_addr_t, uint64_t value);
<span class="enscript-type">int</span> <span class="enscript-function-name">suword32</span>(user_addr_t, uint32_t value);
<span class="enscript-type">int</span> <span class="enscript-function-name">suword16</span>(user_addr_t, uint16_t value);
<span class="enscript-type">int</span> <span class="enscript-function-name">suword8</span>(user_addr_t, uint8_t value);

<span class="enscript-comment">/*
 * cpuvar
 */</span>
<span class="enscript-type">extern</span> lck_mtx_t cpu_lock;
<span class="enscript-type">extern</span> lck_mtx_t cyc_lock;
<span class="enscript-type">extern</span> lck_mtx_t mod_lock;

<span class="enscript-comment">/*
 * wrap_timer_call: wrapper of timer_call for cyclic timers.
 */</span>
<span class="enscript-type">struct</span> wrap_timer_call;

<span class="enscript-comment">/*
 * Per-CPU data.
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> dtrace_cpu {
	processorid_t   cpu_id;                    <span class="enscript-comment">/* CPU number */</span>
	<span class="enscript-type">struct</span> dtrace_cpu *cpu_next;                 <span class="enscript-comment">/* next existing CPU */</span>
	lck_rw_t        cpu_ft_lock;               <span class="enscript-comment">/* DTrace: fasttrap lock */</span>
	uintptr_t       cpu_dtrace_caller;         <span class="enscript-comment">/* DTrace: caller, if any */</span>
	hrtime_t        cpu_dtrace_chillmark;      <span class="enscript-comment">/* DTrace: chill mark time */</span>
	hrtime_t        cpu_dtrace_chilled;        <span class="enscript-comment">/* DTrace: total chill time */</span>
	boolean_t       cpu_dtrace_invop_underway; <span class="enscript-comment">/* DTrace gaurds against invalid op re-entrancy */</span>

	<span class="enscript-comment">/* Local cyclic timers on this CPU */</span>
	LIST_HEAD(cyc_list_head, wrap_timer_call) cpu_cyc_list;
} dtrace_cpu_t;

<span class="enscript-type">extern</span> dtrace_cpu_t *cpu_list;

<span class="enscript-comment">/*
 * The cpu_core structure consists of per-CPU state available in any context.
 * On some architectures, this may mean that the page(s) containing the
 * NCPU-sized array of cpu_core structures must be locked in the TLB -- it
 * is up to the platform to assure that this is performed properly.  Note that
 * the structure is sized to avoid false sharing.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CPU_CACHE_COHERENCE_SIZE</span>	64

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> cpu_core {
	uint64_t	cpuc_dtrace_illval;     <span class="enscript-comment">/* DTrace illegal value */</span>
	lck_mtx_t	cpuc_pid_lock;          <span class="enscript-comment">/* DTrace pid provider lock */</span>
	uint16_t	cpuc_dtrace_flags;      <span class="enscript-comment">/* DTrace flags */</span>
        uint64_t	cpuc_missing_tos;	<span class="enscript-comment">/* Addr. of top most stack frame if missing */</span>
        uint8_t		cpuc_pad[CPU_CACHE_COHERENCE_SIZE - <span class="enscript-keyword">sizeof</span>(uint64_t) - <span class="enscript-keyword">sizeof</span>(lck_mtx_t) - <span class="enscript-keyword">sizeof</span>(uint16_t) - <span class="enscript-keyword">sizeof</span>(uint64_t) ];	<span class="enscript-comment">/* padding */</span>
} cpu_core_t;

<span class="enscript-type">extern</span> cpu_core_t *cpu_core;

<span class="enscript-type">extern</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> dtrace_max_cpus;		<span class="enscript-comment">/* max number of enabled cpus */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">NCPU</span>	    dtrace_max_cpus

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">cpu_number</span>(<span class="enscript-type">void</span>); <span class="enscript-comment">/* From #include &lt;kern/cpu_number.h&gt;. Called from probe context, must blacklist. */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CPU</span>		(&amp;(cpu_list[cpu_number()]))	<span class="enscript-comment">/* Pointer to current CPU */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">CPU_ON_INTR</span>(cpup) ml_at_interrupt_context() <span class="enscript-comment">/* always invoked on current cpu */</span>

<span class="enscript-comment">/*
 * Routines used to register interest in cpu's being added to or removed
 * from the system.
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> {
	CPU_INIT,
	CPU_CONFIG,
	CPU_UNCONFIG,
	CPU_ON,
	CPU_OFF,
	CPU_CPUPART_IN,
	CPU_CPUPART_OUT
} cpu_setup_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">int</span> <span class="enscript-function-name">cpu_setup_func_t</span>(cpu_setup_t, <span class="enscript-type">int</span>, <span class="enscript-type">void</span> *);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">register_cpu_setup_func</span>(cpu_setup_func_t *, <span class="enscript-type">void</span> *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">unregister_cpu_setup_func</span>(cpu_setup_func_t *, <span class="enscript-type">void</span> *);

<span class="enscript-comment">/*
 * CPU_DTRACE
 */</span>

<span class="enscript-comment">/*
 * DTrace flags.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CPU_DTRACE_NOFAULT</span>	0x0001	<span class="enscript-comment">/* Don't fault */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CPU_DTRACE_DROP</span>		0x0002	<span class="enscript-comment">/* Drop this ECB */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CPU_DTRACE_BADADDR</span>	0x0004	<span class="enscript-comment">/* DTrace fault: bad address */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CPU_DTRACE_BADALIGN</span>	0x0008	<span class="enscript-comment">/* DTrace fault: bad alignment */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CPU_DTRACE_DIVZERO</span>	0x0010	<span class="enscript-comment">/* DTrace fault: divide by zero */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CPU_DTRACE_ILLOP</span>	0x0020	<span class="enscript-comment">/* DTrace fault: illegal operation */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CPU_DTRACE_NOSCRATCH</span>	0x0040	<span class="enscript-comment">/* DTrace fault: out of scratch */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CPU_DTRACE_KPRIV</span>	0x0080	<span class="enscript-comment">/* DTrace fault: bad kernel access */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CPU_DTRACE_UPRIV</span>	0x0100	<span class="enscript-comment">/* DTrace fault: bad user access */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CPU_DTRACE_TUPOFLOW</span>	0x0200	<span class="enscript-comment">/* DTrace fault: tuple stack overflow */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CPU_DTRACE_USTACK_FP</span>	0x0400  <span class="enscript-comment">/* pid provider hint to ustack() */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CPU_DTRACE_ENTRY</span>	0x0800	<span class="enscript-comment">/* pid provider hint to ustack() */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CPU_DTRACE_BADSTACK</span> 0x1000  <span class="enscript-comment">/* DTrace fault: bad stack */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CPU_DTRACE_FAULT</span>	(CPU_DTRACE_BADADDR | CPU_DTRACE_BADALIGN | \
				CPU_DTRACE_DIVZERO | CPU_DTRACE_ILLOP | \
				CPU_DTRACE_NOSCRATCH | CPU_DTRACE_KPRIV | \
				CPU_DTRACE_UPRIV | CPU_DTRACE_TUPOFLOW | \
				CPU_DTRACE_BADSTACK)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CPU_DTRACE_ERROR</span>	(CPU_DTRACE_FAULT | CPU_DTRACE_DROP)

<span class="enscript-comment">/*
 * Loadable Modules
 */</span>

<span class="enscript-comment">/* Keep the compiler happy */</span>
<span class="enscript-type">struct</span> dtrace_module_symbols;

<span class="enscript-comment">/* Solaris' modctl structure, greatly simplified, shadowing parts of xnu kmod structure. */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> modctl {
	<span class="enscript-type">struct</span> modctl	*mod_next;
	<span class="enscript-type">struct</span> modctl	*mod_stale;     <span class="enscript-comment">// stale module chain
</span>	uint32_t	mod_id;		<span class="enscript-comment">// the kext unique identifier
</span>	<span class="enscript-type">char</span>		mod_modname[KMOD_MAX_NAME];
	<span class="enscript-type">int</span>		mod_loadcnt;
	<span class="enscript-type">char</span>		mod_loaded;
	uint16_t	mod_flags;	<span class="enscript-comment">// See flags below
</span>	<span class="enscript-type">int</span>		mod_nenabled;	<span class="enscript-comment">// # of enabled DTrace probes in module
</span>	vm_address_t	mod_address;	<span class="enscript-comment">// starting address (of Mach-o header blob)
</span>	vm_size_t	mod_size;	<span class="enscript-comment">// total size (of blob)
</span>	UUID		mod_uuid;
	<span class="enscript-type">struct</span> dtrace_module_symbols* mod_user_symbols;
} modctl_t;

<span class="enscript-comment">/* Definitions for mod_flags */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MODCTL_IS_MACH_KERNEL</span>			0x01  // This module represents /mach_kernel
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MODCTL_HAS_KERNEL_SYMBOLS</span>		0x02  // Kernel symbols (nlist) are available
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MODCTL_FBT_PROBES_PROVIDED</span>      	0x04  // fbt probes have been provided
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MODCTL_FBT_INVALID</span>			0x08  // Module is invalid for fbt probes
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MODCTL_SDT_PROBES_PROVIDED</span>		0x10  // sdt probes have been provided
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MODCTL_SDT_INVALID</span>			0x20  // Module is invalid for sdt probes
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MODCTL_HAS_UUID</span>				0x40  // Module has UUID
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MODCTL_FBT_PRIVATE_PROBES_PROVIDED</span>	0x80  // fbt private probes have been provided
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MODCTL_FBT_PROVIDE_PRIVATE_PROBES</span>	0x100 // fbt provider must provide private probes

<span class="enscript-comment">/* Simple/singular mod_flags accessors */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MOD_IS_MACH_KERNEL</span>(mod)			(mod-&gt;mod_flags &amp; MODCTL_IS_MACH_KERNEL)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MOD_HAS_KERNEL_SYMBOLS</span>(mod)		(mod-&gt;mod_flags &amp; MODCTL_HAS_KERNEL_SYMBOLS)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MOD_HAS_USERSPACE_SYMBOLS</span>(mod)		(mod-&gt;mod_user_symbols) <span class="enscript-comment">/* No point in duplicating state in the flags bits */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MOD_FBT_PROBES_PROVIDED</span>(mod)   		(mod-&gt;mod_flags &amp; MODCTL_FBT_PROBES_PROVIDED)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MOD_FBT_INVALID</span>(mod)			(mod-&gt;mod_flags &amp; MODCTL_FBT_INVALID)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MOD_SDT_PROBES_PROVIDED</span>(mod)   		(mod-&gt;mod_flags &amp; MODCTL_SDT_PROBES_PROVIDED)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MOD_SDT_INVALID</span>(mod)			(mod-&gt;mod_flags &amp; MODCTL_SDT_INVALID)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MOD_HAS_UUID</span>(mod)			(mod-&gt;mod_flags &amp; MODCTL_HAS_UUID)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MOD_FBT_PRIVATE_PROBES_PROVIDED</span>(mod)	(mod-&gt;mod_flags &amp; MODCTL_FBT_PRIVATE_PROBES_PROVIDED)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MOD_FBT_PROVIDE_PRIVATE_PROBES</span>(mod)	(mod-&gt;mod_flags &amp; MODCTL_FBT_PROVIDE_PRIVATE_PROBES)

<span class="enscript-comment">/* Compound accessors */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MOD_FBT_PRIVATE_PROBES_DONE</span>(mod)	(MOD_FBT_PRIVATE_PROBES_PROVIDED(mod) || !MOD_FBT_PROVIDE_PRIVATE_PROBES(mod))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MOD_FBT_DONE</span>(mod)			((MOD_FBT_PROBES_PROVIDED(mod) &amp;&amp; MOD_FBT_PRIVATE_PROBES_DONE(mod)) || MOD_FBT_INVALID(mod))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MOD_SDT_DONE</span>(mod)			(MOD_SDT_PROBES_PROVIDED(mod) || MOD_SDT_INVALID(mod))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">MOD_SYMBOLS_DONE</span>(mod)			(MOD_FBT_DONE(mod) &amp;&amp; MOD_SDT_DONE(mod))

<span class="enscript-type">extern</span> modctl_t *dtrace_modctl_list;

<span class="enscript-comment">/*
 * cred_t
 */</span>
<span class="enscript-comment">/* Privileges */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PRIV_DTRACE_KERNEL</span>        3
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PRIV_DTRACE_PROC</span>          4
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PRIV_DTRACE_USER</span>          5
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PRIV_PROC_OWNER</span>          30
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PRIV_PROC_ZONE</span>           35
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PRIV_ALL</span>			(-1)	<span class="enscript-comment">/* All privileges required */</span>

<span class="enscript-comment">/* Privilege sets */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PRIV_EFFECTIVE</span>            0

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> ucred cred_t;
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">cr_suid</span> cr_svuid
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">cr_sgid</span> cr_svgid

<span class="enscript-type">extern</span> cred_t *<span class="enscript-function-name">dtrace_CRED</span>(<span class="enscript-type">void</span>); <span class="enscript-comment">/* Safe to call from probe context. */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">CRED</span>() kauth_cred_get() <span class="enscript-comment">/* Can't be called from probe context! */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">PRIV_POLICY_CHOICE</span>(<span class="enscript-type">void</span> *, <span class="enscript-type">int</span>, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">PRIV_POLICY_ONLY</span>(<span class="enscript-type">void</span> *, <span class="enscript-type">int</span>, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> gid_t <span class="enscript-function-name">crgetgid</span>(<span class="enscript-type">const</span> cred_t *);
<span class="enscript-type">extern</span> uid_t <span class="enscript-function-name">crgetuid</span>(<span class="enscript-type">const</span> cred_t *);
#<span class="enscript-reference">define</span> <span class="enscript-function-name">crgetzoneid</span>(x) ((zoneid_t)0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">crhold</span>(a) {}
#<span class="enscript-reference">define</span> <span class="enscript-function-name">crfree</span>(a) {}

<span class="enscript-comment">/*
 * &quot;cyclic&quot;
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CY_LOW_LEVEL</span>		0
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CY_LOCK_LEVEL</span>		1
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CY_HIGH_LEVEL</span>		2
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CY_SOFT_LEVELS</span>		2
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CY_LEVELS</span>			3

<span class="enscript-type">typedef</span> uintptr_t cyclic_id_t;
<span class="enscript-type">typedef</span> cyclic_id_t *cyclic_id_list_t;
<span class="enscript-type">typedef</span> uint16_t cyc_level_t;
<span class="enscript-type">typedef</span> <span class="enscript-function-name">void</span> (*cyc_func_t)(<span class="enscript-type">void</span> *);

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CYCLIC_NONE</span>		((cyclic_id_t)0)

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> cyc_time {
	hrtime_t cyt_when;
	hrtime_t cyt_interval;
} cyc_time_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> cyc_handler {
	cyc_func_t cyh_func;
	<span class="enscript-type">void</span> *cyh_arg;
	cyc_level_t cyh_level;
} cyc_handler_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> cyc_omni_handler {
	<span class="enscript-type">void</span> (*cyo_online)(<span class="enscript-type">void</span> *, dtrace_cpu_t *, cyc_handler_t *, cyc_time_t *);
	<span class="enscript-type">void</span> (*cyo_offline)(<span class="enscript-type">void</span> *, dtrace_cpu_t *, <span class="enscript-type">void</span> *);
	<span class="enscript-type">void</span> *cyo_arg;
} cyc_omni_handler_t;

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">dtrace_install_cpu_hooks</span>(<span class="enscript-type">void</span>);

<span class="enscript-type">extern</span> cyclic_id_t <span class="enscript-function-name">cyclic_add</span>(cyc_handler_t *, cyc_time_t *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">cyclic_remove</span>(cyclic_id_t);

<span class="enscript-type">extern</span> cyclic_id_list_t <span class="enscript-function-name">cyclic_add_omni</span>(cyc_omni_handler_t *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">cyclic_remove_omni</span>(cyclic_id_list_t);

<span class="enscript-type">extern</span> cyclic_id_t <span class="enscript-function-name">cyclic_timer_add</span>(cyc_handler_t *, cyc_time_t *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">cyclic_timer_remove</span>(cyclic_id_t);

<span class="enscript-comment">/*
 * timeout / untimeout (converted to dtrace_timeout / dtrace_untimeout due to name collision)
 */</span>

thread_call_t <span class="enscript-function-name">dtrace_timeout</span>(<span class="enscript-type">void</span> (*func)(<span class="enscript-type">void</span> *, <span class="enscript-type">void</span> *), <span class="enscript-type">void</span>* arg, uint64_t nanos);

<span class="enscript-comment">/*
 * ddi
 */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DDI_SUCCESS</span>			0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DDI_FAILURE</span>			-1

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DDI_DEV_T_NONE</span>	((dev_t)-1)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DDI_DEV_T_ANY</span>	((dev_t)-2)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DDI_MAJOR_T_UNKNOWN</span>	((major_t)0)

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DDI_PSEUDO</span> <span class="enscript-string">&quot;ddi_pseudo&quot;</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> {
	DDI_ATTACH = 0,
	DDI_RESUME = 1,
	DDI_PM_RESUME = 2
} ddi_attach_cmd_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> {
	DDI_DETACH = 0,
	DDI_SUSPEND = 1,
	DDI_PM_SUSPEND = 2,
	DDI_HOTPLUG_DETACH = 3		<span class="enscript-comment">/* detach, don't try to auto-unconfig */</span>
} ddi_detach_cmd_t;

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DDI_PROP_SUCCESS</span>	0

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DDI_PROP_DONTPASS</span>   1
<span class="enscript-type">typedef</span> uint_t major_t;
<span class="enscript-type">typedef</span> uint_t minor_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> __dev_info *dev_info_t;

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ddi_report_dev</span>(dev_info_t *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">ddi_soft_state_init</span>(<span class="enscript-type">void</span> **, size_t, size_t);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> *<span class="enscript-function-name">ddi_get_soft_state</span>(<span class="enscript-type">void</span> *, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">ddi_soft_state_free</span>(<span class="enscript-type">void</span> *, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">ddi_soft_state_zalloc</span>(<span class="enscript-type">void</span> *, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ddi_soft_state_fini</span>(<span class="enscript-type">void</span> **);

<span class="enscript-type">int</span> <span class="enscript-function-name">ddi_getprop</span>(dev_t dev, dev_info_t *dip, <span class="enscript-type">int</span> flags, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *name, <span class="enscript-type">int</span> defvalue);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">ddi_prop_free</span>(<span class="enscript-type">void</span> *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">ddi_prop_lookup_int_array</span>(dev_t, dev_info_t *, uint_t, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *, <span class="enscript-type">int</span> **, uint_t *);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">ddi_driver_major</span>(dev_info_t *);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">ddi_create_minor_node</span>(dev_info_t *, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *, <span class="enscript-type">int</span>, minor_t, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ddi_remove_minor_node</span>(dev_info_t *, <span class="enscript-type">char</span> *);

<span class="enscript-type">extern</span> major_t <span class="enscript-function-name">getemajor</span>(dev_t);
<span class="enscript-type">extern</span> minor_t <span class="enscript-function-name">getminor</span>(dev_t);

<span class="enscript-type">extern</span> dev_t <span class="enscript-function-name">makedevice</span>(major_t, minor_t);

<span class="enscript-comment">/*
 * Kernel Debug Interface
 */</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> kdi_dtrace_set {
	KDI_DTSET_DTRACE_ACTIVATE,
	KDI_DTSET_DTRACE_DEACTIVATE,
	KDI_DTSET_KMDB_BPT_ACTIVATE,
	KDI_DTSET_KMDB_BPT_DEACTIVATE
} kdi_dtrace_set_t;

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">kdi_dtrace_set</span>(kdi_dtrace_set_t);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">debug_enter</span>(<span class="enscript-type">char</span> *);

<span class="enscript-comment">/*
 * DTrace specific zone allocation
 */</span>

<span class="enscript-comment">/*
 * To break dtrace memory usage out in a trackable
 * fashion, uncomment the #define below. This will
 * enable emulation of the general kalloc.XXX zones
 * for most dtrace allocations. (kalloc.large is not
 * emulated)
 *
 * #define DTRACE_MEMORY_ZONES 1
 *
 */</span>

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">DTRACE_MEMORY_ZONES</span>)
<span class="enscript-type">void</span> <span class="enscript-function-name">dtrace_alloc_init</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">void</span> *<span class="enscript-function-name">dtrace_alloc</span>(vm_size_t);
<span class="enscript-type">void</span> <span class="enscript-function-name">dtrace_free</span>(<span class="enscript-type">void</span> *, vm_size_t);
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">/*
 * kmem
 */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KM_SLEEP</span>	0x00000000
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KM_NOSLEEP</span>	0x00000001

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> vmem vmem_t;
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> kmem_cache kmem_cache_t;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kmem_alloc</span> dt_kmem_alloc <span class="enscript-comment">/* Avoid clash with Darwin's kmem_alloc */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kmem_free</span> dt_kmem_free <span class="enscript-comment">/* Avoid clash with Darwin's kmem_free */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kmem_zalloc</span> dt_kmem_zalloc <span class="enscript-comment">/* Avoid clash with Darwin's kmem_zalloc */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> *<span class="enscript-function-name">dt_kmem_alloc</span>(size_t, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">dt_kmem_free</span>(<span class="enscript-type">void</span> *, size_t);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> *<span class="enscript-function-name">dt_kmem_zalloc</span>(size_t, <span class="enscript-type">int</span>);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> *<span class="enscript-function-name">dt_kmem_alloc_aligned</span>(size_t, size_t, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> *<span class="enscript-function-name">dt_kmem_zalloc_aligned</span>(size_t, size_t, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">dt_kmem_free_aligned</span>(<span class="enscript-type">void</span>*, size_t);

<span class="enscript-type">extern</span> kmem_cache_t *
<span class="enscript-function-name">kmem_cache_create</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *, size_t, size_t, <span class="enscript-type">int</span> (*)(<span class="enscript-type">void</span> *, <span class="enscript-type">void</span> *, <span class="enscript-type">int</span>),
	<span class="enscript-type">void</span> (*)(<span class="enscript-type">void</span> *, <span class="enscript-type">void</span> *), <span class="enscript-type">void</span> (*)(<span class="enscript-type">void</span> *), <span class="enscript-type">void</span> *, vmem_t *, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> *<span class="enscript-function-name">kmem_cache_alloc</span>(kmem_cache_t *, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">kmem_cache_free</span>(kmem_cache_t *, <span class="enscript-type">void</span> *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">kmem_cache_destroy</span>(kmem_cache_t *);

<span class="enscript-comment">/*
 * kthread
 */</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> _kthread kthread_t; <span class="enscript-comment">/* For dtrace_vtime_switch(), dtrace_panicked and dtrace_errthread */</span>

<span class="enscript-comment">/*
 * proc
 */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DATAMODEL_MASK</span>  0x0FF00000

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DATAMODEL_ILP32</span> 0x00100000
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DATAMODEL_LP64</span>  0x00200000

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DATAMODEL_NONE</span>  0

#<span class="enscript-reference">if</span>     <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__LP64__</span>)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DATAMODEL_NATIVE</span>        DATAMODEL_LP64
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DATAMODEL_NATIVE</span>        DATAMODEL_ILP32
#<span class="enscript-reference">endif</span>  <span class="enscript-comment">/* __LP64__ */</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> model_t; <span class="enscript-comment">/* For dtrace_instr_size_isa() prototype in &lt;sys/dtrace.h&gt; */</span>

<span class="enscript-comment">/*
 * taskq
 */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">TQ_SLEEP</span>	0x00	<span class="enscript-comment">/* Can block for memory */</span>

<span class="enscript-type">typedef</span> uint_t pri_t;
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> taskq taskq_t;
<span class="enscript-type">typedef</span> <span class="enscript-function-name">void</span> (task_func_t)(<span class="enscript-type">void</span> *);
<span class="enscript-type">typedef</span> uintptr_t taskqid_t;

<span class="enscript-type">extern</span> taskq_t	*taskq_create(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *, <span class="enscript-type">int</span>, pri_t, <span class="enscript-type">int</span>, <span class="enscript-type">int</span>, uint_t);
<span class="enscript-type">extern</span> taskqid_t <span class="enscript-function-name">taskq_dispatch</span>(taskq_t *, task_func_t, <span class="enscript-type">void</span> *, uint_t);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>	taskq_destroy(taskq_t *);

<span class="enscript-type">extern</span> pri_t maxclsyspri;

<span class="enscript-comment">/*
 * vmem
 */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">VMC_IDENTIFIER</span>	0x00040000	<span class="enscript-comment">/* not backed by memory */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">VM_SLEEP</span>	0x00000000	<span class="enscript-comment">/* same as KM_SLEEP */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">VM_BESTFIT</span>	0x00000100

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> *<span class="enscript-function-name">vmem_alloc</span>(vmem_t *, size_t, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> vmem_t *<span class="enscript-function-name">vmem_create</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *, <span class="enscript-type">void</span> *, size_t, size_t, <span class="enscript-type">void</span> *,
					<span class="enscript-type">void</span> *, vmem_t *, size_t, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">vmem_destroy</span>(vmem_t *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">vmem_free</span>(vmem_t *vmp, <span class="enscript-type">void</span> *vaddr, size_t size);

<span class="enscript-comment">/*
 * Atomic
 */</span>

<span class="enscript-type">static</span> inline <span class="enscript-type">void</span> <span class="enscript-function-name">atomic_add_32</span>( uint32_t *theAddress, int32_t theAmount )
{
	(<span class="enscript-type">void</span>)OSAddAtomic( theAmount, theAddress );
}

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__i386__</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__x86_64__</span>)
<span class="enscript-type">static</span> inline <span class="enscript-type">void</span> <span class="enscript-function-name">atomic_add_64</span>( uint64_t *theAddress, int64_t theAmount )
{
	(<span class="enscript-type">void</span>)OSAddAtomic64( theAmount, (SInt64 *)theAddress );
}
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">/*
 * Miscellaneous
 */</span>

<span class="enscript-type">typedef</span> uintptr_t pc_t;
<span class="enscript-type">typedef</span> uintptr_t greg_t; <span class="enscript-comment">/* For dtrace_impl.h prototype of dtrace_getfp() */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> regs *<span class="enscript-function-name">find_user_regs</span>( thread_t thread);
<span class="enscript-type">extern</span> vm_offset_t <span class="enscript-function-name">dtrace_get_cpu_int_stack_top</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> vm_offset_t <span class="enscript-function-name">max_valid_stack_address</span>(<span class="enscript-type">void</span>); <span class="enscript-comment">/* kern/thread.h */</span>

<span class="enscript-type">extern</span> <span class="enscript-type">volatile</span> <span class="enscript-type">int</span> panicwait; <span class="enscript-comment">/* kern/debug.c */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">panic_quiesce</span> (panicwait)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IS_P2ALIGNED</span>(v, a) ((((uintptr_t)(v)) &amp; ((uintptr_t)(a) - 1)) == 0)

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">delay</span>( <span class="enscript-type">int</span> ); <span class="enscript-comment">/* kern/clock.h */</span>

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">vuprintf</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *, va_list);

<span class="enscript-type">extern</span> hrtime_t <span class="enscript-function-name">dtrace_abs_to_nano</span>(uint64_t);

__private_extern__ <span class="enscript-type">const</span> <span class="enscript-type">char</span> * strstr(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *);

#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">proc_t</span>

<span class="enscript-comment">/*
 * Safe counted string compare against a literal string. The sizeof() intentionally
 * counts the trailing NUL, and so ensures that all the characters in the literal
 * can participate in the comparison.
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">LIT_STRNEQL</span>(s1, lit_s2) (0 == strncmp( (s1), (lit_s2), sizeof((lit_s2)) ))

<span class="enscript-comment">/*
 * Safe counted string compare of a literal against the beginning of a string. Here
 * the sizeof() is reduced by 1 so that the trailing null of the literal does not
 * participate in the comparison.
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">LIT_STRNSTART</span>(s1, lit_s2) (0 == strncmp( (s1), (lit_s2), sizeof((lit_s2)) - 1 ))

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KERNELBASE</span> VM_MIN_KERNEL_ADDRESS
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL_BUILD */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* _DTRACE_GLUE_H */</span>

</pre>
<hr />
</body></html>