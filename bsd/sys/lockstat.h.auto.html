<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>lockstat.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">lockstat.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * CDDL HEADER START
 *
 * The contents of this file are subject to the terms of the
 * Common Development and Distribution License, Version 1.0 only
 * (the &quot;License&quot;).  You may not use this file except in compliance
 * with the License.
 *
 * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE
 * or <a href="http://www.opensolaris.org/os/licensing.">http://www.opensolaris.org/os/licensing.</a>
 * See the License for the specific language governing permissions
 * and limitations under the License.
 *
 * When distributing Covered Code, include this CDDL HEADER in each
 * file and include the License file at usr/src/OPENSOLARIS.LICENSE.
 * If applicable, add the following below this CDDL HEADER, with the
 * fields enclosed by brackets &quot;[]&quot; replaced with your own identifying
 * information: Portions Copyright [yyyy] [name of copyright owner]
 *
 * CDDL HEADER END
 */</span>
<span class="enscript-comment">/*
 * Copyright 1997-2003 Sun Microsystems, Inc.  All rights reserved.
 * Use is subject to license terms.
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_SYS_LOCKSTAT_H</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">_SYS_LOCKSTAT_H</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">/* #pragma ident	&quot;@(#)lockstat.h	1.6	05/06/08 SMI&quot; */</span>

#<span class="enscript-reference">ifdef</span>	<span class="enscript-variable-name">__cplusplus</span>
<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> {
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">/*
 * Spin locks - we have less variants
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_SPIN_LOCK_ACQUIRE</span>	0
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_SPIN_LOCK_SPIN</span>		1
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_SPIN_UNLOCK_RELEASE</span>	2
<span class="enscript-comment">/*
 * Mutexes can also have interlock-spin events, which are
 * unique to our lock implementation.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_MTX_LOCK_ACQUIRE</span>			3
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_MTX_LOCK_BLOCK</span>			5
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_MTX_LOCK_SPIN</span>			6
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_MTX_LOCK_ILK_SPIN</span>		7
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_MTX_TRY_LOCK_ACQUIRE</span>		8
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_MTX_TRY_SPIN_LOCK_ACQUIRE</span>	9
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_MTX_UNLOCK_RELEASE</span>		10

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LS_LCK_MTX_LOCK_SPIN_ACQUIRE</span>		39
<span class="enscript-comment">/*
 * Provide a parallel set for indirect mutexes
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_MTX_EXT_LOCK_ACQUIRE</span>			17
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_MTX_EXT_LOCK_BLOCK</span>			18
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_MTX_EXT_LOCK_SPIN</span>			19
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_MTX_EXT_LOCK_ILK_SPIN</span>		20
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_MTX_TRY_EXT_LOCK_ACQUIRE</span>		21
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_MTX_EXT_UNLOCK_RELEASE</span>		22
<span class="enscript-comment">/*
 * Our reader-writer locks support a blocking upgrade primitive, as
 * well as the possibility of spinning on the interlock.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_RW_LOCK_SHARED_ACQUIRE</span>		23
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_RW_LOCK_SHARED_BLOCK</span>		24
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_RW_LOCK_SHARED_SPIN</span>		25

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_RW_LOCK_EXCL_ACQUIRE</span>		26
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_RW_LOCK_EXCL_BLOCK</span>		27
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_RW_LOCK_EXCL_SPIN</span>		28

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_RW_DONE_RELEASE</span>			29

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_RW_TRY_LOCK_SHARED_ACQUIRE</span>	30
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_RW_TRY_LOCK_SHARED_SPIN</span>		31

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_RW_TRY_LOCK_EXCL_ACQUIRE</span>		32
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_RW_TRY_LOCK_EXCL_ILK_SPIN</span>	33

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_RW_LOCK_SHARED_TO_EXCL_UPGRADE</span>	34
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_RW_LOCK_SHARED_TO_EXCL_SPIN</span>	35
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_RW_LOCK_SHARED_TO_EXCL_BLOCK</span>	36

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_RW_LOCK_EXCL_TO_SHARED_DOWNGRADE</span>	37
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_RW_LOCK_EXCL_TO_SHARED_ILK_SPIN</span>	38

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_NPROBES</span>			40
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LS_LCK_INVALID</span>			LS_NPROBES

<span class="enscript-comment">/*
 * Name the various locking functions...
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_MTX_LOCK</span>			<span class="enscript-string">&quot;lck_mtx_lock&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_MTX_SPIN_LOCK</span>		<span class="enscript-string">&quot;lck_mtx_spin_lock&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_MTX_UNLOCK</span>		<span class="enscript-string">&quot;lck_mtx_unlock&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_MTX_TRY_LOCK</span>		<span class="enscript-string">&quot;lck_mtx_try_lock&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_MTX_TRY_SPIN_LOCK</span>	<span class="enscript-string">&quot;lck_mtx_try_spin_lock&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_MTX_EXT_LOCK</span>		<span class="enscript-string">&quot;lck_mtx_ext_lock&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_MTX_EXT_UNLOCK</span>		<span class="enscript-string">&quot;lck_mtx_ext_unlock&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_MTX_EXT_TRY_LOCK</span>		<span class="enscript-string">&quot;lck_mtx_ext_try_lock&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_MTX_LOCK_SPIN_LOCK</span>	<span class="enscript-string">&quot;lck_mtx_lock_spin&quot;</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_SPIN_LOCK</span>		<span class="enscript-string">&quot;lck_spin_lock&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_SPIN_TRY_LOCK</span>		<span class="enscript-string">&quot;lck_spin_try_lock&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_SPIN_UNLOCK</span>		<span class="enscript-string">&quot;lck_spin_unlock&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_RW_LOCK_SHARED</span>		<span class="enscript-string">&quot;lck_rw_lock_shared&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_RW_LOCK_EXCL</span>		<span class="enscript-string">&quot;lck_rw_lock_exclusive&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_RW_DONE</span>			<span class="enscript-string">&quot;lck_rw_done&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_RW_TRY_LOCK_EXCL</span>		<span class="enscript-string">&quot;lck_rw_try_lock_exclusive&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_RW_TRY_LOCK_SHARED</span>	<span class="enscript-string">&quot;lck_rw_try_lock_shared&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_RW_LOCK_SHARED_TO_EXCL</span>	<span class="enscript-string">&quot;lck_rw_shared_to_exclusive&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_LCK_RW_LOCK_EXCL_TO_SHARED</span>	<span class="enscript-string">&quot;lck_rw_exclusive_to_shared&quot;</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_ACQUIRE</span>			<span class="enscript-string">&quot;acquire&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_RELEASE</span>			<span class="enscript-string">&quot;release&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_SPIN</span>				<span class="enscript-string">&quot;spin&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_BLOCK</span>			<span class="enscript-string">&quot;block&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_UPGRADE</span>			<span class="enscript-string">&quot;upgrade&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_DOWNGRADE</span>			<span class="enscript-string">&quot;downgrade&quot;</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_TYPE_ADAPTIVE</span>		<span class="enscript-string">&quot;adaptive&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_TYPE_SPIN</span>			<span class="enscript-string">&quot;spin&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_TYPE_ILK</span>			<span class="enscript-string">&quot;interlock&quot;</span>	<span class="enscript-comment">/* OS X only */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_TYPE_THREAD</span>			<span class="enscript-string">&quot;thread&quot;</span>	<span class="enscript-comment">/* Solaris only */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_TYPE_RW</span>			<span class="enscript-string">&quot;rw&quot;</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LS_TYPE_RWUPGRADE</span>		<span class="enscript-string">&quot;rwupgrade&quot;</span>	<span class="enscript-comment">/* OS X only */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LSA_ACQUIRE</span>			(LS_TYPE_ADAPTIVE <span class="enscript-string">&quot;-&quot;</span> LS_ACQUIRE)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LSA_RELEASE</span>			(LS_TYPE_ADAPTIVE <span class="enscript-string">&quot;-&quot;</span> LS_RELEASE)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LSA_SPIN</span>			(LS_TYPE_ADAPTIVE <span class="enscript-string">&quot;-&quot;</span> LS_SPIN)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LSA_BLOCK</span>			(LS_TYPE_ADAPTIVE <span class="enscript-string">&quot;-&quot;</span> LS_BLOCK)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LSA_ILK_SPIN</span>			(LS_TYPE_ILK <span class="enscript-string">&quot;-&quot;</span> LS_SPIN)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LSS_ACQUIRE</span>			(LS_TYPE_SPIN <span class="enscript-string">&quot;-&quot;</span> LS_ACQUIRE)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LSS_RELEASE</span>			(LS_TYPE_SPIN <span class="enscript-string">&quot;-&quot;</span> LS_RELEASE)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LSS_SPIN</span>			(LS_TYPE_SPIN <span class="enscript-string">&quot;-&quot;</span> LS_SPIN)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LSR_ACQUIRE</span>			(LS_TYPE_RW <span class="enscript-string">&quot;-&quot;</span> LS_ACQUIRE)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LSR_RELEASE</span>			(LS_TYPE_RW <span class="enscript-string">&quot;-&quot;</span> LS_RELEASE)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LSR_BLOCK</span>			(LS_TYPE_RW <span class="enscript-string">&quot;-&quot;</span> LS_BLOCK)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LSR_SPIN</span>			(LS_TYPE_RW <span class="enscript-string">&quot;-&quot;</span> LS_SPIN)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LSR_UPGRADE</span>			(LS_TYPE_RW <span class="enscript-string">&quot;-&quot;</span> LS_UPGRADE)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LSR_UPGRADE_BLOCK</span>		(LS_TYPE_RWUPGRADE <span class="enscript-string">&quot;-&quot;</span> LS_BLOCK)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LSR_DOWNGRADE</span>			(LS_TYPE_RW <span class="enscript-string">&quot;-&quot;</span> LS_DOWNGRADE)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LST_SPIN</span>			(LS_TYPE_THREAD <span class="enscript-string">&quot;-&quot;</span> LS_SPIN)

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_ASM</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdint.h&gt;</span>
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_KERNEL</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_KERNEL</span> <span class="enscript-comment">/* Solaris vs. Darwin */</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">/*
 * Platform-independent kernel support for the lockstat driver.
 */</span>
#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">NEED_DTRACE_DEFS</span>)
<span class="enscript-type">typedef</span> uint32_t dtrace_id_t;		<span class="enscript-comment">/* probe identifier - also in dtrace.h! */</span>
<span class="enscript-type">typedef</span> uint64_t	u_longlong_t;	<span class="enscript-comment">/* also in dtrace.h! */</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-type">extern</span> dtrace_id_t lockstat_probemap[LS_NPROBES];
<span class="enscript-type">extern</span> <span class="enscript-function-name">void</span> (*lockstat_probe)(dtrace_id_t, uint64_t, uint64_t,
    uint64_t, uint64_t, uint64_t);



#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">_KERNEL</span>

#<span class="enscript-reference">if</span>	<span class="enscript-variable-name">CONFIG_DTRACE</span>

<span class="enscript-type">extern</span> <span class="enscript-function-name">void</span> (lockstat_probe_wrapper)(<span class="enscript-type">int</span>, uintptr_t, <span class="enscript-type">int</span>);
	
<span class="enscript-comment">/*
 * Macros to record lockstat probes.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">LOCKSTAT_RECORD4</span>(probe, lp, arg0, arg1, arg2, arg3)		\
	{								\
		dtrace_id_t id;						\
		<span class="enscript-keyword">if</span> ((id = lockstat_probemap[(probe)])) {		\
			(*lockstat_probe)(id, (uintptr_t)(lp), (arg0),	\
			    (arg1), (arg2), (arg3));			\
		}							\
	}

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">LOCKSTAT_RECORD2</span>(probe, lp, arg1, arg2)	\
	LOCKSTAT_RECORD4(probe, lp, arg1, arg2, 0, 0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">LOCKSTAT_RECORD</span>(probe, lp, arg)	\
	LOCKSTAT_RECORD4(probe, lp, arg, 0, 0, 0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">LOCKSTAT_RECORD0</span>(probe, lp)	\
	LOCKSTAT_RECORD4(probe, lp, 0, 0, 0, 0)
#<span class="enscript-reference">else</span>
	<span class="enscript-comment">/* No Lockstat provider */</span>

#<span class="enscript-reference">define</span> <span class="enscript-function-name">LOCKSTAT_RECORD</span>()
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">LOCKSTAT_RECORD0</span>()
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">LOCKSTAT_RECORD2</span>()
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">LOCKSTAT_RECORD4</span>()

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !CONFIG_DTRACE */</span>

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* _KERNEL */</span>

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* _ASM */</span>

#<span class="enscript-reference">ifdef</span>	<span class="enscript-variable-name">__cplusplus</span>
}
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* _SYS_LOCKSTAT_H */</span>

</pre>
<hr />
</body></html>