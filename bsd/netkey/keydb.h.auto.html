<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>keydb.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">keydb.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*	$KAME: keydb.h,v 1.9 2000/02/22 14:06:41 itojun Exp $	*/</span>

<span class="enscript-comment">/*
 * Copyright (C) 1995, 1996, 1997, and 1998 WIDE Project.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. Neither the name of the project nor the names of its contributors
 *    may be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE PROJECT AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE PROJECT OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_NETKEY_KEYDB_H_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_NETKEY_KEYDB_H_</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/appleapiopts.h&gt;</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">BSD_KERNEL_PRIVATE</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netkey/key_var.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/if_utun.h&gt;</span>

<span class="enscript-comment">/* Security Association Index */</span>
<span class="enscript-comment">/* NOTE: Ensure to be same address family */</span>
<span class="enscript-type">struct</span> secasindex {
	<span class="enscript-type">struct</span> sockaddr_storage src;	<span class="enscript-comment">/* srouce address for SA */</span>
	<span class="enscript-type">struct</span> sockaddr_storage dst;	<span class="enscript-comment">/* destination address for SA */</span>
	u_int16_t proto;		<span class="enscript-comment">/* IPPROTO_ESP or IPPROTO_AH */</span>
	u_int8_t mode;			<span class="enscript-comment">/* mode of protocol, see ipsec.h */</span>
	u_int32_t reqid;		<span class="enscript-comment">/* reqid id who owned this SA */</span>
					<span class="enscript-comment">/* see IPSEC_MANUAL_REQID_MAX. */</span>
	u_int ipsec_ifindex;
};

<span class="enscript-comment">/* Security Association Data Base */</span>
<span class="enscript-type">struct</span> secashead {
	LIST_ENTRY(secashead) chain;

	<span class="enscript-type">struct</span> secasindex saidx;

	<span class="enscript-type">struct</span> sadb_ident *idents;	<span class="enscript-comment">/* source identity */</span>
	<span class="enscript-type">struct</span> sadb_ident *identd;	<span class="enscript-comment">/* destination identity */</span>
					<span class="enscript-comment">/* XXX I don't know how to use them. */</span>

	ifnet_t ipsec_if;
	u_int outgoing_if;
	u_int8_t dir;                   <span class="enscript-comment">/* IPSEC_DIR_INBOUND or IPSEC_DIR_OUTBOUND */</span>
	u_int8_t state;			<span class="enscript-comment">/* MATURE or DEAD. */</span>
	LIST_HEAD(_satree, secasvar) savtree[SADB_SASTATE_MAX+1];
					<span class="enscript-comment">/* SA chain */</span>
					<span class="enscript-comment">/* The first of this list is newer SA */</span>

	<span class="enscript-type">struct</span> route sa_route;		<span class="enscript-comment">/* route cache */</span>
};

<span class="enscript-type">typedef</span> <span class="enscript-function-name">int</span> (*utun_is_keepalive_func) __P((<span class="enscript-type">void</span> *, <span class="enscript-type">void</span> *, u_int16_t, u_int32_t, size_t));
<span class="enscript-type">typedef</span> <span class="enscript-function-name">int</span> (*utun_input_func) __P((<span class="enscript-type">void</span> *, <span class="enscript-type">void</span> *, protocol_family_t family));

<span class="enscript-comment">/* Security Association */</span>
<span class="enscript-type">struct</span> secasvar {
	LIST_ENTRY(secasvar) chain;
	LIST_ENTRY(secasvar) spihash;
	<span class="enscript-type">int</span> refcnt;			<span class="enscript-comment">/* reference count */</span>
	u_int8_t state;			<span class="enscript-comment">/* Status of this Association */</span>

	u_int8_t alg_auth;		<span class="enscript-comment">/* Authentication Algorithm Identifier*/</span>
	u_int8_t alg_enc;		<span class="enscript-comment">/* Cipher Algorithm Identifier */</span>
	u_int32_t spi;			<span class="enscript-comment">/* SPI Value, network byte order */</span>
	u_int32_t flags;		<span class="enscript-comment">/* holder for SADB_KEY_FLAGS */</span>
	u_int16_t flags2;		<span class="enscript-comment">/* holder for SADB_SA2_KEY_FLAGS */</span>

	<span class="enscript-type">struct</span> sadb_key *key_auth;	<span class="enscript-comment">/* Key for Authentication */</span>
	<span class="enscript-type">struct</span> sadb_key *key_enc;	<span class="enscript-comment">/* Key for Encryption */</span>
	caddr_t iv;			<span class="enscript-comment">/* Initilization Vector */</span>
	u_int ivlen;			<span class="enscript-comment">/* length of IV */</span>
	<span class="enscript-type">void</span> *sched;			<span class="enscript-comment">/* intermediate encryption key */</span>
	size_t schedlen;

	<span class="enscript-type">struct</span> secreplay *replay;	<span class="enscript-comment">/* replay prevention */</span>
	<span class="enscript-type">long</span> created;			<span class="enscript-comment">/* for lifetime */</span>

	<span class="enscript-type">struct</span> sadb_lifetime *lft_c;	<span class="enscript-comment">/* CURRENT lifetime, it's constant. */</span>
	<span class="enscript-type">struct</span> sadb_lifetime *lft_h;	<span class="enscript-comment">/* HARD lifetime */</span>
	<span class="enscript-type">struct</span> sadb_lifetime *lft_s;	<span class="enscript-comment">/* SOFT lifetime */</span>

	<span class="enscript-type">struct</span> socket *so; <span class="enscript-comment">/* Associated socket */</span>

	u_int32_t seq;			<span class="enscript-comment">/* sequence number */</span>
	pid_t pid;			<span class="enscript-comment">/* message's pid */</span>

	<span class="enscript-type">struct</span> secashead *sah;		<span class="enscript-comment">/* back pointer to the secashead */</span>
	
	<span class="enscript-comment">/* Nat Traversal related bits */</span>
	u_int32_t	natt_last_activity;
	u_int16_t	remote_ike_port;
	u_int16_t	natt_encapsulated_src_port;	<span class="enscript-comment">/* network byte order */</span>
	u_int16_t	natt_interval; <span class="enscript-comment">/* Interval in seconds */</span>
	u_int16_t	natt_offload_interval; <span class="enscript-comment">/* Hardware Offload Interval in seconds */</span>
	
	u_int8_t	always_expire; <span class="enscript-comment">/* Send expire/delete messages even if unused */</span>

	<span class="enscript-type">void</span>              *utun_pcb;
	utun_is_keepalive_func    utun_is_keepalive_fn;
	utun_input_func    utun_in_fn;
};

<span class="enscript-comment">/* replay prevention */</span>
<span class="enscript-type">struct</span> secreplay {
	u_int32_t count;
	u_int wsize;		<span class="enscript-comment">/* window size, i.g. 4 bytes */</span>
	u_int32_t seq;		<span class="enscript-comment">/* used by sender */</span>
	u_int32_t lastseq;	<span class="enscript-comment">/* used by receiver */</span>
	caddr_t bitmap;		<span class="enscript-comment">/* used by receiver */</span>
	<span class="enscript-type">int</span> overflow;		<span class="enscript-comment">/* overflow flag */</span>
};

<span class="enscript-comment">/* socket table due to send PF_KEY messages. */</span>
<span class="enscript-type">struct</span> secreg {
	LIST_ENTRY(secreg) chain;

	<span class="enscript-type">struct</span> socket *so;
};

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">IPSEC_NONBLOCK_ACQUIRE</span>
<span class="enscript-comment">/* acquiring list table. */</span>
<span class="enscript-type">struct</span> secacq {
	LIST_ENTRY(secacq) chain;

	<span class="enscript-type">struct</span> secasindex saidx;

	u_int32_t seq;		<span class="enscript-comment">/* sequence number */</span>
	<span class="enscript-type">long</span> created;		<span class="enscript-comment">/* for lifetime */</span>
	<span class="enscript-type">int</span> count;		<span class="enscript-comment">/* for lifetime */</span>
};
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">/* Sensitivity Level Specification */</span>
<span class="enscript-comment">/* nothing */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SADB_KILL_INTERVAL</span>	600	<span class="enscript-comment">/* six seconds */</span>

<span class="enscript-type">struct</span> key_cb {
	<span class="enscript-type">int</span> key_count;
	<span class="enscript-type">int</span> any_count;
};

<span class="enscript-comment">/* secpolicy */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> secpolicy *<span class="enscript-function-name">keydb_newsecpolicy</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">keydb_delsecpolicy</span>(<span class="enscript-type">struct</span> secpolicy *);
<span class="enscript-comment">/* secashead */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> secashead *<span class="enscript-function-name">keydb_newsecashead</span>(<span class="enscript-type">void</span>);
<span class="enscript-comment">// extern void keydb_delsecashead(struct secashead *);	// not used
</span><span class="enscript-comment">/* secasvar */</span>
<span class="enscript-comment">// extern struct secasvar *keydb_newsecasvar(void);		// not used
</span><span class="enscript-comment">// extern void keydb_refsecasvar(struct secasvar *);	// not used
</span><span class="enscript-comment">// extern void keydb_freesecasvar(struct secasvar *);	// not used
</span><span class="enscript-comment">/* secreplay */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> secreplay *<span class="enscript-function-name">keydb_newsecreplay</span>(size_t);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">keydb_delsecreplay</span>(<span class="enscript-type">struct</span> secreplay *);
<span class="enscript-comment">/* secreg */</span>
<span class="enscript-comment">// extern struct secreg *keydb_newsecreg(void);			// not used
</span><span class="enscript-comment">// extern void keydb_delsecreg(struct secreg *);		// not used
</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* BSD_KERNEL_PRIVATE */</span>

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* _NETKEY_KEYDB_H_ */</span>
</pre>
<hr />
</body></html>