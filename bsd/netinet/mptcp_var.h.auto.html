<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>mptcp_var.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">mptcp_var.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2012-2015 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 *
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 *
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 *
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_NETINET_MPTCP_VAR_H_</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">_NETINET_MPTCP_VAR_H_</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">PRIVATE</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/in.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/tcp.h&gt;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">BSD_KERNEL_PRIVATE</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/queue.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/protosw.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/locks.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/boolean.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/mp_pcb.h&gt;</span>

<span class="enscript-comment">/*
 * MPTCP Session
 *
 * This is an extension to the multipath PCB specific for MPTCP, protected by
 * the per-PCB mpp_lock (also the socket's lock); MPTCP thread signalling uses
 * its own mpte_thread_lock due to lock ordering constraints.
 */</span>
<span class="enscript-type">struct</span> mptses {
	<span class="enscript-type">struct</span> mppcb	*mpte_mppcb;		<span class="enscript-comment">/* back ptr to multipath PCB */</span>
	<span class="enscript-type">struct</span> mptcb	*mpte_mptcb;		<span class="enscript-comment">/* ptr to MPTCP PCB */</span>
	TAILQ_HEAD(, mptopt) mpte_sopts;	<span class="enscript-comment">/* list of socket options */</span>
	TAILQ_HEAD(, mptsub) mpte_subflows;	<span class="enscript-comment">/* list of subflows */</span>
	uint16_t	mpte_numflows;		<span class="enscript-comment">/* # of subflows in list */</span>
	uint16_t	mpte_nummpcapflows;	<span class="enscript-comment">/* # of MP_CAP subflows */</span>
	sae_associd_t	mpte_associd;		<span class="enscript-comment">/* MPTCP association ID */</span>
	sae_connid_t	mpte_connid_last;	<span class="enscript-comment">/* last used connection ID */</span>
	<span class="enscript-comment">/*
	 * Threading (protected by mpte_thread_lock)
	 */</span>
	decl_lck_mtx_data(, mpte_thread_lock);	<span class="enscript-comment">/* thread lock */</span>
	<span class="enscript-type">struct</span> thread	*mpte_thread;		<span class="enscript-comment">/* worker thread */</span>
	uint32_t	mpte_thread_active;	<span class="enscript-comment">/* thread is running */</span>
	uint32_t	mpte_thread_reqs;	<span class="enscript-comment">/* # of requests for thread */</span>
	<span class="enscript-type">struct</span> mptsub	*mpte_active_sub;	<span class="enscript-comment">/* ptr to last active subf */</span>
	uint8_t	mpte_flags;			<span class="enscript-comment">/* per mptcp session flags */</span>
	uint8_t	mpte_lost_aid;			<span class="enscript-comment">/* storing lost address id */</span>
	uint8_t	mpte_addrid_last;		<span class="enscript-comment">/* storing address id parm */</span>
};

<span class="enscript-comment">/*
 * Valid values for mpte_flags.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTE_SND_REM_ADDR</span>	0x01		<span class="enscript-comment">/* Send Remove_addr option */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">mptompte</span>(mp)	((struct mptses *)(mp)-&gt;mpp_pcbe)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">MPTE_LOCK_ASSERT_HELD</span>(_mpte)					\
	lck_mtx_assert(&amp;(_mpte)-&gt;mpte_mppcb-&gt;mpp_lock, LCK_MTX_ASSERT_OWNED)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">MPTE_LOCK_ASSERT_NOTHELD</span>(_mpte)					\
	lck_mtx_assert(&amp;(_mpte)-&gt;mpte_mppcb-&gt;mpp_lock, LCK_MTX_ASSERT_NOTOWNED)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">MPTE_LOCK</span>(_mpte)						\
	lck_mtx_lock(&amp;(_mpte)-&gt;mpte_mppcb-&gt;mpp_lock)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">MPTE_LOCK_SPIN</span>(_mpte)						\
	lck_mtx_lock_spin(&amp;(_mpte)-&gt;mpte_mppcb-&gt;mpp_lock)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">MPTE_CONVERT_LOCK</span>(_mpte) do {					\
	MPTE_LOCK_ASSERT_HELD(_mpte);					\
	lck_mtx_convert_spin(&amp;(_mpte)-&gt;mpte_mppcb-&gt;mpp_lock);		\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">MPTE_UNLOCK</span>(_mpte)						\
	lck_mtx_unlock(&amp;(_mpte)-&gt;mpte_mppcb-&gt;mpp_lock)

<span class="enscript-comment">/*
 * MPTCP socket options
 */</span>
<span class="enscript-type">struct</span> mptopt {
	TAILQ_ENTRY(mptopt)	mpo_entry;	<span class="enscript-comment">/* glue to other options */</span>
	uint32_t		mpo_flags;	<span class="enscript-comment">/* see flags below */</span>
	<span class="enscript-type">int</span>			mpo_level;	<span class="enscript-comment">/* sopt_level */</span>
	<span class="enscript-type">int</span>			mpo_name;	<span class="enscript-comment">/* sopt_name */</span>
	<span class="enscript-type">int</span>			mpo_intval;	<span class="enscript-comment">/* sopt_val */</span>
};

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPOF_ATTACHED</span>		0x1	<span class="enscript-comment">/* attached to MP socket */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPOF_SUBFLOW_OK</span>		0x2	<span class="enscript-comment">/* can be issued on subflow socket */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPOF_INTERIM</span>		0x4	<span class="enscript-comment">/* has not been issued on any subflow */</span>

<span class="enscript-comment">/*
 * Structure passed down to TCP during subflow connection establishment
 * containing information pertaining to the MPTCP.
 */</span>
<span class="enscript-type">struct</span> mptsub_connreq {
	uint32_t	mpcr_type;	<span class="enscript-comment">/* see MPTSUB_CONNREQ_* below */</span>
	uint32_t	mpcr_ifscope;	<span class="enscript-comment">/* ifscope parameter to connectx(2) */</span>
	<span class="enscript-type">struct</span> proc	*mpcr_proc;	<span class="enscript-comment">/* process issuing connectx(2) */</span>
};

<span class="enscript-comment">/* valid values for mpcr_type */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTSUB_CONNREQ_MP_ENABLE</span>	1	<span class="enscript-comment">/* enable MPTCP */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTSUB_CONNREQ_MP_ADD</span>		2	<span class="enscript-comment">/* join an existing MPTCP */</span>

<span class="enscript-comment">/*
 * MPTCP subflow
 *
 * Protected by the the per-subflow mpts_lock.  Note that mpts_flags
 * and mpts_evctl are modified via atomic operations.
 */</span>
<span class="enscript-type">struct</span> mptsub {
	decl_lck_mtx_data(, mpts_lock);		<span class="enscript-comment">/* per-subflow lock */</span>
	TAILQ_ENTRY(mptsub)	mpts_entry;	<span class="enscript-comment">/* glue to peer subflows */</span>
	uint32_t		mpts_refcnt;	<span class="enscript-comment">/* reference count */</span>
	uint32_t		mpts_flags;	<span class="enscript-comment">/* see flags below */</span>
	uint32_t		mpts_evctl;	<span class="enscript-comment">/* subflow control events */</span>
	uint32_t		mpts_family;	<span class="enscript-comment">/* address family */</span>
	sae_connid_t		mpts_connid;	<span class="enscript-comment">/* subflow connection ID */</span>
	<span class="enscript-type">int</span>			mpts_oldintval;	<span class="enscript-comment">/* sopt_val before sosetopt  */</span>
	uint32_t		mpts_rank;	<span class="enscript-comment">/* subflow priority/rank */</span>
	int32_t			mpts_soerror;	<span class="enscript-comment">/* most recent subflow error */</span>
	<span class="enscript-type">struct</span> mptses		*mpts_mpte;	<span class="enscript-comment">/* back ptr to MPTCP session */</span>
	<span class="enscript-type">struct</span> socket		*mpts_socket;	<span class="enscript-comment">/* subflow socket */</span>
	<span class="enscript-type">struct</span> sockaddr_list	*mpts_src_sl;	<span class="enscript-comment">/* source list */</span>
	<span class="enscript-type">struct</span> sockaddr_list	*mpts_dst_sl;	<span class="enscript-comment">/* destination list */</span>
	<span class="enscript-type">struct</span> ifnet		*mpts_outif;	<span class="enscript-comment">/* outbound interface */</span>
	u_int64_t		mpts_sndnxt;	<span class="enscript-comment">/* next byte to send in mp so */</span>
	u_int32_t		mpts_rel_seq;	<span class="enscript-comment">/* running count of subflow # */</span>
	<span class="enscript-type">struct</span> protosw		*mpts_oprotosw;	<span class="enscript-comment">/* original protosw */</span>
	<span class="enscript-type">struct</span> mptsub_connreq	mpts_mpcr;	<span class="enscript-comment">/* connection request */</span>
	int32_t			mpts_srtt;	<span class="enscript-comment">/* tcp's rtt estimate */</span>
	int32_t			mpts_rxtcur;	<span class="enscript-comment">/* tcp's rto estimate */</span>
	uint32_t		mpts_probesoon;	<span class="enscript-comment">/* send probe after probeto */</span>
	uint32_t		mpts_probecnt;	<span class="enscript-comment">/* number of probes sent */</span>
	uint32_t		mpts_maxseg;	<span class="enscript-comment">/* cached value of t_maxseg */</span>
	uint32_t		mpts_peerswitch;<span class="enscript-comment">/* no of uses of backup so */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MPTSL_WIRED</span>		0x01
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MPTSL_WIFI</span>		0x02
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MPTSL_CELL</span>		0x04
	uint32_t		mpts_linktype;	<span class="enscript-comment">/* wired, wifi, cell */</span>
};

<span class="enscript-comment">/*
 * Valid values for mpts_flags.  In particular:
 *
 *    - MP_CAPABLE means that the connection is successfully established as
 *	MPTCP and data transfer may occur, but is not yet ready for multipath-
 *	related semantics until MP_READY.  I.e. if this is on the first subflow,
 *	it causes the MPTCP socket to transition to a connected state, except
 *	that additional subflows will not be established; they will be marked
 *	with PENDING and will be processed when the first subflow is marked
 *	with MP_READY.
 *
 *    - MP_READY implies that an MP_CAPABLE connection has been confirmed as
 *	an MPTCP connection.  See notes above.
 *
 *    - MP_DEGRADED implies that the connection has lost its MPTCP capabilities
 *	but data transfer on the MPTCP socket is unaffected.  Any existing
 *	PENDING subflows will be disconnected, and further attempts to connect
 *	additional subflows will be rejected.
 *
 * Note that these are per-subflow flags.  The setting and clearing of MP_READY
 * reflects the state of the MPTCP connection with regards to its multipath
 * semantics, via the MPTCPF_JOIN_READY flag.  Until that flag is set (meaning
 * until at least a subflow is marked with MP_READY), further connectx(2)
 * attempts to join will be queued.  When the flag is cleared (after it has
 * been set), further connectx(2) will fail (and existing queued ones will be
 * aborted) and the MPTCP connection loses all of its multipath semantics.
 *
 * Keep in sync with bsd/dev/dtrace/scripts/mptcp.d.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTSF_ATTACHED</span>		0x1	<span class="enscript-comment">/* attached to MPTCP PCB */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTSF_CONNECTING</span>	0x2	<span class="enscript-comment">/* connection was attempted */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTSF_CONNECT_PENDING</span>	0x4	<span class="enscript-comment">/* will connect when MPTCP is ready */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTSF_CONNECTED</span>		0x8	<span class="enscript-comment">/* connection is established */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTSF_DISCONNECTING</span>	0x10	<span class="enscript-comment">/* disconnection was attempted */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTSF_DISCONNECTED</span>	0x20	<span class="enscript-comment">/* has been disconnected */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTSF_MP_CAPABLE</span>	0x40	<span class="enscript-comment">/* connected as a MPTCP subflow */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTSF_MP_READY</span>		0x80	<span class="enscript-comment">/* MPTCP has been confirmed */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTSF_MP_DEGRADED</span>	0x100	<span class="enscript-comment">/* has lost its MPTCP capabilities */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTSF_SUSPENDED</span>		0x200	<span class="enscript-comment">/* write-side is flow controlled */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTSF_BOUND_IF</span>		0x400	<span class="enscript-comment">/* subflow bound to an interface */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTSF_BOUND_IP</span>		0x800	<span class="enscript-comment">/* subflow bound to a src address */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTSF_BOUND_PORT</span>	0x1000	<span class="enscript-comment">/* subflow bound to a src port */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTSF_PREFERRED</span>		0x2000	<span class="enscript-comment">/* primary/preferred subflow */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTSF_SOPT_OLDVAL</span>	0x4000	<span class="enscript-comment">/* old option value is valid */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTSF_SOPT_INPROG</span>	0x8000	<span class="enscript-comment">/* sosetopt in progress */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTSF_DELETEOK</span>		0x10000	<span class="enscript-comment">/* subflow can be deleted */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTSF_FAILINGOVER</span>	0x20000	<span class="enscript-comment">/* subflow not used for output */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTSF_ACTIVE</span>		0x40000	<span class="enscript-comment">/* subflow currently in use */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTSF_MPCAP_CTRSET</span>	0x80000	<span class="enscript-comment">/* mpcap counter */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MPTSF_FASTJ_SEND</span>	0x100000 <span class="enscript-comment">/* send data after SYN in MP_JOIN */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MPTSF_FASTJ_REQD</span>	0x200000 <span class="enscript-comment">/* fastjoin required */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MPTSF_USER_DISCONNECT</span>	0x400000 <span class="enscript-comment">/* User triggered disconnect */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTSF_BITS</span> \
	<span class="enscript-string">&quot;\020\1ATTACHED\2CONNECTING\3PENDING\4CONNECTED\5DISCONNECTING&quot;</span> \
	<span class="enscript-string">&quot;\6DISCONNECTED\7MP_CAPABLE\10MP_READY\11MP_DEGRADED\12SUSPENDED&quot;</span> \
	<span class="enscript-string">&quot;\13BOUND_IF\14BOUND_IP\15BOUND_PORT\16PREFERRED\17SOPT_OLDVAL&quot;</span> \
	<span class="enscript-string">&quot;\20SOPT_INPROG\21NOLINGER\22FAILINGOVER\23ACTIVE\24MPCAP_CTRSET&quot;</span> \
	<span class="enscript-string">&quot;\25FASTJ_SEND\26FASTJ_REQD\27USER_DISCONNECT&quot;</span>

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">MPTS_LOCK_ASSERT_HELD</span>(_mpts)					\
	lck_mtx_assert(&amp;(_mpts)-&gt;mpts_lock, LCK_MTX_ASSERT_OWNED)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">MPTS_LOCK_ASSERT_NOTHELD</span>(_mpts)					\
	lck_mtx_assert(&amp;(_mpts)-&gt;mpts_lock, LCK_MTX_ASSERT_NOTOWNED)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">MPTS_LOCK</span>(_mpts)						\
	lck_mtx_lock(&amp;(_mpts)-&gt;mpts_lock)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">MPTS_UNLOCK</span>(_mpts)						\
	lck_mtx_unlock(&amp;(_mpts)-&gt;mpts_lock)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">MPTS_ADDREF</span>(_mpts)						\
	mptcp_subflow_addref(_mpts, 0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">MPTS_ADDREF_LOCKED</span>(_mpts)					\
	mptcp_subflow_addref(_mpts, 1)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">MPTS_REMREF</span>(_mpts)						\
	mptcp_subflow_remref(_mpts)

<span class="enscript-comment">/*
 * MPTCP states
 * Keep in sync with bsd/dev/dtrace/mptcp.d
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> mptcp_state {
	MPTCPS_CLOSED		= 0,	<span class="enscript-comment">/* closed */</span>
	MPTCPS_LISTEN		= 1,	<span class="enscript-comment">/* not yet implemented */</span>
	MPTCPS_ESTABLISHED	= 2,	<span class="enscript-comment">/* MPTCP connection established */</span>
	MPTCPS_CLOSE_WAIT	= 3,	<span class="enscript-comment">/* rcvd DFIN, waiting for close */</span>
	MPTCPS_FIN_WAIT_1	= 4,	<span class="enscript-comment">/* have closed, sent DFIN */</span>
	MPTCPS_CLOSING		= 5,	<span class="enscript-comment">/* closed xchd DFIN, waiting DFIN ACK */</span>
	MPTCPS_LAST_ACK		= 6,	<span class="enscript-comment">/* had DFIN and close; await DFIN ACK */</span>
	MPTCPS_FIN_WAIT_2	= 7,	<span class="enscript-comment">/* have closed, DFIN is acked */</span>
	MPTCPS_TIME_WAIT	= 8,	<span class="enscript-comment">/* in 2*MSL quiet wait after close */</span>
	MPTCPS_FASTCLOSE_WAIT	= 9,	<span class="enscript-comment">/* sent MP_FASTCLOSE */</span>
	MPTCPS_TERMINATE	= 10,	<span class="enscript-comment">/* terminal state */</span>
} mptcp_state_t;

<span class="enscript-type">typedef</span> u_int64_t	mptcp_key_t;
<span class="enscript-type">typedef</span> u_int32_t	mptcp_token_t;
<span class="enscript-type">typedef</span> u_int8_t	mptcp_addr_id;


<span class="enscript-comment">/* Address ID list */</span>
<span class="enscript-type">struct</span> mptcp_subf_auth_entry {
	LIST_ENTRY(mptcp_subf_auth_entry) msae_next;
	u_int32_t	msae_laddr_rand;	<span class="enscript-comment">/* Local nonce */</span>
	u_int32_t	msae_raddr_rand;	<span class="enscript-comment">/* Remote nonce */</span>
	mptcp_addr_id	msae_laddr_id;		<span class="enscript-comment">/* Local addr ID */</span>
	mptcp_addr_id	msae_raddr_id;		<span class="enscript-comment">/* Remote addr ID */</span>
};

<span class="enscript-comment">/*
 * MPTCP Protocol Control Block
 *
 * Protected by per-MPTCP mpt_lock.
 * Keep in sync with bsd/dev/dtrace/scripts/mptcp.d.
 */</span>
<span class="enscript-type">struct</span> mptcb {
	decl_lck_mtx_data(, mpt_lock);		<span class="enscript-comment">/* per MPTCP PCB lock */</span>
	<span class="enscript-type">struct</span> mptses	*mpt_mpte;		<span class="enscript-comment">/* back ptr to MPTCP session */</span>
	mptcp_state_t	mpt_state;		<span class="enscript-comment">/* MPTCP state */</span>
	u_int32_t	mpt_flags;		<span class="enscript-comment">/* see flags below */</span>
	u_int32_t	mpt_refcnt;		<span class="enscript-comment">/* references held on mptcb */</span>
	u_int32_t	mpt_version;		<span class="enscript-comment">/* MPTCP proto version */</span>
	<span class="enscript-type">int</span>		mpt_softerror;		<span class="enscript-comment">/* error not yet reported */</span>
	<span class="enscript-comment">/*
	 * Authentication and metadata invariants
	 */</span>
	mptcp_key_t	*mpt_localkey;		<span class="enscript-comment">/* in network byte order */</span>
	mptcp_key_t	mpt_remotekey;		<span class="enscript-comment">/* in network byte order */</span>
	mptcp_token_t	mpt_localtoken;		<span class="enscript-comment">/* HMAC SHA1 of local key */</span>
	mptcp_token_t	mpt_remotetoken;	<span class="enscript-comment">/* HMAC SHA1 of remote key */</span>

	<span class="enscript-comment">/*
	 * Timer vars for scenarios where subflow level acks arrive, but
	 * Data ACKs do not.
	 */</span>
	<span class="enscript-type">int</span>		mpt_rxtshift;		<span class="enscript-comment">/* num of consecutive retrans */</span>
	u_int32_t	mpt_rxtstart;		<span class="enscript-comment">/* time at which rxt started */</span>
	u_int64_t	mpt_rtseq;		<span class="enscript-comment">/* seq # being tracked */</span>
	u_int32_t	mpt_timer_vals;		<span class="enscript-comment">/* timer related values */</span>
	u_int32_t	mpt_timewait;		<span class="enscript-comment">/* timewait */</span>
	<span class="enscript-comment">/*
	 * Sending side
	 */</span>
	u_int64_t	mpt_snduna;		<span class="enscript-comment">/* DSN of last unacked byte */</span>
	u_int64_t	mpt_sndnxt;		<span class="enscript-comment">/* DSN of next byte to send */</span>
	u_int64_t	mpt_sndmax;		<span class="enscript-comment">/* DSN of max byte sent */</span>
	u_int64_t	mpt_local_idsn;		<span class="enscript-comment">/* First byte's DSN */</span>
	u_int32_t	mpt_sndwnd;
	<span class="enscript-comment">/*
	 * Receiving side
	 */</span>
	u_int64_t	mpt_rcvnxt;		<span class="enscript-comment">/* Next expected DSN */</span>
	u_int64_t	mpt_rcvatmark;		<span class="enscript-comment">/* mpsocket marker of rcvnxt */</span>
	u_int64_t	mpt_remote_idsn;	<span class="enscript-comment">/* Peer's IDSN */</span>
	u_int32_t	mpt_rcvwnd;
	LIST_HEAD(, mptcp_subf_auth_entry) mpt_subauth_list; <span class="enscript-comment">/* address IDs */</span>
	<span class="enscript-comment">/*
	 * Fastclose
	 */</span>
	u_int64_t	mpt_dsn_at_csum_fail;   <span class="enscript-comment">/* MPFail Opt DSN */</span>
	u_int32_t	mpt_ssn_at_csum_fail;	<span class="enscript-comment">/* MPFail Subflow Seq */</span>
	<span class="enscript-comment">/*
	 * Zombie handling
	 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPT_GC_TICKS</span>		(30)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MPT_GC_TICKS_FAST</span>	(10)
	int32_t		mpt_gc_ticks;		<span class="enscript-comment">/* Used for zombie deletion */</span>

	u_int32_t	mpt_notsent_lowat;	<span class="enscript-comment">/* TCP_NOTSENT_LOWAT support */</span>
	u_int32_t	mpt_peer_version;	<span class="enscript-comment">/* Version from peer */</span>
};

<span class="enscript-comment">/* valid values for mpt_flags (see also notes on mpts_flags above) */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTCPF_CHECKSUM</span>		0x1	<span class="enscript-comment">/* checksum DSS option */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTCPF_FALLBACK_TO_TCP</span>	0x2	<span class="enscript-comment">/* Fallback to TCP */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTCPF_JOIN_READY</span>	0x4	<span class="enscript-comment">/* Ready to start 2 or more subflows */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTCPF_RECVD_MPFAIL</span>	0x8	<span class="enscript-comment">/* Received MP_FAIL option */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTCPF_PEEL_OFF</span>		0x10	<span class="enscript-comment">/* Peel off this socket */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTCPF_SND_64BITDSN</span>	0x20	<span class="enscript-comment">/* Send full 64-bit DSN */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTCPF_SND_64BITACK</span>	0x40	<span class="enscript-comment">/* Send 64-bit ACK response */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTCPF_RCVD_64BITACK</span>	0x80	<span class="enscript-comment">/* Received 64-bit Data ACK */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MPTCPF_POST_FALLBACK_SYNC</span>	0x100	<span class="enscript-comment">/* Post fallback resend data */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTCPF_BITS</span> \
	<span class="enscript-string">&quot;\020\1CHECKSUM\2FALLBACK_TO_TCP\3JOIN_READY\4RECVD_MPFAIL\5PEEL_OFF&quot;</span> \
	<span class="enscript-string">&quot;\6SND_64BITDSN\7SND_64BITACK\10RCVD_64BITACK\11POST_FALLBACK_SYNC&quot;</span>

<span class="enscript-comment">/* valid values for mpt_timer_vals */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTT_REXMT</span>		0x01	<span class="enscript-comment">/* Starting Retransmit Timer */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTT_TW</span>			0x02	<span class="enscript-comment">/* Starting Timewait Timer */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTT_FASTCLOSE</span>		0x04	<span class="enscript-comment">/* Starting Fastclose wait timer */</span>
<span class="enscript-comment">//#define MPTT_PROBE_TIMER	0x08	/* Timer for probing preferred path */
</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">MPT_LOCK_ASSERT_HELD</span>(_mpt)					\
	lck_mtx_assert(&amp;(_mpt)-&gt;mpt_lock, LCK_MTX_ASSERT_OWNED)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">MPT_LOCK_ASSERT_NOTHELD</span>(_mpt)					\
	lck_mtx_assert(&amp;(_mpt)-&gt;mpt_lock, LCK_MTX_ASSERT_NOTOWNED)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">MPT_LOCK</span>(_mpt)							\
	lck_mtx_lock(&amp;(_mpt)-&gt;mpt_lock)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">MPT_LOCK_SPIN</span>(_mpt)						\
	lck_mtx_lock_spin(&amp;(_mpt)-&gt;mpt_lock)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">MPT_CONVERT_LOCK</span>(_mpt) do {					\
	MPT_LOCK_ASSERT_HELD(_mpt);					\
	lck_mtx_convert_spin(&amp;(_mpt)-&gt;mpt_lock);			\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">MPT_UNLOCK</span>(_mpt)						\
	lck_mtx_unlock(&amp;(_mpt)-&gt;mpt_lock)

<span class="enscript-comment">/* events for close FSM */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPCE_CLOSE</span>		0x1
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPCE_RECV_DATA_ACK</span>	0x2
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPCE_RECV_DATA_FIN</span>	0x4

<span class="enscript-comment">/* mptcb manipulation */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">tptomptp</span>(tp)	((struct mptcb *)((tp)-&gt;t_mptcb))

<span class="enscript-comment">/*
 * MPTCP control block and state structures are allocated along with
 * the MP protocol control block; the folllowing represents the layout.
 */</span>
<span class="enscript-type">struct</span> mpp_mtp {
	<span class="enscript-type">struct</span> mppcb		mpp;		<span class="enscript-comment">/* Multipath PCB */</span>
	<span class="enscript-type">struct</span> mptses		mpp_ses;	<span class="enscript-comment">/* MPTCP session */</span>
	<span class="enscript-type">struct</span> mptcb		mtcb;		<span class="enscript-comment">/* MPTCP PCB */</span>
};

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">SYSCTL_DECL</span>
<span class="enscript-function-name">SYSCTL_DECL</span>(_net_inet_mptcp);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* SYSCTL_DECL */</span>

<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> mppcbinfo mtcbinfo;
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pr_usrreqs mptcp_usrreqs;

<span class="enscript-comment">/* Encryption algorithm related definitions */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTCP_SHA1_RESULTLEN</span>    20
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">SHA1_TRUNCATED</span>		8

<span class="enscript-comment">/* List of valid keys to use for MPTCP connections */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTCP_KEY_DIGEST_LEN</span>		(MPTCP_SHA1_RESULTLEN)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTCP_MX_KEY_ALLOCS</span>		(256)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTCP_KEY_PREALLOCS_MX</span>		(16)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTCP_MX_PREALLOC_ZONE_SZ</span>	(8192)

<span class="enscript-type">struct</span> mptcp_key_entry {
	LIST_ENTRY(mptcp_key_entry)	mkey_next;
	mptcp_key_t			mkey_value;
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MKEYF_FREE</span>	0x0
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MKEYF_INUSE</span>	0x1
	u_int32_t			mkey_flags;
	<span class="enscript-type">char</span>				mkey_digest[MPTCP_KEY_DIGEST_LEN];
};

<span class="enscript-comment">/* structure for managing unique key list */</span>
<span class="enscript-type">struct</span> mptcp_keys_pool_head {
	<span class="enscript-type">struct</span> mptcp_key_entry *lh_first;	<span class="enscript-comment">/* list of keys */</span>
	u_int32_t	mkph_count;		<span class="enscript-comment">/* total keys in pool */</span>
	vm_size_t	mkph_key_elm_sz;	<span class="enscript-comment">/* size of key entry */</span>
	<span class="enscript-type">struct</span> zone	*mkph_key_entry_zone;	<span class="enscript-comment">/* zone for key entry */</span>
	decl_lck_mtx_data(, mkph_lock);		<span class="enscript-comment">/* lock for key list */</span>
};

<span class="enscript-comment">/* MPTCP Receive Window */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTCP_RWIN_MAX</span>	(1&lt;&lt;16)

<span class="enscript-comment">/* MPTCP Debugging Levels */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTCP_LOGLVL_NONE</span>	0x0	<span class="enscript-comment">/* No debug logging */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTCP_LOGLVL_ERR</span>	0x1	<span class="enscript-comment">/* Errors in execution are logged */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTCP_LOGLVL_LOG</span>	0x2	<span class="enscript-comment">/* Important logs */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTCP_LOGLVL_VERBOSE</span>	0x3	<span class="enscript-comment">/* Verbose logs */</span>

<span class="enscript-comment">/* MPTCP sub-components for debug logging */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MPTCP_NO_DBG</span>		0x00	<span class="enscript-comment">/* No areas are logged */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MPTCP_STATE_DBG</span>		0x01	<span class="enscript-comment">/* State machine logging */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MPTCP_SOCKET_DBG</span>	0x02	<span class="enscript-comment">/* Socket call logging */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MPTCP_SENDER_DBG</span>	0x04	<span class="enscript-comment">/* Sender side logging */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MPTCP_RECEIVER_DBG</span>	0x08	<span class="enscript-comment">/* Receiver logging */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MPTCP_EVENTS_DBG</span>	0x10	<span class="enscript-comment">/* Subflow events logging */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MPTCP_ALL_DBG</span>		(MPTCP_STATE_DBG | MPTCP_SOCKET_DBG | \
    MPTCP_SENDER_DBG | MPTCP_RECEIVER_DBG | MPTCP_EVENTS_DBG)

<span class="enscript-comment">/* Mask to obtain 32-bit portion of data sequence number */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTCP_DATASEQ_LOW32_MASK</span>	(0xffffffff)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">MPTCP_DATASEQ_LOW32</span>(seq)	(seq &amp; MPTCP_DATASEQ_LOW32_MASK)

<span class="enscript-comment">/* Mask to obtain upper 32-bit portion of data sequence number */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTCP_DATASEQ_HIGH32_MASK</span>	(0xffffffff00000000)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">MPTCP_DATASEQ_HIGH32</span>(seq)	(seq &amp; MPTCP_DATASEQ_HIGH32_MASK)

<span class="enscript-comment">/* Mask to obtain 32-bit portion of data ack */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTCP_DATAACK_LOW32_MASK</span>	(0xffffffff)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">MPTCP_DATAACK_LOW32</span>(ack)	(ack &amp; MPTCP_DATAACK_LOW32_MASK)

<span class="enscript-comment">/* Mask to obtain upper 32-bit portion of data ack */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MPTCP_DATAACK_HIGH32_MASK</span>	(0xffffffff00000000)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">MPTCP_DATAACK_HIGH32</span>(ack)	(ack &amp; MPTCP_DATAACK_HIGH32_MASK)

<span class="enscript-comment">/*
 * x is the 64-bit data sequence number, y the 32-bit data seq number to be
 * extended. z is y extended to the appropriate 64-bit value.
 * This algorithm is based on the fact that subflow level window sizes are
 * at the maximum 2**30 (in reality, they are a lot lesser). A high throughput
 * application sending on a large number of subflows can in theory have very
 * large MPTCP level send and receive windows. In which case, 64 bit DSNs
 * must be sent in place of 32 bit DSNs on wire. For us, with 2 subflows at
 * 512K each, sequence wraparound detection can be done by checking whether
 * the 32-bit value obtained on wire is 2**31 bytes apart from the stored
 * lower 32-bits of the Data Sequence Number. Bogus DSNs are dropped by
 * comparing against rwnd. Bogus DSNs within rwnd cannot be protected against
 * and are as weak as bogus TCP sequence numbers.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">MPTCP_EXTEND_DSN</span>(x, y, z) {					\
	<span class="enscript-keyword">if</span> ((MPTCP_DATASEQ_LOW32(x) &gt; y) &amp;&amp;				\
	    ((((u_int32_t)MPTCP_DATASEQ_LOW32(x)) - (u_int32_t)y) &gt;=	\
	    (u_int32_t)(1 &lt;&lt; 31))) {					\
		<span class="enscript-comment">/*							\
		 * y wrapped around and x and y are 2**31 bytes  apart	\
		 */</span>							\
		z = MPTCP_DATASEQ_HIGH32(x) + 0x100000000;		\
		z |= y;							\
	} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> ((MPTCP_DATASEQ_LOW32(x) &lt; y) &amp;&amp;			\
	    (((u_int32_t)y -						\
	    ((u_int32_t)MPTCP_DATASEQ_LOW32(x))) &gt;=			\
	    (u_int32_t)(1 &lt;&lt; 31))) {					\
		<span class="enscript-comment">/*							\
		 * x wrapped around and x and y are 2**31 apart		\
		 */</span>							\
		z = MPTCP_DATASEQ_HIGH32(x) - 0x100000000;		\
		z |= y;							\
	} <span class="enscript-keyword">else</span> {							\
		z = MPTCP_DATASEQ_HIGH32(x) | y;			\
	}								\
}

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">mptcplog</span>(x, y, z)	do {					\
	<span class="enscript-keyword">if</span> ((mptcp_dbg_area &amp; y) &amp;&amp;					\
	    (mptcp_dbg_level &gt;= z))					\
		log x;							\
} <span class="enscript-keyword">while</span> (0)

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> mptcp_enable;	<span class="enscript-comment">/* Multipath TCP */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> mptcp_mpcap_retries;	<span class="enscript-comment">/* Multipath TCP retries */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> mptcp_join_retries;	<span class="enscript-comment">/* Multipath TCP Join retries */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> mptcp_dss_csum;	<span class="enscript-comment">/* Multipath DSS Option checksum */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> mptcp_fail_thresh;	<span class="enscript-comment">/* Multipath failover thresh of retransmits */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> mptcp_subflow_keeptime; <span class="enscript-comment">/* Multipath subflow TCP_KEEPALIVE opt */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> mptcp_mpprio_enable;	<span class="enscript-comment">/* MP_PRIO option enable/disable */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> mptcp_remaddr_enable;<span class="enscript-comment">/* REMOVE_ADDR option enable/disable */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> mptcp_fastjoin;	<span class="enscript-comment">/* Enable FastJoin */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> mptcp_zerortt_fastjoin; <span class="enscript-comment">/* Enable Data after SYN Fast Join */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> mptcp_rwnotify;	<span class="enscript-comment">/* Enable RW notification on resume */</span>
<span class="enscript-type">extern</span> uint32_t mptcp_dbg_level;	<span class="enscript-comment">/* Multipath TCP debugging level */</span>
<span class="enscript-type">extern</span> uint32_t mptcp_dbg_area;	<span class="enscript-comment">/* Multipath TCP debugging area */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MPPCB_LIMIT</span>	16
<span class="enscript-type">extern</span> uint32_t mptcp_socket_limit; <span class="enscript-comment">/* max number of mptcp sockets allowed */</span>
<span class="enscript-type">extern</span> uint32_t mptcp_delayed_subf_start; <span class="enscript-comment">/* delayed cellular subflow start */</span>	
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> tcp_jack_rxmt;	<span class="enscript-comment">/* Join ACK retransmission value in msecs */</span>

__BEGIN_DECLS
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_init</span>(<span class="enscript-type">struct</span> protosw *, <span class="enscript-type">struct</span> domain *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">mptcp_ctloutput</span>(<span class="enscript-type">struct</span> socket *, <span class="enscript-type">struct</span> sockopt *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> *<span class="enscript-function-name">mptcp_sescreate</span>(<span class="enscript-type">struct</span> socket *, <span class="enscript-type">struct</span> mppcb *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_drain</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> mptses *<span class="enscript-function-name">mptcp_drop</span>(<span class="enscript-type">struct</span> mptses *, <span class="enscript-type">struct</span> mptcb *, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> mptses *<span class="enscript-function-name">mptcp_close</span>(<span class="enscript-type">struct</span> mptses *, <span class="enscript-type">struct</span> mptcb *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">mptcp_lock</span>(<span class="enscript-type">struct</span> socket *, <span class="enscript-type">int</span>, <span class="enscript-type">void</span> *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">mptcp_unlock</span>(<span class="enscript-type">struct</span> socket *, <span class="enscript-type">int</span>, <span class="enscript-type">void</span> *);
<span class="enscript-type">extern</span> lck_mtx_t *<span class="enscript-function-name">mptcp_getlock</span>(<span class="enscript-type">struct</span> socket *, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_thread_signal</span>(<span class="enscript-type">struct</span> mptses *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_flush_sopts</span>(<span class="enscript-type">struct</span> mptses *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">mptcp_setconnorder</span>(<span class="enscript-type">struct</span> mptses *, sae_connid_t, uint32_t);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">mptcp_getconnorder</span>(<span class="enscript-type">struct</span> mptses *, sae_connid_t, uint32_t *);

<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> mptopt *<span class="enscript-function-name">mptcp_sopt_alloc</span>(<span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> *<span class="enscript-function-name">mptcp_sopt2str</span>(<span class="enscript-type">int</span>, <span class="enscript-type">int</span>, <span class="enscript-type">char</span> *, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_sopt_free</span>(<span class="enscript-type">struct</span> mptopt *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_sopt_insert</span>(<span class="enscript-type">struct</span> mptses *, <span class="enscript-type">struct</span> mptopt *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_sopt_remove</span>(<span class="enscript-type">struct</span> mptses *, <span class="enscript-type">struct</span> mptopt *);
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> mptopt *<span class="enscript-function-name">mptcp_sopt_find</span>(<span class="enscript-type">struct</span> mptses *, <span class="enscript-type">struct</span> sockopt *);

<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> mptsub *<span class="enscript-function-name">mptcp_subflow_alloc</span>(<span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_subflow_free</span>(<span class="enscript-type">struct</span> mptsub *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_subflow_addref</span>(<span class="enscript-type">struct</span> mptsub *, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">mptcp_subflow_add</span>(<span class="enscript-type">struct</span> mptses *, <span class="enscript-type">struct</span> mptsub *,
    <span class="enscript-type">struct</span> proc *, uint32_t);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_subflow_del</span>(<span class="enscript-type">struct</span> mptses *, <span class="enscript-type">struct</span> mptsub *, boolean_t);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_subflow_remref</span>(<span class="enscript-type">struct</span> mptsub *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">mptcp_subflow_output</span>(<span class="enscript-type">struct</span> mptses *, <span class="enscript-type">struct</span> mptsub *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_subflow_disconnect</span>(<span class="enscript-type">struct</span> mptses *, <span class="enscript-type">struct</span> mptsub *,
    boolean_t);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_subflow_sopeeloff</span>(<span class="enscript-type">struct</span> mptses *, <span class="enscript-type">struct</span> mptsub *,
    <span class="enscript-type">struct</span> socket *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">mptcp_subflow_sosetopt</span>(<span class="enscript-type">struct</span> mptses *, <span class="enscript-type">struct</span> socket *,
    <span class="enscript-type">struct</span> mptopt *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">mptcp_subflow_sogetopt</span>(<span class="enscript-type">struct</span> mptses *, <span class="enscript-type">struct</span> socket *,
    <span class="enscript-type">struct</span> mptopt *);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_input</span>(<span class="enscript-type">struct</span> mptses *, <span class="enscript-type">struct</span> mbuf *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">mptcp_output</span>(<span class="enscript-type">struct</span> mptses *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_close_fsm</span>(<span class="enscript-type">struct</span> mptcb *, uint32_t);

<span class="enscript-type">extern</span> mptcp_token_t <span class="enscript-function-name">mptcp_get_localtoken</span>(<span class="enscript-type">void</span> *);
<span class="enscript-type">extern</span> mptcp_token_t <span class="enscript-function-name">mptcp_get_remotetoken</span>(<span class="enscript-type">void</span> *);

<span class="enscript-type">extern</span> u_int64_t <span class="enscript-function-name">mptcp_get_localkey</span>(<span class="enscript-type">void</span> *);
<span class="enscript-type">extern</span> u_int64_t <span class="enscript-function-name">mptcp_get_remotekey</span>(<span class="enscript-type">void</span> *);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_free_key</span>(mptcp_key_t *key);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_hmac_sha1</span>(mptcp_key_t, mptcp_key_t, u_int32_t, u_int32_t,
    u_char*, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_get_hmac</span>(mptcp_addr_id, <span class="enscript-type">struct</span> mptcb *, u_char *, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_get_rands</span>(mptcp_addr_id, <span class="enscript-type">struct</span> mptcb *, u_int32_t *,
    u_int32_t *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_set_raddr_rand</span>(mptcp_addr_id, <span class="enscript-type">struct</span> mptcb *, mptcp_addr_id,
    u_int32_t);
<span class="enscript-type">extern</span> u_int64_t <span class="enscript-function-name">mptcp_get_trunced_hmac</span>(mptcp_addr_id, <span class="enscript-type">struct</span> mptcb *mp_tp);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">mptcp_generate_token</span>(<span class="enscript-type">char</span> *, <span class="enscript-type">int</span>, caddr_t, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">mptcp_generate_idsn</span>(<span class="enscript-type">char</span> *, <span class="enscript-type">int</span>, caddr_t, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">mptcp_ok_to_keepalive</span>(<span class="enscript-type">struct</span> mptcb *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_insert_dsn</span>(<span class="enscript-type">struct</span> mppcb *, <span class="enscript-type">struct</span> mbuf *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>  <span class="enscript-function-name">mptcp_output_getm_dsnmap32</span>(<span class="enscript-type">struct</span> socket *, <span class="enscript-type">int</span>, uint32_t,
    u_int32_t *, u_int32_t *, u_int16_t *, u_int64_t *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>  <span class="enscript-function-name">mptcp_output_getm_dsnmap64</span>(<span class="enscript-type">struct</span> socket *, <span class="enscript-type">int</span>, uint32_t,
    u_int64_t *, u_int32_t *, u_int16_t *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_send_dfin</span>(<span class="enscript-type">struct</span> socket *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_act_on_txfail</span>(<span class="enscript-type">struct</span> socket *);
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> mptsub *<span class="enscript-function-name">mptcp_get_subflow</span>(<span class="enscript-type">struct</span> mptses *, <span class="enscript-type">struct</span> mptsub *,
    <span class="enscript-type">struct</span> mptsub **);
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> mptsub *<span class="enscript-function-name">mptcp_get_pending_subflow</span>(<span class="enscript-type">struct</span> mptses *,
    <span class="enscript-type">struct</span> mptsub *);
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> mptsub* <span class="enscript-function-name">mptcp_use_symptoms_hints</span>(<span class="enscript-type">struct</span> mptsub*,
    <span class="enscript-type">struct</span> mptsub *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">mptcp_get_map_for_dsn</span>(<span class="enscript-type">struct</span> socket *, u_int64_t, u_int32_t *);
<span class="enscript-type">extern</span> int32_t <span class="enscript-function-name">mptcp_adj_sendlen</span>(<span class="enscript-type">struct</span> socket *so, int32_t off, int32_t len);
<span class="enscript-type">extern</span> int32_t <span class="enscript-function-name">mptcp_sbspace</span>(<span class="enscript-type">struct</span> mptcb *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_notify_mpready</span>(<span class="enscript-type">struct</span> socket *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_notify_mpfail</span>(<span class="enscript-type">struct</span> socket *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_notify_close</span>(<span class="enscript-type">struct</span> socket *);
<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">mptcp_no_rto_spike</span>(<span class="enscript-type">struct</span> socket*);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">mptcp_set_notsent_lowat</span>(<span class="enscript-type">struct</span> mptses *mpte, <span class="enscript-type">int</span> optval);
<span class="enscript-type">extern</span> u_int32_t <span class="enscript-function-name">mptcp_get_notsent_lowat</span>(<span class="enscript-type">struct</span> mptses *mpte);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">mptcp_notsent_lowat_check</span>(<span class="enscript-type">struct</span> socket *so);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mptcp_control_register</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">mptcp_is_wifi_unusable</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">mptcp_is_cell_unusable</span>(<span class="enscript-type">void</span>);
__END_DECLS

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* BSD_KERNEL_PRIVATE */</span>
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">PRIVATE</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> mptcp_flow {
	size_t			flow_len;
	size_t			flow_tcpci_offset;
	uint32_t		flow_flags;
	sae_connid_t		flow_cid;
	<span class="enscript-type">struct</span> sockaddr_storage flow_src;
	<span class="enscript-type">struct</span> sockaddr_storage flow_dst;
	uint64_t		flow_sndnxt;	<span class="enscript-comment">/* subflow's sndnxt snapshot */</span>
	uint32_t		flow_relseq;	<span class="enscript-comment">/* last subflow rel seq# */</span>
	int32_t			flow_soerror;	<span class="enscript-comment">/* subflow level error */</span>
	uint32_t		flow_probecnt;	<span class="enscript-comment">/* number of probes sent */</span>
	uint32_t		flow_peerswitch;<span class="enscript-comment">/* did peer switch */</span>
	conninfo_tcp_t		flow_ci;	<span class="enscript-comment">/* must be the last field */</span>
} mptcp_flow_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> conninfo_mptcp {
	size_t		mptcpci_len;
	size_t		mptcpci_flow_offset;	<span class="enscript-comment">/* offsetof first flow */</span>
	size_t		mptcpci_nflows;		<span class="enscript-comment">/* number of subflows */</span>
	uint32_t	mptcpci_state;		<span class="enscript-comment">/* MPTCP level state */</span>
	uint32_t	mptcpci_mpte_flags;	<span class="enscript-comment">/* Session flags */</span>
	uint32_t	mptcpci_flags;		<span class="enscript-comment">/* MPTCB flags */</span>
	uint32_t	mptcpci_ltoken;		<span class="enscript-comment">/* local token */</span>
	uint32_t	mptcpci_rtoken;		<span class="enscript-comment">/* remote token */</span>
	uint32_t        mptcpci_notsent_lowat;	<span class="enscript-comment">/* NOTSENT_LOWAT */</span>

	<span class="enscript-comment">/* Send side */</span>
	uint64_t	mptcpci_snduna;		<span class="enscript-comment">/* DSN of last unacked byte */</span>
	uint64_t	mptcpci_sndnxt;		<span class="enscript-comment">/* DSN of next byte to send */</span>
	uint64_t	mptcpci_sndmax;		<span class="enscript-comment">/* DSN of max byte sent */</span>
	uint64_t	mptcpci_lidsn;		<span class="enscript-comment">/* Local IDSN */</span>
	uint32_t	mptcpci_sndwnd;		<span class="enscript-comment">/* Send window snapshot */</span>

	<span class="enscript-comment">/* Receive side */</span>
	uint64_t	mptcpci_rcvnxt;		<span class="enscript-comment">/* Next expected DSN */</span>
	uint64_t	mptcpci_rcvatmark;	<span class="enscript-comment">/* Session level rcvnxt */</span>
	uint64_t	mptcpci_ridsn;		<span class="enscript-comment">/* Peer's IDSN */</span>
	uint32_t	mptcpci_rcvwnd;		<span class="enscript-comment">/* Receive window */</span>

	uint8_t		mptcpci_mpte_addrid;	<span class="enscript-comment">/* last addr id */</span>

	mptcp_flow_t	mptcpci_flows[1];
} conninfo_mptcp_t;

<span class="enscript-comment">/* Use SymptomsD notifications of wifi and cell status in subflow selection */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MPTCP_KERN_CTL_NAME</span>    <span class="enscript-string">&quot;com.apple.network.advisory&quot;</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> symptoms_advisory {
	<span class="enscript-type">union</span> {
		uint32_t	sa_nwk_status_int;
		<span class="enscript-type">struct</span> {
			<span class="enscript-type">union</span> {
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SYMPTOMS_ADVISORY_NOCOMMENT</span>    0x00
				uint16_t	sa_nwk_status;
				<span class="enscript-type">struct</span> {
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SYMPTOMS_ADVISORY_WIFI_BAD</span>     0x01
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SYMPTOMS_ADVISORY_WIFI_OK</span>      0x02
					uint8_t	sa_wifi_status;
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SYMPTOMS_ADVISORY_CELL_BAD</span>     0x01
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SYMPTOMS_ADVISORY_CELL_OK</span>      0x02
					uint8_t	sa_cell_status;
				};
			};
			uint16_t	sa_unused;
		};
	};
} symptoms_advisory_t;


#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* PRIVATE */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* _NETINET_MPTCP_VAR_H_ */</span>
</pre>
<hr />
</body></html>