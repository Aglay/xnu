<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>kpi_ipfilter.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">kpi_ipfilter.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2008-2014 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*!
	@header kpi_ipfilter.h
	This header defines an API to attach IP filters. IP filters may be
	attached to intercept either IPv4 or IPv6 packets. The filters can
	intercept all IP packets in to and out of the host regardless of
	interface.
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">__KPI_IPFILTER__</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">__KPI_IPFILTER__</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/kernel_types.h&gt;</span>

<span class="enscript-comment">/*
 * ipf_pktopts
 *
 * Options for outgoing packets. The options need to be preserved when 
 * re-injecting a packet.
 */</span>
<span class="enscript-type">struct</span> ipf_pktopts {
	u_int32_t			ippo_flags;
	ifnet_t				ippo_mcast_ifnet;
	<span class="enscript-type">int</span>				ippo_mcast_loop;
	u_int8_t			ippo_mcast_ttl;
};
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IPPOF_MCAST_OPTS</span>	0x1
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">PRIVATE</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IPPOF_BOUND_IF</span>		0x2
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IPPOF_NO_IFT_CELLULAR</span>	0x4
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IPPOF_SELECT_SRCIF</span>	0x8
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IPPOF_BOUND_SRCADDR</span>	0x10
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IPPOF_SHIFT_IFSCOPE</span>	16
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IPPOF_NO_IFF_EXPENSIVE</span>	0x20
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* PRIVATE */</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> ipf_pktopts *ipf_pktopts_t;

__BEGIN_DECLS

<span class="enscript-comment">/*!
	@typedef ipf_input_func

	@discussion ipf_input_func is used to filter incoming ip packets.
		The IP filter is called for packets from all interfaces. The
		filter is called between when the general IP processing is
		handled and when the packet is passed up to the next layer
		protocol such as udp or tcp. In the case of encapsulation, such
		as UDP in ESP (IPSec), your filter will be called once for ESP
		and then again for UDP. This will give your filter an
		opportunity to process the ESP header as well as the decrypted
		packet. Offset and protocol are used to determine where in the
		packet processing is currently occuring. If you're only
		interested in TCP or UDP packets, just return 0 if protocol
		doesn't match TCP or UDP.
	@param cookie The cookie specified when your filter was attached.
	@param data The reassembled ip packet, data will start at the ip
		header.
	@param offset An offset to the next header
		(udp/tcp/icmp/esp/etc...).
	@param protocol The protocol type (udp/tcp/icmp/etc...) of the IP packet
	@result Return:
		0 - The caller will continue with normal processing of the
			packet.
		EJUSTRETURN - The caller will stop processing the packet,
			the packet will not be freed.
		Anything Else - The caller will free the packet and stop
			processing.
*/</span>
<span class="enscript-type">typedef</span>	errno_t (*ipf_input_func)(<span class="enscript-type">void</span> *cookie, mbuf_t *data, <span class="enscript-type">int</span> offset,
    u_int8_t protocol);

<span class="enscript-comment">/*!
	@typedef ipf_output_func

	@discussion ipf_output_func is used to filter outbound ip packets.
		The IP filter is called for packets to all interfaces. The
		filter is called before fragmentation and IPSec processing. If
		you need to change the destination IP address, call
		ipf_inject_output and return EJUSTRETURN.
	@param cookie The cookie specified when your filter was attached.
	@param data The ip packet, will contain an IP header followed by the
		rest of the IP packet.
	@result Return:
		0 - The caller will continue with normal processing of the
			packet.
		EJUSTRETURN - The caller will stop processing the packet,
			the packet will not be freed.
		Anything Else - The caller will free the packet and stop
			processing.
*/</span>
<span class="enscript-type">typedef</span>	errno_t (*ipf_output_func)(<span class="enscript-type">void</span> *cookie, mbuf_t *data,
    ipf_pktopts_t options);

<span class="enscript-comment">/*!
	@typedef ipf_detach_func

	@discussion ipf_detach_func is called to notify your filter that it
		has been detached.
	@param cookie The cookie specified when your filter was attached.
*/</span>
<span class="enscript-type">typedef</span>	<span class="enscript-type">void</span> (*ipf_detach_func)(<span class="enscript-type">void</span> *cookie);

<span class="enscript-comment">/*!
	@typedef ipf_filter
	@discussion This structure is used to define an IP filter for
		use with the ipf_addv4 or ipf_addv6 function.
	@field cookie A kext defined cookie that will be passed to all
		filter functions.
	@field name A filter name used for debugging purposes.
	@field ipf_input The filter function to handle inbound packets.
	@field ipf_output The filter function to handle outbound packets.
	@field ipf_detach The filter function to notify of a detach.
*/</span>
<span class="enscript-type">struct</span> ipf_filter {
	<span class="enscript-type">void</span>		*cookie;
	<span class="enscript-type">const</span> <span class="enscript-type">char</span>	*name;
	ipf_input_func	ipf_input;
	ipf_output_func	ipf_output;
	ipf_detach_func	ipf_detach;
};

<span class="enscript-type">struct</span> opaque_ipfilter;
<span class="enscript-type">typedef</span>	<span class="enscript-type">struct</span> opaque_ipfilter *ipfilter_t;

<span class="enscript-comment">/*!
	@function ipf_addv4
	@discussion Attaches an IPv4 ip filter.
	@param filter A structure defining the filter.
	@param filter_ref A reference to the filter used to detach it.
	@result 0 on success otherwise the errno error.
 */</span>
<span class="enscript-type">extern</span> errno_t <span class="enscript-function-name">ipf_addv4</span>(<span class="enscript-type">const</span> <span class="enscript-type">struct</span> ipf_filter *filter,
    ipfilter_t *filter_ref);

<span class="enscript-comment">/*!
	@function ipf_addv6
	@discussion Attaches an IPv6 ip filter.
	@param filter A structure defining the filter.
	@param filter_ref A reference to the filter used to detach it.
	@result 0 on success otherwise the errno error.
 */</span>
<span class="enscript-type">extern</span> errno_t <span class="enscript-function-name">ipf_addv6</span>(<span class="enscript-type">const</span> <span class="enscript-type">struct</span> ipf_filter *filter,
    ipfilter_t *filter_ref);

<span class="enscript-comment">/*!
	@function ipf_remove
	@discussion Detaches an IPv4 or IPv6 filter.
	@param filter_ref The reference to the filter returned from ipf_addv4 or
		ipf_addv6.
	@result 0 on success otherwise the errno error.
 */</span>
<span class="enscript-type">extern</span> errno_t <span class="enscript-function-name">ipf_remove</span>(ipfilter_t filter_ref);

<span class="enscript-comment">/*!
	@function ipf_inject_input
	@discussion Inject an IP packet as though it had just been
		reassembled in ip_input. When re-injecting a packet intercepted
		by the filter's ipf_input function, an IP filter can pass its
		reference to avoid processing the packet twice. This also
		prevents ip filters installed before this filter from
		getting a chance to process the packet. If the filter modified
		the packet, it should not specify the filter ref to give other
		filters a chance to process the new packet.

		Caller is responsible for freeing mbuf chain in the event that
		ipf_inject_input returns an error.
	@param data The complete IPv4 or IPv6 packet, receive interface must
		be set.
	@param filter_ref The reference to the filter injecting the data
	@result 0 on success otherwise the errno error.
 */</span>
<span class="enscript-type">extern</span> errno_t <span class="enscript-function-name">ipf_inject_input</span>(mbuf_t data, ipfilter_t filter_ref);

<span class="enscript-comment">/*!
	@function ipf_inject_output
	@discussion Inject an IP packet as though it had just been sent to
		ip_output. When re-injecting a packet intercepted by the
		filter's ipf_output function, an IP filter can pass its
		reference to avoid processing the packet twice. This also
		prevents ip filters installed before this filter from getting a
		chance to process the packet. If the filter modified the packet,
		it should not specify the filter ref to give other filters a
		chance to process the new packet.
	@param data The complete IPv4 or IPv6 packet.
	@param filter_ref The reference to the filter injecting the data
	@param options Output options for the packet
	@result 0 on success otherwise the errno error. ipf_inject_output
		will always free the mbuf.
 */</span>
<span class="enscript-type">extern</span> errno_t <span class="enscript-function-name">ipf_inject_output</span>(mbuf_t data, ipfilter_t filter_ref,
    ipf_pktopts_t options);

__END_DECLS
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* __KPI_IPFILTER__ */</span>
</pre>
<hr />
</body></html>