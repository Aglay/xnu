<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>in_pcb.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">in_pcb.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000-2014 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 *
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 *
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 *
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*
 * Copyright (c) 1982, 1986, 1990, 1993
 *	The Regents of the University of California.  All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *	This product includes software developed by the University of
 *	California, Berkeley and its contributors.
 * 4. Neither the name of the University nor the names of its contributors
 *    may be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 *	@(#)in_pcb.h	8.1 (Berkeley) 6/10/93
 * $FreeBSD: src/sys/netinet/in_pcb.h,v 1.32.2.4 2001/08/13 16:26:17 ume Exp $
 */</span>
<span class="enscript-comment">/*
 * NOTICE: This file was modified by SPARTA, Inc. in 2007 to introduce
 * support for mandatory and extensible security protections.  This notice
 * is included in support of clause 2.2 (b) of the Apple Public License,
 * Version 2.0.
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_NETINET_IN_PCB_H_</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">_NETINET_IN_PCB_H_</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/appleapiopts.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/queue.h&gt;</span>
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">BSD_KERNEL_PRIVATE</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/bitstring.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/tree.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/locks.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/zalloc.h&gt;</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* BSD_KERNEL_PRIVATE */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet6/ipsec.h&gt;</span> <span class="enscript-comment">/* for IPSEC */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">NECP</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/necp.h&gt;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">IPSEC</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet6/ipsec.h&gt;</span> <span class="enscript-comment">/* for IPSEC */</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">BSD_KERNEL_PRIVATE</span>
<span class="enscript-comment">/*
 * struct inpcb is the common protocol control block structure used in most
 * IP transport protocols.
 *
 * Pointers to local and foreign host table entries, local and foreign socket
 * numbers, and pointers up (to a socket structure) and down (to a
 * protocol-specific control block) are stored here.
 */</span>
<span class="enscript-function-name">LIST_HEAD</span>(inpcbhead, inpcb);
<span class="enscript-function-name">LIST_HEAD</span>(inpcbporthead, inpcbport);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* BSD_KERNEL_PRIVATE */</span>
<span class="enscript-type">typedef</span>	u_quad_t	inp_gen_t;

<span class="enscript-comment">/*
 * PCB with AF_INET6 null bind'ed laddr can receive AF_INET input packet.
 * So, AF_INET6 null laddr is also used as AF_INET null laddr, by utilizing
 * the following structure.
 */</span>
<span class="enscript-type">struct</span> in_addr_4in6 {
	u_int32_t	ia46_pad32[3];
	<span class="enscript-type">struct</span>	in_addr	ia46_addr4;
};

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">BSD_KERNEL_PRIVATE</span>
<span class="enscript-comment">/*
 * NB: the zone allocator is type-stable EXCEPT FOR THE FIRST TWO LONGS
 * of the structure.  Therefore, it is important that the members in
 * that position not contain any information which is required to be
 * stable.
 */</span>
<span class="enscript-type">struct</span>	icmp6_filter;
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_MACF_NET</span>
<span class="enscript-type">struct</span>	label;
#<span class="enscript-reference">endif</span>
<span class="enscript-type">struct</span> ifnet;

<span class="enscript-type">struct</span> inp_stat {
	u_int64_t	rxpackets;
	u_int64_t	rxbytes;
	u_int64_t	txpackets;
	u_int64_t	txbytes;
};

<span class="enscript-comment">/*
 * struct inpcb captures the network layer state for TCP, UDP and raw IPv6
 * and IPv6 sockets.  In the case of TCP, further per-connection state is
 * hung off of inp_ppcb most of the time.
 */</span>
<span class="enscript-type">struct</span> inpcb {
	decl_lck_mtx_data(, inpcb_mtx);	<span class="enscript-comment">/* inpcb per-socket mutex */</span>
	LIST_ENTRY(inpcb) inp_hash;	<span class="enscript-comment">/* hash list */</span>
	LIST_ENTRY(inpcb) inp_list;	<span class="enscript-comment">/* list for all PCBs of this proto */</span>
	<span class="enscript-type">void</span>	*inp_ppcb;		<span class="enscript-comment">/* pointer to per-protocol pcb */</span>
	<span class="enscript-type">struct</span> inpcbinfo *inp_pcbinfo;	<span class="enscript-comment">/* PCB list info */</span>
	<span class="enscript-type">struct</span> socket *inp_socket;	<span class="enscript-comment">/* back pointer to socket */</span>
	LIST_ENTRY(inpcb) inp_portlist;	<span class="enscript-comment">/* list for this PCB's local port */</span>
	RB_ENTRY(inpcb) infc_link;	<span class="enscript-comment">/* link for flowhash RB tree */</span>
	<span class="enscript-type">struct</span> inpcbport *inp_phd;	<span class="enscript-comment">/* head of this list */</span>
	inp_gen_t inp_gencnt;		<span class="enscript-comment">/* generation count of this instance */</span>
	<span class="enscript-type">int</span>	inp_hash_element;	<span class="enscript-comment">/* array index of pcb's hash list */</span>
	<span class="enscript-type">int</span>	inp_wantcnt;		<span class="enscript-comment">/* wanted count; atomically updated */</span>
	<span class="enscript-type">int</span>	inp_state;		<span class="enscript-comment">/* state (INUSE/CACHED/DEAD) */</span>
	u_short	inp_fport;		<span class="enscript-comment">/* foreign port */</span>
	u_short	inp_lport;		<span class="enscript-comment">/* local port */</span>
	u_int32_t inp_flags;		<span class="enscript-comment">/* generic IP/datagram flags */</span>
	u_int32_t inp_flags2;		<span class="enscript-comment">/* generic IP/datagram flags #2 */</span>
	u_int32_t inp_flow;		<span class="enscript-comment">/* IPv6 flow information */</span>

	u_char	inp_sndinprog_cnt;	<span class="enscript-comment">/* outstanding send operations */</span>
	u_char	inp_vflag;		<span class="enscript-comment">/* INP_IPV4 or INP_IPV6 */</span>

	u_char inp_ip_ttl;		<span class="enscript-comment">/* time to live proto */</span>
	u_char inp_ip_p;		<span class="enscript-comment">/* protocol proto */</span>

	<span class="enscript-type">struct</span> ifnet *inp_boundifp;	<span class="enscript-comment">/* interface for INP_BOUND_IF */</span>
	<span class="enscript-type">struct</span> ifnet *inp_last_outifp;	<span class="enscript-comment">/* last known outgoing interface */</span>
	u_int32_t inp_flowhash;		<span class="enscript-comment">/* flow hash */</span>

	<span class="enscript-comment">/* Protocol-dependent part */</span>
	<span class="enscript-type">union</span> {
		<span class="enscript-comment">/* foreign host table entry */</span>
		<span class="enscript-type">struct</span> in_addr_4in6 inp46_foreign;
		<span class="enscript-type">struct</span> in6_addr inp6_foreign;
	} inp_dependfaddr;
	<span class="enscript-type">union</span> {
		<span class="enscript-comment">/* local host table entry */</span>
		<span class="enscript-type">struct</span> in_addr_4in6 inp46_local;
		<span class="enscript-type">struct</span> in6_addr inp6_local;
	} inp_dependladdr;
	<span class="enscript-type">union</span> {
		<span class="enscript-comment">/* placeholder for routing entry */</span>
		<span class="enscript-type">struct</span> route inp4_route;
		<span class="enscript-type">struct</span> route_in6 inp6_route;
	} inp_dependroute;
	<span class="enscript-type">struct</span> {
		<span class="enscript-comment">/* type of service proto */</span>
		u_char inp4_ip_tos;
		<span class="enscript-comment">/* IP options */</span>
		<span class="enscript-type">struct</span> mbuf *inp4_options;
		<span class="enscript-comment">/* IP multicast options */</span>
		<span class="enscript-type">struct</span> ip_moptions *inp4_moptions;
	} inp_depend4;
	<span class="enscript-type">struct</span> {
		<span class="enscript-comment">/* IP options */</span>
		<span class="enscript-type">struct</span> mbuf *inp6_options;
		<span class="enscript-comment">/* IP6 options for outgoing packets */</span>
		<span class="enscript-type">struct</span>	ip6_pktopts *inp6_outputopts;
		<span class="enscript-comment">/* IP multicast options */</span>
		<span class="enscript-type">struct</span>	ip6_moptions *inp6_moptions;
		<span class="enscript-comment">/* ICMPv6 code type filter */</span>
		<span class="enscript-type">struct</span>	icmp6_filter *inp6_icmp6filt;
		<span class="enscript-comment">/* IPV6_CHECKSUM setsockopt */</span>
		<span class="enscript-type">int</span>	inp6_cksum;
		<span class="enscript-type">short</span>	inp6_hops;
	} inp_depend6;

	caddr_t inp_saved_ppcb;		<span class="enscript-comment">/* place to save pointer while cached */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_MACF_NET</span>
	<span class="enscript-type">struct</span> label *inp_label;	<span class="enscript-comment">/* MAC label */</span>
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">IPSEC</span>
	<span class="enscript-type">struct</span> inpcbpolicy *inp_sp;	<span class="enscript-comment">/* for IPSec */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* IPSEC */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">NECP</span>
	<span class="enscript-type">struct</span> {
		<span class="enscript-type">char</span> *inp_domain;
		<span class="enscript-type">char</span> *inp_account;
	} inp_necp_attributes;
	<span class="enscript-type">struct</span> necp_inpcb_result inp_policyresult;
#<span class="enscript-reference">endif</span>
	u_char *inp_keepalive_data;	<span class="enscript-comment">/* for keepalive offload */</span>
	u_int8_t inp_keepalive_datalen; <span class="enscript-comment">/* keepalive data length */</span>
	u_int8_t inp_keepalive_type;	<span class="enscript-comment">/* type of application */</span>
	u_int16_t inp_keepalive_interval; <span class="enscript-comment">/* keepalive interval */</span>
	uint32_t inp_nstat_refcnt __attribute__((aligned(4)));
	<span class="enscript-type">struct</span> inp_stat	*inp_stat;
	<span class="enscript-type">struct</span> inp_stat	*inp_cstat;	<span class="enscript-comment">/* cellular data */</span>
	<span class="enscript-type">struct</span> inp_stat	*inp_wstat;	<span class="enscript-comment">/* Wi-Fi data */</span>
	<span class="enscript-type">struct</span> inp_stat	*inp_Wstat;	<span class="enscript-comment">/* Wired data */</span>
	u_int8_t inp_stat_store[<span class="enscript-keyword">sizeof</span> (<span class="enscript-type">struct</span> inp_stat) + <span class="enscript-keyword">sizeof</span> (u_int64_t)];
	u_int8_t inp_cstat_store[<span class="enscript-keyword">sizeof</span> (<span class="enscript-type">struct</span> inp_stat) + <span class="enscript-keyword">sizeof</span> (u_int64_t)];
	u_int8_t inp_wstat_store[<span class="enscript-keyword">sizeof</span> (<span class="enscript-type">struct</span> inp_stat) + <span class="enscript-keyword">sizeof</span> (u_int64_t)];
	u_int8_t inp_Wstat_store[<span class="enscript-keyword">sizeof</span> (<span class="enscript-type">struct</span> inp_stat) + <span class="enscript-keyword">sizeof</span> (u_int64_t)];
};

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">INP_ADD_STAT</span>(_inp, _cnt_cellular, _cnt_wifi, _cnt_wired, _a, _n)\
<span class="enscript-keyword">do</span> {									\
	locked_add_64(&amp;((_inp)-&gt;inp_stat-&gt;_a), (_n));			\
	<span class="enscript-keyword">if</span> (_cnt_cellular)						\
		locked_add_64(&amp;((_inp)-&gt;inp_cstat-&gt;_a), (_n));		\
	<span class="enscript-keyword">if</span> (_cnt_wifi)							\
		locked_add_64(&amp;((_inp)-&gt;inp_wstat-&gt;_a), (_n));		\
	<span class="enscript-keyword">if</span> (_cnt_wired)							\
		locked_add_64(&amp;((_inp)-&gt;inp_Wstat-&gt;_a), (_n));		\
} <span class="enscript-keyword">while</span> (0);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* BSD_KERNEL_PRIVATE */</span>

<span class="enscript-comment">/*
 * Interface exported to userland by various protocols which use
 * inpcbs.  Hack alert -- only define if struct xsocket is in scope.
 */</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">pack</span>(4)

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__LP64__</span>)
<span class="enscript-type">struct</span> _inpcb_list_entry {
    u_int32_t	le_next;
    u_int32_t	le_prev;
};
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">_INPCB_PTR</span>(x)		u_int32_t
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">_INPCB_LIST_ENTRY</span>(x)	struct _inpcb_list_entry
#<span class="enscript-reference">else</span> <span class="enscript-comment">/* !__LP64__ */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">_INPCB_PTR</span>(x)		x
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">_INPCB_LIST_ENTRY</span>(x)	LIST_ENTRY(x)
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !__LP64__ */</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">XNU_KERNEL_PRIVATE</span>
<span class="enscript-comment">/*
 * This is a copy of the inpcb as it shipped in Panther. This structure
 * is filled out in a copy function. This allows the inpcb to change
 * without breaking userland tools.
 *
 * CAUTION: Many fields may not be filled out. Fewer may be filled out
 * in the future. Code defensively.
 */</span>
<span class="enscript-type">struct</span> inpcb_compat {
#<span class="enscript-reference">else</span>
<span class="enscript-type">struct</span> inpcbinfo;
<span class="enscript-type">struct</span> inpcbport;
<span class="enscript-type">struct</span> mbuf;
<span class="enscript-type">struct</span> ip6_pktopts;
<span class="enscript-type">struct</span> ip6_moptions;
<span class="enscript-type">struct</span> icmp6_filter;
<span class="enscript-type">struct</span> inpcbpolicy;

<span class="enscript-type">struct</span> inpcb {
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL_PRIVATE */</span>
	_INPCB_LIST_ENTRY(inpcb) inp_hash;	<span class="enscript-comment">/* hash list */</span>
	<span class="enscript-type">struct</span> in_addr reserved1;		<span class="enscript-comment">/* reserved */</span>
	<span class="enscript-type">struct</span> in_addr reserved2;		<span class="enscript-comment">/* reserved */</span>
	u_short	inp_fport;			<span class="enscript-comment">/* foreign port */</span>
	u_short	inp_lport;			<span class="enscript-comment">/* local port */</span>
	_INPCB_LIST_ENTRY(inpcb) inp_list;	<span class="enscript-comment">/* list for all peer PCBs */</span>
	_INPCB_PTR(caddr_t) inp_ppcb;		<span class="enscript-comment">/* per-protocol pcb */</span>
	_INPCB_PTR(<span class="enscript-type">struct</span> inpcbinfo *) inp_pcbinfo;	<span class="enscript-comment">/* PCB list info */</span>
	_INPCB_PTR(<span class="enscript-type">void</span> *) inp_socket;	<span class="enscript-comment">/* back pointer to socket */</span>
	u_char nat_owner;		<span class="enscript-comment">/* Used to NAT TCP/UDP traffic */</span>
	u_int32_t nat_cookie;		<span class="enscript-comment">/* Cookie stored and returned to NAT */</span>
	_INPCB_LIST_ENTRY(inpcb) inp_portlist;	<span class="enscript-comment">/* this PCB's local port list */</span>
	_INPCB_PTR(<span class="enscript-type">struct</span> inpcbport *) inp_phd; <span class="enscript-comment">/* head of this list */</span>
	inp_gen_t inp_gencnt;		<span class="enscript-comment">/* generation count of this instance */</span>
	<span class="enscript-type">int</span> inp_flags;			<span class="enscript-comment">/* generic IP/datagram flags */</span>
	u_int32_t inp_flow;

	u_char inp_vflag;

	u_char inp_ip_ttl;		<span class="enscript-comment">/* time to live proto */</span>
	u_char inp_ip_p;		<span class="enscript-comment">/* protocol proto */</span>
	<span class="enscript-comment">/* protocol dependent part */</span>
	<span class="enscript-type">union</span> {
		<span class="enscript-comment">/* foreign host table entry */</span>
		<span class="enscript-type">struct</span> in_addr_4in6 inp46_foreign;
		<span class="enscript-type">struct</span> in6_addr inp6_foreign;
	} inp_dependfaddr;
	<span class="enscript-type">union</span> {
		<span class="enscript-comment">/* local host table entry */</span>
		<span class="enscript-type">struct</span> in_addr_4in6 inp46_local;
		<span class="enscript-type">struct</span> in6_addr inp6_local;
	} inp_dependladdr;
	<span class="enscript-type">union</span> {
		<span class="enscript-comment">/* placeholder for routing entry */</span>
		u_char inp4_route[20];
		u_char inp6_route[32];
	} inp_dependroute;
	<span class="enscript-type">struct</span> {
		<span class="enscript-comment">/* type of service proto */</span>
		u_char inp4_ip_tos;
		<span class="enscript-comment">/* IP options */</span>
		_INPCB_PTR(<span class="enscript-type">struct</span> mbuf *) inp4_options;
		<span class="enscript-comment">/* IP multicast options */</span>
		_INPCB_PTR(<span class="enscript-type">struct</span> ip_moptions *) inp4_moptions;
	} inp_depend4;

	<span class="enscript-type">struct</span> {
		<span class="enscript-comment">/* IP options */</span>
		_INPCB_PTR(<span class="enscript-type">struct</span> mbuf *) inp6_options;
		u_int8_t inp6_hlim;
		u_int8_t unused_uint8_1;
		ushort unused_uint16_1;
		<span class="enscript-comment">/* IP6 options for outgoing packets */</span>
		_INPCB_PTR(<span class="enscript-type">struct</span> ip6_pktopts *) inp6_outputopts;
		<span class="enscript-comment">/* IP multicast options */</span>
		_INPCB_PTR(<span class="enscript-type">struct</span> ip6_moptions *) inp6_moptions;
		<span class="enscript-comment">/* ICMPv6 code type filter */</span>
		_INPCB_PTR(<span class="enscript-type">struct</span> icmp6_filter *) inp6_icmp6filt;
		<span class="enscript-comment">/* IPV6_CHECKSUM setsockopt */</span>
		<span class="enscript-type">int</span>	inp6_cksum;
		u_short	inp6_ifindex;
		<span class="enscript-type">short</span>	inp6_hops;
	} inp_depend6;

	<span class="enscript-type">int</span> hash_element;		<span class="enscript-comment">/* Array index of pcb's hash list */</span>
	_INPCB_PTR(caddr_t) inp_saved_ppcb; <span class="enscript-comment">/* pointer while cached */</span>
	_INPCB_PTR(<span class="enscript-type">struct</span> inpcbpolicy *) inp_sp;
	u_int32_t	reserved[3];	<span class="enscript-comment">/* reserved */</span>
};

<span class="enscript-type">struct</span>	xinpcb {
	u_int32_t	xi_len;		<span class="enscript-comment">/* length of this structure */</span>
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">XNU_KERNEL_PRIVATE</span>
	<span class="enscript-type">struct</span>	inpcb_compat xi_inp;
#<span class="enscript-reference">else</span>
	<span class="enscript-type">struct</span>	inpcb xi_inp;
#<span class="enscript-reference">endif</span>
	<span class="enscript-type">struct</span>	xsocket xi_socket;
	u_quad_t	xi_alignment_hack;
};

<span class="enscript-type">struct</span> inpcb64_list_entry {
    u_int64_t   le_next;
    u_int64_t   le_prev;
};

<span class="enscript-type">struct</span>	xinpcb64 {
	u_int64_t	xi_len;		<span class="enscript-comment">/* length of this structure */</span>
	u_int64_t	xi_inpp;
	u_short		inp_fport;	<span class="enscript-comment">/* foreign port */</span>
	u_short		inp_lport;	<span class="enscript-comment">/* local port */</span>
	<span class="enscript-type">struct</span> inpcb64_list_entry inp_list; <span class="enscript-comment">/* list for all PCBs */</span>
	u_int64_t	inp_ppcb;	<span class="enscript-comment">/* ptr to per-protocol PCB */</span>
	u_int64_t	inp_pcbinfo;	<span class="enscript-comment">/* PCB list info */</span>
	<span class="enscript-type">struct</span> inpcb64_list_entry inp_portlist;	<span class="enscript-comment">/* this PCB's local port list */</span>
	u_int64_t	inp_phd;	<span class="enscript-comment">/* head of this list */</span>
	inp_gen_t	inp_gencnt;	<span class="enscript-comment">/* current generation count */</span>
	<span class="enscript-type">int</span>		inp_flags;	<span class="enscript-comment">/* generic IP/datagram flags */</span>
	u_int32_t	inp_flow;
	u_char		inp_vflag;
	u_char		inp_ip_ttl;	<span class="enscript-comment">/* time to live */</span>
	u_char		inp_ip_p;	<span class="enscript-comment">/* protocol */</span>
	<span class="enscript-type">union</span> {				<span class="enscript-comment">/* foreign host table entry */</span>
		<span class="enscript-type">struct</span>  in_addr_4in6	inp46_foreign;
		<span class="enscript-type">struct</span>  in6_addr	inp6_foreign;
	} inp_dependfaddr;
	<span class="enscript-type">union</span> {				<span class="enscript-comment">/* local host table entry */</span>
		<span class="enscript-type">struct</span>  in_addr_4in6	inp46_local;
		<span class="enscript-type">struct</span>  in6_addr	inp6_local;
	} inp_dependladdr;
	<span class="enscript-type">struct</span> {
		u_char	inp4_ip_tos;	<span class="enscript-comment">/* type of service */</span>
	} inp_depend4;
	<span class="enscript-type">struct</span> {
		u_int8_t inp6_hlim;
		<span class="enscript-type">int</span>	inp6_cksum;
		u_short	inp6_ifindex;
		<span class="enscript-type">short</span>	inp6_hops;
	} inp_depend6;
	<span class="enscript-type">struct</span>  xsocket64 xi_socket;
	u_quad_t	xi_alignment_hack;
};

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">PRIVATE</span>
<span class="enscript-type">struct</span> xinpcb_list_entry {
    u_int64_t   le_next;
    u_int64_t   le_prev;
};

<span class="enscript-type">struct</span>	xinpcb_n {
	u_int32_t	xi_len;		<span class="enscript-comment">/* length of this structure */</span>
	u_int32_t	xi_kind;	<span class="enscript-comment">/* XSO_INPCB */</span>
	u_int64_t	xi_inpp;
	u_short		inp_fport;	<span class="enscript-comment">/* foreign port */</span>
	u_short		inp_lport;	<span class="enscript-comment">/* local port */</span>
	u_int64_t	inp_ppcb;	<span class="enscript-comment">/* pointer to per-protocol pcb */</span>
	inp_gen_t	inp_gencnt;	<span class="enscript-comment">/* generation count of this instance */</span>
	<span class="enscript-type">int</span>		inp_flags;	<span class="enscript-comment">/* generic IP/datagram flags */</span>
	u_int32_t	inp_flow;
	u_char		inp_vflag;
	u_char		inp_ip_ttl;	<span class="enscript-comment">/* time to live */</span>
	u_char		inp_ip_p;	<span class="enscript-comment">/* protocol */</span>
	<span class="enscript-type">union</span> {				<span class="enscript-comment">/* foreign host table entry */</span>
		<span class="enscript-type">struct</span> in_addr_4in6	inp46_foreign;
		<span class="enscript-type">struct</span> in6_addr		inp6_foreign;
	} inp_dependfaddr;
	<span class="enscript-type">union</span> {				<span class="enscript-comment">/* local host table entry */</span>
		<span class="enscript-type">struct</span> in_addr_4in6	inp46_local;
		<span class="enscript-type">struct</span> in6_addr		inp6_local;
	} inp_dependladdr;
	<span class="enscript-type">struct</span> {
		u_char	inp4_ip_tos;	<span class="enscript-comment">/* type of service */</span>
	} inp_depend4;
	<span class="enscript-type">struct</span> {
		u_int8_t inp6_hlim;
		<span class="enscript-type">int</span>	inp6_cksum;
		u_short	inp6_ifindex;
		<span class="enscript-type">short</span>	inp6_hops;
	} inp_depend6;
	u_int32_t		inp_flowhash;
	u_int32_t	inp_flags2;
};
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* PRIVATE */</span>

<span class="enscript-type">struct</span>	xinpgen {
	u_int32_t	xig_len;	<span class="enscript-comment">/* length of this structure */</span>
	u_int		xig_count;	<span class="enscript-comment">/* number of PCBs at this time */</span>
	inp_gen_t	xig_gen;	<span class="enscript-comment">/* generation count at this time */</span>
	so_gen_t	xig_sogen;	<span class="enscript-comment">/* current socket generation count */</span>
};

#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">pack</span>()

<span class="enscript-comment">/*
 * These defines are for use with the inpcb.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_IPV4</span>	0x1
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_IPV6</span>	0x2
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">inp_faddr</span>	inp_dependfaddr.inp46_foreign.ia46_addr4
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">inp_laddr</span>	inp_dependladdr.inp46_local.ia46_addr4
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">in6p_faddr</span>	inp_dependfaddr.inp6_foreign
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">in6p_laddr</span>	inp_dependladdr.inp6_local

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">BSD_KERNEL_PRIVATE</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">inp_route</span>	inp_dependroute.inp4_route
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">inp_ip_tos</span>	inp_depend4.inp4_ip_tos
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">inp_options</span>	inp_depend4.inp4_options
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">inp_moptions</span>	inp_depend4.inp4_moptions
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">in6p_route</span>	inp_dependroute.inp6_route
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">in6p_ip6_hlim</span>	inp_depend6.inp6_hlim
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">in6p_hops</span>	inp_depend6.inp6_hops	<span class="enscript-comment">/* default hop limit */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">in6p_ip6_nxt</span>	inp_ip_p
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">in6p_vflag</span>	inp_vflag
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">in6p_options</span>	inp_depend6.inp6_options
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">in6p_outputopts</span>	inp_depend6.inp6_outputopts
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">in6p_moptions</span>	inp_depend6.inp6_moptions
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">in6p_icmp6filt</span>	inp_depend6.inp6_icmp6filt
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">in6p_cksum</span>	inp_depend6.inp6_cksum
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">in6p_ifindex</span>	inp_depend6.inp6_ifindex
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">in6p_flags</span>	inp_flags
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">in6p_flags2</span>	inp_flags2
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">in6p_socket</span>	inp_socket
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">in6p_lport</span>	inp_lport
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">in6p_fport</span>	inp_fport
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">in6p_ppcb</span>	inp_ppcb
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">in6p_state</span>	inp_state
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">in6p_wantcnt</span>	inp_wantcnt
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">in6p_last_outifp</span> inp_last_outifp
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">in6pcb</span>		inpcb
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">IPSEC</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">in6p_sp</span>		inp_sp
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* IPSEC */</span>

<span class="enscript-type">struct</span> inpcbport {
	LIST_ENTRY(inpcbport) phd_hash;
	<span class="enscript-type">struct</span> inpcbhead phd_pcblist;
	u_short phd_port;
};

<span class="enscript-type">struct</span> intimercount {
	u_int32_t intimer_lazy;	<span class="enscript-comment">/* lazy requests for timer scheduling */</span>
	u_int32_t intimer_fast; <span class="enscript-comment">/* fast requests, can be coalesced */</span>
	u_int32_t intimer_nodelay; <span class="enscript-comment">/* fast requests, never coalesced */</span>
};

<span class="enscript-type">typedef</span> <span class="enscript-function-name">void</span> (*inpcb_timer_func_t)(<span class="enscript-type">struct</span> inpcbinfo *);

<span class="enscript-comment">/*
 * Global data structure for each high-level protocol (UDP, TCP, ...) in both
 * IPv4 and IPv6.  Holds inpcb lists and information for managing them.  Each
 * pcbinfo is protected by a RW lock: ipi_lock.
 *
 * All INPCB pcbinfo entries are linked together via ipi_entry.
 */</span>
<span class="enscript-type">struct</span> inpcbinfo {
	<span class="enscript-comment">/*
	 * Glue to all PCB infos, as well as garbage collector and
	 * timer callbacks, protected by inpcb_lock.  Callout request
	 * counts are atomically updated.
	 */</span>
	TAILQ_ENTRY(inpcbinfo)	ipi_entry;
	inpcb_timer_func_t	ipi_gc;
	inpcb_timer_func_t	ipi_timer;
	<span class="enscript-type">struct</span> intimercount	ipi_gc_req;
	<span class="enscript-type">struct</span> intimercount	ipi_timer_req;

	<span class="enscript-comment">/*
	 * Per-protocol lock protecting pcb list, pcb count, etc.
	 */</span>
	lck_rw_t		*ipi_lock;

	<span class="enscript-comment">/*
	 * List and count of pcbs on the protocol.
	 */</span>
	<span class="enscript-type">struct</span> inpcbhead	*ipi_listhead;
	uint32_t		ipi_count;

	<span class="enscript-comment">/*
	 * Count of pcbs marked with INP2_TIMEWAIT flag.
	 */</span>
	uint32_t		ipi_twcount;

	<span class="enscript-comment">/*
	 * Generation count -- incremented each time a connection is
	 * allocated or freed.
	 */</span>
	uint64_t		ipi_gencnt;

	<span class="enscript-comment">/*
	 * Fields associated with port lookup and allocation.
	 */</span>
	uint16_t		ipi_lastport;
	uint16_t		ipi_lastlow;
	uint16_t		ipi_lasthi;

	<span class="enscript-comment">/*
	 * Zone from which inpcbs are allocated for this protocol.
	 */</span>
	<span class="enscript-type">struct</span> zone		*ipi_zone;

	<span class="enscript-comment">/*
	 * Per-protocol hash of pcbs, hashed by local and foreign
	 * addresses and port numbers.
	 */</span>
	<span class="enscript-type">struct</span> inpcbhead	*ipi_hashbase;
	u_long			ipi_hashmask;

	<span class="enscript-comment">/*
	 * Per-protocol hash of pcbs, hashed by only local port number.
	 */</span>
	<span class="enscript-type">struct</span> inpcbporthead	*ipi_porthashbase;
	u_long			ipi_porthashmask;

	<span class="enscript-comment">/*
	 * Misc.
	 */</span>
	lck_attr_t		*ipi_lock_attr;
	lck_grp_t		*ipi_lock_grp;
	lck_grp_attr_t		*ipi_lock_grp_attr;
};

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">INP_PCBHASH</span>(faddr, lport, fport, mask) \
	(((faddr) ^ ((faddr) &gt;&gt; 16) ^ ntohs((lport) ^ (fport))) &amp; (mask))
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">INP_PCBPORTHASH</span>(lport, mask) \
	(ntohs((lport)) &amp; (mask))

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">INP_IS_FLOW_CONTROLLED</span>(_inp_) \
	((_inp_)-&gt;inp_flags &amp; INP_FLOW_CONTROLLED)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">INP_IS_FLOW_SUSPENDED</span>(_inp_) \
	(((_inp_)-&gt;inp_flags &amp; INP_FLOW_SUSPENDED) ||	\
	((_inp_)-&gt;inp_socket-&gt;so_flags &amp; SOF_SUSPENDED))
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">INP_WAIT_FOR_IF_FEEDBACK</span>(_inp_) \
	(((_inp_)-&gt;inp_flags &amp; (INP_FLOW_CONTROLLED | INP_FLOW_SUSPENDED)) != 0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">INP_NO_CELLULAR</span>(_inp) \
	((_inp)-&gt;inp_flags &amp; INP_NO_IFT_CELLULAR)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">INP_NO_EXPENSIVE</span>(_inp) \
	((_inp)-&gt;inp_flags2 &amp; INP2_NO_IFF_EXPENSIVE)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">INP_AWDL_UNRESTRICTED</span>(_inp) \
	((_inp)-&gt;inp_flags2 &amp; INP2_AWDL_UNRESTRICTED)

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* BSD_KERNEL_PRIVATE */</span>

<span class="enscript-comment">/*
 * Flags for inp_flags.
 *
 * Some of these are publicly defined for legacy reasons, as they are
 * (unfortunately) used by certain applications to determine, at compile
 * time, whether or not the OS supports certain features.
 */</span>
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">BSD_KERNEL_PRIVATE</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_RECVOPTS</span>		0x00000001 <span class="enscript-comment">/* receive incoming IP options */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_RECVRETOPTS</span>		0x00000002 <span class="enscript-comment">/* receive IP options for reply */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_RECVDSTADDR</span>		0x00000004 <span class="enscript-comment">/* receive IP dst address */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_HDRINCL</span>		0x00000008 <span class="enscript-comment">/* user supplies entire IP header */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_HIGHPORT</span>		0x00000010 <span class="enscript-comment">/* user wants &quot;high&quot; port binding */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_LOWPORT</span>		0x00000020 <span class="enscript-comment">/* user wants &quot;low&quot; port binding */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* BSD_KERNEL_PRIVATE */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_ANONPORT</span>		0x00000040 <span class="enscript-comment">/* port chosen for user */</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">BSD_KERNEL_PRIVATE</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_RECVIF</span>		0x00000080 <span class="enscript-comment">/* receive incoming interface */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_MTUDISC</span>		0x00000100 <span class="enscript-comment">/* unused */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_STRIPHDR</span>		0x00000200 <span class="enscript-comment">/* strip hdrs in raw_ip (for OT) */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_RECV_ANYIF</span>		0x00000400 <span class="enscript-comment">/* don't restrict inbound iface */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_INADDR_ANY</span>		0x00000800 <span class="enscript-comment">/* local address wasn't specified */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_IN6ADDR_ANY</span>		INP_INADDR_ANY
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_RECVTTL</span>		0x00001000 <span class="enscript-comment">/* receive incoming IP TTL */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_UDP_NOCKSUM</span>		0x00002000 <span class="enscript-comment">/* turn off outbound UDP checksum */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_BOUND_IF</span>		0x00004000 <span class="enscript-comment">/* bind socket to an interface */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* BSD_KERNEL_PRIVATE */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">IN6P_IPV6_V6ONLY</span>	0x00008000 <span class="enscript-comment">/* restrict AF_INET6 socket for v6 */</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">BSD_KERNEL_PRIVATE</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">IN6P_PKTINFO</span>		0x00010000 <span class="enscript-comment">/* receive IP6 dst and I/F */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">IN6P_HOPLIMIT</span>		0x00020000 <span class="enscript-comment">/* receive hoplimit */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">IN6P_HOPOPTS</span>		0x00040000 <span class="enscript-comment">/* receive hop-by-hop options */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">IN6P_DSTOPTS</span>		0x00080000 <span class="enscript-comment">/* receive dst options after rthdr */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">IN6P_RTHDR</span>		0x00100000 <span class="enscript-comment">/* receive routing header */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">IN6P_RTHDRDSTOPTS</span>	0x00200000 <span class="enscript-comment">/* receive dstoptions before rthdr */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">IN6P_TCLASS</span>		0x00400000 <span class="enscript-comment">/* receive traffic class value */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">IN6P_AUTOFLOWLABEL</span>	0x00800000 <span class="enscript-comment">/* attach flowlabel automatically */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* BSD_KERNEL_PRIVATE */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">IN6P_BINDV6ONLY</span>		0x01000000 <span class="enscript-comment">/* do not grab IPv4 traffic */</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">BSD_KERNEL_PRIVATE</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">IN6P_RFC2292</span>		0x02000000 <span class="enscript-comment">/* used RFC2292 API on the socket */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">IN6P_MTU</span>		0x04000000 <span class="enscript-comment">/* receive path MTU */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_PKTINFO</span>		0x08000000 <span class="enscript-comment">/* rcv and snd PKTINFO for IPv4 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_FLOW_SUSPENDED</span>	0x10000000 <span class="enscript-comment">/* flow suspended */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_NO_IFT_CELLULAR</span>	0x20000000 <span class="enscript-comment">/* do not use cellular interface */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_FLOW_CONTROLLED</span>	0x40000000 <span class="enscript-comment">/* flow controlled */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_FC_FEEDBACK</span>		0x80000000 <span class="enscript-comment">/* got interface flow adv feedback */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_CONTROLOPTS</span>	\
	(INP_RECVOPTS|INP_RECVRETOPTS|INP_RECVDSTADDR|INP_RECVIF|INP_RECVTTL| \
	INP_PKTINFO|IN6P_PKTINFO|IN6P_HOPLIMIT|IN6P_HOPOPTS|IN6P_DSTOPTS| \
	IN6P_RTHDR|IN6P_RTHDRDSTOPTS|IN6P_TCLASS|IN6P_RFC2292|IN6P_MTU)

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP_UNMAPPABLEOPTS</span> \
	(IN6P_HOPOPTS|IN6P_DSTOPTS|IN6P_RTHDR| IN6P_TCLASS|IN6P_AUTOFLOWLABEL)

<span class="enscript-comment">/*
 * Flags for inp_flags2.
 *
 * Overflowed INP flags; use INP2 prefix to avoid misuse.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP2_TIMEWAIT</span>		0x00000001 <span class="enscript-comment">/* in TIMEWAIT */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP2_IN_FCTREE</span>		0x00000002 <span class="enscript-comment">/* in inp_fc_tree */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP2_WANT_APP_POLICY</span>	0x00000004 <span class="enscript-comment">/* necp app policy check is desired */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP2_NO_IFF_EXPENSIVE</span>	0x00000008 <span class="enscript-comment">/* do not use expensive interface */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP2_INHASHLIST</span>		0x00000010 <span class="enscript-comment">/* pcb is in inp_hash list */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP2_AWDL_UNRESTRICTED</span>	0x00000020 <span class="enscript-comment">/* AWDL restricted mode allowed */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INP2_KEEPALIVE_OFFLOAD</span>	0x00000040 <span class="enscript-comment">/* Enable UDP keepalive offload */</span>

<span class="enscript-comment">/*
 * Flags passed to in_pcblookup*() functions.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INPLOOKUP_WILDCARD</span>	1

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">sotoinpcb</span>(so)	((struct inpcb *)(so)-&gt;so_pcb)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">sotoin6pcb</span>(so)	sotoinpcb(so)

<span class="enscript-type">struct</span> sysctl_req;

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> ipport_lowfirstauto;
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> ipport_lowlastauto;
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> ipport_firstauto;
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> ipport_lastauto;
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> ipport_hifirstauto;
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> ipport_hilastauto;

<span class="enscript-comment">/* freshly allocated PCB, it's in use */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INPCB_STATE_INUSE</span>	0x1
<span class="enscript-comment">/* this pcb is sitting in a a cache */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INPCB_STATE_CACHED</span>	0x2
<span class="enscript-comment">/* should treat as gone, will be garbage collected and freed */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INPCB_STATE_DEAD</span>	0x3

<span class="enscript-comment">/* marked as ready to be garbaged collected, should be treated as not found */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">WNT_STOPUSING</span>		0xffff
<span class="enscript-comment">/* that pcb is being acquired, do not recycle this time */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">WNT_ACQUIRE</span>		0x1
<span class="enscript-comment">/* release acquired mode, can be garbage collected when wantcnt is null */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">WNT_RELEASE</span>		0x2

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">in_pcbinit</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">in_pcbinfo_attach</span>(<span class="enscript-type">struct</span> inpcbinfo *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">in_pcbinfo_detach</span>(<span class="enscript-type">struct</span> inpcbinfo *);

<span class="enscript-comment">/* type of timer to be scheduled by inpcb_gc_sched and inpcb_timer_sched */</span>
<span class="enscript-type">enum</span> {
	INPCB_TIMER_LAZY = 0x1,
	INPCB_TIMER_FAST,
	INPCB_TIMER_NODELAY
};
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">inpcb_gc_sched</span>(<span class="enscript-type">struct</span> inpcbinfo *, u_int32_t type);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">inpcb_timer_sched</span>(<span class="enscript-type">struct</span> inpcbinfo *, u_int32_t type);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">in_losing</span>(<span class="enscript-type">struct</span> inpcb *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">in_rtchange</span>(<span class="enscript-type">struct</span> inpcb *, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">in_pcballoc</span>(<span class="enscript-type">struct</span> socket *, <span class="enscript-type">struct</span> inpcbinfo *, <span class="enscript-type">struct</span> proc *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">in_pcbbind</span>(<span class="enscript-type">struct</span> inpcb *, <span class="enscript-type">struct</span> sockaddr *, <span class="enscript-type">struct</span> proc *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">in_pcbconnect</span>(<span class="enscript-type">struct</span> inpcb *, <span class="enscript-type">struct</span> sockaddr *, <span class="enscript-type">struct</span> proc *,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>, <span class="enscript-type">struct</span> ifnet **);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">in_pcbdetach</span>(<span class="enscript-type">struct</span> inpcb *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">in_pcbdispose</span>(<span class="enscript-type">struct</span> inpcb *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">in_pcbdisconnect</span>(<span class="enscript-type">struct</span> inpcb *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">in_pcbinshash</span>(<span class="enscript-type">struct</span> inpcb *, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">in_pcbladdr</span>(<span class="enscript-type">struct</span> inpcb *, <span class="enscript-type">struct</span> sockaddr *, <span class="enscript-type">struct</span> in_addr *,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>, <span class="enscript-type">struct</span> ifnet **);
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> inpcb *<span class="enscript-function-name">in_pcblookup_local</span>(<span class="enscript-type">struct</span> inpcbinfo *, <span class="enscript-type">struct</span> in_addr,
    u_int, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> inpcb *<span class="enscript-function-name">in_pcblookup_local_and_cleanup</span>(<span class="enscript-type">struct</span> inpcbinfo *,
    <span class="enscript-type">struct</span> in_addr, u_int, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> inpcb *<span class="enscript-function-name">in_pcblookup_hash</span>(<span class="enscript-type">struct</span> inpcbinfo *, <span class="enscript-type">struct</span> in_addr,
    u_int, <span class="enscript-type">struct</span> in_addr, u_int, <span class="enscript-type">int</span>, <span class="enscript-type">struct</span> ifnet *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">in_pcblookup_hash_exists</span>(<span class="enscript-type">struct</span> inpcbinfo *, <span class="enscript-type">struct</span> in_addr,
    u_int, <span class="enscript-type">struct</span> in_addr, u_int, <span class="enscript-type">int</span>, uid_t *, gid_t *, <span class="enscript-type">struct</span> ifnet *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">in_pcbnotifyall</span>(<span class="enscript-type">struct</span> inpcbinfo *, <span class="enscript-type">struct</span> in_addr, <span class="enscript-type">int</span>,
    <span class="enscript-type">void</span> (*)(<span class="enscript-type">struct</span> inpcb *, <span class="enscript-type">int</span>));
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">in_pcbrehash</span>(<span class="enscript-type">struct</span> inpcb *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">in_getpeeraddr</span>(<span class="enscript-type">struct</span> socket *, <span class="enscript-type">struct</span> sockaddr **);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">in_getpeeraddr_s</span>(<span class="enscript-type">struct</span> socket *, <span class="enscript-type">struct</span> sockaddr_storage *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">in_getsockaddr</span>(<span class="enscript-type">struct</span> socket *, <span class="enscript-type">struct</span> sockaddr **);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">in_getsockaddr_s</span>(<span class="enscript-type">struct</span> socket *, <span class="enscript-type">struct</span> sockaddr_storage *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">in_pcb_checkstate</span>(<span class="enscript-type">struct</span> inpcb *, <span class="enscript-type">int</span>, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">in_pcbremlists</span>(<span class="enscript-type">struct</span> inpcb *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">inpcb_to_compat</span>(<span class="enscript-type">struct</span> inpcb *, <span class="enscript-type">struct</span> inpcb_compat *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">inpcb_to_xinpcb64</span>(<span class="enscript-type">struct</span> inpcb *, <span class="enscript-type">struct</span> xinpcb64 *);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">get_pcblist_n</span>(<span class="enscript-type">short</span>, <span class="enscript-type">struct</span> sysctl_req *, <span class="enscript-type">struct</span> inpcbinfo *);
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INPCB_GET_PORTS_USED_WILDCARDOK</span>	0x01
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INPCB_GET_PORTS_USED_NOWAKEUPOK</span>	0x02
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INPCB_GET_PORTS_USED_RECVANYIFONLY</span> 0x04
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INPCB_GET_PORTS_USED_EXTBGIDLEONLY</span> 0x08
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INPCB_GET_PORTS_USED_ACTIVEONLY</span> 0x10

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">inpcb_get_ports_used</span>(u_int32_t, <span class="enscript-type">int</span>, u_int32_t, bitstr_t *,
    <span class="enscript-type">struct</span> inpcbinfo *);
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INPCB_OPPORTUNISTIC_THROTTLEON</span>	0x0001
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">INPCB_OPPORTUNISTIC_SETCMD</span>	0x0002
<span class="enscript-type">extern</span> uint32_t <span class="enscript-function-name">inpcb_count_opportunistic</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>, <span class="enscript-type">struct</span> inpcbinfo *,
    u_int32_t);
<span class="enscript-type">extern</span> uint32_t <span class="enscript-function-name">inpcb_find_anypcb_byaddr</span>(<span class="enscript-type">struct</span> ifaddr *, <span class="enscript-type">struct</span> inpcbinfo *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">inp_route_copyout</span>(<span class="enscript-type">struct</span> inpcb *, <span class="enscript-type">struct</span> route *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">inp_route_copyin</span>(<span class="enscript-type">struct</span> inpcb *, <span class="enscript-type">struct</span> route *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">inp_bindif</span>(<span class="enscript-type">struct</span> inpcb *, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>, <span class="enscript-type">struct</span> ifnet **);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">inp_set_nocellular</span>(<span class="enscript-type">struct</span> inpcb *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">inp_clear_nocellular</span>(<span class="enscript-type">struct</span> inpcb *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">inp_set_noexpensive</span>(<span class="enscript-type">struct</span> inpcb *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">inp_set_awdl_unrestricted</span>(<span class="enscript-type">struct</span> inpcb *);
<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">inp_get_awdl_unrestricted</span>(<span class="enscript-type">struct</span> inpcb *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">inp_clear_awdl_unrestricted</span>(<span class="enscript-type">struct</span> inpcb *);
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">NECP</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">inp_update_necp_policy</span>(<span class="enscript-type">struct</span> inpcb *, <span class="enscript-type">struct</span> sockaddr *, <span class="enscript-type">struct</span> sockaddr *, u_int);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">inp_set_want_app_policy</span>(<span class="enscript-type">struct</span> inpcb *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">inp_clear_want_app_policy</span>(<span class="enscript-type">struct</span> inpcb *);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* NECP */</span>
<span class="enscript-type">extern</span> u_int32_t <span class="enscript-function-name">inp_calc_flowhash</span>(<span class="enscript-type">struct</span> inpcb *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">inp_reset_fc_state</span>(<span class="enscript-type">struct</span> inpcb *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">inp_set_fc_state</span>(<span class="enscript-type">struct</span> inpcb *, <span class="enscript-type">int</span> advcode);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">inp_fc_unthrottle_tcp</span>(<span class="enscript-type">struct</span> inpcb *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">inp_flowadv</span>(uint32_t);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">inp_flush</span>(<span class="enscript-type">struct</span> inpcb *, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">inp_findinpcb_procinfo</span>(<span class="enscript-type">struct</span> inpcbinfo *, uint32_t, <span class="enscript-type">struct</span> so_procinfo *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">inp_get_soprocinfo</span>(<span class="enscript-type">struct</span> inpcb *, <span class="enscript-type">struct</span> so_procinfo *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">inp_update_policy</span>(<span class="enscript-type">struct</span> inpcb *);
<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">inp_restricted_recv</span>(<span class="enscript-type">struct</span> inpcb *, <span class="enscript-type">struct</span> ifnet *);
<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">inp_restricted_send</span>(<span class="enscript-type">struct</span> inpcb *, <span class="enscript-type">struct</span> ifnet *);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* BSD_KERNEL_PRIVATE */</span>
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL_PRIVATE</span>
<span class="enscript-comment">/* exported for PPP */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">inp_clear_INP_INADDR_ANY</span>(<span class="enscript-type">struct</span> socket *);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL_PRIVATE */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !_NETINET_IN_PCB_H_ */</span>
</pre>
<hr />
</body></html>