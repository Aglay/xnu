<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>ip_fw2_compat.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">ip_fw2_compat.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/* IPFW backward compatibility */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_IP_FW_COMPAT_H_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_IP_FW_COMPAT_H_</span>

<span class="enscript-comment">/* prototypes */</span>
<span class="enscript-type">void</span>	ipfw_convert_from_latest(<span class="enscript-type">struct</span> ip_fw *curr_rule, <span class="enscript-type">void</span> *old_rule, u_int32_t api_version, <span class="enscript-type">int</span> is64user);
<span class="enscript-type">int</span>		ipfw_convert_to_latest(<span class="enscript-type">struct</span> sockopt *sopt, <span class="enscript-type">struct</span> ip_fw *rule, <span class="enscript-type">int</span> api_version, <span class="enscript-type">int</span> is64user);
<span class="enscript-type">int</span>	ipfw_get_command_and_version(<span class="enscript-type">struct</span> sockopt *sopt, <span class="enscript-type">int</span> *command, u_int32_t *api_version);


<span class="enscript-comment">/*
 * ******************************
 * ****** IPFW version one ******
 * ******************************
 */</span>

<span class="enscript-comment">/*
 * This union structure identifies an interface, either explicitly
 * by name or implicitly by IP address. The flags IP_FW_F_IIFNAME
 * and IP_FW_F_OIFNAME say how to interpret this structure. An
 * interface unit number of -1 matches any unit number, while an
 * IP address of 0.0.0.0 indicates matches any interface.
 *
 * The receive and transmit interfaces are only compared against the
 * the packet if the corresponding bit (IP_FW_F_IIFACE or IP_FW_F_OIFACE)
 * is set. Note some packets lack a receive or transmit interface
 * (in which case the missing &quot;interface&quot; never matches).
 */</span>

<span class="enscript-type">union</span> ip_fw_if_compat {
    <span class="enscript-type">struct</span> in_addr fu_via_ip;	<span class="enscript-comment">/* Specified by IP address */</span>
    <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* Specified by interface name */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">FW_IFNLEN_COMPAT</span>     10 <span class="enscript-comment">/* need room ! was IFNAMSIZ */</span>
	    <span class="enscript-type">char</span>  name[FW_IFNLEN_COMPAT];
	    <span class="enscript-type">short</span> unit;		<span class="enscript-comment">/* -1 means match any unit */</span>
    } fu_via_if_compat;
};

<span class="enscript-comment">/*
 * Format of an IP firewall descriptor
 *
 * fw_src, fw_dst, fw_smsk, fw_dmsk are always stored in network byte order.
 * fw_flg and fw_n*p are stored in host byte order (of course).
 * Port numbers are stored in HOST byte order.
 */</span>


<span class="enscript-type">struct</span> ip_fw_compat {
	u_int32_t version;		<span class="enscript-comment">/* Version of this structure.  Should always be */</span>
							<span class="enscript-comment">/* set to IP_FW_CURRENT_API_VERSION by clients. */</span>
	<span class="enscript-type">void</span> *context;			<span class="enscript-comment">/* Context that is usable by user processes to */</span>
							<span class="enscript-comment">/* identify this rule. */</span>
    u_int64_t fw_pcnt,fw_bcnt;		<span class="enscript-comment">/* Packet and byte counters */</span>
    <span class="enscript-type">struct</span> in_addr fw_src, fw_dst;	<span class="enscript-comment">/* Source and destination IP addr */</span>
    <span class="enscript-type">struct</span> in_addr fw_smsk, fw_dmsk;	<span class="enscript-comment">/* Mask for src and dest IP addr */</span>
    u_short fw_number;			<span class="enscript-comment">/* Rule number */</span>
    u_int fw_flg;			<span class="enscript-comment">/* Flags word */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_MAX_PORTS_COMPAT</span>	10		<span class="enscript-comment">/* A reasonable maximum */</span>
	<span class="enscript-type">union</span> {
		u_short fw_pts[IP_FW_MAX_PORTS_COMPAT];	<span class="enscript-comment">/* Array of port numbers to match */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_ICMPTYPES_MAX_COMPAT</span>	128
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_ICMPTYPES_DIM_COMPAT</span>	(IP_FW_ICMPTYPES_MAX_COMPAT / (sizeof(unsigned) * 8))
		<span class="enscript-type">unsigned</span> fw_icmptypes[IP_FW_ICMPTYPES_DIM_COMPAT]; <span class="enscript-comment">/* ICMP types bitmap */</span>
	} fw_uar_compat;
    u_int fw_ipflg;			<span class="enscript-comment">/* IP flags word */</span>
    u_char fw_ipopt,fw_ipnopt;		<span class="enscript-comment">/* IP options set/unset */</span>
    u_char fw_tcpopt,fw_tcpnopt;	<span class="enscript-comment">/* TCP options set/unset */</span>
    u_char fw_tcpf,fw_tcpnf;		<span class="enscript-comment">/* TCP flags set/unset */</span>
    <span class="enscript-type">long</span> timestamp;			<span class="enscript-comment">/* timestamp (tv_sec) of last match */</span>
    <span class="enscript-type">union</span> ip_fw_if_compat fw_in_if, fw_out_if;	<span class="enscript-comment">/* Incoming and outgoing interfaces */</span>
    <span class="enscript-type">union</span> {
		u_short fu_divert_port;		<span class="enscript-comment">/* Divert/tee port (options IPDIVERT) */</span>
		u_short fu_pipe_nr;		<span class="enscript-comment">/* queue number (option DUMMYNET) */</span>
		u_short fu_skipto_rule;		<span class="enscript-comment">/* SKIPTO command rule number */</span>
		u_short fu_reject_code;		<span class="enscript-comment">/* REJECT response code */</span>
		<span class="enscript-type">struct</span> sockaddr_in fu_fwd_ip;
    } fw_un_compat;
    u_char fw_prot;			<span class="enscript-comment">/* IP protocol */</span>
	<span class="enscript-comment">/*
	 * N'of src ports and # of dst ports in ports array (dst ports
	 * follow src ports; max of 10 ports in all; count of 0 means
	 * match all ports)
	 */</span>
    u_char fw_nports;
    <span class="enscript-type">void</span> *pipe_ptr;                    <span class="enscript-comment">/* flow_set ptr for dummynet pipe */</span>
    <span class="enscript-type">void</span> *next_rule_ptr ;              <span class="enscript-comment">/* next rule in case of match */</span>
    uid_t fw_uid;			<span class="enscript-comment">/* uid to match */</span>
    <span class="enscript-type">int</span> fw_logamount;			<span class="enscript-comment">/* amount to log */</span>
    u_int64_t fw_loghighest;		<span class="enscript-comment">/* highest number packet to log */</span>
};

<span class="enscript-comment">/*
 * extended ipfw structure... some fields in the original struct
 * can be used to pass parameters up/down, namely pointers
 *     void *pipe_ptr
 *     void *next_rule_ptr 
 * some others can be used to pass parameters down, namely counters etc.
 *     u_int64_t fw_pcnt,fw_bcnt;
 *     long timestamp;
 */</span>

<span class="enscript-type">struct</span> ip_fw_ext_compat {             <span class="enscript-comment">/* extended structure */</span>
    <span class="enscript-type">struct</span> ip_fw rule;      <span class="enscript-comment">/* must be at offset 0 */</span>
    <span class="enscript-type">long</span>    dont_match_prob;        <span class="enscript-comment">/* 0x7fffffff means 1.0, always fail */</span>
    u_int   dyn_type;  <span class="enscript-comment">/* type for dynamic rule */</span>
};

<span class="enscript-type">struct</span> ip_fw_chain_compat {
	LIST_ENTRY(ip_fw_chain_compat) next;
	<span class="enscript-type">struct</span> ip_fw_compat *rule;
};

<span class="enscript-comment">/*
 * dynamic ipfw rule
 */</span>
 
<span class="enscript-type">struct</span> ipfw_dyn_rule_compat {
    <span class="enscript-type">struct</span> ipfw_dyn_rule *next ;

    <span class="enscript-type">struct</span> ipfw_flow_id id ;
    <span class="enscript-type">struct</span> ipfw_flow_id mask ;
    <span class="enscript-type">struct</span> ip_fw_chain_compat *chain ;		<span class="enscript-comment">/* pointer to parent rule	*/</span>
    u_int32_t type ;			<span class="enscript-comment">/* rule type			*/</span>
    u_int32_t expire ;			<span class="enscript-comment">/* expire time			*/</span>
    u_int64_t pcnt, bcnt;		<span class="enscript-comment">/* match counters		*/</span>
    u_int32_t bucket ;			<span class="enscript-comment">/* which bucket in hash table	*/</span>
    u_int32_t state ;			<span class="enscript-comment">/* state of this rule (typ. a   */</span>
					<span class="enscript-comment">/* combination of TCP flags)	*/</span>
} ;

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">BSD_KERNEL_PRIVATE</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">pack</span>(4)

<span class="enscript-type">struct</span> ip_fw_compat_32 {
	u_int32_t version;		<span class="enscript-comment">/* Version of this structure.  Should always be */</span>
							<span class="enscript-comment">/* set to IP_FW_CURRENT_API_VERSION by clients. */</span>
	user32_addr_t context;	<span class="enscript-comment">/* Context that is usable by user processes to */</span>
							<span class="enscript-comment">/* identify this rule. */</span>
    u_int64_t fw_pcnt,fw_bcnt;		<span class="enscript-comment">/* Packet and byte counters */</span>
    <span class="enscript-type">struct</span> in_addr fw_src, fw_dst;	<span class="enscript-comment">/* Source and destination IP addr */</span>
    <span class="enscript-type">struct</span> in_addr fw_smsk, fw_dmsk;<span class="enscript-comment">/* Mask for src and dest IP addr */</span>
    u_short fw_number;		<span class="enscript-comment">/* Rule number */</span>
    u_int fw_flg;			<span class="enscript-comment">/* Flags word */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_MAX_PORTS_COMPAT</span>	10		<span class="enscript-comment">/* A reasonable maximum */</span>
	<span class="enscript-type">union</span> {
		u_short fw_pts[IP_FW_MAX_PORTS_COMPAT];	<span class="enscript-comment">/* Array of port numbers to match */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_ICMPTYPES_MAX_COMPAT</span>	128
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_ICMPTYPES_DIM_COMPAT</span>	(IP_FW_ICMPTYPES_MAX_COMPAT / (sizeof(unsigned) * 8))
		<span class="enscript-type">unsigned</span> fw_icmptypes[IP_FW_ICMPTYPES_DIM_COMPAT]; <span class="enscript-comment">/* ICMP types bitmap */</span>
	} fw_uar_compat;
    u_int fw_ipflg;			<span class="enscript-comment">/* IP flags word */</span>
    u_char fw_ipopt,fw_ipnopt;		<span class="enscript-comment">/* IP options set/unset */</span>
    u_char fw_tcpopt,fw_tcpnopt;	<span class="enscript-comment">/* TCP options set/unset */</span>
    u_char fw_tcpf,fw_tcpnf;		<span class="enscript-comment">/* TCP flags set/unset */</span>
    u_int32_t timestamp;			<span class="enscript-comment">/* timestamp (tv_sec) of last match */</span>
    <span class="enscript-type">union</span> ip_fw_if_compat fw_in_if, fw_out_if;	<span class="enscript-comment">/* Incoming and outgoing interfaces */</span>
    <span class="enscript-type">union</span> {
		u_short fu_divert_port;		<span class="enscript-comment">/* Divert/tee port (options IPDIVERT) */</span>
		u_short fu_pipe_nr;		<span class="enscript-comment">/* queue number (option DUMMYNET) */</span>
		u_short fu_skipto_rule;		<span class="enscript-comment">/* SKIPTO command rule number */</span>
		u_short fu_reject_code;		<span class="enscript-comment">/* REJECT response code */</span>
		<span class="enscript-type">struct</span> sockaddr_in fu_fwd_ip;
    } fw_un_compat;
    u_char fw_prot;			<span class="enscript-comment">/* IP protocol */</span>
	<span class="enscript-comment">/*
	 * N'of src ports and # of dst ports in ports array (dst ports
	 * follow src ports; max of 10 ports in all; count of 0 means
	 * match all ports)
	 */</span>
    u_char fw_nports;
    user32_addr_t pipe_ptr;                    <span class="enscript-comment">/* flow_set ptr for dummynet pipe */</span>
    user32_addr_t next_rule_ptr ;              <span class="enscript-comment">/* next rule in case of match */</span>
    uid_t fw_uid;			<span class="enscript-comment">/* uid to match */</span>
    <span class="enscript-type">int</span> fw_logamount;			<span class="enscript-comment">/* amount to log */</span>
    u_int64_t fw_loghighest;		<span class="enscript-comment">/* highest number packet to log */</span>
};
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">pack</span>()

<span class="enscript-type">struct</span> ip_fw_compat_64 {
	u_int32_t version;		<span class="enscript-comment">/* Version of this structure.  Should always be */</span>
							<span class="enscript-comment">/* set to IP_FW_CURRENT_API_VERSION by clients. */</span>
	user64_addr_t context;			<span class="enscript-comment">/* Context that is usable by user processes to */</span>
									<span class="enscript-comment">/* identify this rule. */</span>
    u_int64_t fw_pcnt,fw_bcnt;		<span class="enscript-comment">/* Packet and byte counters */</span>
    <span class="enscript-type">struct</span> in_addr fw_src, fw_dst;	<span class="enscript-comment">/* Source and destination IP addr */</span>
    <span class="enscript-type">struct</span> in_addr fw_smsk, fw_dmsk;<span class="enscript-comment">/* Mask for src and dest IP addr */</span>
    u_short fw_number;				<span class="enscript-comment">/* Rule number */</span>
    u_int fw_flg;					<span class="enscript-comment">/* Flags word */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_MAX_PORTS_COMPAT</span>	10		<span class="enscript-comment">/* A reasonable maximum */</span>
	<span class="enscript-type">union</span> {
		u_short fw_pts[IP_FW_MAX_PORTS_COMPAT];	<span class="enscript-comment">/* Array of port numbers to match */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_ICMPTYPES_MAX_COMPAT</span>	128
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_ICMPTYPES_DIM_COMPAT</span>	(IP_FW_ICMPTYPES_MAX_COMPAT / (sizeof(unsigned) * 8))
		<span class="enscript-type">unsigned</span> fw_icmptypes[IP_FW_ICMPTYPES_DIM_COMPAT]; <span class="enscript-comment">/* ICMP types bitmap */</span>
	} fw_uar_compat;
    u_int fw_ipflg;					<span class="enscript-comment">/* IP flags word */</span>
    u_char fw_ipopt,fw_ipnopt;		<span class="enscript-comment">/* IP options set/unset */</span>
    u_char fw_tcpopt,fw_tcpnopt;	<span class="enscript-comment">/* TCP options set/unset */</span>
    u_char fw_tcpf,fw_tcpnf;		<span class="enscript-comment">/* TCP flags set/unset */</span>
    u_int64_t timestamp;			<span class="enscript-comment">/* timestamp (tv_sec) of last match */</span>
    <span class="enscript-type">union</span> ip_fw_if_compat fw_in_if, fw_out_if;	<span class="enscript-comment">/* Incoming and outgoing interfaces */</span>
    <span class="enscript-type">union</span> {
		u_short fu_divert_port;		<span class="enscript-comment">/* Divert/tee port (options IPDIVERT) */</span>
		u_short fu_pipe_nr;			<span class="enscript-comment">/* queue number (option DUMMYNET) */</span>
		u_short fu_skipto_rule;		<span class="enscript-comment">/* SKIPTO command rule number */</span>
		u_short fu_reject_code;		<span class="enscript-comment">/* REJECT response code */</span>
		<span class="enscript-type">struct</span> sockaddr_in fu_fwd_ip;
    } fw_un_compat;
    u_char fw_prot;			<span class="enscript-comment">/* IP protocol */</span>
	<span class="enscript-comment">/*
	 * N'of src ports and # of dst ports in ports array (dst ports
	 * follow src ports; max of 10 ports in all; count of 0 means
	 * match all ports)
	 */</span>
    u_char fw_nports;
    user64_addr_t pipe_ptr;                    <span class="enscript-comment">/* flow_set ptr for dummynet pipe */</span>
    user64_addr_t next_rule_ptr ;              <span class="enscript-comment">/* next rule in case of match */</span>
    uid_t fw_uid;								<span class="enscript-comment">/* uid to match */</span>
    <span class="enscript-type">int</span> fw_logamount;							<span class="enscript-comment">/* amount to log */</span>
    u_int64_t fw_loghighest;					<span class="enscript-comment">/* highest number packet to log */</span>
};

<span class="enscript-type">struct</span> ipfw_dyn_rule_compat_32 {
    user32_addr_t next ;

    <span class="enscript-type">struct</span> ipfw_flow_id id ;
    <span class="enscript-type">struct</span> ipfw_flow_id mask ;
    user32_addr_t chain ;		<span class="enscript-comment">/* pointer to parent rule	*/</span>
    u_int32_t type ;			<span class="enscript-comment">/* rule type			*/</span>
    u_int32_t expire ;			<span class="enscript-comment">/* expire time			*/</span>
    u_int64_t pcnt, bcnt;		<span class="enscript-comment">/* match counters		*/</span>
    u_int32_t bucket ;			<span class="enscript-comment">/* which bucket in hash table	*/</span>
    u_int32_t state ;			<span class="enscript-comment">/* state of this rule (typ. a   */</span>
					<span class="enscript-comment">/* combination of TCP flags)	*/</span>
} ;

<span class="enscript-type">struct</span> ipfw_dyn_rule_compat_64 {
    user64_addr_t next ;

    <span class="enscript-type">struct</span> ipfw_flow_id id ;
    <span class="enscript-type">struct</span> ipfw_flow_id mask ;
    user64_addr_t chain ;		<span class="enscript-comment">/* pointer to parent rule	*/</span>
    u_int32_t type ;			<span class="enscript-comment">/* rule type			*/</span>
    u_int32_t expire ;			<span class="enscript-comment">/* expire time			*/</span>
    u_int64_t pcnt, bcnt;		<span class="enscript-comment">/* match counters		*/</span>
    u_int32_t bucket ;			<span class="enscript-comment">/* which bucket in hash table	*/</span>
    u_int32_t state ;			<span class="enscript-comment">/* state of this rule (typ. a   */</span>
					<span class="enscript-comment">/* combination of TCP flags)	*/</span>
} ;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* BSD_KERNEL_PRIVATE */</span>


#<span class="enscript-reference">define</span> <span class="enscript-function-name">IP_FW_GETNSRCP_COMPAT</span>(rule)		((rule)-&gt;fw_nports &amp; 0x0f)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">IP_FW_SETNSRCP_COMPAT</span>(rule, n)		do {				\
					  (rule)-&gt;fw_nports &amp;= ~0x0f;	\
					  (rule)-&gt;fw_nports |= (n);	\
					} <span class="enscript-keyword">while</span> (0)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">IP_FW_GETNDSTP_COMPAT</span>(rule)		((rule)-&gt;fw_nports &gt;&gt; 4)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">IP_FW_SETNDSTP_COMPAT</span>(rule, n)		do {				\
					  (rule)-&gt;fw_nports &amp;= ~0xf0;	\
					  (rule)-&gt;fw_nports |= (n) &lt;&lt; 4;\
					} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fw_divert_port_compat</span>	fw_un_compat.fu_divert_port
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fw_skipto_rule_compat</span>	fw_un_compat.fu_skipto_rule
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fw_reject_code_compat</span>	fw_un_compat.fu_reject_code
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fw_pipe_nr_compat</span>	fw_un_compat.fu_pipe_nr
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">fw_fwd_ip_compat</span>	fw_un_compat.fu_fwd_ip

<span class="enscript-comment">/*
 * Values for &quot;flags&quot; field .
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_COMMAND_COMPAT</span> 0x000000ff	<span class="enscript-comment">/* Mask for type of chain entry:	*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_DENY_COMPAT</span>	0x00000000	<span class="enscript-comment">/* This is a deny rule			*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_REJECT_COMPAT</span>	0x00000001	<span class="enscript-comment">/* Deny and send a response packet	*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_ACCEPT_COMPAT</span>	0x00000002	<span class="enscript-comment">/* This is an accept rule		*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_COUNT_COMPAT</span>	0x00000003	<span class="enscript-comment">/* This is a count rule			*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_DIVERT_COMPAT</span>	0x00000004	<span class="enscript-comment">/* This is a divert rule		*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_TEE_COMPAT</span>	0x00000005	<span class="enscript-comment">/* This is a tee rule			*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_SKIPTO_COMPAT</span>	0x00000006	<span class="enscript-comment">/* This is a skipto rule		*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_FWD_COMPAT</span>	0x00000007	<span class="enscript-comment">/* This is a &quot;change forwarding address&quot; rule */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_PIPE_COMPAT</span>	0x00000008	<span class="enscript-comment">/* This is a dummynet rule */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_QUEUE_COMPAT</span>	0x00000009	<span class="enscript-comment">/* This is a dummynet queue */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_IN_COMPAT</span>	0x00000100	<span class="enscript-comment">/* Check inbound packets		*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_OUT_COMPAT</span>	0x00000200	<span class="enscript-comment">/* Check outbound packets		*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_IIFACE_COMPAT</span>	0x00000400	<span class="enscript-comment">/* Apply inbound interface test		*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_OIFACE_COMPAT</span>	0x00000800	<span class="enscript-comment">/* Apply outbound interface test	*/</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_PRN_COMPAT</span>	0x00001000	<span class="enscript-comment">/* Print if this rule matches		*/</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_SRNG_COMPAT</span>	0x00002000	<span class="enscript-comment">/* The first two src ports are a min	*
					 * and max range (stored in host byte	*
					 * order).				*/</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_DRNG_COMPAT</span>	0x00004000	<span class="enscript-comment">/* The first two dst ports are a min	*
					 * and max range (stored in host byte	*
					 * order).				*/</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_FRAG_COMPAT</span>	0x00008000	<span class="enscript-comment">/* Fragment				*/</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_IIFNAME_COMPAT</span>	0x00010000	<span class="enscript-comment">/* In interface by name/unit (not IP)	*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_OIFNAME_COMPAT</span>	0x00020000	<span class="enscript-comment">/* Out interface by name/unit (not IP)	*/</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_INVSRC_COMPAT</span>	0x00040000	<span class="enscript-comment">/* Invert sense of src check		*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_INVDST_COMPAT</span>	0x00080000	<span class="enscript-comment">/* Invert sense of dst check		*/</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_ICMPBIT_COMPAT</span> 0x00100000	<span class="enscript-comment">/* ICMP type bitmap is valid		*/</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_UID_COMPAT</span>	0x00200000	<span class="enscript-comment">/* filter by uid			*/</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_RND_MATCH_COMPAT</span> 0x00800000	<span class="enscript-comment">/* probabilistic rule match		*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_SMSK_COMPAT</span>	0x01000000	<span class="enscript-comment">/* src-port + mask 			*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_DMSK_COMPAT</span>	0x02000000	<span class="enscript-comment">/* dst-port + mask 			*/</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">IP_FW_BRIDGED_COMPAT</span>	0x04000000	<span class="enscript-comment">/* only match bridged packets		*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_KEEP_S_COMPAT</span>	0x08000000	<span class="enscript-comment">/* keep state	 			*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_CHECK_S_COMPAT</span>	0x10000000	<span class="enscript-comment">/* check state	 			*/</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_SME_COMPAT</span>	0x20000000	<span class="enscript-comment">/* source = me				*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_DME_COMPAT</span>	0x40000000	<span class="enscript-comment">/* destination = me			*/</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_F_MASK_COMPAT</span>	0x7FFFFFFF	<span class="enscript-comment">/* All possible flag bits mask		*/</span>

<span class="enscript-comment">/*
 * Flags for the 'fw_ipflg' field, for comparing values of ip and its protocols.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">IP_FW_IF_TCPEST_COMPAT</span>	0x00000020	<span class="enscript-comment">/* established TCP connection */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">IP_FW_IF_TCPMSK_COMPAT</span>	0x00000020	<span class="enscript-comment">/* mask of all TCP values */</span>

<span class="enscript-comment">/*
 * Definitions for TCP flags.
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_TCPF_FIN_COMPAT</span>		TH_FIN
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_TCPF_SYN_COMPAT</span>		TH_SYN
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_TCPF_RST_COMPAT</span>		TH_RST
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_TCPF_PSH_COMPAT</span>		TH_PUSH
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_TCPF_ACK_COMPAT</span>		TH_ACK
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_TCPF_URG_COMPAT</span>		TH_URG

<span class="enscript-comment">/*
 * For backwards compatibility with rules specifying &quot;via iface&quot; but
 * not restricted to only &quot;in&quot; or &quot;out&quot; packets, we define this combination
 * of bits to represent this configuration.
 */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IF_FW_F_VIAHACK_COMPAT</span>	(IP_FW_F_IN_COMPAT|IP_FW_F_OUT_COMPAT|IP_FW_F_IIFACE_COMPAT|IP_FW_F_OIFACE_COMPAT)

<span class="enscript-comment">/*
 * Definitions for REJECT response codes.
 * Values less than 256 correspond to ICMP unreachable codes.
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_FW_REJECT_RST_COMPAT</span>	0x0100		<span class="enscript-comment">/* TCP packets: send RST */</span>


<span class="enscript-comment">/*
 * ******************************
 * ****** IPFW version zero *****
 * ******************************
 */</span>

<span class="enscript-comment">/*
 * This union structure identifies an interface, either explicitly
 * by name or implicitly by IP address. The flags IP_FW_F_IIFNAME
 * and IP_FW_F_OIFNAME say how to interpret this structure. An
 * interface unit number of -1 matches any unit number, while an
 * IP address of 0.0.0.0 indicates matches any interface.
 *
 * The receive and transmit interfaces are only compared against the
 * the packet if the corresponding bit (IP_FW_F_IIFACE or IP_FW_F_OIFACE)
 * is set. Note some packets lack a receive or transmit interface
 * (in which case the missing &quot;interface&quot; never matches).
 */</span>

<span class="enscript-type">union</span> ip_old_fw_if {
    <span class="enscript-type">struct</span> in_addr fu_via_ip;	<span class="enscript-comment">/* Specified by IP address */</span>
    <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* Specified by interface name */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">OLD_FW_IFNLEN</span>     10 <span class="enscript-comment">/* need room ! was IFNAMSIZ */</span>
	    <span class="enscript-type">char</span>  name[OLD_FW_IFNLEN];
	    <span class="enscript-type">short</span> unit;		<span class="enscript-comment">/* -1 means match any unit */</span>
    } fu_via_if;
};

<span class="enscript-comment">/*
 * Format of an IP firewall descriptor
 *
 * fw_src, fw_dst, fw_smsk, fw_dmsk are always stored in network byte order.
 * fw_flg and fw_n*p are stored in host byte order (of course).
 * Port numbers are stored in HOST byte order.
 * Warning: setsockopt() will fail if sizeof(struct ip_fw) &gt; MLEN (108)
 */</span>

<span class="enscript-type">struct</span> ip_old_fw {
    u_int64_t fw_pcnt,fw_bcnt;		<span class="enscript-comment">/* Packet and byte counters */</span>
    <span class="enscript-type">struct</span> in_addr fw_src, fw_dst;	<span class="enscript-comment">/* Source and destination IP addr */</span>
    <span class="enscript-type">struct</span> in_addr fw_smsk, fw_dmsk;	<span class="enscript-comment">/* Mask for src and dest IP addr */</span>
    u_short fw_number;			<span class="enscript-comment">/* Rule number */</span>
    u_int fw_flg;			<span class="enscript-comment">/* Flags word */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_MAX_PORTS</span>	10		<span class="enscript-comment">/* A reasonable maximum */</span>
	<span class="enscript-type">union</span> {
	u_short fw_pts[IP_OLD_FW_MAX_PORTS];	<span class="enscript-comment">/* Array of port numbers to match */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_ICMPTYPES_MAX</span>	128
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_ICMPTYPES_DIM</span>	(IP_OLD_FW_ICMPTYPES_MAX / (sizeof(unsigned) * 8))
	<span class="enscript-type">unsigned</span> fw_icmptypes[IP_OLD_FW_ICMPTYPES_DIM]; <span class="enscript-comment">/* ICMP types bitmap */</span>
	} fw_uar;
    u_char fw_ipopt,fw_ipnopt;		<span class="enscript-comment">/* IP options set/unset */</span>
    u_char fw_tcpf,fw_tcpnf;		<span class="enscript-comment">/* TCP flags set/unset */</span>
    <span class="enscript-type">long</span> timestamp;			<span class="enscript-comment">/* timestamp (tv_sec) of last match */</span>
    <span class="enscript-type">union</span> ip_old_fw_if fw_in_if, fw_out_if;	<span class="enscript-comment">/* Incoming and outgoing interfaces */</span>
    <span class="enscript-type">union</span> {
	u_short fu_divert_port;		<span class="enscript-comment">/* Divert/tee port (options IPDIVERT) */</span>
	u_short fu_pipe_nr;		<span class="enscript-comment">/* pipe number (option DUMMYNET) */</span>
	u_short fu_skipto_rule;		<span class="enscript-comment">/* SKIPTO command rule number */</span>
	u_short fu_reject_code;		<span class="enscript-comment">/* REJECT response code */</span>
	<span class="enscript-type">struct</span> sockaddr_in fu_fwd_ip;
    } fw_un;
    u_char fw_prot;			<span class="enscript-comment">/* IP protocol */</span>
    u_char fw_nports;			<span class="enscript-comment">/* N'of src ports and # of dst ports */</span>
					<span class="enscript-comment">/* in ports array (dst ports follow */</span>
					<span class="enscript-comment">/* src ports; max of 10 ports in all; */</span>
					<span class="enscript-comment">/* count of 0 means match all ports) */</span>
    <span class="enscript-type">void</span> *pipe_ptr;                    <span class="enscript-comment">/* Pipe ptr in case of dummynet pipe */</span>
    <span class="enscript-type">void</span> *next_rule_ptr ;              <span class="enscript-comment">/* next rule in case of match */</span>
};

#<span class="enscript-reference">define</span> <span class="enscript-function-name">IP_OLD_FW_GETNSRCP</span>(rule)		((rule)-&gt;fw_nports &amp; 0x0f)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">IP_OLD_FW_SETNSRCP</span>(rule, n)		do {				\
					  (rule)-&gt;fw_nports &amp;= ~0x0f;	\
					  (rule)-&gt;fw_nports |= (n);	\
					} <span class="enscript-keyword">while</span> (0)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">IP_OLD_FW_GETNDSTP</span>(rule)		((rule)-&gt;fw_nports &gt;&gt; 4)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">IP_OLD_FW_SETNDSTP</span>(rule, n)		do {				\
					  (rule)-&gt;fw_nports &amp;= ~0xf0;	\
					  (rule)-&gt;fw_nports |= (n) &lt;&lt; 4;\
					} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">old_fw_divert_port</span>	fw_un.fu_divert_port
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">old_fw_skipto_rule</span>	fw_un.fu_skipto_rule
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">old_fw_reject_code</span>	fw_un.fu_reject_code
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">old_fw_pipe_nr</span>	fw_un.fu_pipe_nr
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">old_fw_fwd_ip</span>	fw_un.fu_fwd_ip

<span class="enscript-comment">/*
 * Values for &quot;flags&quot; field .
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_F_COMMAND</span> 0x000000ff	<span class="enscript-comment">/* Mask for type of chain entry:	*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_F_DENY</span>	0x00000000	<span class="enscript-comment">/* This is a deny rule			*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_F_REJECT</span>	0x00000001	<span class="enscript-comment">/* Deny and send a response packet	*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_F_ACCEPT</span>	0x00000002	<span class="enscript-comment">/* This is an accept rule		*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_F_COUNT</span>	0x00000003	<span class="enscript-comment">/* This is a count rule			*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_F_DIVERT</span>	0x00000004	<span class="enscript-comment">/* This is a divert rule		*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_F_TEE</span>	0x00000005	<span class="enscript-comment">/* This is a tee rule			*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_F_SKIPTO</span>	0x00000006	<span class="enscript-comment">/* This is a skipto rule		*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_F_FWD</span>	0x00000007	<span class="enscript-comment">/* This is a &quot;change forwarding address&quot; rule */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_F_PIPE</span>	0x00000008	<span class="enscript-comment">/* This is a dummynet rule */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_F_IN</span>	0x00000100	<span class="enscript-comment">/* Check inbound packets		*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_F_OUT</span>	0x00000200	<span class="enscript-comment">/* Check outbound packets		*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_F_IIFACE</span>	0x00000400	<span class="enscript-comment">/* Apply inbound interface test		*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_F_OIFACE</span>	0x00000800	<span class="enscript-comment">/* Apply outbound interface test	*/</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_F_PRN</span>	0x00001000	<span class="enscript-comment">/* Print if this rule matches		*/</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_F_SRNG</span>	0x00002000	<span class="enscript-comment">/* The first two src ports are a min	*
					 * and max range (stored in host byte	*
					 * order).				*/</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_F_DRNG</span>	0x00004000	<span class="enscript-comment">/* The first two dst ports are a min	*
					 * and max range (stored in host byte	*
					 * order).				*/</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_F_FRAG</span>	0x00008000	<span class="enscript-comment">/* Fragment				*/</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_F_IIFNAME</span>	0x00010000	<span class="enscript-comment">/* In interface by name/unit (not IP)	*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_F_OIFNAME</span>	0x00020000	<span class="enscript-comment">/* Out interface by name/unit (not IP)	*/</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_F_INVSRC</span>	0x00040000	<span class="enscript-comment">/* Invert sense of src check		*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_F_INVDST</span>	0x00080000	<span class="enscript-comment">/* Invert sense of dst check		*/</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_F_ICMPBIT</span> 0x00100000	<span class="enscript-comment">/* ICMP type bitmap is valid		*/</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_F_MASK</span>	0x001FFFFF	<span class="enscript-comment">/* All possible flag bits mask		*/</span>

<span class="enscript-comment">/*
 * For backwards compatibility with rules specifying &quot;via iface&quot; but
 * not restricted to only &quot;in&quot; or &quot;out&quot; packets, we define this combination
 * of bits to represent this configuration.
 */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IF_OLD_FW_F_VIAHACK</span>	(IP_OLD_FW_F_IN|IP_OLD_FW_F_OUT|IP_OLD_FW_F_IIFACE|IP_OLD_FW_F_OIFACE)

<span class="enscript-comment">/*
 * Definitions for TCP flags - abridged
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_OLD_FW_TCPF_ESTAB</span>	0x40

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* _IP_FW_COMPAT_H_ */</span>
</pre>
<hr />
</body></html>