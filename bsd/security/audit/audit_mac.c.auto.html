<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>audit_mac.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">audit_mac.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*-
 * Copyright (c) 1999-2008 Apple Inc.
 * All rights reserved.
 *
 * @APPLE_BSD_LICENSE_HEADER_START@
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1.  Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 * 2.  Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 * 3.  Neither the name of Apple Inc. (&quot;Apple&quot;) nor the names of
 *     its contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS &quot;AS IS&quot; AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
 * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING
 * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 *
 * @APPLE_BSD_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*
 * NOTICE: This file was modified by McAfee Research in 2004 to introduce
 * support for mandatory and extensible security protections.  This notice
 * is included in support of clause 2.2 (b) of the Apple Public License,
 * Version 2.0.
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/kernel.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/proc.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/kauth.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/queue.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/systm.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;bsm/audit.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;bsm/audit_internal.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;bsm/audit_kevents.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;security/audit/audit.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;security/audit/audit_private.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/host_priv.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/host_special_ports.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/audit_triggers_server.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/host.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/kalloc.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/zalloc.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/sched_prim.h&gt;</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_AUDIT</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_MACF</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;bsm/audit_record.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;security/mac.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;security/mac_framework.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;security/mac_policy.h&gt;</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MAC_ARG_PREFIX</span> <span class="enscript-string">&quot;arg: &quot;</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MAC_ARG_PREFIX_LEN</span> 5

zone_t		audit_mac_label_zone;
<span class="enscript-type">extern</span> zone_t	mac_audit_data_zone;

<span class="enscript-type">void</span>
<span class="enscript-function-name">audit_mac_init</span>(<span class="enscript-type">void</span>)
{
	<span class="enscript-comment">/* Assume 3 MAC labels for each audit record: two for vnodes,
	 * one for creds.
	 */</span>
	audit_mac_label_zone = zinit(MAC_AUDIT_LABEL_LEN,
	    AQ_HIWATER * 3*MAC_AUDIT_LABEL_LEN, 8192, <span class="enscript-string">&quot;audit_mac_label_zone&quot;</span>);
}

<span class="enscript-type">int</span>
<span class="enscript-function-name">audit_mac_new</span>(proc_t p, <span class="enscript-type">struct</span> kaudit_record *ar)
{
	<span class="enscript-type">struct</span> mac mac;

	<span class="enscript-comment">/* 
	 * Retrieve the MAC labels for the process.
	 */</span>
	ar-&gt;k_ar.ar_cred_mac_labels = (<span class="enscript-type">char</span> *)zalloc(audit_mac_label_zone);
	<span class="enscript-keyword">if</span> (ar-&gt;k_ar.ar_cred_mac_labels == NULL)
		<span class="enscript-keyword">return</span> (1);
	mac.m_buflen = MAC_AUDIT_LABEL_LEN;
	mac.m_string = ar-&gt;k_ar.ar_cred_mac_labels;
	mac_cred_label_externalize_audit(p, &amp;mac);

	<span class="enscript-comment">/*
	 * grab space for the reconds.
	 */</span>
	ar-&gt;k_ar.ar_mac_records = (<span class="enscript-type">struct</span> mac_audit_record_list_t *)
	    kalloc(<span class="enscript-keyword">sizeof</span>(*ar-&gt;k_ar.ar_mac_records));
	<span class="enscript-keyword">if</span> (ar-&gt;k_ar.ar_mac_records == NULL) {
		zfree(audit_mac_label_zone, ar-&gt;k_ar.ar_cred_mac_labels);
		<span class="enscript-keyword">return</span> (1);
	}
	LIST_INIT(ar-&gt;k_ar.ar_mac_records);
	ar-&gt;k_ar.ar_forced_by_mac = 0;
	
	<span class="enscript-keyword">return</span> (0);
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">audit_mac_free</span>(<span class="enscript-type">struct</span> kaudit_record *ar)
{
	<span class="enscript-type">struct</span> mac_audit_record *head, *next;

	<span class="enscript-keyword">if</span> (ar-&gt;k_ar.ar_vnode1_mac_labels != NULL)
		zfree(audit_mac_label_zone, ar-&gt;k_ar.ar_vnode1_mac_labels);
	<span class="enscript-keyword">if</span> (ar-&gt;k_ar.ar_vnode2_mac_labels != NULL)
		zfree(audit_mac_label_zone, ar-&gt;k_ar.ar_vnode2_mac_labels);
	<span class="enscript-keyword">if</span> (ar-&gt;k_ar.ar_cred_mac_labels != NULL)
		zfree(audit_mac_label_zone, ar-&gt;k_ar.ar_cred_mac_labels);
	<span class="enscript-keyword">if</span> (ar-&gt;k_ar.ar_arg_mac_string != NULL)
		kfree(ar-&gt;k_ar.ar_arg_mac_string,
		    MAC_MAX_LABEL_BUF_LEN + MAC_ARG_PREFIX_LEN);

	<span class="enscript-comment">/*
	 * Free the audit data from the MAC policies.
	 */</span>
	head = LIST_FIRST(ar-&gt;k_ar.ar_mac_records);
	<span class="enscript-keyword">while</span> (head != NULL) {
		next = LIST_NEXT(head, records);
		zfree(mac_audit_data_zone, head-&gt;data);
		kfree(head, <span class="enscript-keyword">sizeof</span>(*head));
		head = next;
	}
	kfree(ar-&gt;k_ar.ar_mac_records, <span class="enscript-keyword">sizeof</span>(*ar-&gt;k_ar.ar_mac_records));
}

<span class="enscript-type">int</span>
<span class="enscript-function-name">audit_mac_syscall_enter</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">short</span> code, proc_t p, <span class="enscript-type">struct</span> uthread *uthread,
    kauth_cred_t my_cred, au_event_t event)
{
	<span class="enscript-type">int</span> error;

	error = mac_audit_check_preselect(my_cred, code,
	     (<span class="enscript-type">void</span> *)uthread-&gt;uu_arg);
	<span class="enscript-keyword">if</span> (error == MAC_AUDIT_YES) {
		uthread-&gt;uu_ar = audit_new(event, p, uthread);
		uthread-&gt;uu_ar-&gt;k_ar.ar_forced_by_mac = 1;
		au_to_text(<span class="enscript-string">&quot;Forced by a MAC policy&quot;</span>);
		<span class="enscript-keyword">return</span> (1);
	} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (error == MAC_AUDIT_NO) {
		<span class="enscript-keyword">return</span> (0);
	} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (error == MAC_AUDIT_DEFAULT) {
		<span class="enscript-keyword">return</span> (1);
	}

	<span class="enscript-keyword">return</span> (0);
}

<span class="enscript-type">int</span>
<span class="enscript-function-name">audit_mac_syscall_exit</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">short</span> code, <span class="enscript-type">struct</span> uthread *uthread, <span class="enscript-type">int</span> error,
    <span class="enscript-type">int</span> retval)
{
	<span class="enscript-type">int</span> mac_error;

	<span class="enscript-keyword">if</span> (uthread-&gt;uu_ar == NULL)  <span class="enscript-comment">/* syscall wasn't audited */</span>
		<span class="enscript-keyword">return</span> (1);

	<span class="enscript-comment">/*
	 * Note, no other postselect mechanism exists.  If 
	 * mac_audit_check_postselect returns MAC_AUDIT_NO, the record will be
	 * suppressed.  Other values at this point result in the audit record
	 * being committed.  This suppression behavior will probably go away in
	 * the port to 10.3.4.
	 */</span>
	mac_error = mac_audit_check_postselect(kauth_cred_get(), code,
	    (<span class="enscript-type">void</span> *) uthread-&gt;uu_arg, error, retval,
	    uthread-&gt;uu_ar-&gt;k_ar.ar_forced_by_mac);

	<span class="enscript-keyword">if</span> (mac_error == MAC_AUDIT_YES)
		uthread-&gt;uu_ar-&gt;k_ar_commit |= AR_COMMIT_KERNEL;
	<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (mac_error == MAC_AUDIT_NO) {
		audit_free(uthread-&gt;uu_ar);
		<span class="enscript-keyword">return</span> (1);	
	}
	<span class="enscript-keyword">return</span> (0);
}

<span class="enscript-comment">/*
 * This function is called by the MAC Framework to add audit data
 * from a policy to the current audit record.
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">audit_mac_data</span>(<span class="enscript-type">int</span> type, <span class="enscript-type">int</span> len, u_char *data) {
	<span class="enscript-type">struct</span> kaudit_record *cur;
	<span class="enscript-type">struct</span> mac_audit_record *record;

	<span class="enscript-keyword">if</span> (audit_enabled == 0) {
		kfree(data, len);
		<span class="enscript-keyword">return</span> (ENOTSUP);
	}

	cur = currecord();
	<span class="enscript-keyword">if</span> (cur == NULL) {
		kfree(data, len);
		<span class="enscript-keyword">return</span> (ENOTSUP);
	}

	<span class="enscript-comment">/*
	 * XXX: Note that we silently drop the audit data if this
	 * allocation fails - this is consistent with the rest of the
	 * audit implementation.
	 */</span>
	record = kalloc(<span class="enscript-keyword">sizeof</span>(*record));
	<span class="enscript-keyword">if</span> (record == NULL) {
		kfree(data, len);
		<span class="enscript-keyword">return</span> (0);
	}

	record-&gt;type = type;
	record-&gt;length = len;
	record-&gt;data = data;
	LIST_INSERT_HEAD(cur-&gt;k_ar.ar_mac_records, record, records);

	<span class="enscript-keyword">return</span> (0);
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">audit_arg_mac_string</span>(<span class="enscript-type">struct</span> kaudit_record *ar, <span class="enscript-type">char</span> *string)
{

	<span class="enscript-keyword">if</span> (ar-&gt;k_ar.ar_arg_mac_string == NULL)
		ar-&gt;k_ar.ar_arg_mac_string =
			kalloc(MAC_MAX_LABEL_BUF_LEN + MAC_ARG_PREFIX_LEN);

	<span class="enscript-comment">/*
	 * XXX This should be a rare event. If kalloc() returns NULL,
	 * the system is low on kernel virtual memory. To be
	 * consistent with the rest of audit, just return
	 * (may need to panic if required to for audit).
	 */</span>
	<span class="enscript-keyword">if</span> (ar-&gt;k_ar.ar_arg_mac_string == NULL)
		<span class="enscript-keyword">if</span> (ar-&gt;k_ar.ar_arg_mac_string == NULL)
			<span class="enscript-keyword">return</span>;

	strncpy(ar-&gt;k_ar.ar_arg_mac_string, MAC_ARG_PREFIX,
	    MAC_ARG_PREFIX_LEN);
	strncpy(ar-&gt;k_ar.ar_arg_mac_string + MAC_ARG_PREFIX_LEN, string,
	    MAC_MAX_LABEL_BUF_LEN);
	ARG_SET_VALID(ar, ARG_MAC_STRING);
}
#<span class="enscript-reference">endif</span>  <span class="enscript-comment">/* MAC */</span>

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CONFIG_AUDIT */</span>
</pre>
<hr />
</body></html>