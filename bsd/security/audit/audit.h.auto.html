<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>audit.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">audit.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*-
 * Copyright (c) 2004-2009 Apple Inc.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1.  Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 * 2.  Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 * 3.  Neither the name of Apple Inc. (&quot;Apple&quot;) nor the names of
 *     its contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS &quot;AS IS&quot; AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
 * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING
 * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 *
 */</span>
<span class="enscript-comment">/*
 * NOTICE: This file was modified by SPARTA, Inc. in 2005 to introduce
 * support for mandatory and extensible security protections.  This notice
 * is included in support of clause 2.2 (b) of the Apple Public License,
 * Version 2.0.
 */</span>

<span class="enscript-comment">/*
 * This header includes function prototypes and type definitions that are
 * necessary for the kernel as a whole to interact with the audit subsystem.
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_SECURITY_AUDIT_AUDIT_H</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">_SECURITY_AUDIT_AUDIT_H</span>

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">_KERNEL</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">KERNEL</span>)

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_MACF</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/queue.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;security/mac_framework.h&gt;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;bsm/audit.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/sysctl.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/user.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/ipc.h&gt;</span>

<span class="enscript-comment">/*
 * Audit subsystem condition flags.  The audit_enabled flag is set and
 * removed automatically as a result of configuring log files, and can be
 * observed but should not be directly manipulated.  The audit suspension
 * flag permits audit to be temporarily disabled without reconfiguring the
 * audit target. The audit syscalls flag is set at the first hint that kernel
 * events (system and mach calls) need to be audited.  It is used for
 * performance so an event class map table lookup doesn't have be done for
 * every system call if only user events are being audited.
 */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>	audit_enabled;
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>	audit_suspended;
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>	audit_syscalls;

<span class="enscript-comment">/*
 * Define the masks for the audited arguments.
 *
 * XXXRW: These need to remain in audit.h for now because our vnode and name
 * lookup audit calls rely on passing in flags to indicate which name or
 * vnode is being logged.  These should move to audit_private.h when that is
 * fixed.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_EUID</span>		0x0000000000000001ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_RUID</span>		0x0000000000000002ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_SUID</span>		0x0000000000000004ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_EGID</span>		0x0000000000000008ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_RGID</span>		0x0000000000000010ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_SGID</span>		0x0000000000000020ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_PID</span>			0x0000000000000040ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_UID</span>			0x0000000000000080ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_AUID</span>		0x0000000000000100ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_GID</span>			0x0000000000000200ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_FD</span>			0x0000000000000400ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_POSIX_IPC_PERM</span>	0x0000000000000800ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_FFLAGS</span>		0x0000000000001000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_MODE</span>		0x0000000000002000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_VALUE32</span>		0x0000000000004000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_ADDR32</span>		0x0000000000008000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_ADDR</span>		ARG_ADDR32
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_LEN</span>			0x0000000000010000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_MASK</span>		0x0000000000020000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_SIGNUM</span>		0x0000000000040000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_LOGIN</span>		0x0000000000080000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_SADDRINET</span>		0x0000000000100000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_SADDRINET6</span>		0x0000000000200000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_SADDRUNIX</span>		0x0000000000400000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_TERMID_ADDR</span>		ARG_SADDRUNIX	
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_KPATH1</span>		0x0000000000800000ULL	<span class="enscript-comment">/* darwin-only */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_KPATH2</span>		0x0000000001000000ULL	<span class="enscript-comment">/* darwin-only */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_UPATH1</span>		0x0000000002000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_UPATH2</span>		0x0000000004000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_TEXT</span>		0x0000000008000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_VNODE1</span>		0x0000000010000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_VNODE2</span>		0x0000000020000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_SVIPC_CMD</span>		0x0000000040000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_SVIPC_PERM</span>		0x0000000080000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_SVIPC_ID</span>		0x0000000100000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_SVIPC_ADDR</span>		0x0000000200000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_GROUPSET</span>		0x0000000400000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_CMD</span>			0x0000000800000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_SOCKINFO</span>		0x0000001000000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_ASID</span>		0x0000002000000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_TERMID</span>		0x0000004000000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_AUDITON</span>		0x0000008000000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_VALUE64</span>		0x0000010000000000ULL	<span class="enscript-comment">/* darwin-only */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_AMASK</span>		0x0000020000000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_CTLNAME</span>		0x0000040000000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_PROCESS</span>		0x0000080000000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_MACHPORT1</span>		0x0000100000000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_MACHPORT2</span>		0x0000200000000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_MAC_STRING</span>		0x0000400000000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_EXIT</span>		0x0000800000000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_IOVECSTR</span>		0x0001000000000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_ARGV</span>		0x0002000000000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_ENVV</span>		0x0004000000000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_OPAQUE</span>		0x0008000000000000ULL	<span class="enscript-comment">/* darwin-only */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_DATA</span>		0x0010000000000000ULL	<span class="enscript-comment">/* darwin-only */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_ADDR64</span>		0x0020000000000000ULL	<span class="enscript-comment">/* darwin-only */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_NONE</span>		0x0000000000000000ULL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ARG_ALL</span>			0xFFFFFFFFFFFFFFFFULL

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_MACF</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MAC_AUDIT_LABEL_LEN</span> 1024
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MAC_AUDIT_DATA_TYPE</span> 0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MAC_AUDIT_TEXT_TYPE</span> 1

<span class="enscript-type">struct</span> mac_audit_record {
        <span class="enscript-type">int</span> type;               <span class="enscript-comment">/* one of the types defined above */</span>
        <span class="enscript-type">int</span> length;             <span class="enscript-comment">/* byte length of the data field */</span>
        u_char *data;           <span class="enscript-comment">/* the payload */</span>
        LIST_ENTRY(mac_audit_record) records;
};

#<span class="enscript-reference">endif</span>

<span class="enscript-type">struct</span> proc;
<span class="enscript-type">struct</span> vnode;
<span class="enscript-type">struct</span> componentname;

<span class="enscript-type">int</span> 			 kau_will_audit(<span class="enscript-type">void</span>);
<span class="enscript-type">void</span>			 audit_init(<span class="enscript-type">void</span>);
<span class="enscript-type">void</span>			 audit_shutdown(<span class="enscript-type">void</span>);
<span class="enscript-type">void</span>			 audit_syscall_enter(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> code,
				<span class="enscript-type">struct</span> proc *proc, <span class="enscript-type">struct</span> uthread *uthread);
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_MACF</span>
<span class="enscript-comment">/*
 * The parameter list of audit_syscall_exit() was modified to also take the
 * Darwin syscall number, which is required by mac_audit_check_postselect().
 */</span>
<span class="enscript-type">void</span>	audit_syscall_exit(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> code, <span class="enscript-type">int</span> error,
		<span class="enscript-type">struct</span> proc *proc, <span class="enscript-type">struct</span> uthread *uthread);
#<span class="enscript-reference">else</span>
<span class="enscript-type">void</span>	audit_syscall_exit(<span class="enscript-type">int</span> error, <span class="enscript-type">struct</span> proc *proc, 
			<span class="enscript-type">struct</span> uthread *uthread);
#<span class="enscript-reference">endif</span>
<span class="enscript-type">void</span>	audit_mach_syscall_enter(<span class="enscript-type">unsigned</span> <span class="enscript-type">short</span> audit_event);
<span class="enscript-type">void</span>	audit_mach_syscall_exit(<span class="enscript-type">int</span> retval, <span class="enscript-type">struct</span> uthread *uthread);

<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> auditinfo_addr *audit_default_aia_p;

<span class="enscript-comment">/*
 * The remaining kernel functions are conditionally compiled in as they are
 * wrapped by a macro, and the macro should be the only place in the source
 * tree where these functions are referenced.
 */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_AUDIT</span>
<span class="enscript-type">struct</span> ipc_perm;
<span class="enscript-type">struct</span> sockaddr;
<span class="enscript-type">union</span> auditon_udata;
<span class="enscript-type">void</span>	 audit_arg_addr(<span class="enscript-type">struct</span> kaudit_record *ar, user_addr_t addr);
<span class="enscript-type">void</span> 	 audit_arg_exit(<span class="enscript-type">struct</span> kaudit_record *ar, <span class="enscript-type">int</span> status, <span class="enscript-type">int</span> retval);
<span class="enscript-type">void</span>	 audit_arg_len(<span class="enscript-type">struct</span> kaudit_record *ar, user_size_t len);
<span class="enscript-type">void</span>	 audit_arg_fd(<span class="enscript-type">struct</span> kaudit_record *ar, <span class="enscript-type">int</span> fd);
<span class="enscript-type">void</span>	 audit_arg_fflags(<span class="enscript-type">struct</span> kaudit_record *ar, <span class="enscript-type">int</span> fflags);
<span class="enscript-type">void</span>	 audit_arg_gid(<span class="enscript-type">struct</span> kaudit_record *ar, gid_t gid);
<span class="enscript-type">void</span>	 audit_arg_uid(<span class="enscript-type">struct</span> kaudit_record *ar, uid_t uid);
<span class="enscript-type">void</span>	 audit_arg_egid(<span class="enscript-type">struct</span> kaudit_record *ar, gid_t egid);
<span class="enscript-type">void</span>	 audit_arg_euid(<span class="enscript-type">struct</span> kaudit_record *ar, uid_t euid);
<span class="enscript-type">void</span>	 audit_arg_rgid(<span class="enscript-type">struct</span> kaudit_record *ar, gid_t rgid);
<span class="enscript-type">void</span>	 audit_arg_ruid(<span class="enscript-type">struct</span> kaudit_record *ar, uid_t ruid);
<span class="enscript-type">void</span>	 audit_arg_sgid(<span class="enscript-type">struct</span> kaudit_record *ar, gid_t sgid);
<span class="enscript-type">void</span>	 audit_arg_suid(<span class="enscript-type">struct</span> kaudit_record *ar, uid_t suid);
<span class="enscript-type">void</span>	 audit_arg_groupset(<span class="enscript-type">struct</span> kaudit_record *ar, gid_t *gidset,
		u_int gidset_size);
<span class="enscript-type">void</span>	 audit_arg_login(<span class="enscript-type">struct</span> kaudit_record *ar, <span class="enscript-type">char</span> *login);
<span class="enscript-type">void</span>	 audit_arg_ctlname(<span class="enscript-type">struct</span> kaudit_record *ar, <span class="enscript-type">int</span> *name, <span class="enscript-type">int</span> namelen);
<span class="enscript-type">void</span>	 audit_arg_mask(<span class="enscript-type">struct</span> kaudit_record *ar, <span class="enscript-type">int</span> mask);
<span class="enscript-type">void</span>	 audit_arg_mode(<span class="enscript-type">struct</span> kaudit_record *ar, mode_t mode);
<span class="enscript-type">void</span>	 audit_arg_value32(<span class="enscript-type">struct</span> kaudit_record *ar, uint32_t value32);
<span class="enscript-type">void</span>	 audit_arg_value64(<span class="enscript-type">struct</span> kaudit_record *ar, uint64_t value64);
<span class="enscript-type">void</span>	 audit_arg_owner(<span class="enscript-type">struct</span> kaudit_record *ar, uid_t uid, gid_t gid);
<span class="enscript-type">void</span>	 audit_arg_pid(<span class="enscript-type">struct</span> kaudit_record *ar, pid_t pid);
<span class="enscript-type">void</span>	 audit_arg_process(<span class="enscript-type">struct</span> kaudit_record *ar, proc_t p);
<span class="enscript-type">void</span>	 audit_arg_signum(<span class="enscript-type">struct</span> kaudit_record *ar, u_int signum);
<span class="enscript-type">void</span>	 audit_arg_socket(<span class="enscript-type">struct</span> kaudit_record *ar, <span class="enscript-type">int</span> sodomain, <span class="enscript-type">int</span> sotype,
		<span class="enscript-type">int</span> soprotocol);
<span class="enscript-type">void</span>	 audit_arg_sockaddr(<span class="enscript-type">struct</span> kaudit_record *ar, <span class="enscript-type">struct</span> vnode *cwd_vp,
		<span class="enscript-type">struct</span> sockaddr *so);
<span class="enscript-type">void</span>	 audit_arg_auid(<span class="enscript-type">struct</span> kaudit_record *ar, uid_t auid);
<span class="enscript-type">void</span>	 audit_arg_auditinfo(<span class="enscript-type">struct</span> kaudit_record *ar,
		<span class="enscript-type">struct</span> auditinfo *au_info);
<span class="enscript-type">void</span>	 audit_arg_auditinfo_addr(<span class="enscript-type">struct</span> kaudit_record *ar,
		<span class="enscript-type">struct</span> auditinfo_addr *au_info);
<span class="enscript-type">void</span>	 audit_arg_upath(<span class="enscript-type">struct</span> kaudit_record *ar, <span class="enscript-type">struct</span> vnode *cwd_vp,
		<span class="enscript-type">char</span> *upath, u_int64_t flags);
<span class="enscript-type">void</span>	 audit_arg_vnpath(<span class="enscript-type">struct</span> kaudit_record *ar, <span class="enscript-type">struct</span> vnode *vp,
		u_int64_t flags);
<span class="enscript-type">void</span>	 audit_arg_vnpath_withref(<span class="enscript-type">struct</span> kaudit_record *ar, <span class="enscript-type">struct</span> vnode *vp,
		u_int64_t flags);
<span class="enscript-type">void</span>	 audit_arg_text(<span class="enscript-type">struct</span> kaudit_record *ar, <span class="enscript-type">char</span> *text);
<span class="enscript-type">void</span>	 audit_arg_opaque(<span class="enscript-type">struct</span> kaudit_record *ar, <span class="enscript-type">void</span> *data, size_t size);
<span class="enscript-type">void</span>	 audit_arg_data(<span class="enscript-type">struct</span> kaudit_record *ar, <span class="enscript-type">void</span> *data, size_t size,
		size_t number);
<span class="enscript-type">void</span>	 audit_arg_cmd(<span class="enscript-type">struct</span> kaudit_record *ar, <span class="enscript-type">int</span> cmd);
<span class="enscript-type">void</span>	 audit_arg_svipc_cmd(<span class="enscript-type">struct</span> kaudit_record *ar, <span class="enscript-type">int</span> cmd);
<span class="enscript-type">void</span>	 audit_arg_svipc_perm(<span class="enscript-type">struct</span> kaudit_record *ar, <span class="enscript-type">struct</span> ipc_perm *perm);
<span class="enscript-type">void</span>	 audit_arg_svipc_id(<span class="enscript-type">struct</span> kaudit_record *ar, <span class="enscript-type">int</span> id);
<span class="enscript-type">void</span>	 audit_arg_svipc_addr(<span class="enscript-type">struct</span> kaudit_record *ar, user_addr_t addr);
<span class="enscript-type">void</span>	 audit_arg_posix_ipc_perm(<span class="enscript-type">struct</span> kaudit_record *ar, uid_t uid,
		gid_t gid, mode_t mode);
<span class="enscript-type">void</span>	 audit_arg_auditon(<span class="enscript-type">struct</span> kaudit_record *ar,
		<span class="enscript-type">union</span> auditon_udata *udata);
<span class="enscript-type">void</span>	 audit_arg_file(<span class="enscript-type">struct</span> kaudit_record *ar, <span class="enscript-type">struct</span> proc *p,
		<span class="enscript-type">struct</span> fileproc *fp);
<span class="enscript-type">void</span>	 audit_arg_argv(<span class="enscript-type">struct</span> kaudit_record *ar, <span class="enscript-type">char</span> *argv, <span class="enscript-type">int</span> argc,
		<span class="enscript-type">int</span> length); 
<span class="enscript-type">void</span>	 audit_arg_envv(<span class="enscript-type">struct</span> kaudit_record *ar, <span class="enscript-type">char</span> *envv, <span class="enscript-type">int</span> envc,
		<span class="enscript-type">int</span> length);

<span class="enscript-type">void</span>	 audit_arg_mach_port1(<span class="enscript-type">struct</span> kaudit_record *ar, mach_port_name_t port);
<span class="enscript-type">void</span>	 audit_arg_mach_port2(<span class="enscript-type">struct</span> kaudit_record *ar, mach_port_name_t port);
<span class="enscript-type">void</span>	 audit_sysclose(<span class="enscript-type">struct</span> kaudit_record *ar, <span class="enscript-type">struct</span> proc *p, <span class="enscript-type">int</span> fd);

<span class="enscript-type">void</span>     <span class="enscript-function-name">audit_proc_coredump</span>(proc_t proc, <span class="enscript-type">char</span> *path, <span class="enscript-type">int</span> errcode);
<span class="enscript-type">void</span>	 audit_proc_init(<span class="enscript-type">struct</span> proc *p);
<span class="enscript-type">void</span>	 audit_proc_fork(<span class="enscript-type">struct</span> proc *parent, <span class="enscript-type">struct</span> proc *child);
<span class="enscript-type">void</span>	 audit_proc_free(<span class="enscript-type">struct</span> proc *p);

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_KAUTH_CRED_T</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">_KAUTH_CRED_T</span>
<span class="enscript-type">struct</span> ucred;
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> ucred *kauth_cred_t;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !_KAUTH_CRED_T */</span>

<span class="enscript-type">void</span>	 audit_session_ref(kauth_cred_t cred);
<span class="enscript-type">void</span>	 audit_session_unref(kauth_cred_t cred);
<span class="enscript-type">void</span>	 audit_session_procnew(proc_t p);
<span class="enscript-type">void</span>	 audit_session_procexit(proc_t p);
<span class="enscript-type">int</span>	 audit_session_spawnjoin(proc_t p, ipc_port_t port);

<span class="enscript-type">void</span>	 audit_sdev_submit(au_id_t auid, au_asid_t asid, <span class="enscript-type">void</span> *record,
	    u_int record_len);

<span class="enscript-comment">/*
 * Audit session macros. 
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IS_VALID_SESSION</span>(a)	((a) != NULL &amp;&amp; (a) != audit_default_aia_p)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">AUDIT_SESSION_REF</span>(cred)		audit_session_ref(cred)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">AUDIT_SESSION_UNREF</span>(cred)	audit_session_unref(cred)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">AUDIT_SESSION_PROCNEW</span>(p)	audit_session_procnew(p)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">AUDIT_SESSION_PROCEXIT</span>(p)	audit_session_procexit(p)

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_MACF</span>
<span class="enscript-comment">/* 
 * audit_mac_data() is the MAC Framework's entry point to the audit subsystem.
 * It currently creates only text and data audit tokens.
 */</span>
<span class="enscript-type">int</span>	 audit_mac_data(<span class="enscript-type">int</span> type, <span class="enscript-type">int</span> len, u_char *data);
<span class="enscript-type">void</span>	 audit_arg_mac_string(<span class="enscript-type">struct</span> kaudit_record *ar, <span class="enscript-type">char</span> *string);

#<span class="enscript-reference">endif</span>

<span class="enscript-type">extern</span> au_event_t sys_au_event[];

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">AUDIT_RECORD</span>() \
	((<span class="enscript-type">struct</span> uthread*)get_bsdthread_info(current_thread()))-&gt;uu_ar

#<span class="enscript-reference">ifndef</span>	<span class="enscript-variable-name">AUDIT_USE_BUILTIN_EXPECT</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">AUDIT_USE_BUILTIN_EXPECT</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">ifdef</span>	<span class="enscript-variable-name">AUDIT_USE_BUILTIN_EXPECT</span>
<span class="enscript-comment">/*
 * Use branch prediction for the case of auditing enabled but not 
 * auditing system calls.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">AUDIT_SYSCALLS</span>()	__builtin_expect(audit_syscalls, 0)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">AUDIT_ENABLED</span>()		__builtin_expect(audit_syscalls &amp;&amp; 	\
    					audit_enabled, 0)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">AUDIT_AUDITING</span>(x)	__builtin_expect(NULL != (x), 0)

#<span class="enscript-reference">else</span>

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">AUDIT_SYSCALLS</span>()	(audit_syscalls)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">AUDIT_ENABLED</span>()		(audit_syscalls &amp;&amp; audit_enabled)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">AUDIT_AUDITING</span>(x)	(NULL != (x))

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* AUDIT_USE_BUILTIN_EXPECT */</span>

<span class="enscript-comment">/*
 * Define a macro to wrap the audit_arg_* calls by checking the global
 * audit_enabled flag before performing the actual call.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">AUDIT_ARG</span>(op, args...)	do {					\
	<span class="enscript-keyword">if</span> (AUDIT_SYSCALLS()) {						\
		<span class="enscript-type">struct</span> kaudit_record *__ar = AUDIT_RECORD(); 		\
		<span class="enscript-keyword">if</span> (AUDIT_AUDITING(__ar)) 				\
			audit_arg_ ## op (__ar, args);			\
	}								\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">AUDIT_SYSCALL_ENTER</span>(args...)	do {				\
	<span class="enscript-keyword">if</span> (AUDIT_ENABLED()) {					\
		audit_syscall_enter(args);				\
	}								\
} <span class="enscript-keyword">while</span> (0)

<span class="enscript-comment">/*
 * Wrap the audit_syscall_exit() function so that it is called only when
 * we have a audit record on the thread.  Audit records can persist after 
 * auditing is disabled, so we don't just check audit_enabled here. 
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">AUDIT_SYSCALL_EXIT</span>(code, proc, uthread, error)	do {		\
		<span class="enscript-keyword">if</span> (AUDIT_AUDITING(uthread-&gt;uu_ar))			\
			audit_syscall_exit(code, error, proc, uthread);	\
} <span class="enscript-keyword">while</span> (0)

<span class="enscript-comment">/*
 * Wrap the audit_mach_syscall_enter() and audit_mach_syscall_exit()
 * functions in a manner similar to other system call enter/exit functions.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">AUDIT_MACH_SYSCALL_ENTER</span>(args...)       do {			\
	<span class="enscript-keyword">if</span> (AUDIT_ENABLED()) {					\
		audit_mach_syscall_enter(args);				\
	}								\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">AUDIT_MACH_SYSCALL_EXIT</span>(retval) 	do {			\
	<span class="enscript-keyword">if</span> (AUDIT_SYSCALLS()) {						\
		<span class="enscript-type">struct</span> uthread *__uthread = 				\
			get_bsdthread_info(current_thread());		\
		<span class="enscript-keyword">if</span> (AUDIT_AUDITING(__uthread-&gt;uu_ar))			\
			audit_mach_syscall_exit(retval, __uthread);	\
	}								\
} <span class="enscript-keyword">while</span> (0)

<span class="enscript-comment">/*
 * A Macro to wrap the audit_sysclose() function.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">AUDIT_SYSCLOSE</span>(args...)	do {					\
	<span class="enscript-keyword">if</span> (AUDIT_SYSCALLS()) {						\
		<span class="enscript-type">struct</span> kaudit_record *__ar = AUDIT_RECORD();		\
		<span class="enscript-keyword">if</span> (AUDIT_AUDITING(__ar))				\
			audit_sysclose(__ar, args);			\
	}								\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">else</span> <span class="enscript-comment">/* !CONFIG_AUDIT */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">AUDIT_ARG</span>(op, args...)	do {					\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">AUDIT_SYSCALL_ENTER</span>(args...)	do {				\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">AUDIT_SYSCALL_EXIT</span>(code, proc, uthread, error)	do {	     	\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">AUDIT_MACH_SYSCALL_ENTER</span>(args...)       do {			\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">AUDIT_MACH_SYSCALL_EXIT</span>(retval) 	do {			\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">AUDIT_SYSCLOSE</span>(op, args...)	do {				\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">AUDIT_SESSION_REF</span>(cred)		do {				\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">AUDIT_SESSION_UNREF</span>(cred)	do {				\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">AUDIT_SESSION_PROCNEW</span>(cred)	do {				\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">AUDIT_SESSION_PROCEXIT</span>(cred)	do {				\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">AUDIT_SESSION_REF</span>(cred)		do {				\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">AUDIT_SESSION_UNREF</span>(cred)	do {				\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">AUDIT_SESSION_PROCNEW</span>(cred)	do {				\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">AUDIT_SESSION_PROCEXIT</span>(cred)	do {				\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CONFIG_AUDIT */</span>

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL */</span>

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !_SECURITY_AUDIT_ADUIT_H */</span>
</pre>
<hr />
</body></html>