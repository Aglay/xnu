<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>pktsched_tcq.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">pktsched_tcq.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2011-2012 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 *
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 *
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 *
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

<span class="enscript-comment">/*
 * traffic class queue
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/cdefs.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/param.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/malloc.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/mbuf.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/systm.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/errno.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/kernel.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/syslog.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/zalloc.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/if.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/net_osdep.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/pktsched/pktsched_tcq.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/in.h&gt;</span>

<span class="enscript-comment">/*
 * function prototypes
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">tcq_enqueue_ifclassq</span>(<span class="enscript-type">struct</span> ifclassq *, <span class="enscript-type">struct</span> mbuf *);
<span class="enscript-type">static</span> <span class="enscript-type">struct</span> mbuf *<span class="enscript-function-name">tcq_dequeue_tc_ifclassq</span>(<span class="enscript-type">struct</span> ifclassq *,
    mbuf_svc_class_t, cqdq_op_t);
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">tcq_request_ifclassq</span>(<span class="enscript-type">struct</span> ifclassq *, cqrq_t, <span class="enscript-type">void</span> *);
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">tcq_clear_interface</span>(<span class="enscript-type">struct</span> tcq_if *);
<span class="enscript-type">static</span> <span class="enscript-type">struct</span> tcq_class *<span class="enscript-function-name">tcq_class_create</span>(<span class="enscript-type">struct</span> tcq_if *, <span class="enscript-type">int</span>, u_int32_t,
    <span class="enscript-type">int</span>, u_int32_t);
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">tcq_class_destroy</span>(<span class="enscript-type">struct</span> tcq_if *, <span class="enscript-type">struct</span> tcq_class *);
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">tcq_destroy_locked</span>(<span class="enscript-type">struct</span> tcq_if *);
<span class="enscript-type">static</span> inline <span class="enscript-type">int</span> <span class="enscript-function-name">tcq_addq</span>(<span class="enscript-type">struct</span> tcq_class *, <span class="enscript-type">struct</span> mbuf *,
    <span class="enscript-type">struct</span> pf_mtag *);
<span class="enscript-type">static</span> inline <span class="enscript-type">struct</span> mbuf *<span class="enscript-function-name">tcq_getq</span>(<span class="enscript-type">struct</span> tcq_class *);
<span class="enscript-type">static</span> inline <span class="enscript-type">struct</span> mbuf *<span class="enscript-function-name">tcq_pollq</span>(<span class="enscript-type">struct</span> tcq_class *);
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">tcq_purgeq</span>(<span class="enscript-type">struct</span> tcq_if *, <span class="enscript-type">struct</span> tcq_class *, u_int32_t,
    u_int32_t *, u_int32_t *);
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">tcq_purge_sc</span>(<span class="enscript-type">struct</span> tcq_if *, cqrq_purge_sc_t *);
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">tcq_updateq</span>(<span class="enscript-type">struct</span> tcq_if *, <span class="enscript-type">struct</span> tcq_class *, cqev_t);
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">tcq_throttle</span>(<span class="enscript-type">struct</span> tcq_if *, cqrq_throttle_t *);
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">tcq_resumeq</span>(<span class="enscript-type">struct</span> tcq_if *, <span class="enscript-type">struct</span> tcq_class *);
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">tcq_suspendq</span>(<span class="enscript-type">struct</span> tcq_if *, <span class="enscript-type">struct</span> tcq_class *);
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">tcq_stat_sc</span>(<span class="enscript-type">struct</span> tcq_if *, cqrq_stat_sc_t *);
<span class="enscript-type">static</span> <span class="enscript-type">struct</span> mbuf *<span class="enscript-function-name">tcq_dequeue_cl</span>(<span class="enscript-type">struct</span> tcq_if *, <span class="enscript-type">struct</span> tcq_class *,
    mbuf_svc_class_t, cqdq_op_t);
<span class="enscript-type">static</span> inline <span class="enscript-type">struct</span> tcq_class *<span class="enscript-function-name">tcq_clh_to_clp</span>(<span class="enscript-type">struct</span> tcq_if *, u_int32_t);
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> *<span class="enscript-function-name">tcq_style</span>(<span class="enscript-type">struct</span> tcq_if *);

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">TCQ_ZONE_MAX</span>	32		<span class="enscript-comment">/* maximum elements in zone */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">TCQ_ZONE_NAME</span>	<span class="enscript-string">&quot;pktsched_tcq&quot;</span>	<span class="enscript-comment">/* zone name */</span>

<span class="enscript-type">static</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> tcq_size;		<span class="enscript-comment">/* size of zone element */</span>
<span class="enscript-type">static</span> <span class="enscript-type">struct</span> zone *tcq_zone;		<span class="enscript-comment">/* zone for tcq */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">TCQ_CL_ZONE_MAX</span>	32		<span class="enscript-comment">/* maximum elements in zone */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">TCQ_CL_ZONE_NAME</span> <span class="enscript-string">&quot;pktsched_tcq_cl&quot;</span> <span class="enscript-comment">/* zone name */</span>

<span class="enscript-type">static</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> tcq_cl_size;	<span class="enscript-comment">/* size of zone element */</span>
<span class="enscript-type">static</span> <span class="enscript-type">struct</span> zone *tcq_cl_zone;	<span class="enscript-comment">/* zone for tcq_class */</span>

<span class="enscript-type">void</span>
<span class="enscript-function-name">tcq_init</span>(<span class="enscript-type">void</span>)
{
	tcq_size = <span class="enscript-keyword">sizeof</span> (<span class="enscript-type">struct</span> tcq_if);
	tcq_zone = zinit(tcq_size, TCQ_ZONE_MAX * tcq_size,
	    0, TCQ_ZONE_NAME);
	<span class="enscript-keyword">if</span> (tcq_zone == NULL) {
		panic(<span class="enscript-string">&quot;%s: failed allocating %s&quot;</span>, __func__, TCQ_ZONE_NAME);
		<span class="enscript-comment">/* NOTREACHED */</span>
	}
	zone_change(tcq_zone, Z_EXPAND, TRUE);
	zone_change(tcq_zone, Z_CALLERACCT, TRUE);

	tcq_cl_size = <span class="enscript-keyword">sizeof</span> (<span class="enscript-type">struct</span> tcq_class);
	tcq_cl_zone = zinit(tcq_cl_size, TCQ_CL_ZONE_MAX * tcq_cl_size,
	    0, TCQ_CL_ZONE_NAME);
	<span class="enscript-keyword">if</span> (tcq_cl_zone == NULL) {
		panic(<span class="enscript-string">&quot;%s: failed allocating %s&quot;</span>, __func__, TCQ_CL_ZONE_NAME);
		<span class="enscript-comment">/* NOTREACHED */</span>
	}
	zone_change(tcq_cl_zone, Z_EXPAND, TRUE);
	zone_change(tcq_cl_zone, Z_CALLERACCT, TRUE);
}

<span class="enscript-type">struct</span> tcq_if *
<span class="enscript-function-name">tcq_alloc</span>(<span class="enscript-type">struct</span> ifnet *ifp, <span class="enscript-type">int</span> how, boolean_t altq)
{
	<span class="enscript-type">struct</span> tcq_if	*tif;

	tif = (how == M_WAITOK) ? zalloc(tcq_zone) : zalloc_noblock(tcq_zone);
	<span class="enscript-keyword">if</span> (tif == NULL)
		<span class="enscript-keyword">return</span> (NULL);

	bzero(tif, tcq_size);
	tif-&gt;tif_maxpri = -1;
	tif-&gt;tif_ifq = &amp;ifp-&gt;if_snd;
	<span class="enscript-keyword">if</span> (altq)
		tif-&gt;tif_flags |= TCQIFF_ALTQ;

	<span class="enscript-keyword">if</span> (pktsched_verbose) {
		log(LOG_DEBUG, <span class="enscript-string">&quot;%s: %s scheduler allocated\n&quot;</span>,
		    if_name(ifp), tcq_style(tif));
	}

	<span class="enscript-keyword">return</span> (tif);
}

<span class="enscript-type">int</span>
<span class="enscript-function-name">tcq_destroy</span>(<span class="enscript-type">struct</span> tcq_if *tif)
{
	<span class="enscript-type">struct</span> ifclassq *ifq = tif-&gt;tif_ifq;
	<span class="enscript-type">int</span> err;

	IFCQ_LOCK(ifq);
	err = tcq_destroy_locked(tif);
	IFCQ_UNLOCK(ifq);

	<span class="enscript-keyword">return</span> (err);
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">tcq_destroy_locked</span>(<span class="enscript-type">struct</span> tcq_if *tif)
{
	IFCQ_LOCK_ASSERT_HELD(tif-&gt;tif_ifq);

	(<span class="enscript-type">void</span>) tcq_clear_interface(tif);

	<span class="enscript-keyword">if</span> (pktsched_verbose) {
		log(LOG_DEBUG, <span class="enscript-string">&quot;%s: %s scheduler destroyed\n&quot;</span>,
		    if_name(TCQIF_IFP(tif)), tcq_style(tif));
	}

	zfree(tcq_zone, tif);

	<span class="enscript-keyword">return</span> (0);
}

<span class="enscript-comment">/*
 * bring the interface back to the initial state by discarding
 * all the filters and classes.
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">tcq_clear_interface</span>(<span class="enscript-type">struct</span> tcq_if *tif)
{
	<span class="enscript-type">struct</span> tcq_class	*cl;
	<span class="enscript-type">int</span> pri;

	IFCQ_LOCK_ASSERT_HELD(tif-&gt;tif_ifq);

	<span class="enscript-comment">/* clear out the classes */</span>
	<span class="enscript-keyword">for</span> (pri = 0; pri &lt;= tif-&gt;tif_maxpri; pri++)
		<span class="enscript-keyword">if</span> ((cl = tif-&gt;tif_classes[pri]) != NULL)
			tcq_class_destroy(tif, cl);

	<span class="enscript-keyword">return</span> (0);
}

<span class="enscript-comment">/* discard all the queued packets on the interface */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">tcq_purge</span>(<span class="enscript-type">struct</span> tcq_if *tif)
{
	<span class="enscript-type">struct</span> tcq_class *cl;
	<span class="enscript-type">int</span> pri;

	IFCQ_LOCK_ASSERT_HELD(tif-&gt;tif_ifq);

	<span class="enscript-keyword">for</span> (pri = 0; pri &lt;= tif-&gt;tif_maxpri; pri++) {
		<span class="enscript-keyword">if</span> ((cl = tif-&gt;tif_classes[pri]) != NULL &amp;&amp; !qempty(&amp;cl-&gt;cl_q))
			tcq_purgeq(tif, cl, 0, NULL, NULL);
	}
#<span class="enscript-reference">if</span> !<span class="enscript-variable-name">PF_ALTQ</span>
	<span class="enscript-comment">/*
	 * This assertion is safe to be made only when PF_ALTQ is not
	 * configured; otherwise, IFCQ_LEN represents the sum of the
	 * packets managed by ifcq_disc and altq_disc instances, which
	 * is possible when transitioning between the two.
	 */</span>
	VERIFY(IFCQ_LEN(tif-&gt;tif_ifq) == 0);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !PF_ALTQ */</span>
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">tcq_purge_sc</span>(<span class="enscript-type">struct</span> tcq_if *tif, cqrq_purge_sc_t *pr)
{
	<span class="enscript-type">struct</span> ifclassq *ifq = tif-&gt;tif_ifq;
	u_int32_t i;

	IFCQ_LOCK_ASSERT_HELD(ifq);

	VERIFY(pr-&gt;sc == MBUF_SC_UNSPEC || MBUF_VALID_SC(pr-&gt;sc));
	VERIFY(pr-&gt;flow != 0);

	<span class="enscript-keyword">if</span> (pr-&gt;sc != MBUF_SC_UNSPEC) {
		i = MBUF_SCIDX(pr-&gt;sc);
		VERIFY(i &lt; IFCQ_SC_MAX);

		tcq_purgeq(tif, ifq-&gt;ifcq_disc_slots[i].cl,
		    pr-&gt;flow, &amp;pr-&gt;packets, &amp;pr-&gt;bytes);
	} <span class="enscript-keyword">else</span> {
		u_int32_t cnt, len;

		pr-&gt;packets = 0;
		pr-&gt;bytes = 0;

		<span class="enscript-keyword">for</span> (i = 0; i &lt; IFCQ_SC_MAX; i++) {
			tcq_purgeq(tif, ifq-&gt;ifcq_disc_slots[i].cl,
			    pr-&gt;flow, &amp;cnt, &amp;len);
			pr-&gt;packets += cnt;
			pr-&gt;bytes += len;
		}
	}
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">tcq_event</span>(<span class="enscript-type">struct</span> tcq_if *tif, cqev_t ev)
{
	<span class="enscript-type">struct</span> tcq_class *cl;
	<span class="enscript-type">int</span> pri;

	IFCQ_LOCK_ASSERT_HELD(tif-&gt;tif_ifq);

	<span class="enscript-keyword">for</span> (pri = 0; pri &lt;= tif-&gt;tif_maxpri; pri++)
		<span class="enscript-keyword">if</span> ((cl = tif-&gt;tif_classes[pri]) != NULL)
			tcq_updateq(tif, cl, ev);
}

<span class="enscript-type">int</span>
<span class="enscript-function-name">tcq_add_queue</span>(<span class="enscript-type">struct</span> tcq_if *tif, <span class="enscript-type">int</span> priority, u_int32_t qlimit,
    <span class="enscript-type">int</span> flags, u_int32_t qid, <span class="enscript-type">struct</span> tcq_class **clp)
{
	<span class="enscript-type">struct</span> tcq_class *cl;

	IFCQ_LOCK_ASSERT_HELD(tif-&gt;tif_ifq);

	<span class="enscript-comment">/* check parameters */</span>
	<span class="enscript-keyword">if</span> (priority &gt;= TCQ_MAXPRI)
		<span class="enscript-keyword">return</span> (EINVAL);
	<span class="enscript-keyword">if</span> (tif-&gt;tif_classes[priority] != NULL)
		<span class="enscript-keyword">return</span> (EBUSY);
	<span class="enscript-keyword">if</span> (tcq_clh_to_clp(tif, qid) != NULL)
		<span class="enscript-keyword">return</span> (EBUSY);

	cl = tcq_class_create(tif, priority, qlimit, flags, qid);
	<span class="enscript-keyword">if</span> (cl == NULL)
		<span class="enscript-keyword">return</span> (ENOMEM);

	<span class="enscript-keyword">if</span> (clp != NULL)
		*clp = cl;

	<span class="enscript-keyword">return</span> (0);
}

<span class="enscript-type">static</span> <span class="enscript-type">struct</span> tcq_class *
<span class="enscript-function-name">tcq_class_create</span>(<span class="enscript-type">struct</span> tcq_if *tif, <span class="enscript-type">int</span> pri, u_int32_t qlimit,
    <span class="enscript-type">int</span> flags, u_int32_t qid)
{
	<span class="enscript-type">struct</span> ifnet *ifp;
	<span class="enscript-type">struct</span> ifclassq *ifq;
	<span class="enscript-type">struct</span> tcq_class *cl;

	IFCQ_LOCK_ASSERT_HELD(tif-&gt;tif_ifq);

	<span class="enscript-comment">/* Sanitize flags unless internally configured */</span>
	<span class="enscript-keyword">if</span> (tif-&gt;tif_flags &amp; TCQIFF_ALTQ)
		flags &amp;= TQCF_USERFLAGS;

#<span class="enscript-reference">if</span> !<span class="enscript-variable-name">CLASSQ_RED</span>
	<span class="enscript-keyword">if</span> (flags &amp; TQCF_RED) {
		log(LOG_ERR, <span class="enscript-string">&quot;%s: %s RED not available!\n&quot;</span>,
		    if_name(TCQIF_IFP(tif)), tcq_style(tif));
		<span class="enscript-keyword">return</span> (NULL);
	}
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !CLASSQ_RED */</span>

#<span class="enscript-reference">if</span> !<span class="enscript-variable-name">CLASSQ_RIO</span>
	<span class="enscript-keyword">if</span> (flags &amp; TQCF_RIO) {
		log(LOG_ERR, <span class="enscript-string">&quot;%s: %s RIO not available!\n&quot;</span>,
		    if_name(TCQIF_IFP(tif)), tcq_style(tif));
		<span class="enscript-keyword">return</span> (NULL);
	}
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_RIO */</span>

#<span class="enscript-reference">if</span> !<span class="enscript-variable-name">CLASSQ_BLUE</span>
	<span class="enscript-keyword">if</span> (flags &amp; TQCF_BLUE) {
		log(LOG_ERR, <span class="enscript-string">&quot;%s: %s BLUE not available!\n&quot;</span>,
		    if_name(TCQIF_IFP(tif)), tcq_style(tif));
		<span class="enscript-keyword">return</span> (NULL);
	}
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_BLUE */</span>

	<span class="enscript-comment">/* These are mutually exclusive */</span>
	<span class="enscript-keyword">if</span> ((flags &amp; (TQCF_RED|TQCF_RIO|TQCF_BLUE|TQCF_SFB)) &amp;&amp;
	    (flags &amp; (TQCF_RED|TQCF_RIO|TQCF_BLUE|TQCF_SFB)) != TQCF_RED &amp;&amp;
	    (flags &amp; (TQCF_RED|TQCF_RIO|TQCF_BLUE|TQCF_SFB)) != TQCF_RIO &amp;&amp;
	    (flags &amp; (TQCF_RED|TQCF_RIO|TQCF_BLUE|TQCF_SFB)) != TQCF_BLUE &amp;&amp;
	    (flags &amp; (TQCF_RED|TQCF_RIO|TQCF_BLUE|TQCF_SFB)) != TQCF_SFB) {
		log(LOG_ERR, <span class="enscript-string">&quot;%s: %s more than one RED|RIO|BLUE|SFB\n&quot;</span>,
		    if_name(TCQIF_IFP(tif)), tcq_style(tif));
		<span class="enscript-keyword">return</span> (NULL);
	}

	ifq = tif-&gt;tif_ifq;
	ifp = TCQIF_IFP(tif);

	<span class="enscript-keyword">if</span> ((cl = tif-&gt;tif_classes[pri]) != NULL) {
		<span class="enscript-comment">/* modify the class instead of creating a new one */</span>
		<span class="enscript-keyword">if</span> (!qempty(&amp;cl-&gt;cl_q))
			tcq_purgeq(tif, cl, 0, NULL, NULL);
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_RIO</span>
		<span class="enscript-keyword">if</span> (q_is_rio(&amp;cl-&gt;cl_q))
			rio_destroy(cl-&gt;cl_rio);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_RIO */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_RED</span>
		<span class="enscript-keyword">if</span> (q_is_red(&amp;cl-&gt;cl_q))
			red_destroy(cl-&gt;cl_red);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_RED */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_BLUE</span>
		<span class="enscript-keyword">if</span> (q_is_blue(&amp;cl-&gt;cl_q))
			blue_destroy(cl-&gt;cl_blue);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_BLUE */</span>
		<span class="enscript-keyword">if</span> (q_is_sfb(&amp;cl-&gt;cl_q) &amp;&amp; cl-&gt;cl_sfb != NULL)
			sfb_destroy(cl-&gt;cl_sfb);
		cl-&gt;cl_qalg.ptr = NULL;
		qtype(&amp;cl-&gt;cl_q) = Q_DROPTAIL;
		qstate(&amp;cl-&gt;cl_q) = QS_RUNNING;
	} <span class="enscript-keyword">else</span> {
		cl = zalloc(tcq_cl_zone);
		<span class="enscript-keyword">if</span> (cl == NULL)
			<span class="enscript-keyword">return</span> (NULL);

		bzero(cl, tcq_cl_size);
	}

	tif-&gt;tif_classes[pri] = cl;
	<span class="enscript-keyword">if</span> (flags &amp; TQCF_DEFAULTCLASS)
		tif-&gt;tif_default = cl;
	<span class="enscript-keyword">if</span> (qlimit == 0 || qlimit &gt; IFCQ_MAXLEN(ifq)) {
		qlimit = IFCQ_MAXLEN(ifq);
		<span class="enscript-keyword">if</span> (qlimit == 0)
			qlimit = DEFAULT_QLIMIT;  <span class="enscript-comment">/* use default */</span>
	}
	_qinit(&amp;cl-&gt;cl_q, Q_DROPTAIL, qlimit);
	cl-&gt;cl_flags = flags;
	cl-&gt;cl_pri = pri;
	<span class="enscript-keyword">if</span> (pri &gt; tif-&gt;tif_maxpri)
		tif-&gt;tif_maxpri = pri;
	cl-&gt;cl_tif = tif;
	cl-&gt;cl_handle = qid;

	<span class="enscript-keyword">if</span> (flags &amp; (TQCF_RED|TQCF_RIO|TQCF_BLUE|TQCF_SFB)) {
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_RED</span> || <span class="enscript-variable-name">CLASSQ_RIO</span>
		u_int64_t ifbandwidth = ifnet_output_linkrate(ifp);
		<span class="enscript-type">int</span> pkttime;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_RED || CLASSQ_RIO */</span>

		cl-&gt;cl_qflags = 0;
		<span class="enscript-keyword">if</span> (flags &amp; TQCF_ECN) {
			<span class="enscript-keyword">if</span> (flags &amp; TQCF_BLUE)
				cl-&gt;cl_qflags |= BLUEF_ECN;
			<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (flags &amp; TQCF_SFB)
				cl-&gt;cl_qflags |= SFBF_ECN;
			<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (flags &amp; TQCF_RED)
				cl-&gt;cl_qflags |= REDF_ECN;
			<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (flags &amp; TQCF_RIO)
				cl-&gt;cl_qflags |= RIOF_ECN;
		}
		<span class="enscript-keyword">if</span> (flags &amp; TQCF_FLOWCTL) {
			<span class="enscript-keyword">if</span> (flags &amp; TQCF_SFB)
				cl-&gt;cl_qflags |= SFBF_FLOWCTL;
		}
		<span class="enscript-keyword">if</span> (flags &amp; TQCF_DELAYBASED) {
			<span class="enscript-keyword">if</span> (flags &amp; TQCF_SFB)
				cl-&gt;cl_qflags |= SFBF_DELAYBASED;
		}
		<span class="enscript-keyword">if</span> (flags &amp; TQCF_CLEARDSCP) {
			<span class="enscript-keyword">if</span> (flags &amp; TQCF_RIO)
				cl-&gt;cl_qflags |= RIOF_CLEARDSCP;
		}
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_RED</span> || <span class="enscript-variable-name">CLASSQ_RIO</span>
		<span class="enscript-comment">/*
		 * XXX: RED &amp; RIO should be watching link speed and MTU
		 *	events and recompute pkttime accordingly.
		 */</span>
		<span class="enscript-keyword">if</span> (ifbandwidth &lt; 8)
			pkttime = 1000 * 1000 * 1000; <span class="enscript-comment">/* 1 sec */</span>
		<span class="enscript-keyword">else</span>
			pkttime = (int64_t)ifp-&gt;if_mtu * 1000 * 1000 * 1000 /
			    (ifbandwidth / 8);

		<span class="enscript-comment">/* Test for exclusivity {RED,RIO,BLUE,SFB} was done above */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_RED</span>
		<span class="enscript-keyword">if</span> (flags &amp; TQCF_RED) {
			cl-&gt;cl_red = red_alloc(ifp, 0, 0,
			    qlimit(&amp;cl-&gt;cl_q) * 10/100,
			    qlimit(&amp;cl-&gt;cl_q) * 30/100,
			    cl-&gt;cl_qflags, pkttime);
			<span class="enscript-keyword">if</span> (cl-&gt;cl_red != NULL)
				qtype(&amp;cl-&gt;cl_q) = Q_RED;
		}
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_RED */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_RIO</span>
		<span class="enscript-keyword">if</span> (flags &amp; TQCF_RIO) {
			cl-&gt;cl_rio =
			    rio_alloc(ifp, 0, NULL, cl-&gt;cl_qflags, pkttime);
			<span class="enscript-keyword">if</span> (cl-&gt;cl_rio != NULL)
				qtype(&amp;cl-&gt;cl_q) = Q_RIO;
		}
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_RIO */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_RED || CLASSQ_RIO */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_BLUE</span>
		<span class="enscript-keyword">if</span> (flags &amp; TQCF_BLUE) {
			cl-&gt;cl_blue = blue_alloc(ifp, 0, 0, cl-&gt;cl_qflags);
			<span class="enscript-keyword">if</span> (cl-&gt;cl_blue != NULL)
				qtype(&amp;cl-&gt;cl_q) = Q_BLUE;
		}
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_BLUE */</span>
		<span class="enscript-keyword">if</span> (flags &amp; TQCF_SFB) {
			<span class="enscript-keyword">if</span> (!(cl-&gt;cl_flags &amp; TQCF_LAZY))
				cl-&gt;cl_sfb = sfb_alloc(ifp, cl-&gt;cl_handle,
				    qlimit(&amp;cl-&gt;cl_q), cl-&gt;cl_qflags);
			<span class="enscript-keyword">if</span> (cl-&gt;cl_sfb != NULL || (cl-&gt;cl_flags &amp; TQCF_LAZY))
				qtype(&amp;cl-&gt;cl_q) = Q_SFB;
		}
	}

	<span class="enscript-keyword">if</span> (pktsched_verbose) {
		log(LOG_DEBUG, <span class="enscript-string">&quot;%s: %s created qid=%d pri=%d qlimit=%d &quot;</span>
		    <span class="enscript-string">&quot;flags=%b\n&quot;</span>, if_name(ifp), tcq_style(tif),
		    cl-&gt;cl_handle, cl-&gt;cl_pri, qlimit, flags, TQCF_BITS);
	}

	<span class="enscript-keyword">return</span> (cl);
}

<span class="enscript-type">int</span>
<span class="enscript-function-name">tcq_remove_queue</span>(<span class="enscript-type">struct</span> tcq_if *tif, u_int32_t qid)
{
	<span class="enscript-type">struct</span> tcq_class *cl;

	IFCQ_LOCK_ASSERT_HELD(tif-&gt;tif_ifq);

	<span class="enscript-keyword">if</span> ((cl = tcq_clh_to_clp(tif, qid)) == NULL)
		<span class="enscript-keyword">return</span> (EINVAL);

	<span class="enscript-keyword">return</span> (tcq_class_destroy(tif, cl));
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">tcq_class_destroy</span>(<span class="enscript-type">struct</span> tcq_if *tif, <span class="enscript-type">struct</span> tcq_class *cl)
{
	<span class="enscript-type">struct</span> ifclassq *ifq = tif-&gt;tif_ifq;
	<span class="enscript-type">int</span> pri;

	IFCQ_LOCK_ASSERT_HELD(ifq);

	<span class="enscript-keyword">if</span> (!qempty(&amp;cl-&gt;cl_q))
		tcq_purgeq(tif, cl, 0, NULL, NULL);

	tif-&gt;tif_classes[cl-&gt;cl_pri] = NULL;
	<span class="enscript-keyword">if</span> (tif-&gt;tif_maxpri == cl-&gt;cl_pri) {
		<span class="enscript-keyword">for</span> (pri = cl-&gt;cl_pri; pri &gt;= 0; pri--)
			<span class="enscript-keyword">if</span> (tif-&gt;tif_classes[pri] != NULL) {
				tif-&gt;tif_maxpri = pri;
				<span class="enscript-keyword">break</span>;
			}
		<span class="enscript-keyword">if</span> (pri &lt; 0)
			tif-&gt;tif_maxpri = -1;
	}

	<span class="enscript-keyword">if</span> (tif-&gt;tif_default == cl)
		tif-&gt;tif_default = NULL;

	<span class="enscript-keyword">if</span> (cl-&gt;cl_qalg.ptr != NULL) {
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_RIO</span>
		<span class="enscript-keyword">if</span> (q_is_rio(&amp;cl-&gt;cl_q))
			rio_destroy(cl-&gt;cl_rio);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_RIO */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_RED</span>
		<span class="enscript-keyword">if</span> (q_is_red(&amp;cl-&gt;cl_q))
			red_destroy(cl-&gt;cl_red);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_RED */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_BLUE</span>
		<span class="enscript-keyword">if</span> (q_is_blue(&amp;cl-&gt;cl_q))
			blue_destroy(cl-&gt;cl_blue);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_BLUE */</span>
		<span class="enscript-keyword">if</span> (q_is_sfb(&amp;cl-&gt;cl_q) &amp;&amp; cl-&gt;cl_sfb != NULL)
			sfb_destroy(cl-&gt;cl_sfb);
		cl-&gt;cl_qalg.ptr = NULL;
		qtype(&amp;cl-&gt;cl_q) = Q_DROPTAIL;
		qstate(&amp;cl-&gt;cl_q) = QS_RUNNING;
	}

	<span class="enscript-keyword">if</span> (pktsched_verbose) {
		log(LOG_DEBUG, <span class="enscript-string">&quot;%s: %s destroyed qid=%d pri=%d\n&quot;</span>,
		    if_name(TCQIF_IFP(tif)), tcq_style(tif),
		    cl-&gt;cl_handle, cl-&gt;cl_pri);
	}

	zfree(tcq_cl_zone, cl);
	<span class="enscript-keyword">return</span> (0);
}

<span class="enscript-type">int</span>
<span class="enscript-function-name">tcq_enqueue</span>(<span class="enscript-type">struct</span> tcq_if *tif, <span class="enscript-type">struct</span> tcq_class *cl, <span class="enscript-type">struct</span> mbuf *m,
    <span class="enscript-type">struct</span> pf_mtag *t)
{
	<span class="enscript-type">struct</span> ifclassq *ifq = tif-&gt;tif_ifq;
	<span class="enscript-type">int</span> len, ret;

	IFCQ_LOCK_ASSERT_HELD(ifq);
	VERIFY(cl == NULL || cl-&gt;cl_tif == tif);

	<span class="enscript-keyword">if</span> (cl == NULL) {
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PF_ALTQ</span>
		cl = tcq_clh_to_clp(tif, t-&gt;pftag_qid);
#<span class="enscript-reference">else</span> <span class="enscript-comment">/* !PF_ALTQ */</span>
		cl = tcq_clh_to_clp(tif, 0);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !PF_ALTQ */</span>
		<span class="enscript-keyword">if</span> (cl == NULL) {
			cl = tif-&gt;tif_default;
			<span class="enscript-keyword">if</span> (cl == NULL) {
				IFCQ_CONVERT_LOCK(ifq);
				m_freem(m);
				<span class="enscript-keyword">return</span> (ENOBUFS);
			}
		}
	}

	len = m_pktlen(m);

	ret = tcq_addq(cl, m, t);
	<span class="enscript-keyword">if</span> (ret != 0) {
		<span class="enscript-keyword">if</span> (ret == CLASSQEQ_SUCCESS_FC) {
			<span class="enscript-comment">/* packet enqueued, return advisory feedback */</span>
			ret = EQFULL;
		} <span class="enscript-keyword">else</span> {
			VERIFY(ret == CLASSQEQ_DROPPED ||
			    ret == CLASSQEQ_DROPPED_FC ||
			    ret == CLASSQEQ_DROPPED_SP);
			<span class="enscript-comment">/* packet has been freed in tcq_addq */</span>
			PKTCNTR_ADD(&amp;cl-&gt;cl_dropcnt, 1, len);
			IFCQ_DROP_ADD(ifq, 1, len);
			<span class="enscript-keyword">switch</span> (ret) {
			<span class="enscript-keyword">case</span> <span class="enscript-reference">CLASSQEQ_DROPPED</span>:
				<span class="enscript-keyword">return</span> (ENOBUFS);
			<span class="enscript-keyword">case</span> <span class="enscript-reference">CLASSQEQ_DROPPED_FC</span>:
				<span class="enscript-keyword">return</span> (EQFULL);
			<span class="enscript-keyword">case</span> <span class="enscript-reference">CLASSQEQ_DROPPED_SP</span>:
				<span class="enscript-keyword">return</span> (EQSUSPENDED);
			}
			<span class="enscript-comment">/* NOT REACHED */</span>
		}
	}
	IFCQ_INC_LEN(ifq);
	IFCQ_INC_BYTES(ifq, len);

	<span class="enscript-comment">/* successfully queued. */</span>
	<span class="enscript-keyword">return</span> (ret);
}

<span class="enscript-comment">/*
 * note: CLASSQDQ_POLL returns the next packet without removing the packet
 *	from the queue.  CLASSQDQ_REMOVE is a normal dequeue operation.
 *	CLASSQDQ_REMOVE must return the same packet if called immediately
 *	after CLASSQDQ_POLL.
 */</span>
<span class="enscript-type">struct</span> mbuf *
<span class="enscript-function-name">tcq_dequeue_tc</span>(<span class="enscript-type">struct</span> tcq_if *tif, mbuf_svc_class_t sc, cqdq_op_t op)
{
	<span class="enscript-keyword">return</span> (tcq_dequeue_cl(tif, NULL, sc, op));
}

<span class="enscript-type">static</span> <span class="enscript-type">struct</span> mbuf *
<span class="enscript-function-name">tcq_dequeue_cl</span>(<span class="enscript-type">struct</span> tcq_if *tif, <span class="enscript-type">struct</span> tcq_class *cl,
    mbuf_svc_class_t sc, cqdq_op_t op)
{
	<span class="enscript-type">struct</span> ifclassq *ifq = tif-&gt;tif_ifq;
	<span class="enscript-type">struct</span> mbuf *m;

	IFCQ_LOCK_ASSERT_HELD(ifq);

	<span class="enscript-keyword">if</span> (cl == NULL) {
		cl = tcq_clh_to_clp(tif, MBUF_SCIDX(sc));
		<span class="enscript-keyword">if</span> (cl == NULL)
			<span class="enscript-keyword">return</span> (NULL);
	}

	<span class="enscript-keyword">if</span> (qempty(&amp;cl-&gt;cl_q))
		<span class="enscript-keyword">return</span> (NULL);

	VERIFY(!IFCQ_IS_EMPTY(ifq));

	<span class="enscript-keyword">if</span> (op == CLASSQDQ_POLL)
		<span class="enscript-keyword">return</span> (tcq_pollq(cl));

	m = tcq_getq(cl);
	<span class="enscript-keyword">if</span> (m != NULL) {
		IFCQ_DEC_LEN(ifq);
		IFCQ_DEC_BYTES(ifq, m_pktlen(m));
		<span class="enscript-keyword">if</span> (qempty(&amp;cl-&gt;cl_q))
			cl-&gt;cl_period++;
		PKTCNTR_ADD(&amp;cl-&gt;cl_xmitcnt, 1, m_pktlen(m));
		IFCQ_XMIT_ADD(ifq, 1, m_pktlen(m));
	}
	<span class="enscript-keyword">return</span> (m);
}

<span class="enscript-type">static</span> inline <span class="enscript-type">int</span>
<span class="enscript-function-name">tcq_addq</span>(<span class="enscript-type">struct</span> tcq_class *cl, <span class="enscript-type">struct</span> mbuf *m, <span class="enscript-type">struct</span> pf_mtag *t)
{
	<span class="enscript-type">struct</span> tcq_if *tif = cl-&gt;cl_tif;
	<span class="enscript-type">struct</span> ifclassq *ifq = tif-&gt;tif_ifq;

	IFCQ_LOCK_ASSERT_HELD(ifq);

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_RIO</span>
	<span class="enscript-keyword">if</span> (q_is_rio(&amp;cl-&gt;cl_q))
		<span class="enscript-keyword">return</span> (rio_addq(cl-&gt;cl_rio, &amp;cl-&gt;cl_q, m, t));
	<span class="enscript-keyword">else</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_RIO */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_RED</span>
	<span class="enscript-keyword">if</span> (q_is_red(&amp;cl-&gt;cl_q))
		<span class="enscript-keyword">return</span> (red_addq(cl-&gt;cl_red, &amp;cl-&gt;cl_q, m, t));
	<span class="enscript-keyword">else</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_RED */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_BLUE</span>
	<span class="enscript-keyword">if</span> (q_is_blue(&amp;cl-&gt;cl_q))
		<span class="enscript-keyword">return</span> (blue_addq(cl-&gt;cl_blue, &amp;cl-&gt;cl_q, m, t));
	<span class="enscript-keyword">else</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_BLUE */</span>
	<span class="enscript-keyword">if</span> (q_is_sfb(&amp;cl-&gt;cl_q)) {
		<span class="enscript-keyword">if</span> (cl-&gt;cl_sfb == NULL) {
			<span class="enscript-type">struct</span> ifnet *ifp = TCQIF_IFP(tif);

			VERIFY(cl-&gt;cl_flags &amp; TQCF_LAZY);
			cl-&gt;cl_flags &amp;= ~TQCF_LAZY;
			IFCQ_CONVERT_LOCK(ifq);

			cl-&gt;cl_sfb = sfb_alloc(ifp, cl-&gt;cl_handle,
			    qlimit(&amp;cl-&gt;cl_q), cl-&gt;cl_qflags);
			<span class="enscript-keyword">if</span> (cl-&gt;cl_sfb == NULL) {
				<span class="enscript-comment">/* fall back to droptail */</span>
				qtype(&amp;cl-&gt;cl_q) = Q_DROPTAIL;
				cl-&gt;cl_flags &amp;= ~TQCF_SFB;
				cl-&gt;cl_qflags &amp;= ~(SFBF_ECN | SFBF_FLOWCTL);

				log(LOG_ERR, <span class="enscript-string">&quot;%s: %s SFB lazy allocation &quot;</span>
				    <span class="enscript-string">&quot;failed for qid=%d pri=%d, falling back &quot;</span>
				    <span class="enscript-string">&quot;to DROPTAIL\n&quot;</span>, if_name(ifp),
				    tcq_style(tif), cl-&gt;cl_handle,
				    cl-&gt;cl_pri);
			} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (tif-&gt;tif_throttle != IFNET_THROTTLE_OFF) {
				<span class="enscript-comment">/* if there's pending throttling, set it */</span>
				cqrq_throttle_t tr = { 1, tif-&gt;tif_throttle };
				<span class="enscript-type">int</span> err = tcq_throttle(tif, &amp;tr);

				<span class="enscript-keyword">if</span> (err == EALREADY)
					err = 0;
				<span class="enscript-keyword">if</span> (err != 0) {
					tr.level = IFNET_THROTTLE_OFF;
					(<span class="enscript-type">void</span>) tcq_throttle(tif, &amp;tr);
				}
			}
		}
		<span class="enscript-keyword">if</span> (cl-&gt;cl_sfb != NULL)
			<span class="enscript-keyword">return</span> (sfb_addq(cl-&gt;cl_sfb, &amp;cl-&gt;cl_q, m, t));
	} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (qlen(&amp;cl-&gt;cl_q) &gt;= qlimit(&amp;cl-&gt;cl_q)) {
		IFCQ_CONVERT_LOCK(ifq);
		m_freem(m);
		<span class="enscript-keyword">return</span> (CLASSQEQ_DROPPED);
	}

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PF_ECN</span>
	<span class="enscript-keyword">if</span> (cl-&gt;cl_flags &amp; TQCF_CLEARDSCP)
		write_dsfield(m, t, 0);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* PF_ECN */</span>

	_addq(&amp;cl-&gt;cl_q, m);

	<span class="enscript-keyword">return</span> (0);
}

<span class="enscript-type">static</span> inline <span class="enscript-type">struct</span> mbuf *
<span class="enscript-function-name">tcq_getq</span>(<span class="enscript-type">struct</span> tcq_class *cl)
{
	IFCQ_LOCK_ASSERT_HELD(cl-&gt;cl_tif-&gt;tif_ifq);

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_RIO</span>
	<span class="enscript-keyword">if</span> (q_is_rio(&amp;cl-&gt;cl_q))
		<span class="enscript-keyword">return</span> (rio_getq(cl-&gt;cl_rio, &amp;cl-&gt;cl_q));
	<span class="enscript-keyword">else</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_RIO */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_RED</span>
	<span class="enscript-keyword">if</span> (q_is_red(&amp;cl-&gt;cl_q))
		<span class="enscript-keyword">return</span> (red_getq(cl-&gt;cl_red, &amp;cl-&gt;cl_q));
	<span class="enscript-keyword">else</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_RED */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_BLUE</span>
	<span class="enscript-keyword">if</span> (q_is_blue(&amp;cl-&gt;cl_q))
		<span class="enscript-keyword">return</span> (blue_getq(cl-&gt;cl_blue, &amp;cl-&gt;cl_q));
	<span class="enscript-keyword">else</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_BLUE */</span>
	<span class="enscript-keyword">if</span> (q_is_sfb(&amp;cl-&gt;cl_q) &amp;&amp; cl-&gt;cl_sfb != NULL)
		<span class="enscript-keyword">return</span> (sfb_getq(cl-&gt;cl_sfb, &amp;cl-&gt;cl_q));

	<span class="enscript-keyword">return</span> (_getq(&amp;cl-&gt;cl_q));
}

<span class="enscript-type">static</span> inline <span class="enscript-type">struct</span> mbuf *
<span class="enscript-function-name">tcq_pollq</span>(<span class="enscript-type">struct</span> tcq_class *cl)
{
	IFCQ_LOCK_ASSERT_HELD(cl-&gt;cl_tif-&gt;tif_ifq);

	<span class="enscript-keyword">return</span> (qhead(&amp;cl-&gt;cl_q));
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">tcq_purgeq</span>(<span class="enscript-type">struct</span> tcq_if *tif, <span class="enscript-type">struct</span> tcq_class *cl, u_int32_t flow,
    u_int32_t *packets, u_int32_t *bytes)
{
	<span class="enscript-type">struct</span> ifclassq *ifq = tif-&gt;tif_ifq;
	u_int32_t cnt = 0, len = 0, qlen;

	IFCQ_LOCK_ASSERT_HELD(ifq);

	<span class="enscript-keyword">if</span> ((qlen = qlen(&amp;cl-&gt;cl_q)) == 0)
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">done</span>;

	<span class="enscript-comment">/* become regular mutex before freeing mbufs */</span>
	IFCQ_CONVERT_LOCK(ifq);

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_RIO</span>
	<span class="enscript-keyword">if</span> (q_is_rio(&amp;cl-&gt;cl_q))
		rio_purgeq(cl-&gt;cl_rio, &amp;cl-&gt;cl_q, flow, &amp;cnt, &amp;len);
	<span class="enscript-keyword">else</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_RIO */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_RED</span>
	<span class="enscript-keyword">if</span> (q_is_red(&amp;cl-&gt;cl_q))
		red_purgeq(cl-&gt;cl_red, &amp;cl-&gt;cl_q, flow, &amp;cnt, &amp;len);
	<span class="enscript-keyword">else</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_RED */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_BLUE</span>
	<span class="enscript-keyword">if</span> (q_is_blue(&amp;cl-&gt;cl_q))
		blue_purgeq(cl-&gt;cl_blue, &amp;cl-&gt;cl_q, flow, &amp;cnt, &amp;len);
	<span class="enscript-keyword">else</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_BLUE */</span>
	<span class="enscript-keyword">if</span> (q_is_sfb(&amp;cl-&gt;cl_q) &amp;&amp; cl-&gt;cl_sfb != NULL)
		sfb_purgeq(cl-&gt;cl_sfb, &amp;cl-&gt;cl_q, flow, &amp;cnt, &amp;len);
	<span class="enscript-keyword">else</span>
		_flushq_flow(&amp;cl-&gt;cl_q, flow, &amp;cnt, &amp;len);

	<span class="enscript-keyword">if</span> (cnt &gt; 0) {
		VERIFY(qlen(&amp;cl-&gt;cl_q) == (qlen - cnt));

		PKTCNTR_ADD(&amp;cl-&gt;cl_dropcnt, cnt, len);
		IFCQ_DROP_ADD(ifq, cnt, len);

		VERIFY(((<span class="enscript-type">signed</span>)IFCQ_LEN(ifq) - cnt) &gt;= 0);
		IFCQ_LEN(ifq) -= cnt;

		<span class="enscript-keyword">if</span> (pktsched_verbose) {
			log(LOG_DEBUG, <span class="enscript-string">&quot;%s: %s purge qid=%d pri=%d &quot;</span>
			    <span class="enscript-string">&quot;qlen=[%d,%d] cnt=%d len=%d flow=0x%x\n&quot;</span>,
			    if_name(TCQIF_IFP(tif)), tcq_style(tif),
			    cl-&gt;cl_handle, cl-&gt;cl_pri, qlen, qlen(&amp;cl-&gt;cl_q),
			    cnt, len, flow);
		}
	}
<span class="enscript-reference">done</span>:
	<span class="enscript-keyword">if</span> (packets != NULL)
		*packets = cnt;
	<span class="enscript-keyword">if</span> (bytes != NULL)
		*bytes = len;
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">tcq_updateq</span>(<span class="enscript-type">struct</span> tcq_if *tif, <span class="enscript-type">struct</span> tcq_class *cl, cqev_t ev)
{
	IFCQ_LOCK_ASSERT_HELD(tif-&gt;tif_ifq);

	<span class="enscript-keyword">if</span> (pktsched_verbose) {
		log(LOG_DEBUG, <span class="enscript-string">&quot;%s: %s update qid=%d pri=%d event=%s\n&quot;</span>,
		    if_name(TCQIF_IFP(tif)), tcq_style(tif),
		    cl-&gt;cl_handle, cl-&gt;cl_pri, ifclassq_ev2str(ev));
	}

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_RIO</span>
	<span class="enscript-keyword">if</span> (q_is_rio(&amp;cl-&gt;cl_q))
		<span class="enscript-keyword">return</span> (rio_updateq(cl-&gt;cl_rio, ev));
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_RIO */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_RED</span>
	<span class="enscript-keyword">if</span> (q_is_red(&amp;cl-&gt;cl_q))
		<span class="enscript-keyword">return</span> (red_updateq(cl-&gt;cl_red, ev));
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_RED */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_BLUE</span>
	<span class="enscript-keyword">if</span> (q_is_blue(&amp;cl-&gt;cl_q))
		<span class="enscript-keyword">return</span> (blue_updateq(cl-&gt;cl_blue, ev));
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_BLUE */</span>
	<span class="enscript-keyword">if</span> (q_is_sfb(&amp;cl-&gt;cl_q) &amp;&amp; cl-&gt;cl_sfb != NULL)
		<span class="enscript-keyword">return</span> (sfb_updateq(cl-&gt;cl_sfb, ev));
}

<span class="enscript-type">int</span>
<span class="enscript-function-name">tcq_get_class_stats</span>(<span class="enscript-type">struct</span> tcq_if *tif, u_int32_t qid,
    <span class="enscript-type">struct</span> tcq_classstats *sp)
{
	<span class="enscript-type">struct</span> tcq_class *cl;

	IFCQ_LOCK_ASSERT_HELD(tif-&gt;tif_ifq);

	<span class="enscript-keyword">if</span> ((cl = tcq_clh_to_clp(tif, qid)) == NULL)
		<span class="enscript-keyword">return</span> (EINVAL);

	sp-&gt;class_handle = cl-&gt;cl_handle;
	sp-&gt;priority = cl-&gt;cl_pri;
	sp-&gt;qlength = qlen(&amp;cl-&gt;cl_q);
	sp-&gt;qlimit = qlimit(&amp;cl-&gt;cl_q);
	sp-&gt;period = cl-&gt;cl_period;
	sp-&gt;xmitcnt = cl-&gt;cl_xmitcnt;
	sp-&gt;dropcnt = cl-&gt;cl_dropcnt;

	sp-&gt;qtype = qtype(&amp;cl-&gt;cl_q);
	sp-&gt;qstate = qstate(&amp;cl-&gt;cl_q);
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_RED</span>
	<span class="enscript-keyword">if</span> (q_is_red(&amp;cl-&gt;cl_q))
		red_getstats(cl-&gt;cl_red, &amp;sp-&gt;red[0]);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_RED */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_RIO</span>
	<span class="enscript-keyword">if</span> (q_is_rio(&amp;cl-&gt;cl_q))
		rio_getstats(cl-&gt;cl_rio, &amp;sp-&gt;red[0]);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_RIO */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_BLUE</span>
	<span class="enscript-keyword">if</span> (q_is_blue(&amp;cl-&gt;cl_q))
		blue_getstats(cl-&gt;cl_blue, &amp;sp-&gt;blue);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_BLUE */</span>
	<span class="enscript-keyword">if</span> (q_is_sfb(&amp;cl-&gt;cl_q) &amp;&amp; cl-&gt;cl_sfb != NULL)
		sfb_getstats(cl-&gt;cl_sfb, &amp;sp-&gt;sfb);

	<span class="enscript-keyword">return</span> (0);
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">tcq_stat_sc</span>(<span class="enscript-type">struct</span> tcq_if *tif, cqrq_stat_sc_t *sr)
{
	<span class="enscript-type">struct</span> ifclassq *ifq = tif-&gt;tif_ifq;
	<span class="enscript-type">struct</span> tcq_class *cl;
	u_int32_t i;

	IFCQ_LOCK_ASSERT_HELD(ifq);

	VERIFY(sr-&gt;sc == MBUF_SC_UNSPEC || MBUF_VALID_SC(sr-&gt;sc));

	i = MBUF_SCIDX(sr-&gt;sc);
	VERIFY(i &lt; IFCQ_SC_MAX);

	cl = ifq-&gt;ifcq_disc_slots[i].cl;
	sr-&gt;packets = qlen(&amp;cl-&gt;cl_q);
	sr-&gt;bytes = qsize(&amp;cl-&gt;cl_q);

	<span class="enscript-keyword">return</span> (0);
}

<span class="enscript-comment">/* convert a class handle to the corresponding class pointer */</span>
<span class="enscript-type">static</span> inline <span class="enscript-type">struct</span> tcq_class *
<span class="enscript-function-name">tcq_clh_to_clp</span>(<span class="enscript-type">struct</span> tcq_if *tif, u_int32_t chandle)
{
	<span class="enscript-type">struct</span> tcq_class *cl;
	<span class="enscript-type">int</span> idx;

	IFCQ_LOCK_ASSERT_HELD(tif-&gt;tif_ifq);

	<span class="enscript-keyword">for</span> (idx = tif-&gt;tif_maxpri; idx &gt;= 0; idx--)
		<span class="enscript-keyword">if</span> ((cl = tif-&gt;tif_classes[idx]) != NULL &amp;&amp;
		    cl-&gt;cl_handle == chandle)
			<span class="enscript-keyword">return</span> (cl);

	<span class="enscript-keyword">return</span> (NULL);
}

<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> *
<span class="enscript-function-name">tcq_style</span>(<span class="enscript-type">struct</span> tcq_if *tif)
{
	<span class="enscript-keyword">return</span> ((tif-&gt;tif_flags &amp; TCQIFF_ALTQ) ? <span class="enscript-string">&quot;ALTQ_TCQ&quot;</span> : <span class="enscript-string">&quot;TCQ&quot;</span>);
}

<span class="enscript-comment">/*
 * tcq_enqueue_ifclassq is an enqueue function to be registered to
 * (*ifcq_enqueue) in struct ifclassq.
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">tcq_enqueue_ifclassq</span>(<span class="enscript-type">struct</span> ifclassq *ifq, <span class="enscript-type">struct</span> mbuf *m)
{
	u_int32_t i;

	IFCQ_LOCK_ASSERT_HELD(ifq);

	<span class="enscript-keyword">if</span> (!(m-&gt;m_flags &amp; M_PKTHDR)) {
		<span class="enscript-comment">/* should not happen */</span>
		log(LOG_ERR, <span class="enscript-string">&quot;%s: packet does not have pkthdr\n&quot;</span>,
		    if_name(ifq-&gt;ifcq_ifp));
		IFCQ_CONVERT_LOCK(ifq);
		m_freem(m);
		<span class="enscript-keyword">return</span> (ENOBUFS);
	}

	i = MBUF_SCIDX(mbuf_get_service_class(m));
	VERIFY((u_int32_t)i &lt; IFCQ_SC_MAX);

	<span class="enscript-keyword">return</span> (tcq_enqueue(ifq-&gt;ifcq_disc,
	    ifq-&gt;ifcq_disc_slots[i].cl, m, m_pftag(m)));
}

<span class="enscript-comment">/*
 * tcq_dequeue_tc_ifclassq is a dequeue function to be registered to
 * (*ifcq_dequeue) in struct ifclass.
 *
 * note: CLASSQDQ_POLL returns the next packet without removing the packet
 *	from the queue.  CLASSQDQ_REMOVE is a normal dequeue operation.
 *	CLASSQDQ_REMOVE must return the same packet if called immediately
 *	after CLASSQDQ_POLL.
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">struct</span> mbuf *
<span class="enscript-function-name">tcq_dequeue_tc_ifclassq</span>(<span class="enscript-type">struct</span> ifclassq *ifq, mbuf_svc_class_t sc,
    cqdq_op_t op)
{
	u_int32_t i = MBUF_SCIDX(sc);

	VERIFY((u_int32_t)i &lt; IFCQ_SC_MAX);

	<span class="enscript-keyword">return</span> (tcq_dequeue_cl(ifq-&gt;ifcq_disc,
	    ifq-&gt;ifcq_disc_slots[i].cl, sc, op));
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">tcq_request_ifclassq</span>(<span class="enscript-type">struct</span> ifclassq *ifq, cqrq_t req, <span class="enscript-type">void</span> *arg)
{
	<span class="enscript-type">struct</span> tcq_if	*tif = (<span class="enscript-type">struct</span> tcq_if *)ifq-&gt;ifcq_disc;
	<span class="enscript-type">int</span> err = 0;

	IFCQ_LOCK_ASSERT_HELD(ifq);

	<span class="enscript-keyword">switch</span> (req) {
	<span class="enscript-keyword">case</span> <span class="enscript-reference">CLASSQRQ_PURGE</span>:
		tcq_purge(tif);
		<span class="enscript-keyword">break</span>;

	<span class="enscript-keyword">case</span> <span class="enscript-reference">CLASSQRQ_PURGE_SC</span>:
		tcq_purge_sc(tif, (cqrq_purge_sc_t *)arg);
		<span class="enscript-keyword">break</span>;

	<span class="enscript-keyword">case</span> <span class="enscript-reference">CLASSQRQ_EVENT</span>:
		tcq_event(tif, (cqev_t)arg);
		<span class="enscript-keyword">break</span>;

	<span class="enscript-keyword">case</span> <span class="enscript-reference">CLASSQRQ_THROTTLE</span>:
		err = tcq_throttle(tif, (cqrq_throttle_t *)arg);
		<span class="enscript-keyword">break</span>;

	<span class="enscript-keyword">case</span> <span class="enscript-reference">CLASSQRQ_STAT_SC</span>:
		err = tcq_stat_sc(tif, (cqrq_stat_sc_t *)arg);
		<span class="enscript-keyword">break</span>;
	}
	<span class="enscript-keyword">return</span> (err);
}

<span class="enscript-type">int</span>
<span class="enscript-function-name">tcq_setup_ifclassq</span>(<span class="enscript-type">struct</span> ifclassq *ifq, u_int32_t flags)
{
	<span class="enscript-type">struct</span> ifnet *ifp = ifq-&gt;ifcq_ifp;
	<span class="enscript-type">struct</span> tcq_class *cl0, *cl1, *cl2, *cl3;
	<span class="enscript-type">struct</span> tcq_if *tif;
	u_int32_t maxlen = 0, qflags = 0;
	<span class="enscript-type">int</span> err = 0;

	IFCQ_LOCK_ASSERT_HELD(ifq);
	VERIFY(ifq-&gt;ifcq_disc == NULL);
	VERIFY(ifq-&gt;ifcq_type == PKTSCHEDT_NONE);

	<span class="enscript-keyword">if</span> (flags &amp; PKTSCHEDF_QALG_RED)
		qflags |= TQCF_RED;
	<span class="enscript-keyword">if</span> (flags &amp; PKTSCHEDF_QALG_RIO)
		qflags |= TQCF_RIO;
	<span class="enscript-keyword">if</span> (flags &amp; PKTSCHEDF_QALG_BLUE)
		qflags |= TQCF_BLUE;
	<span class="enscript-keyword">if</span> (flags &amp; PKTSCHEDF_QALG_SFB)
		qflags |= TQCF_SFB;
	<span class="enscript-keyword">if</span> (flags &amp; PKTSCHEDF_QALG_ECN)
		qflags |= TQCF_ECN;
	<span class="enscript-keyword">if</span> (flags &amp; PKTSCHEDF_QALG_FLOWCTL)
		qflags |= TQCF_FLOWCTL;
	<span class="enscript-keyword">if</span> (flags &amp; PKTSCHEDF_QALG_DELAYBASED)
		qflags |= TQCF_DELAYBASED;

	tif = tcq_alloc(ifp, M_WAITOK, FALSE);
	<span class="enscript-keyword">if</span> (tif == NULL)
		<span class="enscript-keyword">return</span> (ENOMEM);

	<span class="enscript-keyword">if</span> ((maxlen = IFCQ_MAXLEN(ifq)) == 0)
		maxlen = if_sndq_maxlen;

	<span class="enscript-keyword">if</span> ((err = tcq_add_queue(tif, 0, maxlen,
	    qflags | PRCF_LAZY, SCIDX_BK, &amp;cl0)) != 0)
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">cleanup</span>;

	<span class="enscript-keyword">if</span> ((err = tcq_add_queue(tif, 1, maxlen,
	    qflags | TQCF_DEFAULTCLASS, SCIDX_BE, &amp;cl1)) != 0)
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">cleanup</span>;

	<span class="enscript-keyword">if</span> ((err = tcq_add_queue(tif, 2, maxlen,
	    qflags | PRCF_LAZY, SCIDX_VI, &amp;cl2)) != 0)
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">cleanup</span>;

	<span class="enscript-keyword">if</span> ((err = tcq_add_queue(tif, 3, maxlen,
	    qflags, SCIDX_VO, &amp;cl3)) != 0)
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">cleanup</span>;

	err = ifclassq_attach(ifq, PKTSCHEDT_TCQ, tif,
	    tcq_enqueue_ifclassq, NULL, tcq_dequeue_tc_ifclassq,
	    tcq_request_ifclassq);

	<span class="enscript-comment">/* cache these for faster lookup */</span>
	<span class="enscript-keyword">if</span> (err == 0) {
		<span class="enscript-comment">/* Map {BK_SYS,BK} to TC_BK */</span>
		ifq-&gt;ifcq_disc_slots[SCIDX_BK_SYS].qid = SCIDX_BK;
		ifq-&gt;ifcq_disc_slots[SCIDX_BK_SYS].cl = cl0;

		ifq-&gt;ifcq_disc_slots[SCIDX_BK].qid = SCIDX_BK;
		ifq-&gt;ifcq_disc_slots[SCIDX_BK].cl = cl0;

		<span class="enscript-comment">/* Map {BE,RD,OAM} to TC_BE */</span>
		ifq-&gt;ifcq_disc_slots[SCIDX_BE].qid = SCIDX_BE;
		ifq-&gt;ifcq_disc_slots[SCIDX_BE].cl = cl1;

		ifq-&gt;ifcq_disc_slots[SCIDX_RD].qid = SCIDX_BE;
		ifq-&gt;ifcq_disc_slots[SCIDX_RD].cl = cl1;

		ifq-&gt;ifcq_disc_slots[SCIDX_OAM].qid = SCIDX_BE;
		ifq-&gt;ifcq_disc_slots[SCIDX_OAM].cl = cl1;

		<span class="enscript-comment">/* Map {AV,RV,VI} to TC_VI */</span>
		ifq-&gt;ifcq_disc_slots[SCIDX_AV].qid = SCIDX_VI;
		ifq-&gt;ifcq_disc_slots[SCIDX_AV].cl = cl2;

		ifq-&gt;ifcq_disc_slots[SCIDX_RV].qid = SCIDX_VI;
		ifq-&gt;ifcq_disc_slots[SCIDX_RV].cl = cl2;

		ifq-&gt;ifcq_disc_slots[SCIDX_VI].qid = SCIDX_VI;
		ifq-&gt;ifcq_disc_slots[SCIDX_VI].cl = cl2;

		<span class="enscript-comment">/* Map {VO,CTL} to TC_VO */</span>
		ifq-&gt;ifcq_disc_slots[SCIDX_VO].qid = SCIDX_VO;
		ifq-&gt;ifcq_disc_slots[SCIDX_VO].cl = cl3;

		ifq-&gt;ifcq_disc_slots[SCIDX_CTL].qid = SCIDX_VO;
		ifq-&gt;ifcq_disc_slots[SCIDX_CTL].cl = cl3;
	}

<span class="enscript-reference">cleanup</span>:
	<span class="enscript-keyword">if</span> (err != 0)
		(<span class="enscript-type">void</span>) tcq_destroy_locked(tif);

	<span class="enscript-keyword">return</span> (err);
}

<span class="enscript-type">int</span>
<span class="enscript-function-name">tcq_teardown_ifclassq</span>(<span class="enscript-type">struct</span> ifclassq *ifq)
{
	<span class="enscript-type">struct</span> tcq_if *tif = ifq-&gt;ifcq_disc;
	<span class="enscript-type">int</span> i;

	IFCQ_LOCK_ASSERT_HELD(ifq);
	VERIFY(tif != NULL &amp;&amp; ifq-&gt;ifcq_type == PKTSCHEDT_TCQ);

	(<span class="enscript-type">void</span>) tcq_destroy_locked(tif);

	ifq-&gt;ifcq_disc = NULL;
	<span class="enscript-keyword">for</span> (i = 0; i &lt; IFCQ_SC_MAX; i++) {
		ifq-&gt;ifcq_disc_slots[i].qid = 0;
		ifq-&gt;ifcq_disc_slots[i].cl = NULL;
	}

	<span class="enscript-keyword">return</span> (ifclassq_detach(ifq));
}

<span class="enscript-type">int</span>
<span class="enscript-function-name">tcq_getqstats_ifclassq</span>(<span class="enscript-type">struct</span> ifclassq *ifq, u_int32_t slot,
    <span class="enscript-type">struct</span> if_ifclassq_stats *ifqs)
{
	<span class="enscript-type">struct</span> tcq_if *tif = ifq-&gt;ifcq_disc;

	IFCQ_LOCK_ASSERT_HELD(ifq);
	VERIFY(ifq-&gt;ifcq_type == PKTSCHEDT_TCQ);

	<span class="enscript-keyword">if</span> (slot &gt;= IFCQ_SC_MAX)
		<span class="enscript-keyword">return</span> (EINVAL);

	<span class="enscript-keyword">return</span> (tcq_get_class_stats(tif, ifq-&gt;ifcq_disc_slots[slot].qid,
	    &amp;ifqs-&gt;ifqs_tcq_stats));
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">tcq_throttle</span>(<span class="enscript-type">struct</span> tcq_if *tif, cqrq_throttle_t *tr)
{
	<span class="enscript-type">struct</span> ifclassq *ifq = tif-&gt;tif_ifq;
	<span class="enscript-type">struct</span> tcq_class *cl;
	<span class="enscript-type">int</span> err = 0;

	IFCQ_LOCK_ASSERT_HELD(ifq);
	VERIFY(!(tif-&gt;tif_flags &amp; TCQIFF_ALTQ));

	<span class="enscript-keyword">if</span> (!tr-&gt;set) {
		tr-&gt;level = tif-&gt;tif_throttle;
		<span class="enscript-keyword">return</span> (0);
	}

	<span class="enscript-keyword">if</span> (tr-&gt;level == tif-&gt;tif_throttle)
		<span class="enscript-keyword">return</span> (EALREADY);

	<span class="enscript-comment">/* Current throttling levels only involve BK_SYS class */</span>
	cl = ifq-&gt;ifcq_disc_slots[SCIDX_BK_SYS].cl;

	<span class="enscript-keyword">switch</span> (tr-&gt;level) {
	<span class="enscript-keyword">case</span> <span class="enscript-reference">IFNET_THROTTLE_OFF</span>:
		err = tcq_resumeq(tif, cl);
		<span class="enscript-keyword">break</span>;

	<span class="enscript-keyword">case</span> <span class="enscript-reference">IFNET_THROTTLE_OPPORTUNISTIC</span>:
		err = tcq_suspendq(tif, cl);
		<span class="enscript-keyword">break</span>;

	<span class="enscript-reference">default</span>:
		VERIFY(0);
		<span class="enscript-comment">/* NOTREACHED */</span>
	}

	<span class="enscript-keyword">if</span> (err == 0 || err == ENXIO) {
		<span class="enscript-keyword">if</span> (pktsched_verbose) {
			log(LOG_DEBUG, <span class="enscript-string">&quot;%s: %s throttling %slevel set %d-&gt;%d\n&quot;</span>,
			    if_name(TCQIF_IFP(tif)), tcq_style(tif),
			    (err == 0) ? <span class="enscript-string">&quot;&quot;</span> : <span class="enscript-string">&quot;lazy &quot;</span>, tif-&gt;tif_throttle,
			    tr-&gt;level);
		}
		tif-&gt;tif_throttle = tr-&gt;level;
		<span class="enscript-keyword">if</span> (err != 0)
			err = 0;
		<span class="enscript-keyword">else</span>
			tcq_purgeq(tif, cl, 0, NULL, NULL);
	} <span class="enscript-keyword">else</span> {
		log(LOG_ERR, <span class="enscript-string">&quot;%s: %s unable to set throttling level &quot;</span>
		    <span class="enscript-string">&quot;%d-&gt;%d [error=%d]\n&quot;</span>, if_name(TCQIF_IFP(tif)),
		    tcq_style(tif), tif-&gt;tif_throttle, tr-&gt;level, err);
	}

	<span class="enscript-keyword">return</span> (err);
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">tcq_resumeq</span>(<span class="enscript-type">struct</span> tcq_if *tif, <span class="enscript-type">struct</span> tcq_class *cl)
{
	<span class="enscript-type">struct</span> ifclassq *ifq = tif-&gt;tif_ifq;
	<span class="enscript-type">int</span> err = 0;

	IFCQ_LOCK_ASSERT_HELD(ifq);

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_RIO</span>
	<span class="enscript-keyword">if</span> (q_is_rio(&amp;cl-&gt;cl_q))
		err = rio_suspendq(cl-&gt;cl_rio, &amp;cl-&gt;cl_q, FALSE);
	<span class="enscript-keyword">else</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_RIO */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_RED</span>
	<span class="enscript-keyword">if</span> (q_is_red(&amp;cl-&gt;cl_q))
		err = red_suspendq(cl-&gt;cl_red, &amp;cl-&gt;cl_q, FALSE);
	<span class="enscript-keyword">else</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_RED */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_BLUE</span>
	<span class="enscript-keyword">if</span> (q_is_blue(&amp;cl-&gt;cl_q))
		err = blue_suspendq(cl-&gt;cl_blue, &amp;cl-&gt;cl_q, FALSE);
	<span class="enscript-keyword">else</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_BLUE */</span>
	<span class="enscript-keyword">if</span> (q_is_sfb(&amp;cl-&gt;cl_q) &amp;&amp; cl-&gt;cl_sfb != NULL)
		err = sfb_suspendq(cl-&gt;cl_sfb, &amp;cl-&gt;cl_q, FALSE);

	<span class="enscript-keyword">if</span> (err == 0)
		qstate(&amp;cl-&gt;cl_q) = QS_RUNNING;

	<span class="enscript-keyword">return</span> (err);
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">tcq_suspendq</span>(<span class="enscript-type">struct</span> tcq_if *tif, <span class="enscript-type">struct</span> tcq_class *cl)
{
	<span class="enscript-type">struct</span> ifclassq *ifq = tif-&gt;tif_ifq;
	<span class="enscript-type">int</span> err = 0;

	IFCQ_LOCK_ASSERT_HELD(ifq);

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_RIO</span>
	<span class="enscript-keyword">if</span> (q_is_rio(&amp;cl-&gt;cl_q))
		err = rio_suspendq(cl-&gt;cl_rio, &amp;cl-&gt;cl_q, TRUE);
	<span class="enscript-keyword">else</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_RIO */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_RED</span>
	<span class="enscript-keyword">if</span> (q_is_red(&amp;cl-&gt;cl_q))
		err = red_suspendq(cl-&gt;cl_red, &amp;cl-&gt;cl_q, TRUE);
	<span class="enscript-keyword">else</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_RED */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CLASSQ_BLUE</span>
	<span class="enscript-keyword">if</span> (q_is_blue(&amp;cl-&gt;cl_q))
		err = blue_suspendq(cl-&gt;cl_blue, &amp;cl-&gt;cl_q, TRUE);
	<span class="enscript-keyword">else</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CLASSQ_BLUE */</span>
	<span class="enscript-keyword">if</span> (q_is_sfb(&amp;cl-&gt;cl_q)) {
		<span class="enscript-keyword">if</span> (cl-&gt;cl_sfb != NULL) {
			err = sfb_suspendq(cl-&gt;cl_sfb, &amp;cl-&gt;cl_q, TRUE);
		} <span class="enscript-keyword">else</span> {
			VERIFY(cl-&gt;cl_flags &amp; TQCF_LAZY);
			err = ENXIO;	<span class="enscript-comment">/* delayed throttling */</span>
		}
	}

	<span class="enscript-keyword">if</span> (err == 0 || err == ENXIO)
		qstate(&amp;cl-&gt;cl_q) = QS_SUSPENDED;

	<span class="enscript-keyword">return</span> (err);
}
</pre>
<hr />
</body></html>