<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>if_pflog.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">if_pflog.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2007-2013 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 *
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 *
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 *
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

<span class="enscript-comment">/*	$apfw: if_pflog.c,v 1.4 2008/08/27 00:01:32 jhw Exp $		*/</span>
<span class="enscript-comment">/*	$OpenBSD: if_pflog.c,v 1.22 2006/12/15 09:31:20 otto Exp $	*/</span>
<span class="enscript-comment">/*
 * The authors of this code are John Ioannidis (<a href="mailto:ji@tla.org">ji@tla.org</a>),
 * Angelos D. Keromytis (<a href="mailto:kermit@csd.uch.gr">kermit@csd.uch.gr</a>) and 
 * Niels Provos (<a href="mailto:provos@physnet.uni-hamburg.de">provos@physnet.uni-hamburg.de</a>).
 *
 * This code was written by John Ioannidis for BSD/OS in Athens, Greece, 
 * in November 1995.
 *
 * Ported to OpenBSD and NetBSD, with additional transforms, in December 1996,
 * by Angelos D. Keromytis.
 *
 * Additional transforms and features in 1997 and 1998 by Angelos D. Keromytis
 * and Niels Provos.
 *
 * Copyright (C) 1995, 1996, 1997, 1998 by John Ioannidis, Angelos D. Keromytis
 * and Niels Provos.
 * Copyright (c) 2001, Angelos D. Keromytis, Niels Provos.
 *
 * Permission to use, copy, and modify this software with or without fee
 * is hereby granted, provided that this entire notice is included in
 * all copies of any software which is or includes a copy or
 * modification of this software. 
 * You may use this code under the GNU public license if you so wish. Please
 * contribute changes back to the authors under this freer than GPL license
 * so that we may further the use of strong encryption without limitations to
 * all.
 *
 * THIS SOFTWARE IS BEING PROVIDED &quot;AS IS&quot;, WITHOUT ANY EXPRESS OR
 * IMPLIED WARRANTY. IN PARTICULAR, NONE OF THE AUTHORS MAKES ANY
 * REPRESENTATION OR WARRANTY OF ANY KIND CONCERNING THE
 * MERCHANTABILITY OF THIS SOFTWARE OR ITS FITNESS FOR ANY PARTICULAR
 * PURPOSE.
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/param.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/systm.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/mbuf.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/proc_internal.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/socket.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/ioctl.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/mcache.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/if.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/if_var.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/if_types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/route.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/bpf.h&gt;</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/in.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/in_var.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/in_systm.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/ip.h&gt;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET6</span>
#<span class="enscript-reference">if</span> !<span class="enscript-variable-name">INET</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/in.h&gt;</span>
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet6/nd6.h&gt;</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* INET6 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/pfvar.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/if_pflog.h&gt;</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PFLOGNAME</span>	<span class="enscript-string">&quot;pflog&quot;</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFLOGMTU</span>	(32768 + MHLEN + MLEN)

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">PFLOGDEBUG</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">DPRINTF</span>(x)    do { if (pflogdebug) printf x ; } while (0)
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">DPRINTF</span>(x)
#<span class="enscript-reference">endif</span>

<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">pflog_clone_create</span>(<span class="enscript-type">struct</span> if_clone *, u_int32_t, <span class="enscript-type">void</span> *);
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">pflog_clone_destroy</span>(<span class="enscript-type">struct</span> ifnet *);
<span class="enscript-type">static</span> errno_t <span class="enscript-function-name">pflogoutput</span>(<span class="enscript-type">struct</span> ifnet *, <span class="enscript-type">struct</span> mbuf *);
<span class="enscript-type">static</span> errno_t <span class="enscript-function-name">pflogioctl</span>(<span class="enscript-type">struct</span> ifnet *, <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span>, <span class="enscript-type">void</span> *);
<span class="enscript-type">static</span> errno_t <span class="enscript-function-name">pflogdemux</span>(<span class="enscript-type">struct</span> ifnet *, <span class="enscript-type">struct</span> mbuf *, <span class="enscript-type">char</span> *,
    protocol_family_t *);
<span class="enscript-type">static</span> errno_t <span class="enscript-function-name">pflogaddproto</span>(<span class="enscript-type">struct</span> ifnet *, protocol_family_t,
    <span class="enscript-type">const</span> <span class="enscript-type">struct</span> ifnet_demux_desc *, u_int32_t);
<span class="enscript-type">static</span> errno_t <span class="enscript-function-name">pflogdelproto</span>(<span class="enscript-type">struct</span> ifnet *, protocol_family_t);
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">pflogfree</span>(<span class="enscript-type">struct</span> ifnet *);

<span class="enscript-type">static</span> <span class="enscript-function-name">LIST_HEAD</span>(, pflog_softc)	pflogif_list;
<span class="enscript-type">static</span> <span class="enscript-type">struct</span> if_clone pflog_cloner =
    IF_CLONE_INITIALIZER(PFLOGNAME, pflog_clone_create, pflog_clone_destroy,
        0, (PFLOGIFS_MAX - 1));

<span class="enscript-type">struct</span> ifnet *pflogifs[PFLOGIFS_MAX];	<span class="enscript-comment">/* for fast access */</span>

<span class="enscript-type">void</span>
<span class="enscript-function-name">pfloginit</span>(<span class="enscript-type">void</span>)
{
	<span class="enscript-type">int</span> i;

	LIST_INIT(&amp;pflogif_list);
	<span class="enscript-keyword">for</span> (i = 0; i &lt; PFLOGIFS_MAX; i++)
		pflogifs[i] = NULL;

	(<span class="enscript-type">void</span>) if_clone_attach(&amp;pflog_cloner);
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">pflog_clone_create</span>(<span class="enscript-type">struct</span> if_clone *ifc, u_int32_t unit, __unused <span class="enscript-type">void</span> *params)
{
	<span class="enscript-type">struct</span> pflog_softc *pflogif;
	<span class="enscript-type">struct</span> ifnet_init_params pf_init;
	<span class="enscript-type">int</span> error = 0;

	<span class="enscript-keyword">if</span> (unit &gt;= PFLOGIFS_MAX) {
		<span class="enscript-comment">/* Either the interface cloner or our initializer is broken */</span>
		panic(<span class="enscript-string">&quot;%s: unit (%d) exceeds max (%d)&quot;</span>, __func__, unit,
		    PFLOGIFS_MAX);
		<span class="enscript-comment">/* NOTREACHED */</span>
	}

	<span class="enscript-keyword">if</span> ((pflogif = _MALLOC(<span class="enscript-keyword">sizeof</span> (*pflogif),
	    M_DEVBUF, M_WAITOK|M_ZERO)) == NULL) {
		error = ENOMEM;
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">done</span>;
	}

	bzero(&amp;pf_init, <span class="enscript-keyword">sizeof</span> (pf_init));
	pf_init.name = ifc-&gt;ifc_name;
	pf_init.unit = unit;
	pf_init.type = IFT_PFLOG;
	pf_init.family = IFNET_FAMILY_LOOPBACK;
	pf_init.output = pflogoutput;
	pf_init.demux = pflogdemux;
	pf_init.add_proto = pflogaddproto;
	pf_init.del_proto = pflogdelproto;
	pf_init.softc = pflogif;
	pf_init.ioctl = pflogioctl;
	pf_init.detach = pflogfree;

	bzero(pflogif, <span class="enscript-keyword">sizeof</span> (*pflogif));
	pflogif-&gt;sc_unit = unit;

	error = ifnet_allocate(&amp;pf_init, &amp;pflogif-&gt;sc_if);
	<span class="enscript-keyword">if</span> (error != 0) {
		printf(<span class="enscript-string">&quot;%s: ifnet_allocate failed - %d\n&quot;</span>, __func__, error);
		_FREE(pflogif, M_DEVBUF);
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">done</span>;
	}

	ifnet_set_mtu(pflogif-&gt;sc_if, PFLOGMTU);
	ifnet_set_flags(pflogif-&gt;sc_if, IFF_UP, IFF_UP);

	error = ifnet_attach(pflogif-&gt;sc_if, NULL);
	<span class="enscript-keyword">if</span> (error != 0) {
		printf(<span class="enscript-string">&quot;%s: ifnet_attach failed - %d\n&quot;</span>, __func__, error);
		ifnet_release(pflogif-&gt;sc_if);
		_FREE(pflogif, M_DEVBUF);
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">done</span>;
	}

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">NBPFILTER</span> &gt; 0
	bpfattach(pflogif-&gt;sc_if, DLT_PFLOG, PFLOG_HDRLEN);
#<span class="enscript-reference">endif</span>

	lck_rw_lock_shared(pf_perim_lock);
	lck_mtx_lock(pf_lock);
	LIST_INSERT_HEAD(&amp;pflogif_list, pflogif, sc_list);
	pflogifs[unit] = pflogif-&gt;sc_if;
	lck_mtx_unlock(pf_lock);
	lck_rw_done(pf_perim_lock);

<span class="enscript-reference">done</span>:
	<span class="enscript-keyword">return</span> (error);
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">pflog_clone_destroy</span>(<span class="enscript-type">struct</span> ifnet *ifp)
{
	<span class="enscript-type">struct</span> pflog_softc *pflogif = ifp-&gt;if_softc;

	lck_rw_lock_shared(pf_perim_lock);
	lck_mtx_lock(pf_lock);
	pflogifs[pflogif-&gt;sc_unit] = NULL;
	LIST_REMOVE(pflogif, sc_list);
	lck_mtx_unlock(pf_lock);
	lck_rw_done(pf_perim_lock);

	<span class="enscript-comment">/* bpfdetach() is taken care of as part of interface detach */</span>
	(<span class="enscript-type">void</span>) ifnet_detach(ifp);

	<span class="enscript-keyword">return</span> 0;
}

<span class="enscript-type">static</span> errno_t
<span class="enscript-function-name">pflogoutput</span>(<span class="enscript-type">struct</span> ifnet *ifp, <span class="enscript-type">struct</span> mbuf *m)
{
	printf(<span class="enscript-string">&quot;%s: freeing data for %s\n&quot;</span>, __func__, if_name(ifp));
	m_freem(m);
	<span class="enscript-keyword">return</span> (ENOTSUP);
}

<span class="enscript-type">static</span> errno_t
<span class="enscript-function-name">pflogioctl</span>(<span class="enscript-type">struct</span> ifnet *ifp, <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> cmd, <span class="enscript-type">void</span> *data)
{
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">unused</span>(<span class="enscript-variable-name">data</span>)
	<span class="enscript-keyword">switch</span> (cmd) {
	<span class="enscript-keyword">case</span> <span class="enscript-reference">SIOCSIFADDR</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-reference">SIOCAIFADDR</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-reference">SIOCSIFDSTADDR</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-reference">SIOCSIFFLAGS</span>:
		<span class="enscript-keyword">if</span> (ifnet_flags(ifp) &amp; IFF_UP)
			ifnet_set_flags(ifp, IFF_RUNNING, IFF_RUNNING);
		<span class="enscript-keyword">else</span>
			ifnet_set_flags(ifp, 0, IFF_RUNNING);
		<span class="enscript-keyword">break</span>;
	<span class="enscript-reference">default</span>:
		<span class="enscript-keyword">return</span> (ENOTTY);
	}

	<span class="enscript-keyword">return</span> (0);
}

<span class="enscript-type">static</span> errno_t
<span class="enscript-function-name">pflogdemux</span>(<span class="enscript-type">struct</span> ifnet *ifp, <span class="enscript-type">struct</span> mbuf *m, <span class="enscript-type">char</span> *h, protocol_family_t *ppf)
{
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">unused</span>(<span class="enscript-variable-name">h</span>, <span class="enscript-variable-name">ppf</span>)
	printf(<span class="enscript-string">&quot;%s: freeing data for %s\n&quot;</span>, __func__, if_name(ifp));
	m_freem(m);
	<span class="enscript-keyword">return</span> (EJUSTRETURN);
}

<span class="enscript-type">static</span> errno_t
<span class="enscript-function-name">pflogaddproto</span>(<span class="enscript-type">struct</span> ifnet *ifp, protocol_family_t pf,
    <span class="enscript-type">const</span> <span class="enscript-type">struct</span> ifnet_demux_desc *d, u_int32_t cnt)
{
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">unused</span>(<span class="enscript-variable-name">ifp</span>, <span class="enscript-variable-name">pf</span>, <span class="enscript-variable-name">d</span>, <span class="enscript-variable-name">cnt</span>)
	<span class="enscript-keyword">return</span> (0);
}

<span class="enscript-type">static</span> errno_t
<span class="enscript-function-name">pflogdelproto</span>(<span class="enscript-type">struct</span> ifnet *ifp, protocol_family_t pf)
{
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">unused</span>(<span class="enscript-variable-name">ifp</span>, <span class="enscript-variable-name">pf</span>)
	<span class="enscript-keyword">return</span> (0);
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">pflogfree</span>(<span class="enscript-type">struct</span> ifnet *ifp)
{
	_FREE(ifp-&gt;if_softc, M_DEVBUF);
	ifp-&gt;if_softc = NULL;
	(<span class="enscript-type">void</span>) ifnet_release(ifp);
}

<span class="enscript-type">int</span>
<span class="enscript-function-name">pflog_packet</span>(<span class="enscript-type">struct</span> pfi_kif *kif, <span class="enscript-type">struct</span> mbuf *m, sa_family_t af, u_int8_t dir,
    u_int8_t reason, <span class="enscript-type">struct</span> pf_rule *rm, <span class="enscript-type">struct</span> pf_rule *am,
    <span class="enscript-type">struct</span> pf_ruleset *ruleset, <span class="enscript-type">struct</span> pf_pdesc *pd)
{
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">NBPFILTER</span> &gt; 0
	<span class="enscript-type">struct</span> ifnet *ifn;
	<span class="enscript-type">struct</span> pfloghdr hdr;

	lck_mtx_assert(pf_lock, LCK_MTX_ASSERT_OWNED);

	<span class="enscript-keyword">if</span> (kif == NULL || m == NULL || rm == NULL || pd == NULL)
		<span class="enscript-keyword">return</span> (-1);

	<span class="enscript-keyword">if</span> (rm-&gt;logif &gt;= PFLOGIFS_MAX ||
	    (ifn = pflogifs[rm-&gt;logif]) == NULL || !ifn-&gt;if_bpf) {
		<span class="enscript-keyword">return</span> (0);
	}

	bzero(&amp;hdr, <span class="enscript-keyword">sizeof</span> (hdr));
	hdr.length = PFLOG_REAL_HDRLEN;
	hdr.af = af;
	hdr.action = rm-&gt;action;
	hdr.reason = reason;
	memcpy(hdr.ifname, kif-&gt;pfik_name, <span class="enscript-keyword">sizeof</span> (hdr.ifname));

	<span class="enscript-keyword">if</span> (am == NULL) {
		hdr.rulenr = htonl(rm-&gt;nr);
		hdr.subrulenr = -1;
	} <span class="enscript-keyword">else</span> {
		hdr.rulenr = htonl(am-&gt;nr);
		hdr.subrulenr = htonl(rm-&gt;nr);
		<span class="enscript-keyword">if</span> (ruleset != NULL &amp;&amp; ruleset-&gt;anchor != NULL)
			strlcpy(hdr.ruleset, ruleset-&gt;anchor-&gt;name,
			    <span class="enscript-keyword">sizeof</span> (hdr.ruleset));
	}
	<span class="enscript-keyword">if</span> (rm-&gt;log &amp; PF_LOG_SOCKET_LOOKUP &amp;&amp; !pd-&gt;lookup.done)
		pd-&gt;lookup.done = pf_socket_lookup(dir, pd);
	<span class="enscript-keyword">if</span> (pd-&gt;lookup.done &gt; 0) {
		hdr.uid = pd-&gt;lookup.uid;
		hdr.pid = pd-&gt;lookup.pid;
	} <span class="enscript-keyword">else</span> {
		hdr.uid = UID_MAX;
		hdr.pid = NO_PID;
	}
	hdr.rule_uid = rm-&gt;cuid;
	hdr.rule_pid = rm-&gt;cpid;
	hdr.dir = dir;

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET</span>
	<span class="enscript-keyword">if</span> (af == AF_INET &amp;&amp; dir == PF_OUT) {
		<span class="enscript-type">struct</span> ip *ip;

		ip = mtod(m, <span class="enscript-type">struct</span> ip *);
		ip-&gt;ip_sum = 0;
		ip-&gt;ip_sum = in_cksum(m, ip-&gt;ip_hl &lt;&lt; 2);
	}
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* INET */</span>

	atomic_add_64(&amp;ifn-&gt;if_opackets, 1);
	atomic_add_64(&amp;ifn-&gt;if_obytes, m-&gt;m_pkthdr.len);

	<span class="enscript-keyword">switch</span> (dir) {
	<span class="enscript-keyword">case</span> <span class="enscript-reference">PF_IN</span>:
		bpf_tap_in(ifn, DLT_PFLOG, m, &amp;hdr, PFLOG_HDRLEN);
		<span class="enscript-keyword">break</span>;

	<span class="enscript-keyword">case</span> <span class="enscript-reference">PF_OUT</span>:
		bpf_tap_out(ifn, DLT_PFLOG, m, &amp;hdr, PFLOG_HDRLEN);
		<span class="enscript-keyword">break</span>;

	<span class="enscript-reference">default</span>:
		<span class="enscript-keyword">break</span>;
	}
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* NBPFILTER &gt; 0 */</span>
	<span class="enscript-keyword">return</span> (0);
}
</pre>
<hr />
</body></html>