<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>necp.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">necp.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2013, 2014 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 *
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 *
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 *
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">ifndef</span>	<span class="enscript-variable-name">_NET_NECP_H_</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">_NET_NECP_H_</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/in.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/socket.h&gt;</span>

<span class="enscript-comment">/*
 * Name registered by the ipsec kernel control
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_CONTROL_NAME</span> <span class="enscript-string">&quot;com.apple.net.necp_control&quot;</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">NECP_TLV_LENGTH_UINT32</span>	1

<span class="enscript-type">struct</span> necp_packet_header {
    u_int8_t		packet_type;
	u_int8_t		flags;
    u_int32_t		message_id;
};
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_PACKET_TYPE_POLICY_ADD</span>				1
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_PACKET_TYPE_POLICY_GET</span>				2
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_PACKET_TYPE_POLICY_DELETE</span>			3
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_PACKET_TYPE_POLICY_APPLY_ALL</span>		4
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_PACKET_TYPE_POLICY_LIST_ALL</span>		5
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_PACKET_TYPE_POLICY_DELETE_ALL</span>		6
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_PACKET_TYPE_SET_SESSION_PRIORITY</span>	7
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_PACKET_TYPE_LOCK_SESSION_TO_PROC</span>	8
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_PACKET_TYPE_REGISTER_SERVICE</span>		9
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_PACKET_TYPE_UNREGISTER_SERVICE</span>		10

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_PACKET_FLAGS_RESPONSE</span>				0x01	// Used for acks, errors, and query responses

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_TLV_NIL</span>							0
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_TLV_ERROR</span>							1	// u_int32_t
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_TLV_POLICY_ORDER</span>					2	// u_int32_t
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_TLV_POLICY_CONDITION</span>				3
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_TLV_POLICY_RESULT</span>					4
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_TLV_POLICY_ID</span>						5	// u_int32_t
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_TLV_SESSION_PRIORITY</span>				6	// u_int32_t
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_TLV_ATTRIBUTE_DOMAIN</span>				7	// char[]
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_TLV_ATTRIBUTE_ACCOUNT</span>				8	// char[]
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_TLV_SERVICE_UUID</span>					9	// uuid_t
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_TLV_ROUTE_RULE</span>						10

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_CONDITION_FLAGS_NEGATIVE</span>	0x01 // Negative

<span class="enscript-comment">// Conditions
</span>#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_CONDITION_DEFAULT</span>			0	// N/A, not valid with any other conditions
<span class="enscript-comment">// Socket/Application conditions
</span>#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_CONDITION_APPLICATION</span>		1	// uuid_t, uses effective UUID when possible
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_CONDITION_REAL_APPLICATION</span>	2	// uuid_t, never uses effective UUID. Only valid with NECP_POLICY_CONDITION_APPLICATION
<span class="enscript-comment">// Application-only Conditions
</span>#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_CONDITION_DOMAIN</span>			3	// String, such as apple.com
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_CONDITION_ACCOUNT</span>			4	// String
<span class="enscript-comment">// Socket/Application condition
</span>#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_CONDITION_ENTITLEMENT</span>		5	// String
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_CONDITION_PID</span>				6	// pid_t
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_CONDITION_UID</span>				7	// uid_t
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_CONDITION_ALL_INTERFACES</span>	8	// N/A
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_CONDITION_BOUND_INTERFACE</span>	9	// String
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_CONDITION_TRAFFIC_CLASS</span>		10	// necp_policy_condition_tc_range
<span class="enscript-comment">// Socket/IP conditions
</span>#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_CONDITION_IP_PROTOCOL</span>		11	// u_int8_t
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_CONDITION_LOCAL_ADDR</span>		12	// necp_policy_condition_addr
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_CONDITION_REMOTE_ADDR</span>		13	// necp_policy_condition_addr
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_CONDITION_LOCAL_ADDR_RANGE</span>	14	// necp_policy_condition_addr_range
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_CONDITION_REMOTE_ADDR_RANGE</span>	15	// necp_policy_condition_addr_range

<span class="enscript-comment">// Results
</span>#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_RESULT_PASS</span>					1	// N/A
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_RESULT_SKIP</span>					2	// u_int32_t, policy order to skip to. 0 to skip all session policies.
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_RESULT_DROP</span>					3	// N/A
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_RESULT_SOCKET_DIVERT</span>		4	// u_int32_t, flow divert control unit
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_RESULT_SOCKET_FILTER</span>		5	// u_int32_t, filter control unit
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_RESULT_IP_TUNNEL</span>			6	// String, interface name
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_RESULT_IP_FILTER</span>			7	// ?
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_RESULT_TRIGGER</span>				8	// service uuid_t
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_RESULT_TRIGGER_IF_NEEDED</span>	9	// service uuid_t
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_RESULT_TRIGGER_SCOPED</span>		10	// service uuid_t
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_RESULT_NO_TRIGGER_SCOPED</span>	11	// service uuid_t
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_RESULT_SOCKET_SCOPED</span>		12	// String, interface name
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_RESULT_ROUTE_RULES</span>			13	// N/A, must have route rules defined
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_RESULT_USE_NETAGENT</span>			14	// netagent uuid_t

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_POLICY_RESULT_MAX</span>					NECP_POLICY_RESULT_USE_NETAGENT

<span class="enscript-comment">// Route rule
</span>#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_ROUTE_RULE_NONE</span>					0	// N/A
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_ROUTE_RULE_DENY_INTERFACE</span>			1	// String, or empty to match all
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_ROUTE_RULE_ALLOW_INTERFACE</span>			2	// String, or empty to match all

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_ROUTE_RULE_FLAG_CELLULAR</span>			0x01
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_ROUTE_RULE_FLAG_WIFI</span>				0x02
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_ROUTE_RULE_FLAG_WIRED</span>				0x04
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_ROUTE_RULE_FLAG_EXPENSIVE</span>			0x08

<span class="enscript-comment">// Errors
</span>#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_ERROR_INTERNAL</span>						0
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_ERROR_UNKNOWN_PACKET_TYPE</span>			1
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_ERROR_INVALID_TLV</span>					2
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_ERROR_POLICY_RESULT_INVALID</span>		3
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_ERROR_POLICY_CONDITIONS_INVALID</span>	4
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_ERROR_POLICY_ID_NOT_FOUND</span>			5
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_ERROR_INVALID_PROCESS</span>				6
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_ERROR_ROUTE_RULES_INVALID</span>			7

<span class="enscript-comment">// Modifiers
</span>#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_MASK_USERSPACE_ONLY</span>	0x80000000	// on filter_control_unit value

<span class="enscript-type">struct</span> necp_policy_condition_tc_range {
	u_int32_t start_tc;
	u_int32_t end_tc;
} __attribute__((__packed__));

<span class="enscript-type">struct</span> necp_policy_condition_addr {
	u_int8_t		prefix;
	<span class="enscript-type">union</span> {
		<span class="enscript-type">struct</span> sockaddr			sa;
		<span class="enscript-type">struct</span> sockaddr_in		sin;
		<span class="enscript-type">struct</span> sockaddr_in6		sin6;
	} address;
} __attribute__((__packed__));

<span class="enscript-type">struct</span> necp_policy_condition_addr_range {
	<span class="enscript-type">union</span> {
		<span class="enscript-type">struct</span> sockaddr			sa;
		<span class="enscript-type">struct</span> sockaddr_in		sin;
		<span class="enscript-type">struct</span> sockaddr_in6		sin6;
	} start_address;
	<span class="enscript-type">union</span> {
		<span class="enscript-type">struct</span> sockaddr			sa;
		<span class="enscript-type">struct</span> sockaddr_in		sin;
		<span class="enscript-type">struct</span> sockaddr_in6		sin6;
	} end_address;
} __attribute__((__packed__));

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_SESSION_PRIORITY_UNKNOWN</span>			0
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_SESSION_PRIORITY_CONTROL</span>			1
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_SESSION_PRIORITY_PRIVILEGED_TUNNEL</span>	2
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_SESSION_PRIORITY_HIGH</span>				3
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_SESSION_PRIORITY_DEFAULT</span>			4
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_SESSION_PRIORITY_LOW</span>				5

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_SESSION_NUM_PRIORITIES</span>				NECP_SESSION_PRIORITY_LOW

<span class="enscript-type">typedef</span> u_int32_t necp_policy_id;
<span class="enscript-type">typedef</span> u_int32_t necp_policy_order;

<span class="enscript-type">typedef</span> u_int32_t necp_kernel_policy_result;
<span class="enscript-type">typedef</span> u_int32_t necp_kernel_policy_filter;

<span class="enscript-type">typedef</span> <span class="enscript-type">union</span> {
	u_int						tunnel_interface_index;
	u_int						scoped_interface_index;
	u_int32_t					flow_divert_control_unit;
	u_int32_t					filter_control_unit;
} necp_kernel_policy_routing_result_parameter;

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_SERVICE_FLAGS_REGISTERED</span>			0x01
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_MAX_NETAGENTS</span>						8
<span class="enscript-type">struct</span> necp_aggregate_result {
	necp_kernel_policy_result			routing_result;
	necp_kernel_policy_routing_result_parameter	routing_result_parameter;
	necp_kernel_policy_filter			filter_control_unit;
	necp_kernel_policy_result			service_action;
	uuid_t								service_uuid;
	u_int32_t							service_flags;
	u_int32_t							service_data;
	u_int								routed_interface_index;
	u_int32_t							policy_id;
	uuid_t								netagents[NECP_MAX_NETAGENTS];
	u_int32_t							netagent_flags[NECP_MAX_NETAGENTS];
};

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KEV_NECP_SUBCLASS</span> 8
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KEV_NECP_POLICIES_CHANGED</span> 1

<span class="enscript-type">struct</span> kev_necp_policies_changed_data {
	u_int32_t		changed_count;	<span class="enscript-comment">// Defaults to 0.
</span>};

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">BSD_KERNEL_PRIVATE</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdbool.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/socketvar.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/kern_control.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/ip_var.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet6/ip6_var.h&gt;</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECPCTL_DROP_ALL_LEVEL</span>				1	<span class="enscript-comment">/* Drop all packets if no policy matches above this level */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECPCTL_DEBUG</span>						2	<span class="enscript-comment">/* Log all kernel policy matches */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECPCTL_PASS_LOOPBACK</span>				3	<span class="enscript-comment">/* Pass all loopback traffic */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECPCTL_PASS_KEEPALIVES</span>				4	<span class="enscript-comment">/* Pass all kernel-generated keepalive traffic */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECPCTL_SOCKET_POLICY_COUNT</span>			5	<span class="enscript-comment">/* Count of all socket-level policies */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECPCTL_SOCKET_NON_APP_POLICY_COUNT</span>	6	<span class="enscript-comment">/* Count of non-per-app socket-level policies */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECPCTL_IP_POLICY_COUNT</span>				7	<span class="enscript-comment">/* Count of all ip-level policies */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECPCTL_SESSION_COUNT</span>				8	<span class="enscript-comment">/* Count of NECP sessions */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECPCTL_NAMES</span> {					\
	{ 0, 0 },							\
	{ <span class="enscript-string">&quot;drop_all_level&quot;</span>, CTLTYPE_INT },	\
	{ <span class="enscript-string">&quot;debug&quot;</span>, CTLTYPE_INT },			\
	{ <span class="enscript-string">&quot;pass_loopback&quot;</span>, CTLTYPE_INT },	\
	{ <span class="enscript-string">&quot;pass_keepalives&quot;</span>, CTLTYPE_INT },	\
}

<span class="enscript-type">typedef</span> u_int32_t necp_kernel_policy_id;
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_KERNEL_POLICY_ID_NONE</span>			0
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_KERNEL_POLICY_ID_NO_MATCH</span>		1
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_KERNEL_POLICY_ID_FIRST_VALID</span>	2

<span class="enscript-type">typedef</span> u_int32_t necp_app_id;

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_KERNEL_POLICY_RESULT_NONE</span>					0
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_KERNEL_POLICY_RESULT_PASS</span>					NECP_POLICY_RESULT_PASS
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_KERNEL_POLICY_RESULT_SKIP</span>					NECP_POLICY_RESULT_SKIP
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_KERNEL_POLICY_RESULT_DROP</span>					NECP_POLICY_RESULT_DROP
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_KERNEL_POLICY_RESULT_SOCKET_DIVERT</span>			NECP_POLICY_RESULT_SOCKET_DIVERT
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_KERNEL_POLICY_RESULT_SOCKET_FILTER</span>			NECP_POLICY_RESULT_SOCKET_FILTER
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_KERNEL_POLICY_RESULT_IP_TUNNEL</span>				NECP_POLICY_RESULT_IP_TUNNEL
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_KERNEL_POLICY_RESULT_IP_FILTER</span>				NECP_POLICY_RESULT_IP_FILTER
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_KERNEL_POLICY_RESULT_TRIGGER</span>				NECP_POLICY_RESULT_TRIGGER
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_KERNEL_POLICY_RESULT_TRIGGER_IF_NEEDED</span>		NECP_POLICY_RESULT_TRIGGER_IF_NEEDED
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_KERNEL_POLICY_RESULT_TRIGGER_SCOPED</span>		NECP_POLICY_RESULT_TRIGGER_SCOPED
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_KERNEL_POLICY_RESULT_NO_TRIGGER_SCOPED</span>		NECP_POLICY_RESULT_NO_TRIGGER_SCOPED
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_KERNEL_POLICY_RESULT_SOCKET_SCOPED</span>			NECP_POLICY_RESULT_SOCKET_SCOPED
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_KERNEL_POLICY_RESULT_ROUTE_RULES</span>			NECP_POLICY_RESULT_ROUTE_RULES
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NECP_KERNEL_POLICY_RESULT_USE_NETAGENT</span>			NECP_POLICY_RESULT_USE_NETAGENT

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
	u_int32_t identifier;
	u_int32_t data;
} necp_kernel_policy_service;

<span class="enscript-type">typedef</span> <span class="enscript-type">union</span> {
	u_int						tunnel_interface_index;
	u_int						scoped_interface_index;
	u_int32_t					flow_divert_control_unit;
	u_int32_t					filter_control_unit;
	u_int32_t					skip_policy_order;
	u_int32_t					route_rule_id;
	u_int32_t					netagent_id;
	necp_kernel_policy_service	service;
} necp_kernel_policy_result_parameter;

<span class="enscript-type">union</span> necp_sockaddr_union {
	<span class="enscript-type">struct</span> sockaddr			sa;
	<span class="enscript-type">struct</span> sockaddr_in		sin;
	<span class="enscript-type">struct</span> sockaddr_in6		sin6;
};

<span class="enscript-type">struct</span> necp_kernel_socket_policy {
	LIST_ENTRY(necp_kernel_socket_policy)	chain;
	necp_policy_id				parent_policy_id;
	necp_kernel_policy_id		id;
	necp_policy_order			order;
	u_int32_t					session_order;
	<span class="enscript-type">int</span>							session_pid;

	u_int32_t					condition_mask;
	u_int32_t					condition_negated_mask;
	necp_kernel_policy_id		cond_policy_id;
	u_int32_t					cond_app_id;					<span class="enscript-comment">// Locally assigned ID value stored
</span>	u_int32_t					cond_real_app_id;				<span class="enscript-comment">// Locally assigned ID value stored
</span>	u_int32_t					cond_account_id;				<span class="enscript-comment">// Locally assigned ID value stored
</span>	<span class="enscript-type">char</span>						*cond_domain;					<span class="enscript-comment">// String
</span>	u_int8_t					cond_domain_dot_count;			<span class="enscript-comment">// Number of dots in cond_domain
</span>	pid_t						cond_pid;
	uid_t						cond_uid;
	ifnet_t						cond_bound_interface;			<span class="enscript-comment">// Matches specific binding only
</span>	<span class="enscript-type">struct</span> necp_policy_condition_tc_range cond_traffic_class;	<span class="enscript-comment">// Matches traffic class in range
</span>	u_int16_t					cond_protocol;					<span class="enscript-comment">// Matches IP protcol number
</span>	<span class="enscript-type">union</span> necp_sockaddr_union	cond_local_start;				<span class="enscript-comment">// Matches local IP address (or start)
</span>	<span class="enscript-type">union</span> necp_sockaddr_union	cond_local_end;					<span class="enscript-comment">// Matches IP address range
</span>	u_int8_t					cond_local_prefix;				<span class="enscript-comment">// Defines subnet
</span>	<span class="enscript-type">union</span> necp_sockaddr_union	cond_remote_start;				<span class="enscript-comment">// Matches remote IP address (or start)
</span>	<span class="enscript-type">union</span> necp_sockaddr_union	cond_remote_end;				<span class="enscript-comment">// Matches IP address range
</span>	u_int8_t					cond_remote_prefix;				<span class="enscript-comment">// Defines subnet
</span>
	necp_kernel_policy_result	result;
	necp_kernel_policy_result_parameter	result_parameter;
};

<span class="enscript-type">struct</span> necp_kernel_ip_output_policy {
	LIST_ENTRY(necp_kernel_ip_output_policy)	chain;
	necp_policy_id				parent_policy_id;
	necp_kernel_policy_id		id;
	necp_policy_order			suborder;
	necp_policy_order			order;
	u_int32_t					session_order;
	<span class="enscript-type">int</span>							session_pid;

	u_int32_t					condition_mask;
	u_int32_t					condition_negated_mask;
	necp_kernel_policy_id		cond_policy_id;
	ifnet_t						cond_bound_interface;			<span class="enscript-comment">// Matches specific binding only
</span>	u_int16_t					cond_protocol;					<span class="enscript-comment">// Matches IP protcol number
</span>	<span class="enscript-type">union</span> necp_sockaddr_union	cond_local_start;				<span class="enscript-comment">// Matches local IP address (or start)
</span>	<span class="enscript-type">union</span> necp_sockaddr_union	cond_local_end;					<span class="enscript-comment">// Matches IP address range
</span>	u_int8_t					cond_local_prefix;				<span class="enscript-comment">// Defines subnet
</span>	<span class="enscript-type">union</span> necp_sockaddr_union	cond_remote_start;				<span class="enscript-comment">// Matches remote IP address (or start)
</span>	<span class="enscript-type">union</span> necp_sockaddr_union	cond_remote_end;				<span class="enscript-comment">// Matches IP address range
</span>	u_int8_t					cond_remote_prefix;				<span class="enscript-comment">// Defines subnet
</span>	u_int32_t					cond_last_interface_index;

	necp_kernel_policy_result	result;
	necp_kernel_policy_result_parameter	result_parameter;
};

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MAX_KERNEL_SOCKET_POLICIES</span>			1
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MAX_KERNEL_IP_OUTPUT_POLICIES</span>		4
<span class="enscript-type">struct</span> necp_session_policy {
	LIST_ENTRY(necp_session_policy) chain;
	bool				applied;			<span class="enscript-comment">// Applied into the kernel table
</span>	bool				pending_deletion;	<span class="enscript-comment">// Waiting to be removed from kernel table
</span>	bool				pending_update;		<span class="enscript-comment">// Policy has been modified since creation/last application
</span>	necp_policy_id		id;
	necp_policy_order	order;
	u_int8_t			*result;
	u_int32_t			result_size;
	u_int8_t			*conditions; <span class="enscript-comment">// Array of conditions, each with a u_int32_t length at start
</span>	u_int32_t			conditions_size;
	u_int8_t			*route_rules; <span class="enscript-comment">// Array of route rules, each with a u_int32_t length at start
</span>	u_int32_t			route_rules_size;

	uuid_t				applied_app_uuid;
	uuid_t				applied_real_app_uuid;
	<span class="enscript-type">char</span>				*applied_domain;
	<span class="enscript-type">char</span>				*applied_account;

	uuid_t				applied_result_uuid;

	u_int32_t			applied_route_rules_id;

	necp_kernel_policy_id	kernel_socket_policies[MAX_KERNEL_SOCKET_POLICIES];
	necp_kernel_policy_id	kernel_ip_output_policies[MAX_KERNEL_IP_OUTPUT_POLICIES];
};

<span class="enscript-type">struct</span> necp_aggregate_socket_result {
	necp_kernel_policy_result			result;
	necp_kernel_policy_result_parameter	result_parameter;
	necp_kernel_policy_filter			filter_control_unit;
	u_int32_t							route_rule_id;
};

<span class="enscript-type">struct</span> necp_inpcb_result {
	<span class="enscript-type">char</span>								*application_layer_domain;
	u_int32_t							application_layer_account_id;
	necp_kernel_policy_id				policy_id;
	int32_t								policy_gencount;
	u_int32_t							flowhash;
	<span class="enscript-type">struct</span> necp_aggregate_socket_result	results;
};

errno_t <span class="enscript-function-name">necp_init</span>(<span class="enscript-type">void</span>);

errno_t <span class="enscript-function-name">necp_set_socket_attributes</span>(<span class="enscript-type">struct</span> socket *so, <span class="enscript-type">struct</span> sockopt *sopt);
errno_t <span class="enscript-function-name">necp_get_socket_attributes</span>(<span class="enscript-type">struct</span> socket *so, <span class="enscript-type">struct</span> sockopt *sopt);

u_int32_t <span class="enscript-function-name">necp_socket_get_content_filter_control_unit</span>(<span class="enscript-type">struct</span> socket *so);

bool <span class="enscript-function-name">necp_socket_should_use_flow_divert</span>(<span class="enscript-type">struct</span> inpcb *inp);
u_int32_t <span class="enscript-function-name">necp_socket_get_flow_divert_control_unit</span>(<span class="enscript-type">struct</span> inpcb *inp);

bool <span class="enscript-function-name">necp_socket_should_rescope</span>(<span class="enscript-type">struct</span> inpcb *inp);
u_int <span class="enscript-function-name">necp_socket_get_rescope_if_index</span>(<span class="enscript-type">struct</span> inpcb *inp);
u_int32_t <span class="enscript-function-name">necp_socket_get_effective_mtu</span>(<span class="enscript-type">struct</span> inpcb *inp, u_int32_t current_mtu);

bool <span class="enscript-function-name">necp_socket_is_allowed_to_send_recv</span>(<span class="enscript-type">struct</span> inpcb *inp, necp_kernel_policy_id *return_policy_id, u_int32_t *return_route_rule_id);
bool <span class="enscript-function-name">necp_socket_is_allowed_to_send_recv_v4</span>(<span class="enscript-type">struct</span> inpcb *inp, u_int16_t local_port, u_int16_t remote_port, <span class="enscript-type">struct</span> in_addr *local_addr, <span class="enscript-type">struct</span> in_addr *remote_addr, ifnet_t interface, necp_kernel_policy_id *return_policy_id, u_int32_t *return_route_rule_id);
bool <span class="enscript-function-name">necp_socket_is_allowed_to_send_recv_v6</span>(<span class="enscript-type">struct</span> inpcb *inp, u_int16_t local_port, u_int16_t remote_port, <span class="enscript-type">struct</span> in6_addr *local_addr, <span class="enscript-type">struct</span> in6_addr *remote_addr, ifnet_t interface, necp_kernel_policy_id *return_policy_id, u_int32_t *return_route_rule_id);
<span class="enscript-type">int</span> <span class="enscript-function-name">necp_mark_packet_from_socket</span>(<span class="enscript-type">struct</span> mbuf *packet, <span class="enscript-type">struct</span> inpcb *inp, necp_kernel_policy_id policy_id, u_int32_t route_rule_id);
necp_kernel_policy_id <span class="enscript-function-name">necp_get_policy_id_from_packet</span>(<span class="enscript-type">struct</span> mbuf *packet);
u_int32_t <span class="enscript-function-name">necp_get_last_interface_index_from_packet</span>(<span class="enscript-type">struct</span> mbuf *packet);
u_int32_t <span class="enscript-function-name">necp_get_route_rule_id_from_packet</span>(<span class="enscript-type">struct</span> mbuf *packet);

necp_kernel_policy_id <span class="enscript-function-name">necp_socket_find_policy_match</span>(<span class="enscript-type">struct</span> inpcb *inp, <span class="enscript-type">struct</span> sockaddr *override_local_addr, <span class="enscript-type">struct</span> sockaddr *override_remote_addr, u_int32_t override_bound_interface);
necp_kernel_policy_id <span class="enscript-function-name">necp_ip_output_find_policy_match</span>(<span class="enscript-type">struct</span> mbuf *packet, <span class="enscript-type">int</span> flags, <span class="enscript-type">struct</span> ip_out_args *ipoa, necp_kernel_policy_result *result, necp_kernel_policy_result_parameter *result_parameter);
necp_kernel_policy_id <span class="enscript-function-name">necp_ip6_output_find_policy_match</span>(<span class="enscript-type">struct</span> mbuf *packet, <span class="enscript-type">int</span> flags, <span class="enscript-type">struct</span> ip6_out_args *ip6oa, necp_kernel_policy_result *result, necp_kernel_policy_result_parameter *result_parameter);

<span class="enscript-type">int</span> <span class="enscript-function-name">necp_mark_packet_from_ip</span>(<span class="enscript-type">struct</span> mbuf *packet, necp_kernel_policy_id policy_id);
<span class="enscript-type">int</span> <span class="enscript-function-name">necp_mark_packet_from_interface</span>(<span class="enscript-type">struct</span> mbuf *packet, ifnet_t interface);

ifnet_t <span class="enscript-function-name">necp_get_ifnet_from_result_parameter</span>(necp_kernel_policy_result_parameter *result_parameter);
bool <span class="enscript-function-name">necp_packet_can_rebind_to_ifnet</span>(<span class="enscript-type">struct</span> mbuf *packet, <span class="enscript-type">struct</span> ifnet *interface, <span class="enscript-type">struct</span> route *new_route, <span class="enscript-type">int</span> family);

bool <span class="enscript-function-name">necp_packet_is_allowed_over_interface</span>(<span class="enscript-type">struct</span> mbuf *packet, <span class="enscript-type">struct</span> ifnet *interface);

<span class="enscript-type">int</span> <span class="enscript-function-name">necp_mark_packet_as_keepalive</span>(<span class="enscript-type">struct</span> mbuf *packet, bool is_keepalive);
bool <span class="enscript-function-name">necp_get_is_keepalive_from_packet</span>(<span class="enscript-type">struct</span> mbuf *packet);

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* BSD_KERNEL_PRIVATE */</span>
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">KERNEL</span>
<span class="enscript-type">int</span> <span class="enscript-function-name">necp_match_policy</span>(<span class="enscript-type">const</span> uint8_t *parameters, size_t parameters_size, <span class="enscript-type">struct</span> necp_aggregate_result *returned_result);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !KERNEL */</span>

#<span class="enscript-reference">endif</span>
</pre>
<hr />
</body></html>