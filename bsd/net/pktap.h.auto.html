<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>pktap.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">pktap.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2012-2014 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 *
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 *
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 *
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_NET_PKTAP_H_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_NET_PKTAP_H_</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/_types/_timeval32.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdint.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/if.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;uuid/uuid.h&gt;</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">PRIVATE</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PKTAP_IFNAME</span> <span class="enscript-string">&quot;pktap&quot;</span>

<span class="enscript-comment">/* To store interface name + unit */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PKTAP_IFXNAMESIZE</span> (IF_NAMESIZE + 8)

<span class="enscript-comment">/*
 * Commands via SIOCGDRVSPEC/SIOCSDRVSPEC
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PKTP_CMD_FILTER_GET</span>	1	<span class="enscript-comment">/* array of PKTAP_MAX_FILTERS * struct pktap_filter */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PKTP_CMD_FILTER_SET</span>	3	<span class="enscript-comment">/* array of PKTAP_MAX_FILTERS * struct pktap_filter */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PKTP_CMD_TAP_COUNT</span>	4	<span class="enscript-comment">/* uint32_t number of active bpf tap on the interface */</span>

<span class="enscript-comment">/*
 * Filtering is currently based on network interface properties --
 * the interface type and the interface name -- and has two types of 
 * operations -- pass and skip.
 * By default only interfaces of type IFT_ETHER and IFT_CELLULAR pass
 * the filter.
 * It's possible to include other interfaces by type or by name
 * The interface type is evaluated before the interface name
 * The first matching rule stops the evaluation. 
 * A rule with interface type 0 (zero) matches any interfaces
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PKTAP_FILTER_OP_NONE</span>	0	<span class="enscript-comment">/* For inactive entries at the end of the list */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PKTAP_FILTER_OP_PASS</span>	1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PKTAP_FILTER_OP_SKIP</span>	2

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PKTAP_FILTER_PARAM_NONE</span>		0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PKTAP_FILTER_PARAM_IF_TYPE</span>	1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PKTAP_FILTER_PARAM_IF_NAME</span>	2

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">BSD_KERNEL_PRIVATE</span>
<span class="enscript-type">struct</span> pktap_filter {
	uint32_t	filter_op;
	uint32_t	filter_param;
	<span class="enscript-type">union</span> {
		uint32_t	_filter_if_type;
		<span class="enscript-type">char</span>		_filter_if_name[PKTAP_IFXNAMESIZE];
	} param_;
	size_t		filter_ifname_prefix_len;
};

<span class="enscript-type">struct</span> x_pktap_filter {
#<span class="enscript-reference">else</span>
<span class="enscript-type">struct</span> pktap_filter {
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* BSD_KERNEL_PRIVATE */</span>
	uint32_t	filter_op;
	uint32_t	filter_param;
	<span class="enscript-type">union</span> {
		uint32_t	_filter_if_type;
		<span class="enscript-type">char</span>		_filter_if_name[PKTAP_IFXNAMESIZE];
	} param_;
};
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">filter_param_if_type</span> param_._filter_if_type
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">filter_param_if_name</span> param_._filter_if_name

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PKTAP_MAX_FILTERS</span> 8

<span class="enscript-comment">/*
 * Header for DLT_PKTAP
 *
 * In theory, there could be several types of blocks in a chain before the actual packet
 */</span>
<span class="enscript-type">struct</span> pktap_header {
	uint32_t		pth_length;			<span class="enscript-comment">/* length of this header */</span>
	uint32_t		pth_type_next;			<span class="enscript-comment">/* type of data following */</span>
	uint32_t		pth_dlt;			<span class="enscript-comment">/* DLT of packet */</span>
	<span class="enscript-type">char</span>			pth_ifname[PKTAP_IFXNAMESIZE];	<span class="enscript-comment">/* interface name */</span>
	uint32_t		pth_flags;			<span class="enscript-comment">/* flags */</span>
	uint32_t		pth_protocol_family;
	uint32_t		pth_frame_pre_length;
	uint32_t		pth_frame_post_length;
	pid_t			pth_pid;			<span class="enscript-comment">/* process ID */</span>
	<span class="enscript-type">char</span>			pth_comm[MAXCOMLEN+1];		<span class="enscript-comment">/* process name */</span>
	uint32_t		pth_svc;			<span class="enscript-comment">/* service class */</span>
	uint16_t		pth_iftype;
	uint16_t		pth_ifunit;
	pid_t			pth_epid;		<span class="enscript-comment">/* effective process ID */</span>
	<span class="enscript-type">char</span>			pth_ecomm[MAXCOMLEN+1];	<span class="enscript-comment">/* effective command name */</span>
	uint32_t		pth_flowid;
	uint32_t		pth_ipproto;
	<span class="enscript-type">struct</span> timeval32	pth_tstamp;
	uuid_t			pth_uuid;
	uuid_t			pth_euuid;	
};

<span class="enscript-comment">/*
 *
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PTH_TYPE_NONE</span>	0		<span class="enscript-comment">/* No more data following */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PTH_TYPE_PACKET</span>	1		<span class="enscript-comment">/* Actual captured packet data */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PTH_FLAG_DIR_IN</span>			0x0001	<span class="enscript-comment">/* Outgoing packet */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PTH_FLAG_DIR_OUT</span>		0x0002	<span class="enscript-comment">/* Incoming packet */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PTH_FLAG_PROC_DELEGATED</span>		0x0004	<span class="enscript-comment">/* Process delegated */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PTH_FLAG_IF_DELEGATED</span>		0x0008	<span class="enscript-comment">/* Interface delegated */</span>
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">BSD_KERNEL_PRIVATE</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PTH_FLAG_DELAY_PKTAP</span>		0x1000	<span class="enscript-comment">/* Finalize pktap header on read */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* BSD_KERNEL_PRIVATE */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PTH_FLAG_TSTAMP</span>			0x2000	<span class="enscript-comment">/* Has time stamp */</span>


#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">BSD_KERNEL_PRIVATE</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">pktap_init</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">pktap_input</span>(<span class="enscript-type">struct</span> ifnet *, protocol_family_t, <span class="enscript-type">struct</span> mbuf *, <span class="enscript-type">char</span> *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">pktap_output</span>(<span class="enscript-type">struct</span> ifnet *, protocol_family_t, <span class="enscript-type">struct</span> mbuf *, 
	u_int32_t, u_int32_t);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">pktap_fill_proc_info</span>(<span class="enscript-type">struct</span> pktap_header *, protocol_family_t , 
	<span class="enscript-type">struct</span> mbuf *, u_int32_t , <span class="enscript-type">int</span> , <span class="enscript-type">struct</span> ifnet *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">pktap_finalize_proc_info</span>(<span class="enscript-type">struct</span> pktap_header *);

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* BSD_KERNEL_PRIVATE */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* PRIVATE */</span>

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* _NET_PKTAP_H_ */</span>
</pre>
<hr />
</body></html>