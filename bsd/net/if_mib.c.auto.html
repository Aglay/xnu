<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>if_mib.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">if_mib.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000-2013 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*
 * Copyright 1996 Massachusetts Institute of Technology
 *
 * Permission to use, copy, modify, and distribute this software and
 * its documentation for any purpose and without fee is hereby
 * granted, provided that both the above copyright notice and this
 * permission notice appear in all copies, that both the above
 * copyright notice and this permission notice appear in all
 * supporting documentation, and that the name of M.I.T. not be used
 * in advertising or publicity pertaining to distribution of the
 * software without specific, written prior permission.  M.I.T. makes
 * no representations about the suitability of this software for any
 * purpose.  It is provided &quot;as is&quot; without express or implied
 * warranty.
 * 
 * THIS SOFTWARE IS PROVIDED BY M.I.T. ``AS IS''.  M.I.T. DISCLAIMS
 * ALL EXPRESS OR IMPLIED WARRANTIES WITH REGARD TO THIS SOFTWARE,
 * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT
 * SHALL M.I.T. BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
 * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
 * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
 * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 * $FreeBSD: src/sys/net/if_mib.c,v 1.8.2.1 2000/08/03 00:09:34 ps Exp $
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/param.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/systm.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/kernel.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/socket.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/sysctl.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/systm.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/if.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/if_mib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/if_var.h&gt;</span>

<span class="enscript-comment">/*
 * A sysctl(3) MIB for generic interface information.  This information
 * is exported in the net.link.generic branch, which has the following
 * structure:
 *
 * net.link.generic	.system			- system-wide control variables
 *						  and statistics (node)
 *			.ifdata.&lt;ifindex&gt;.general
 *						- what's in `struct ifdata'
 *						  plus some other info
 *			.ifdata.&lt;ifindex&gt;.linkspecific
 *						- a link-type-specific data
 *						  structure (as might be used
 *						  by an SNMP agent
 *
 * Perhaps someday we will make addresses accessible via this interface
 * as well (then there will be four such...).  The reason that the
 * index comes before the last element in the name is because it
 * seems more orthogonal that way, particularly with the possibility
 * of other per-interface data living down here as well (e.g., integrated
 * services stuff).
 */</span>

<span class="enscript-function-name">SYSCTL_DECL</span>(_net_link_generic);

<span class="enscript-function-name">SYSCTL_NODE</span>(_net_link_generic, IFMIB_SYSTEM, system, CTLFLAG_RD|CTLFLAG_LOCKED, 0,
	    <span class="enscript-string">&quot;Variables global to all interfaces&quot;</span>);

<span class="enscript-function-name">SYSCTL_INT</span>(_net_link_generic_system, IFMIB_IFCOUNT, ifcount, CTLFLAG_RD | CTLFLAG_LOCKED,
	   &amp;if_index, 0, <span class="enscript-string">&quot;Number of configured interfaces&quot;</span>);

<span class="enscript-type">static</span> <span class="enscript-type">int</span> sysctl_ifdata SYSCTL_HANDLER_ARGS;
<span class="enscript-function-name">SYSCTL_NODE</span>(_net_link_generic, IFMIB_IFDATA, ifdata, CTLFLAG_RD | CTLFLAG_LOCKED,
            sysctl_ifdata, <span class="enscript-string">&quot;Interface table&quot;</span>);

<span class="enscript-type">static</span> <span class="enscript-type">int</span> sysctl_ifalldata SYSCTL_HANDLER_ARGS;
<span class="enscript-function-name">SYSCTL_NODE</span>(_net_link_generic, IFMIB_IFALLDATA, ifalldata, CTLFLAG_RD | CTLFLAG_LOCKED,
            sysctl_ifalldata, <span class="enscript-string">&quot;Interface table&quot;</span>);

<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">make_ifmibdata</span>(<span class="enscript-type">struct</span> ifnet *, <span class="enscript-type">int</span> *, <span class="enscript-type">struct</span> sysctl_req *);

<span class="enscript-type">int</span>
<span class="enscript-function-name">make_ifmibdata</span>(<span class="enscript-type">struct</span> ifnet *ifp, <span class="enscript-type">int</span> *name, <span class="enscript-type">struct</span> sysctl_req *req)
{
	<span class="enscript-type">struct</span> ifmibdata	ifmd;
	<span class="enscript-type">int</span> error = 0;

	<span class="enscript-keyword">switch</span>(name[1]) {
	<span class="enscript-reference">default</span>:
		error = ENOENT;
		<span class="enscript-keyword">break</span>;

	<span class="enscript-keyword">case</span> <span class="enscript-reference">IFDATA_GENERAL</span>:
		bzero(&amp;ifmd, <span class="enscript-keyword">sizeof</span>(ifmd));
		<span class="enscript-comment">/*
		 * Make sure the interface is in use
		 */</span>
		<span class="enscript-keyword">if</span> (ifnet_is_attached(ifp, 0)) {
			snprintf(ifmd.ifmd_name, <span class="enscript-keyword">sizeof</span>(ifmd.ifmd_name), <span class="enscript-string">&quot;%s&quot;</span>,
				if_name(ifp));

#<span class="enscript-reference">define</span> <span class="enscript-function-name">COPY</span>(fld) ifmd.ifmd_##fld = ifp-&gt;if_##fld
			COPY(pcount);
			COPY(flags);
			if_data_internal_to_if_data64(ifp, &amp;ifp-&gt;if_data, &amp;ifmd.ifmd_data);
#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">COPY</span>
			ifmd.ifmd_snd_len = IFCQ_LEN(&amp;ifp-&gt;if_snd);
			ifmd.ifmd_snd_maxlen = IFCQ_MAXLEN(&amp;ifp-&gt;if_snd);
			ifmd.ifmd_snd_drops = ifp-&gt;if_snd.ifcq_dropcnt.packets;
		}
		error = SYSCTL_OUT(req, &amp;ifmd, <span class="enscript-keyword">sizeof</span> ifmd);
		<span class="enscript-keyword">if</span> (error || !req-&gt;newptr)
			<span class="enscript-keyword">break</span>;

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">IF_MIB_WR</span>
		error = SYSCTL_IN(req, &amp;ifmd, <span class="enscript-keyword">sizeof</span> ifmd);
		<span class="enscript-keyword">if</span> (error)
			<span class="enscript-keyword">break</span>;

#<span class="enscript-reference">define</span> <span class="enscript-function-name">DONTCOPY</span>(fld) ifmd.ifmd_data.ifi_##fld = ifp-&gt;if_data.ifi_##fld
		DONTCOPY(type);
		DONTCOPY(physical);
		DONTCOPY(addrlen);
		DONTCOPY(hdrlen);
		DONTCOPY(mtu);
		DONTCOPY(metric);
		DONTCOPY(baudrate);
#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">DONTCOPY</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">COPY</span>(fld) ifp-&gt;if_##fld = ifmd.ifmd_##fld
		COPY(data);
		ifp-&gt;if_snd.ifq_maxlen = ifmd.ifmd_snd_maxlen;
		ifp-&gt;if_snd.ifq_drops = ifmd.ifmd_snd_drops;
#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">COPY</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* IF_MIB_WR */</span>
		<span class="enscript-keyword">break</span>;

	<span class="enscript-keyword">case</span> <span class="enscript-reference">IFDATA_LINKSPECIFIC</span>:
		error = SYSCTL_OUT(req, ifp-&gt;if_linkmib, ifp-&gt;if_linkmiblen);
		<span class="enscript-keyword">if</span> (error || !req-&gt;newptr)
			<span class="enscript-keyword">break</span>;

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">IF_MIB_WR</span>
		error = SYSCTL_IN(req, ifp-&gt;if_linkmib, ifp-&gt;if_linkmiblen);
		<span class="enscript-keyword">if</span> (error)
			<span class="enscript-keyword">break</span>;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* IF_MIB_WR */</span>
		<span class="enscript-keyword">break</span>;

	<span class="enscript-keyword">case</span> <span class="enscript-reference">IFDATA_SUPPLEMENTAL</span>: {
		<span class="enscript-type">struct</span> ifmibdata_supplemental *ifmd_supp;

		<span class="enscript-keyword">if</span> ((ifmd_supp = _MALLOC(<span class="enscript-keyword">sizeof</span> (*ifmd_supp), M_TEMP,
		    M_NOWAIT | M_ZERO)) == NULL) {
			error = ENOMEM;
			<span class="enscript-keyword">break</span>;
		}

		if_copy_traffic_class(ifp, &amp;ifmd_supp-&gt;ifmd_traffic_class);
		if_copy_data_extended(ifp, &amp;ifmd_supp-&gt;ifmd_data_extended);
		if_copy_packet_stats(ifp, &amp;ifmd_supp-&gt;ifmd_packet_stats);
		if_copy_rxpoll_stats(ifp, &amp;ifmd_supp-&gt;ifmd_rxpoll_stats);

		<span class="enscript-keyword">if</span> (req-&gt;oldptr == USER_ADDR_NULL)
			req-&gt;oldlen = <span class="enscript-keyword">sizeof</span> (*ifmd_supp);

		error = SYSCTL_OUT(req, ifmd_supp, MIN(<span class="enscript-keyword">sizeof</span> (*ifmd_supp),
		    req-&gt;oldlen));

		_FREE(ifmd_supp, M_TEMP);
		<span class="enscript-keyword">break</span>;
	}
	}

	<span class="enscript-keyword">return</span> error;
}

<span class="enscript-type">int</span>
sysctl_ifdata SYSCTL_HANDLER_ARGS <span class="enscript-comment">/* XXX bad syntax! */</span>
{
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">unused</span>(<span class="enscript-variable-name">oidp</span>)
	<span class="enscript-type">int</span> *name = (<span class="enscript-type">int</span> *)arg1;
	<span class="enscript-type">int</span> error = 0;
	u_int namelen = arg2;
	<span class="enscript-type">struct</span> ifnet *ifp;

	<span class="enscript-keyword">if</span> (namelen != 2)
		<span class="enscript-keyword">return</span> (EINVAL);

	ifnet_head_lock_shared();
	<span class="enscript-keyword">if</span> (name[0] &lt;= 0 || name[0] &gt; if_index ||
	    (ifp = ifindex2ifnet[name[0]]) == NULL) {
		ifnet_head_done();
		<span class="enscript-keyword">return</span> (ENOENT);
	}
	ifnet_reference(ifp);
	ifnet_head_done();

	ifnet_lock_shared(ifp);
	error = make_ifmibdata(ifp, name, req);
	ifnet_lock_done(ifp);

	ifnet_release(ifp);

	<span class="enscript-keyword">return</span> (error);
}

<span class="enscript-type">int</span>
sysctl_ifalldata SYSCTL_HANDLER_ARGS <span class="enscript-comment">/* XXX bad syntax! */</span>
{
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">unused</span>(<span class="enscript-variable-name">oidp</span>)
	<span class="enscript-type">int</span> *name = (<span class="enscript-type">int</span> *)arg1;
	<span class="enscript-type">int</span> error = 0;
	u_int namelen = arg2;
	<span class="enscript-type">struct</span> ifnet *ifp;

	<span class="enscript-keyword">if</span> (namelen != 2)
		<span class="enscript-keyword">return</span> (EINVAL);

	ifnet_head_lock_shared();
	TAILQ_FOREACH(ifp, &amp;ifnet_head, if_link) {
		ifnet_lock_shared(ifp);

		error = make_ifmibdata(ifp, name, req);

		ifnet_lock_done(ifp);
		<span class="enscript-keyword">if</span> (error != 0)
			<span class="enscript-keyword">break</span>;
	}
	ifnet_head_done();
	<span class="enscript-keyword">return</span> error;
}
</pre>
<hr />
</body></html>