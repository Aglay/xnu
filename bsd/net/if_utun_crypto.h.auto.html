<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>if_utun_crypto.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">if_utun_crypto.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2011 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">ifndef</span>	<span class="enscript-variable-name">_NET_IF_UTUN_CRYPTO_H_</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">_NET_IF_UTUN_CRYPTO_H_</span>

<span class="enscript-comment">// constants used in configuring the crypto context
</span><span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> utun_crypto_ver {
	UTUN_CRYPTO_VER_1 = 1,
	UTUN_CRYPTO_VER_MAX,
} utun_crypto_ver_t;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">UTUN_CRYPTO_KEYS_IPSEC_VER_1</span>                  UTUN_CRYPTO_VER_1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">UTUN_CRYPTO_IPSEC_VER_1</span>                       UTUN_CRYPTO_VER_1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">UTUN_CRYPTO_DTLS_VER_1</span>                        UTUN_CRYPTO_VER_1

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">UTUN_CRYPTO_ARGS_VER_MAX</span>                      UTUN_CRYPTO_VER_MAX
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">UTUN_CRYPTO_KEYS_ARGS_VER_MAX</span>                 UTUN_CRYPTO_VER_MAX
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">UTUN_CRYPTO_FRAMER_ARGS_VER_MAX</span>               UTUN_CRYPTO_VER_MAX

<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> utun_crypto_dir {
	UTUN_CRYPTO_DIR_IN = 1,
	UTUN_CRYPTO_DIR_OUT,
	UTUN_CRYPTO_DIR_MAX,
} utun_crypto_dir_t;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">UTUN_CRYPTO_CTX_NUM_DIRS</span> 2

#<span class="enscript-reference">define</span> <span class="enscript-function-name">BITSTOBYTES</span>(n)                                (n &gt;&gt; 3)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">BYTESTOBITS</span>(n)                                (n &lt;&lt; 3)

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MAX_KEY_AUTH_LEN_BITS</span>                         512 // corresponds to SHA512
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MAX_KEY_AUTH_LEN_BYTES</span>                        (BITSTOBYTES(MAX_KEY_AUTH_LEN_BITS))
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MAX_KEY_ENC_LEN_BITS</span>                          256 // corresponds to AES256
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MAX_KEY_ENC_LEN_BYTES</span>                         (BITSTOBYTES(MAX_KEY_ENC_LEN_BITS))

<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> utun_crypto_type {
	UTUN_CRYPTO_TYPE_IPSEC = 1,
	UTUN_CRYPTO_TYPE_DTLS,
	UTUN_CRYPTO_TYPE_MAX,
} utun_crypto_type_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> if_utun_crypto_ipsec_mode {
	IF_UTUN_CRYPTO_IPSEC_MODE_NONE = 0,
	IF_UTUN_CRYPTO_IPSEC_MODE_TRANSPORT,
	IF_UTUN_CRYPTO_IPSEC_MODE_TUNNEL,
	IF_UTUN_CRYPTO_IPSEC_MODE_MAX,
} if_utun_crypto_ipsec_mode_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> if_utun_crypto_ipsec_proto {
	IF_UTUN_CRYPTO_IPSEC_PROTO_NONE = 0,
	IF_UTUN_CRYPTO_IPSEC_PROTO_ESP,
	IF_UTUN_CRYPTO_IPSEC_PROTO_AH,
	IF_UTUN_CRYPTO_IPSEC_PROTO_MAX,
} if_utun_crypto_ipsec_proto_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> if_utun_crypto_ipsec_auth {
	IF_UTUN_CRYPTO_IPSEC_AUTH_NONE = 0,
	IF_UTUN_CRYPTO_IPSEC_AUTH_MD5,
	IF_UTUN_CRYPTO_IPSEC_AUTH_SHA1,
	IF_UTUN_CRYPTO_IPSEC_AUTH_SHA256,
	IF_UTUN_CRYPTO_IPSEC_AUTH_SHA384,
	IF_UTUN_CRYPTO_IPSEC_AUTH_SHA512,
	IF_UTUN_CRYPTO_IPSEC_AUTH_MAX,
} if_utun_crypto_ipsec_auth_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> if_utun_crypto_ipsec_enc {
	IF_UTUN_CRYPTO_IPSEC_ENC_NONE = 0,
	IF_UTUN_CRYPTO_IPSEC_ENC_DES,
	IF_UTUN_CRYPTO_IPSEC_ENC_3DES,
	IF_UTUN_CRYPTO_IPSEC_ENC_AES128,
	IF_UTUN_CRYPTO_IPSEC_ENC_AES256,
	IF_UTUN_CRYPTO_IPSEC_ENC_MAX,
} if_utun_crypto_ipsec_enc_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> if_utun_crypto_ipsec_keepalive {
	IF_UTUN_CRYPTO_IPSEC_KEEPALIVE_NONE = 0,
	IF_UTUN_CRYPTO_IPSEC_KEEPALIVE_NATT,
	IF_UTUN_CRYPTO_IPSEC_KEEPALIVE_ESP,
	IF_UTUN_CRYPTO_IPSEC_KEEPALIVE_MAX,
} if_utun_crypto_ipsec_keepalive_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> if_utun_crypto_ipsec_natd {
	IF_UTUN_CRYPTO_IPSEC_NATD_NONE = 0,
	IF_UTUN_CRYPTO_IPSEC_NATD_MINE,
	IF_UTUN_CRYPTO_IPSEC_NATD_PEER,
	IF_UTUN_CRYPTO_IPSEC_NATD_BOTH,
	IF_UTUN_CRYPTO_IPSEC_NATD_MAX,
} if_utun_crypto_ipsec_natd_t;

<span class="enscript-comment">// structures used for storing the App's keying index arguments
</span><span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_keys_idx_ipsec_args_v1 {
	<span class="enscript-type">struct</span> sockaddr_storage                       src_addr; <span class="enscript-comment">// v4 or v6 socket address (ignore port numbers)
</span>	<span class="enscript-type">struct</span> sockaddr_storage                       dst_addr; <span class="enscript-comment">// v4 or v6 socket address (ignore port numbers)
</span>	if_utun_crypto_ipsec_proto_t                  proto;
	if_utun_crypto_ipsec_mode_t                   mode;
	u_int32_t                                     reqid; <span class="enscript-comment">// policy's reqid, default to 0 for now since we are avoiding policies.
</span>	u_int32_t                                     spi;		  <span class="enscript-comment">// 0 when requesting the index, otherwise it contains the resulting index
</span>	u_int32_t                                     spirange_min; <span class="enscript-comment">// default to 0
</span>	u_int32_t                                     spirange_max; <span class="enscript-comment">// default to 0xffffffff
</span>} __attribute__((packed)) utun_crypto_keys_idx_ipsec_args_v1_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_keys_idx_dtls_args_v1 {
	<span class="enscript-comment">// stub for DTLS keying index arguments
</span>	u_int32_t                                     unused; <span class="enscript-comment">// place holder
</span>} __attribute__((packed)) utun_crypto_keys_idx_dtls_args_v1_t;

<span class="enscript-comment">// App's parent structure for sending/storing keying index arguments
</span><span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_keys_idx_args {
	utun_crypto_ver_t                             ver;
	utun_crypto_type_t                            type;
	utun_crypto_dir_t                             dir;
	u_int32_t                                     args_ulen;
	u_int32_t                                     varargs_buflen;
	<span class="enscript-type">union</span> {
		<span class="enscript-comment">// don't change the order, number, or size of elements above this line (in this struct). otherwise UTUN_CRYPTO_CTX_IDX_ARGS_HDR_SIZE breaks backwards compatibility
</span>		utun_crypto_keys_idx_ipsec_args_v1_t  ipsec_v1;
		utun_crypto_keys_idx_dtls_args_v1_t   dtls_v1;
		<span class="enscript-comment">// future (additional) versions of the arguments may be placed here
</span>	} u;
	u_int8_t                                      varargs_buf[0];
} __attribute__((aligned(4), packed)) utun_crypto_keys_idx_args_t;

<span class="enscript-comment">// structures used for storing the App's keying material arguments
</span><span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_keys_ipsec_args_v1 {
	<span class="enscript-type">struct</span> sockaddr_storage                       src_addr; <span class="enscript-comment">// v4 or v6 socket address (ignore port numbers)
</span>	<span class="enscript-type">struct</span> sockaddr_storage                       dst_addr; <span class="enscript-comment">// v4 or v6 socket address (ignore port numbers)
</span>	if_utun_crypto_ipsec_proto_t                  proto;
	if_utun_crypto_ipsec_mode_t                   mode;
	if_utun_crypto_ipsec_auth_t                   alg_auth;
	if_utun_crypto_ipsec_enc_t                    alg_enc;
	if_utun_crypto_ipsec_keepalive_t              keepalive;
	if_utun_crypto_ipsec_natd_t                   natd;
	u_int8_t                                      replay;   <span class="enscript-comment">// window size default to 4
</span>	u_int8_t                                      punt_rx_keepalive;
	u_int16_t                                     interval_tx_keepalive;
	u_int16_t                                     key_auth_len; <span class="enscript-comment">// 128 or 160 or 192 or 256 or 384 or 512
</span>	u_int16_t                                     key_enc_len;  <span class="enscript-comment">// 64 or 128 or 192 or 256
</span>	u_int16_t                                     natt_port; <span class="enscript-comment">// if non-zero flags will be set to include SADB_X_EXT_NATT
</span>	u_int16_t                                     unused;
	u_int32_t                                     seq;	  <span class="enscript-comment">// default to 0
</span>	u_int32_t                                     spi;
	u_int32_t                                     pid;      <span class="enscript-comment">// vpnagent's process id
</span>	u_int32_t                                     reqid; <span class="enscript-comment">// policy's reqid, default to 0 for now since we are avoiding policies.
</span>	u_int64_t                                     lifetime_hard; <span class="enscript-comment">// value in seconds
</span>	u_int64_t                                     lifetime_soft; <span class="enscript-comment">// value in seconds
</span>	<span class="enscript-comment">// key_auth and key_enc will actually be stored in utun_crypto_KEYS_args_t.varargs_buf
</span>} __attribute__((packed)) utun_crypto_keys_ipsec_args_v1_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_keys_dtls_args_v1 {
	<span class="enscript-comment">// stub for DTLS keying material arguments
</span>	u_int32_t                                     unused; <span class="enscript-comment">// place holder
</span>} __attribute__((packed)) utun_crypto_keys_dtls_args_v1_t;

<span class="enscript-comment">// App's parent structure for sending/storing keying material arguments
</span><span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_keys_args {
	utun_crypto_ver_t                             ver;
	utun_crypto_type_t                            type;
	utun_crypto_dir_t                             dir;
	u_int32_t                                     args_ulen;
	u_int32_t                                     varargs_buflen;
	<span class="enscript-type">union</span> {
		<span class="enscript-comment">// don't change the order, number, or size of elements above this line (in this struct). otherwise UTUN_CRYPTO_KEYS_ARGS_HDR_SIZE breaks backwards compatibility
</span>		utun_crypto_keys_ipsec_args_v1_t      ipsec_v1;
		utun_crypto_keys_dtls_args_v1_t       dtls_v1;
		<span class="enscript-comment">// future (additional) versions of the arguments may be placed here
</span>	} u;
	u_int8_t                                      varargs_buf[0];
} __attribute__((aligned(4), packed)) utun_crypto_keys_args_t;

<span class="enscript-comment">// structures used for storing the App's crypto arguments
</span><span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_ipsec_args_v1 {
	<span class="enscript-comment">// stub for IPSec crypto context arguments
</span>	u_int32_t                                     unused; <span class="enscript-comment">// place holder
</span>} __attribute__((packed)) utun_crypto_ipsec_args_v1_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_dtls_args_v1 {
	<span class="enscript-comment">// stub for DTLS crypto context arguments
</span>	<span class="enscript-type">int</span>                                           kpi_handle;
} __attribute__((packed)) utun_crypto_dtls_args_v1_t;

<span class="enscript-comment">// App's parent structure for starting/stopping crypto
</span><span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_args {
	utun_crypto_ver_t                             ver;
	utun_crypto_type_t                            type;
	u_int32_t                                     stop_data_traffic;
	u_int32_t                                     args_ulen;
	u_int32_t                                     varargs_buflen;
	<span class="enscript-type">union</span> {
		<span class="enscript-comment">// don't change the order, number, or size of elements above this line (in this struct). otherwise UTUN_CRYPTO_ARGS_HDR_SIZE breaks backwards compatibility
</span>		utun_crypto_ipsec_args_v1_t           ipsec_v1;
		utun_crypto_dtls_args_v1_t            dtls_v1;
		<span class="enscript-comment">// future (additional) versions of the arguments may be placed here
</span>	} u;
	u_int8_t                                      varargs_buf[0]; <span class="enscript-comment">// must be at the end of this struct
</span>} __attribute__((aligned(4), packed)) utun_crypto_args_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> {
  UTUN_CRYPTO_INNER_TYPE_IPv4 = 1,
  UTUN_CRYPTO_INNER_TYPE_IPv6,
  UTUN_CRYPTO_INNER_TYPE_MAX,
} utun_crypto_framer_inner_type_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_framer_ipsec_args_v1 {
	<span class="enscript-comment">// stub for IPSec framer arguments
</span>	u_int32_t                                     unused; <span class="enscript-comment">// place holder
</span>} __attribute__((packed)) utun_crypto_framer_ipsec_args_v1_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_framer_dtls_in_args_v1 {
	<span class="enscript-type">int</span>                                           in_pattern_len;
	<span class="enscript-type">int</span>                                           in_pattern_mask_len;
	<span class="enscript-type">int</span>                                           in_data_offset;
	<span class="enscript-comment">// in_pattern, in_pattern_mask will actually be stored in utun_crypto_framer_args_t.varargs_buf
</span>} __attribute__((packed)) utun_crypto_framer_dtls_in_args_v1_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_framer_dtls_out_args_v1 {
	<span class="enscript-type">int</span>                                           out_pattern_len;
	u_int32_t                                     len_field_mask; <span class="enscript-comment">// 0 means unconfigured
</span>	<span class="enscript-type">int</span>                                           len_field_offset;
	<span class="enscript-type">int</span>                                           len_field_extra;
	u_int32_t                                     sequence_field;
	u_int32_t                                     sequence_field_mask; <span class="enscript-comment">// 0 means unconfigured
</span>	<span class="enscript-type">int</span>                                           sequence_field_offset;
	<span class="enscript-comment">// out_pattern will actually be stored in utun_crypto_framer_args_t.varargs_buf
</span>} __attribute__((packed)) utun_crypto_framer_dtls_out_args_v1_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_framer_dtls_args_v1 {
	<span class="enscript-comment">// the following depend on utun_crypto_framer_args_t.dir
</span>	<span class="enscript-type">union</span> {
		<span class="enscript-comment">// don't change the order, number, or size of elements above this line (in this struct). otherwise UTUN_CRYPTO_KEYS_ARGS_HDR_SIZE breaks backwards compatibility
</span>		utun_crypto_framer_dtls_in_args_v1_t  in;
		utun_crypto_framer_dtls_out_args_v1_t out;
		<span class="enscript-comment">// future (additional) versions of the arguments may be placed here
</span>	} u;
} __attribute__((packed)) utun_crypto_framer_dtls_args_v1_t;

<span class="enscript-comment">// App's parent structure for sending/storing framer arguments
</span><span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_framer_args {
	utun_crypto_ver_t                             ver;
	utun_crypto_type_t                            type;
	utun_crypto_dir_t                             dir;
	utun_crypto_framer_inner_type_t               inner_type;
	u_int32_t                                     args_ulen;
	u_int32_t                                     varargs_buflen;
	<span class="enscript-type">union</span> {
		<span class="enscript-comment">// don't change the order, number, or size of elements above this line (in this struct). otherwise UTUN_CRYPTO_KEYS_ARGS_HDR_SIZE breaks backwards compatibility
</span>		utun_crypto_framer_ipsec_args_v1_t    ipsec_v1;
		utun_crypto_framer_dtls_args_v1_t     dtls_v1;
		<span class="enscript-comment">// future (additional) versions of the arguments may be placed here
</span>	} u;
	u_int8_t                                      varargs_buf[0];
} __attribute__((aligned(4), packed)) utun_crypto_framer_args_t;

#<span class="enscript-reference">define</span> <span class="enscript-function-name">utun_crypto_framer_args_dtls_in</span>(framer)   framer-&gt;u.dtls_v1.u.in
#<span class="enscript-reference">define</span> <span class="enscript-function-name">utun_crypto_framer_args_dtls_out</span>(framer)  framer-&gt;u.dtls_v1.u.out

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL_PRIVATE</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/kern_control.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/kpi_protocol.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/kpi_interface.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/pfkeyv2.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netkey/key.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netkey/keydb.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/bpf.h&gt;</span>

<span class="enscript-type">struct</span> utun_pcb;

<span class="enscript-comment">// structures used for storing kernel's keying material runtime state
</span><span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_keys_ipsec_state {
	<span class="enscript-comment">// kernel's ipsec keying material state
</span>	u_int32_t                                     spi;
	<span class="enscript-type">struct</span> secashead                             *sah;
	<span class="enscript-type">struct</span> secasvar                              *sav;
	u_int8_t                                      proto;
	u_int8_t                                      ifamily;
	u_int8_t                                      mode;
	u_int8_t                                      unused;
} __attribute__((packed)) utun_crypto_keys_ipsec_state_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_keys_dtls_state {
	<span class="enscript-comment">// stub for kernel's DTLS keying material state
</span>	u_int32_t                                     unused; <span class="enscript-comment">// place holder
</span>} __attribute__((packed)) utun_crypto_keys_dtls_state_t;

<span class="enscript-comment">// kernel's parent structure for keying material state
</span><span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_keys_state {
	<span class="enscript-type">union</span> {
		utun_crypto_keys_ipsec_state_t        ipsec;
		utun_crypto_keys_dtls_state_t         dtls;
	} u;
} __attribute__((aligned(4), packed)) utun_crypto_keys_state_t;

<span class="enscript-comment">// kernel's parent structure for keying material
</span><span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_keys {
	<span class="enscript-type">int</span>                                           valid; <span class="enscript-comment">// is valid?
</span>	utun_crypto_type_t                            type;
	u_int16_t                                     unused;
	utun_crypto_keys_state_t                      state; <span class="enscript-comment">// runtime state
</span>	LIST_ENTRY(utun_crypto_keys)                  chain;
} __attribute__((aligned(4), packed)) utun_crypto_keys_t;

<span class="enscript-comment">// structures used for storing kernel's framer runtime state
</span><span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_framer_ipsec_state {
	<span class="enscript-comment">// stub for kernel's IPSec framer state
</span>	u_int32_t                                     unused; <span class="enscript-comment">// place holder
</span>} __attribute__((packed)) utun_crypto_framer_ipsec_state_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_framer_dtls_in_state {
	u_int8_t                                     *in_pattern;
	<span class="enscript-type">int</span>                                           in_pattern_len;
	u_int8_t                                     *in_pattern_mask;
	u_int8_t                                     *in_pattern_masked;
	<span class="enscript-type">int</span>                                           in_data_offset;
	<span class="enscript-type">struct</span> bpf_program                            in_pattern_filter;
} __attribute__((packed)) utun_crypto_framer_dtls_in_state_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_framer_dtls_out_state {
	u_int8_t                                     *out_pattern;
	<span class="enscript-type">int</span>                                           out_pattern_len;
	u_int32_t                                     len_field_mask; <span class="enscript-comment">// 0 means unconfigured
</span>	<span class="enscript-type">int</span>                                           len_field_offset;
	<span class="enscript-type">int</span>                                           len_field_extra;
	u_int32_t                                     sequence_field;
	u_int32_t                                     sequence_field_initval;
	u_int32_t                                     sequence_field_mask; <span class="enscript-comment">// 0 means unconfigured
</span>	<span class="enscript-type">int</span>                                           sequence_field_offset;
} __attribute__((packed)) utun_crypto_framer_dtls_out_state_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_framer_dtls_state {
	<span class="enscript-type">union</span> {
		<span class="enscript-comment">// don't change the order, number, or size of elements above this line (in this struct). otherwise UTUN_CRYPTO_KEYS_ARGS_HDR_SIZE breaks backwards compatibility
</span>		utun_crypto_framer_dtls_in_state_t  in;
		utun_crypto_framer_dtls_out_state_t out;
		<span class="enscript-comment">// future (additional) versions of the arguments may be placed here
</span>	} u;
} __attribute__((packed)) utun_crypto_framer_dtls_state_t;

<span class="enscript-comment">// kernel's parent structure for framer state
</span><span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_framer_state {
	<span class="enscript-type">union</span> {
		utun_crypto_framer_ipsec_state_t ipsec;
		utun_crypto_framer_dtls_state_t  dtls;
	} u;
} __attribute__((aligned(4), packed)) utun_crypto_framer_state_t;

<span class="enscript-comment">// kernel's parent structure for the framer
</span><span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_framer {
	<span class="enscript-type">int</span>                                           valid; <span class="enscript-comment">// is valid?
</span>	utun_crypto_type_t                            type;
	utun_crypto_dir_t                             dir;
	utun_crypto_framer_inner_type_t               inner_type;
	protocol_family_t                             inner_protocol_family;
	utun_crypto_framer_state_t                    state; <span class="enscript-comment">// runtime state
</span>	LIST_ENTRY(utun_crypto_framer)                framer_chain;
} __attribute__((aligned(4), packed)) utun_crypto_framer_t;

#<span class="enscript-reference">define</span> <span class="enscript-function-name">UTUN_CRYPTO_INNER_TYPE_TO_IDX</span>(type)           (type - 1)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">UTUN_CRYPTO_IDX_TO_INNER_TYPE</span>(idx)            (idx + 1)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">UTUN_CRYPTO_INNER_TYPE_IDX_MAX</span>                UTUN_CRYPTO_INNER_TYPE_TO_IDX(UTUN_CRYPTO_INNER_TYPE_MAX)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">UTUN_CRYPTO_DIR_TO_IDX</span>(dir)                   (dir - 1)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">UTUN_CRYPTO_IDX_TO_DIR</span>(idx)                   (idx + 1)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">UTUN_CRYPTO_DIR_IDX_MAX</span>                       UTUN_CRYPTO_DIR_TO_IDX(UTUN_CRYPTO_DIR_MAX)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">utun_crypto_framer_state_dtls_in</span>(framer)      framer-&gt;state.u.dtls.u.in
#<span class="enscript-reference">define</span> <span class="enscript-function-name">utun_crypto_framer_state_dtls_out</span>(framer)     framer-&gt;state.u.dtls.u.out

<span class="enscript-comment">// kernel's parent structure for all crypto stuff
</span><span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_ctx {
	<span class="enscript-type">int</span>                                           valid;
	utun_crypto_type_t                            type;
	u_int16_t                                     unused;
	LIST_HEAD(chain, utun_crypto_keys)            keys_listhead;
	LIST_HEAD(framer_chain, utun_crypto_framer)   framer_listheads[UTUN_CRYPTO_INNER_TYPE_IDX_MAX];
	<span class="enscript-type">int</span>                                           num_framers;
	<span class="enscript-type">int</span>                                           kpi_handle;
	caddr_t                                       kpi_ref;
	<span class="enscript-type">int</span>                                           kpi_refcnt;
} __attribute__((aligned(4), packed)) utun_crypto_ctx_t;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">UTUN_CRYPTO_KEYS_IDX_ARGS_HDR_SIZE</span>            ((size_t)(&amp;((utun_crypto_keys_idx_args_t *)0)-&gt;u))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">UTUN_CRYPTO_KEYS_IDX_ARGS_VARARGS_BUF</span>(args)   ((u_int8_t *)args + UTUN_CRYPTO_KEYS_IDX_ARGS_HDR_SIZE + args-&gt;args_ulen)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">UTUN_CRYPTO_KEYS_IDX_ARGS_TOTAL_SIZE</span>(args)    ((size_t)(UTUN_CRYPTO_KEYS_IDX_ARGS_HDR_SIZE + args-&gt;args_ulen + args-&gt;varargs_buflen))

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">UTUN_CRYPTO_KEYS_ARGS_HDR_SIZE</span>                ((size_t)(&amp;((utun_crypto_keys_args_t *)0)-&gt;u))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">UTUN_CRYPTO_KEYS_ARGS_VARARGS_BUF</span>(args)       ((u_int8_t *)args + UTUN_CRYPTO_KEYS_ARGS_HDR_SIZE + args-&gt;args_ulen)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">UTUN_CRYPTO_KEYS_ARGS_TOTAL_SIZE</span>(args)        ((size_t)(UTUN_CRYPTO_KEYS_ARGS_HDR_SIZE + args-&gt;args_ulen + args-&gt;varargs_buflen))

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">UTUN_CRYPTO_FRAMER_ARGS_HDR_SIZE</span>                ((size_t)(&amp;((utun_crypto_framer_args_t *)0)-&gt;u))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">UTUN_CRYPTO_FRAMER_ARGS_VARARGS_BUF</span>(args)       ((u_int8_t *)args + UTUN_CRYPTO_FRAMER_ARGS_HDR_SIZE + args-&gt;args_ulen)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">UTUN_CRYPTO_FRAMER_ARGS_TOTAL_SIZE</span>(args)        ((size_t)(UTUN_CRYPTO_FRAMER_ARGS_HDR_SIZE + args-&gt;args_ulen + args-&gt;varargs_buflen))

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">UTUN_CRYPTO_ARGS_HDR_SIZE</span>                     ((size_t)(&amp;((utun_crypto_args_t *)0)-&gt;u))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">UTUN_CRYPTO_ARGS_VARARGS_BUF</span>(args)            ((u_int8_t *)args + UTUN_CRYPTO_ARGS_HDR_SIZE + args-&gt;args_ulen)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">UTUN_CRYPTO_ARGS_TOTAL_SIZE</span>(args)             ((size_t)(UTUN_CRYPTO_ARGS_HDR_SIZE + args-&gt;args_ulen + args-&gt;varargs_buflen))

<span class="enscript-type">typedef</span> <span class="enscript-function-name">caddr_t</span> (*utun_crypto_kpi_connect_func)(<span class="enscript-type">int</span> kpi_handle, <span class="enscript-type">struct</span> utun_pcb *utun_ref);

<span class="enscript-type">typedef</span> <span class="enscript-function-name">errno_t</span> (*utun_crypto_kpi_send_func)(caddr_t ref, mbuf_t *pkt);

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_kpi_reg {
  <span class="enscript-comment">/* Dispatch functions */</span>
  utun_crypto_type_t           crypto_kpi_type;
  u_int32_t                    crypto_kpi_flags;
  utun_crypto_kpi_connect_func crypto_kpi_connect;
  utun_crypto_kpi_send_func    crypto_kpi_send;
} utun_crypto_kpi_reg_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> utun_crypto_kpi_reg_list {
  utun_crypto_kpi_reg_t            reg;
  <span class="enscript-type">struct</span> utun_crypto_kpi_reg_list *next;
} utun_crypto_kpi_reg_list_t;

<span class="enscript-type">void</span>
<span class="enscript-function-name">utun_ctl_init_crypto</span>(<span class="enscript-type">void</span>);

<span class="enscript-comment">/*
 * Summary: registers the crypto KPI's Kext routines with UTUN... so that UTUN can make calls into it (e.g. DTLS)
 */</span>
errno_t
<span class="enscript-function-name">utun_crypto_kpi_register</span>(utun_crypto_kpi_reg_t *reg);

<span class="enscript-type">void</span>
<span class="enscript-function-name">utun_cleanup_crypto</span>(<span class="enscript-type">struct</span> utun_pcb *pcb);

errno_t
<span class="enscript-function-name">utun_ctl_enable_crypto</span>(__unused kern_ctl_ref  kctlref,
		       __unused u_int32_t     unit, 
		       __unused <span class="enscript-type">void</span>         *unitinfo,
		       __unused <span class="enscript-type">int</span>           opt, 
		       <span class="enscript-type">void</span>                  *data, 
		       size_t                 len);

errno_t
<span class="enscript-function-name">utun_ctl_disable_crypto</span>(__unused kern_ctl_ref  kctlref,
			__unused u_int32_t     unit, 
			__unused <span class="enscript-type">void</span>         *unitinfo,
			__unused <span class="enscript-type">int</span>           opt, 
			<span class="enscript-type">void</span>                  *data, 
			size_t                 len);

errno_t
<span class="enscript-function-name">utun_ctl_config_crypto_keys</span>(__unused kern_ctl_ref  kctlref,
			    __unused u_int32_t	   unit, 
			    __unused <span class="enscript-type">void</span>         *unitinfo,
			    __unused <span class="enscript-type">int</span>           opt, 
			    <span class="enscript-type">void</span>                  *data, 
			    size_t                 len);

errno_t
<span class="enscript-function-name">utun_ctl_unconfig_crypto_keys</span>(__unused kern_ctl_ref  kctlref,
			      __unused u_int32_t     unit, 
			      __unused <span class="enscript-type">void</span>         *unitinfo,
			      __unused <span class="enscript-type">int</span>           opt, 
			      <span class="enscript-type">void</span>                  *data, 
			      size_t                 len);

errno_t
<span class="enscript-function-name">utun_ctl_config_crypto_framer</span>(__unused kern_ctl_ref  kctlref,
			      __unused u_int32_t	   unit, 
			      __unused <span class="enscript-type">void</span>         *unitinfo,
			      __unused <span class="enscript-type">int</span>           opt, 
			      <span class="enscript-type">void</span>                  *data, 
			      size_t                 len);

errno_t
<span class="enscript-function-name">utun_ctl_unconfig_crypto_framer</span>(__unused kern_ctl_ref  kctlref,
				__unused u_int32_t     unit, 
				__unused <span class="enscript-type">void</span>         *unitinfo,
				__unused <span class="enscript-type">int</span>           opt, 
				<span class="enscript-type">void</span>                  *data, 
				size_t                 len);

errno_t
<span class="enscript-function-name">utun_ctl_generate_crypto_keys_idx</span>(__unused kern_ctl_ref  kctlref,
				  __unused u_int32_t     unit, 
				  __unused <span class="enscript-type">void</span>         *unitinfo,
				  __unused <span class="enscript-type">int</span>           opt, 
				  <span class="enscript-type">void</span>                  *data, 
				  size_t                *len);

errno_t
<span class="enscript-function-name">utun_ctl_stop_crypto_data_traffic</span>(__unused kern_ctl_ref  kctlref,
				  __unused u_int32_t     unit, 
				  __unused <span class="enscript-type">void</span>         *unitinfo,
				  __unused <span class="enscript-type">int</span>           opt, 
				  <span class="enscript-type">void</span>                  *data, 
				  size_t                 len);

errno_t
<span class="enscript-function-name">utun_ctl_start_crypto_data_traffic</span>(__unused kern_ctl_ref  kctlref,
				   __unused u_int32_t     unit, 
				   __unused <span class="enscript-type">void</span>         *unitinfo,
				   __unused <span class="enscript-type">int</span>           opt, 
				   <span class="enscript-type">void</span>                  *data, 
				   size_t                 len);

<span class="enscript-type">int</span>
<span class="enscript-function-name">utun_pkt_crypto_output</span>(<span class="enscript-type">struct</span> utun_pcb *pcb, mbuf_t *m);

#<span class="enscript-reference">endif</span> // <span class="enscript-variable-name">KERNEL_PRIVATE</span>

#<span class="enscript-reference">endif</span> // <span class="enscript-variable-name">_NET_IF_UTUN_CRYPTO_H_</span>
</pre>
<hr />
</body></html>