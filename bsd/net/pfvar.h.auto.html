<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>pfvar.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">pfvar.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2007-2015 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 *
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 *
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 *
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

<span class="enscript-comment">/*	$apfw: git commit b6bf13f8321283cd7ee82b1795e86506084b1b95 $ */</span>
<span class="enscript-comment">/*	$OpenBSD: pfvar.h,v 1.259 2007/12/02 12:08:04 pascoe Exp $ */</span>

<span class="enscript-comment">/*
 * Copyright (c) 2001 Daniel Hartmeier
 * NAT64 - Copyright (c) 2010 Viagenie Inc. (<a href="http://www.viagenie.ca">http://www.viagenie.ca</a>)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 *    - Redistributions of source code must retain the above copyright
 *      notice, this list of conditions and the following disclaimer.
 *    - Redistributions in binary form must reproduce the above
 *      copyright notice, this list of conditions and the following
 *      disclaimer in the documentation and/or other materials provided
 *      with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
 * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
 * COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
 * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
 * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
 * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
 * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 *
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_NET_PFVAR_H_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_NET_PFVAR_H_</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">PRIVATE</span>
<span class="enscript-comment">/*
 * XXX
 * XXX Private interfaces.  Do not include this file; use pfctl(8) instead.
 * XXX
 */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PF</span> || !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">KERNEL</span>)

#<span class="enscript-reference">ifdef</span>  <span class="enscript-variable-name">__cplusplus</span>
<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> {
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdbool.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/param.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/queue.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/tree.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/radix.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/in.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/if_var.h&gt;</span>
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/kern_types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/zalloc.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/locks.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;machine/endian.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/systm.h&gt;</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">BYTE_ORDER</span> == <span class="enscript-variable-name">BIG_ENDIAN</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">htobe64</span>(x)	(x)
#<span class="enscript-reference">else</span> <span class="enscript-comment">/* LITTLE ENDIAN */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">htobe64</span>(x)	__DARWIN_OSSwapInt64(x)
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* LITTLE_ENDIAN */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">be64toh</span>(x)	htobe64(x)

<span class="enscript-type">extern</span> lck_rw_t *pf_perim_lock;
<span class="enscript-type">extern</span> lck_mtx_t *pf_lock;

<span class="enscript-type">struct</span> pool {
	<span class="enscript-type">struct</span> zone	*pool_zone;	<span class="enscript-comment">/* pointer to backend zone */</span>
	<span class="enscript-type">const</span> <span class="enscript-type">char</span>	*pool_name;	<span class="enscript-comment">/* name of pool */</span>
	<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>	pool_count;	<span class="enscript-comment">/* # of outstanding elements */</span>
	<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>	pool_hiwat;	<span class="enscript-comment">/* high watermark */</span>
	<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>	pool_limit;	<span class="enscript-comment">/* hard limit */</span>
	<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>	pool_fails;	<span class="enscript-comment">/* # of failed allocs due to limit */</span>
};

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PR_NOWAIT</span>	FALSE
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PR_WAITOK</span>	TRUE

__private_extern__ <span class="enscript-type">void</span> pool_init(<span class="enscript-type">struct</span> pool *, size_t, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>, <span class="enscript-type">int</span>, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *, <span class="enscript-type">void</span> *);
__private_extern__ <span class="enscript-type">void</span> pool_destroy(<span class="enscript-type">struct</span> pool *);
__private_extern__ <span class="enscript-type">void</span> pool_sethiwat(<span class="enscript-type">struct</span> pool *, <span class="enscript-type">int</span>);
__private_extern__ <span class="enscript-type">void</span> pool_sethardlimit(<span class="enscript-type">struct</span> pool *, <span class="enscript-type">int</span>,
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> *, <span class="enscript-type">int</span>);
__private_extern__ <span class="enscript-type">void</span> *pool_get(<span class="enscript-type">struct</span> pool *, <span class="enscript-type">int</span>);
__private_extern__ <span class="enscript-type">void</span> pool_put(<span class="enscript-type">struct</span> pool *, <span class="enscript-type">void</span> *);
__private_extern__ u_int64_t pf_time_second(<span class="enscript-type">void</span>);
__private_extern__ u_int64_t pf_calendar_time_second(<span class="enscript-type">void</span>);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL */</span>

<span class="enscript-type">union</span> sockaddr_union {
	<span class="enscript-type">struct</span> sockaddr		sa;
	<span class="enscript-type">struct</span> sockaddr_in	sin;
	<span class="enscript-type">struct</span> sockaddr_in6	sin6;
};

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PF_TCPS_PROXY_SRC</span>	((TCP_NSTATES)+0)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PF_TCPS_PROXY_DST</span>	((TCP_NSTATES)+1)

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PF_MD5_DIGEST_LENGTH</span>	16
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">MD5_DIGEST_LENGTH</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PF_MD5_DIGEST_LENGTH</span> != <span class="enscript-variable-name">MD5_DIGEST_LENGTH</span>
#<span class="enscript-reference">error</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* PF_MD5_DIGEST_LENGTH != MD5_DIGEST_LENGTH */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* MD5_DIGEST_LENGTH */</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
<span class="enscript-type">struct</span> ip;
<span class="enscript-type">struct</span> ip6_hdr;
<span class="enscript-type">struct</span> tcphdr;
<span class="enscript-type">struct</span> pf_grev1_hdr;
<span class="enscript-type">struct</span> pf_esp_hdr;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_GRE_PPTP_VARIANT</span>	0x01

<span class="enscript-type">enum</span>	{ PF_INOUT, PF_IN, PF_OUT };
<span class="enscript-type">enum</span>	{ PF_PASS, PF_DROP, PF_SCRUB, PF_NOSCRUB, PF_NAT, PF_NONAT,
	  PF_BINAT, PF_NOBINAT, PF_RDR, PF_NORDR, PF_SYNPROXY_DROP,
	  PF_DUMMYNET, PF_NODUMMYNET, PF_NAT64, PF_NONAT64 };
<span class="enscript-type">enum</span>	{ PF_RULESET_SCRUB, PF_RULESET_FILTER, PF_RULESET_NAT,
	  PF_RULESET_BINAT, PF_RULESET_RDR, PF_RULESET_DUMMYNET, 
	  PF_RULESET_MAX };
<span class="enscript-type">enum</span>	{ PF_OP_NONE, PF_OP_IRG, PF_OP_EQ, PF_OP_NE, PF_OP_LT,
	  PF_OP_LE, PF_OP_GT, PF_OP_GE, PF_OP_XRG, PF_OP_RRG };
<span class="enscript-type">enum</span>	{ PF_DEBUG_NONE, PF_DEBUG_URGENT, PF_DEBUG_MISC, PF_DEBUG_NOISY };
<span class="enscript-type">enum</span>	{ PF_CHANGE_NONE, PF_CHANGE_ADD_HEAD, PF_CHANGE_ADD_TAIL,
	  PF_CHANGE_ADD_BEFORE, PF_CHANGE_ADD_AFTER,
	  PF_CHANGE_REMOVE, PF_CHANGE_GET_TICKET };
<span class="enscript-type">enum</span>	{ PF_GET_NONE, PF_GET_CLR_CNTR };

<span class="enscript-comment">/*
 * Note about PFTM_*: real indices into pf_rule.timeout[] come before
 * PFTM_MAX, special cases afterwards. See pf_state_expires().
 */</span>
<span class="enscript-type">enum</span>	{ PFTM_TCP_FIRST_PACKET, PFTM_TCP_OPENING, PFTM_TCP_ESTABLISHED,
	  PFTM_TCP_CLOSING, PFTM_TCP_FIN_WAIT, PFTM_TCP_CLOSED,
	  PFTM_UDP_FIRST_PACKET, PFTM_UDP_SINGLE, PFTM_UDP_MULTIPLE,
	  PFTM_ICMP_FIRST_PACKET, PFTM_ICMP_ERROR_REPLY,
	  PFTM_GREv1_FIRST_PACKET, PFTM_GREv1_INITIATING,
	  PFTM_GREv1_ESTABLISHED, PFTM_ESP_FIRST_PACKET, PFTM_ESP_INITIATING,
	  PFTM_ESP_ESTABLISHED, PFTM_OTHER_FIRST_PACKET, PFTM_OTHER_SINGLE,
	  PFTM_OTHER_MULTIPLE, PFTM_FRAG, PFTM_INTERVAL,
	  PFTM_ADAPTIVE_START, PFTM_ADAPTIVE_END, PFTM_SRC_NODE,
	  PFTM_TS_DIFF, PFTM_MAX, PFTM_PURGE, PFTM_UNLINKED };

<span class="enscript-comment">/* PFTM default values */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTM_TCP_FIRST_PACKET_VAL</span>	120	<span class="enscript-comment">/* First TCP packet */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTM_TCP_OPENING_VAL</span>		30	<span class="enscript-comment">/* No response yet */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTM_TCP_ESTABLISHED_VAL</span>	(24 * 60 * 60)	<span class="enscript-comment">/* Established */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTM_TCP_CLOSING_VAL</span>		(15 * 60)	<span class="enscript-comment">/* Half closed */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTM_TCP_FIN_WAIT_VAL</span>		45	<span class="enscript-comment">/* Got both FINs */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTM_TCP_CLOSED_VAL</span>		90	<span class="enscript-comment">/* Got a RST */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTM_UDP_FIRST_PACKET_VAL</span>	60	<span class="enscript-comment">/* First UDP packet */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTM_UDP_SINGLE_VAL</span>		30	<span class="enscript-comment">/* Unidirectional */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTM_UDP_MULTIPLE_VAL</span>		60	<span class="enscript-comment">/* Bidirectional */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTM_ICMP_FIRST_PACKET_VAL</span>	20	<span class="enscript-comment">/* First ICMP packet */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTM_ICMP_ERROR_REPLY_VAL</span>	10	<span class="enscript-comment">/* Got error response */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTM_GREv1_FIRST_PACKET_VAL</span>	120
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTM_GREv1_INITIATING_VAL</span>	30
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTM_GREv1_ESTABLISHED_VAL</span>	1800
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTM_ESP_FIRST_PACKET_VAL</span>	120
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTM_ESP_INITIATING_VAL</span>		30
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTM_ESP_ESTABLISHED_VAL</span>	900
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTM_OTHER_FIRST_PACKET_VAL</span>	60	<span class="enscript-comment">/* First packet */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTM_OTHER_SINGLE_VAL</span>		30	<span class="enscript-comment">/* Unidirectional */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTM_OTHER_MULTIPLE_VAL</span>		60	<span class="enscript-comment">/* Bidirectional */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTM_FRAG_VAL</span>			30	<span class="enscript-comment">/* Fragment expire */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTM_INTERVAL_VAL</span>		10	<span class="enscript-comment">/* Expire interval */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTM_SRC_NODE_VAL</span>		0	<span class="enscript-comment">/* Source tracking */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTM_TS_DIFF_VAL</span>		30	<span class="enscript-comment">/* Allowed TS diff */</span>

<span class="enscript-type">enum</span>	{ PF_NOPFROUTE, PF_FASTROUTE, PF_ROUTETO, PF_DUPTO, PF_REPLYTO };
<span class="enscript-type">enum</span>	{ PF_LIMIT_STATES,
	  PF_LIMIT_APP_STATES,
	  PF_LIMIT_SRC_NODES, PF_LIMIT_FRAGS,
	  PF_LIMIT_TABLES, PF_LIMIT_TABLE_ENTRIES, PF_LIMIT_MAX };
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_POOL_IDMASK</span>		0x0f
<span class="enscript-type">enum</span>	{ PF_POOL_NONE, PF_POOL_BITMASK, PF_POOL_RANDOM,
	  PF_POOL_SRCHASH, PF_POOL_ROUNDROBIN };
<span class="enscript-type">enum</span>	{ PF_ADDR_ADDRMASK, PF_ADDR_NOROUTE, PF_ADDR_DYNIFTL,
	  PF_ADDR_TABLE, PF_ADDR_RTLABEL, PF_ADDR_URPFFAILED,
	  PF_ADDR_RANGE };
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_POOL_TYPEMASK</span>	0x0f
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_POOL_STICKYADDR</span>	0x20
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PF_WSCALE_FLAG</span>		0x80
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PF_WSCALE_MASK</span>		0x0f

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PF_LOG</span>			0x01
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PF_LOG_ALL</span>		0x02
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PF_LOG_SOCKET_LOOKUP</span>	0x04

<span class="enscript-type">struct</span> pf_addr {
	<span class="enscript-type">union</span> {
		<span class="enscript-type">struct</span> in_addr		v4;
		<span class="enscript-type">struct</span> in6_addr		v6;
		u_int8_t		addr8[16];
		u_int16_t		addr16[8];
		u_int32_t		addr32[4];
	} pfa;		    <span class="enscript-comment">/* 128-bit address */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">v4</span>	pfa.v4
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">v6</span>	pfa.v6
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">addr8</span>	pfa.addr8
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">addr16</span>	pfa.addr16
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">addr32</span>	pfa.addr32
};

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PF_TABLE_NAME_SIZE</span>	 32

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFI_AFLAG_NETWORK</span>	0x01
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFI_AFLAG_BROADCAST</span>	0x02
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFI_AFLAG_PEER</span>		0x04
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFI_AFLAG_MODEMASK</span>	0x07
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFI_AFLAG_NOALIAS</span>	0x08

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">RTLABEL_LEN</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">RTLABEL_LEN</span> 32
#<span class="enscript-reference">endif</span>

<span class="enscript-type">struct</span> pf_addr_wrap {
	<span class="enscript-type">union</span> {
		<span class="enscript-type">struct</span> {
			<span class="enscript-type">struct</span> pf_addr		 addr;
			<span class="enscript-type">struct</span> pf_addr		 mask;
		}			 a;
		<span class="enscript-type">char</span>			 ifname[IFNAMSIZ];
		<span class="enscript-type">char</span>			 tblname[PF_TABLE_NAME_SIZE];
		<span class="enscript-type">char</span>			 rtlabelname[RTLABEL_LEN];
		u_int32_t		 rtlabel;
	}			 v;
	<span class="enscript-type">union</span> {
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
		<span class="enscript-type">struct</span> pfi_dynaddr	*dyn	__attribute__((aligned(8)));
		<span class="enscript-type">struct</span> pfr_ktable	*tbl	__attribute__((aligned(8)));
#<span class="enscript-reference">else</span> <span class="enscript-comment">/* !KERNEL */</span>
		<span class="enscript-type">void</span>			*dyn	__attribute__((aligned(8)));
		<span class="enscript-type">void</span>			*tbl	__attribute__((aligned(8)));
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !KERNEL */</span>
		<span class="enscript-type">int</span>			 dyncnt __attribute__((aligned(8)));
		<span class="enscript-type">int</span>			 tblcnt __attribute__((aligned(8)));
	}			 p __attribute__((aligned(8)));
	u_int8_t		 type;		<span class="enscript-comment">/* PF_ADDR_* */</span>
	u_int8_t		 iflags;	<span class="enscript-comment">/* PFI_AFLAG_* */</span>
};

<span class="enscript-type">struct</span> pf_port_range {
	u_int16_t			port[2];
	u_int8_t			op;
};

<span class="enscript-type">union</span> pf_rule_xport {
	<span class="enscript-type">struct</span> pf_port_range	range;
	u_int16_t		call_id;
	u_int32_t		spi;
};

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
<span class="enscript-type">struct</span> pfi_dynaddr {
	TAILQ_ENTRY(pfi_dynaddr)	 entry;
	<span class="enscript-type">struct</span> pf_addr			 pfid_addr4;
	<span class="enscript-type">struct</span> pf_addr			 pfid_mask4;
	<span class="enscript-type">struct</span> pf_addr			 pfid_addr6;
	<span class="enscript-type">struct</span> pf_addr			 pfid_mask6;
	<span class="enscript-type">struct</span> pfr_ktable		*pfid_kt;
	<span class="enscript-type">struct</span> pfi_kif			*pfid_kif;
	<span class="enscript-type">void</span>				*pfid_hook_cookie;
	<span class="enscript-type">int</span>				 pfid_net;	<span class="enscript-comment">/* mask or 128 */</span>
	<span class="enscript-type">int</span>				 pfid_acnt4;	<span class="enscript-comment">/* address count IPv4 */</span>
	<span class="enscript-type">int</span>				 pfid_acnt6;	<span class="enscript-comment">/* address count IPv6 */</span>
	sa_family_t			 pfid_af;	<span class="enscript-comment">/* rule af */</span>
	u_int8_t			 pfid_iflags;	<span class="enscript-comment">/* PFI_AFLAG_* */</span>
};

<span class="enscript-comment">/*
 * Address manipulation macros
 */</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET</span>
#<span class="enscript-reference">if</span> !<span class="enscript-variable-name">INET6</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_INET_ONLY</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* ! INET6 */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* INET */</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET6</span>
#<span class="enscript-reference">if</span> !<span class="enscript-variable-name">INET</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_INET6_ONLY</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* ! INET */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* INET6 */</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET6</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_INET_INET6</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* INET6 */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* INET */</span>

#<span class="enscript-reference">else</span> <span class="enscript-comment">/* !KERNEL */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_INET_INET6</span>

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !KERNEL */</span>

<span class="enscript-comment">/* Both IPv4 and IPv6 */</span>
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">PF_INET_INET6</span>

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_AEQ</span>(a, b, c) \
	((c == AF_INET &amp;&amp; (a)-&gt;addr32[0] == (b)-&gt;addr32[0]) || \
	((a)-&gt;addr32[3] == (b)-&gt;addr32[3] &amp;&amp; \
	(a)-&gt;addr32[2] == (b)-&gt;addr32[2] &amp;&amp; \
	(a)-&gt;addr32[1] == (b)-&gt;addr32[1] &amp;&amp; \
	(a)-&gt;addr32[0] == (b)-&gt;addr32[0])) \

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_ANEQ</span>(a, b, c) \
	((c == AF_INET &amp;&amp; (a)-&gt;addr32[0] != (b)-&gt;addr32[0]) || \
	((a)-&gt;addr32[3] != (b)-&gt;addr32[3] || \
	(a)-&gt;addr32[2] != (b)-&gt;addr32[2] || \
	(a)-&gt;addr32[1] != (b)-&gt;addr32[1] || \
	(a)-&gt;addr32[0] != (b)-&gt;addr32[0])) \

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_ALEQ</span>(a, b, c) \
	((c == AF_INET &amp;&amp; (a)-&gt;addr32[0] &lt;= (b)-&gt;addr32[0]) || \
	((a)-&gt;addr32[3] &lt;= (b)-&gt;addr32[3] &amp;&amp; \
	(a)-&gt;addr32[2] &lt;= (b)-&gt;addr32[2] &amp;&amp; \
	(a)-&gt;addr32[1] &lt;= (b)-&gt;addr32[1] &amp;&amp; \
	(a)-&gt;addr32[0] &lt;= (b)-&gt;addr32[0])) \

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_AZERO</span>(a, c) \
	((c == AF_INET &amp;&amp; !(a)-&gt;addr32[0]) || \
	(!(a)-&gt;addr32[0] &amp;&amp; !(a)-&gt;addr32[1] &amp;&amp; \
	!(a)-&gt;addr32[2] &amp;&amp; !(a)-&gt;addr32[3])) \

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_MATCHA</span>(n, a, m, b, f) \
	pf_match_addr(n, a, m, b, f)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_ACPY</span>(a, b, f) \
	pf_addrcpy(a, b, f)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_AINC</span>(a, f) \
	pf_addr_inc(a, f)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_POOLMASK</span>(a, b, c, d, f) \
	pf_poolmask(a, b, c, d, f)

#<span class="enscript-reference">else</span>

<span class="enscript-comment">/* Just IPv6 */</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">PF_INET6_ONLY</span>

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_AEQ</span>(a, b, c) \
	((a)-&gt;addr32[3] == (b)-&gt;addr32[3] &amp;&amp; \
	(a)-&gt;addr32[2] == (b)-&gt;addr32[2] &amp;&amp; \
	(a)-&gt;addr32[1] == (b)-&gt;addr32[1] &amp;&amp; \
	(a)-&gt;addr32[0] == (b)-&gt;addr32[0]) \

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_ANEQ</span>(a, b, c) \
	((a)-&gt;addr32[3] != (b)-&gt;addr32[3] || \
	(a)-&gt;addr32[2] != (b)-&gt;addr32[2] || \
	(a)-&gt;addr32[1] != (b)-&gt;addr32[1] || \
	(a)-&gt;addr32[0] != (b)-&gt;addr32[0]) \

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_ALEQ</span>(a, b, c) \
	((a)-&gt;addr32[3] &lt;= (b)-&gt;addr32[3] &amp;&amp; \
	(a)-&gt;addr32[2] &lt;= (b)-&gt;addr32[2] &amp;&amp; \
	(a)-&gt;addr32[1] &lt;= (b)-&gt;addr32[1] &amp;&amp; \
	(a)-&gt;addr32[0] &lt;= (b)-&gt;addr32[0]) \

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_AZERO</span>(a, c) \
	(!(a)-&gt;addr32[0] &amp;&amp; \
	!(a)-&gt;addr32[1] &amp;&amp; \
	!(a)-&gt;addr32[2] &amp;&amp; \
	!(a)-&gt;addr32[3]) \

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_MATCHA</span>(n, a, m, b, f) \
	pf_match_addr(n, a, m, b, f)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_ACPY</span>(a, b, f) \
	pf_addrcpy(a, b, f)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_AINC</span>(a, f) \
	pf_addr_inc(a, f)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_POOLMASK</span>(a, b, c, d, f) \
	pf_poolmask(a, b, c, d, f)

#<span class="enscript-reference">else</span>

<span class="enscript-comment">/* Just IPv4 */</span>
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">PF_INET_ONLY</span>

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_AEQ</span>(a, b, c) \
	((a)-&gt;addr32[0] == (b)-&gt;addr32[0])

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_ANEQ</span>(a, b, c) \
	((a)-&gt;addr32[0] != (b)-&gt;addr32[0])

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_ALEQ</span>(a, b, c) \
	((a)-&gt;addr32[0] &lt;= (b)-&gt;addr32[0])

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_AZERO</span>(a, c) \
	(!(a)-&gt;addr32[0])

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_MATCHA</span>(n, a, m, b, f) \
	pf_match_addr(n, a, m, b, f)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_ACPY</span>(a, b, f) \
	(a)-&gt;v4.s_addr = (b)-&gt;v4.s_addr

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_AINC</span>(a, f) \
	<span class="enscript-keyword">do</span> { \
		(a)-&gt;addr32[0] = htonl(ntohl((a)-&gt;addr32[0]) + 1); \
	} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_POOLMASK</span>(a, b, c, d, f) \
	<span class="enscript-keyword">do</span> { \
		(a)-&gt;addr32[0] = ((b)-&gt;addr32[0] &amp; (c)-&gt;addr32[0]) | \
		(((c)-&gt;addr32[0] ^ 0xffffffff) &amp; (d)-&gt;addr32[0]); \
	} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* PF_INET_ONLY */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* PF_INET6_ONLY */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* PF_INET_INET6 */</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">PF_MISMATCHAW</span>(aw, x, af, neg, ifp)				\
	(								\
		(((aw)-&gt;type == PF_ADDR_NOROUTE &amp;&amp;			\
		    pf_routable((x), (af), NULL)) ||			\
		(((aw)-&gt;type == PF_ADDR_URPFFAILED &amp;&amp; (ifp) != NULL &amp;&amp;	\
		    pf_routable((x), (af), (ifp))) ||			\
		((aw)-&gt;type == PF_ADDR_RTLABEL &amp;&amp;			\
		    !pf_rtlabel_match((x), (af), (aw))) ||		\
		((aw)-&gt;type == PF_ADDR_TABLE &amp;&amp;				\
		    !pfr_match_addr((aw)-&gt;p.tbl, (x), (af))) ||		\
		((aw)-&gt;type == PF_ADDR_DYNIFTL &amp;&amp;			\
		    !pfi_match_addr((aw)-&gt;p.dyn, (x), (af))) || 	\
		((aw)-&gt;type == PF_ADDR_RANGE &amp;&amp;				\
		    !pf_match_addr_range(&amp;(aw)-&gt;v.a.addr,		\
		    &amp;(aw)-&gt;v.a.mask, (x), (af))) || 			\
		((aw)-&gt;type == PF_ADDR_ADDRMASK &amp;&amp;			\
		    !PF_AZERO(&amp;(aw)-&gt;v.a.mask, (af)) &amp;&amp;			\
		    !PF_MATCHA(0, &amp;(aw)-&gt;v.a.addr,			\
		    &amp;(aw)-&gt;v.a.mask, (x), (af))))) !=			\
		(neg)							\
	)
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL */</span>

<span class="enscript-type">struct</span> pf_rule_uid {
	uid_t		 uid[2];
	u_int8_t	 op;
	u_int8_t	 _pad[3];
};

<span class="enscript-type">struct</span> pf_rule_gid {
	uid_t		 gid[2];
	u_int8_t	 op;
	u_int8_t	 _pad[3];
};

<span class="enscript-type">struct</span> pf_rule_addr {
	<span class="enscript-type">struct</span> pf_addr_wrap	 addr;
	<span class="enscript-type">union</span> pf_rule_xport	 xport;
	u_int8_t		 neg;
};

<span class="enscript-type">struct</span> pf_pooladdr {
	<span class="enscript-type">struct</span> pf_addr_wrap		 addr;
	TAILQ_ENTRY(pf_pooladdr)	 entries;
#<span class="enscript-reference">if</span> !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__LP64__</span>)
	u_int32_t			 _pad[2];
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !__LP64__ */</span>
	<span class="enscript-type">char</span>				 ifname[IFNAMSIZ];
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
	<span class="enscript-type">struct</span> pfi_kif			*kif	__attribute__((aligned(8)));
#<span class="enscript-reference">else</span> <span class="enscript-comment">/* !KERNEL */</span>
	<span class="enscript-type">void</span>				*kif	__attribute__((aligned(8)));
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !KERNEL */</span>
};

<span class="enscript-function-name">TAILQ_HEAD</span>(pf_palist, pf_pooladdr);

<span class="enscript-type">struct</span> pf_poolhashkey {
	<span class="enscript-type">union</span> {
		u_int8_t		key8[16];
		u_int16_t		key16[8];
		u_int32_t		key32[4];
	} pfk;		    <span class="enscript-comment">/* 128-bit hash key */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">key8</span>	pfk.key8
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">key16</span>	pfk.key16
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">key32</span>	pfk.key32
};

<span class="enscript-type">struct</span> pf_pool {
	<span class="enscript-type">struct</span> pf_palist	 list;
#<span class="enscript-reference">if</span> !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__LP64__</span>)
	u_int32_t		 _pad[2];
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !__LP64__ */</span>
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
	<span class="enscript-type">struct</span> pf_pooladdr	*cur		__attribute__((aligned(8)));
#<span class="enscript-reference">else</span> <span class="enscript-comment">/* !KERNEL */</span>
	<span class="enscript-type">void</span>			*cur		__attribute__((aligned(8)));
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !KERNEL */</span>
	<span class="enscript-type">struct</span> pf_poolhashkey	 key		__attribute__((aligned(8)));
	<span class="enscript-type">struct</span> pf_addr		 counter;
	<span class="enscript-type">int</span>			 tblidx;
	u_int16_t		 proxy_port[2];
	u_int8_t		 port_op;
	u_int8_t		 opts;
	sa_family_t		 af;
};


<span class="enscript-comment">/* A packed Operating System description for fingerprinting */</span>
<span class="enscript-type">typedef</span> u_int32_t pf_osfp_t;
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_ANY</span>	((pf_osfp_t)0)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_UNKNOWN</span>	((pf_osfp_t)-1)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_NOMATCH</span>	((pf_osfp_t)-2)

<span class="enscript-type">struct</span> pf_osfp_entry {
	SLIST_ENTRY(pf_osfp_entry) fp_entry;
#<span class="enscript-reference">if</span> !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__LP64__</span>)
	u_int32_t		_pad;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !__LP64__ */</span>
	pf_osfp_t		fp_os;
	<span class="enscript-type">int</span>			fp_enflags;
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_EXPANDED</span>	0x001		<span class="enscript-comment">/* expanded entry */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_GENERIC</span>		0x002		<span class="enscript-comment">/* generic signature */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_NODETAIL</span>	0x004		<span class="enscript-comment">/* no p0f details */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_LEN</span>	32
	<span class="enscript-type">char</span>			fp_class_nm[PF_OSFP_LEN];
	<span class="enscript-type">char</span>			fp_version_nm[PF_OSFP_LEN];
	<span class="enscript-type">char</span>			fp_subtype_nm[PF_OSFP_LEN];
};
#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_OSFP_ENTRY_EQ</span>(a, b) \
    ((a)-&gt;fp_os == (b)-&gt;fp_os &amp;&amp; \
    memcmp((a)-&gt;fp_class_nm, (b)-&gt;fp_class_nm, PF_OSFP_LEN) == 0 &amp;&amp; \
    memcmp((a)-&gt;fp_version_nm, (b)-&gt;fp_version_nm, PF_OSFP_LEN) == 0 &amp;&amp; \
    memcmp((a)-&gt;fp_subtype_nm, (b)-&gt;fp_subtype_nm, PF_OSFP_LEN) == 0)

<span class="enscript-comment">/* handle pf_osfp_t packing */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_FP_RESERVED_BIT</span>	1  <span class="enscript-comment">/* For the special negative #defines */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_FP_UNUSED_BITS</span>		1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_FP_CLASS_BITS</span>		10 <span class="enscript-comment">/* OS Class (Windows, Linux) */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_FP_VERSION_BITS</span>	10 <span class="enscript-comment">/* OS version (95, 98, NT, 2.4.54, 3.2) */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_FP_SUBTYPE_BITS</span>	10 <span class="enscript-comment">/* patch level (NT SP4, SP3, ECN patch) */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_OSFP_UNPACK</span>(osfp, class, version, subtype) do { \
	(class) = ((osfp) &gt;&gt; (_FP_VERSION_BITS+_FP_SUBTYPE_BITS)) &amp; \
	    ((1 &lt;&lt; _FP_CLASS_BITS) - 1); \
	(version) = ((osfp) &gt;&gt; _FP_SUBTYPE_BITS) &amp; \
	    ((1 &lt;&lt; _FP_VERSION_BITS) - 1);\
	(subtype) = (osfp) &amp; ((1 &lt;&lt; _FP_SUBTYPE_BITS) - 1); \
} <span class="enscript-keyword">while</span> (0)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">PF_OSFP_PACK</span>(osfp, class, version, subtype) do { \
	(osfp) = ((class) &amp; ((1 &lt;&lt; _FP_CLASS_BITS) - 1)) &lt;&lt; (_FP_VERSION_BITS \
	    + _FP_SUBTYPE_BITS); \
	(osfp) |= ((version) &amp; ((1 &lt;&lt; _FP_VERSION_BITS) - 1)) &lt;&lt; \
	    _FP_SUBTYPE_BITS; \
	(osfp) |= (subtype) &amp; ((1 &lt;&lt; _FP_SUBTYPE_BITS) - 1); \
} <span class="enscript-keyword">while</span> (0)

<span class="enscript-comment">/* the fingerprint of an OSes TCP SYN packet */</span>
<span class="enscript-type">typedef</span> u_int64_t	pf_tcpopts_t;
<span class="enscript-type">struct</span> pf_os_fingerprint {
	SLIST_HEAD(pf_osfp_enlist, pf_osfp_entry) fp_oses; <span class="enscript-comment">/* list of matches */</span>
	pf_tcpopts_t		fp_tcpopts;	<span class="enscript-comment">/* packed TCP options */</span>
	u_int16_t		fp_wsize;	<span class="enscript-comment">/* TCP window size */</span>
	u_int16_t		fp_psize;	<span class="enscript-comment">/* ip-&gt;ip_len */</span>
	u_int16_t		fp_mss;		<span class="enscript-comment">/* TCP MSS */</span>
	u_int16_t		fp_flags;
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_WSIZE_MOD</span>	0x0001		<span class="enscript-comment">/* Window modulus */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_WSIZE_DC</span>	0x0002		<span class="enscript-comment">/* Window don't care */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_WSIZE_MSS</span>	0x0004		<span class="enscript-comment">/* Window multiple of MSS */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_WSIZE_MTU</span>	0x0008		<span class="enscript-comment">/* Window multiple of MTU */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_PSIZE_MOD</span>	0x0010		<span class="enscript-comment">/* packet size modulus */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_PSIZE_DC</span>	0x0020		<span class="enscript-comment">/* packet size don't care */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_WSCALE</span>		0x0040		<span class="enscript-comment">/* TCP window scaling */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_WSCALE_MOD</span>	0x0080		<span class="enscript-comment">/* TCP window scale modulus */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_WSCALE_DC</span>	0x0100		<span class="enscript-comment">/* TCP window scale dont-care */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_MSS</span>		0x0200		<span class="enscript-comment">/* TCP MSS */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_MSS_MOD</span>		0x0400		<span class="enscript-comment">/* TCP MSS modulus */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_MSS_DC</span>		0x0800		<span class="enscript-comment">/* TCP MSS dont-care */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_DF</span>		0x1000		<span class="enscript-comment">/* IPv4 don't fragment bit */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_TS0</span>		0x2000		<span class="enscript-comment">/* Zero timestamp */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_INET6</span>		0x4000		<span class="enscript-comment">/* IPv6 */</span>
	u_int8_t		fp_optcnt;	<span class="enscript-comment">/* TCP option count */</span>
	u_int8_t		fp_wscale;	<span class="enscript-comment">/* TCP window scaling */</span>
	u_int8_t		fp_ttl;		<span class="enscript-comment">/* IPv4 TTL */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_MAXTTL_OFFSET</span>	40
<span class="enscript-comment">/* TCP options packing */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_TCPOPT_NOP</span>	0x0		<span class="enscript-comment">/* TCP NOP option */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_TCPOPT_WSCALE</span>	0x1		<span class="enscript-comment">/* TCP window scaling option */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_TCPOPT_MSS</span>	0x2		<span class="enscript-comment">/* TCP max segment size opt */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_TCPOPT_SACK</span>	0x3		<span class="enscript-comment">/* TCP SACK OK option */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_TCPOPT_TS</span>	0x4		<span class="enscript-comment">/* TCP timestamp option */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_TCPOPT_BITS</span>	3		<span class="enscript-comment">/* bits used by each option */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OSFP_MAX_OPTS</span> \
    (<span class="enscript-keyword">sizeof</span>(((<span class="enscript-type">struct</span> pf_os_fingerprint *)0)-&gt;fp_tcpopts) * 8) \
    / PF_OSFP_TCPOPT_BITS

	SLIST_ENTRY(pf_os_fingerprint)	fp_next;
};

<span class="enscript-type">struct</span> pf_osfp_ioctl {
	<span class="enscript-type">struct</span> pf_osfp_entry	fp_os;
	pf_tcpopts_t		fp_tcpopts;	<span class="enscript-comment">/* packed TCP options */</span>
	u_int16_t		fp_wsize;	<span class="enscript-comment">/* TCP window size */</span>
	u_int16_t		fp_psize;	<span class="enscript-comment">/* ip-&gt;ip_len */</span>
	u_int16_t		fp_mss;		<span class="enscript-comment">/* TCP MSS */</span>
	u_int16_t		fp_flags;
	u_int8_t		fp_optcnt;	<span class="enscript-comment">/* TCP option count */</span>
	u_int8_t		fp_wscale;	<span class="enscript-comment">/* TCP window scaling */</span>
	u_int8_t		fp_ttl;		<span class="enscript-comment">/* IPv4 TTL */</span>

	<span class="enscript-type">int</span>			fp_getnum;	<span class="enscript-comment">/* DIOCOSFPGET number */</span>
};


<span class="enscript-type">union</span> pf_rule_ptr {
	<span class="enscript-type">struct</span> pf_rule		*ptr		__attribute__((aligned(8)));
	u_int32_t		 nr		__attribute__((aligned(8)));
} __attribute__((aligned(8)));

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PF_ANCHOR_NAME_SIZE</span>	 64

<span class="enscript-type">struct</span> pf_rule {
	<span class="enscript-type">struct</span> pf_rule_addr	 src;
	<span class="enscript-type">struct</span> pf_rule_addr	 dst;
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_SKIP_IFP</span>		0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_SKIP_DIR</span>		1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_SKIP_AF</span>		2
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_SKIP_PROTO</span>		3
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_SKIP_SRC_ADDR</span>	4
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_SKIP_SRC_PORT</span>	5
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_SKIP_DST_ADDR</span>	6
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_SKIP_DST_PORT</span>	7
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_SKIP_COUNT</span>		8
	<span class="enscript-type">union</span> pf_rule_ptr	 skip[PF_SKIP_COUNT];
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_RULE_LABEL_SIZE</span>	 64
	<span class="enscript-type">char</span>			 label[PF_RULE_LABEL_SIZE];
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_QNAME_SIZE</span>		 64
	<span class="enscript-type">char</span>			 ifname[IFNAMSIZ];
	<span class="enscript-type">char</span>			 qname[PF_QNAME_SIZE];
	<span class="enscript-type">char</span>			 pqname[PF_QNAME_SIZE];
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PF_TAG_NAME_SIZE</span>	 64
	<span class="enscript-type">char</span>			 tagname[PF_TAG_NAME_SIZE];
	<span class="enscript-type">char</span>			 match_tagname[PF_TAG_NAME_SIZE];

	<span class="enscript-type">char</span>			 overload_tblname[PF_TABLE_NAME_SIZE];

	TAILQ_ENTRY(pf_rule)	 entries;
#<span class="enscript-reference">if</span> !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__LP64__</span>)
	u_int32_t		 _pad[2];
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !__LP64__ */</span>
	<span class="enscript-type">struct</span> pf_pool		 rpool;

	u_int64_t		 evaluations;
	u_int64_t		 packets[2];
	u_int64_t		 bytes[2];

	u_int64_t		 ticket;
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_OWNER_NAME_SIZE</span>	 64
	<span class="enscript-type">char</span>			 owner[PF_OWNER_NAME_SIZE];
	u_int32_t		 priority;

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
	<span class="enscript-type">struct</span> pfi_kif		*kif		__attribute__((aligned(8)));
#<span class="enscript-reference">else</span> <span class="enscript-comment">/* !KERNEL */</span>
	<span class="enscript-type">void</span>			*kif		__attribute__((aligned(8)));
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !KERNEL */</span>
	<span class="enscript-type">struct</span> pf_anchor	*anchor		__attribute__((aligned(8)));
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
	<span class="enscript-type">struct</span> pfr_ktable	*overload_tbl	__attribute__((aligned(8)));
#<span class="enscript-reference">else</span> <span class="enscript-comment">/* !KERNEL */</span>
	<span class="enscript-type">void</span>			*overload_tbl	__attribute__((aligned(8)));
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !KERNEL */</span>

	pf_osfp_t		 os_fingerprint	__attribute__((aligned(8)));

	<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>		 rtableid;
	u_int32_t		 timeout[PFTM_MAX];
	u_int32_t		 states;
	u_int32_t		 max_states;
	u_int32_t		 src_nodes;
	u_int32_t		 max_src_nodes;
	u_int32_t		 max_src_states;
	u_int32_t		 max_src_conn;
	<span class="enscript-type">struct</span> {
		u_int32_t		limit;
		u_int32_t		seconds;
	}			 max_src_conn_rate;
	u_int32_t		 qid;
	u_int32_t		 pqid;
	u_int32_t		 rt_listid;
	u_int32_t		 nr;
	u_int32_t		 prob;
	uid_t			 cuid;
	pid_t			 cpid;

	u_int16_t		 return_icmp;
	u_int16_t		 return_icmp6;
	u_int16_t		 max_mss;
	u_int16_t		 tag;
	u_int16_t		 match_tag;

	<span class="enscript-type">struct</span> pf_rule_uid	 uid;
	<span class="enscript-type">struct</span> pf_rule_gid	 gid;

	u_int32_t		 rule_flag;
	u_int8_t		 action;
	u_int8_t		 direction;
	u_int8_t		 log;
	u_int8_t		 logif;
	u_int8_t		 quick;
	u_int8_t		 ifnot;
	u_int8_t		 match_tag_not;
	u_int8_t		 natpass;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_STATE_NORMAL</span>		0x1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_STATE_MODULATE</span>	0x2
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_STATE_SYNPROXY</span>	0x3
	u_int8_t		 keep_state;
	sa_family_t		 af;
	u_int8_t		 proto;
	u_int8_t		 type;
	u_int8_t		 code;
	u_int8_t		 flags;
	u_int8_t		 flagset;
	u_int8_t		 min_ttl;
	u_int8_t		 allow_opts;
	u_int8_t		 rt;
	u_int8_t		 return_ttl;

<span class="enscript-comment">/* service class categories */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">SCIDX_MASK</span>		0x0f
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">SC_BE</span>			0x10
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">SC_BK_SYS</span>		0x11
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">SC_BK</span>			0x12
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">SC_RD</span>			0x13
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">SC_OAM</span>			0x14
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">SC_AV</span>			0x15
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">SC_RV</span>			0x16
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">SC_VI</span>			0x17
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">SC_VO</span>			0x18
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">SC_CTL</span>			0x19

<span class="enscript-comment">/* diffserve code points */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DSCP_MASK</span>		0xfc
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DSCP_CUMASK</span>		0x03
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DSCP_EF</span>			0xb8
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DSCP_AF11</span>		0x28
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DSCP_AF12</span>		0x30
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DSCP_AF13</span>		0x38
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DSCP_AF21</span>		0x48
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DSCP_AF22</span>		0x50
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DSCP_AF23</span>		0x58
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DSCP_AF31</span>		0x68
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DSCP_AF32</span>		0x70
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DSCP_AF33</span>		0x78
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DSCP_AF41</span>		0x88
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DSCP_AF42</span>		0x90
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DSCP_AF43</span>		0x98
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">AF_CLASSMASK</span>		0xe0
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">AF_DROPPRECMASK</span>		0x18
	u_int8_t		 tos;
	u_int8_t		 anchor_relative;
	u_int8_t		 anchor_wildcard;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_FLUSH</span>		0x01
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_FLUSH_GLOBAL</span>		0x02
	u_int8_t		 flush;

	u_int8_t		proto_variant;
	u_int8_t		extfilter; <span class="enscript-comment">/* Filter mode [PF_EXTFILTER_xxx] */</span>
	u_int8_t		extmap;    <span class="enscript-comment">/* Mapping mode [PF_EXTMAP_xxx] */</span>
	u_int32_t               dnpipe;
	u_int32_t               dntype;
};

<span class="enscript-comment">/* pf device identifiers */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFDEV_PF</span>		0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFDEV_PFM</span>		1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFDEV_MAX</span>		2

<span class="enscript-comment">/* rule flags */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PFRULE_DROP</span>		0x0000
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PFRULE_RETURNRST</span>	0x0001
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PFRULE_FRAGMENT</span>		0x0002
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PFRULE_RETURNICMP</span>	0x0004
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PFRULE_RETURN</span>		0x0008
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PFRULE_NOSYNC</span>		0x0010
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFRULE_SRCTRACK</span>		0x0020  <span class="enscript-comment">/* track source states */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFRULE_RULESRCTRACK</span>	0x0040  <span class="enscript-comment">/* per rule */</span>

<span class="enscript-comment">/* scrub flags */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PFRULE_NODF</span>		0x0100
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PFRULE_FRAGCROP</span>		0x0200	<span class="enscript-comment">/* non-buffering frag cache */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PFRULE_FRAGDROP</span>		0x0400	<span class="enscript-comment">/* drop funny fragments */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFRULE_RANDOMID</span>		0x0800
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFRULE_REASSEMBLE_TCP</span>	0x1000

<span class="enscript-comment">/* rule flags for TOS/DSCP/service class differentiation */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PFRULE_TOS</span>		0x2000
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PFRULE_DSCP</span>		0x4000
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PFRULE_SC</span>		0x8000

<span class="enscript-comment">/* rule flags again */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PFRULE_IFBOUND</span>		0x00010000	<span class="enscript-comment">/* if-bound */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PFRULE_PFM</span>		0x00020000	<span class="enscript-comment">/* created by pfm device */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PFSTATE_HIWAT</span>		10000	<span class="enscript-comment">/* default state table size */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PFSTATE_ADAPT_START</span>	6000	<span class="enscript-comment">/* default adaptive timeout start */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PFSTATE_ADAPT_END</span>	12000	<span class="enscript-comment">/* default adaptive timeout end */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PFAPPSTATE_HIWAT</span>	10000	<span class="enscript-comment">/* default same as state table */</span>

<span class="enscript-type">enum</span> pf_extmap {
	PF_EXTMAP_APD	= 1,	<span class="enscript-comment">/* Address-port-dependent mapping */</span>
	PF_EXTMAP_AD,		<span class="enscript-comment">/* Address-dependent mapping */</span>
	PF_EXTMAP_EI		<span class="enscript-comment">/* Endpoint-independent mapping */</span>
};

<span class="enscript-type">enum</span> pf_extfilter {
	PF_EXTFILTER_APD = 1,	<span class="enscript-comment">/* Address-port-dependent filtering */</span>
	PF_EXTFILTER_AD,	<span class="enscript-comment">/* Address-dependent filtering */</span>
	PF_EXTFILTER_EI		<span class="enscript-comment">/* Endpoint-independent filtering */</span>
};

<span class="enscript-type">struct</span> pf_threshold {
	u_int32_t	limit;
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PF_THRESHOLD_MULT</span>	1000
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_THRESHOLD_MAX</span>	0xffffffff / PF_THRESHOLD_MULT
	u_int32_t	seconds;
	u_int32_t	count;
	u_int32_t	last;
};

<span class="enscript-type">struct</span> pf_src_node {
	RB_ENTRY(pf_src_node) entry;
	<span class="enscript-type">struct</span> pf_addr	 addr;
	<span class="enscript-type">struct</span> pf_addr	 raddr;
	<span class="enscript-type">union</span> pf_rule_ptr rule;
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
	<span class="enscript-type">struct</span> pfi_kif	*kif;
#<span class="enscript-reference">else</span> <span class="enscript-comment">/* !KERNEL */</span>
	<span class="enscript-type">void</span>		*kif;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !KERNEL */</span>
	u_int64_t	 bytes[2];
	u_int64_t	 packets[2];
	u_int32_t	 states;
	u_int32_t	 conn;
	<span class="enscript-type">struct</span> pf_threshold	conn_rate;
	u_int64_t	 creation;
	u_int64_t	 expire;
	sa_family_t	 af;
	u_int8_t	 ruletype;
};

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFSNODE_HIWAT</span>		10000	<span class="enscript-comment">/* default source node table size */</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
<span class="enscript-type">struct</span> pf_state_scrub {
	<span class="enscript-type">struct</span> timeval	pfss_last;	<span class="enscript-comment">/* time received last packet	*/</span>
	u_int32_t	pfss_tsecr;	<span class="enscript-comment">/* last echoed timestamp	*/</span>
	u_int32_t	pfss_tsval;	<span class="enscript-comment">/* largest timestamp		*/</span>
	u_int32_t	pfss_tsval0;	<span class="enscript-comment">/* original timestamp		*/</span>
	u_int16_t	pfss_flags;
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFSS_TIMESTAMP</span>	0x0001		<span class="enscript-comment">/* modulate timestamp		*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFSS_PAWS</span>	0x0010		<span class="enscript-comment">/* stricter PAWS checks		*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFSS_PAWS_IDLED</span>	0x0020		<span class="enscript-comment">/* was idle too long.  no PAWS	*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFSS_DATA_TS</span>	0x0040		<span class="enscript-comment">/* timestamp on data packets	*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFSS_DATA_NOTS</span>	0x0080		<span class="enscript-comment">/* no timestamp on data packets	*/</span>
	u_int8_t	pfss_ttl;	<span class="enscript-comment">/* stashed TTL			*/</span>
	u_int8_t	pad;
	u_int32_t	pfss_ts_mod;	<span class="enscript-comment">/* timestamp modulation		*/</span>
};
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL */</span>

<span class="enscript-type">union</span> pf_state_xport {
	u_int16_t	port;
	u_int16_t	call_id;
	u_int32_t	spi;
};

<span class="enscript-type">struct</span> pf_state_host {
	<span class="enscript-type">struct</span> pf_addr		addr;
	<span class="enscript-type">union</span> pf_state_xport	xport;
};

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
<span class="enscript-type">struct</span> pf_state_peer {
	u_int32_t	seqlo;		<span class="enscript-comment">/* Max sequence number sent	*/</span>
	u_int32_t	seqhi;		<span class="enscript-comment">/* Max the other end ACKd + win	*/</span>
	u_int32_t	seqdiff;	<span class="enscript-comment">/* Sequence number modulator	*/</span>
	u_int16_t	max_win;	<span class="enscript-comment">/* largest window (pre scaling)	*/</span>
	u_int8_t	state;		<span class="enscript-comment">/* active state level		*/</span>
	u_int8_t	wscale;		<span class="enscript-comment">/* window scaling factor	*/</span>
	u_int16_t	mss;		<span class="enscript-comment">/* Maximum segment size option	*/</span>
	u_int8_t	tcp_est;	<span class="enscript-comment">/* Did we reach TCPS_ESTABLISHED */</span>
	<span class="enscript-type">struct</span> pf_state_scrub	*scrub;	<span class="enscript-comment">/* state is scrubbed		*/</span>
	u_int8_t	pad[3];
};

<span class="enscript-function-name">TAILQ_HEAD</span>(pf_state_queue, pf_state);

<span class="enscript-type">struct</span> pf_state;
<span class="enscript-type">struct</span> pf_pdesc;
<span class="enscript-type">struct</span> pf_app_state;

<span class="enscript-type">typedef</span> <span class="enscript-function-name">void</span> (*pf_app_handler)(<span class="enscript-type">struct</span> pf_state *, <span class="enscript-type">int</span>, <span class="enscript-type">int</span>, <span class="enscript-type">struct</span> pf_pdesc *,
	<span class="enscript-type">struct</span> pfi_kif *);

<span class="enscript-type">typedef</span> <span class="enscript-function-name">int</span> (*pf_app_compare)(<span class="enscript-type">struct</span> pf_app_state *, <span class="enscript-type">struct</span> pf_app_state *);

<span class="enscript-type">struct</span> pf_pptp_state {
	<span class="enscript-type">struct</span> pf_state *grev1_state;
};

<span class="enscript-type">struct</span> pf_grev1_state {
	<span class="enscript-type">struct</span> pf_state *pptp_state;
};

<span class="enscript-type">struct</span> pf_ike_state {
	u_int64_t cookie;
};

<span class="enscript-type">struct</span> pf_app_state {
	pf_app_handler	handler;
	pf_app_compare	compare_lan_ext;
	pf_app_compare	compare_ext_gwy;
	<span class="enscript-type">union</span> {
		<span class="enscript-type">struct</span> pf_pptp_state pptp;
		<span class="enscript-type">struct</span> pf_grev1_state grev1;
		<span class="enscript-type">struct</span> pf_ike_state ike;
	} u;
};

<span class="enscript-comment">/* keep synced with struct pf_state, used in RB_FIND */</span>
<span class="enscript-type">struct</span> pf_state_key_cmp {
	<span class="enscript-type">struct</span> pf_state_host lan;
	<span class="enscript-type">struct</span> pf_state_host gwy;
	<span class="enscript-type">struct</span> pf_state_host ext_lan;
	<span class="enscript-type">struct</span> pf_state_host ext_gwy;
	sa_family_t	 af_lan;
	sa_family_t	 af_gwy;
	u_int8_t	 proto;
	u_int8_t	 direction;
	u_int8_t	 proto_variant;
	<span class="enscript-type">struct</span> pf_app_state	*app_state;
};

<span class="enscript-function-name">TAILQ_HEAD</span>(pf_statelist, pf_state);

<span class="enscript-type">struct</span> pf_state_key {
	<span class="enscript-type">struct</span> pf_state_host lan;
	<span class="enscript-type">struct</span> pf_state_host gwy;
	<span class="enscript-type">struct</span> pf_state_host ext_lan;
	<span class="enscript-type">struct</span> pf_state_host ext_gwy;
	sa_family_t	 af_lan;
	sa_family_t	 af_gwy;
	u_int8_t	 proto;
	u_int8_t	 direction;
	u_int8_t	 proto_variant;
	<span class="enscript-type">struct</span> pf_app_state	*app_state;
	u_int32_t	 flowsrc;
	u_int32_t	 flowhash;

	RB_ENTRY(pf_state_key)	 entry_lan_ext;
	RB_ENTRY(pf_state_key)	 entry_ext_gwy;
	<span class="enscript-type">struct</span> pf_statelist	 states;
	u_int32_t	 refcnt;
};


<span class="enscript-comment">/* keep synced with struct pf_state, used in RB_FIND */</span>
<span class="enscript-type">struct</span> pf_state_cmp {
	u_int64_t	 id;
	u_int32_t	 creatorid;
	u_int32_t	 pad;
};

<span class="enscript-comment">/* flowhash key (12-bytes multiple for performance) */</span>
<span class="enscript-type">struct</span> pf_flowhash_key {
	<span class="enscript-type">struct</span> pf_state_host	ap1;	<span class="enscript-comment">/* address+port blob 1 */</span>
	<span class="enscript-type">struct</span> pf_state_host	ap2;	<span class="enscript-comment">/* address+port blob 2 */</span>
	u_int32_t		af;
	u_int32_t		proto;
};
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL */</span>

<span class="enscript-type">struct</span> hook_desc;
<span class="enscript-function-name">TAILQ_HEAD</span>(hook_desc_head, hook_desc);

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
<span class="enscript-type">struct</span> pf_state {
	u_int64_t		 id;
	u_int32_t		 creatorid;
	u_int32_t		 pad;

	TAILQ_ENTRY(pf_state)	 entry_list;
	TAILQ_ENTRY(pf_state)	 next;
	RB_ENTRY(pf_state)	 entry_id;
	<span class="enscript-type">struct</span> pf_state_peer	 src;
	<span class="enscript-type">struct</span> pf_state_peer	 dst;
	<span class="enscript-type">union</span> pf_rule_ptr	 rule;
	<span class="enscript-type">union</span> pf_rule_ptr	 anchor;
	<span class="enscript-type">union</span> pf_rule_ptr	 nat_rule;
	<span class="enscript-type">struct</span> pf_addr		 rt_addr;
	<span class="enscript-type">struct</span> hook_desc_head	 unlink_hooks;
	<span class="enscript-type">struct</span> pf_state_key	*state_key;
	<span class="enscript-type">struct</span> pfi_kif		*kif;
	<span class="enscript-type">struct</span> pfi_kif		*rt_kif;
	<span class="enscript-type">struct</span> pf_src_node	*src_node;
	<span class="enscript-type">struct</span> pf_src_node	*nat_src_node;
	u_int64_t		 packets[2];
	u_int64_t		 bytes[2];
	u_int64_t		 creation;
	u_int64_t		 expire;
	u_int64_t		 pfsync_time;
	u_int16_t		 tag;
	u_int8_t		 log;
	u_int8_t		 allow_opts;
	u_int8_t		 timeout;
	u_int8_t		 sync_flags;
};
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PFSTATE_NOSYNC</span>	 0x01
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PFSTATE_FROMSYNC</span> 0x02
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PFSTATE_STALE</span>	 0x04

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">__packed</span>	__attribute__((__packed__))

<span class="enscript-comment">/*
 * Unified state structures for pulling states out of the kernel
 * used by pfsync(4) and the pf(4) ioctl.
 */</span>
<span class="enscript-type">struct</span> pfsync_state_scrub {
	u_int16_t	pfss_flags;
	u_int8_t	pfss_ttl;	<span class="enscript-comment">/* stashed TTL		*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFSYNC_SCRUB_FLAG_VALID</span> 	0x01
	u_int8_t	scrub_flag;
	u_int32_t	pfss_ts_mod;	<span class="enscript-comment">/* timestamp modulation	*/</span>
} __packed;

<span class="enscript-type">struct</span> pfsync_state_host {
	<span class="enscript-type">struct</span> pf_addr		addr;
	<span class="enscript-type">union</span> pf_state_xport	xport;
	u_int16_t		pad[2];
} __packed;

<span class="enscript-type">struct</span> pfsync_state_peer {
	<span class="enscript-type">struct</span> pfsync_state_scrub scrub;	<span class="enscript-comment">/* state is scrubbed	*/</span>
	u_int32_t	seqlo;		<span class="enscript-comment">/* Max sequence number sent	*/</span>
	u_int32_t	seqhi;		<span class="enscript-comment">/* Max the other end ACKd + win	*/</span>
	u_int32_t	seqdiff;	<span class="enscript-comment">/* Sequence number modulator	*/</span>
	u_int16_t	max_win;	<span class="enscript-comment">/* largest window (pre scaling)	*/</span>
	u_int16_t	mss;		<span class="enscript-comment">/* Maximum segment size option	*/</span>
	u_int8_t	state;		<span class="enscript-comment">/* active state level		*/</span>
	u_int8_t	wscale;		<span class="enscript-comment">/* window scaling factor	*/</span>
	u_int8_t	pad[6];
} __packed;

<span class="enscript-type">struct</span> pfsync_state {
	u_int32_t	 id[2];
	<span class="enscript-type">char</span>		 ifname[IFNAMSIZ];
	<span class="enscript-type">struct</span> pfsync_state_host lan;
	<span class="enscript-type">struct</span> pfsync_state_host gwy;
	<span class="enscript-type">struct</span> pfsync_state_host ext_lan;
	<span class="enscript-type">struct</span> pfsync_state_host ext_gwy;
	<span class="enscript-type">struct</span> pfsync_state_peer src;
	<span class="enscript-type">struct</span> pfsync_state_peer dst;
	<span class="enscript-type">struct</span> pf_addr	 rt_addr;
	<span class="enscript-type">struct</span> hook_desc_head unlink_hooks;
#<span class="enscript-reference">if</span> !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__LP64__</span>)
	u_int32_t	_pad[2];
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !__LP64__ */</span>
	u_int32_t	 rule;
	u_int32_t	 anchor;
	u_int32_t	 nat_rule;
	u_int64_t	 creation;
	u_int64_t	 expire;
	u_int32_t	 packets[2][2];
	u_int32_t	 bytes[2][2];
	u_int32_t	 creatorid;
	u_int16_t	 tag;
	sa_family_t	 af_lan;
	sa_family_t	 af_gwy;
	u_int8_t	 proto;
	u_int8_t	 direction;
	u_int8_t	 log;
	u_int8_t	 allow_opts;
	u_int8_t	 timeout;
	u_int8_t	 sync_flags;
	u_int8_t	 updates;
	u_int8_t	 proto_variant;
	u_int8_t	 __pad;
	u_int32_t	 flowhash;
} __packed;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFSYNC_FLAG_COMPRESS</span>	0x01
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFSYNC_FLAG_STALE</span>	0x02
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFSYNC_FLAG_SRCNODE</span>	0x04
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFSYNC_FLAG_NATSRCNODE</span>	0x08

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
<span class="enscript-comment">/* for copies to/from userland via pf_ioctl() */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">pf_state_peer_to_pfsync</span>(s, d) do {	\
	(d)-&gt;seqlo = (s)-&gt;seqlo;		\
	(d)-&gt;seqhi = (s)-&gt;seqhi;		\
	(d)-&gt;seqdiff = (s)-&gt;seqdiff;		\
	(d)-&gt;max_win = (s)-&gt;max_win;		\
	(d)-&gt;mss = (s)-&gt;mss;			\
	(d)-&gt;state = (s)-&gt;state;		\
	(d)-&gt;wscale = (s)-&gt;wscale;		\
	<span class="enscript-keyword">if</span> ((s)-&gt;scrub) {						\
		(d)-&gt;scrub.pfss_flags =					\
		    (s)-&gt;scrub-&gt;pfss_flags &amp; PFSS_TIMESTAMP;		\
		(d)-&gt;scrub.pfss_ttl = (s)-&gt;scrub-&gt;pfss_ttl;		\
		(d)-&gt;scrub.pfss_ts_mod = (s)-&gt;scrub-&gt;pfss_ts_mod;	\
		(d)-&gt;scrub.scrub_flag = PFSYNC_SCRUB_FLAG_VALID;	\
	}								\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">pf_state_peer_from_pfsync</span>(s, d) do {	\
	(d)-&gt;seqlo = (s)-&gt;seqlo;		\
	(d)-&gt;seqhi = (s)-&gt;seqhi;		\
	(d)-&gt;seqdiff = (s)-&gt;seqdiff;		\
	(d)-&gt;max_win = (s)-&gt;max_win;		\
	(d)-&gt;mss = ntohs((s)-&gt;mss);		\
	(d)-&gt;state = (s)-&gt;state;		\
	(d)-&gt;wscale = (s)-&gt;wscale;		\
	<span class="enscript-keyword">if</span> ((s)-&gt;scrub.scrub_flag == PFSYNC_SCRUB_FLAG_VALID &amp;&amp;		\
	    (d)-&gt;scrub != NULL) {					\
		(d)-&gt;scrub-&gt;pfss_flags =				\
		    ntohs((s)-&gt;scrub.pfss_flags) &amp; PFSS_TIMESTAMP;	\
		(d)-&gt;scrub-&gt;pfss_ttl = (s)-&gt;scrub.pfss_ttl;		\
		(d)-&gt;scrub-&gt;pfss_ts_mod = (s)-&gt;scrub.pfss_ts_mod;	\
	}								\
} <span class="enscript-keyword">while</span> (0)
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL */</span>

#<span class="enscript-reference">define</span> <span class="enscript-function-name">pf_state_counter_to_pfsync</span>(s, d) do {			\
	d[0] = (s&gt;&gt;32)&amp;0xffffffff;				\
	d[1] = s&amp;0xffffffff;					\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">pf_state_counter_from_pfsync</span>(s)		\
	(((u_int64_t)(s[0])&lt;&lt;32) | (u_int64_t)(s[1]))



<span class="enscript-function-name">TAILQ_HEAD</span>(pf_rulequeue, pf_rule);

<span class="enscript-type">struct</span> pf_anchor;

<span class="enscript-type">struct</span> pf_ruleset {
	<span class="enscript-type">struct</span> {
		<span class="enscript-type">struct</span> pf_rulequeue	 queues[2];
		<span class="enscript-type">struct</span> {
			<span class="enscript-type">struct</span> pf_rulequeue	*ptr;
			<span class="enscript-type">struct</span> pf_rule		**ptr_array;
			u_int32_t		 rcount;
			u_int32_t		 ticket;
			<span class="enscript-type">int</span>			 open;
		}			 active, inactive;
	}			 rules[PF_RULESET_MAX];
	<span class="enscript-type">struct</span> pf_anchor	*anchor;
	u_int32_t		 tticket;
	<span class="enscript-type">int</span>			 tables;
	<span class="enscript-type">int</span>			 topen;
};

<span class="enscript-function-name">RB_HEAD</span>(pf_anchor_global, pf_anchor);
<span class="enscript-function-name">RB_HEAD</span>(pf_anchor_node, pf_anchor);
<span class="enscript-type">struct</span> pf_anchor {
	RB_ENTRY(pf_anchor)	 entry_global;
	RB_ENTRY(pf_anchor)	 entry_node;
	<span class="enscript-type">struct</span> pf_anchor	*parent;
	<span class="enscript-type">struct</span> pf_anchor_node	 children;
	<span class="enscript-type">char</span>			 name[PF_ANCHOR_NAME_SIZE];
	<span class="enscript-type">char</span>			 path[MAXPATHLEN];
	<span class="enscript-type">struct</span> pf_ruleset	 ruleset;
	<span class="enscript-type">int</span>			 refcnt;	<span class="enscript-comment">/* anchor rules */</span>
	<span class="enscript-type">int</span>			 match;
	<span class="enscript-type">char</span>			 owner[PF_OWNER_NAME_SIZE];
};
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
<span class="enscript-function-name">RB_PROTOTYPE_SC</span>(__private_extern__, pf_anchor_global, pf_anchor, entry_global,
    pf_anchor_compare);
<span class="enscript-function-name">RB_PROTOTYPE_SC</span>(__private_extern__, pf_anchor_node, pf_anchor, entry_node,
    pf_anchor_compare);
#<span class="enscript-reference">else</span> <span class="enscript-comment">/* !KERNEL */</span>
<span class="enscript-function-name">RB_PROTOTYPE</span>(pf_anchor_global, pf_anchor, entry_global, pf_anchor_compare);
<span class="enscript-function-name">RB_PROTOTYPE</span>(pf_anchor_node, pf_anchor, entry_node, pf_anchor_compare);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !KERNEL */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_RESERVED_ANCHOR</span>	<span class="enscript-string">&quot;_pf&quot;</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFR_TFLAG_PERSIST</span>	0x00000001
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFR_TFLAG_CONST</span>		0x00000002
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFR_TFLAG_ACTIVE</span>	0x00000004
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFR_TFLAG_INACTIVE</span>	0x00000008
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFR_TFLAG_REFERENCED</span>	0x00000010
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFR_TFLAG_REFDANCHOR</span>	0x00000020
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFR_TFLAG_USRMASK</span>	0x00000003
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFR_TFLAG_SETMASK</span>	0x0000003C
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFR_TFLAG_ALLMASK</span>	0x0000003F

<span class="enscript-type">struct</span> pfr_table {
	<span class="enscript-type">char</span>			 pfrt_anchor[MAXPATHLEN];
	<span class="enscript-type">char</span>			 pfrt_name[PF_TABLE_NAME_SIZE];
	u_int32_t		 pfrt_flags;
	u_int8_t		 pfrt_fback;
};

<span class="enscript-type">enum</span> { PFR_FB_NONE, PFR_FB_MATCH, PFR_FB_ADDED, PFR_FB_DELETED,
	PFR_FB_CHANGED, PFR_FB_CLEARED, PFR_FB_DUPLICATE,
	PFR_FB_NOTMATCH, PFR_FB_CONFLICT, PFR_FB_MAX };

<span class="enscript-type">struct</span> pfr_addr {
	<span class="enscript-type">union</span> {
		<span class="enscript-type">struct</span> in_addr	 _pfra_ip4addr;
		<span class="enscript-type">struct</span> in6_addr	 _pfra_ip6addr;
	}		 pfra_u;
	u_int8_t	 pfra_af;
	u_int8_t	 pfra_net;
	u_int8_t	 pfra_not;
	u_int8_t	 pfra_fback;
};
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">pfra_ip4addr</span>	pfra_u._pfra_ip4addr
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">pfra_ip6addr</span>	pfra_u._pfra_ip6addr

<span class="enscript-type">enum</span> { PFR_DIR_IN, PFR_DIR_OUT, PFR_DIR_MAX };
<span class="enscript-type">enum</span> { PFR_OP_BLOCK, PFR_OP_PASS, PFR_OP_ADDR_MAX, PFR_OP_TABLE_MAX };
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFR_OP_XPASS</span>	PFR_OP_ADDR_MAX

<span class="enscript-type">struct</span> pfr_astats {
	<span class="enscript-type">struct</span> pfr_addr	 pfras_a;
#<span class="enscript-reference">if</span> !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__LP64__</span>)
	u_int32_t	 _pad;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !__LP64__ */</span>
	u_int64_t	 pfras_packets[PFR_DIR_MAX][PFR_OP_ADDR_MAX];
	u_int64_t	 pfras_bytes[PFR_DIR_MAX][PFR_OP_ADDR_MAX];
	u_int64_t	 pfras_tzero;
};

<span class="enscript-type">enum</span> { PFR_REFCNT_RULE, PFR_REFCNT_ANCHOR, PFR_REFCNT_MAX };

<span class="enscript-type">struct</span> pfr_tstats {
	<span class="enscript-type">struct</span> pfr_table pfrts_t;
	u_int64_t	 pfrts_packets[PFR_DIR_MAX][PFR_OP_TABLE_MAX];
	u_int64_t	 pfrts_bytes[PFR_DIR_MAX][PFR_OP_TABLE_MAX];
	u_int64_t	 pfrts_match;
	u_int64_t	 pfrts_nomatch;
	u_int64_t	 pfrts_tzero;
	<span class="enscript-type">int</span>		 pfrts_cnt;
	<span class="enscript-type">int</span>		 pfrts_refcnt[PFR_REFCNT_MAX];
#<span class="enscript-reference">if</span> !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__LP64__</span>)
	u_int32_t	 _pad;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !__LP64__ */</span>
};
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">pfrts_name</span>	pfrts_t.pfrt_name
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">pfrts_flags</span>	pfrts_t.pfrt_flags

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
<span class="enscript-function-name">SLIST_HEAD</span>(pfr_kentryworkq, pfr_kentry);
<span class="enscript-type">struct</span> pfr_kentry {
	<span class="enscript-type">struct</span> radix_node	 pfrke_node[2];
	<span class="enscript-type">union</span> sockaddr_union	 pfrke_sa;
	u_int64_t		 pfrke_packets[PFR_DIR_MAX][PFR_OP_ADDR_MAX];
	u_int64_t		 pfrke_bytes[PFR_DIR_MAX][PFR_OP_ADDR_MAX];
	SLIST_ENTRY(pfr_kentry)	 pfrke_workq;
	u_int64_t		 pfrke_tzero;
	u_int8_t		 pfrke_af;
	u_int8_t		 pfrke_net;
	u_int8_t		 pfrke_not;
	u_int8_t		 pfrke_mark;
	u_int8_t		 pfrke_intrpool;
};

<span class="enscript-function-name">SLIST_HEAD</span>(pfr_ktableworkq, pfr_ktable);
<span class="enscript-function-name">RB_HEAD</span>(pfr_ktablehead, pfr_ktable);
<span class="enscript-type">struct</span> pfr_ktable {
	<span class="enscript-type">struct</span> pfr_tstats	 pfrkt_ts;
	RB_ENTRY(pfr_ktable)	 pfrkt_tree;
	SLIST_ENTRY(pfr_ktable)	 pfrkt_workq;
	<span class="enscript-type">struct</span> radix_node_head	*pfrkt_ip4;
	<span class="enscript-type">struct</span> radix_node_head	*pfrkt_ip6;
	<span class="enscript-type">struct</span> pfr_ktable	*pfrkt_shadow;
	<span class="enscript-type">struct</span> pfr_ktable	*pfrkt_root;
	<span class="enscript-type">struct</span> pf_ruleset	*pfrkt_rs;
	u_int64_t		 pfrkt_larg;
	u_int32_t		 pfrkt_nflags;
};
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">pfrkt_t</span>		pfrkt_ts.pfrts_t
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">pfrkt_name</span>	pfrkt_t.pfrt_name
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">pfrkt_anchor</span>	pfrkt_t.pfrt_anchor
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">pfrkt_ruleset</span>	pfrkt_t.pfrt_ruleset
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">pfrkt_flags</span>	pfrkt_t.pfrt_flags
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">pfrkt_cnt</span>	pfrkt_ts.pfrts_cnt
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">pfrkt_refcnt</span>	pfrkt_ts.pfrts_refcnt
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">pfrkt_packets</span>	pfrkt_ts.pfrts_packets
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">pfrkt_bytes</span>	pfrkt_ts.pfrts_bytes
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">pfrkt_match</span>	pfrkt_ts.pfrts_match
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">pfrkt_nomatch</span>	pfrkt_ts.pfrts_nomatch
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">pfrkt_tzero</span>	pfrkt_ts.pfrts_tzero

<span class="enscript-function-name">RB_HEAD</span>(pf_state_tree_lan_ext, pf_state_key);
<span class="enscript-function-name">RB_PROTOTYPE_SC</span>(__private_extern__, pf_state_tree_lan_ext, pf_state_key,
    entry_lan_ext, pf_state_compare_lan_ext);

<span class="enscript-function-name">RB_HEAD</span>(pf_state_tree_ext_gwy, pf_state_key);
<span class="enscript-function-name">RB_PROTOTYPE_SC</span>(__private_extern__, pf_state_tree_ext_gwy, pf_state_key,
    entry_ext_gwy, pf_state_compare_ext_gwy);

<span class="enscript-function-name">RB_HEAD</span>(pfi_ifhead, pfi_kif);

<span class="enscript-comment">/* state tables */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pf_state_tree_lan_ext	 pf_statetbl_lan_ext;
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pf_state_tree_ext_gwy	 pf_statetbl_ext_gwy;

<span class="enscript-comment">/* keep synced with pfi_kif, used in RB_FIND */</span>
<span class="enscript-type">struct</span> pfi_kif_cmp {
	<span class="enscript-type">char</span>				 pfik_name[IFNAMSIZ];
};

<span class="enscript-type">struct</span> pfi_kif {
	<span class="enscript-type">char</span>				 pfik_name[IFNAMSIZ];
	RB_ENTRY(pfi_kif)		 pfik_tree;
	u_int64_t			 pfik_packets[2][2][2];
	u_int64_t			 pfik_bytes[2][2][2];
	u_int64_t			 pfik_tzero;
	<span class="enscript-type">int</span>				 pfik_flags;
	<span class="enscript-type">void</span>				*pfik_ah_cookie;
	<span class="enscript-type">struct</span> ifnet			*pfik_ifp;
	<span class="enscript-type">int</span>				 pfik_states;
	<span class="enscript-type">int</span>				 pfik_rules;
	TAILQ_HEAD(, pfi_dynaddr)	 pfik_dynaddrs;
};

<span class="enscript-type">enum</span> pfi_kif_refs {
	PFI_KIF_REF_NONE,
	PFI_KIF_REF_STATE,
	PFI_KIF_REF_RULE
};

<span class="enscript-type">struct</span> pfi_uif {
#<span class="enscript-reference">else</span> <span class="enscript-comment">/* !KERNEL */</span>
<span class="enscript-type">struct</span> pfi_kif {
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !KERNEL */</span>
	<span class="enscript-type">char</span>				 pfik_name[IFNAMSIZ];
	u_int64_t			 pfik_packets[2][2][2];
	u_int64_t			 pfik_bytes[2][2][2];
	u_int64_t			 pfik_tzero;
	<span class="enscript-type">int</span>				 pfik_flags;
	<span class="enscript-type">int</span>				 pfik_states;
	<span class="enscript-type">int</span>				 pfik_rules;
#<span class="enscript-reference">if</span> !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__LP64__</span>)
	u_int32_t			 _pad;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !__LP64__ */</span>
};

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFI_IFLAG_SKIP</span>		0x0100	<span class="enscript-comment">/* skip filtering on interface */</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
<span class="enscript-type">struct</span> pf_pdesc {
	<span class="enscript-type">struct</span> {
		<span class="enscript-type">int</span>	 done;
		uid_t	 uid;
		gid_t	 gid;
		pid_t	 pid;
	}		 lookup;
	u_int64_t	 tot_len;	<span class="enscript-comment">/* Make Mickey money */</span>
	<span class="enscript-type">union</span> {
		<span class="enscript-type">struct</span> tcphdr		*tcp;
		<span class="enscript-type">struct</span> udphdr		*udp;
		<span class="enscript-type">struct</span> icmp		*icmp;
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET6</span>
		<span class="enscript-type">struct</span> icmp6_hdr	*icmp6;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* INET6 */</span>
		<span class="enscript-type">struct</span> pf_grev1_hdr	*grev1;
		<span class="enscript-type">struct</span> pf_esp_hdr	*esp;
		<span class="enscript-type">void</span>			*any;
	} hdr;

	<span class="enscript-comment">/* XXX TODO: Change baddr and naddr to *saddr */</span>
	<span class="enscript-type">struct</span> pf_addr	 baddr;		<span class="enscript-comment">/* src address before translation */</span>
	<span class="enscript-type">struct</span> pf_addr	 bdaddr;	<span class="enscript-comment">/* dst address before translation */</span>
	<span class="enscript-type">struct</span> pf_addr	 naddr;		<span class="enscript-comment">/* src address after translation */</span>
	<span class="enscript-type">struct</span> pf_addr	 ndaddr;	<span class="enscript-comment">/* dst address after translation */</span>
	<span class="enscript-type">struct</span> pf_rule	*nat_rule;	<span class="enscript-comment">/* nat/rdr rule applied to packet */</span>
	<span class="enscript-type">struct</span> pf_addr	*src;
	<span class="enscript-type">struct</span> pf_addr	*dst;
	<span class="enscript-type">struct</span> ether_header
			*eh;
	<span class="enscript-type">struct</span> mbuf	*mp;
	<span class="enscript-type">int</span>		lmw;		<span class="enscript-comment">/* lazy writable offset */</span>
	<span class="enscript-type">struct</span> pf_mtag	*pf_mtag;
	u_int16_t	*ip_sum;
	u_int32_t	 off;		<span class="enscript-comment">/* protocol header offset */</span>
	u_int32_t	 hdrlen;	<span class="enscript-comment">/* protocol header length */</span>
	u_int32_t	 p_len;		<span class="enscript-comment">/* total length of payload */</span>
	u_int16_t	 flags;		<span class="enscript-comment">/* Let SCRUB trigger behavior in */</span>
					<span class="enscript-comment">/* state code. Easier than tags */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFDESC_TCP_NORM</span>	0x0001		<span class="enscript-comment">/* TCP shall be statefully scrubbed */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFDESC_IP_REAS</span>	0x0002		<span class="enscript-comment">/* IP frags would've been reassembled */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFDESC_IP_FRAG</span>	0x0004		<span class="enscript-comment">/* This is a fragment */</span>
	sa_family_t	 af;
	sa_family_t	 naf;		<span class="enscript-comment">/*  address family after translation */</span>
	u_int8_t	 proto;
	u_int8_t	 tos;
	u_int8_t	 ttl;
	u_int8_t	 proto_variant;
	mbuf_svc_class_t sc;		<span class="enscript-comment">/* mbuf service class (MBUF_SVC) */</span>
	u_int32_t	 pktflags;	<span class="enscript-comment">/* mbuf packet flags (PKTF) */</span>
	u_int32_t	 flowsrc;	<span class="enscript-comment">/* flow source (FLOWSRC) */</span>
	u_int32_t	 flowhash;	<span class="enscript-comment">/* flow hash to identify the sender */</span>
};
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL */</span>

<span class="enscript-comment">/* flags for RDR options */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_DPORT_RANGE</span>	0x01		<span class="enscript-comment">/* Dest port uses range */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_RPORT_RANGE</span>	0x02		<span class="enscript-comment">/* RDR'ed port uses range */</span>

<span class="enscript-comment">/* Reasons code for passing/dropping a packet */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFRES_MATCH</span>	0		<span class="enscript-comment">/* Explicit match of a rule */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFRES_BADOFF</span>	1		<span class="enscript-comment">/* Bad offset for pull_hdr */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFRES_FRAG</span>	2		<span class="enscript-comment">/* Dropping following fragment */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFRES_SHORT</span>	3		<span class="enscript-comment">/* Dropping short packet */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFRES_NORM</span>	4		<span class="enscript-comment">/* Dropping by normalizer */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFRES_MEMORY</span>	5		<span class="enscript-comment">/* Dropped due to lacking mem */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFRES_TS</span>	6		<span class="enscript-comment">/* Bad TCP Timestamp (RFC1323) */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFRES_CONGEST</span>	7		<span class="enscript-comment">/* Congestion (of ipintrq) */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFRES_IPOPTIONS</span> 8		<span class="enscript-comment">/* IP option */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFRES_PROTCKSUM</span> 9		<span class="enscript-comment">/* Protocol checksum invalid */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFRES_BADSTATE</span>	10		<span class="enscript-comment">/* State mismatch */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFRES_STATEINS</span>	11		<span class="enscript-comment">/* State insertion failure */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFRES_MAXSTATES</span>	12		<span class="enscript-comment">/* State limit */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFRES_SRCLIMIT</span>	13		<span class="enscript-comment">/* Source node/conn limit */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFRES_SYNPROXY</span>	14		<span class="enscript-comment">/* SYN proxy */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFRES_DUMMYNET</span>	15		<span class="enscript-comment">/* Dummynet */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFRES_MAX</span>	16		<span class="enscript-comment">/* total+1 */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFRES_NAMES</span> { \
	<span class="enscript-string">&quot;match&quot;</span>, \
	<span class="enscript-string">&quot;bad-offset&quot;</span>, \
	<span class="enscript-string">&quot;fragment&quot;</span>, \
	<span class="enscript-string">&quot;short&quot;</span>, \
	<span class="enscript-string">&quot;normalize&quot;</span>, \
	<span class="enscript-string">&quot;memory&quot;</span>, \
	<span class="enscript-string">&quot;bad-timestamp&quot;</span>, \
	<span class="enscript-string">&quot;congestion&quot;</span>, \
	<span class="enscript-string">&quot;ip-option&quot;</span>, \
	<span class="enscript-string">&quot;proto-cksum&quot;</span>, \
	<span class="enscript-string">&quot;state-mismatch&quot;</span>, \
	<span class="enscript-string">&quot;state-insert&quot;</span>, \
	<span class="enscript-string">&quot;state-limit&quot;</span>, \
	<span class="enscript-string">&quot;src-limit&quot;</span>, \
	<span class="enscript-string">&quot;synproxy&quot;</span>, \
	<span class="enscript-string">&quot;dummynet&quot;</span>, \
	NULL \
}

<span class="enscript-comment">/* Counters for other things we want to keep track of */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LCNT_STATES</span>		0	<span class="enscript-comment">/* states */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LCNT_SRCSTATES</span>		1	<span class="enscript-comment">/* max-src-states */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LCNT_SRCNODES</span>		2	<span class="enscript-comment">/* max-src-nodes */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LCNT_SRCCONN</span>		3	<span class="enscript-comment">/* max-src-conn */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LCNT_SRCCONNRATE</span>	4	<span class="enscript-comment">/* max-src-conn-rate */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LCNT_OVERLOAD_TABLE</span>	5	<span class="enscript-comment">/* entry added to overload table */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LCNT_OVERLOAD_FLUSH</span>	6	<span class="enscript-comment">/* state entries flushed */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LCNT_MAX</span>		7	<span class="enscript-comment">/* total+1 */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LCNT_NAMES</span> { \
	<span class="enscript-string">&quot;max states per rule&quot;</span>, \
	<span class="enscript-string">&quot;max-src-states&quot;</span>, \
	<span class="enscript-string">&quot;max-src-nodes&quot;</span>, \
	<span class="enscript-string">&quot;max-src-conn&quot;</span>, \
	<span class="enscript-string">&quot;max-src-conn-rate&quot;</span>, \
	<span class="enscript-string">&quot;overload table insertion&quot;</span>, \
	<span class="enscript-string">&quot;overload flush states&quot;</span>, \
	NULL \
}

<span class="enscript-comment">/* UDP state enumeration */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFUDPS_NO_TRAFFIC</span>	0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFUDPS_SINGLE</span>		1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFUDPS_MULTIPLE</span>		2

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFUDPS_NSTATES</span>		3	<span class="enscript-comment">/* number of state levels */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFUDPS_NAMES</span> { \
	<span class="enscript-string">&quot;NO_TRAFFIC&quot;</span>, \
	<span class="enscript-string">&quot;SINGLE&quot;</span>, \
	<span class="enscript-string">&quot;MULTIPLE&quot;</span>, \
	NULL \
}

<span class="enscript-comment">/* GREv1 protocol state enumeration */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFGRE1S_NO_TRAFFIC</span>		0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFGRE1S_INITIATING</span>		1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFGRE1S_ESTABLISHED</span>		2

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFGRE1S_NSTATES</span>			3	<span class="enscript-comment">/* number of state levels */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFGRE1S_NAMES</span> { \
	<span class="enscript-string">&quot;NO_TRAFFIC&quot;</span>, \
	<span class="enscript-string">&quot;INITIATING&quot;</span>, \
	<span class="enscript-string">&quot;ESTABLISHED&quot;</span>, \
	NULL \
}

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFESPS_NO_TRAFFIC</span>	0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFESPS_INITIATING</span>	1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFESPS_ESTABLISHED</span>	2

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFESPS_NSTATES</span>		3	<span class="enscript-comment">/* number of state levels */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFESPS_NAMES</span> { <span class="enscript-string">&quot;NO_TRAFFIC&quot;</span>, <span class="enscript-string">&quot;INITIATING&quot;</span>, <span class="enscript-string">&quot;ESTABLISHED&quot;</span>, NULL }

<span class="enscript-comment">/* Other protocol state enumeration */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFOTHERS_NO_TRAFFIC</span>	0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFOTHERS_SINGLE</span>		1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFOTHERS_MULTIPLE</span>	2

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFOTHERS_NSTATES</span>	3	<span class="enscript-comment">/* number of state levels */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFOTHERS_NAMES</span> { \
	<span class="enscript-string">&quot;NO_TRAFFIC&quot;</span>, \
	<span class="enscript-string">&quot;SINGLE&quot;</span>, \
	<span class="enscript-string">&quot;MULTIPLE&quot;</span>, \
	NULL \
}

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">FCNT_STATE_SEARCH</span>	0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">FCNT_STATE_INSERT</span>	1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">FCNT_STATE_REMOVALS</span>	2
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">FCNT_MAX</span>		3

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SCNT_SRC_NODE_SEARCH</span>	0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SCNT_SRC_NODE_INSERT</span>	1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SCNT_SRC_NODE_REMOVALS</span>	2
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SCNT_MAX</span>		3

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">ACTION_SET</span>(a, x) \
	<span class="enscript-keyword">do</span> { \
		<span class="enscript-keyword">if</span> ((a) != NULL) \
			*(a) = (x); \
	} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">REASON_SET</span>(a, x) \
	<span class="enscript-keyword">do</span> { \
		<span class="enscript-keyword">if</span> ((a) != NULL) \
			*(a) = (x); \
		<span class="enscript-keyword">if</span> (x &lt; PFRES_MAX) \
			pf_status.counters[x]++; \
	} <span class="enscript-keyword">while</span> (0)
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL */</span>

<span class="enscript-type">struct</span> pf_status {
	u_int64_t	counters[PFRES_MAX];
	u_int64_t	lcounters[LCNT_MAX];	<span class="enscript-comment">/* limit counters */</span>
	u_int64_t	fcounters[FCNT_MAX];
	u_int64_t	scounters[SCNT_MAX];
	u_int64_t	pcounters[2][2][3];
	u_int64_t	bcounters[2][2];
	u_int64_t	stateid;
	u_int32_t	running;
	u_int32_t	states;
	u_int32_t	src_nodes;
	u_int64_t	since			__attribute__((aligned(8)));
	u_int32_t	debug;
	u_int32_t	hostid;
	<span class="enscript-type">char</span>		ifname[IFNAMSIZ];
	u_int8_t	pf_chksum[PF_MD5_DIGEST_LENGTH];
};

<span class="enscript-type">struct</span> cbq_opts {
	u_int32_t	minburst;
	u_int32_t	maxburst;
	u_int32_t	pktsize;
	u_int32_t	maxpktsize;
	u_int32_t	ns_per_byte;
	u_int32_t	maxidle;
	int32_t		minidle;
	u_int32_t	offtime;
	u_int32_t	flags;
};

<span class="enscript-type">struct</span> priq_opts {
	u_int32_t	flags;
};

<span class="enscript-type">struct</span> qfq_opts {
	u_int32_t	flags;
	u_int32_t	lmax;
};

<span class="enscript-type">struct</span> hfsc_opts {
	<span class="enscript-comment">/* real-time service curve */</span>
	u_int64_t	rtsc_m1;	<span class="enscript-comment">/* slope of the 1st segment in bps */</span>
	u_int64_t	rtsc_d;		<span class="enscript-comment">/* the x-projection of m1 in msec */</span>
	u_int64_t	rtsc_m2;	<span class="enscript-comment">/* slope of the 2nd segment in bps */</span>
	u_int32_t	rtsc_fl;	<span class="enscript-comment">/* service curve flags */</span>
#<span class="enscript-reference">if</span> !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__LP64__</span>)
	u_int32_t	_pad;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !__LP64__ */</span>
	<span class="enscript-comment">/* link-sharing service curve */</span>
	u_int64_t	lssc_m1;
	u_int64_t	lssc_d;
	u_int64_t	lssc_m2;
	u_int32_t	lssc_fl;
#<span class="enscript-reference">if</span> !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__LP64__</span>)
	u_int32_t	__pad;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !__LP64__ */</span>
	<span class="enscript-comment">/* upper-limit service curve */</span>
	u_int64_t	ulsc_m1;
	u_int64_t	ulsc_d;
	u_int64_t	ulsc_m2;
	u_int32_t	ulsc_fl;
	u_int32_t	flags;		<span class="enscript-comment">/* scheduler flags */</span>
};

<span class="enscript-type">struct</span> fairq_opts {
	u_int32_t	nbuckets;	<span class="enscript-comment">/* hash buckets */</span>
	u_int32_t	flags;
	u_int64_t	hogs_m1;	<span class="enscript-comment">/* hog detection bandwidth */</span>

	<span class="enscript-comment">/* link-sharing service curve */</span>
	u_int64_t	lssc_m1;
	u_int64_t	lssc_d;
	u_int64_t	lssc_m2;
};

<span class="enscript-comment">/* bandwidth types */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_ALTQ_BW_ABSOLUTE</span>	1	<span class="enscript-comment">/* bw in absolute value (bps) */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_ALTQ_BW_PERCENT</span>	2	<span class="enscript-comment">/* bandwidth in percentage */</span>

<span class="enscript-comment">/* ALTQ rule flags */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PF_ALTQF_TBR</span>		0x1	<span class="enscript-comment">/* enable Token Bucket Regulator */</span>

<span class="enscript-comment">/* queue rule flags */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PF_ALTQ_QRF_WEIGHT</span>	0x1	<span class="enscript-comment">/* weight instead of priority */</span>

<span class="enscript-type">struct</span> pf_altq {
	<span class="enscript-type">char</span>			 ifname[IFNAMSIZ];

	<span class="enscript-comment">/* discipline-specific state */</span>
	<span class="enscript-type">void</span>			*altq_disc __attribute__((aligned(8)));
	TAILQ_ENTRY(pf_altq)	 entries __attribute__((aligned(8)));
#<span class="enscript-reference">if</span> !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__LP64__</span>)
	u_int32_t		_pad[2];
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !__LP64__ */</span>

	u_int32_t		 aflags;	<span class="enscript-comment">/* ALTQ rule flags */</span>
	u_int32_t		 bwtype;	<span class="enscript-comment">/* bandwidth type */</span>

	<span class="enscript-comment">/* scheduler spec */</span>
	u_int32_t		 scheduler;	<span class="enscript-comment">/* scheduler type */</span>
	u_int32_t		 tbrsize;	<span class="enscript-comment">/* tokenbucket regulator size */</span>
	u_int64_t		 ifbandwidth;	<span class="enscript-comment">/* interface bandwidth */</span>

	<span class="enscript-comment">/* queue spec */</span>
	<span class="enscript-type">char</span>			 qname[PF_QNAME_SIZE];	<span class="enscript-comment">/* queue name */</span>
	<span class="enscript-type">char</span>			 parent[PF_QNAME_SIZE];	<span class="enscript-comment">/* parent name */</span>
	u_int32_t		 parent_qid;	<span class="enscript-comment">/* parent queue id */</span>
	u_int32_t		 qrflags;	<span class="enscript-comment">/* queue rule flags */</span>
	<span class="enscript-type">union</span> {
		u_int32_t	 priority;	<span class="enscript-comment">/* priority */</span>
		u_int32_t	 weight;	<span class="enscript-comment">/* weight */</span>
	};
	u_int32_t		 qlimit;	<span class="enscript-comment">/* queue size limit */</span>
	u_int32_t		 flags;		<span class="enscript-comment">/* misc flags */</span>
#<span class="enscript-reference">if</span> !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__LP64__</span>)
	u_int32_t		__pad;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !__LP64__ */</span>
	u_int64_t		 bandwidth;	<span class="enscript-comment">/* queue bandwidth */</span>
	<span class="enscript-type">union</span> {
		<span class="enscript-type">struct</span> cbq_opts		 cbq_opts;
		<span class="enscript-type">struct</span> priq_opts	 priq_opts;
		<span class="enscript-type">struct</span> hfsc_opts	 hfsc_opts;
		<span class="enscript-type">struct</span> fairq_opts	 fairq_opts;
		<span class="enscript-type">struct</span> qfq_opts		 qfq_opts;
	} pq_u;

	u_int32_t		 qid;		<span class="enscript-comment">/* return value */</span>
};

<span class="enscript-type">struct</span> pf_tagname {
	TAILQ_ENTRY(pf_tagname)	entries;
	<span class="enscript-type">char</span>			name[PF_TAG_NAME_SIZE];
	u_int16_t		tag;
	<span class="enscript-type">int</span>			ref;
};

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFFRAG_FRENT_HIWAT</span>	5000	<span class="enscript-comment">/* Number of fragment entries */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFFRAG_FRAG_HIWAT</span>	1000	<span class="enscript-comment">/* Number of fragmented packets */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFFRAG_FRCENT_HIWAT</span>	50000	<span class="enscript-comment">/* Number of fragment cache entries */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFFRAG_FRCACHE_HIWAT</span>	10000	<span class="enscript-comment">/* Number of fragment descriptors */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFR_KTABLE_HIWAT</span>	1000	<span class="enscript-comment">/* Number of tables */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFR_KENTRY_HIWAT</span>	200000	<span class="enscript-comment">/* Number of table entries */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFR_KENTRY_HIWAT_SMALL</span>	100000	<span class="enscript-comment">/* Number of table entries (tiny hosts) */</span>

<span class="enscript-comment">/*
 * ioctl parameter structures
 */</span>

<span class="enscript-type">struct</span> pfioc_pooladdr {
	u_int32_t		 action;
	u_int32_t		 ticket;
	u_int32_t		 nr;
	u_int32_t		 r_num;
	u_int8_t		 r_action;
	u_int8_t		 r_last;
	u_int8_t		 af;
	<span class="enscript-type">char</span>			 anchor[MAXPATHLEN];
	<span class="enscript-type">struct</span> pf_pooladdr	 addr;
};

<span class="enscript-type">struct</span> pfioc_rule {
	u_int32_t	 action;
	u_int32_t	 ticket;
	u_int32_t	 pool_ticket;
	u_int32_t	 nr;
	<span class="enscript-type">char</span>		 anchor[MAXPATHLEN];
	<span class="enscript-type">char</span>		 anchor_call[MAXPATHLEN];
	<span class="enscript-type">struct</span> pf_rule	 rule;
};

<span class="enscript-type">struct</span> pfioc_natlook {
	<span class="enscript-type">struct</span> pf_addr	 saddr;
	<span class="enscript-type">struct</span> pf_addr	 daddr;
	<span class="enscript-type">struct</span> pf_addr	 rsaddr;
	<span class="enscript-type">struct</span> pf_addr	 rdaddr;
	<span class="enscript-type">union</span> pf_state_xport	sxport;
	<span class="enscript-type">union</span> pf_state_xport	dxport;
	<span class="enscript-type">union</span> pf_state_xport	rsxport;
	<span class="enscript-type">union</span> pf_state_xport	rdxport;
	sa_family_t	 af;
	u_int8_t	 proto;
	u_int8_t	 proto_variant;
	u_int8_t	 direction;
};

<span class="enscript-type">struct</span> pfioc_state {
	<span class="enscript-type">struct</span> pfsync_state	state;
};

<span class="enscript-type">struct</span> pfioc_src_node_kill {
	<span class="enscript-comment">/* XXX returns the number of src nodes killed in psnk_af */</span>
	sa_family_t psnk_af;
	<span class="enscript-type">struct</span> pf_rule_addr psnk_src;
	<span class="enscript-type">struct</span> pf_rule_addr psnk_dst;
};

<span class="enscript-type">struct</span> pfioc_state_addr_kill {
	<span class="enscript-type">struct</span> pf_addr_wrap		addr;
	u_int8_t			reserved_[3];
	u_int8_t			neg;
	<span class="enscript-type">union</span> pf_rule_xport		xport;
};

<span class="enscript-type">struct</span> pfioc_state_kill {
	<span class="enscript-comment">/* XXX returns the number of states killed in psk_af */</span>
	sa_family_t		psk_af;
	u_int8_t		psk_proto;
	u_int8_t		psk_proto_variant;
	u_int8_t		_pad;
	<span class="enscript-type">struct</span> pfioc_state_addr_kill	psk_src;
	<span class="enscript-type">struct</span> pfioc_state_addr_kill	psk_dst;
	<span class="enscript-type">char</span>			psk_ifname[IFNAMSIZ];
	<span class="enscript-type">char</span>			psk_ownername[PF_OWNER_NAME_SIZE];
};

<span class="enscript-type">struct</span> pfioc_states {
	<span class="enscript-type">int</span>	ps_len;
	<span class="enscript-type">union</span> {
		caddr_t			 psu_buf;
		<span class="enscript-type">struct</span> pfsync_state	*psu_states;
	} ps_u __attribute__((aligned(8)));
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ps_buf</span>		ps_u.psu_buf
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ps_states</span>	ps_u.psu_states
};

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
<span class="enscript-type">struct</span> pfioc_states_32 {
	<span class="enscript-type">int</span>	ps_len;
	<span class="enscript-type">union</span> {
		user32_addr_t		psu_buf;
		user32_addr_t		psu_states;
	} ps_u __attribute__((aligned(8)));
};

<span class="enscript-type">struct</span> pfioc_states_64 {
	<span class="enscript-type">int</span>	ps_len;
	<span class="enscript-type">union</span> {
		user64_addr_t		psu_buf;
		user64_addr_t		psu_states;
	} ps_u __attribute__((aligned(8)));
};
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFTOK_PROCNAME_LEN</span>    64
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">pack</span>(1)
<span class="enscript-type">struct</span> pfioc_token {
	u_int64_t			token_value;
	u_int64_t			timestamp;
	pid_t				pid;
	<span class="enscript-type">char</span>				proc_name[PFTOK_PROCNAME_LEN];
};
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">pack</span>()

<span class="enscript-type">struct</span> pfioc_kernel_token {
	SLIST_ENTRY(pfioc_kernel_token)	next;
	<span class="enscript-type">struct</span> pfioc_token		token;
};

<span class="enscript-type">struct</span> pfioc_remove_token {
	u_int64_t                token_value;
	u_int64_t                refcount;
};

<span class="enscript-type">struct</span> pfioc_tokens {
	<span class="enscript-type">int</span>	size;
	<span class="enscript-type">union</span> {
		caddr_t				pgtu_buf;
		<span class="enscript-type">struct</span> pfioc_token		*pgtu_tokens;
	} pgt_u __attribute__((aligned(8)));
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">pgt_buf</span>		pgt_u.pgtu_buf
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">pgt_tokens</span>	pgt_u.pgtu_tokens
};

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
<span class="enscript-type">struct</span> pfioc_tokens_32 {
	<span class="enscript-type">int</span>	size;
	<span class="enscript-type">union</span> {
		user32_addr_t		pgtu_buf;
		user32_addr_t		pgtu_tokens;
	} pgt_u __attribute__((aligned(8)));
};

<span class="enscript-type">struct</span> pfioc_tokens_64 {
	<span class="enscript-type">int</span>	size;
	<span class="enscript-type">union</span> {
		user64_addr_t		pgtu_buf;
		user64_addr_t		pgtu_tokens;
	} pgt_u __attribute__((aligned(8)));
};
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL */</span>


<span class="enscript-type">struct</span> pfioc_src_nodes {
	<span class="enscript-type">int</span>	psn_len;
	<span class="enscript-type">union</span> {
		caddr_t			psu_buf;
		<span class="enscript-type">struct</span> pf_src_node	*psu_src_nodes;
	} psn_u __attribute__((aligned(8)));
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">psn_buf</span>		psn_u.psu_buf
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">psn_src_nodes</span>	psn_u.psu_src_nodes
};

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
<span class="enscript-type">struct</span> pfioc_src_nodes_32 {
	<span class="enscript-type">int</span>	psn_len;
	<span class="enscript-type">union</span> {
		user32_addr_t		psu_buf;
		user32_addr_t		psu_src_nodes;
	} psn_u __attribute__((aligned(8)));
};

<span class="enscript-type">struct</span> pfioc_src_nodes_64 {
	<span class="enscript-type">int</span>	psn_len;
	<span class="enscript-type">union</span> {
		user64_addr_t		psu_buf;
		user64_addr_t		psu_src_nodes;
	} psn_u __attribute__((aligned(8)));
};
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL */</span>

<span class="enscript-type">struct</span> pfioc_if {
	<span class="enscript-type">char</span>		 ifname[IFNAMSIZ];
};

<span class="enscript-type">struct</span> pfioc_tm {
	<span class="enscript-type">int</span>		 timeout;
	<span class="enscript-type">int</span>		 seconds;
};

<span class="enscript-type">struct</span> pfioc_limit {
	<span class="enscript-type">int</span>		 index;
	<span class="enscript-type">unsigned</span>	 limit;
};

<span class="enscript-type">struct</span> pfioc_altq {
	u_int32_t	 action;
	u_int32_t	 ticket;
	u_int32_t	 nr;
	<span class="enscript-type">struct</span> pf_altq	 altq			__attribute__((aligned(8)));
};

<span class="enscript-type">struct</span> pfioc_qstats {
	u_int32_t	 ticket;
	u_int32_t	 nr;
	<span class="enscript-type">void</span>		*buf			__attribute__((aligned(8)));
	<span class="enscript-type">int</span>		 nbytes			__attribute__((aligned(8)));
	u_int8_t	 scheduler;
};

<span class="enscript-type">struct</span> pfioc_ruleset {
	u_int32_t	 nr;
	<span class="enscript-type">char</span>		 path[MAXPATHLEN];
	<span class="enscript-type">char</span>		 name[PF_ANCHOR_NAME_SIZE];
};

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_RULESET_ALTQ</span>		(PF_RULESET_MAX)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_RULESET_TABLE</span>	(PF_RULESET_MAX+1)
<span class="enscript-type">struct</span> pfioc_trans {
	<span class="enscript-type">int</span>		 size;	<span class="enscript-comment">/* number of elements */</span>
	<span class="enscript-type">int</span>		 esize; <span class="enscript-comment">/* size of each element in bytes */</span>
	<span class="enscript-type">struct</span> pfioc_trans_e {
		<span class="enscript-type">int</span>		rs_num;
		<span class="enscript-type">char</span>		anchor[MAXPATHLEN];
		u_int32_t	ticket;
	} *array __attribute__((aligned(8)));
};

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
<span class="enscript-type">struct</span> pfioc_trans_32 {
	<span class="enscript-type">int</span>		 size;	<span class="enscript-comment">/* number of elements */</span>
	<span class="enscript-type">int</span>		 esize; <span class="enscript-comment">/* size of each element in bytes */</span>
	user32_addr_t	 array __attribute__((aligned(8)));
};

<span class="enscript-type">struct</span> pfioc_trans_64 {
	<span class="enscript-type">int</span>		 size;	<span class="enscript-comment">/* number of elements */</span>
	<span class="enscript-type">int</span>		 esize; <span class="enscript-comment">/* size of each element in bytes */</span>
	user64_addr_t	 array __attribute__((aligned(8)));
};
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL */</span>


#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFR_FLAG_ATOMIC</span>		0x00000001
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFR_FLAG_DUMMY</span>		0x00000002
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFR_FLAG_FEEDBACK</span>	0x00000004
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFR_FLAG_CLSTATS</span>	0x00000008
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFR_FLAG_ADDRSTOO</span>	0x00000010
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFR_FLAG_REPLACE</span>	0x00000020
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFR_FLAG_ALLRSETS</span>	0x00000040
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFR_FLAG_ALLMASK</span>	0x0000007F
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PFR_FLAG_USERIOCTL</span>	0x10000000
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL */</span>

<span class="enscript-type">struct</span> pfioc_table {
	<span class="enscript-type">struct</span> pfr_table	 pfrio_table;
	<span class="enscript-type">void</span>			*pfrio_buffer	__attribute__((aligned(8)));
	<span class="enscript-type">int</span>			 pfrio_esize	__attribute__((aligned(8)));
	<span class="enscript-type">int</span>			 pfrio_size;
	<span class="enscript-type">int</span>			 pfrio_size2;
	<span class="enscript-type">int</span>			 pfrio_nadd;
	<span class="enscript-type">int</span>			 pfrio_ndel;
	<span class="enscript-type">int</span>			 pfrio_nchange;
	<span class="enscript-type">int</span>			 pfrio_flags;
	u_int32_t		 pfrio_ticket;
};
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">pfrio_exists</span>	pfrio_nadd
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">pfrio_nzero</span>	pfrio_nadd
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">pfrio_nmatch</span>	pfrio_nadd
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">pfrio_naddr</span>	pfrio_size2
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">pfrio_setflag</span>	pfrio_size2
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">pfrio_clrflag</span>	pfrio_nadd

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
<span class="enscript-type">struct</span> pfioc_table_32 {
	<span class="enscript-type">struct</span> pfr_table	 pfrio_table;
	user32_addr_t		 pfrio_buffer	__attribute__((aligned(8)));
	<span class="enscript-type">int</span>			 pfrio_esize	__attribute__((aligned(8)));
	<span class="enscript-type">int</span>			 pfrio_size;
	<span class="enscript-type">int</span>			 pfrio_size2;
	<span class="enscript-type">int</span>			 pfrio_nadd;
	<span class="enscript-type">int</span>			 pfrio_ndel;
	<span class="enscript-type">int</span>			 pfrio_nchange;
	<span class="enscript-type">int</span>			 pfrio_flags;
	u_int32_t		 pfrio_ticket;
};

<span class="enscript-type">struct</span> pfioc_table_64 {
	<span class="enscript-type">struct</span> pfr_table	 pfrio_table;
	user64_addr_t		 pfrio_buffer	__attribute__((aligned(8)));
	<span class="enscript-type">int</span>			 pfrio_esize	__attribute__((aligned(8)));
	<span class="enscript-type">int</span>			 pfrio_size;
	<span class="enscript-type">int</span>			 pfrio_size2;
	<span class="enscript-type">int</span>			 pfrio_nadd;
	<span class="enscript-type">int</span>			 pfrio_ndel;
	<span class="enscript-type">int</span>			 pfrio_nchange;
	<span class="enscript-type">int</span>			 pfrio_flags;
	u_int32_t		 pfrio_ticket;
};
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL */</span>

<span class="enscript-type">struct</span> pfioc_iface {
	<span class="enscript-type">char</span>	 pfiio_name[IFNAMSIZ];
	<span class="enscript-type">void</span>	*pfiio_buffer			__attribute__((aligned(8)));
	<span class="enscript-type">int</span>	 pfiio_esize			__attribute__((aligned(8)));
	<span class="enscript-type">int</span>	 pfiio_size;
	<span class="enscript-type">int</span>	 pfiio_nzero;
	<span class="enscript-type">int</span>	 pfiio_flags;
};

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
<span class="enscript-type">struct</span> pfioc_iface_32 {
	<span class="enscript-type">char</span>	 pfiio_name[IFNAMSIZ];
	user32_addr_t pfiio_buffer		__attribute__((aligned(8)));
	<span class="enscript-type">int</span>	 pfiio_esize			__attribute__((aligned(8)));
	<span class="enscript-type">int</span>	 pfiio_size;
	<span class="enscript-type">int</span>	 pfiio_nzero;
	<span class="enscript-type">int</span>	 pfiio_flags;
};

<span class="enscript-type">struct</span> pfioc_iface_64 {
	<span class="enscript-type">char</span>	 pfiio_name[IFNAMSIZ];
	user64_addr_t pfiio_buffer		__attribute__((aligned(8)));
	<span class="enscript-type">int</span>	 pfiio_esize			__attribute__((aligned(8)));
	<span class="enscript-type">int</span>	 pfiio_size;
	<span class="enscript-type">int</span>	 pfiio_nzero;
	<span class="enscript-type">int</span>	 pfiio_flags;
};
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL */</span>

<span class="enscript-type">struct</span> pf_ifspeed {
	<span class="enscript-type">char</span>			ifname[IFNAMSIZ];
	u_int64_t		baudrate;
};

<span class="enscript-comment">/*
 * ioctl operations
 */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCSTART</span>	_IO  (<span class="enscript-string">'D'</span>,  1)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCSTOP</span>	_IO  (<span class="enscript-string">'D'</span>,  2)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCADDRULE</span>	_IOWR(<span class="enscript-string">'D'</span>,  4, struct pfioc_rule)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCGETSTARTERS</span>	_IOWR(<span class="enscript-string">'D'</span>,  5, struct pfioc_tokens)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCGETRULES</span>	_IOWR(<span class="enscript-string">'D'</span>,  6, struct pfioc_rule)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCGETRULE</span>	_IOWR(<span class="enscript-string">'D'</span>,  7, struct pfioc_rule)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCSTARTREF</span>	_IOR (<span class="enscript-string">'D'</span>,  8, u_int64_t)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCSTOPREF</span>	_IOWR(<span class="enscript-string">'D'</span>,  9, struct pfioc_remove_token)
<span class="enscript-comment">/* XXX cut 10 - 17 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCCLRSTATES</span>	_IOWR(<span class="enscript-string">'D'</span>, 18, struct pfioc_state_kill)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCGETSTATE</span>	_IOWR(<span class="enscript-string">'D'</span>, 19, struct pfioc_state)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCSETSTATUSIF</span>	_IOWR(<span class="enscript-string">'D'</span>, 20, struct pfioc_if)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCGETSTATUS</span>	_IOWR(<span class="enscript-string">'D'</span>, 21, struct pf_status)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCCLRSTATUS</span>	_IO  (<span class="enscript-string">'D'</span>, 22)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCNATLOOK</span>	_IOWR(<span class="enscript-string">'D'</span>, 23, struct pfioc_natlook)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCSETDEBUG</span>	_IOWR(<span class="enscript-string">'D'</span>, 24, u_int32_t)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCGETSTATES</span>	_IOWR(<span class="enscript-string">'D'</span>, 25, struct pfioc_states)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCCHANGERULE</span>	_IOWR(<span class="enscript-string">'D'</span>, 26, struct pfioc_rule)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCINSERTRULE</span>	_IOWR(<span class="enscript-string">'D'</span>,  27, struct pfioc_rule)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCDELETERULE</span>	_IOWR(<span class="enscript-string">'D'</span>,  28, struct pfioc_rule)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCSETTIMEOUT</span>	_IOWR(<span class="enscript-string">'D'</span>, 29, struct pfioc_tm)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCGETTIMEOUT</span>	_IOWR(<span class="enscript-string">'D'</span>, 30, struct pfioc_tm)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCADDSTATE</span>	_IOWR(<span class="enscript-string">'D'</span>, 37, struct pfioc_state)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCCLRRULECTRS</span>	_IO  (<span class="enscript-string">'D'</span>, 38)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCGETLIMIT</span>	_IOWR(<span class="enscript-string">'D'</span>, 39, struct pfioc_limit)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCSETLIMIT</span>	_IOWR(<span class="enscript-string">'D'</span>, 40, struct pfioc_limit)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCKILLSTATES</span>	_IOWR(<span class="enscript-string">'D'</span>, 41, struct pfioc_state_kill)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCSTARTALTQ</span>	_IO  (<span class="enscript-string">'D'</span>, 42)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCSTOPALTQ</span>	_IO  (<span class="enscript-string">'D'</span>, 43)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCADDALTQ</span>	_IOWR(<span class="enscript-string">'D'</span>, 45, struct pfioc_altq)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCGETALTQS</span>	_IOWR(<span class="enscript-string">'D'</span>, 47, struct pfioc_altq)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCGETALTQ</span>	_IOWR(<span class="enscript-string">'D'</span>, 48, struct pfioc_altq)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCCHANGEALTQ</span>	_IOWR(<span class="enscript-string">'D'</span>, 49, struct pfioc_altq)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCGETQSTATS</span>	_IOWR(<span class="enscript-string">'D'</span>, 50, struct pfioc_qstats)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCBEGINADDRS</span>	_IOWR(<span class="enscript-string">'D'</span>, 51, struct pfioc_pooladdr)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCADDADDR</span>	_IOWR(<span class="enscript-string">'D'</span>, 52, struct pfioc_pooladdr)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCGETADDRS</span>	_IOWR(<span class="enscript-string">'D'</span>, 53, struct pfioc_pooladdr)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCGETADDR</span>	_IOWR(<span class="enscript-string">'D'</span>, 54, struct pfioc_pooladdr)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCCHANGEADDR</span>	_IOWR(<span class="enscript-string">'D'</span>, 55, struct pfioc_pooladdr)
<span class="enscript-comment">/* XXX cut 55 - 57 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DIOCGETRULESETS</span>	_IOWR(<span class="enscript-string">'D'</span>, 58, struct pfioc_ruleset)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DIOCGETRULESET</span>	_IOWR(<span class="enscript-string">'D'</span>, 59, struct pfioc_ruleset)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DIOCRCLRTABLES</span>	_IOWR(<span class="enscript-string">'D'</span>, 60, struct pfioc_table)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DIOCRADDTABLES</span>	_IOWR(<span class="enscript-string">'D'</span>, 61, struct pfioc_table)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DIOCRDELTABLES</span>	_IOWR(<span class="enscript-string">'D'</span>, 62, struct pfioc_table)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DIOCRGETTABLES</span>	_IOWR(<span class="enscript-string">'D'</span>, 63, struct pfioc_table)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DIOCRGETTSTATS</span>	_IOWR(<span class="enscript-string">'D'</span>, 64, struct pfioc_table)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCRCLRTSTATS</span>	_IOWR(<span class="enscript-string">'D'</span>, 65, struct pfioc_table)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DIOCRCLRADDRS</span>	_IOWR(<span class="enscript-string">'D'</span>, 66, struct pfioc_table)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DIOCRADDADDRS</span>	_IOWR(<span class="enscript-string">'D'</span>, 67, struct pfioc_table)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DIOCRDELADDRS</span>	_IOWR(<span class="enscript-string">'D'</span>, 68, struct pfioc_table)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DIOCRSETADDRS</span>	_IOWR(<span class="enscript-string">'D'</span>, 69, struct pfioc_table)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DIOCRGETADDRS</span>	_IOWR(<span class="enscript-string">'D'</span>, 70, struct pfioc_table)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DIOCRGETASTATS</span>	_IOWR(<span class="enscript-string">'D'</span>, 71, struct pfioc_table)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCRCLRASTATS</span>	_IOWR(<span class="enscript-string">'D'</span>, 72, struct pfioc_table)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DIOCRTSTADDRS</span>	_IOWR(<span class="enscript-string">'D'</span>, 73, struct pfioc_table)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DIOCRSETTFLAGS</span>	_IOWR(<span class="enscript-string">'D'</span>, 74, struct pfioc_table)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCRINADEFINE</span>	_IOWR(<span class="enscript-string">'D'</span>, 77, struct pfioc_table)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCOSFPFLUSH</span>	_IO(<span class="enscript-string">'D'</span>, 78)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCOSFPADD</span>	_IOWR(<span class="enscript-string">'D'</span>, 79, struct pf_osfp_ioctl)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCOSFPGET</span>	_IOWR(<span class="enscript-string">'D'</span>, 80, struct pf_osfp_ioctl)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCXBEGIN</span>	_IOWR(<span class="enscript-string">'D'</span>, 81, struct pfioc_trans)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCXCOMMIT</span>	_IOWR(<span class="enscript-string">'D'</span>, 82, struct pfioc_trans)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCXROLLBACK</span>	_IOWR(<span class="enscript-string">'D'</span>, 83, struct pfioc_trans)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCGETSRCNODES</span>	_IOWR(<span class="enscript-string">'D'</span>, 84, struct pfioc_src_nodes)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCCLRSRCNODES</span>	_IO(<span class="enscript-string">'D'</span>, 85)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCSETHOSTID</span>	_IOWR(<span class="enscript-string">'D'</span>, 86, u_int32_t)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCIGETIFACES</span>	_IOWR(<span class="enscript-string">'D'</span>, 87, struct pfioc_iface)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCSETIFFLAG</span>	_IOWR(<span class="enscript-string">'D'</span>, 89, struct pfioc_iface)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCCLRIFFLAG</span>	_IOWR(<span class="enscript-string">'D'</span>, 90, struct pfioc_iface)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIOCKILLSRCNODES</span> _IOWR(<span class="enscript-string">'D'</span>, 91, struct pfioc_src_node_kill)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DIOCGIFSPEED</span>	_IOWR(<span class="enscript-string">'D'</span>, 92, struct pf_ifspeed)

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL</span>
<span class="enscript-function-name">RB_HEAD</span>(pf_src_tree, pf_src_node);
<span class="enscript-function-name">RB_PROTOTYPE_SC</span>(__private_extern__, pf_src_tree, pf_src_node, entry,
    pf_src_compare);
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pf_src_tree tree_src_tracking;

<span class="enscript-function-name">RB_HEAD</span>(pf_state_tree_id, pf_state);
<span class="enscript-function-name">RB_PROTOTYPE_SC</span>(__private_extern__, pf_state_tree_id, pf_state,
    entry_id, pf_state_compare_id);
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pf_state_tree_id tree_id;
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pf_state_queue state_list;

<span class="enscript-function-name">TAILQ_HEAD</span>(pf_poolqueue, pf_pool);
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pf_poolqueue	pf_pools[2];
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pf_palist	pf_pabuf;
<span class="enscript-type">extern</span> u_int32_t		ticket_pabuf;
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PF_ALTQ</span>
<span class="enscript-function-name">TAILQ_HEAD</span>(pf_altqqueue, pf_altq);
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pf_altqqueue	pf_altqs[2];
<span class="enscript-type">extern</span> u_int32_t		ticket_altqs_active;
<span class="enscript-type">extern</span> u_int32_t		ticket_altqs_inactive;
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>			altqs_inactive_open;
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pf_altqqueue	*pf_altqs_active;
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pf_altqqueue	*pf_altqs_inactive;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* PF_ALTQ */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pf_poolqueue	*pf_pools_active;
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pf_poolqueue	*pf_pools_inactive;

__private_extern__ <span class="enscript-type">int</span> pf_tbladdr_setup(<span class="enscript-type">struct</span> pf_ruleset *,
    <span class="enscript-type">struct</span> pf_addr_wrap *);
__private_extern__ <span class="enscript-type">void</span> pf_tbladdr_remove(<span class="enscript-type">struct</span> pf_addr_wrap *);
__private_extern__ <span class="enscript-type">void</span> pf_tbladdr_copyout(<span class="enscript-type">struct</span> pf_addr_wrap *);
__private_extern__ <span class="enscript-type">void</span> pf_calc_skip_steps(<span class="enscript-type">struct</span> pf_rulequeue *);
__private_extern__ u_int32_t pf_calc_state_key_flowhash(<span class="enscript-type">struct</span> pf_state_key *);

<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pool pf_src_tree_pl, pf_rule_pl;
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pool pf_state_pl, pf_state_key_pl, pf_pooladdr_pl;
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pool pf_state_scrub_pl;
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PF_ALTQ</span>
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pool pf_altq_pl;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* PF_ALTQ */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pool pf_app_state_pl;

<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> thread *pf_purge_thread;

__private_extern__ <span class="enscript-type">void</span> pfinit(<span class="enscript-type">void</span>);
__private_extern__ <span class="enscript-type">void</span> pf_purge_thread_fn(<span class="enscript-type">void</span> *, wait_result_t);
__private_extern__ <span class="enscript-type">void</span> pf_purge_expired_src_nodes(<span class="enscript-type">void</span>);
__private_extern__ <span class="enscript-type">void</span> pf_purge_expired_states(u_int32_t);
__private_extern__ <span class="enscript-type">void</span> pf_unlink_state(<span class="enscript-type">struct</span> pf_state *);
__private_extern__ <span class="enscript-type">void</span> pf_free_state(<span class="enscript-type">struct</span> pf_state *);
__private_extern__ <span class="enscript-type">int</span> pf_insert_state(<span class="enscript-type">struct</span> pfi_kif *, <span class="enscript-type">struct</span> pf_state *);
__private_extern__ <span class="enscript-type">int</span> pf_insert_src_node(<span class="enscript-type">struct</span> pf_src_node **,
    <span class="enscript-type">struct</span> pf_rule *, <span class="enscript-type">struct</span> pf_addr *, sa_family_t);
__private_extern__ <span class="enscript-type">void</span> pf_src_tree_remove_state(<span class="enscript-type">struct</span> pf_state *);
__private_extern__ <span class="enscript-type">struct</span> pf_state *pf_find_state_byid(<span class="enscript-type">struct</span> pf_state_cmp *);
__private_extern__ <span class="enscript-type">struct</span> pf_state *pf_find_state_all(<span class="enscript-type">struct</span> pf_state_key_cmp *,
    u_int, <span class="enscript-type">int</span> *);
__private_extern__ <span class="enscript-type">void</span> pf_print_state(<span class="enscript-type">struct</span> pf_state *);
__private_extern__ <span class="enscript-type">void</span> pf_print_flags(u_int8_t);
__private_extern__ u_int16_t pf_cksum_fixup(u_int16_t, u_int16_t, u_int16_t,
    u_int8_t);

<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> ifnet *sync_ifp;
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pf_rule pf_default_rule;
__private_extern__ <span class="enscript-type">void</span> pf_addrcpy(<span class="enscript-type">struct</span> pf_addr *, <span class="enscript-type">struct</span> pf_addr *,
    u_int8_t);
__private_extern__ <span class="enscript-type">void</span> pf_rm_rule(<span class="enscript-type">struct</span> pf_rulequeue *, <span class="enscript-type">struct</span> pf_rule *);

<span class="enscript-type">struct</span> ip_fw_args;
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET</span>
__private_extern__ <span class="enscript-type">int</span> pf_test(<span class="enscript-type">int</span>, <span class="enscript-type">struct</span> ifnet *, <span class="enscript-type">struct</span> mbuf **,
    <span class="enscript-type">struct</span> ether_header *, <span class="enscript-type">struct</span> ip_fw_args *);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* INET */</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET6</span>
__private_extern__ <span class="enscript-type">int</span> pf_test6(<span class="enscript-type">int</span>, <span class="enscript-type">struct</span> ifnet *, <span class="enscript-type">struct</span> mbuf **,
    <span class="enscript-type">struct</span> ether_header *, <span class="enscript-type">struct</span> ip_fw_args *);
__private_extern__ <span class="enscript-type">void</span> pf_poolmask(<span class="enscript-type">struct</span> pf_addr *, <span class="enscript-type">struct</span> pf_addr *,
    <span class="enscript-type">struct</span> pf_addr *, <span class="enscript-type">struct</span> pf_addr *, u_int8_t);
__private_extern__ <span class="enscript-type">void</span> pf_addr_inc(<span class="enscript-type">struct</span> pf_addr *, sa_family_t);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* INET6 */</span>

__private_extern__ <span class="enscript-type">struct</span> mbuf *pf_lazy_makewritable(<span class="enscript-type">struct</span> pf_pdesc *,
    <span class="enscript-type">struct</span> mbuf *, <span class="enscript-type">int</span>);
__private_extern__ <span class="enscript-type">void</span> *pf_pull_hdr(<span class="enscript-type">struct</span> mbuf *, <span class="enscript-type">int</span>, <span class="enscript-type">void</span> *, <span class="enscript-type">int</span>,
    u_short *, u_short *, sa_family_t);
__private_extern__ <span class="enscript-type">void</span> pf_change_a(<span class="enscript-type">void</span> *, u_int16_t *, u_int32_t, u_int8_t);
__private_extern__ <span class="enscript-type">int</span> pflog_packet(<span class="enscript-type">struct</span> pfi_kif *, <span class="enscript-type">struct</span> mbuf *,
    sa_family_t, u_int8_t, u_int8_t, <span class="enscript-type">struct</span> pf_rule *, <span class="enscript-type">struct</span> pf_rule *,
    <span class="enscript-type">struct</span> pf_ruleset *, <span class="enscript-type">struct</span> pf_pdesc *);
__private_extern__ <span class="enscript-type">int</span> pf_match_addr(u_int8_t, <span class="enscript-type">struct</span> pf_addr *,
    <span class="enscript-type">struct</span> pf_addr *, <span class="enscript-type">struct</span> pf_addr *, sa_family_t);
__private_extern__ <span class="enscript-type">int</span> pf_match_addr_range(<span class="enscript-type">struct</span> pf_addr *, <span class="enscript-type">struct</span> pf_addr *,
    <span class="enscript-type">struct</span> pf_addr *, sa_family_t);
__private_extern__ <span class="enscript-type">int</span> pf_match(u_int8_t, u_int32_t, u_int32_t, u_int32_t);
__private_extern__ <span class="enscript-type">int</span> pf_match_port(u_int8_t, u_int16_t, u_int16_t, u_int16_t);
__private_extern__ <span class="enscript-type">int</span> pf_match_xport(u_int8_t, u_int8_t, <span class="enscript-type">union</span> pf_rule_xport *,
    <span class="enscript-type">union</span> pf_state_xport *);
__private_extern__ <span class="enscript-type">int</span> pf_match_uid(u_int8_t, uid_t, uid_t, uid_t);
__private_extern__ <span class="enscript-type">int</span> pf_match_gid(u_int8_t, gid_t, gid_t, gid_t);

__private_extern__ <span class="enscript-type">void</span> pf_normalize_init(<span class="enscript-type">void</span>);
__private_extern__ <span class="enscript-type">int</span> pf_normalize_isempty(<span class="enscript-type">void</span>);
__private_extern__ <span class="enscript-type">int</span> pf_normalize_ip(<span class="enscript-type">struct</span> mbuf **, <span class="enscript-type">int</span>, <span class="enscript-type">struct</span> pfi_kif *,
    u_short *, <span class="enscript-type">struct</span> pf_pdesc *);
__private_extern__ <span class="enscript-type">int</span> pf_normalize_ip6(<span class="enscript-type">struct</span> mbuf **, <span class="enscript-type">int</span>, <span class="enscript-type">struct</span> pfi_kif *,
    u_short *, <span class="enscript-type">struct</span> pf_pdesc *);
__private_extern__ <span class="enscript-type">int</span> pf_normalize_tcp(<span class="enscript-type">int</span>, <span class="enscript-type">struct</span> pfi_kif *, <span class="enscript-type">struct</span> mbuf *,
    <span class="enscript-type">int</span>, <span class="enscript-type">int</span>, <span class="enscript-type">void</span> *, <span class="enscript-type">struct</span> pf_pdesc *);
__private_extern__ <span class="enscript-type">void</span> pf_normalize_tcp_cleanup(<span class="enscript-type">struct</span> pf_state *);
__private_extern__ <span class="enscript-type">int</span> pf_normalize_tcp_init(<span class="enscript-type">struct</span> mbuf *, <span class="enscript-type">int</span>,
    <span class="enscript-type">struct</span> pf_pdesc *, <span class="enscript-type">struct</span> tcphdr *, <span class="enscript-type">struct</span> pf_state_peer *,
    <span class="enscript-type">struct</span> pf_state_peer *);
__private_extern__ <span class="enscript-type">int</span> pf_normalize_tcp_stateful(<span class="enscript-type">struct</span> mbuf *, <span class="enscript-type">int</span>,
    <span class="enscript-type">struct</span> pf_pdesc *, u_short *, <span class="enscript-type">struct</span> tcphdr *, <span class="enscript-type">struct</span> pf_state *,
    <span class="enscript-type">struct</span> pf_state_peer *, <span class="enscript-type">struct</span> pf_state_peer *, <span class="enscript-type">int</span> *);
__private_extern__ u_int64_t pf_state_expires(<span class="enscript-type">const</span> <span class="enscript-type">struct</span> pf_state *);
__private_extern__ <span class="enscript-type">void</span> pf_purge_expired_fragments(<span class="enscript-type">void</span>);
__private_extern__ <span class="enscript-type">int</span> pf_routable(<span class="enscript-type">struct</span> pf_addr *addr, sa_family_t af,
    <span class="enscript-type">struct</span> pfi_kif *);
__private_extern__ <span class="enscript-type">int</span> pf_rtlabel_match(<span class="enscript-type">struct</span> pf_addr *, sa_family_t,
    <span class="enscript-type">struct</span> pf_addr_wrap *);
__private_extern__ <span class="enscript-type">int</span> pf_socket_lookup(<span class="enscript-type">int</span>, <span class="enscript-type">struct</span> pf_pdesc *);
__private_extern__ <span class="enscript-type">struct</span> pf_state_key *pf_alloc_state_key(<span class="enscript-type">struct</span> pf_state *,
    <span class="enscript-type">struct</span> pf_state_key *);
__private_extern__ <span class="enscript-type">void</span> pfr_initialize(<span class="enscript-type">void</span>);
__private_extern__ <span class="enscript-type">int</span> pfr_match_addr(<span class="enscript-type">struct</span> pfr_ktable *, <span class="enscript-type">struct</span> pf_addr *,
    sa_family_t);
__private_extern__ <span class="enscript-type">void</span> pfr_update_stats(<span class="enscript-type">struct</span> pfr_ktable *, <span class="enscript-type">struct</span> pf_addr *,
    sa_family_t, u_int64_t, <span class="enscript-type">int</span>, <span class="enscript-type">int</span>, <span class="enscript-type">int</span>);
__private_extern__ <span class="enscript-type">int</span> pfr_pool_get(<span class="enscript-type">struct</span> pfr_ktable *, <span class="enscript-type">int</span> *,
    <span class="enscript-type">struct</span> pf_addr *, <span class="enscript-type">struct</span> pf_addr **, <span class="enscript-type">struct</span> pf_addr **, sa_family_t);
__private_extern__ <span class="enscript-type">void</span> pfr_dynaddr_update(<span class="enscript-type">struct</span> pfr_ktable *,
    <span class="enscript-type">struct</span> pfi_dynaddr *);
__private_extern__ <span class="enscript-type">void</span> pfr_table_copyin_cleanup(<span class="enscript-type">struct</span> pfr_table *);
__private_extern__ <span class="enscript-type">struct</span> pfr_ktable *pfr_attach_table(<span class="enscript-type">struct</span> pf_ruleset *,
    <span class="enscript-type">char</span> *);
__private_extern__ <span class="enscript-type">void</span> pfr_detach_table(<span class="enscript-type">struct</span> pfr_ktable *);
__private_extern__ <span class="enscript-type">int</span> pfr_clr_tables(<span class="enscript-type">struct</span> pfr_table *, <span class="enscript-type">int</span> *, <span class="enscript-type">int</span>);
__private_extern__ <span class="enscript-type">int</span> pfr_add_tables(user_addr_t, <span class="enscript-type">int</span>, <span class="enscript-type">int</span> *, <span class="enscript-type">int</span>);
__private_extern__ <span class="enscript-type">int</span> pfr_del_tables(user_addr_t, <span class="enscript-type">int</span>, <span class="enscript-type">int</span> *, <span class="enscript-type">int</span>);
__private_extern__ <span class="enscript-type">int</span> pfr_get_tables(<span class="enscript-type">struct</span> pfr_table *, user_addr_t,
    <span class="enscript-type">int</span> *, <span class="enscript-type">int</span>);
__private_extern__ <span class="enscript-type">int</span> pfr_get_tstats(<span class="enscript-type">struct</span> pfr_table *, user_addr_t,
    <span class="enscript-type">int</span> *, <span class="enscript-type">int</span>);
__private_extern__ <span class="enscript-type">int</span> pfr_clr_tstats(user_addr_t, <span class="enscript-type">int</span>, <span class="enscript-type">int</span> *, <span class="enscript-type">int</span>);
__private_extern__ <span class="enscript-type">int</span> pfr_set_tflags(user_addr_t, <span class="enscript-type">int</span>, <span class="enscript-type">int</span>, <span class="enscript-type">int</span>, <span class="enscript-type">int</span> *,
    <span class="enscript-type">int</span> *, <span class="enscript-type">int</span>);
__private_extern__ <span class="enscript-type">int</span> pfr_clr_addrs(<span class="enscript-type">struct</span> pfr_table *, <span class="enscript-type">int</span> *, <span class="enscript-type">int</span>);
__private_extern__ <span class="enscript-type">int</span> pfr_insert_kentry(<span class="enscript-type">struct</span> pfr_ktable *, <span class="enscript-type">struct</span> pfr_addr *,
    u_int64_t);
__private_extern__ <span class="enscript-type">int</span> pfr_add_addrs(<span class="enscript-type">struct</span> pfr_table *, user_addr_t,
    <span class="enscript-type">int</span>, <span class="enscript-type">int</span> *, <span class="enscript-type">int</span>);
__private_extern__ <span class="enscript-type">int</span> pfr_del_addrs(<span class="enscript-type">struct</span> pfr_table *, user_addr_t,
    <span class="enscript-type">int</span>, <span class="enscript-type">int</span> *, <span class="enscript-type">int</span>);
__private_extern__ <span class="enscript-type">int</span> pfr_set_addrs(<span class="enscript-type">struct</span> pfr_table *, user_addr_t,
    <span class="enscript-type">int</span>, <span class="enscript-type">int</span> *, <span class="enscript-type">int</span> *, <span class="enscript-type">int</span> *, <span class="enscript-type">int</span> *, <span class="enscript-type">int</span>, u_int32_t);
__private_extern__ <span class="enscript-type">int</span> pfr_get_addrs(<span class="enscript-type">struct</span> pfr_table *, user_addr_t,
    <span class="enscript-type">int</span> *, <span class="enscript-type">int</span>);
__private_extern__ <span class="enscript-type">int</span> pfr_get_astats(<span class="enscript-type">struct</span> pfr_table *, user_addr_t,
    <span class="enscript-type">int</span> *, <span class="enscript-type">int</span>);
__private_extern__ <span class="enscript-type">int</span> pfr_clr_astats(<span class="enscript-type">struct</span> pfr_table *, user_addr_t,
    <span class="enscript-type">int</span>, <span class="enscript-type">int</span> *, <span class="enscript-type">int</span>);
__private_extern__ <span class="enscript-type">int</span> pfr_tst_addrs(<span class="enscript-type">struct</span> pfr_table *, user_addr_t,
    <span class="enscript-type">int</span>, <span class="enscript-type">int</span> *, <span class="enscript-type">int</span>);
__private_extern__ <span class="enscript-type">int</span> pfr_ina_begin(<span class="enscript-type">struct</span> pfr_table *, u_int32_t *, <span class="enscript-type">int</span> *,
    <span class="enscript-type">int</span>);
__private_extern__ <span class="enscript-type">int</span> pfr_ina_rollback(<span class="enscript-type">struct</span> pfr_table *, u_int32_t, <span class="enscript-type">int</span> *,
    <span class="enscript-type">int</span>);
__private_extern__ <span class="enscript-type">int</span> pfr_ina_commit(<span class="enscript-type">struct</span> pfr_table *, u_int32_t, <span class="enscript-type">int</span> *,
    <span class="enscript-type">int</span> *, <span class="enscript-type">int</span>);
__private_extern__ <span class="enscript-type">int</span> pfr_ina_define(<span class="enscript-type">struct</span> pfr_table *, user_addr_t,
    <span class="enscript-type">int</span>, <span class="enscript-type">int</span> *, <span class="enscript-type">int</span> *, u_int32_t, <span class="enscript-type">int</span>);

<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pfi_kif *pfi_all;

__private_extern__ <span class="enscript-type">void</span> pfi_initialize(<span class="enscript-type">void</span>);
__private_extern__ <span class="enscript-type">struct</span> pfi_kif *pfi_kif_get(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *);
__private_extern__ <span class="enscript-type">void</span> pfi_kif_ref(<span class="enscript-type">struct</span> pfi_kif *, <span class="enscript-type">enum</span> pfi_kif_refs);
__private_extern__ <span class="enscript-type">void</span> pfi_kif_unref(<span class="enscript-type">struct</span> pfi_kif *, <span class="enscript-type">enum</span> pfi_kif_refs);
__private_extern__ <span class="enscript-type">int</span> pfi_kif_match(<span class="enscript-type">struct</span> pfi_kif *, <span class="enscript-type">struct</span> pfi_kif *);
__private_extern__ <span class="enscript-type">void</span> pfi_attach_ifnet(<span class="enscript-type">struct</span> ifnet *);
__private_extern__ <span class="enscript-type">void</span> pfi_detach_ifnet(<span class="enscript-type">struct</span> ifnet *);
__private_extern__ <span class="enscript-type">int</span> pfi_match_addr(<span class="enscript-type">struct</span> pfi_dynaddr *, <span class="enscript-type">struct</span> pf_addr *,
    sa_family_t);
__private_extern__ <span class="enscript-type">int</span> pfi_dynaddr_setup(<span class="enscript-type">struct</span> pf_addr_wrap *, sa_family_t);
__private_extern__ <span class="enscript-type">void</span> pfi_dynaddr_remove(<span class="enscript-type">struct</span> pf_addr_wrap *);
__private_extern__ <span class="enscript-type">void</span> pfi_dynaddr_copyout(<span class="enscript-type">struct</span> pf_addr_wrap *);
__private_extern__ <span class="enscript-type">void</span> pfi_update_status(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *, <span class="enscript-type">struct</span> pf_status *);
__private_extern__ <span class="enscript-type">int</span> pfi_get_ifaces(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *, user_addr_t, <span class="enscript-type">int</span> *);
__private_extern__ <span class="enscript-type">int</span> pfi_set_flags(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *, <span class="enscript-type">int</span>);
__private_extern__ <span class="enscript-type">int</span> pfi_clear_flags(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *, <span class="enscript-type">int</span>);

__private_extern__ u_int16_t pf_tagname2tag(<span class="enscript-type">char</span> *);
__private_extern__ <span class="enscript-type">void</span> pf_tag2tagname(u_int16_t, <span class="enscript-type">char</span> *);
__private_extern__ <span class="enscript-type">void</span> pf_tag_ref(u_int16_t);
__private_extern__ <span class="enscript-type">void</span> pf_tag_unref(u_int16_t);
__private_extern__ <span class="enscript-type">int</span> pf_tag_packet(<span class="enscript-type">struct</span> mbuf *, <span class="enscript-type">struct</span> pf_mtag *,
    <span class="enscript-type">int</span>, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>, <span class="enscript-type">struct</span> pf_pdesc *);
__private_extern__ <span class="enscript-type">void</span> pf_step_into_anchor(<span class="enscript-type">int</span> *, <span class="enscript-type">struct</span> pf_ruleset **, <span class="enscript-type">int</span>,
    <span class="enscript-type">struct</span> pf_rule **, <span class="enscript-type">struct</span> pf_rule **,  <span class="enscript-type">int</span> *);
__private_extern__ <span class="enscript-type">int</span> pf_step_out_of_anchor(<span class="enscript-type">int</span> *, <span class="enscript-type">struct</span> pf_ruleset **, <span class="enscript-type">int</span>,
    <span class="enscript-type">struct</span> pf_rule **, <span class="enscript-type">struct</span> pf_rule **, <span class="enscript-type">int</span> *);
__private_extern__ u_int32_t pf_qname2qid(<span class="enscript-type">char</span> *);
__private_extern__ <span class="enscript-type">void</span> pf_qid2qname(u_int32_t, <span class="enscript-type">char</span> *);
__private_extern__ <span class="enscript-type">void</span> pf_qid_unref(u_int32_t);

<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pf_status pf_status;
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pool pf_frent_pl, pf_frag_pl;

<span class="enscript-type">struct</span> pf_pool_limit {
	<span class="enscript-type">void</span>		*pp;
	<span class="enscript-type">unsigned</span>	 limit;
};
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pf_pool_limit	pf_pool_limits[PF_LIMIT_MAX];

__private_extern__ <span class="enscript-type">int</span> pf_af_hook(<span class="enscript-type">struct</span> ifnet *, <span class="enscript-type">struct</span> mbuf **,
    <span class="enscript-type">struct</span> mbuf **, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>, <span class="enscript-type">int</span>, <span class="enscript-type">struct</span> ip_fw_args *);
__private_extern__ <span class="enscript-type">int</span> pf_ifaddr_hook(<span class="enscript-type">struct</span> ifnet *);
__private_extern__ <span class="enscript-type">void</span> pf_ifnet_hook(<span class="enscript-type">struct</span> ifnet *, <span class="enscript-type">int</span>);

<span class="enscript-comment">/*
 * The following are defined with &quot;private extern&quot; storage class for
 * kernel, and &quot;extern&quot; for user-space.
 */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pf_anchor_global pf_anchors;
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pf_anchor pf_main_anchor;
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">pf_main_ruleset</span>	pf_main_anchor.ruleset

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> pf_is_enabled;
<span class="enscript-type">extern</span> int16_t pf_nat64_configured;
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PF_IS_ENABLED</span> (pf_is_enabled != 0)
<span class="enscript-type">extern</span> u_int32_t pf_hash_seed;

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PF_ALTQ</span>
<span class="enscript-type">extern</span> u_int32_t altq_allowed;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* PF_ALTQ */</span>

<span class="enscript-comment">/* these ruleset functions can be linked into userland programs (pfctl) */</span>
__private_extern__ <span class="enscript-type">int</span> pf_get_ruleset_number(u_int8_t);
__private_extern__ <span class="enscript-type">void</span> pf_init_ruleset(<span class="enscript-type">struct</span> pf_ruleset *);
__private_extern__ <span class="enscript-type">int</span> pf_anchor_setup(<span class="enscript-type">struct</span> pf_rule *,
    <span class="enscript-type">const</span> <span class="enscript-type">struct</span> pf_ruleset *, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *);
__private_extern__ <span class="enscript-type">int</span> pf_anchor_copyout(<span class="enscript-type">const</span> <span class="enscript-type">struct</span> pf_ruleset *,
    <span class="enscript-type">const</span> <span class="enscript-type">struct</span> pf_rule *, <span class="enscript-type">struct</span> pfioc_rule *);
__private_extern__ <span class="enscript-type">void</span> pf_anchor_remove(<span class="enscript-type">struct</span> pf_rule *);
__private_extern__ <span class="enscript-type">void</span> pf_remove_if_empty_ruleset(<span class="enscript-type">struct</span> pf_ruleset *);
__private_extern__ <span class="enscript-type">struct</span> pf_anchor *pf_find_anchor(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *);
__private_extern__ <span class="enscript-type">struct</span> pf_ruleset *pf_find_ruleset(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *);
__private_extern__ <span class="enscript-type">struct</span> pf_ruleset *pf_find_ruleset_with_owner(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *,
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> *, <span class="enscript-type">int</span>, <span class="enscript-type">int</span> *);
__private_extern__ <span class="enscript-type">struct</span> pf_ruleset *pf_find_or_create_ruleset(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *);
__private_extern__ <span class="enscript-type">void</span> pf_rs_initialize(<span class="enscript-type">void</span>);

__private_extern__ <span class="enscript-type">int</span> pf_osfp_add(<span class="enscript-type">struct</span> pf_osfp_ioctl *);
__private_extern__ <span class="enscript-type">struct</span> pf_osfp_enlist *pf_osfp_fingerprint(<span class="enscript-type">struct</span> pf_pdesc *,
    <span class="enscript-type">struct</span> mbuf *, <span class="enscript-type">int</span>, <span class="enscript-type">const</span> <span class="enscript-type">struct</span> tcphdr *);
__private_extern__ <span class="enscript-type">struct</span> pf_osfp_enlist *pf_osfp_fingerprint_hdr(
    <span class="enscript-type">const</span> <span class="enscript-type">struct</span> ip *, <span class="enscript-type">const</span> <span class="enscript-type">struct</span> ip6_hdr *, <span class="enscript-type">const</span> <span class="enscript-type">struct</span> tcphdr *);
__private_extern__ <span class="enscript-type">void</span> pf_osfp_flush(<span class="enscript-type">void</span>);
__private_extern__ <span class="enscript-type">int</span> pf_osfp_get(<span class="enscript-type">struct</span> pf_osfp_ioctl *);
__private_extern__ <span class="enscript-type">void</span> pf_osfp_initialize(<span class="enscript-type">void</span>);
__private_extern__ <span class="enscript-type">int</span> pf_osfp_match(<span class="enscript-type">struct</span> pf_osfp_enlist *, pf_osfp_t);
__private_extern__ <span class="enscript-type">struct</span> pf_os_fingerprint *pf_osfp_validate(<span class="enscript-type">void</span>);
__private_extern__ <span class="enscript-type">struct</span> pf_mtag *pf_find_mtag(<span class="enscript-type">struct</span> mbuf *);
__private_extern__ <span class="enscript-type">struct</span> pf_mtag *pf_get_mtag(<span class="enscript-type">struct</span> mbuf *);
#<span class="enscript-reference">else</span> <span class="enscript-comment">/* !KERNEL */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pf_anchor_global pf_anchors;
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pf_anchor pf_main_anchor;
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">pf_main_ruleset</span>	pf_main_anchor.ruleset

<span class="enscript-comment">/* these ruleset functions can be linked into userland programs (pfctl) */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">pf_get_ruleset_number</span>(u_int8_t);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">pf_init_ruleset</span>(<span class="enscript-type">struct</span> pf_ruleset *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">pf_anchor_setup</span>(<span class="enscript-type">struct</span> pf_rule *, <span class="enscript-type">const</span> <span class="enscript-type">struct</span> pf_ruleset *,
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">pf_anchor_copyout</span>(<span class="enscript-type">const</span> <span class="enscript-type">struct</span> pf_ruleset *, <span class="enscript-type">const</span> <span class="enscript-type">struct</span> pf_rule *,
    <span class="enscript-type">struct</span> pfioc_rule *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">pf_anchor_remove</span>(<span class="enscript-type">struct</span> pf_rule *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">pf_remove_if_empty_ruleset</span>(<span class="enscript-type">struct</span> pf_ruleset *);
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pf_anchor *<span class="enscript-function-name">pf_find_anchor</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *);
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pf_ruleset *<span class="enscript-function-name">pf_find_ruleset</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *);
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pf_ruleset *<span class="enscript-function-name">pf_find_ruleset_with_owner</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *,
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> *, <span class="enscript-type">int</span>, <span class="enscript-type">int</span> *);
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pf_ruleset *<span class="enscript-function-name">pf_find_or_create_ruleset</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">pf_rs_initialize</span>(<span class="enscript-type">void</span>);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !KERNEL */</span>

#<span class="enscript-reference">ifdef</span>  <span class="enscript-variable-name">__cplusplus</span>
}
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* PF || !KERNEL */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* PRIVATE */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* _NET_PFVAR_H_ */</span>
</pre>
<hr />
</body></html>