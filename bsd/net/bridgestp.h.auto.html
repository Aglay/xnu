<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>bridgestp.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">bridgestp.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*	$NetBSD: if_bridgevar.h,v 1.4 2003/07/08 07:13:50 itojun Exp $	*/</span>

<span class="enscript-comment">/*
 * Copyright (c) 2010 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 *
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 *
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 *
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

<span class="enscript-comment">/*
 * Copyright 2001 Wasabi Systems, Inc.
 * All rights reserved.
 *
 * Written by Jason R. Thorpe for Wasabi Systems, Inc.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *	This product includes software developed for the NetBSD Project by
 *	Wasabi Systems, Inc.
 * 4. The name of Wasabi Systems, Inc. may not be used to endorse
 *    or promote products derived from this software without specific prior
 *    written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY WASABI SYSTEMS, INC. ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
 * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL WASABI SYSTEMS, INC
 * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */</span>

<span class="enscript-comment">/*
 * Copyright (c) 1999, 2000 Jason L. Wright (<a href="mailto:jason@thought.net">jason@thought.net</a>)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *	This product includes software developed by Jason L. Wright
 * 4. The name of the author may not be used to endorse or promote products
 *    derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT,
 * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
 * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
 * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 *
 * OpenBSD: if_bridge.h,v 1.14 2001/03/22 03:48:29 jason Exp
 *
 * $FreeBSD$
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">__BRIDGESTP_H__</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">__BRIDGESTP_H__</span>

<span class="enscript-comment">/*
 * Data structure and control definitions for STP interfaces.
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/queue.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/locks.h&gt;</span>
<span class="enscript-comment">/* STP port states */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_IFSTATE_DISABLED</span>	0
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_IFSTATE_LISTENING</span>	1
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_IFSTATE_LEARNING</span>	2
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_IFSTATE_FORWARDING</span>	3
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_IFSTATE_BLOCKING</span>	4
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_IFSTATE_DISCARDING</span>	5

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_TCSTATE_ACTIVE</span>	1
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_TCSTATE_DETECTED</span>	2
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_TCSTATE_INACTIVE</span>	3
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_TCSTATE_LEARNING</span>	4
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_TCSTATE_PROPAG</span>	5
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_TCSTATE_ACK</span>	6
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_TCSTATE_TC</span>		7
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_TCSTATE_TCN</span>	8

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_ROLE_DISABLED</span>	0
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_ROLE_ROOT</span>		1
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_ROLE_DESIGNATED</span>	2
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_ROLE_ALTERNATE</span>	3
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_ROLE_BACKUP</span>	4

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">XNU_KERNEL_PRIVATE</span>

<span class="enscript-comment">/* STP port flags */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PORT_CANMIGRATE</span>	0x0001
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PORT_NEWINFO</span>	0x0002
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PORT_DISPUTED</span>	0x0004
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PORT_ADMCOST</span>	0x0008
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PORT_AUTOEDGE</span>	0x0010
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PORT_AUTOPTP</span>	0x0020
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PORT_ADMEDGE</span>	0x0040
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PORT_PNDCOST</span>	0x0080

<span class="enscript-comment">/* BPDU priority */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PDU_SUPERIOR</span>	1
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PDU_REPEATED</span>	2
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PDU_INFERIOR</span>	3
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PDU_INFERIORALT</span>	4
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PDU_OTHER</span>		5

<span class="enscript-comment">/* BPDU flags */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PDU_PRMASK</span>		0x0c		<span class="enscript-comment">/* Port Role */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PDU_PRSHIFT</span>	2		<span class="enscript-comment">/* Port Role offset */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PDU_F_UNKN</span>		0x00		<span class="enscript-comment">/* Unknown port    (00) */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PDU_F_ALT</span>		0x01		<span class="enscript-comment">/* Alt/Backup port (01) */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PDU_F_ROOT</span>		0x02		<span class="enscript-comment">/* Root port       (10) */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PDU_F_DESG</span>		0x03		<span class="enscript-comment">/* Designated port (11) */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PDU_STPMASK</span>	0x81		<span class="enscript-comment">/* strip unused STP flags */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PDU_RSTPMASK</span>	0x7f		<span class="enscript-comment">/* strip unused RSTP flags */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PDU_F_TC</span>		0x01		<span class="enscript-comment">/* Topology change */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PDU_F_P</span>		0x02		<span class="enscript-comment">/* Proposal flag */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PDU_F_L</span>		0x10		<span class="enscript-comment">/* Learning flag */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PDU_F_F</span>		0x20		<span class="enscript-comment">/* Forwarding flag */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PDU_F_A</span>		0x40		<span class="enscript-comment">/* Agreement flag */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PDU_F_TCA</span>		0x80		<span class="enscript-comment">/* Topology change ack */</span>

<span class="enscript-comment">/*
 * Spanning tree defaults.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_DEFAULT_MAX_AGE</span>		(20 * 256)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_DEFAULT_HELLO_TIME</span>		(2 * 256)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_DEFAULT_FORWARD_DELAY</span>	(15 * 256)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_DEFAULT_HOLD_TIME</span>		(1 * 256)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_DEFAULT_MIGRATE_DELAY</span>	(3 * 256)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_DEFAULT_HOLD_COUNT</span>		6
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_DEFAULT_BRIDGE_PRIORITY</span>	0x8000
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_DEFAULT_PORT_PRIORITY</span>	0x80
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_DEFAULT_PATH_COST</span>		55
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_MIN_HELLO_TIME</span>		(1 * 256)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_MIN_MAX_AGE</span>		(6 * 256)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_MIN_FORWARD_DELAY</span>		(4 * 256)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_MIN_HOLD_COUNT</span>		1
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_MAX_HELLO_TIME</span>		(2 * 256)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_MAX_MAX_AGE</span>		(40 * 256)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_MAX_FORWARD_DELAY</span>		(30 * 256)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_MAX_HOLD_COUNT</span>		10
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_MAX_PRIORITY</span>		61440
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_MAX_PORT_PRIORITY</span>		240
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_MAX_PATH_COST</span>		200000000

<span class="enscript-comment">/* BPDU message types */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_MSGTYPE_CFG</span>	0x00		<span class="enscript-comment">/* Configuration */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_MSGTYPE_RSTP</span>	0x02		<span class="enscript-comment">/* Rapid STP */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_MSGTYPE_TCN</span>	0x80		<span class="enscript-comment">/* Topology chg notification */</span>

<span class="enscript-comment">/* Protocol versions */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PROTO_ID</span>		0x00
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PROTO_STP</span>		0x00
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PROTO_RSTP</span>		0x02
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_PROTO_MAX</span>		BSTP_PROTO_RSTP

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_INFO_RECIEVED</span>	1		<span class="enscript-comment">/* compat */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_INFO_RECEIVED</span>	1
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_INFO_MINE</span>		2
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_INFO_AGED</span>		3
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_INFO_DISABLED</span>	4


#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_MESSAGE_AGE_INCR</span>	(1 * 256)	<span class="enscript-comment">/* in 256ths of a second */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_TICK_VAL</span>		(1 * 256)	<span class="enscript-comment">/* in 256ths of a second */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_LINK_TIMER</span>		(BSTP_TICK_VAL * 15)

<span class="enscript-comment">/*
 * Driver callbacks for STP state changes
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-function-name">void</span> (*bstp_state_cb_t)(<span class="enscript-type">struct</span> ifnet *, <span class="enscript-type">int</span>);
<span class="enscript-type">typedef</span> <span class="enscript-function-name">void</span> (*bstp_rtage_cb_t)(<span class="enscript-type">struct</span> ifnet *, <span class="enscript-type">int</span>);
<span class="enscript-type">struct</span> bstp_cb_ops {
	bstp_state_cb_t	bcb_state;
	bstp_rtage_cb_t	bcb_rtage;
};

<span class="enscript-comment">/*
 * Because BPDU's do not make nicely aligned structures, two different
 * declarations are used: bstp_?bpdu (wire representation, packed) and
 * bstp_*_unit (internal, nicely aligned version).
 */</span>

<span class="enscript-comment">/* configuration bridge protocol data unit */</span>
<span class="enscript-type">struct</span> bstp_cbpdu {
	uint8_t		cbu_dsap;		<span class="enscript-comment">/* LLC: destination sap */</span>
	uint8_t		cbu_ssap;		<span class="enscript-comment">/* LLC: source sap */</span>
	uint8_t		cbu_ctl;		<span class="enscript-comment">/* LLC: control */</span>
	uint16_t	cbu_protoid;		<span class="enscript-comment">/* protocol id */</span>
	uint8_t		cbu_protover;		<span class="enscript-comment">/* protocol version */</span>
	uint8_t		cbu_bpdutype;		<span class="enscript-comment">/* message type */</span>
	uint8_t		cbu_flags;		<span class="enscript-comment">/* flags (below) */</span>

	<span class="enscript-comment">/* root id */</span>
	uint16_t	cbu_rootpri;		<span class="enscript-comment">/* root priority */</span>
	uint8_t		cbu_rootaddr[6];	<span class="enscript-comment">/* root address */</span>

	uint32_t	cbu_rootpathcost;	<span class="enscript-comment">/* root path cost */</span>

	<span class="enscript-comment">/* bridge id */</span>
	uint16_t	cbu_bridgepri;		<span class="enscript-comment">/* bridge priority */</span>
	uint8_t		cbu_bridgeaddr[6];	<span class="enscript-comment">/* bridge address */</span>

	uint16_t	cbu_portid;		<span class="enscript-comment">/* port id */</span>
	uint16_t	cbu_messageage;		<span class="enscript-comment">/* current message age */</span>
	uint16_t	cbu_maxage;		<span class="enscript-comment">/* maximum age */</span>
	uint16_t	cbu_hellotime;		<span class="enscript-comment">/* hello time */</span>
	uint16_t	cbu_forwarddelay;	<span class="enscript-comment">/* forwarding delay */</span>
	uint8_t		cbu_versionlen;		<span class="enscript-comment">/* version 1 length */</span>
} __attribute__((__packed__));
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_BPDU_STP_LEN</span>	(3 + 35)	<span class="enscript-comment">/* LLC + STP pdu */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BSTP_BPDU_RSTP_LEN</span>	(3 + 36)	<span class="enscript-comment">/* LLC + RSTP pdu */</span>

<span class="enscript-comment">/* topology change notification bridge protocol data unit */</span>
<span class="enscript-type">struct</span> bstp_tbpdu {
	uint8_t		tbu_dsap;		<span class="enscript-comment">/* LLC: destination sap */</span>
	uint8_t		tbu_ssap;		<span class="enscript-comment">/* LLC: source sap */</span>
	uint8_t		tbu_ctl;		<span class="enscript-comment">/* LLC: control */</span>
	uint16_t	tbu_protoid;		<span class="enscript-comment">/* protocol id */</span>
	uint8_t		tbu_protover;		<span class="enscript-comment">/* protocol version */</span>
	uint8_t		tbu_bpdutype;		<span class="enscript-comment">/* message type */</span>
} __attribute__((__packed__));

<span class="enscript-comment">/*
 * Timekeeping structure used in spanning tree code.
 */</span>
 
<span class="enscript-type">typedef</span> <span class="enscript-type">void</span> <span class="enscript-function-name">bstp_task_func_t</span>(<span class="enscript-type">void</span> *context, <span class="enscript-type">int</span> count);
 
<span class="enscript-type">struct</span> bstp_task {
	TAILQ_ENTRY(bstp_task)	bt_next;
	<span class="enscript-type">int</span>						bt_count;
	bstp_task_func_t		*bt_func;
	<span class="enscript-type">void</span>					*bt_context;
};

<span class="enscript-type">struct</span> bstp_timer {
	<span class="enscript-type">int</span>		active;
	<span class="enscript-type">int</span>		latched;
	<span class="enscript-type">int</span>		value;
};

<span class="enscript-type">struct</span> bstp_pri_vector {
	uint64_t		pv_root_id;
	uint32_t		pv_cost;
	uint64_t		pv_dbridge_id;
	uint16_t		pv_dport_id;
	uint16_t		pv_port_id;
};

<span class="enscript-type">struct</span> bstp_config_unit {
	<span class="enscript-type">struct</span> bstp_pri_vector	cu_pv;
	uint16_t	cu_message_age;
	uint16_t	cu_max_age;
	uint16_t	cu_forward_delay;
	uint16_t	cu_hello_time;
	uint8_t		cu_message_type;
	uint8_t		cu_topology_change_ack;
	uint8_t		cu_topology_change;
	uint8_t		cu_proposal;
	uint8_t		cu_agree;
	uint8_t		cu_learning;
	uint8_t		cu_forwarding;
	uint8_t		cu_role;
};

<span class="enscript-type">struct</span> bstp_tcn_unit {
	uint8_t		tu_message_type;
};

<span class="enscript-type">struct</span> bstp_port {
	LIST_ENTRY(bstp_port)	bp_next;
	<span class="enscript-type">struct</span> ifnet		*bp_ifp;	<span class="enscript-comment">/* parent if */</span>
	<span class="enscript-type">struct</span> bstp_state	*bp_bs;
	uint8_t			bp_active;
	uint8_t			bp_protover;
	uint32_t		bp_flags;
	uint32_t		bp_path_cost;
	uint16_t		bp_port_msg_age;
	uint16_t		bp_port_max_age;
	uint16_t		bp_port_fdelay;
	uint16_t		bp_port_htime;
	uint16_t		bp_desg_msg_age;
	uint16_t		bp_desg_max_age;
	uint16_t		bp_desg_fdelay;
	uint16_t		bp_desg_htime;
	<span class="enscript-type">struct</span> bstp_timer	bp_edge_delay_timer;
	<span class="enscript-type">struct</span> bstp_timer	bp_forward_delay_timer;
	<span class="enscript-type">struct</span> bstp_timer	bp_hello_timer;
	<span class="enscript-type">struct</span> bstp_timer	bp_message_age_timer;
	<span class="enscript-type">struct</span> bstp_timer	bp_migrate_delay_timer;
	<span class="enscript-type">struct</span> bstp_timer	bp_recent_backup_timer;
	<span class="enscript-type">struct</span> bstp_timer	bp_recent_root_timer;
	<span class="enscript-type">struct</span> bstp_timer	bp_tc_timer;
	<span class="enscript-type">struct</span> bstp_config_unit bp_msg_cu;
	<span class="enscript-type">struct</span> bstp_pri_vector	bp_desg_pv;
	<span class="enscript-type">struct</span> bstp_pri_vector	bp_port_pv;
	uint16_t		bp_port_id;
	uint8_t			bp_state;
	uint8_t			bp_tcstate;
	uint8_t			bp_role;
	uint8_t			bp_infois;
	uint8_t			bp_tc_ack;
	uint8_t			bp_tc_prop;
	uint8_t			bp_fdbflush;
	uint8_t			bp_priority;
	uint8_t			bp_ptp_link;
	uint8_t			bp_agree;
	uint8_t			bp_agreed;
	uint8_t			bp_sync;
	uint8_t			bp_synced;
	uint8_t			bp_proposing;
	uint8_t			bp_proposed;
	uint8_t			bp_operedge;
	uint8_t			bp_reroot;
	uint8_t			bp_rcvdtc;
	uint8_t			bp_rcvdtca;
	uint8_t			bp_rcvdtcn;
	uint32_t		bp_forward_transitions;
	uint8_t			bp_txcount;
	<span class="enscript-type">struct</span> bstp_task	bp_statetask;
	<span class="enscript-type">struct</span> bstp_task	bp_rtagetask;
	uint32_t		bp_if_link_state;	<span class="enscript-comment">/* cache of the parent if link state */</span>
};

<span class="enscript-comment">/*
 * Values for bp_if_link_state.
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LINK_STATE_UNKNOWN</span>      0       <span class="enscript-comment">/* link invalid/unknown */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LINK_STATE_DOWN</span>         1       <span class="enscript-comment">/* link is down */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LINK_STATE_UP</span>           2       <span class="enscript-comment">/* link is up */</span>

<span class="enscript-comment">/*
 * Software state for each bridge STP.
 */</span>
<span class="enscript-type">struct</span> bstp_state {
	LIST_ENTRY(bstp_state)	bs_list;
	uint8_t			bs_running;
	lck_mtx_t		*bs_mtx;
	<span class="enscript-type">struct</span> bstp_pri_vector	bs_bridge_pv;
	<span class="enscript-type">struct</span> bstp_pri_vector	bs_root_pv;
	<span class="enscript-type">struct</span> bstp_port	*bs_root_port;
	uint8_t			bs_protover;
	uint16_t		bs_migration_delay;
	uint16_t		bs_edge_delay;
	uint16_t		bs_bridge_max_age;
	uint16_t		bs_bridge_fdelay;
	uint16_t		bs_bridge_htime;
	uint16_t		bs_root_msg_age;
	uint16_t		bs_root_max_age;
	uint16_t		bs_root_fdelay;
	uint16_t		bs_root_htime;
	uint16_t		bs_hold_time;
	uint16_t		bs_bridge_priority;
	uint8_t			bs_txholdcount;
	uint8_t			bs_allsynced;
	<span class="enscript-type">struct</span> bstp_timer	bs_link_timer;
	<span class="enscript-type">struct</span> timeval		bs_last_tc_time;
	LIST_HEAD(, bstp_port)	bs_bplist;
	bstp_state_cb_t		bs_state_cb;
	bstp_rtage_cb_t		bs_rtage_cb;
};

<span class="enscript-type">void</span>	bstp_attach(<span class="enscript-type">struct</span> bstp_state *, <span class="enscript-type">struct</span> bstp_cb_ops *);
<span class="enscript-type">void</span>	bstp_detach(<span class="enscript-type">struct</span> bstp_state *);
<span class="enscript-type">void</span>	bstp_init(<span class="enscript-type">struct</span> bstp_state *);
<span class="enscript-type">void</span>	bstp_stop(<span class="enscript-type">struct</span> bstp_state *);
<span class="enscript-type">int</span>	bstp_create(<span class="enscript-type">struct</span> bstp_state *, <span class="enscript-type">struct</span> bstp_port *, <span class="enscript-type">struct</span> ifnet *);
<span class="enscript-type">int</span>	bstp_enable(<span class="enscript-type">struct</span> bstp_port *);
<span class="enscript-type">void</span>	bstp_disable(<span class="enscript-type">struct</span> bstp_port *);
<span class="enscript-type">void</span>	bstp_destroy(<span class="enscript-type">struct</span> bstp_port *);
<span class="enscript-type">void</span>	bstp_linkstate(<span class="enscript-type">struct</span> ifnet *, <span class="enscript-type">int</span>);
<span class="enscript-type">int</span>	bstp_set_htime(<span class="enscript-type">struct</span> bstp_state *, <span class="enscript-type">int</span>);
<span class="enscript-type">int</span>	bstp_set_fdelay(<span class="enscript-type">struct</span> bstp_state *, <span class="enscript-type">int</span>);
<span class="enscript-type">int</span>	bstp_set_maxage(<span class="enscript-type">struct</span> bstp_state *, <span class="enscript-type">int</span>);
<span class="enscript-type">int</span>	bstp_set_holdcount(<span class="enscript-type">struct</span> bstp_state *, <span class="enscript-type">int</span>);
<span class="enscript-type">int</span>	bstp_set_protocol(<span class="enscript-type">struct</span> bstp_state *, <span class="enscript-type">int</span>);
<span class="enscript-type">int</span>	bstp_set_priority(<span class="enscript-type">struct</span> bstp_state *, <span class="enscript-type">int</span>);
<span class="enscript-type">int</span>	bstp_set_port_priority(<span class="enscript-type">struct</span> bstp_port *, <span class="enscript-type">int</span>);
<span class="enscript-type">int</span>	bstp_set_path_cost(<span class="enscript-type">struct</span> bstp_port *, uint32_t);
<span class="enscript-type">int</span>	bstp_set_edge(<span class="enscript-type">struct</span> bstp_port *, <span class="enscript-type">int</span>);
<span class="enscript-type">int</span>	bstp_set_autoedge(<span class="enscript-type">struct</span> bstp_port *, <span class="enscript-type">int</span>);
<span class="enscript-type">int</span>	bstp_set_ptp(<span class="enscript-type">struct</span> bstp_port *, <span class="enscript-type">int</span>);
<span class="enscript-type">int</span>	bstp_set_autoptp(<span class="enscript-type">struct</span> bstp_port *, <span class="enscript-type">int</span>);
<span class="enscript-type">struct</span> mbuf *<span class="enscript-function-name">bstp_input</span>(<span class="enscript-type">struct</span> bstp_port *, <span class="enscript-type">struct</span> ifnet *, <span class="enscript-type">struct</span> mbuf *);

<span class="enscript-type">void</span> <span class="enscript-function-name">bstp_sys_init</span>(<span class="enscript-type">void</span>);

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* XNU_KERNEL_PRIVATE */</span>

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* __BRIDGESTP_H__ */</span>

</pre>
<hr />
</body></html>