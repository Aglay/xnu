<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>kpi_interfacefilter.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">kpi_interfacefilter.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2008 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*!
	@header kpi_interfacefilter.h
	This header defines an API to attach interface filters. Interface
	filters may be attached to a specific interface. The filters can
	intercept all packets in to and out of the specific interface. In
	addition, the filters may intercept interface specific events and
	ioctls.
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">__KPI_INTERFACEFILTER__</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">__KPI_INTERFACEFILTER__</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/kernel_types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/kpi_interface.h&gt;</span>

<span class="enscript-type">struct</span> kev_msg;

__BEGIN_DECLS

<span class="enscript-comment">/*!
	@typedef iff_input_func

	@discussion iff_input_func is used to filter incoming packets. The
		interface is only valid for the duration of the filter call. If
		you need to keep a reference to the interface, be sure to call
		ifnet_reference and ifnet_release. The packets passed to the
		inbound filter are different from those passed to the outbound
		filter. Packets to the inbound filter have the frame header
		passed in separately from the rest of the packet. The outbound
		data filters is passed the whole packet including the frame
		header.

		The frame header usually preceeds the data in the mbuf. This
		ensures that the frame header will be a valid pointer as long as
		the mbuf is not freed. If you need to change the frame header to
		point somewhere else, the recommended method is to prepend a new
		frame header to the mbuf chain (mbuf_prepend), set the header to
		point to that data, then call mbuf_adj to move the mbuf data
		pointer back to the start of the packet payload.
	@param cookie The cookie specified when this filter was attached.
	@param interface The interface the packet was recieved on.
	@param protocol The protocol of this packet. If you specified a
		protocol when attaching your filter, the protocol will only ever
		be the protocol you specified.
	@param data The inbound packet, after the frame header as determined
		by the interface.
	@param frame_ptr A pointer to the pointer to the frame header. The
		frame header length can be found by inspecting the interface's
		frame header length (ifnet_hdrlen).
	@result Return:
		0 - The caller will continue with normal processing of the
			packet.
		EJUSTRETURN - The caller will stop processing the packet,
			the packet will not be freed.
		Anything Else - The caller will free the packet and stop
			processing.
*/</span>
<span class="enscript-type">typedef</span>	errno_t (*iff_input_func)(<span class="enscript-type">void</span> *cookie, ifnet_t interface,
    protocol_family_t protocol, mbuf_t *data, <span class="enscript-type">char</span> **frame_ptr);

<span class="enscript-comment">/*!
	@typedef iff_output_func

	@discussion iff_output_func is used to filter fully formed outbound
		packets. The interface is only valid for the duration of the
		filter call. If you need to keep a reference to the interface,
		be sure to call ifnet_reference and ifnet_release.
	@param cookie The cookie specified when this filter was attached.
	@param interface The interface the packet is being transmitted on.
	@param data The fully formed outbound packet in a chain of mbufs.
		The frame header is already included. The filter function may
		modify the packet or return a different mbuf chain.
	@result Return:
		0 - The caller will continue with normal processing of the
			packet.
		EJUSTRETURN - The caller will stop processing the packet,
			the packet will not be freed.
		Anything Else - The caller will free the packet and stop
			processing.
*/</span>
<span class="enscript-type">typedef</span>	errno_t (*iff_output_func)(<span class="enscript-type">void</span> *cookie, ifnet_t interface,
    protocol_family_t protocol, mbuf_t *data);

<span class="enscript-comment">/*!
	@typedef iff_event_func

	@discussion iff_event_func is used to filter interface specific
		events. The interface is only valid for the duration of the
		filter call. If you need to keep a reference to the interface,
		be sure to call ifnet_reference and ifnet_release.
	@param cookie The cookie specified when this filter was attached.
	@param interface The interface the packet is being transmitted on.
	@param event_msg The kernel event, may not be changed.
*/</span>
<span class="enscript-type">typedef</span>	<span class="enscript-type">void</span> (*iff_event_func)(<span class="enscript-type">void</span> *cookie, ifnet_t interface,
    protocol_family_t protocol, <span class="enscript-type">const</span> <span class="enscript-type">struct</span> kev_msg *event_msg);

<span class="enscript-comment">/*!
	@typedef iff_ioctl_func

	@discussion iff_ioctl_func is used to filter ioctls sent to an
		interface. The interface is only valid for the duration of the
		filter call. If you need to keep a reference to the interface,
		be sure to call ifnet_reference and ifnet_release.

		All undefined ioctls are reserved for future use by Apple. If
		you need to communicate with your kext using an ioctl, please
		use SIOCSIFKPI and SIOCGIFKPI.
	@param cookie The cookie specified when this filter was attached.
	@param interface The interface the packet is being transmitted on.
	@param ioctl_cmd The ioctl command.
	@param ioctl_arg A pointer to the ioctl argument.
	@result Return:
		0 - This filter function handled the ioctl.
		EOPNOTSUPP - This filter function does not understand/did not
			handle this ioctl.
		EJUSTRETURN - This filter function handled the ioctl,
			processing should stop.
		Anything Else - Processing will stop, the error will be
			returned.
*/</span>
<span class="enscript-type">typedef</span>	errno_t (*iff_ioctl_func)(<span class="enscript-type">void</span> *cookie, ifnet_t interface,
    protocol_family_t protocol, <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> ioctl_cmd, <span class="enscript-type">void</span> *ioctl_arg);

<span class="enscript-comment">/*!
	@typedef iff_detached_func

	@discussion iff_detached_func is called to notify the filter that it
		has been detached from an interface. This is the last call to
		the filter that will be made. A filter may be detached if the
		interface is detached or the detach filter function is called.
		In the case that the interface is being detached, your filter's
		event function will be called with the interface detaching event
		before the your detached function will be called.
	@param cookie The cookie specified when this filter was attached.
	@param interface The interface this filter was detached from.
*/</span>
<span class="enscript-type">typedef</span>	<span class="enscript-type">void</span> (*iff_detached_func)(<span class="enscript-type">void</span> *cookie, ifnet_t interface);

<span class="enscript-comment">/*!
	@struct iff_filter
	@discussion This structure is used to define an interface filter for
		use with the iflt_attach function.
	@field iff_cookie A kext defined cookie that will be passed to all
		filter functions.
	@field iff_name A filter name used for debugging purposes.
	@field iff_protocol The protocol of the packets this filter is
		interested in. If you specify zero, packets from all protocols
		will be passed to the filter.
	@field iff_input The filter function to handle inbound packets, may
		be NULL.
	@field iff_output The filter function to handle outbound packets,
		may be NULL.
	@field iff_event The filter function to handle interface events, may
		be null.
	@field iff_ioctl The filter function to handle interface ioctls, may
		be null.
	@field iff_detached The filter function used to notify the filter that
		it has been detached.
*/</span>

<span class="enscript-type">struct</span> iff_filter {
	<span class="enscript-type">void</span>			*iff_cookie;
	<span class="enscript-type">const</span> <span class="enscript-type">char</span>		*iff_name;
	protocol_family_t	iff_protocol;
	iff_input_func		iff_input;
	iff_output_func		iff_output;
	iff_event_func		iff_event;
	iff_ioctl_func		iff_ioctl;
	iff_detached_func	iff_detached;
};

<span class="enscript-comment">/*!
	@function iflt_attach
	@discussion Attaches an interface filter to an interface.
	@param interface The interface the filter should be attached to.
	@param filter A structure defining the filter.
	@param filter_ref A reference to the filter used to detach.
	@result 0 on success otherwise the errno error.
 */</span>
<span class="enscript-type">extern</span> errno_t <span class="enscript-function-name">iflt_attach</span>(ifnet_t interface, <span class="enscript-type">const</span> <span class="enscript-type">struct</span> iff_filter *filter,
    interface_filter_t *filter_ref);

<span class="enscript-comment">/*!
	@function iflt_detach
	@discussion Detaches an interface filter from an interface.
	@param filter_ref The reference to the filter from iflt_attach.
 */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">iflt_detach</span>(interface_filter_t filter_ref);

__END_DECLS
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* __KPI_INTERFACEFILTER__ */</span>
</pre>
<hr />
</body></html>