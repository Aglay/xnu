<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>pf_osfp.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">pf_osfp.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2007-2011 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 *
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 *
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 *
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

<span class="enscript-comment">/*	$apfw: pf_osfp.c,v 1.4 2008/08/27 00:01:32 jhw Exp $ */</span>
<span class="enscript-comment">/*	$OpenBSD: pf_osfp.c,v 1.12 2006/12/13 18:14:10 itojun Exp $ */</span>

<span class="enscript-comment">/*
 * Copyright (c) 2003 Mike Frantzen &lt;<a href="mailto:frantzen@w4g.org">frantzen@w4g.org</a>&gt;
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;machine/endian.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/param.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/socket.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/systm.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/mbuf.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/in.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/in_systm.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/ip.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/tcp.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/tcp_fsm.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/if.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/pfvar.h&gt;</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET6</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/ip6.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet6/in6_var.h&gt;</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* INET6 */</span>

#<span class="enscript-reference">define</span> <span class="enscript-function-name">DPFPRINTF</span>(format, x...)			\
	<span class="enscript-keyword">if</span> (pf_status.debug &gt;= PF_DEBUG_NOISY)	\
		printf(format, ##x)

<span class="enscript-type">static</span> <span class="enscript-function-name">SLIST_HEAD</span>(pf_osfp_list, pf_os_fingerprint) pf_osfp_list;
<span class="enscript-type">static</span> <span class="enscript-type">struct</span> pool pf_osfp_entry_pl;
<span class="enscript-type">static</span> <span class="enscript-type">struct</span> pool pf_osfp_pl;

<span class="enscript-type">static</span> <span class="enscript-type">struct</span> pf_os_fingerprint	*pf_osfp_find(<span class="enscript-type">struct</span> pf_osfp_list *,
    <span class="enscript-type">struct</span> pf_os_fingerprint *, u_int8_t);
<span class="enscript-type">static</span> <span class="enscript-type">struct</span> pf_os_fingerprint	*pf_osfp_find_exact(<span class="enscript-type">struct</span> pf_osfp_list *,
    <span class="enscript-type">struct</span> pf_os_fingerprint *);
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">pf_osfp_insert</span>(<span class="enscript-type">struct</span> pf_osfp_list *, <span class="enscript-type">struct</span> pf_os_fingerprint *);


<span class="enscript-comment">/*
 * Passively fingerprint the OS of the host (IPv4 TCP SYN packets only)
 * Returns the list of possible OSes.
 */</span>
<span class="enscript-type">struct</span> pf_osfp_enlist *
<span class="enscript-function-name">pf_osfp_fingerprint</span>(<span class="enscript-type">struct</span> pf_pdesc *pd, <span class="enscript-type">struct</span> mbuf *m, <span class="enscript-type">int</span> off,
    <span class="enscript-type">const</span> <span class="enscript-type">struct</span> tcphdr *tcp)
{
	<span class="enscript-type">struct</span> ip *ip;
	<span class="enscript-type">struct</span> ip6_hdr *ip6;
	<span class="enscript-type">char</span> hdr[60];

	<span class="enscript-keyword">if</span> ((pd-&gt;af != PF_INET &amp;&amp; pd-&gt;af != PF_INET6) ||
	    pd-&gt;proto != IPPROTO_TCP ||
	    (tcp-&gt;th_off &lt;&lt; 2) &lt; (<span class="enscript-type">int</span>)<span class="enscript-keyword">sizeof</span> (*tcp))
		<span class="enscript-keyword">return</span> (NULL);

	<span class="enscript-keyword">if</span> (pd-&gt;af == PF_INET) {
		ip = mtod(m, <span class="enscript-type">struct</span> ip *);
		ip6 = (<span class="enscript-type">struct</span> ip6_hdr *)NULL;
	} <span class="enscript-keyword">else</span> {
		ip = (<span class="enscript-type">struct</span> ip *)NULL;
		ip6 = mtod(m, <span class="enscript-type">struct</span> ip6_hdr *);
	}
	<span class="enscript-keyword">if</span> (!pf_pull_hdr(m, off, hdr, tcp-&gt;th_off &lt;&lt; 2, NULL, NULL,
	    pd-&gt;af))
		<span class="enscript-keyword">return</span> (NULL);

	<span class="enscript-keyword">return</span> (pf_osfp_fingerprint_hdr(ip, ip6, (<span class="enscript-type">struct</span> tcphdr *)(<span class="enscript-type">void</span> *)hdr));
}

<span class="enscript-type">struct</span> pf_osfp_enlist *
<span class="enscript-function-name">pf_osfp_fingerprint_hdr</span>(<span class="enscript-type">const</span> <span class="enscript-type">struct</span> ip *ip, <span class="enscript-type">const</span> <span class="enscript-type">struct</span> ip6_hdr *ip6,
    <span class="enscript-type">const</span> <span class="enscript-type">struct</span> tcphdr *tcp)
{
#<span class="enscript-reference">if</span> !<span class="enscript-variable-name">INET6</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">unused</span>(<span class="enscript-variable-name">ip6</span>)
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* !INET6 */</span>
	<span class="enscript-type">struct</span> pf_os_fingerprint fp, *fpresult;
	<span class="enscript-type">int</span> cnt, optlen = 0;
	<span class="enscript-type">const</span> u_int8_t *optp;
	<span class="enscript-type">char</span> srcname[128];

	<span class="enscript-keyword">if</span> ((tcp-&gt;th_flags &amp; (TH_SYN|TH_ACK)) != TH_SYN)
		<span class="enscript-keyword">return</span> (NULL);
	<span class="enscript-keyword">if</span> (ip) {
		<span class="enscript-keyword">if</span> ((ip-&gt;ip_off &amp; htons(IP_OFFMASK)) != 0)
			<span class="enscript-keyword">return</span> (NULL);
	}

	memset(&amp;fp, 0, <span class="enscript-keyword">sizeof</span> (fp));

	<span class="enscript-keyword">if</span> (ip) {
		fp.fp_psize = ntohs(ip-&gt;ip_len);
		fp.fp_ttl = ip-&gt;ip_ttl;
		<span class="enscript-keyword">if</span> (ip-&gt;ip_off &amp; htons(IP_DF))
			fp.fp_flags |= PF_OSFP_DF;
		(<span class="enscript-type">void</span>) inet_ntop(AF_INET, &amp;ip-&gt;ip_src, srcname,
		    (socklen_t)<span class="enscript-keyword">sizeof</span> (srcname));
	}
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET6</span>
	<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (ip6) {
		<span class="enscript-comment">/* jumbo payload? */</span>
		fp.fp_psize = <span class="enscript-keyword">sizeof</span> (<span class="enscript-type">struct</span> ip6_hdr) + ntohs(ip6-&gt;ip6_plen);
		fp.fp_ttl = ip6-&gt;ip6_hlim;
		fp.fp_flags |= PF_OSFP_DF;
		fp.fp_flags |= PF_OSFP_INET6;
		(<span class="enscript-type">void</span>) inet_ntop(AF_INET6, &amp;ip6-&gt;ip6_src, srcname,
		    (socklen_t)<span class="enscript-keyword">sizeof</span> (srcname));
	}
#<span class="enscript-reference">endif</span>
	<span class="enscript-keyword">else</span>
		<span class="enscript-keyword">return</span> (NULL);
	fp.fp_wsize = ntohs(tcp-&gt;th_win);


	cnt = (tcp-&gt;th_off &lt;&lt; 2) - <span class="enscript-keyword">sizeof</span> (*tcp);
	optp = (<span class="enscript-type">const</span> u_int8_t *)((<span class="enscript-type">const</span> <span class="enscript-type">char</span> *)tcp + <span class="enscript-keyword">sizeof</span> (*tcp));
	<span class="enscript-keyword">for</span> (; cnt &gt; 0; cnt -= optlen, optp += optlen) {
		<span class="enscript-keyword">if</span> (*optp == TCPOPT_EOL)
			<span class="enscript-keyword">break</span>;

		fp.fp_optcnt++;
		<span class="enscript-keyword">if</span> (*optp == TCPOPT_NOP) {
			fp.fp_tcpopts = (fp.fp_tcpopts &lt;&lt; PF_OSFP_TCPOPT_BITS) |
			    PF_OSFP_TCPOPT_NOP;
			optlen = 1;
		} <span class="enscript-keyword">else</span> {
			<span class="enscript-keyword">if</span> (cnt &lt; 2)
				<span class="enscript-keyword">return</span> (NULL);
			optlen = optp[1];
			<span class="enscript-keyword">if</span> (optlen &gt; cnt || optlen &lt; 2)
				<span class="enscript-keyword">return</span> (NULL);
			<span class="enscript-keyword">switch</span> (*optp) {
			<span class="enscript-keyword">case</span> <span class="enscript-reference">TCPOPT_MAXSEG</span>:
				<span class="enscript-keyword">if</span> (optlen &gt;= TCPOLEN_MAXSEG)
					memcpy(&amp;fp.fp_mss, &amp;optp[2],
					    <span class="enscript-keyword">sizeof</span> (fp.fp_mss));
				fp.fp_tcpopts = (fp.fp_tcpopts &lt;&lt;
				    PF_OSFP_TCPOPT_BITS) | PF_OSFP_TCPOPT_MSS;
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">BYTE_ORDER</span> != <span class="enscript-variable-name">BIG_ENDIAN</span>
				NTOHS(fp.fp_mss);
#<span class="enscript-reference">endif</span>
				<span class="enscript-keyword">break</span>;
			<span class="enscript-keyword">case</span> <span class="enscript-reference">TCPOPT_WINDOW</span>:
				<span class="enscript-keyword">if</span> (optlen &gt;= TCPOLEN_WINDOW)
					memcpy(&amp;fp.fp_wscale, &amp;optp[2],
					    <span class="enscript-keyword">sizeof</span> (fp.fp_wscale));
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">BYTE_ORDER</span> != <span class="enscript-variable-name">BIG_ENDIAN</span>
				NTOHS(fp.fp_wscale);
#<span class="enscript-reference">endif</span>
				fp.fp_tcpopts = (fp.fp_tcpopts &lt;&lt;
				    PF_OSFP_TCPOPT_BITS) |
				    PF_OSFP_TCPOPT_WSCALE;
				<span class="enscript-keyword">break</span>;
			<span class="enscript-keyword">case</span> <span class="enscript-reference">TCPOPT_SACK_PERMITTED</span>:
				fp.fp_tcpopts = (fp.fp_tcpopts &lt;&lt;
				    PF_OSFP_TCPOPT_BITS) | PF_OSFP_TCPOPT_SACK;
				<span class="enscript-keyword">break</span>;
			<span class="enscript-keyword">case</span> <span class="enscript-reference">TCPOPT_TIMESTAMP</span>:
				<span class="enscript-keyword">if</span> (optlen &gt;= TCPOLEN_TIMESTAMP) {
					u_int32_t ts;
					memcpy(&amp;ts, &amp;optp[2], <span class="enscript-keyword">sizeof</span> (ts));
					<span class="enscript-keyword">if</span> (ts == 0)
						fp.fp_flags |= PF_OSFP_TS0;

				}
				fp.fp_tcpopts = (fp.fp_tcpopts &lt;&lt;
				    PF_OSFP_TCPOPT_BITS) | PF_OSFP_TCPOPT_TS;
				<span class="enscript-keyword">break</span>;
			<span class="enscript-reference">default</span>:
				<span class="enscript-keyword">return</span> (NULL);
			}
		}
		optlen = MAX(optlen, 1);	<span class="enscript-comment">/* paranoia */</span>
	}

	DPFPRINTF(<span class="enscript-string">&quot;fingerprinted %s:%d  %d:%d:%d:%d:%llx (%d) &quot;</span>
	    <span class="enscript-string">&quot;(TS=%s,M=%s%d,W=%s%d)\n&quot;</span>,
	    srcname, ntohs(tcp-&gt;th_sport),
	    fp.fp_wsize, fp.fp_ttl, (fp.fp_flags &amp; PF_OSFP_DF) != 0,
	    fp.fp_psize, (<span class="enscript-type">long</span> <span class="enscript-type">long</span> <span class="enscript-type">int</span>)fp.fp_tcpopts, fp.fp_optcnt,
	    (fp.fp_flags &amp; PF_OSFP_TS0) ? <span class="enscript-string">&quot;0&quot;</span> : <span class="enscript-string">&quot;&quot;</span>,
	    (fp.fp_flags &amp; PF_OSFP_MSS_MOD) ? <span class="enscript-string">&quot;%&quot;</span> :
	    (fp.fp_flags &amp; PF_OSFP_MSS_DC) ? <span class="enscript-string">&quot;*&quot;</span> : <span class="enscript-string">&quot;&quot;</span>,
	    fp.fp_mss,
	    (fp.fp_flags &amp; PF_OSFP_WSCALE_MOD) ? <span class="enscript-string">&quot;%&quot;</span> :
	    (fp.fp_flags &amp; PF_OSFP_WSCALE_DC) ? <span class="enscript-string">&quot;*&quot;</span> : <span class="enscript-string">&quot;&quot;</span>,
	    fp.fp_wscale);

	<span class="enscript-keyword">if</span> ((fpresult = pf_osfp_find(&amp;pf_osfp_list, &amp;fp,
	    PF_OSFP_MAXTTL_OFFSET)))
		<span class="enscript-keyword">return</span> (&amp;fpresult-&gt;fp_oses);
	<span class="enscript-keyword">return</span> (NULL);
}

<span class="enscript-comment">/* Match a fingerprint ID against a list of OSes */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">pf_osfp_match</span>(<span class="enscript-type">struct</span> pf_osfp_enlist *list, pf_osfp_t os)
{
	<span class="enscript-type">struct</span> pf_osfp_entry *entry;
	<span class="enscript-type">int</span> os_class, os_version, os_subtype;
	<span class="enscript-type">int</span> en_class, en_version, en_subtype;

	<span class="enscript-keyword">if</span> (os == PF_OSFP_ANY)
		<span class="enscript-keyword">return</span> (1);
	<span class="enscript-keyword">if</span> (list == NULL) {
		DPFPRINTF(<span class="enscript-string">&quot;osfp no match against %x\n&quot;</span>, os);
		<span class="enscript-keyword">return</span> (os == PF_OSFP_UNKNOWN);
	}
	PF_OSFP_UNPACK(os, os_class, os_version, os_subtype);
	SLIST_FOREACH(entry, list, fp_entry) {
		PF_OSFP_UNPACK(entry-&gt;fp_os, en_class, en_version, en_subtype);
		<span class="enscript-keyword">if</span> ((os_class == PF_OSFP_ANY || en_class == os_class) &amp;&amp;
		    (os_version == PF_OSFP_ANY || en_version == os_version) &amp;&amp;
		    (os_subtype == PF_OSFP_ANY || en_subtype == os_subtype)) {
			DPFPRINTF(<span class="enscript-string">&quot;osfp matched %s %s %s  %x==%x\n&quot;</span>,
			    entry-&gt;fp_class_nm, entry-&gt;fp_version_nm,
			    entry-&gt;fp_subtype_nm, os, entry-&gt;fp_os);
			<span class="enscript-keyword">return</span> (1);
		}
	}
	DPFPRINTF(<span class="enscript-string">&quot;fingerprint 0x%x didn't match\n&quot;</span>, os);
	<span class="enscript-keyword">return</span> (0);
}

<span class="enscript-comment">/* Initialize the OS fingerprint system */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">pf_osfp_initialize</span>(<span class="enscript-type">void</span>)
{
	pool_init(&amp;pf_osfp_entry_pl, <span class="enscript-keyword">sizeof</span> (<span class="enscript-type">struct</span> pf_osfp_entry), 0, 0, 0,
	    <span class="enscript-string">&quot;pfosfpen&quot;</span>, NULL);
	pool_init(&amp;pf_osfp_pl, <span class="enscript-keyword">sizeof</span> (<span class="enscript-type">struct</span> pf_os_fingerprint), 0, 0, 0,
	    <span class="enscript-string">&quot;pfosfp&quot;</span>, NULL);
	SLIST_INIT(&amp;pf_osfp_list);
}

#<span class="enscript-reference">if</span> 0
<span class="enscript-type">void</span>
<span class="enscript-function-name">pf_osfp_destroy</span>(<span class="enscript-type">void</span>)
{
	pf_osfp_flush();

	pool_destroy(&amp;pf_osfp_pl);
	pool_destroy(&amp;pf_osfp_entry_pl);
}
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">/* Flush the fingerprint list */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">pf_osfp_flush</span>(<span class="enscript-type">void</span>)
{
	<span class="enscript-type">struct</span> pf_os_fingerprint *fp;
	<span class="enscript-type">struct</span> pf_osfp_entry *entry;

	<span class="enscript-keyword">while</span> ((fp = SLIST_FIRST(&amp;pf_osfp_list))) {
		SLIST_REMOVE_HEAD(&amp;pf_osfp_list, fp_next);
		<span class="enscript-keyword">while</span> ((entry = SLIST_FIRST(&amp;fp-&gt;fp_oses))) {
			SLIST_REMOVE_HEAD(&amp;fp-&gt;fp_oses, fp_entry);
			pool_put(&amp;pf_osfp_entry_pl, entry);
		}
		pool_put(&amp;pf_osfp_pl, fp);
	}
}


<span class="enscript-comment">/* Add a fingerprint */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">pf_osfp_add</span>(<span class="enscript-type">struct</span> pf_osfp_ioctl *fpioc)
{
	<span class="enscript-type">struct</span> pf_os_fingerprint *fp, fpadd;
	<span class="enscript-type">struct</span> pf_osfp_entry *entry, *uentry;

	memset(&amp;fpadd, 0, <span class="enscript-keyword">sizeof</span> (fpadd));
	fpadd.fp_tcpopts = fpioc-&gt;fp_tcpopts;
	fpadd.fp_wsize = fpioc-&gt;fp_wsize;
	fpadd.fp_psize = fpioc-&gt;fp_psize;
	fpadd.fp_mss = fpioc-&gt;fp_mss;
	fpadd.fp_flags = fpioc-&gt;fp_flags;
	fpadd.fp_optcnt = fpioc-&gt;fp_optcnt;
	fpadd.fp_wscale = fpioc-&gt;fp_wscale;
	fpadd.fp_ttl = fpioc-&gt;fp_ttl;

	uentry = &amp;fpioc-&gt;fp_os;
	uentry-&gt;fp_entry.sle_next = NULL;
	uentry-&gt;fp_class_nm[<span class="enscript-keyword">sizeof</span> (uentry-&gt;fp_class_nm) - 1] = <span class="enscript-string">'\0'</span>;
	uentry-&gt;fp_version_nm[<span class="enscript-keyword">sizeof</span> (uentry-&gt;fp_version_nm) - 1] = <span class="enscript-string">'\0'</span>;
	uentry-&gt;fp_subtype_nm[<span class="enscript-keyword">sizeof</span> (uentry-&gt;fp_subtype_nm) - 1] = <span class="enscript-string">'\0'</span>;

	DPFPRINTF(<span class="enscript-string">&quot;adding osfp %s %s %s = %s%d:%d:%d:%s%d:0x%llx %d &quot;</span>
	    <span class="enscript-string">&quot;(TS=%s,M=%s%d,W=%s%d) %x\n&quot;</span>,
	    fpioc-&gt;fp_os.fp_class_nm, fpioc-&gt;fp_os.fp_version_nm,
	    fpioc-&gt;fp_os.fp_subtype_nm,
	    (fpadd.fp_flags &amp; PF_OSFP_WSIZE_MOD) ? <span class="enscript-string">&quot;%&quot;</span> :
	    (fpadd.fp_flags &amp; PF_OSFP_WSIZE_MSS) ? <span class="enscript-string">&quot;S&quot;</span> :
	    (fpadd.fp_flags &amp; PF_OSFP_WSIZE_MTU) ? <span class="enscript-string">&quot;T&quot;</span> :
	    (fpadd.fp_flags &amp; PF_OSFP_WSIZE_DC) ? <span class="enscript-string">&quot;*&quot;</span> : <span class="enscript-string">&quot;&quot;</span>,
	    fpadd.fp_wsize,
	    fpadd.fp_ttl,
	    (fpadd.fp_flags &amp; PF_OSFP_DF) ? 1 : 0,
	    (fpadd.fp_flags &amp; PF_OSFP_PSIZE_MOD) ? <span class="enscript-string">&quot;%&quot;</span> :
	    (fpadd.fp_flags &amp; PF_OSFP_PSIZE_DC) ? <span class="enscript-string">&quot;*&quot;</span> : <span class="enscript-string">&quot;&quot;</span>,
	    fpadd.fp_psize,
	    (<span class="enscript-type">long</span> <span class="enscript-type">long</span> <span class="enscript-type">int</span>)fpadd.fp_tcpopts, fpadd.fp_optcnt,
	    (fpadd.fp_flags &amp; PF_OSFP_TS0) ? <span class="enscript-string">&quot;0&quot;</span> : <span class="enscript-string">&quot;&quot;</span>,
	    (fpadd.fp_flags &amp; PF_OSFP_MSS_MOD) ? <span class="enscript-string">&quot;%&quot;</span> :
	    (fpadd.fp_flags &amp; PF_OSFP_MSS_DC) ? <span class="enscript-string">&quot;*&quot;</span> : <span class="enscript-string">&quot;&quot;</span>,
	    fpadd.fp_mss,
	    (fpadd.fp_flags &amp; PF_OSFP_WSCALE_MOD) ? <span class="enscript-string">&quot;%&quot;</span> :
	    (fpadd.fp_flags &amp; PF_OSFP_WSCALE_DC) ? <span class="enscript-string">&quot;*&quot;</span> : <span class="enscript-string">&quot;&quot;</span>,
	    fpadd.fp_wscale,
	    fpioc-&gt;fp_os.fp_os);


	<span class="enscript-keyword">if</span> ((fp = pf_osfp_find_exact(&amp;pf_osfp_list, &amp;fpadd))) {
		SLIST_FOREACH(entry, &amp;fp-&gt;fp_oses, fp_entry) {
			<span class="enscript-keyword">if</span> (PF_OSFP_ENTRY_EQ(entry, &amp;fpioc-&gt;fp_os))
				<span class="enscript-keyword">return</span> (EEXIST);
		}
		<span class="enscript-keyword">if</span> ((entry = pool_get(&amp;pf_osfp_entry_pl, PR_WAITOK)) == NULL)
			<span class="enscript-keyword">return</span> (ENOMEM);
	} <span class="enscript-keyword">else</span> {
		<span class="enscript-keyword">if</span> ((fp = pool_get(&amp;pf_osfp_pl, PR_WAITOK)) == NULL)
			<span class="enscript-keyword">return</span> (ENOMEM);
		memset(fp, 0, <span class="enscript-keyword">sizeof</span> (*fp));
		fp-&gt;fp_tcpopts = fpioc-&gt;fp_tcpopts;
		fp-&gt;fp_wsize = fpioc-&gt;fp_wsize;
		fp-&gt;fp_psize = fpioc-&gt;fp_psize;
		fp-&gt;fp_mss = fpioc-&gt;fp_mss;
		fp-&gt;fp_flags = fpioc-&gt;fp_flags;
		fp-&gt;fp_optcnt = fpioc-&gt;fp_optcnt;
		fp-&gt;fp_wscale = fpioc-&gt;fp_wscale;
		fp-&gt;fp_ttl = fpioc-&gt;fp_ttl;
		SLIST_INIT(&amp;fp-&gt;fp_oses);
		<span class="enscript-keyword">if</span> ((entry = pool_get(&amp;pf_osfp_entry_pl, PR_WAITOK)) == NULL) {
			pool_put(&amp;pf_osfp_pl, fp);
			<span class="enscript-keyword">return</span> (ENOMEM);
		}
		pf_osfp_insert(&amp;pf_osfp_list, fp);
	}
	memcpy(entry, &amp;fpioc-&gt;fp_os, <span class="enscript-keyword">sizeof</span> (*entry));

	<span class="enscript-comment">/* Make sure the strings are NUL terminated */</span>
	entry-&gt;fp_class_nm[<span class="enscript-keyword">sizeof</span> (entry-&gt;fp_class_nm)-1] = <span class="enscript-string">'\0'</span>;
	entry-&gt;fp_version_nm[<span class="enscript-keyword">sizeof</span> (entry-&gt;fp_version_nm)-1] = <span class="enscript-string">'\0'</span>;
	entry-&gt;fp_subtype_nm[<span class="enscript-keyword">sizeof</span> (entry-&gt;fp_subtype_nm)-1] = <span class="enscript-string">'\0'</span>;

	SLIST_INSERT_HEAD(&amp;fp-&gt;fp_oses, entry, fp_entry);

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">PFDEBUG</span>
	<span class="enscript-keyword">if</span> ((fp = pf_osfp_validate()))
		printf(<span class="enscript-string">&quot;Invalid fingerprint list\n&quot;</span>);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* PFDEBUG */</span>
	<span class="enscript-keyword">return</span> (0);
}


<span class="enscript-comment">/* Find a fingerprint in the list */</span>
<span class="enscript-type">struct</span> pf_os_fingerprint *
<span class="enscript-function-name">pf_osfp_find</span>(<span class="enscript-type">struct</span> pf_osfp_list *list, <span class="enscript-type">struct</span> pf_os_fingerprint *find,
    u_int8_t ttldiff)
{
	<span class="enscript-type">struct</span> pf_os_fingerprint *f;

#<span class="enscript-reference">define</span> <span class="enscript-function-name">MATCH_INT</span>(_MOD, _DC, _field)					\
	<span class="enscript-keyword">if</span> ((f-&gt;fp_flags &amp; _DC) == 0) {					\
		<span class="enscript-keyword">if</span> ((f-&gt;fp_flags &amp; _MOD) == 0) {			\
			<span class="enscript-keyword">if</span> (f-&gt;_field != find-&gt;_field)			\
				<span class="enscript-keyword">continue</span>;				\
		} <span class="enscript-keyword">else</span> {						\
			<span class="enscript-keyword">if</span> (f-&gt;_field == 0 || find-&gt;_field % f-&gt;_field)	\
				<span class="enscript-keyword">continue</span>;				\
		}							\
	}

	SLIST_FOREACH(f, list, fp_next) {
		<span class="enscript-keyword">if</span> (f-&gt;fp_tcpopts != find-&gt;fp_tcpopts ||
		    f-&gt;fp_optcnt != find-&gt;fp_optcnt ||
		    f-&gt;fp_ttl &lt; find-&gt;fp_ttl ||
		    f-&gt;fp_ttl - find-&gt;fp_ttl &gt; ttldiff ||
		    (f-&gt;fp_flags &amp; (PF_OSFP_DF|PF_OSFP_TS0)) !=
		    (find-&gt;fp_flags &amp; (PF_OSFP_DF|PF_OSFP_TS0)))
			<span class="enscript-keyword">continue</span>;

		MATCH_INT(PF_OSFP_PSIZE_MOD, PF_OSFP_PSIZE_DC, fp_psize)
		MATCH_INT(PF_OSFP_MSS_MOD, PF_OSFP_MSS_DC, fp_mss)
		MATCH_INT(PF_OSFP_WSCALE_MOD, PF_OSFP_WSCALE_DC, fp_wscale)
		<span class="enscript-keyword">if</span> ((f-&gt;fp_flags &amp; PF_OSFP_WSIZE_DC) == 0) {
			<span class="enscript-keyword">if</span> (f-&gt;fp_flags &amp; PF_OSFP_WSIZE_MSS) {
				<span class="enscript-keyword">if</span> (find-&gt;fp_mss == 0)
					<span class="enscript-keyword">continue</span>;

<span class="enscript-comment">/*
 * Some &quot;smart&quot; NAT devices and DSL routers will tweak the MSS size and
 * will set it to whatever is suitable for the link type.
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SMART_MSS</span>	1460
				<span class="enscript-keyword">if</span> ((find-&gt;fp_wsize % find-&gt;fp_mss ||
				    find-&gt;fp_wsize / find-&gt;fp_mss !=
				    f-&gt;fp_wsize) &amp;&amp;
				    (find-&gt;fp_wsize % SMART_MSS ||
				    find-&gt;fp_wsize / SMART_MSS !=
				    f-&gt;fp_wsize))
					<span class="enscript-keyword">continue</span>;
			} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (f-&gt;fp_flags &amp; PF_OSFP_WSIZE_MTU) {
				<span class="enscript-keyword">if</span> (find-&gt;fp_mss == 0)
					<span class="enscript-keyword">continue</span>;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MTUOFF</span>	(sizeof (struct ip) + sizeof (struct tcphdr))
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SMART_MTU</span>	(SMART_MSS + MTUOFF)
				<span class="enscript-keyword">if</span> ((find-&gt;fp_wsize % (find-&gt;fp_mss + MTUOFF) ||
				    find-&gt;fp_wsize / (find-&gt;fp_mss + MTUOFF) !=
				    f-&gt;fp_wsize) &amp;&amp;
				    (find-&gt;fp_wsize % SMART_MTU ||
				    find-&gt;fp_wsize / SMART_MTU !=
				    f-&gt;fp_wsize))
					<span class="enscript-keyword">continue</span>;
			} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (f-&gt;fp_flags &amp; PF_OSFP_WSIZE_MOD) {
				<span class="enscript-keyword">if</span> (f-&gt;fp_wsize == 0 || find-&gt;fp_wsize %
				    f-&gt;fp_wsize)
					<span class="enscript-keyword">continue</span>;
			} <span class="enscript-keyword">else</span> {
				<span class="enscript-keyword">if</span> (f-&gt;fp_wsize != find-&gt;fp_wsize)
					<span class="enscript-keyword">continue</span>;
			}
		}
		<span class="enscript-keyword">return</span> (f);
	}

	<span class="enscript-keyword">return</span> (NULL);
}

<span class="enscript-comment">/* Find an exact fingerprint in the list */</span>
<span class="enscript-type">struct</span> pf_os_fingerprint *
<span class="enscript-function-name">pf_osfp_find_exact</span>(<span class="enscript-type">struct</span> pf_osfp_list *list, <span class="enscript-type">struct</span> pf_os_fingerprint *find)
{
	<span class="enscript-type">struct</span> pf_os_fingerprint *f;

	SLIST_FOREACH(f, list, fp_next) {
		<span class="enscript-keyword">if</span> (f-&gt;fp_tcpopts == find-&gt;fp_tcpopts &amp;&amp;
		    f-&gt;fp_wsize == find-&gt;fp_wsize &amp;&amp;
		    f-&gt;fp_psize == find-&gt;fp_psize &amp;&amp;
		    f-&gt;fp_mss == find-&gt;fp_mss &amp;&amp;
		    f-&gt;fp_flags == find-&gt;fp_flags &amp;&amp;
		    f-&gt;fp_optcnt == find-&gt;fp_optcnt &amp;&amp;
		    f-&gt;fp_wscale == find-&gt;fp_wscale &amp;&amp;
		    f-&gt;fp_ttl == find-&gt;fp_ttl)
			<span class="enscript-keyword">return</span> (f);
	}

	<span class="enscript-keyword">return</span> (NULL);
}

<span class="enscript-comment">/* Insert a fingerprint into the list */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">pf_osfp_insert</span>(<span class="enscript-type">struct</span> pf_osfp_list *list, <span class="enscript-type">struct</span> pf_os_fingerprint *ins)
{
	<span class="enscript-type">struct</span> pf_os_fingerprint *f, *prev = NULL;

	<span class="enscript-comment">/* XXX need to go semi tree based.  can key on tcp options */</span>

	SLIST_FOREACH(f, list, fp_next)
		prev = f;
	<span class="enscript-keyword">if</span> (prev)
		SLIST_INSERT_AFTER(prev, ins, fp_next);
	<span class="enscript-keyword">else</span>
		SLIST_INSERT_HEAD(list, ins, fp_next);
}

<span class="enscript-comment">/* Fill a fingerprint by its number (from an ioctl) */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">pf_osfp_get</span>(<span class="enscript-type">struct</span> pf_osfp_ioctl *fpioc)
{
	<span class="enscript-type">struct</span> pf_os_fingerprint *fp;
	<span class="enscript-type">struct</span> pf_osfp_entry *entry;
	<span class="enscript-type">int</span> num = fpioc-&gt;fp_getnum;
	<span class="enscript-type">int</span> i = 0;


	memset(fpioc, 0, <span class="enscript-keyword">sizeof</span> (*fpioc));
	SLIST_FOREACH(fp, &amp;pf_osfp_list, fp_next) {
		SLIST_FOREACH(entry, &amp;fp-&gt;fp_oses, fp_entry) {
			<span class="enscript-keyword">if</span> (i++ == num) {
				fpioc-&gt;fp_mss = fp-&gt;fp_mss;
				fpioc-&gt;fp_wsize = fp-&gt;fp_wsize;
				fpioc-&gt;fp_flags = fp-&gt;fp_flags;
				fpioc-&gt;fp_psize = fp-&gt;fp_psize;
				fpioc-&gt;fp_ttl = fp-&gt;fp_ttl;
				fpioc-&gt;fp_wscale = fp-&gt;fp_wscale;
				fpioc-&gt;fp_getnum = num;
				memcpy(&amp;fpioc-&gt;fp_os, entry,
				    <span class="enscript-keyword">sizeof</span> (fpioc-&gt;fp_os));
				fpioc-&gt;fp_os.fp_entry.sle_next = NULL;
				<span class="enscript-keyword">return</span> (0);
			}
		}
	}

	<span class="enscript-keyword">return</span> (EBUSY);
}


<span class="enscript-comment">/* Validate that each signature is reachable */</span>
<span class="enscript-type">struct</span> pf_os_fingerprint *
<span class="enscript-function-name">pf_osfp_validate</span>(<span class="enscript-type">void</span>)
{
	<span class="enscript-type">struct</span> pf_os_fingerprint *f, *f2, find;

	SLIST_FOREACH(f, &amp;pf_osfp_list, fp_next) {
		memcpy(&amp;find, f, <span class="enscript-keyword">sizeof</span> (find));

		<span class="enscript-comment">/* We do a few MSS/th_win percolations to make things unique */</span>
		<span class="enscript-keyword">if</span> (find.fp_mss == 0)
			find.fp_mss = 128;
		<span class="enscript-keyword">if</span> (f-&gt;fp_flags &amp; PF_OSFP_WSIZE_MSS)
			find.fp_wsize *= find.fp_mss;
		<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (f-&gt;fp_flags &amp; PF_OSFP_WSIZE_MTU)
			find.fp_wsize *= (find.fp_mss + 40);
		<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (f-&gt;fp_flags &amp; PF_OSFP_WSIZE_MOD)
			find.fp_wsize *= 2;
		<span class="enscript-keyword">if</span> (f != (f2 = pf_osfp_find(&amp;pf_osfp_list, &amp;find, 0))) {
			<span class="enscript-keyword">if</span> (f2)
				printf(<span class="enscript-string">&quot;Found \&quot;%s %s %s\&quot; instead of &quot;</span>
				    <span class="enscript-string">&quot;\&quot;%s %s %s\&quot;\n&quot;</span>,
				    SLIST_FIRST(&amp;f2-&gt;fp_oses)-&gt;fp_class_nm,
				    SLIST_FIRST(&amp;f2-&gt;fp_oses)-&gt;fp_version_nm,
				    SLIST_FIRST(&amp;f2-&gt;fp_oses)-&gt;fp_subtype_nm,
				    SLIST_FIRST(&amp;f-&gt;fp_oses)-&gt;fp_class_nm,
				    SLIST_FIRST(&amp;f-&gt;fp_oses)-&gt;fp_version_nm,
				    SLIST_FIRST(&amp;f-&gt;fp_oses)-&gt;fp_subtype_nm);
			<span class="enscript-keyword">else</span>
				printf(<span class="enscript-string">&quot;Couldn't find \&quot;%s %s %s\&quot;\n&quot;</span>,
				    SLIST_FIRST(&amp;f-&gt;fp_oses)-&gt;fp_class_nm,
				    SLIST_FIRST(&amp;f-&gt;fp_oses)-&gt;fp_version_nm,
				    SLIST_FIRST(&amp;f-&gt;fp_oses)-&gt;fp_subtype_nm);
			<span class="enscript-keyword">return</span> (f);
		}
	}
	<span class="enscript-keyword">return</span> (NULL);
}
</pre>
<hr />
</body></html>