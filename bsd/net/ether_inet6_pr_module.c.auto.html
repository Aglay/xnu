<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>ether_inet6_pr_module.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">ether_inet6_pr_module.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000-2013 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 *
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 *
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 *
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*
 * Copyright (c) 1982, 1989, 1993
 *	The Regents of the University of California.  All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. All advertising materials mentioning features or use of this software
 *    must display the following acknowledgement:
 *	This product includes software developed by the University of
 *	California, Berkeley and its contributors.
 * 4. Neither the name of the University nor the names of its contributors
 *    may be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/param.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/systm.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/kernel.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/malloc.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/mbuf.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/socket.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/sockio.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/sysctl.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/socketvar.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/dlil.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/if.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/route.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/if_llc.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/if_dl.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/if_types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/ndrv.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/kpi_protocol.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/dlil.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/in.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/in_var.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/if_ether.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/in_systm.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/ip.h&gt;</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">INET6</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet6/nd6.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet6/in6_ifattach.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet6/ip6_var.h&gt;</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">/* #include &quot;vlan.h&quot; */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">NVLAN</span> &gt; 0
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/if_vlan_var.h&gt;</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* NVLAN &gt; 0 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/ether_if_module.h&gt;</span>

<span class="enscript-type">static</span> <span class="enscript-type">const</span> u_char etherip6allnodes[ETHER_ADDR_LEN] =
	{ 0x33, 0x33, 0, 0, 0, 1 };

<span class="enscript-comment">/*
 * Process a received Ethernet packet;
 * the packet is in the mbuf chain m without
 * the ether header, which is provided separately.
 */</span>
<span class="enscript-type">static</span> errno_t
<span class="enscript-function-name">ether_inet6_input</span>(ifnet_t ifp, protocol_family_t protocol,
    mbuf_t packet, <span class="enscript-type">char</span> *header)
{
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">unused</span>(<span class="enscript-variable-name">ifp</span>, <span class="enscript-variable-name">protocol</span>)
	<span class="enscript-type">struct</span> ether_header *eh = (<span class="enscript-type">struct</span> ether_header *)(<span class="enscript-type">void</span> *)header;
	u_int16_t ether_type;

	bcopy(&amp;eh-&gt;ether_type, &amp;ether_type, <span class="enscript-keyword">sizeof</span> (ether_type));

	<span class="enscript-keyword">if</span> (ether_type == htons(ETHERTYPE_IPV6)) {
		<span class="enscript-type">struct</span> ifnet *mifp;
		<span class="enscript-comment">/*
		 * Trust the ifp in the mbuf, rather than ifproto's
		 * since the packet could have been injected via
		 * a dlil_input_packet_list() using an ifp that is
		 * different than the one where the packet really
		 * came from.
		 */</span>
		mifp = mbuf_pkthdr_rcvif(packet);

		<span class="enscript-comment">/* Update L2 reachability record, if present (and not bcast) */</span>
		<span class="enscript-keyword">if</span> (bcmp(eh-&gt;ether_shost, etherbroadcastaddr,
		    ETHER_ADDR_LEN) != 0) {
			nd6_llreach_set_reachable(mifp, eh-&gt;ether_shost,
			    ETHER_ADDR_LEN);
		}

		<span class="enscript-comment">/* Save the Ethernet source address for all-nodes multicasts */</span>
		<span class="enscript-keyword">if</span> (!bcmp(eh-&gt;ether_dhost, etherip6allnodes, ETHER_ADDR_LEN)) {
			<span class="enscript-type">struct</span> ip6aux *ip6a;

			ip6a = ip6_addaux(packet);
			<span class="enscript-keyword">if</span> (ip6a) {
				ip6a-&gt;ip6a_flags |= IP6A_HASEEN;
				bcopy(eh-&gt;ether_shost, ip6a-&gt;ip6a_ehsrc,
				    ETHER_ADDR_LEN);
			}
		}

		<span class="enscript-keyword">if</span> (proto_input(protocol, packet) != 0)
			m_freem(packet);
	} <span class="enscript-keyword">else</span> {
		m_freem(packet);
	}

	<span class="enscript-keyword">return</span> (EJUSTRETURN);
}

<span class="enscript-type">static</span> errno_t
<span class="enscript-function-name">ether_inet6_pre_output</span>(ifnet_t ifp, protocol_family_t protocol_family,
    mbuf_t *m0, <span class="enscript-type">const</span> <span class="enscript-type">struct</span> sockaddr *dst_netaddr, <span class="enscript-type">void</span> *route,
    <span class="enscript-type">char</span> *type, <span class="enscript-type">char</span> *edst)
{
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">unused</span>(<span class="enscript-variable-name">protocol_family</span>)
	errno_t	result;
	<span class="enscript-type">struct</span> sockaddr_dl sdl;
	<span class="enscript-type">struct</span> mbuf *m = *m0;

	<span class="enscript-comment">/*
	 * Tell ether_frameout it's ok to loop packet if necessary
	 */</span>
	m-&gt;m_flags |= M_LOOP;

	result = nd6_lookup_ipv6(ifp, (<span class="enscript-type">const</span> <span class="enscript-type">struct</span> sockaddr_in6 *)
	    (uintptr_t)(size_t)dst_netaddr, &amp;sdl, <span class="enscript-keyword">sizeof</span> (sdl), route, *m0);

	<span class="enscript-keyword">if</span> (result == 0) {
		u_int16_t ethertype_ipv6 = htons(ETHERTYPE_IPV6);

		bcopy(&amp;ethertype_ipv6, type, <span class="enscript-keyword">sizeof</span> (ethertype_ipv6));
		bcopy(LLADDR(&amp;sdl), edst, sdl.sdl_alen);
	}

	<span class="enscript-keyword">return</span> (result);
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">ether_inet6_resolve_multi</span>(ifnet_t ifp, <span class="enscript-type">const</span> <span class="enscript-type">struct</span> sockaddr *proto_addr,
    <span class="enscript-type">struct</span> sockaddr_dl *out_ll, size_t ll_len)
{
	<span class="enscript-type">static</span> <span class="enscript-type">const</span> size_t minsize =
	    offsetof(<span class="enscript-type">struct</span> sockaddr_dl, sdl_data[0]) + ETHER_ADDR_LEN;
	<span class="enscript-type">const</span> <span class="enscript-type">struct</span> sockaddr_in6 *sin6 =
	    (<span class="enscript-type">const</span> <span class="enscript-type">struct</span> sockaddr_in6 *)(uintptr_t)(size_t)proto_addr;

	<span class="enscript-keyword">if</span> (proto_addr-&gt;sa_family != AF_INET6)
		<span class="enscript-keyword">return</span> (EAFNOSUPPORT);

	<span class="enscript-keyword">if</span> (proto_addr-&gt;sa_len &lt; <span class="enscript-keyword">sizeof</span> (<span class="enscript-type">struct</span> sockaddr_in6))
		<span class="enscript-keyword">return</span> (EINVAL);

	<span class="enscript-keyword">if</span> (ll_len &lt; minsize)
		<span class="enscript-keyword">return</span> (EMSGSIZE);

	bzero(out_ll, minsize);
	out_ll-&gt;sdl_len = minsize;
	out_ll-&gt;sdl_family = AF_LINK;
	out_ll-&gt;sdl_index = ifp-&gt;if_index;
	out_ll-&gt;sdl_type = IFT_ETHER;
	out_ll-&gt;sdl_nlen = 0;
	out_ll-&gt;sdl_alen = ETHER_ADDR_LEN;
	out_ll-&gt;sdl_slen = 0;
	ETHER_MAP_IPV6_MULTICAST(&amp;sin6-&gt;sin6_addr, LLADDR(out_ll));

	<span class="enscript-keyword">return</span> (0);
}

<span class="enscript-type">static</span> errno_t
<span class="enscript-function-name">ether_inet6_prmod_ioctl</span>(ifnet_t ifp, protocol_family_t protocol_family,
    u_long command, <span class="enscript-type">void</span> *data)
{
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">unused</span>(<span class="enscript-variable-name">protocol_family</span>)
	<span class="enscript-type">int</span> error = 0;

	<span class="enscript-keyword">switch</span> (command) {
	<span class="enscript-keyword">case</span> <span class="enscript-reference">SIOCSIFADDR</span>:		<span class="enscript-comment">/* struct ifaddr pointer */</span>
		<span class="enscript-comment">/*
		 * Note: caller of ifnet_ioctl() passes in pointer to
		 * struct ifaddr as parameter to SIOCSIFADDR, for legacy
		 * reasons.
		 */</span>
		<span class="enscript-keyword">if</span> ((ifp-&gt;if_flags &amp; IFF_RUNNING) == 0) {
			ifnet_set_flags(ifp, IFF_UP, IFF_UP);
			ifnet_ioctl(ifp, 0, SIOCSIFFLAGS, NULL);
		}
		<span class="enscript-keyword">break</span>;

	<span class="enscript-keyword">case</span> <span class="enscript-reference">SIOCGIFADDR</span>: {		<span class="enscript-comment">/* struct ifreq */</span>
		<span class="enscript-type">struct</span> ifreq *ifr = (<span class="enscript-type">struct</span> ifreq *)(<span class="enscript-type">void</span> *)data;
		(<span class="enscript-type">void</span>) ifnet_guarded_lladdr_copy_bytes(ifp,
		    ifr-&gt;ifr_addr.sa_data, ETHER_ADDR_LEN);
		<span class="enscript-keyword">break</span>;
	}

	<span class="enscript-reference">default</span>:
		error = EOPNOTSUPP;
		<span class="enscript-keyword">break</span>;
	}
	<span class="enscript-keyword">return</span> (error);
}

errno_t
<span class="enscript-function-name">ether_attach_inet6</span>(<span class="enscript-type">struct</span> ifnet *ifp, protocol_family_t protocol_family)
{
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">unused</span>(<span class="enscript-variable-name">protocol_family</span>)
	<span class="enscript-type">struct</span> ifnet_attach_proto_param	proto;
	<span class="enscript-type">struct</span> ifnet_demux_desc demux[1];
	u_short en_6native = htons(ETHERTYPE_IPV6);
	errno_t	error;

	bzero(&amp;proto, <span class="enscript-keyword">sizeof</span> (proto));
	demux[0].type = DLIL_DESC_ETYPE2;
	demux[0].data = &amp;en_6native;
	demux[0].datalen = <span class="enscript-keyword">sizeof</span> (en_6native);
	proto.demux_list = demux;
	proto.demux_count = 1;
	proto.input = ether_inet6_input;
	proto.pre_output = ether_inet6_pre_output;
	proto.ioctl = ether_inet6_prmod_ioctl;
	proto.resolve = ether_inet6_resolve_multi;
	error = ifnet_attach_protocol(ifp, protocol_family, &amp;proto);
	<span class="enscript-keyword">if</span> (error &amp;&amp; error != EEXIST) {
		printf(<span class="enscript-string">&quot;WARNING: %s can't attach ipv6 to %s\n&quot;</span>, __func__,
		    if_name(ifp));
	}

	<span class="enscript-keyword">return</span> (error);
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">ether_detach_inet6</span>(<span class="enscript-type">struct</span> ifnet *ifp, protocol_family_t protocol_family)
{
	(<span class="enscript-type">void</span>) ifnet_detach_protocol(ifp, protocol_family);
}
</pre>
<hr />
</body></html>