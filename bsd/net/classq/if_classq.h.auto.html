<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>if_classq.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">if_classq.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2011-2013 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 *
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 *
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 *
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_NET_CLASSQ_IF_CLASSQ_H_</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">_NET_CLASSQ_IF_CLASSQ_H_</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">PRIVATE</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">IFCQ_SC_MAX</span>		10		<span class="enscript-comment">/* max number of queues */</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">BSD_KERNEL_PRIVATE</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/classq/classq.h&gt;</span>
<span class="enscript-comment">/* classq dequeue op arg */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> cqdq_op {
	CLASSQDQ_REMOVE =	1,	<span class="enscript-comment">/* dequeue mbuf from the queue */</span>
	CLASSQDQ_POLL =		2,	<span class="enscript-comment">/* don't dequeue mbuf from the queue */</span>
} cqdq_op_t;

<span class="enscript-comment">/* classq request types */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> cqrq {
	CLASSQRQ_PURGE =	1,	<span class="enscript-comment">/* purge all packets */</span>
	CLASSQRQ_PURGE_SC =	2,	<span class="enscript-comment">/* purge service class (and flow) */</span>
	CLASSQRQ_EVENT =	3,	<span class="enscript-comment">/* interface events */</span>
	CLASSQRQ_THROTTLE =	4,	<span class="enscript-comment">/* throttle packets */</span>
	CLASSQRQ_STAT_SC =	5,	<span class="enscript-comment">/* get service class queue stats */</span>
} cqrq_t;

<span class="enscript-comment">/* classq purge_sc request argument */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> cqrq_purge_sc {
	mbuf_svc_class_t	sc;	<span class="enscript-comment">/* (in) service class */</span>
	u_int32_t		flow;	<span class="enscript-comment">/* (in) 0 means all flows */</span>
	u_int32_t		packets; <span class="enscript-comment">/* (out) purged packets */</span>
	u_int32_t		bytes;	<span class="enscript-comment">/* (out) purged bytes */</span>
} cqrq_purge_sc_t;

<span class="enscript-comment">/* classq throttle request argument */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> cqrq_throttle {
	u_int32_t		set;	<span class="enscript-comment">/* set or get */</span>
	u_int32_t		level;	<span class="enscript-comment">/* (in/out) throttling level */</span>
} cqrq_throttle_t;

<span class="enscript-comment">/* classq service class stats request argument */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> cqrq_stat_sc {
	mbuf_svc_class_t	sc;	<span class="enscript-comment">/* (in) service class */</span>
	u_int32_t		packets; <span class="enscript-comment">/* (out) packets enqueued */</span>
	u_int32_t		bytes;	<span class="enscript-comment">/* (out) bytes enqueued */</span>
} cqrq_stat_sc_t;

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PF_ALTQ</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/altq/if_altq.h&gt;</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* PF_ALTQ */</span>

<span class="enscript-comment">/*
 * A token-bucket regulator limits the rate that a network driver can
 * dequeue packets from the output queue.  Modern cards are able to buffer
 * a large amount of packets and dequeue too many packets at a time.  This
 * bursty dequeue behavior makes it impossible to schedule packets by
 * queueing disciplines.  A token-bucket is used to control the burst size
 * in a device independent manner.
 */</span>
<span class="enscript-type">struct</span> tb_regulator {
	u_int64_t	tbr_rate_raw;	<span class="enscript-comment">/* (unscaled) token bucket rate */</span>
	u_int32_t	tbr_percent;	<span class="enscript-comment">/* token bucket rate in percentage */</span>
	int64_t		tbr_rate;	<span class="enscript-comment">/* (scaled) token bucket rate */</span>
	int64_t		tbr_depth;	<span class="enscript-comment">/* (scaled) token bucket depth */</span>

	int64_t		tbr_token;	<span class="enscript-comment">/* (scaled) current token */</span>
	int64_t		tbr_filluptime;	<span class="enscript-comment">/* (scaled) time to fill up bucket */</span>
	u_int64_t	tbr_last;	<span class="enscript-comment">/* last time token was updated */</span>

	<span class="enscript-type">int</span>		tbr_lastop;	<span class="enscript-comment">/* last dequeue operation type */</span>
					<span class="enscript-comment">/*   needed for poll-and-dequeue */</span>
};

<span class="enscript-comment">/* simple token bucket meter profile */</span>
<span class="enscript-type">struct</span> tb_profile {
	u_int64_t	rate;	<span class="enscript-comment">/* rate in bit-per-sec */</span>
	u_int32_t	percent; <span class="enscript-comment">/* rate in percentage */</span>
	u_int32_t	depth;	<span class="enscript-comment">/* depth in bytes */</span>
};

<span class="enscript-type">struct</span> ifclassq;
<span class="enscript-type">enum</span> cqdq_op;
<span class="enscript-type">enum</span> cqrq;

<span class="enscript-type">typedef</span> <span class="enscript-function-name">int</span> (*ifclassq_enq_func)(<span class="enscript-type">struct</span> ifclassq *, <span class="enscript-type">struct</span> mbuf *);
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> mbuf *(*ifclassq_deq_func)(<span class="enscript-type">struct</span> ifclassq *, <span class="enscript-type">enum</span> cqdq_op);
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> mbuf *(*ifclassq_deq_sc_func)(<span class="enscript-type">struct</span> ifclassq *,
    mbuf_svc_class_t, <span class="enscript-type">enum</span> cqdq_op);
<span class="enscript-type">typedef</span> <span class="enscript-function-name">int</span> (*ifclassq_req_func)(<span class="enscript-type">struct</span> ifclassq *, <span class="enscript-type">enum</span> cqrq, <span class="enscript-type">void</span> *);

<span class="enscript-comment">/*
 * Structure defining a queue for a network interface.
 */</span>
<span class="enscript-type">struct</span> ifclassq {
	decl_lck_mtx_data(, ifcq_lock);

	<span class="enscript-type">struct</span> ifnet	*ifcq_ifp;	<span class="enscript-comment">/* back pointer to interface */</span>
	u_int32_t	ifcq_len;	<span class="enscript-comment">/* packet count */</span>
	u_int32_t	ifcq_maxlen;
	<span class="enscript-type">struct</span> pktcntr	ifcq_xmitcnt;
	<span class="enscript-type">struct</span> pktcntr	ifcq_dropcnt;

	u_int32_t	ifcq_type;	<span class="enscript-comment">/* scheduler type */</span>
	u_int32_t	ifcq_flags;	<span class="enscript-comment">/* flags */</span>
	u_int32_t	ifcq_sflags;	<span class="enscript-comment">/* scheduler flags */</span>
	u_int32_t	ifcq_target_qdelay; <span class="enscript-comment">/* target queue delay */</span>
	u_int32_t	ifcq_bytes;	<span class="enscript-comment">/* bytes count */</span>
	<span class="enscript-type">void</span>		*ifcq_disc;	<span class="enscript-comment">/* for scheduler-specific use */</span>
	<span class="enscript-comment">/*
	 * ifcq_disc_slots[] represents the leaf classes configured for the
	 * corresponding discpline/scheduler, ordered by their corresponding
	 * service class index.  Each slot holds the queue ID used to identify
	 * the class instance, as well as the class instance pointer itself.
	 * The latter is used during enqueue and dequeue in order to avoid the
	 * costs associated with looking up the class pointer based on the
	 * queue ID.  The queue ID is used when querying the statistics from
	 * user space.
	 *
	 * Avoiding the use of queue ID during enqueue and dequeue is made
	 * possible by virtue of knowing the particular mbuf service class
	 * associated with the packets.  The service class index of the
	 * packet is used as the index to ifcq_disc_slots[].
	 *
	 * ifcq_disc_slots[] therefore also acts as a lookup table which
	 * provides for the mapping between MBUF_SC values and the actual
	 * scheduler classes.
	 */</span>
	<span class="enscript-type">struct</span> ifclassq_disc_slot {
		u_int32_t	qid;
		<span class="enscript-type">void</span>		*cl;
	} ifcq_disc_slots[IFCQ_SC_MAX]; <span class="enscript-comment">/* for discipline use */</span>

	ifclassq_enq_func	ifcq_enqueue;
	ifclassq_deq_func	ifcq_dequeue;
	ifclassq_deq_sc_func	ifcq_dequeue_sc;
	ifclassq_req_func	ifcq_request;

	<span class="enscript-comment">/* token bucket regulator */</span>
	<span class="enscript-type">struct</span> tb_regulator	ifcq_tbr;	<span class="enscript-comment">/* TBR */</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PF_ALTQ</span>
	u_int32_t	ifcq_drain;
	<span class="enscript-type">struct</span> ifaltq	ifcq_altq;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* PF_ALTQ */</span>
};

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">PF_ALTQ</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_ALTQ</span>(_ifcq)		(&amp;(_ifcq)-&gt;ifcq_altq)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_IS_DRAINING</span>(_ifcq)		((_ifcq)-&gt;ifcq_drain &gt; 0)
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* PF_ALTQ */</span>

<span class="enscript-comment">/* ifcq_flags */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">IFCQF_READY</span>	 0x01		<span class="enscript-comment">/* ifclassq supports discipline */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">IFCQF_ENABLED</span>	 0x02		<span class="enscript-comment">/* ifclassq is in use */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">IFCQF_TBR</span>	 0x04		<span class="enscript-comment">/* Token Bucket Regulator is in use */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_IS_READY</span>(_ifcq)		((_ifcq)-&gt;ifcq_flags &amp; IFCQF_READY)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_IS_ENABLED</span>(_ifcq)		((_ifcq)-&gt;ifcq_flags &amp; IFCQF_ENABLED)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_TBR_IS_ENABLED</span>(_ifcq)	((_ifcq)-&gt;ifcq_flags &amp; IFCQF_TBR)

<span class="enscript-comment">/* classq enqueue return value */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CLASSQEQ_DROPPED</span>	(-1)	<span class="enscript-comment">/* packet dropped (freed)  */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CLASSQEQ_SUCCESS</span>	0	<span class="enscript-comment">/* success, packet enqueued */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CLASSQEQ_SUCCESS_FC</span>	1	<span class="enscript-comment">/* packet enqueued; */</span>
					<span class="enscript-comment">/*   give flow control feedback */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CLASSQEQ_DROPPED_FC</span>	2	<span class="enscript-comment">/* packet dropped; */</span>
					<span class="enscript-comment">/*  give flow control feedback */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CLASSQEQ_DROPPED_SP</span>	3	<span class="enscript-comment">/* packet dropped due to suspension; */</span>
					<span class="enscript-comment">/*  give flow control feedback */</span>

<span class="enscript-comment">/* interface event argument for CLASSQRQ_EVENT */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> cqev {
	CLASSQ_EV_LINK_BANDWIDTH = 1,	<span class="enscript-comment">/* link bandwidth has changed */</span>
	CLASSQ_EV_LINK_LATENCY = 2,	<span class="enscript-comment">/* link latency has changed */</span>
	CLASSQ_EV_LINK_MTU =	3,	<span class="enscript-comment">/* link MTU has changed */</span>
	CLASSQ_EV_LINK_UP =	4,	<span class="enscript-comment">/* link is now up */</span>
	CLASSQ_EV_LINK_DOWN =	5,	<span class="enscript-comment">/* link is now down */</span>
} cqev_t;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* BSD_KERNEL_PRIVATE */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/pktsched/pktsched_priq.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/pktsched/pktsched_fairq.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/pktsched/pktsched_tcq.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/pktsched/pktsched_cbq.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/pktsched/pktsched_hfsc.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/pktsched/pktsched_qfq.h&gt;</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">__cplusplus</span>
<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> {
#<span class="enscript-reference">endif</span>

<span class="enscript-type">struct</span> if_ifclassq_stats {
	u_int32_t	ifqs_len;
	u_int32_t	ifqs_maxlen;
	<span class="enscript-type">struct</span> pktcntr	ifqs_xmitcnt;
	<span class="enscript-type">struct</span> pktcntr	ifqs_dropcnt;
	u_int32_t	ifqs_scheduler;
	<span class="enscript-type">union</span> {
		<span class="enscript-type">struct</span> priq_classstats	ifqs_priq_stats;
		<span class="enscript-type">struct</span> fairq_classstats	ifqs_fairq_stats;
		<span class="enscript-type">struct</span> tcq_classstats	ifqs_tcq_stats;
		<span class="enscript-type">struct</span> cbq_classstats	ifqs_cbq_stats;
		<span class="enscript-type">struct</span> hfsc_classstats	ifqs_hfsc_stats;
		<span class="enscript-type">struct</span> qfq_classstats	ifqs_qfq_stats;
	};
} __attribute__((aligned(8)));

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">__cplusplus</span>
}
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">BSD_KERNEL_PRIVATE</span>
<span class="enscript-comment">/*
 * For ifclassq lock
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_LOCK_ASSERT_HELD</span>(_ifcq)					\
	lck_mtx_assert(&amp;(_ifcq)-&gt;ifcq_lock, LCK_MTX_ASSERT_OWNED)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_LOCK_ASSERT_NOTHELD</span>(_ifcq)					\
	lck_mtx_assert(&amp;(_ifcq)-&gt;ifcq_lock, LCK_MTX_ASSERT_NOTOWNED)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_LOCK</span>(_ifcq)						\
	lck_mtx_lock(&amp;(_ifcq)-&gt;ifcq_lock)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_LOCK_SPIN</span>(_ifcq)						\
	lck_mtx_lock_spin(&amp;(_ifcq)-&gt;ifcq_lock)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_CONVERT_LOCK</span>(_ifcq) do {					\
	IFCQ_LOCK_ASSERT_HELD(_ifcq);					\
	lck_mtx_convert_spin(&amp;(_ifcq)-&gt;ifcq_lock);			\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_UNLOCK</span>(_ifcq)						\
	lck_mtx_unlock(&amp;(_ifcq)-&gt;ifcq_lock)

<span class="enscript-comment">/*
 * For ifclassq operations
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_ENQUEUE</span>(_ifq, _m, _err) do {				\
	(_err) = (*(_ifq)-&gt;ifcq_enqueue)(_ifq, _m);			\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_DEQUEUE</span>(_ifq, _m) do {					\
	(_m) = (*(_ifq)-&gt;ifcq_dequeue)(_ifq, CLASSQDQ_REMOVE);		\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_DEQUEUE_SC</span>(_ifq, _sc, _m) do {				\
	(_m) = (*(_ifq)-&gt;ifcq_dequeue_sc)(_ifq, _sc, CLASSQDQ_REMOVE);	\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_TBR_DEQUEUE</span>(_ifcq, _m) do {				\
	(_m) = ifclassq_tbr_dequeue(_ifcq, CLASSQDQ_REMOVE);		\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_TBR_DEQUEUE_SC</span>(_ifcq, _sc, _m) do {			\
	(_m) = ifclassq_tbr_dequeue_sc(_ifcq, CLASSQDQ_REMOVE, _sc);	\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_POLL</span>(_ifq, _m) do {					\
	(_m) = (*(_ifq)-&gt;ifcq_dequeue)(_ifq, CLASSQDQ_POLL);		\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_POLL_SC</span>(_ifq, _sc, _m) do {				\
	(_m) = (*(_ifq)-&gt;ifcq_dequeue_sc)(_ifq, _sc, CLASSQDQ_POLL);	\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_TBR_POLL</span>(_ifcq, _m) do {					\
	(_m) = ifclassq_tbr_dequeue(_ifcq, CLASSQDQ_POLL);		\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_TBR_POLL_SC</span>(_ifcq, _sc, _m) do {				\
	(_m) = ifclassq_tbr_dequeue_sc(_ifcq, CLASSQDQ_POLL, _sc);	\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_PURGE</span>(_ifq) do {						\
	(<span class="enscript-type">void</span>) (*(_ifq)-&gt;ifcq_request)(_ifq, CLASSQRQ_PURGE, NULL);	\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_PURGE_SC</span>(_ifq, _sc, _flow, _packets, _bytes) do {		\
	cqrq_purge_sc_t _req = { _sc, _flow, 0, 0 };			\
	(<span class="enscript-type">void</span>) (*(_ifq)-&gt;ifcq_request)(_ifq, CLASSQRQ_PURGE_SC, &amp;_req);	\
	(_packets) = _req.packets;					\
	(_bytes) = _req.bytes;						\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_UPDATE</span>(_ifq, _ev) do {					\
	(<span class="enscript-type">void</span>) (*(_ifq)-&gt;ifcq_request)(_ifq, CLASSQRQ_EVENT,		\
	    (<span class="enscript-type">void</span> *)(_ev));						\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_SET_THROTTLE</span>(_ifq, _level, _err) do {			\
	cqrq_throttle_t _req = { 1, _level };				\
	(_err) = (*(_ifq)-&gt;ifcq_request)				\
	    (_ifq, CLASSQRQ_THROTTLE, &amp;_req);				\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_GET_THROTTLE</span>(_ifq, _level, _err) do {			\
	cqrq_throttle_t _req = { 0, IFNET_THROTTLE_OFF };		\
	(_err) = (*(_ifq)-&gt;ifcq_request)				\
	    (_ifq, CLASSQRQ_THROTTLE, &amp;_req);				\
	(_level) = _req.level;						\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_LEN_SC</span>(_ifq, _sc, _packets, _bytes, _err) do {		\
	cqrq_stat_sc_t _req = { _sc, 0, 0 };				\
	(_err) = (*(ifq)-&gt;ifcq_request)(_ifq, CLASSQRQ_STAT_SC, &amp;_req);	\
	<span class="enscript-keyword">if</span> ((_packets) != NULL)						\
		(*(_packets)) = _req.packets;				\
	<span class="enscript-keyword">if</span> ((_bytes) != NULL)						\
		(*(_bytes)) = _req.bytes;				\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_LEN</span>(_ifcq)		((_ifcq)-&gt;ifcq_len)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_QFULL</span>(_ifcq)	(IFCQ_LEN(_ifcq) &gt;= (_ifcq)-&gt;ifcq_maxlen)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_IS_EMPTY</span>(_ifcq)	(IFCQ_LEN(_ifcq) == 0)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_INC_LEN</span>(_ifcq)	(IFCQ_LEN(_ifcq)++)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_DEC_LEN</span>(_ifcq)	(IFCQ_LEN(_ifcq)--)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_MAXLEN</span>(_ifcq)	((_ifcq)-&gt;ifcq_maxlen)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_SET_MAXLEN</span>(_ifcq, _len) ((_ifcq)-&gt;ifcq_maxlen = (_len))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">IFCQ_TARGET_QDELAY</span>(_ifcq)	((_ifcq)-&gt;ifcq_target_qdelay)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_BYTES</span>(_ifcq)	((_ifcq)-&gt;ifcq_bytes)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_INC_BYTES</span>(_ifcq, _len) (IFCQ_BYTES(_ifcq) + _len)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_DEC_BYTES</span>(_ifcq, _len) (IFCQ_BYTES(_ifcq) - _len)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_XMIT_ADD</span>(_ifcq, _pkt, _len) do {				\
	PKTCNTR_ADD(&amp;(_ifcq)-&gt;ifcq_xmitcnt, _pkt, _len);		\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IFCQ_DROP_ADD</span>(_ifcq, _pkt, _len) do {				\
	PKTCNTR_ADD(&amp;(_ifcq)-&gt;ifcq_dropcnt, _pkt, _len);		\
} <span class="enscript-keyword">while</span> (0)

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">ifclassq_setup</span>(<span class="enscript-type">struct</span> ifnet *, u_int32_t, boolean_t);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ifclassq_teardown</span>(<span class="enscript-type">struct</span> ifnet *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">ifclassq_pktsched_setup</span>(<span class="enscript-type">struct</span> ifclassq *);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ifclassq_set_maxlen</span>(<span class="enscript-type">struct</span> ifclassq *, u_int32_t);
<span class="enscript-type">extern</span> u_int32_t <span class="enscript-function-name">ifclassq_get_maxlen</span>(<span class="enscript-type">struct</span> ifclassq *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">ifclassq_get_len</span>(<span class="enscript-type">struct</span> ifclassq *, mbuf_svc_class_t,
    u_int32_t *, u_int32_t *);
<span class="enscript-type">extern</span> errno_t <span class="enscript-function-name">ifclassq_enqueue</span>(<span class="enscript-type">struct</span> ifclassq *, <span class="enscript-type">struct</span> mbuf *);
<span class="enscript-type">extern</span> errno_t <span class="enscript-function-name">ifclassq_dequeue</span>(<span class="enscript-type">struct</span> ifclassq *, u_int32_t, <span class="enscript-type">struct</span> mbuf **,
    <span class="enscript-type">struct</span> mbuf **, u_int32_t *, u_int32_t *);
<span class="enscript-type">extern</span> errno_t <span class="enscript-function-name">ifclassq_dequeue_sc</span>(<span class="enscript-type">struct</span> ifclassq *, mbuf_svc_class_t,
    u_int32_t, <span class="enscript-type">struct</span> mbuf **, <span class="enscript-type">struct</span> mbuf **, u_int32_t *, u_int32_t *);
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> mbuf *<span class="enscript-function-name">ifclassq_poll</span>(<span class="enscript-type">struct</span> ifclassq *);
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> mbuf *<span class="enscript-function-name">ifclassq_poll_sc</span>(<span class="enscript-type">struct</span> ifclassq *, mbuf_svc_class_t);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ifclassq_update</span>(<span class="enscript-type">struct</span> ifclassq *, cqev_t);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">ifclassq_attach</span>(<span class="enscript-type">struct</span> ifclassq *, u_int32_t, <span class="enscript-type">void</span> *,
    ifclassq_enq_func, ifclassq_deq_func, ifclassq_deq_sc_func,
    ifclassq_req_func);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">ifclassq_detach</span>(<span class="enscript-type">struct</span> ifclassq *);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">ifclassq_getqstats</span>(<span class="enscript-type">struct</span> ifclassq *, u_int32_t,
    <span class="enscript-type">void</span> *, u_int32_t *);
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> *<span class="enscript-function-name">ifclassq_ev2str</span>(cqev_t);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">ifclassq_tbr_set</span>(<span class="enscript-type">struct</span> ifclassq *, <span class="enscript-type">struct</span> tb_profile *, boolean_t);
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> mbuf *<span class="enscript-function-name">ifclassq_tbr_dequeue</span>(<span class="enscript-type">struct</span> ifclassq *, <span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> mbuf *<span class="enscript-function-name">ifclassq_tbr_dequeue_sc</span>(<span class="enscript-type">struct</span> ifclassq *, <span class="enscript-type">int</span>,
    mbuf_svc_class_t);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* BSD_KERNEL_PRIVATE */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* PRIVATE */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* _NET_CLASSQ_IF_CLASSQ_H_ */</span>
</pre>
<hr />
</body></html>