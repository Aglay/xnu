<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>devfsdefs.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">devfsdefs.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000-2002 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*
 * Copyright 1997,1998 Julian Elischer.  All rights reserved.
 * <a href="mailto:julian@freebsd.org">julian@freebsd.org</a>
 * 
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *  1. Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 *  2. Redistributions in binary form must reproduce the above copyright notice,
 *     this list of conditions and the following disclaimer in the documentation
 *     and/or other materials provided with the distribution.
 * 
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDER ``AS IS'' AND ANY EXPRESS
 * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED.  IN NO EVENT SHALL THE HOLDER OR CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
 * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 * 
 * devfsdefs.h
 */</span>
<span class="enscript-comment">/*
 * NOTICE: This file was modified by McAfee Research in 2004 to introduce
 * support for mandatory and extensible security protections.  This notice
 * is included in support of clause 2.2 (b) of the Apple Public License,
 * Version 2.0.
 */</span>

<span class="enscript-comment">/*
 * HISTORY
 *  8-April-1999 Dieter Siegmund (<a href="mailto:dieter@apple.com">dieter@apple.com</a>)
 *	Ported to from FreeBSD 3.1
 *	Removed unnecessary/unused defines
 *	Renamed structures/elements to clarify usage in code.
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">__DEVFS_DEVFSDEFS_H__</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">__DEVFS_DEVFSDEFS_H__</span>

#<span class="enscript-reference">include</span>  <span class="enscript-string">&lt;sys/appleapiopts.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;security/mac.h&gt;</span>

__BEGIN_DECLS
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">__APPLE_API_PRIVATE</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DEVMAXNAMESIZE</span> 	32 		<span class="enscript-comment">/* XXX */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DEVMAXPATHSIZE</span> 	128		<span class="enscript-comment">/* XXX */</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> {
    DEV_DIR,
    DEV_BDEV,
    DEV_CDEV,
    DEV_SLNK,
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">FDESC</span>
    DEV_DEVFD
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* FDESC */</span>
} devfstype_t;

<span class="enscript-type">extern</span> <span class="enscript-function-name">int</span> (**devfs_vnodeop_p)(<span class="enscript-type">void</span> *);	<span class="enscript-comment">/* our own vector array for dirs */</span>
<span class="enscript-type">extern</span> <span class="enscript-function-name">int</span> (**devfs_spec_vnodeop_p)(<span class="enscript-type">void</span> *); <span class="enscript-comment">/* our own vector array for devs */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> vfsops devfs_vfsops;

<span class="enscript-type">typedef</span>	<span class="enscript-type">struct</span> devnode		devnode_t;
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> devdirent 	devdirent_t;
<span class="enscript-type">typedef</span> <span class="enscript-type">union</span> devnode_type 	devnode_type_t;

<span class="enscript-type">struct</span> devfs_stats {
    <span class="enscript-type">int</span>			nodes;
    <span class="enscript-type">int</span>			entries;
    <span class="enscript-type">int</span>			mounts;
    <span class="enscript-type">int</span>			stringspace;
};

<span class="enscript-type">union</span> devnode_type {
    dev_t		dev;
    <span class="enscript-type">struct</span> {
	devdirent_t *	dirlist;
	devdirent_t * *	dirlast;
	devnode_t *	parent;
	devdirent_t *	myname;		<span class="enscript-comment">/* my entry in .. */</span>
	<span class="enscript-type">int</span>		entrycount;
    }Dir;
    <span class="enscript-type">struct</span> {
	<span class="enscript-type">char</span> *		name;	<span class="enscript-comment">/* must be allocated separately */</span>
	<span class="enscript-type">int</span>		namelen;
    }Slnk;
};

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DEV_MAX_VNODE_RETRY</span>  8          <span class="enscript-comment">/* Max number of retries when we try to
                                           get a vnode for the devnode */</span>
<span class="enscript-type">struct</span> devnode
{
    devfstype_t		dn_type;
    <span class="enscript-comment">/* 
     * Number of vnodes that point to this devnode.  Note, we do not
     * add another reference for a lookup which finds an existing
     * vnode; a reference is added when a vnode is created and removed
     * when a vnode is reclaimed.  A devnode will not be freed while
     * there are outstanding references.  A refcount can be added to
     * prevent the free of a devnode in situations where there is not
     * guaranteed to be a vnode holding a ref, but it is important to
	 * make sure that a deferred delete eventually happens if it is
 	 * blocked behind that reference.
     */</span>
    <span class="enscript-type">int</span>			dn_refcount;
    u_short		dn_mode;
    uid_t		dn_uid; 
    gid_t		dn_gid;
    <span class="enscript-type">struct</span> timespec	dn_atime;<span class="enscript-comment">/* time of last access */</span>
    <span class="enscript-type">struct</span> timespec	dn_mtime;<span class="enscript-comment">/* time of last modification */</span>
    <span class="enscript-type">struct</span> timespec	dn_ctime;<span class="enscript-comment">/* time file changed */</span>
    <span class="enscript-type">int</span>	(***dn_ops)(<span class="enscript-type">void</span> *);<span class="enscript-comment">/* yuk... pointer to pointer(s) to funcs */</span>
    <span class="enscript-type">int</span>			dn_links;<span class="enscript-comment">/* how many file links does this node have? */</span>
    <span class="enscript-type">struct</span> devfsmount *	dn_dvm; <span class="enscript-comment">/* the mount structure for this 'plane' */</span>
    <span class="enscript-type">struct</span> vnode *	dn_vn;	<span class="enscript-comment">/* address of last vnode that represented us */</span>
    <span class="enscript-type">int</span>			dn_len;   <span class="enscript-comment">/* of any associated info (e.g. dir data) */</span>
    devdirent_t *	dn_linklist;<span class="enscript-comment">/* circular list of hardlinks to this node */</span>
    devnode_t *		dn_nextsibling;	<span class="enscript-comment">/* the list of equivalent nodes */</span>
    devnode_t * *	dn_prevsiblingp;<span class="enscript-comment">/* backpointer for the above */</span>
    devnode_type_t	dn_typeinfo;
    <span class="enscript-type">int</span>			dn_change;
    <span class="enscript-type">int</span>			dn_update;
    <span class="enscript-type">int</span>			dn_access;
    <span class="enscript-type">int</span>			dn_lflags;
    ino_t		dn_ino;
    <span class="enscript-type">int</span>			(*dn_clone)(dev_t dev, <span class="enscript-type">int</span> action); <span class="enscript-comment">/* get minor # */</span>
    <span class="enscript-type">struct</span> label *	dn_label;	<span class="enscript-comment">/* security label */</span>
};

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DN_DELETE</span>		0x02
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DN_CREATE</span>		0x04
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DN_CREATEWAIT</span>		0x08


<span class="enscript-type">struct</span> devdirent
{
    <span class="enscript-comment">/*-----------------------directory entry fields-------------*/</span>
    <span class="enscript-type">char</span>		de_name[DEVMAXNAMESIZE];
    devnode_t *		de_dnp;		<span class="enscript-comment">/* the &quot;inode&quot; (devnode) pointer */</span>
    devnode_t *		de_parent;	<span class="enscript-comment">/* backpointer to the directory itself */</span>
    devdirent_t *	de_next;	<span class="enscript-comment">/* next object in this directory */</span>
    devdirent_t *	*de_prevp;	<span class="enscript-comment">/* previous pointer in directory linked list */</span>
    devdirent_t *	de_nextlink;	<span class="enscript-comment">/* next hardlink to this node */</span>
    devdirent_t *	*de_prevlinkp;	<span class="enscript-comment">/* previous hardlink pointer for this node */</span>
};

<span class="enscript-type">extern</span> devdirent_t * 		dev_root;
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> devfs_stats	devfs_stats;
<span class="enscript-type">extern</span> lck_mtx_t	  	devfs_mutex;
<span class="enscript-type">extern</span> lck_mtx_t	  	devfs_attr_mutex;

<span class="enscript-comment">/*
 * Rules for front nodes:
 * Dirs hava a strict 1:1 relationship with their OWN devnode
 * Symlinks similarly
 * Device Nodes ALWAYS point to the devnode that is linked
 * to the Backing node. (with a ref count)
 */</span>

<span class="enscript-comment">/*
 * DEVFS specific per/mount information, used to link a monted fs to a
 * particular 'plane' of front nodes.
 */</span>
<span class="enscript-type">struct</span> devfsmount
{
    <span class="enscript-type">struct</span> mount *	mount;	<span class="enscript-comment">/* vfs mount struct for this fs	*/</span>
    devdirent_t *	plane_root;<span class="enscript-comment">/* the root of this 'plane'	*/</span>
};

<span class="enscript-comment">/*
 * Prototypes for DEVFS virtual filesystem operations
 */</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/lock.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;miscfs/devfs/devfs_proto.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/OSAtomic.h&gt;</span>		<span class="enscript-comment">/* required for OSAddAtomic() */</span>

<span class="enscript-comment">//#define HIDDEN_MOUNTPOINT	1
</span>
<span class="enscript-comment">/* misc */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">M_DEVFSNAME</span>	M_DEVFS
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">M_DEVFSNODE</span>	M_DEVFS
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">M_DEVFSMNT</span>	M_DEVFS

#<span class="enscript-reference">define</span> <span class="enscript-function-name">VTODN</span>(vp)	((devnode_t *)(vp)-&gt;v_data)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">DEVFS_LOCK</span>()	lck_mtx_lock(&amp;devfs_mutex)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">DEVFS_UNLOCK</span>()	lck_mtx_unlock(&amp;devfs_mutex)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">DEVFS_ATTR_LOCK_SPIN</span>()	lck_mtx_lock_spin(&amp;devfs_attr_mutex);
#<span class="enscript-reference">define</span> <span class="enscript-function-name">DEVFS_ATTR_UNLOCK</span>()	lck_mtx_unlock(&amp;devfs_attr_mutex);

<span class="enscript-comment">/*
 * XXX all the (SInt32 *) casts below assume sizeof(int) == sizeof(long)
 */</span>
<span class="enscript-type">static</span> __inline__ <span class="enscript-type">void</span>
<span class="enscript-function-name">DEVFS_INCR_ENTRIES</span>(<span class="enscript-type">void</span>)
{
    OSAddAtomic(1, &amp;devfs_stats.entries);
}

<span class="enscript-type">static</span> __inline__ <span class="enscript-type">void</span>
<span class="enscript-function-name">DEVFS_DECR_ENTRIES</span>(<span class="enscript-type">void</span>)
{
    OSAddAtomic(-1, &amp;devfs_stats.entries);
}

<span class="enscript-type">static</span> __inline__ <span class="enscript-type">void</span>
<span class="enscript-function-name">DEVFS_INCR_NODES</span>(<span class="enscript-type">void</span>)
{
    OSAddAtomic(1, &amp;devfs_stats.nodes);
}

<span class="enscript-type">static</span> __inline__ <span class="enscript-type">void</span>
<span class="enscript-function-name">DEVFS_DECR_NODES</span>(<span class="enscript-type">void</span>)
{
    OSAddAtomic(-1, &amp;devfs_stats.nodes);
}

<span class="enscript-type">static</span> __inline__ <span class="enscript-type">void</span>
<span class="enscript-function-name">DEVFS_INCR_MOUNTS</span>(<span class="enscript-type">void</span>)
{
    OSAddAtomic(1, &amp;devfs_stats.mounts);
}

<span class="enscript-type">static</span> __inline__ <span class="enscript-type">void</span>
<span class="enscript-function-name">DEVFS_DECR_MOUNTS</span>(<span class="enscript-type">void</span>)
{
    OSAddAtomic(-1, &amp;devfs_stats.mounts);
}

<span class="enscript-type">static</span> __inline__ <span class="enscript-type">void</span>
<span class="enscript-function-name">DEVFS_INCR_STRINGSPACE</span>(<span class="enscript-type">int</span> space)
{
    OSAddAtomic(space, &amp;devfs_stats.stringspace);
}

<span class="enscript-type">static</span> __inline__ <span class="enscript-type">void</span>
<span class="enscript-function-name">DEVFS_DECR_STRINGSPACE</span>(<span class="enscript-type">int</span> space)
{
    OSAddAtomic(-space, &amp;devfs_stats.stringspace);
}

<span class="enscript-comment">/* 
 * Access, change, and modify times are protected by a separate lock,
 * which allows tty times to be updated (no more than once per second)
 * in the I/O path without too much fear of contention.
 *
 * For getattr, update times to current time if the last update was recent; 
 * preserve  legacy behavior that frequent stats can yield sub-second resolutions.  
 * If the last time is old, however, we know that the event that triggered
 * the need for an update was no more than 1s after the last update.  In that case,
 * use (last update + 1s) as the time, avoiding the illusion that last update happened
 * much later than it really did.
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DEVFS_LAZY_UPDATE_SECONDS</span>	1

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DEVFS_UPDATE_CHANGE</span>		0x1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DEVFS_UPDATE_MOD</span>		0x2
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DEVFS_UPDATE_ACCESS</span>		0x4

<span class="enscript-type">static</span> __inline__ <span class="enscript-type">void</span>
<span class="enscript-function-name">dn_copy_times</span>(devnode_t * target, devnode_t * source)
{
    DEVFS_ATTR_LOCK_SPIN();
    target-&gt;dn_atime = source-&gt;dn_atime;
    target-&gt;dn_mtime = source-&gt;dn_mtime;
    target-&gt;dn_ctime = source-&gt;dn_ctime;
    DEVFS_ATTR_UNLOCK();
    <span class="enscript-keyword">return</span>;
}

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">BSD_KERNEL_PRIVATE</span>
<span class="enscript-type">int</span> 	devfs_make_symlink(devnode_t *dir_p, <span class="enscript-type">char</span> *name, <span class="enscript-type">int</span> mode, <span class="enscript-type">char</span> *target, devdirent_t **newent);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* BSD_KERNEL_PRIVATE */</span>

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* __APPLE_API_PRIVATE */</span>

__END_DECLS

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* __DEVFS_DEVFSDEFS_H__ */</span>
</pre>
<hr />
</body></html>