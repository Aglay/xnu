<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>stackshot.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">stackshot.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2014 Apple Inc. All rights reserved.
 *
 * @APPLE_LICENSE_HEADER_START@
 *
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this
 * file.
 *
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 *
 * @APPLE_LICENSE_HEADER_END@
 */</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/stackshot.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/mach.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/mach_vm.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdint.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdlib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;errno.h&gt;</span>

<span class="enscript-comment">/*
 * System call entry point
 */</span>
<span class="enscript-type">int</span> <span class="enscript-function-name">__stack_snapshot_with_config</span>(<span class="enscript-type">int</span> stackshot_config_version, user_addr_t stackshot_config, size_t stackshot_config_size);

<span class="enscript-comment">/*
 * stackshot_config_create:	create and initialize the arguments for a stackshot
 *
 * Outputs:			NULL if malloc fails
 *				a pointer to a new stackshot_config_t on success
 */</span>
stackshot_config_t *
<span class="enscript-function-name">stackshot_config_create</span>(<span class="enscript-type">void</span>)
{
	stackshot_config_t *s_config;

	s_config = malloc(<span class="enscript-keyword">sizeof</span>(stackshot_config_t));
	<span class="enscript-keyword">if</span> (s_config == NULL) {
		<span class="enscript-keyword">return</span> NULL;
	}

	s_config-&gt;sc_pid = -1;
	s_config-&gt;sc_flags = 0;
	s_config-&gt;sc_since_timestamp = 0;
	s_config-&gt;sc_buffer = 0;
	s_config-&gt;sc_size = 0;

	<span class="enscript-keyword">return</span> s_config;
}

<span class="enscript-comment">/*
 * stackshot_config_set_pid:	set the PID to be traced
 *
 * Inputs:			stackshot_config - a pointer to the stackshot_config_t we want to update
 *				pid - process id of process to be traced, or -1 for the entire system
 *
 * Outputs:			EINVAL if the passed stackshot_config pointer is NULL
 *				0 on success
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">stackshot_config_set_pid</span>(stackshot_config_t *stackshot_config, <span class="enscript-type">int</span> pid)
{
	stackshot_config_t *s_config;

	<span class="enscript-keyword">if</span> (stackshot_config == NULL) {
		<span class="enscript-keyword">return</span> EINVAL;
	}

	s_config = (stackshot_config_t *) stackshot_config;
	s_config-&gt;sc_pid = pid;

	<span class="enscript-keyword">return</span> 0;
}

<span class="enscript-comment">/*
 * stackshot_config_set_flags:	set the flags to be passed for the stackshot
 *
 * Inputs:			stackshot_config - a pointer to the stackshot_config_t we want to update
 *				flags - flags to pass to stackshot
 *
 * Outputs:			EINVAL if the passed stackshot_config pointer is NULL
 *				0 on success
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">stackshot_config_set_flags</span>(stackshot_config_t *stackshot_config, uint32_t flags)
{
	stackshot_config_t *s_config;

	<span class="enscript-keyword">if</span> (stackshot_config == NULL) {
		<span class="enscript-keyword">return</span> EINVAL;
	}

	s_config = (stackshot_config_t *) stackshot_config;
	s_config-&gt;sc_flags = flags;

	<span class="enscript-keyword">return</span> 0;
}

<span class="enscript-comment">/*
 * stackshot_capture_with_config:	take a stackshot with the provided config
 *
 * Inputs:				stackshot_config - a pointer to the stackshot_config_t we want to use
 *
 * Outputs:				EINVAL if the passed stackshot_config pointer is NULL, a caller is trying
 *						to reuse a config without deallocating its buffer or if there is a
 *						problem with the arguments
 *					EFAULT if there was a problem with accessing the arguments from the kernel
 *					EPERM if the caller is not privileged
 *					ENOTSUP if the caller is passing a stackshot config version that is not
 *						supported by the kernel (indicates libsyscall:kernel mismatch),
 *						or if the caller is requesting unsupported flags
 *					ENOMEM if the kernel is unable to allocate memory
 *					ENOSPC if the caller doesn't have enough space in their address space for
 *						the kernel to remap the buffer
 *					ENOENT if the caller is requesting an existing buffer that doesn't exist
 *						or the target PID isn't found
 *					0 on success
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">stackshot_capture_with_config</span>(stackshot_config_t *stackshot_config)
{
	<span class="enscript-type">int</span> ret;
	stackshot_config_t *s_config;

	<span class="enscript-keyword">if</span> (stackshot_config == NULL) {
		<span class="enscript-keyword">return</span> EINVAL;
	}

	s_config = (stackshot_config_t *) stackshot_config;
	<span class="enscript-keyword">if</span> (s_config-&gt;sc_buffer != 0)  {
		<span class="enscript-keyword">return</span> EINVAL;
	}

	s_config-&gt;sc_out_buffer_addr = &amp;s_config-&gt;sc_buffer;
	s_config-&gt;sc_out_size_addr = &amp;s_config-&gt;sc_size;
	ret = __stack_snapshot_with_config(STACKSHOT_CONFIG_TYPE, s_config, <span class="enscript-keyword">sizeof</span>(stackshot_config_t));
	
	<span class="enscript-keyword">if</span> (ret != 0) {
		ret = errno;
		s_config-&gt;sc_buffer = 0;
		s_config-&gt;sc_size = 0;
	}

	<span class="enscript-keyword">return</span> ret;
}

<span class="enscript-comment">/*
 * stackshot_config_get_stackshot_buffer:	get a pointer to the buffer containing the stackshot
 *
 * Inputs:					stackshot_config - a pointer to a stackshot_config_t
 *
 * Outputs:					NULL if the passed stackshot_config is NULL or if its buffer is NULL
 *						a pointer to the buffer containing the stackshot on success
 */</span>
<span class="enscript-type">void</span> *
<span class="enscript-function-name">stackshot_config_get_stackshot_buffer</span>(stackshot_config_t *stackshot_config)
{
	stackshot_config_t *s_config;

	<span class="enscript-keyword">if</span> (stackshot_config == NULL) {
		<span class="enscript-keyword">return</span> NULL;
	}
	s_config = (stackshot_config_t *) stackshot_config;

	<span class="enscript-keyword">return</span> ((<span class="enscript-type">void</span> *)s_config-&gt;sc_buffer);
}

<span class="enscript-comment">/*
 * stackshot_config_get_stackshot_size:	get the size of the stackshot buffer
 *
 * Inputs:  stackshot_config - a pointer to a stackshot_config_t
 *
 * Outputs: -1 if the passed stackshot config is NULL or there is no buffer
 *             the length of the stackshot buffer on success
 */</span>
uint32_t
<span class="enscript-function-name">stackshot_config_get_stackshot_size</span>(stackshot_config_t * stackshot_config)
{
	<span class="enscript-keyword">if</span> (stackshot_config == NULL || (<span class="enscript-type">void</span> *)stackshot_config-&gt;sc_buffer == NULL) {
		<span class="enscript-keyword">return</span> -1;
	}

	<span class="enscript-keyword">return</span> stackshot_config-&gt;sc_size;
}

<span class="enscript-comment">/*
 * stackshot_config_set_size_hint: set the size of the stackshot buffer
 *
 * Inputs:  stackshot_config - a pointer to a stackshot_config_t
 *          suggested_size - hint for size allocation of stackshot
 *
 * Outputs:  -1  if the passed stackshot config is NULL or there is existing stackshot buffer set.
 *              the length of the stackshot buffer on success.
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">stackshot_config_set_size_hint</span>(stackshot_config_t *stackshot_config, uint32_t suggested_size)
{
	<span class="enscript-keyword">if</span> (stackshot_config == NULL || (<span class="enscript-type">void</span> *)stackshot_config-&gt;sc_buffer != NULL) {
		<span class="enscript-keyword">return</span> -1;
	}

	stackshot_config-&gt;sc_size = suggested_size;

	<span class="enscript-keyword">return</span> 0;
}

<span class="enscript-comment">/*
 * stackshot_config_dealloc_buffer:  dealloc the stackshot buffer and reset the size so that a
 *   stackshot_config_t can be used again
 *
 * Inputs:   stackshot_config - a pointer to a stackshot_config_t
 *
 * Outputs:  EINVAL if the passed stackshot_config is NULL or if its buffer is NULL
 *           0 otherwise
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">stackshot_config_dealloc_buffer</span>(stackshot_config_t *stackshot_config)
{
	stackshot_config_t *s_config;

	<span class="enscript-keyword">if</span> (stackshot_config == NULL) {
		<span class="enscript-keyword">return</span> EINVAL;
	}
	s_config = (stackshot_config_t *) stackshot_config;

	<span class="enscript-keyword">if</span> (s_config-&gt;sc_size &amp;&amp; s_config-&gt;sc_buffer) {
		mach_vm_deallocate(mach_task_self(), (mach_vm_offset_t)s_config-&gt;sc_buffer, (mach_vm_size_t)s_config-&gt;sc_size);
	}

	s_config-&gt;sc_buffer = 0;
	s_config-&gt;sc_size = 0;

	<span class="enscript-keyword">return</span> 0;
}

<span class="enscript-comment">/*
 * stackshot_config_dealloc:	dealloc the stackshot buffer and the stackshot config
 *
 * Inputs:			stackshot_config - a pointer to a stackshot_config_t
 *
 * Outputs:			EINVAL if the passed stackshot_cofnig is NULL
 *				0 otherwise
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">stackshot_config_dealloc</span>(stackshot_config_t *stackshot_config)
{
	stackshot_config_t *s_config;

	<span class="enscript-keyword">if</span> (stackshot_config == NULL) {
		<span class="enscript-keyword">return</span> EINVAL;
	}
	s_config = (stackshot_config_t *) stackshot_config;

	<span class="enscript-keyword">if</span> (s_config-&gt;sc_size &amp;&amp; s_config-&gt;sc_buffer) {
		mach_vm_deallocate(mach_task_self(), (mach_vm_offset_t)s_config-&gt;sc_buffer, (mach_vm_size_t)s_config-&gt;sc_size);
	}

	s_config-&gt;sc_buffer = 0;
	s_config-&gt;sc_size = 0;

	free(s_config);
	<span class="enscript-keyword">return</span> 0;
}
</pre>
<hr />
</body></html>