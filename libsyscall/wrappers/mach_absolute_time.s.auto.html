<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>mach_absolute_time.s</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">mach_absolute_time.s&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
/*
 <span class="enscript-keyword">*</span> Copyright (c) 2003-2007 Apple Inc. All rights reserved.
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> This file contains Original Code and/or Modifications of Original Code
 <span class="enscript-keyword">*</span> as defined in and that are subject to the Apple Public Source License
 <span class="enscript-keyword">*</span> Version 2.0 (the 'License'). You may not use this file except in
 <span class="enscript-keyword">*</span> compliance with the License. The rights granted to you under the License
 <span class="enscript-keyword">*</span> may not be used to create, or enable the creation or redistribution of,
 <span class="enscript-keyword">*</span> unlawful or unlicensed copies of an Apple operating system, or to
 <span class="enscript-keyword">*</span> circumvent, violate, or enable the circumvention or violation of, any
 <span class="enscript-keyword">*</span> terms of an Apple operating system software license agreement.
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> Please obtain a copy of the License at
 <span class="enscript-keyword">*</span> <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> The Original Code and all software distributed under the License are
 <span class="enscript-keyword">*</span> distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 <span class="enscript-keyword">*</span> EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 <span class="enscript-keyword">*</span> INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 <span class="enscript-keyword">*</span> FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 <span class="enscript-keyword">*</span> Please see the License for the specific language governing rights and
 <span class="enscript-keyword">*</span> limitations under the License.
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 <span class="enscript-keyword">*/
</span>
#include &lt;sys/appleapiopts.h&gt;
#include &lt;machine/cpu_capabilities.h&gt;

#if defined(__i386__)

/* return mach_absolute_time in %edx:%eax
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> The algorithm we use is:
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span>	ns = ((((rdtsc - rnt_tsc_base)&lt;&lt;rnt_shift)*rnt_tsc_scale) / 2**32) + rnt_ns_base<span class="enscript-comment">;
 *
</span> <span class="enscript-keyword">*</span> rnt_shift, a constant computed during initialization, is the smallest value for which:
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span>  (tscFreq &lt;&lt; rnt_shift) &gt; SLOW_TSC_THRESHOLD
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> Where SLOW_TSC_THRESHOLD is about 10e9.  Since most processor's tscFreq is greater
 <span class="enscript-keyword">*</span> than 1GHz, rnt_shift is usually 0.  rnt_tsc_scale is also a 32-bit constant:
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span>	rnt_tsc_scale = (10e9 * 2**32) / (tscFreq &lt;&lt; rnt_shift)<span class="enscript-comment">;
 */
</span>
	<span class="enscript-keyword">.globl</span> _mach_absolute_time
<span class="enscript-function-name">_mach_absolute_time:</span>
	<span class="enscript-keyword">pushl</span>	%ebp
	<span class="enscript-keyword">movl</span>	%esp,%ebp
	<span class="enscript-keyword">pushl</span>	%esi
	<span class="enscript-keyword">pushl</span>	%ebx

<span class="enscript-function-name">0:</span>
	<span class="enscript-keyword">movl</span>	_COMM_PAGE_NT_GENERATION,%esi	/* get generation (0 if being changed) */
	<span class="enscript-keyword">testl</span>	%esi,%esi			/* if being updated, loop until stable */
	<span class="enscript-keyword">jz</span>	0b

	<span class="enscript-keyword">lfence
</span>	<span class="enscript-keyword">rdtsc</span>					/* get TSC in %edx:%eax */
	<span class="enscript-keyword">lfence
</span>
	<span class="enscript-keyword">subl</span>	_COMM_PAGE_NT_TSC_BASE,%eax
	<span class="enscript-keyword">sbbl</span>	_COMM_PAGE_NT_TSC_BASE+4,%edx
    <span class="enscript-keyword">
</span>    <span class="enscript-keyword">/*
</span>     <span class="enscript-keyword">*</span> Prior to supporting <span class="enscript-string">&quot;slow&quot;</span> processors, xnu always set _NT_SHIFT to 32.
     <span class="enscript-keyword">*</span> Now it defaults to 0, unless the processor is slow.  The shifts
     <span class="enscript-keyword">*</span> below implicitly mask the count down to 5 bits, handling either default.
     <span class="enscript-keyword">*/
</span>	<span class="enscript-keyword">movl</span>    _COMM_PAGE_NT_SHIFT,%ecx
	<span class="enscript-keyword">shldl</span>   %cl,%eax,%edx			/* shift %edx left, filling in from %eax */
	<span class="enscript-keyword">shll</span>    %cl,%eax			/* finish shifting %edx:%eax left by _COMM_PAGE_NT_SHIFT bits */

	<span class="enscript-keyword">movl</span>	_COMM_PAGE_NT_SCALE,%ecx

	<span class="enscript-keyword">movl</span>	%edx,%ebx
	<span class="enscript-keyword">mull</span>	%ecx
	<span class="enscript-keyword">movl</span>	%ebx,%eax
	<span class="enscript-keyword">movl</span>	%edx,%ebx
	<span class="enscript-keyword">mull</span>	%ecx
	<span class="enscript-keyword">addl</span>	%ebx,%eax
	<span class="enscript-keyword">adcl</span>	$0,%edx

	<span class="enscript-keyword">addl</span>	_COMM_PAGE_NT_NS_BASE,%eax
	<span class="enscript-keyword">adcl</span>	_COMM_PAGE_NT_NS_BASE+4,%edx

	<span class="enscript-keyword">cmpl</span>	_COMM_PAGE_NT_GENERATION,%esi	/* have the parameters changed? */
	<span class="enscript-keyword">jne</span>	0b				/* yes, loop until stable */

	<span class="enscript-keyword">popl</span>	%ebx
	<span class="enscript-keyword">popl</span>	%esi
	<span class="enscript-keyword">popl</span>	%ebp
	<span class="enscript-keyword">ret
</span>
#elif defined(__x86_64__)

/*
 <span class="enscript-keyword">*</span> 64-bit version _mach_absolute_time.  We return the 64-bit nanotime in %rax.
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> The algorithm we use is:
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span>	ns = ((((rdtsc - rnt_tsc_base)&lt;&lt;rnt_shift)*rnt_tsc_scale) / 2**32) + rnt_ns_base<span class="enscript-comment">;
 *
</span> <span class="enscript-keyword">*</span> rnt_shift, a constant computed during initialization, is the smallest value for which:
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span>	tscFreq &lt;&lt; rnt_shift) &gt; SLOW_TSC_THRESHOLD
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> Where SLOW_TSC_THRESHOLD is about 10e9.  Since most processor's tscFreqs are greater
 <span class="enscript-keyword">*</span> than 1GHz, rnt_shift is usually 0.  rnt_tsc_scale is also a 32-bit constant:
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span>	rnt_tsc_scale = (10e9 * 2**32) / (tscFreq &lt;&lt; rnt_shift)<span class="enscript-comment">;
 *
</span> <span class="enscript-keyword">*/
</span>	<span class="enscript-keyword">.globl</span>	_mach_absolute_time
<span class="enscript-function-name">_mach_absolute_time:</span>
	<span class="enscript-keyword">pushq</span>	%rbp				// set up a frame for backtraces
	<span class="enscript-keyword">movq</span>	%rsp,%rbp
	<span class="enscript-keyword">movq</span>	$(_COMM_PAGE_TIME_DATA_START),%rsi
<span class="enscript-function-name">1:</span>
	<span class="enscript-keyword">movl</span>	_NT_GENERATION(%rsi),%r8d	// get generation
	<span class="enscript-keyword">testl</span>	%r8d,%r8d			// if 0, data is being changed...
	<span class="enscript-keyword">jz</span>      1b				// ...so loop until stable
	<span class="enscript-keyword">lfence
</span>	<span class="enscript-keyword">rdtsc</span>					// edx:eax := tsc
	<span class="enscript-keyword">lfence
</span>	<span class="enscript-keyword">shlq</span>	$32,%rdx			// rax := ((edx &lt;&lt; 32) | eax), ie 64-bit tsc
	<span class="enscript-keyword">orq</span>     %rdx,%rax

    <span class="enscript-keyword">/*
</span>     <span class="enscript-keyword">*</span> Prior to supporting <span class="enscript-string">&quot;slow&quot;</span> processors, xnu always set _NT_SHIFT to 32.
     <span class="enscript-keyword">*</span> Now it defaults to 0, unless the processor is slow.  In order to maintain
     <span class="enscript-keyword">*</span> compatibility with both old and new versions of xnu, we mask the shift
     <span class="enscript-keyword">*</span> down to 0x1F, which maps the old default (32) into the new default (0).
     <span class="enscript-keyword">*/
</span>	<span class="enscript-keyword">movl</span>    _NT_SHIFT(%rsi),%ecx
	<span class="enscript-keyword">andl</span>    $0x1F,%ecx			// *** remove this line once 10.9 is GM ***
	<span class="enscript-keyword">subq</span>	_NT_TSC_BASE(%rsi), %rax	// rax := (tsc - base_tsc)
	<span class="enscript-keyword">shlq</span>    %cl,%rax			// rax := (tsc - base_tsc) &lt;&lt; NT_SHIFT
	<span class="enscript-keyword">movl</span>	_NT_SCALE(%rsi),%ecx
	<span class="enscript-keyword">mulq</span>	%rcx				// rdx:rax := ((tsc - base_tsc)&lt;&lt;shift) * scale
	<span class="enscript-keyword">shrdq</span>	$32,%rdx,%rax			// divide by 2**32
	<span class="enscript-keyword">addq</span>	_NT_NS_BASE(%rsi),%rax		// (((tsc - base_tsc) * scale) &gt;&gt; 32) + ns_base
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">cmpl</span>	_NT_GENERATION(%rsi),%r8d	// did the data change during computation?
	<span class="enscript-keyword">jne</span>     1b
	<span class="enscript-keyword">popq</span>	%rbp
	<span class="enscript-keyword">ret
</span>
#else
#error Unsupported architecture
#endif
</pre>
<hr />
</body></html>