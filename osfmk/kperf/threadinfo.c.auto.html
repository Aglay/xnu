<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>threadinfo.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">threadinfo.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2011 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>


<span class="enscript-comment">/*  Sample thread data */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/mach_types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/thread.h&gt;</span> <span class="enscript-comment">/* thread_* */</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/debug.h&gt;</span> <span class="enscript-comment">/* panic */</span>
<span class="enscript-comment">// #include &lt;sys/proc.h&gt;
</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;chud/chud_xnu.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kperf/kperf.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kperf/buffer.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kperf/context.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kperf/threadinfo.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kperf/ast.h&gt;</span>

<span class="enscript-comment">// kAppleProfileTriggerClientThreadModeIdle				= 0x40, // TH_IDLE
</span><span class="enscript-comment">// #define TH_IDLE 0x40
</span>
<span class="enscript-comment">//kAppleProfileTriggerClientThreadModeNotIdle				= kAppleProfileTriggerClientThreadModeIdle &lt;&lt; 16, // !TH_IDLE
</span>#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TH_IDLE_N</span> (TH_IDLE &lt;&lt; 16)

<span class="enscript-type">static</span> uint64_t
<span class="enscript-function-name">make_runmode</span>(thread_t thread)
{
	<span class="enscript-comment">/* CEG: This is a translation of
	 * AppleProfileGetRunModeOfThread below... kinda magic :/
	 */</span>
	<span class="enscript-type">const</span> <span class="enscript-type">int</span> mode = chudxnu_thread_get_scheduler_state(thread);
	
	<span class="enscript-keyword">if</span>( 0 == mode)
	{
		<span class="enscript-keyword">return</span> (chudxnu_thread_get_idle(thread) ? TH_IDLE : TH_IDLE_N);
	}
	<span class="enscript-keyword">else</span>
	{
		<span class="enscript-comment">// Today we happen to know there's a one-to-one mapping.
</span>		<span class="enscript-keyword">return</span> ((mode &amp; 0xffff) | ((~mode &amp; 0xffff) &lt;&lt; 16));
	}
}


<span class="enscript-comment">/* code to collect current thread info */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">kperf_threadinfo_sample</span>(<span class="enscript-type">struct</span> threadinfo *ti, <span class="enscript-type">struct</span> kperf_context *context)
{
	thread_t cur_thread = context-&gt;cur_thread;
	BUF_INFO1( PERF_TI_SAMPLE, (uintptr_t)thread_tid(cur_thread) );

	<span class="enscript-comment">// fill out the fields
</span>	ti-&gt;pid = context-&gt;cur_pid;
	ti-&gt;tid = thread_tid(cur_thread);
	ti-&gt;dq_addr = thread_dispatchqaddr(cur_thread);
	ti-&gt;runmode = make_runmode(cur_thread);
}

<span class="enscript-comment">/* log an existing sample into the buffer */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">kperf_threadinfo_log</span>(<span class="enscript-type">struct</span> threadinfo *ti)
{
	<span class="enscript-comment">/* XXX: K64 only? */</span>
	BUF_DATA( PERF_TI_DATA, ti-&gt;pid, ti-&gt;tid, ti-&gt;dq_addr, ti-&gt;runmode );
}

<span class="enscript-comment">/* 'extra' thread-info functions that are deferred 'til thread-context
 * time
 */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">kperf_threadinfo_extra_sample</span>(<span class="enscript-type">struct</span> tinfo_ex *tex, <span class="enscript-type">struct</span> kperf_context *context)
{
	thread_t cur_thread = context-&gt;cur_thread;
	uint32_t t_chud;

	<span class="enscript-comment">/* can only pend on the current thread */</span>
	<span class="enscript-comment">/* this is valid from PET mode... */</span>
	<span class="enscript-comment">/*
	if( cur_thread != chudxnu_current_thread() )
		panic(&quot;pending to non-current thread&quot;);
	*/</span>

	<span class="enscript-comment">/* get our current bits */</span>
	t_chud = kperf_get_thread_bits(cur_thread);

	<span class="enscript-comment">/* check if there's anything for us to do */</span>
	<span class="enscript-keyword">if</span>( t_chud &amp; T_AST_NAME )
	{
		BUF_INFO1( PERF_TI_XSAMPLE, (uintptr_t)thread_tid(cur_thread) );

		<span class="enscript-comment">/* get the name out */</span>
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">FIXME</span>
		<span class="enscript-comment">/* need kperfbsd.c? */</span>
		proc_name( context-&gt;cur_pid, 
		           &amp;tex-&gt;p_comm[0], CHUD_MAXPCOMM );
#<span class="enscript-reference">endif</span>

		<span class="enscript-comment">/* mark that it's done */</span>
		t_chud &amp;= ~T_AST_NAME;
		t_chud |= T_NAME_DONE;

		kperf_set_thread_bits(cur_thread, t_chud);
	}
	<span class="enscript-keyword">else</span>
		<span class="enscript-comment">/* empty string */</span>
		tex-&gt;p_comm[0] = <span class="enscript-string">'\0'</span>;

}

<span class="enscript-comment">/* log it if there's anyting useful there */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">kperf_threadinfo_extra_log</span>(<span class="enscript-type">struct</span> tinfo_ex *tex)
{
	<span class="enscript-comment">/* no data */</span>
	<span class="enscript-keyword">if</span>( tex-&gt;p_comm[0] == <span class="enscript-string">'\0'</span> )
		<span class="enscript-keyword">return</span>;

	<span class="enscript-comment">/* FIXME: log more */</span>
	BUF_DATA1( PERF_TI_XDATA, (uintptr_t)*(uintptr_t*)&amp;tex-&gt;p_comm[0] );
}

<span class="enscript-comment">/* pend a flag on a thread */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">kperf_threadinfo_extra_pend</span>(<span class="enscript-type">struct</span> kperf_context *context)
{
	<span class="enscript-keyword">return</span> kperf_ast_pend( context-&gt;cur_thread, T_NAME_DONE | T_AST_NAME,
	                       T_AST_NAME );
}


#<span class="enscript-reference">if</span> 0

<span class="enscript-comment">/* transalted from the APF */</span>

APTIAKernelEntry_t *threadInfo = (APTIAKernelEntry_t*)(threadInfos + account-&gt;offset);

context-&gt;timeStamp = mach_absolute_time();
context-&gt;cpuNum = chudxnu_cpu_number();

<span class="enscript-comment">// record the process info from the callback context
</span>context-&gt;pid = chudxnu_current_pid();
threadInfo-&gt;pid = context-&gt;generic-&gt;pid;

<span class="enscript-comment">// thread_tid is a thread_t to ID function in the kernel
</span>context-&gt;threadID = chudxnu_current_thread();
threadInfo-&gt;tid = thread_tid(context-&gt;generic-&gt;threadID);

<span class="enscript-comment">// also a kernel function
</span>threadInfo-&gt;dispatch_queue_addr = thread_dispatchqaddr(context-&gt;generic-&gt;threadID);

<span class="enscript-comment">// see below
</span>threadInfo-&gt;runMode = AppleProfileGetRunModeOfThread(context-&gt;generic-&gt;threadID);


<span class="enscript-comment">/****** WTF is this?! *******/</span>

<span class="enscript-comment">/*!enum AppleProfileTriggerClientThreadRunMode
 *
 * Specifies the thread mode in which to record samples.
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> { <span class="enscript-comment">// Target Thread State - can be OR'd
</span>	<span class="enscript-comment">// Basic Building Blocks:
</span>	<span class="enscript-comment">// for Time Profile, use kAppleProfileTriggerClientThreadModeRunning (optionally with kAppleProfileTriggerClientThreadModeNotIdle).
</span>	<span class="enscript-comment">// for Time Profile (All Thread States), use kAppleProfileTriggerClientThreadModeAny (or just don't specify any thread mode filters).
</span>	<span class="enscript-comment">// for Time Profile (Blocked Threads), use kIOProfileTriggerClientThreadModeBlocked.
</span>	<span class="enscript-comment">// etc...
</span>	
	kAppleProfileTriggerClientThreadModeNone				= 0x0,
	
	kAppleProfileTriggerClientThreadModeRunning				= 0x1, <span class="enscript-comment">// On a core
</span>	kAppleProfileTriggerClientThreadModeRunnable			= 0x2, <span class="enscript-comment">// TH_RUN
</span>	kAppleProfileTriggerClientThreadModeBlocked				= 0x4, <span class="enscript-comment">// TH_WAIT
</span>	kAppleProfileTriggerClientThreadModeUninterruptible		= 0x8, <span class="enscript-comment">// TH_UNINT
</span>	kAppleProfileTriggerClientThreadModeSuspended			= 0x10, <span class="enscript-comment">// TH_SUSP
</span>	kAppleProfileTriggerClientThreadModeTerminating			= 0x20, <span class="enscript-comment">// TH_TERMINATE
</span>	kAppleProfileTriggerClientThreadModeIdle				= 0x40, <span class="enscript-comment">// TH_IDLE
</span>	
	kAppleProfileTriggerClientThreadModeNotRunning			= kAppleProfileTriggerClientThreadModeRunning &lt;&lt; 16, <span class="enscript-comment">// Not on a core
</span>	kAppleProfileTriggerClientThreadModeNotRunnable			= kAppleProfileTriggerClientThreadModeRunnable &lt;&lt; 16, <span class="enscript-comment">// !TH_RUN
</span>	kAppleProfileTriggerClientThreadModeNotBlocked			= kAppleProfileTriggerClientThreadModeBlocked &lt;&lt; 16, <span class="enscript-comment">// !TH_WAIT
</span>	kAppleProfileTriggerClientThreadModeNotUninterruptible	= kAppleProfileTriggerClientThreadModeUninterruptible &lt;&lt; 16, <span class="enscript-comment">// !TH_UNINT
</span>	kAppleProfileTriggerClientThreadModeNotSuspended		= kAppleProfileTriggerClientThreadModeSuspended &lt;&lt; 16, <span class="enscript-comment">// !TH_SUSP
</span>	kAppleProfileTriggerClientThreadModeNotTerminating		= kAppleProfileTriggerClientThreadModeTerminating &lt;&lt; 16, <span class="enscript-comment">// !TH_TERMINATE
</span>	kAppleProfileTriggerClientThreadModeNotIdle				= kAppleProfileTriggerClientThreadModeIdle &lt;&lt; 16, <span class="enscript-comment">// !TH_IDLE
</span>	
	kAppleProfileTriggerClientThreadModeAny					= (   kAppleProfileTriggerClientThreadModeRunning
																| kAppleProfileTriggerClientThreadModeNotRunning),
} AppleProfileTriggerClientThreadRunMode;

<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> AppleProfileTriggerClientThreadRunMode AppleProfileGetRunModeOfThread(thread_t thread) {	
	<span class="enscript-type">const</span> <span class="enscript-type">int</span> mode = chudxnu_thread_get_scheduler_state(thread);
	
	<span class="enscript-keyword">if</span> (0 == mode) {
		<span class="enscript-keyword">return</span> (chudxnu_thread_get_idle(thread) ? kAppleProfileTriggerClientThreadModeIdle : kAppleProfileTriggerClientThreadModeNotIdle);
	} <span class="enscript-keyword">else</span>
	<span class="enscript-keyword">return</span> (AppleProfileTriggerClientThreadRunMode)((mode &amp; 0xffff) | ((~mode &amp; 0xffff) &lt;&lt; 16)); <span class="enscript-comment">// Today we happen to know there's a one-to-one mapping.
</span>}

#<span class="enscript-reference">endif</span>
</pre>
<hr />
</body></html>