<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>ipc_port.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">ipc_port.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000-2008 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*
 * @OSF_COPYRIGHT@
 */</span>
<span class="enscript-comment">/* 
 * Mach Operating System
 * Copyright (c) 1991,1990,1989 Carnegie Mellon University
 * All Rights Reserved.
 * 
 * Permission to use, copy, modify and distribute this software and its
 * documentation is hereby granted, provided that both the copyright
 * notice and this permission notice appear in all copies of the
 * software, derivative works or modified versions, and any portions
 * thereof, and that both notices appear in supporting documentation.
 * 
 * CARNEGIE MELLON ALLOWS FREE USE OF THIS SOFTWARE IN ITS &quot;AS IS&quot;
 * CONDITION.  CARNEGIE MELLON DISCLAIMS ANY LIABILITY OF ANY KIND FOR
 * ANY DAMAGES WHATSOEVER RESULTING FROM THE USE OF THIS SOFTWARE.
 * 
 * Carnegie Mellon requests users of this software to return to
 * 
 *  Software Distribution Coordinator  or  <a href="mailto:Software.Distribution@CS.CMU.EDU">Software.Distribution@CS.CMU.EDU</a>
 *  School of Computer Science
 *  Carnegie Mellon University
 *  Pittsburgh PA 15213-3890
 * 
 * any improvements or extensions that they make and grant Carnegie Mellon
 * the rights to redistribute these changes.
 */</span>
<span class="enscript-comment">/*
 * NOTICE: This file was modified by McAfee Research in 2004 to introduce
 * support for mandatory and extensible security protections.  This notice
 * is included in support of clause 2.2 (b) of the Apple Public License,
 * Version 2.0.
 */</span>
<span class="enscript-comment">/*
 */</span>
<span class="enscript-comment">/*
 *	File:	ipc/ipc_port.h
 *	Author:	Rich Draves
 *	Date:	1989
 *
 *	Definitions for ports.
 */</span>

#<span class="enscript-reference">ifndef</span>	<span class="enscript-variable-name">_IPC_IPC_PORT_H_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_IPC_IPC_PORT_H_</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">MACH_KERNEL_PRIVATE</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach_rt.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach_assert.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach_debug.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/mach_types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/boolean.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/kern_return.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/port.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/assert.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/kern_types.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;ipc/ipc_types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;ipc/ipc_object.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;ipc/ipc_mqueue.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;ipc/ipc_space.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;security/_label.h&gt;</span>

<span class="enscript-comment">/*
 *  A receive right (port) can be in four states:
 *	1) dead (not active, ip_timestamp has death time)
 *	2) in a space (ip_receiver_name != 0, ip_receiver points
 *	to the space but doesn't hold a ref for it)
 *	3) in transit (ip_receiver_name == 0, ip_destination points
 *	to the destination port and holds a ref for it)
 *	4) in limbo (ip_receiver_name == 0, ip_destination == IP_NULL)
 *
 *  If the port is active, and ip_receiver points to some space,
 *  then ip_receiver_name != 0, and that space holds receive rights.
 *  If the port is not active, then ip_timestamp contains a timestamp
 *  taken when the port was destroyed.
 */</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> ipc_port_timestamp_t;

<span class="enscript-type">struct</span> ipc_port {

	<span class="enscript-comment">/*
	 * Initial sub-structure in common with ipc_pset
	 * First element is an ipc_object second is a
	 * message queue
	 */</span>
	<span class="enscript-type">struct</span> ipc_object ip_object;
	<span class="enscript-type">struct</span> ipc_mqueue ip_messages;

	natural_t ip_sprequests:1,	<span class="enscript-comment">/* send-possible requests outstanding */</span>
		  <span class="enscript-reference">ip_spimportant</span>:1,	<span class="enscript-comment">/* ... at least one is importance donating */</span>
		  <span class="enscript-reference">ip_impdonation</span>:1,	<span class="enscript-comment">/* port supports importance donation */</span>
		  <span class="enscript-reference">ip_tempowner</span>:1,	<span class="enscript-comment">/* dont give donations to current receiver */</span>
		  <span class="enscript-reference">ip_guarded</span>:1,         <span class="enscript-comment">/* port guarded (use context value as guard) */</span>
		  <span class="enscript-reference">ip_strict_guard</span>:1,	<span class="enscript-comment">/* Strict guarding; Prevents user manipulation of context values directly */</span>
		  <span class="enscript-reference">ip_reserved</span>:2,
		  <span class="enscript-reference">ip_impcount</span>:24;	<span class="enscript-comment">/* number of importance donations in nested queue */</span>

	<span class="enscript-type">union</span> {
		<span class="enscript-type">struct</span> ipc_space *receiver;
		<span class="enscript-type">struct</span> ipc_port *destination;
		ipc_port_timestamp_t timestamp;
	} data;

	<span class="enscript-type">union</span> {
		ipc_kobject_t kobject;
		ipc_importance_task_t imp_task;
		uintptr_t alias;
	} kdata;
		
	<span class="enscript-type">struct</span> ipc_port *ip_nsrequest;
	<span class="enscript-type">struct</span> ipc_port *ip_pdrequest;
	<span class="enscript-type">struct</span> ipc_port_request *ip_requests;
	<span class="enscript-type">struct</span> ipc_kmsg *ip_premsg;

	mach_vm_address_t ip_context;

	mach_port_mscount_t ip_mscount;
	mach_port_rights_t ip_srights;
	mach_port_rights_t ip_sorights;

#<span class="enscript-reference">if</span>	<span class="enscript-variable-name">MACH_ASSERT</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">IP_NSPARES</span>		4
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">IP_CALLSTACK_MAX</span>	16
<span class="enscript-comment">/*	queue_chain_t	ip_port_links;*/</span><span class="enscript-comment">/* all allocated ports */</span>
	thread_t	ip_thread;	<span class="enscript-comment">/* who made me?  thread context */</span>
	<span class="enscript-type">unsigned</span> <span class="enscript-type">long</span>	ip_timetrack;	<span class="enscript-comment">/* give an idea of &quot;when&quot; created */</span>
	uintptr_t	ip_callstack[IP_CALLSTACK_MAX]; <span class="enscript-comment">/* stack trace */</span>
	<span class="enscript-type">unsigned</span> <span class="enscript-type">long</span>	ip_spares[IP_NSPARES]; <span class="enscript-comment">/* for debugging */</span>
#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* MACH_ASSERT */</span>
} __attribute__((__packed__));


#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ip_references</span>		ip_object.io_references
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ip_bits</span>			ip_object.io_bits

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ip_receiver_name</span>	ip_messages.imq_receiver_name
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ip_in_pset</span>		ip_messages.imq_in_pset

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ip_receiver</span>		data.receiver
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ip_destination</span>		data.destination
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ip_timestamp</span>		data.timestamp

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ip_kobject</span>		kdata.kobject
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ip_imp_task</span>		kdata.imp_task
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ip_alias</span>		kdata.alias

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_NULL</span>			IPC_PORT_NULL
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IP_DEAD</span>			IPC_PORT_DEAD
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IP_VALID</span>(port)		IPC_PORT_VALID(port)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ip_active</span>(port)		io_active(&amp;(port)-&gt;ip_object)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ip_lock_init</span>(port)	io_lock_init(&amp;(port)-&gt;ip_object)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ip_lock</span>(port)		io_lock(&amp;(port)-&gt;ip_object)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ip_lock_try</span>(port)	io_lock_try(&amp;(port)-&gt;ip_object)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ip_unlock</span>(port)		io_unlock(&amp;(port)-&gt;ip_object)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ip_reference</span>(port)	io_reference(&amp;(port)-&gt;ip_object)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ip_release</span>(port)	io_release(&amp;(port)-&gt;ip_object)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ip_kotype</span>(port)		io_kotype(&amp;(port)-&gt;ip_object)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">ip_full_kernel</span>(port)	imq_full_kernel(&amp;(port)-&gt;ip_messages) 
#<span class="enscript-reference">define</span> <span class="enscript-function-name">ip_full</span>(port)		imq_full(&amp;(port)-&gt;ip_messages) 

<span class="enscript-comment">/*
 * JMM - Preallocation flag
 * This flag indicates that there is a message buffer preallocated for this
 * port and we should use that when sending (from the kernel) rather than
 * allocate a new one.  This avoids deadlocks during notification message
 * sends by critical system threads (which may be needed to free memory and
 * therefore cannot be blocked waiting for memory themselves).
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">IP_BIT_PREALLOC</span>		0x00008000	<span class="enscript-comment">/* preallocated mesg */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">IP_PREALLOC</span>(port)	((port)-&gt;ip_bits &amp; IP_BIT_PREALLOC)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">IP_SET_PREALLOC</span>(port, kmsg)				 	\
MACRO_BEGIN								\
	(port)-&gt;ip_bits |= IP_BIT_PREALLOC;				\
	(port)-&gt;ip_premsg = (kmsg);					\
MACRO_END

#<span class="enscript-reference">define</span> <span class="enscript-function-name">IP_CLEAR_PREALLOC</span>(port, kmsg)				 	\
MACRO_BEGIN								\
	assert((port)-&gt;ip_premsg == kmsg);				\
	(port)-&gt;ip_bits &amp;= ~IP_BIT_PREALLOC;				\
	(port)-&gt;ip_premsg = IKM_NULL;					\
MACRO_END

<span class="enscript-comment">/* JMM - address alignment/packing for LP64 */</span>
<span class="enscript-type">struct</span> ipc_port_request {
	<span class="enscript-type">union</span> {
		<span class="enscript-type">struct</span> ipc_port *port;
		ipc_port_request_index_t index;
	} notify;

	<span class="enscript-type">union</span> {
		mach_port_name_t name;
		<span class="enscript-type">struct</span> ipc_table_size *size;
	} name;
};

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ipr_next</span>		notify.index
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ipr_size</span>		name.size

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ipr_soright</span>		notify.port
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">ipr_name</span>		name.name

<span class="enscript-comment">/*
 * Use the low bits in the ipr_soright to specify the request type
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IPR_SOR_SPARM_MASK</span>	1		<span class="enscript-comment">/* send-possible armed */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IPR_SOR_SPREQ_MASK</span>	2		<span class="enscript-comment">/* send-possible requested */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IPR_SOR_SPBIT_MASK</span>	3		<span class="enscript-comment">/* combo */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">IPR_SOR_SPARMED</span>(sor)	(((uintptr_t)(sor) &amp; IPR_SOR_SPARM_MASK) != 0)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">IPR_SOR_SPREQ</span>(sor)	(((uintptr_t)(sor) &amp; IPR_SOR_SPREQ_MASK) != 0)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">IPR_SOR_PORT</span>(sor)	((ipc_port_t)((uintptr_t)(sor) &amp; ~IPR_SOR_SPBIT_MASK))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">IPR_SOR_MAKE</span>(p,m)	((ipc_port_t)((uintptr_t)(p) | (m)))

<span class="enscript-type">extern</span> lck_grp_t 	ipc_lck_grp;
<span class="enscript-type">extern</span> lck_attr_t 	ipc_lck_attr;

<span class="enscript-comment">/*
 *	Taking the ipc_port_multiple lock grants the privilege
 *	to lock multiple ports at once.  No ports must locked
 *	when it is taken.
 */</span>

<span class="enscript-type">extern</span> lck_spin_t ipc_port_multiple_lock_data;

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ipc_port_multiple_lock_init</span>()					\
		lck_spin_init(&amp;ipc_port_multiple_lock_data, &amp;ipc_lck_grp, &amp;ipc_lck_attr)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ipc_port_multiple_lock</span>()					\
		lck_spin_lock(&amp;ipc_port_multiple_lock_data)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ipc_port_multiple_unlock</span>()					\
		lck_spin_unlock(&amp;ipc_port_multiple_lock_data)

<span class="enscript-comment">/*
 *	The port timestamp facility provides timestamps
 *	for port destruction.  It is used to serialize
 *	mach_port_names with port death.
 */</span>

<span class="enscript-type">extern</span> ipc_port_timestamp_t ipc_port_timestamp_data;

<span class="enscript-comment">/* Retrieve a port timestamp value */</span>
<span class="enscript-type">extern</span> ipc_port_timestamp_t <span class="enscript-function-name">ipc_port_timestamp</span>(<span class="enscript-type">void</span>);

<span class="enscript-comment">/*
 *	Compares two timestamps, and returns TRUE if one
 *	happened before two.  Note that this formulation
 *	works when the timestamp wraps around at 2^32,
 *	as long as one and two aren't too far apart.
 */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">IP_TIMESTAMP_ORDER</span>(one, two)	((int) ((one) - (two)) &lt; 0)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ipc_port_translate_receive</span>(space, name, portp)			\
		ipc_object_translate((space), (name),			\
				     MACH_PORT_RIGHT_RECEIVE,		\
				     (ipc_object_t *) (portp))

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ipc_port_translate_send</span>(space, name, portp)			\
		ipc_object_translate((space), (name),			\
				     MACH_PORT_RIGHT_SEND,		\
				     (ipc_object_t *) (portp))

<span class="enscript-comment">/* Allocate a notification request slot */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">IMPORTANCE_INHERITANCE</span>
<span class="enscript-type">extern</span> kern_return_t
<span class="enscript-function-name">ipc_port_request_alloc</span>(
	ipc_port_t			port,
	mach_port_name_t		name,
	ipc_port_t			soright,
	boolean_t			send_possible,
	boolean_t			immediate,
	ipc_port_request_index_t	*indexp,
	boolean_t			*importantp);
#<span class="enscript-reference">else</span>
<span class="enscript-type">extern</span> kern_return_t
<span class="enscript-function-name">ipc_port_request_alloc</span>(
	ipc_port_t			port,
	mach_port_name_t		name,
	ipc_port_t			soright,
	boolean_t			send_possible,
	boolean_t			immediate,
	ipc_port_request_index_t	*indexp);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* IMPORTANCE_INHERITANCE */</span>

<span class="enscript-comment">/* Grow one of a port's tables of notifcation requests */</span>
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ipc_port_request_grow</span>(
	ipc_port_t			port,
	ipc_table_elems_t		target_size);

<span class="enscript-comment">/* Return the type(s) of notification requests outstanding */</span>
<span class="enscript-type">extern</span> mach_port_type_t <span class="enscript-function-name">ipc_port_request_type</span>(
	ipc_port_t			port,
	mach_port_name_t		name,
	ipc_port_request_index_t	index);

<span class="enscript-comment">/* Cancel a notification request and return the send-once right */</span>
<span class="enscript-type">extern</span> ipc_port_t <span class="enscript-function-name">ipc_port_request_cancel</span>(
	ipc_port_t			port,
	mach_port_name_t		name,
	ipc_port_request_index_t	index);

<span class="enscript-comment">/* Arm any delayed send-possible notification */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">IMPORTANCE_INHERITANCE</span>
<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">ipc_port_request_sparm</span>(
	ipc_port_t			port,
	mach_port_name_t		name,
	ipc_port_request_index_t	index,
	mach_msg_option_t		option);
#<span class="enscript-reference">else</span>
<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">ipc_port_request_sparm</span>(
	ipc_port_t			port,
	mach_port_name_t		name,
	ipc_port_request_index_t	index);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* IMPORTANCE_INHERITANCE */</span>

<span class="enscript-comment">/* Macros for manipulating a port's dead name notificaiton requests */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ipc_port_request_rename</span>(port, index, oname, nname)		\
MACRO_BEGIN								\
	ipc_port_request_t ipr, table;					\
									\
	assert(ip_active(port));					\
									\
	table = port-&gt;ip_requests;					\
	assert(table != IPR_NULL);					\
									\
	ipr = &amp;table[index];						\
	assert(ipr-&gt;ipr_name == oname);					\
									\
	ipr-&gt;ipr_name = nname;						\
MACRO_END


<span class="enscript-comment">/* Make a port-deleted request */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_port_pdrequest</span>(
	ipc_port_t	port,
	ipc_port_t	notify,
	ipc_port_t	*previousp);

<span class="enscript-comment">/* Make a no-senders request */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_port_nsrequest</span>(
	ipc_port_t		port,
	mach_port_mscount_t	sync,
	ipc_port_t		notify,
	ipc_port_t		*previousp);

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ipc_port_set_mscount</span>(port, mscount)				\
MACRO_BEGIN								\
	assert(ip_active(port));					\
									\
	(port)-&gt;ip_mscount = (mscount);					\
MACRO_END

<span class="enscript-comment">/* Prepare a receive right for transmission/destruction */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_port_clear_receiver</span>(
	ipc_port_t		port);

<span class="enscript-comment">/* Initialize a newly-allocated port */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_port_init</span>(
	ipc_port_t		port,
	ipc_space_t		space,
	mach_port_name_t	name);

<span class="enscript-comment">/* Allocate a port */</span>
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ipc_port_alloc</span>(
	ipc_space_t		space,
	mach_port_name_t	*namep,
	ipc_port_t		*portp);

<span class="enscript-comment">/* Allocate a port, with a specific name */</span>
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ipc_port_alloc_name</span>(
	ipc_space_t		space,
	mach_port_name_t	name,
	ipc_port_t		*portp);

<span class="enscript-comment">/* Generate dead name notifications */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_port_dnnotify</span>(
	ipc_port_t		port);

<span class="enscript-comment">/* Generate send-possible notifications */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_port_spnotify</span>(
	ipc_port_t		port);

<span class="enscript-comment">/* Destroy a port */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_port_destroy</span>(
	ipc_port_t	port);

<span class="enscript-comment">/* Check if queueing &quot;port&quot; in a message for &quot;dest&quot; would create a circular 
   group of ports and messages */</span>
<span class="enscript-type">extern</span> boolean_t
<span class="enscript-function-name">ipc_port_check_circularity</span>(
	ipc_port_t	port,
	ipc_port_t	dest);

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">IMPORTANCE_INHERITANCE</span>
<span class="enscript-comment">/* apply importance delta to port only */</span>
<span class="enscript-type">extern</span> mach_port_delta_t
<span class="enscript-function-name">ipc_port_impcount_delta</span>(
	ipc_port_t 		port,
	mach_port_delta_t	delta,
	ipc_port_t		base);

<span class="enscript-comment">/* apply importance delta to port, and return task importance for update */</span>
<span class="enscript-type">extern</span> boolean_t
<span class="enscript-function-name">ipc_port_importance_delta_internal</span>(
	ipc_port_t 		port,
	mach_port_delta_t	*delta,
	ipc_importance_task_t	*imp_task);

<span class="enscript-comment">/* Apply an importance delta to a port and reflect change in receiver task */</span>
<span class="enscript-type">extern</span> boolean_t
<span class="enscript-function-name">ipc_port_importance_delta</span>(
	ipc_port_t 		port,
	mach_port_delta_t	delta);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* IMPORTANCE_INHERITANCE */</span>

<span class="enscript-comment">/* Make a send-once notify port from a receive right */</span>
<span class="enscript-type">extern</span> ipc_port_t <span class="enscript-function-name">ipc_port_lookup_notify</span>(
	ipc_space_t		space, 
	mach_port_name_t 	name);

<span class="enscript-comment">/* Make a naked send right from a receive right - port locked and active */</span>
<span class="enscript-type">extern</span> ipc_port_t <span class="enscript-function-name">ipc_port_make_send_locked</span>(
	ipc_port_t	port);

<span class="enscript-comment">/* Make a naked send right from a receive right */</span>
<span class="enscript-type">extern</span> ipc_port_t <span class="enscript-function-name">ipc_port_make_send</span>(
	ipc_port_t	port);

<span class="enscript-comment">/* Make a naked send right from another naked send right */</span>
<span class="enscript-type">extern</span> ipc_port_t <span class="enscript-function-name">ipc_port_copy_send</span>(
	ipc_port_t	port);

<span class="enscript-comment">/* Copyout a naked send right */</span>
<span class="enscript-type">extern</span> mach_port_name_t <span class="enscript-function-name">ipc_port_copyout_send</span>(
	ipc_port_t	sright,
	ipc_space_t	space);

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* MACH_KERNEL_PRIVATE */</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">KERNEL_PRIVATE</span>

<span class="enscript-comment">/* Release a (valid) naked send right */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_port_release_send</span>(
	ipc_port_t	port);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_port_reference</span>(
	ipc_port_t port);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_port_release</span>(
	ipc_port_t port);

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL_PRIVATE */</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">MACH_KERNEL_PRIVATE</span>

<span class="enscript-comment">/* Make a naked send-once right from a locked and active receive right */</span>
<span class="enscript-type">extern</span> ipc_port_t <span class="enscript-function-name">ipc_port_make_sonce_locked</span>(
	ipc_port_t	port);

<span class="enscript-comment">/* Make a naked send-once right from a receive right */</span>
<span class="enscript-type">extern</span> ipc_port_t <span class="enscript-function-name">ipc_port_make_sonce</span>(
	ipc_port_t	port);

<span class="enscript-comment">/* Release a naked send-once right */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_port_release_sonce</span>(
	ipc_port_t	port);

<span class="enscript-comment">/* Release a naked (in limbo or in transit) receive right */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_port_release_receive</span>(
	ipc_port_t	port);

<span class="enscript-comment">/* finalize the destruction of a port before it gets freed */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_port_finalize</span>(
	ipc_port_t	port);

<span class="enscript-comment">/* Allocate a port in a special space */</span>
<span class="enscript-type">extern</span> ipc_port_t <span class="enscript-function-name">ipc_port_alloc_special</span>(
	ipc_space_t	space);

<span class="enscript-comment">/* Deallocate a port in a special space */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_port_dealloc_special</span>(
	ipc_port_t	port,
	ipc_space_t	space);

#<span class="enscript-reference">if</span>	<span class="enscript-variable-name">MACH_ASSERT</span>
<span class="enscript-comment">/* Track low-level port deallocation */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_port_track_dealloc</span>(
	ipc_port_t	port);

<span class="enscript-comment">/* Initialize general port debugging state */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_port_debug_init</span>(<span class="enscript-type">void</span>);
#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* MACH_ASSERT */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ipc_port_alloc_kernel</span>()		\
		ipc_port_alloc_special(ipc_space_kernel)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ipc_port_dealloc_kernel</span>(port)	\
		ipc_port_dealloc_special((port), ipc_space_kernel)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ipc_port_alloc_reply</span>()		\
		ipc_port_alloc_special(ipc_space_reply)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ipc_port_dealloc_reply</span>(port)	\
		ipc_port_dealloc_special((port), ipc_space_reply)

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* MACH_KERNEL_PRIVATE */</span>

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* _IPC_IPC_PORT_H_ */</span>
</pre>
<hr />
</body></html>