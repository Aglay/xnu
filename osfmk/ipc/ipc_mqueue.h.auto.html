<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>ipc_mqueue.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">ipc_mqueue.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000-2007 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*
 * @OSF_COPYRIGHT@
 */</span>
<span class="enscript-comment">/* 
 * Mach Operating System
 * Copyright (c) 1991,1990,1989 Carnegie Mellon University
 * All Rights Reserved.
 * 
 * Permission to use, copy, modify and distribute this software and its
 * documentation is hereby granted, provided that both the copyright
 * notice and this permission notice appear in all copies of the
 * software, derivative works or modified versions, and any portions
 * thereof, and that both notices appear in supporting documentation.
 * 
 * CARNEGIE MELLON ALLOWS FREE USE OF THIS SOFTWARE IN ITS &quot;AS IS&quot;
 * CONDITION.  CARNEGIE MELLON DISCLAIMS ANY LIABILITY OF ANY KIND FOR
 * ANY DAMAGES WHATSOEVER RESULTING FROM THE USE OF THIS SOFTWARE.
 * 
 * Carnegie Mellon requests users of this software to return to
 * 
 *  Software Distribution Coordinator  or  <a href="mailto:Software.Distribution@CS.CMU.EDU">Software.Distribution@CS.CMU.EDU</a>
 *  School of Computer Science
 *  Carnegie Mellon University
 *  Pittsburgh PA 15213-3890
 * 
 * any improvements or extensions that they make and grant Carnegie Mellon
 * the rights to redistribute these changes.
 */</span>
<span class="enscript-comment">/*
 */</span>
<span class="enscript-comment">/*
 *	File:	ipc/ipc_mqueue.h
 *	Author:	Rich Draves
 *	Date:	1989
 *
 *	Definitions for message queues.
 */</span>

#<span class="enscript-reference">ifndef</span>	<span class="enscript-variable-name">_IPC_IPC_MQUEUE_H_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_IPC_IPC_MQUEUE_H_</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach_assert.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/message.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/assert.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/macro_help.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/kern_types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/spl.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/waitq.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;ipc/ipc_kmsg.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;ipc/ipc_object.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;ipc/ipc_types.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/event.h&gt;</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> ipc_mqueue {
	<span class="enscript-type">union</span> {
		<span class="enscript-type">struct</span> {
			<span class="enscript-type">struct</span>  waitq		waitq;
			<span class="enscript-type">struct</span> ipc_kmsg_queue	messages;
			mach_port_seqno_t 	seqno;
			mach_port_name_t	receiver_name;
			uint16_t		msgcount;
			uint16_t		qlimit;
		} __attribute__((__packed__)) port;
		<span class="enscript-type">struct</span> {
			<span class="enscript-type">struct</span> waitq_set	setq;
			mach_port_name_t	local_name;
		} __attribute__((__packed__)) pset;
	} data;
} *ipc_mqueue_t;

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">IMQ_NULL</span>		((ipc_mqueue_t) 0)

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">imq_wait_queue</span>		data.port.waitq
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">imq_messages</span>		data.port.messages
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">imq_msgcount</span>		data.port.msgcount
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">imq_qlimit</span>		data.port.qlimit
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">imq_seqno</span>		data.port.seqno
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">imq_receiver_name</span>	data.port.receiver_name

<span class="enscript-comment">/*
 * we can use the 'eventmask' bits of the waitq b/c
 * they are only used by global queues
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">imq_fullwaiters</span>		data.port.waitq.waitq_eventmask
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">imq_in_pset</span>		data.port.waitq.waitq_set_id

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">imq_set_queue</span>		data.pset.setq
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">imq_local_name</span>		data.pset.local_name
#<span class="enscript-reference">define</span> <span class="enscript-function-name">imq_is_set</span>(mq)		waitqs_is_set(&amp;(mq)-&gt;imq_set_queue)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">imq_lock</span>(mq)		waitq_lock(&amp;(mq)-&gt;imq_wait_queue)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">imq_lock_try</span>(mq)	waitq_lock_try(&amp;(mq)-&gt;imq_wait_queue)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">imq_unlock</span>(mq)		waitq_unlock(&amp;(mq)-&gt;imq_wait_queue)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">imq_held</span>(mq)		waitq_held(&amp;(mq)-&gt;imq_wait_queue)

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">imq_reserve_and_lock</span>(ipc_mqueue_t mq,
				 uint64_t *reserved_prepost, spl_t *spl);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">imq_release_and_unlock</span>(ipc_mqueue_t mq,
				   uint64_t reserved_prepost, spl_t spl);

#<span class="enscript-reference">define</span> <span class="enscript-function-name">imq_full</span>(mq)		((mq)-&gt;imq_msgcount &gt;= (mq)-&gt;imq_qlimit)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">imq_full_kernel</span>(mq)	((mq)-&gt;imq_msgcount &gt;= MACH_PORT_QLIMIT_KERNEL)

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> ipc_mqueue_full;
<span class="enscript-comment">// extern int ipc_mqueue_rcv;
</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IPC_MQUEUE_FULL</span>		CAST_EVENT64_T(&amp;ipc_mqueue_full)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IPC_MQUEUE_RECEIVE</span>	NO_EVENT64

<span class="enscript-comment">/*
 * Exported interfaces
 */</span>

<span class="enscript-comment">/* Initialize a newly-allocated message queue */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_mqueue_init</span>(
	ipc_mqueue_t		mqueue,
	boolean_t		is_set,
	uint64_t		*reserved_link);

<span class="enscript-comment">/* de-initialize / cleanup an mqueue (specifically waitq resources) */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_mqueue_deinit</span>(
	ipc_mqueue_t		mqueue);

<span class="enscript-comment">/* destroy an mqueue */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_mqueue_destroy</span>(
	ipc_mqueue_t		mqueue);

<span class="enscript-comment">/* Wake up receivers waiting in a message queue */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_mqueue_changed</span>(
	ipc_mqueue_t		mqueue);

<span class="enscript-comment">/* Add the specific mqueue as a member of the set */</span>
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ipc_mqueue_add</span>(
	ipc_mqueue_t		mqueue,
	ipc_mqueue_t	 	set_mqueue,
	uint64_t		*reserved_link,
	uint64_t		*reserved_prepost);

<span class="enscript-comment">/* Check to see if mqueue is member of set_mqueue */</span>
<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">ipc_mqueue_member</span>(
	ipc_mqueue_t		mqueue,
	ipc_mqueue_t		set_mqueue);

<span class="enscript-comment">/* Remove an mqueue from a specific set */</span>
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ipc_mqueue_remove</span>(
	ipc_mqueue_t	 	mqueue,
	ipc_mqueue_t		set_mqueue);

<span class="enscript-comment">/* Remove an mqueue from all sets */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_mqueue_remove_from_all</span>(
	ipc_mqueue_t		mqueue);

<span class="enscript-comment">/* Remove all the members of the specifiied set */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_mqueue_remove_all</span>(
	ipc_mqueue_t		mqueue);

<span class="enscript-comment">/* Send a message to a port */</span>
<span class="enscript-type">extern</span> mach_msg_return_t <span class="enscript-function-name">ipc_mqueue_send</span>(
	ipc_mqueue_t		mqueue,
	ipc_kmsg_t		kmsg,
	mach_msg_option_t	option,
	mach_msg_timeout_t	timeout_val,
	spl_t			s);

<span class="enscript-comment">/* check for queue send queue full of a port */</span>
<span class="enscript-type">extern</span> mach_msg_return_t <span class="enscript-function-name">ipc_mqueue_preflight_send</span>(
	ipc_mqueue_t		mqueue,
	ipc_kmsg_t		kmsg,
	mach_msg_option_t	option,
	mach_msg_timeout_t	timeout_val);

<span class="enscript-comment">/* Deliver message to message queue or waiting receiver */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_mqueue_post</span>(
	ipc_mqueue_t		mqueue,
	ipc_kmsg_t		kmsg);

<span class="enscript-comment">/* Receive a message from a message queue */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_mqueue_receive</span>(
	ipc_mqueue_t		mqueue,
	mach_msg_option_t	option,
	mach_msg_size_t		max_size,
	mach_msg_timeout_t	timeout_val,
	<span class="enscript-type">int</span>                     interruptible);

<span class="enscript-comment">/* Receive a message from a message queue using a specified thread */</span>
<span class="enscript-type">extern</span> wait_result_t <span class="enscript-function-name">ipc_mqueue_receive_on_thread</span>(
        ipc_mqueue_t            mqueue,
	mach_msg_option_t       option,
	mach_msg_size_t         max_size,
	mach_msg_timeout_t      rcv_timeout,
	<span class="enscript-type">int</span>                     interruptible,
	thread_t                thread);

<span class="enscript-comment">/* Continuation routine for message receive */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_mqueue_receive_continue</span>(
	<span class="enscript-type">void</span>			*param,
	wait_result_t		wresult);

<span class="enscript-comment">/* Select a message from a queue and try to post it to ourself */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_mqueue_select_on_thread</span>(
	ipc_mqueue_t		port_mq,
	ipc_mqueue_t		set_mq,
	mach_msg_option_t	option,
	mach_msg_size_t		max_size,
	thread_t                thread);

<span class="enscript-comment">/* Peek into a messaqe queue to see if there are messages */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">unsigned</span> <span class="enscript-function-name">ipc_mqueue_peek</span>(
	ipc_mqueue_t		mqueue,
	mach_port_seqno_t	*msg_seqnop,
	mach_msg_size_t		*msg_sizep,
	mach_msg_id_t		*msg_idp,
	mach_msg_max_trailer_t	*msg_trailerp);

<span class="enscript-comment">/* Peek into a messaqe queue set to see if there are queues with messages */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">unsigned</span> <span class="enscript-function-name">ipc_mqueue_set_peek</span>(
	ipc_mqueue_t		mqueue);

<span class="enscript-comment">/* Gather the names of member port for a given set */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_mqueue_set_gather_member_names</span>(
	ipc_space_t		space,
	ipc_mqueue_t		set_mq,
	ipc_entry_num_t		maxnames,
	mach_port_name_t	*names,
	ipc_entry_num_t		*actualp);

<span class="enscript-comment">/* Clear a message count reservation */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_mqueue_release_msgcount</span>(
	ipc_mqueue_t		port_mq,
	ipc_mqueue_t		set_mq);

<span class="enscript-comment">/* Change a queue limit */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_mqueue_set_qlimit</span>(
	ipc_mqueue_t		mqueue,
	mach_port_msgcount_t	qlimit);

<span class="enscript-comment">/* Change a queue's sequence number */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ipc_mqueue_set_seqno</span>(
	ipc_mqueue_t		mqueue, 
	mach_port_seqno_t 	seqno);

<span class="enscript-comment">/* Convert a name in a space to a message queue */</span>
<span class="enscript-type">extern</span> mach_msg_return_t <span class="enscript-function-name">ipc_mqueue_copyin</span>(
	ipc_space_t		space,
	mach_port_name_t	name,
	ipc_mqueue_t		*mqueuep,
	ipc_object_t		*objectp);

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* _IPC_IPC_MQUEUE_H_ */</span>
</pre>
<hr />
</body></html>