<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>task.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">task.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000-2010, 2015 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*
 * @OSF_FREE_COPYRIGHT@
 */</span>
<span class="enscript-comment">/* 
 * Mach Operating System
 * Copyright (c) 1991,1990,1989,1988 Carnegie Mellon University
 * All Rights Reserved.
 * 
 * Permission to use, copy, modify and distribute this software and its
 * documentation is hereby granted, provided that both the copyright
 * notice and this permission notice appear in all copies of the
 * software, derivative works or modified versions, and any portions
 * thereof, and that both notices appear in supporting documentation.
 * 
 * CARNEGIE MELLON ALLOWS FREE USE OF THIS SOFTWARE IN ITS &quot;AS IS&quot;
 * CONDITION.  CARNEGIE MELLON DISCLAIMS ANY LIABILITY OF ANY KIND FOR
 * ANY DAMAGES WHATSOEVER RESULTING FROM THE USE OF THIS SOFTWARE.
 * 
 * Carnegie Mellon requests users of this software to return to
 * 
 *  Software Distribution Coordinator  or  <a href="mailto:Software.Distribution@CS.CMU.EDU">Software.Distribution@CS.CMU.EDU</a>
 *  School of Computer Science
 *  Carnegie Mellon University
 *  Pittsburgh PA 15213-3890
 * 
 * any improvements or extensions that they make and grant Carnegie Mellon
 * the rights to redistribute these changes.
 */</span>
<span class="enscript-comment">/*
 */</span>
<span class="enscript-comment">/*
 *	File:	task.h
 *	Author:	Avadis Tevanian, Jr.
 *
 *	This file contains the structure definitions for tasks.
 *
 */</span>
<span class="enscript-comment">/*
 * Copyright (c) 1993 The University of Utah and
 * the Computer Systems Laboratory (CSL).  All rights reserved.
 *
 * Permission to use, copy, modify and distribute this software and its
 * documentation is hereby granted, provided that both the copyright
 * notice and this permission notice appear in all copies of the
 * software, derivative works or modified versions, and any portions
 * thereof, and that both notices appear in supporting documentation.
 *
 * THE UNIVERSITY OF UTAH AND CSL ALLOW FREE USE OF THIS SOFTWARE IN ITS &quot;AS
 * IS&quot; CONDITION.  THE UNIVERSITY OF UTAH AND CSL DISCLAIM ANY LIABILITY OF
 * ANY KIND FOR ANY DAMAGES WHATSOEVER RESULTING FROM THE USE OF THIS SOFTWARE.
 *
 * CSL requests users of this software to return to <a href="mailto:csl-dist@cs.utah.edu">csl-dist@cs.utah.edu</a> any
 * improvements that they make and grant CSL redistribution rights.
 *
 */</span>
<span class="enscript-comment">/*
 * NOTICE: This file was modified by McAfee Research in 2004 to introduce
 * support for mandatory and extensible security protections.  This notice
 * is included in support of clause 2.2 (b) of the Apple Public License,
 * Version 2.0.
 * Copyright (c) 2005 SPARTA, Inc.
 */</span>

#<span class="enscript-reference">ifndef</span>	<span class="enscript-variable-name">_KERN_TASK_H_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_KERN_TASK_H_</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/kern_types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/mach_types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/cdefs.h&gt;</span>

#<span class="enscript-reference">ifdef</span>	<span class="enscript-variable-name">MACH_KERNEL_PRIVATE</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/boolean.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/port.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/time_value.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/message.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/mach_param.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/task_info.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/exception_types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/vm_statistics.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;machine/task.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/cpu_data.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/queue.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/exception.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/locks.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;security/_label.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;ipc/ipc_port.h&gt;</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* MACH_KERNEL_PRIVATE */</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">XNU_KERNEL_PRIVATE</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/kern_cdata.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/sfi_class.h&gt;</span>

<span class="enscript-comment">/* defns for task-&gt;rsu_controldata */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_CPU_RESOURCE_USAGE</span>		0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_WIREDMEM_RESOURCE_USAGE</span>	1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_VIRTUALMEM_RESOURCE_USAGE</span>	2
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_DISK_RESOURCE_USAGE</span>		3
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_NETWORK_RESOURCE_USAGE</span>	4
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_POWER_RESOURCE_USAGE</span>	5

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_RESOURCE_USAGE_COUNT</span> 6

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">TASK_POLICY_CPUMON_DISABLE</span>			0xFF
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">TASK_POLICY_CPUMON_DEFAULTS</span>			0xFE

<span class="enscript-comment">/* Resource usage/low resource attributes */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_RESOURCE_ATTRIBUTE_NONE</span>		0x00
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_RESOURCE_ATTRIBUTE_THROTTLE</span>		0x01
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_RESOURCE_ATTRIBUTE_SUSPEND</span> 		0x02
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_RESOURCE_ATTRIBUTE_TERMINATE</span>	0x03
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_RESOURCE_ATTRIBUTE_NOTIFY_KQ</span>	0x04
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_RESOURCE_ATTRIBUTE_NOTIFY_EXC</span>	0x05
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_RESOURCE_ATTRIBUTE_DEFAULT</span>		TASK_POLICY_RESOURCE_ATTRIBUTE_NONE

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* XNU_KERNEL_PRIVATE */</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">MACH_KERNEL_PRIVATE</span>


#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/thread.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/coalition.h&gt;</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">CONFIG_ATM</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;atm/atm_internal.h&gt;</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-type">struct</span> _cpu_time_qos_stats {
        uint64_t cpu_time_qos_default;
        uint64_t cpu_time_qos_maintenance;
        uint64_t cpu_time_qos_background;
        uint64_t cpu_time_qos_utility;
        uint64_t cpu_time_qos_legacy;
        uint64_t cpu_time_qos_user_initiated;
        uint64_t cpu_time_qos_user_interactive;
};

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">CONFIG_BANK</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;bank/bank_internal.h&gt;</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-type">struct</span> task {
	<span class="enscript-comment">/* Synchronization/destruction information */</span>
	decl_lck_mtx_data(,lock)		<span class="enscript-comment">/* Task's lock */</span>
	uint32_t	ref_count;	<span class="enscript-comment">/* Number of references to me */</span>
	boolean_t	active;		<span class="enscript-comment">/* Task has not been terminated */</span>
	boolean_t	halting;	<span class="enscript-comment">/* Task is being halted */</span>

	<span class="enscript-comment">/* Miscellaneous */</span>
	vm_map_t	map;		<span class="enscript-comment">/* Address space description */</span>
	queue_chain_t	tasks;	<span class="enscript-comment">/* global list of tasks */</span>
	<span class="enscript-type">void</span>		*user_data;	<span class="enscript-comment">/* Arbitrary data settable via IPC */</span>

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">CONFIG_SCHED_MULTIQ</span>)
	sched_group_t sched_group;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* defined(CONFIG_SCHED_MULTIQ) */</span>

	<span class="enscript-comment">/* Threads in this task */</span>
	queue_head_t		threads;

	processor_set_t		pset_hint;
	<span class="enscript-type">struct</span> affinity_space	*affinity_space;

	<span class="enscript-type">int</span>			thread_count;
	uint32_t		active_thread_count;
	<span class="enscript-type">int</span>			suspend_count;	<span class="enscript-comment">/* Internal scheduling only */</span>

	<span class="enscript-comment">/* User-visible scheduling information */</span>
	integer_t		user_stop_count;	<span class="enscript-comment">/* outstanding stops */</span>
	integer_t		legacy_stop_count;	<span class="enscript-comment">/* outstanding legacy stops */</span>

	integer_t		priority;			<span class="enscript-comment">/* base priority for threads */</span>
	integer_t		max_priority;		<span class="enscript-comment">/* maximum priority for threads */</span>

	integer_t		importance;		<span class="enscript-comment">/* priority offset (BSD 'nice' value) */</span>

	<span class="enscript-comment">/* Task security and audit tokens */</span>
	security_token_t sec_token;
	audit_token_t	audit_token;
        
	<span class="enscript-comment">/* Statistics */</span>
	uint64_t		total_user_time;	<span class="enscript-comment">/* terminated threads only */</span>
	uint64_t		total_system_time;
	
	<span class="enscript-comment">/* Virtual timers */</span>
	uint32_t		vtimers;

	<span class="enscript-comment">/* IPC structures */</span>
	decl_lck_mtx_data(,itk_lock_data)
	<span class="enscript-type">struct</span> ipc_port *itk_self;	<span class="enscript-comment">/* not a right, doesn't hold ref */</span>
	<span class="enscript-type">struct</span> ipc_port *itk_nself;	<span class="enscript-comment">/* not a right, doesn't hold ref */</span>
	<span class="enscript-type">struct</span> ipc_port *itk_sself;	<span class="enscript-comment">/* a send right */</span>
	<span class="enscript-type">struct</span> exception_action exc_actions[EXC_TYPES_COUNT];
		 			<span class="enscript-comment">/* a send right each valid element  */</span>
	<span class="enscript-type">struct</span> ipc_port *itk_host;	<span class="enscript-comment">/* a send right */</span>
	<span class="enscript-type">struct</span> ipc_port *itk_bootstrap;	<span class="enscript-comment">/* a send right */</span>
	<span class="enscript-type">struct</span> ipc_port *itk_seatbelt;	<span class="enscript-comment">/* a send right */</span>
	<span class="enscript-type">struct</span> ipc_port *itk_gssd;	<span class="enscript-comment">/* yet another send right */</span>
	<span class="enscript-type">struct</span> ipc_port *itk_debug_control; <span class="enscript-comment">/* send right for debugmode communications */</span>
	<span class="enscript-type">struct</span> ipc_port *itk_task_access; <span class="enscript-comment">/* and another send right */</span> 
	<span class="enscript-type">struct</span> ipc_port *itk_resume;	<span class="enscript-comment">/* a receive right to resume this task */</span>
	<span class="enscript-type">struct</span> ipc_port *itk_registered[TASK_PORT_REGISTER_MAX];
					<span class="enscript-comment">/* all send rights */</span>

	<span class="enscript-type">struct</span> ipc_space *itk_space;

	<span class="enscript-comment">/* Synchronizer ownership information */</span>
	queue_head_t	semaphore_list;		<span class="enscript-comment">/* list of owned semaphores   */</span>
	<span class="enscript-type">int</span>		semaphores_owned;	<span class="enscript-comment">/* number of semaphores owned */</span>

	ledger_t	ledger;

	<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>	priv_flags;			<span class="enscript-comment">/* privilege resource flags */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VM_BACKING_STORE_PRIV</span>	0x1

	MACHINE_TASK
        
	integer_t faults;              <span class="enscript-comment">/* faults counter */</span>
        integer_t pageins;             <span class="enscript-comment">/* pageins counter */</span>
        integer_t cow_faults;          <span class="enscript-comment">/* copy on write fault counter */</span>
        integer_t messages_sent;       <span class="enscript-comment">/* messages sent counter */</span>
        integer_t messages_received;   <span class="enscript-comment">/* messages received counter */</span>
        integer_t syscalls_mach;       <span class="enscript-comment">/* mach system call counter */</span>
        integer_t syscalls_unix;       <span class="enscript-comment">/* unix system call counter */</span>
		uint32_t  c_switch;			   <span class="enscript-comment">/* total context switches */</span>
		uint32_t  p_switch;			   <span class="enscript-comment">/* total processor switches */</span>
		uint32_t  ps_switch;		   <span class="enscript-comment">/* total pset switches */</span>

	zinfo_usage_t tkm_zinfo;	<span class="enscript-comment">/* per-task, per-zone usage statistics */</span>

#<span class="enscript-reference">ifdef</span>  <span class="enscript-variable-name">MACH_BSD</span> 
	<span class="enscript-type">void</span> *bsd_info;
#<span class="enscript-reference">endif</span>  
	kcdata_descriptor_t		corpse_info;
	<span class="enscript-type">struct</span> vm_shared_region		*shared_region;
	<span class="enscript-type">volatile</span> uint32_t t_flags;                                      <span class="enscript-comment">/* general-purpose task flags protected by task_lock (TL) */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TF_64B_ADDR</span>             0x00000001                              <span class="enscript-comment">/* task has 64-bit addressing */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TF_64B_DATA</span>             0x00000002                              <span class="enscript-comment">/* task has 64-bit data registers */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TF_CPUMON_WARNING</span>       0x00000004                              <span class="enscript-comment">/* task has at least one thread in CPU usage warning zone */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TF_WAKEMON_WARNING</span>      0x00000008                              <span class="enscript-comment">/* task is in wakeups monitor warning zone */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TF_TELEMETRY</span>            (TF_CPUMON_WARNING | TF_WAKEMON_WARNING) <span class="enscript-comment">/* task is a telemetry participant */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TF_GPU_DENIED</span>           0x00000010                              <span class="enscript-comment">/* task is not allowed to access the GPU */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TF_CORPSE</span>               0x00000020                              <span class="enscript-comment">/* task is a corpse */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TF_PENDING_CORPSE</span>       0x00000040                              <span class="enscript-comment">/* task corpse has not been reported yet */</span>

#<span class="enscript-reference">define</span> <span class="enscript-function-name">task_has_64BitAddr</span>(task)	\
	 (((task)-&gt;t_flags &amp; TF_64B_ADDR) != 0)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">task_set_64BitAddr</span>(task)	\
	 ((task)-&gt;t_flags |= TF_64B_ADDR)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">task_clear_64BitAddr</span>(task)	\
	 ((task)-&gt;t_flags &amp;= ~TF_64B_ADDR)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">task_has_64BitData</span>(task)    \
	 (((task)-&gt;t_flags &amp; TF_64B_DATA) != 0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">task_is_a_corpse</span>(task)      \
	 (((task)-&gt;t_flags &amp; TF_CORPSE) != 0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">task_set_corpse</span>(task)       \
	 ((task)-&gt;t_flags |= TF_CORPSE)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">task_corpse_pending_report</span>(task) 	\
	 (((task)-&gt;t_flags &amp; TF_PENDING_CORPSE) != 0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">task_set_corpse_pending_report</span>(task)       \
	 ((task)-&gt;t_flags |= TF_PENDING_CORPSE)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">task_clear_corpse_pending_report</span>(task)       \
	 ((task)-&gt;t_flags &amp;= ~TF_PENDING_CORPSE)

	mach_vm_address_t	all_image_info_addr; <span class="enscript-comment">/* dyld __all_image_info     */</span>
	mach_vm_size_t		all_image_info_size; <span class="enscript-comment">/* section location and size */</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">KPERF</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_PMC_FLAG</span>			0x1	<span class="enscript-comment">/* Bit in &quot;t_chud&quot; signifying PMC interest */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_KPC_FORCED_ALL_CTRS</span>	0x2	<span class="enscript-comment">/* Bit in &quot;t_chud&quot; signifying KPC forced all counters */</span>

	uint32_t t_chud;		<span class="enscript-comment">/* CHUD flags, used for Shark */</span>
#<span class="enscript-reference">endif</span>

	boolean_t pidsuspended; <span class="enscript-comment">/* pid_suspend called; no threads can execute */</span>
	boolean_t frozen;       <span class="enscript-comment">/* frozen; private resident pages committed to swap */</span>
	boolean_t changing_freeze_state;	<span class="enscript-comment">/* in the process of freezing or thawing */</span>
	uint16_t policy_ru_cpu          :4,
	         policy_ru_cpu_ext      :4,
	         applied_ru_cpu         :4,
	         applied_ru_cpu_ext     :4;
	uint8_t  rusage_cpu_flags;
	uint8_t  rusage_cpu_percentage;		<span class="enscript-comment">/* Task-wide CPU limit percentage */</span>
	uint64_t rusage_cpu_interval;		<span class="enscript-comment">/* Task-wide CPU limit interval */</span>
	uint8_t  rusage_cpu_perthr_percentage;  <span class="enscript-comment">/* Per-thread CPU limit percentage */</span>
	uint64_t rusage_cpu_perthr_interval;    <span class="enscript-comment">/* Per-thread CPU limit interval */</span>
	uint64_t rusage_cpu_deadline;
	thread_call_t rusage_cpu_callt;

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_ATM</span>
	<span class="enscript-type">struct</span> atm_task_descriptor *atm_context;  <span class="enscript-comment">/* pointer to per task atm descriptor */</span>
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_BANK</span>
	<span class="enscript-type">struct</span> bank_task *bank_context;  <span class="enscript-comment">/* pointer to per task bank structure */</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">IMPORTANCE_INHERITANCE</span>
	<span class="enscript-type">struct</span> ipc_importance_task  *task_imp_base;	<span class="enscript-comment">/* Base of IPC importance chain */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* IMPORTANCE_INHERITANCE */</span>

	vm_extmod_statistics_data_t	extmod_statistics;

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">MACH_ASSERT</span>
	int8_t		suspends_outstanding;	<span class="enscript-comment">/* suspends this task performed in excess of resumes */</span>
#<span class="enscript-reference">endif</span>

	<span class="enscript-type">struct</span> task_requested_policy requested_policy;
	<span class="enscript-type">struct</span> task_effective_policy effective_policy;
	<span class="enscript-type">struct</span> task_pended_policy    pended_policy;

	<span class="enscript-comment">/*
	 * Can be merged with imp_donor bits, once the IMPORTANCE_INHERITANCE macro goes away.
	 */</span>
	uint32_t        low_mem_notified_warn		:1,	<span class="enscript-comment">/* warning low memory notification is sent to the task */</span>
	                low_mem_notified_critical	:1,	<span class="enscript-comment">/* critical low memory notification is sent to the task */</span>
	                purged_memory_warn		:1,	<span class="enscript-comment">/* purgeable memory of the task is purged for warning level pressure */</span>
	                purged_memory_critical		:1,	<span class="enscript-comment">/* purgeable memory of the task is purged for critical level pressure */</span>
			low_mem_privileged_listener	:1,	<span class="enscript-comment">/* if set, task would like to know about pressure changes before other tasks on the system */</span>
	                mem_notify_reserved		:27;	<span class="enscript-comment">/* reserved for future use */</span>

	io_stat_info_t 	task_io_stats;
	
	<span class="enscript-comment">/* 
	 * The cpu_time_qos_stats fields are protected by the task lock
	 */</span>
	<span class="enscript-type">struct</span> _cpu_time_qos_stats 	cpu_time_qos_stats;

	<span class="enscript-comment">/* Statistics accumulated for terminated threads from this task */</span>
	uint32_t	task_timer_wakeups_bin_1;
	uint32_t	task_timer_wakeups_bin_2;
	uint64_t	task_gpu_ns;

	<span class="enscript-comment">/* # of purgeable volatile VM objects owned by this task: */</span>
	<span class="enscript-type">int</span>		task_volatile_objects;
	<span class="enscript-comment">/* # of purgeable but not volatile VM objects owned by this task: */</span>
	<span class="enscript-type">int</span>		task_nonvolatile_objects;
	boolean_t	task_purgeable_disowning;
	boolean_t	task_purgeable_disowned;

	<span class="enscript-comment">/*
	 * A task's coalition set is &quot;adopted&quot; in task_create_internal
	 * and unset in task_deallocate_internal, so each array member
	 * can be referenced without the task lock.
	 * Note: these fields are protected by coalition-&gt;lock,
	 *       not the task lock.
	 */</span>
	coalition_t	coalition[COALITION_NUM_TYPES];
	queue_chain_t   task_coalition[COALITION_NUM_TYPES];
	uint64_t        dispatchqueue_offset;

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">HYPERVISOR</span>
	<span class="enscript-type">void</span> *hv_task_target; <span class="enscript-comment">/* hypervisor virtual machine object associated with this task */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* HYPERVISOR */</span>
};

#<span class="enscript-reference">define</span> <span class="enscript-function-name">task_lock</span>(task)		 	lck_mtx_lock(&amp;(task)-&gt;lock)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">task_lock_assert_owned</span>(task)	lck_mtx_assert(&amp;(task)-&gt;lock, LCK_MTX_ASSERT_OWNED)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">task_lock_try</span>(task)	 	lck_mtx_try_lock(&amp;(task)-&gt;lock)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">task_unlock</span>(task)	 	lck_mtx_unlock(&amp;(task)-&gt;lock)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">itk_lock_init</span>(task)	lck_mtx_init(&amp;(task)-&gt;itk_lock_data, &amp;ipc_lck_grp, &amp;ipc_lck_attr)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">itk_lock_destroy</span>(task)	lck_mtx_destroy(&amp;(task)-&gt;itk_lock_data, &amp;ipc_lck_grp)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">itk_lock</span>(task)		lck_mtx_lock(&amp;(task)-&gt;itk_lock_data)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">itk_unlock</span>(task)	lck_mtx_unlock(&amp;(task)-&gt;itk_lock_data)

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_REFERENCE_LEAK_DEBUG</span> 0

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">TASK_REFERENCE_LEAK_DEBUG</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">task_reference_internal</span>(task_t task);
<span class="enscript-type">extern</span> uint32_t <span class="enscript-function-name">task_deallocate_internal</span>(task_t task);
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">task_reference_internal</span>(task)		\
			(<span class="enscript-type">void</span>)hw_atomic_add(&amp;(task)-&gt;ref_count, 1)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">task_deallocate_internal</span>(task)		\
			hw_atomic_sub(&amp;(task)-&gt;ref_count, 1)
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">define</span> <span class="enscript-function-name">task_reference</span>(task)					\
MACRO_BEGIN										\
	<span class="enscript-keyword">if</span> ((task) != TASK_NULL)					\
		task_reference_internal(task);			\
MACRO_END

<span class="enscript-type">extern</span> kern_return_t	kernel_task_create(
							task_t			task,
							vm_offset_t		map_base,
							vm_size_t		map_size,
							task_t 			*child);

<span class="enscript-comment">/* Initialize task module */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		task_init(<span class="enscript-type">void</span>);

<span class="enscript-comment">/* coalition_init() calls this to initialize ledgers before task_init() */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		init_task_ledgers(<span class="enscript-type">void</span>);

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">current_task_fast</span>()	(current_thread()-&gt;task)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">current_task</span>()		current_task_fast()

<span class="enscript-type">extern</span> lck_attr_t      task_lck_attr;
<span class="enscript-type">extern</span> lck_grp_t       task_lck_grp;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">QOS_OVERRIDE_MODE_OVERHANG_PEAK</span> 0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">QOS_OVERRIDE_MODE_IGNORE_OVERRIDE</span> 1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">QOS_OVERRIDE_MODE_FINE_GRAINED_OVERRIDE</span> 2
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">QOS_OVERRIDE_MODE_FINE_GRAINED_OVERRIDE_BUT_IGNORE_DISPATCH</span> 3
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">QOS_OVERRIDE_MODE_FINE_GRAINED_OVERRIDE_BUT_SINGLE_MUTEX_OVERRIDE</span> 4

<span class="enscript-type">extern</span> uint32_t qos_override_mode;

#<span class="enscript-reference">else</span>	<span class="enscript-comment">/* MACH_KERNEL_PRIVATE */</span>

__BEGIN_DECLS

<span class="enscript-type">extern</span> task_t	current_task(<span class="enscript-type">void</span>);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		task_reference(task_t	task);

__END_DECLS

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* MACH_KERNEL_PRIVATE */</span>

__BEGIN_DECLS

#<span class="enscript-reference">ifdef</span>	<span class="enscript-variable-name">XNU_KERNEL_PRIVATE</span>

<span class="enscript-comment">/* Hold all threads in a task */</span>
<span class="enscript-type">extern</span> kern_return_t	task_hold(
							task_t		task);

<span class="enscript-comment">/* Wait for task to stop running, either just to get off CPU or to cease being runnable */</span>
<span class="enscript-type">extern</span> kern_return_t	task_wait(
							task_t		task,
							boolean_t 	until_not_runnable);

<span class="enscript-comment">/* Release hold on all threads in a task */</span>
<span class="enscript-type">extern</span> kern_return_t	task_release(
							task_t		task);

<span class="enscript-comment">/* Suspend/resume a task where the kernel owns the suspend count */</span>
<span class="enscript-type">extern</span> kern_return_t    <span class="enscript-function-name">task_suspend_internal</span>(          task_t          task);
<span class="enscript-type">extern</span> kern_return_t    <span class="enscript-function-name">task_resume_internal</span>(           task_t          task);

<span class="enscript-comment">/* Suspends a task by placing a hold on its threads */</span>
<span class="enscript-type">extern</span> kern_return_t    <span class="enscript-function-name">task_pidsuspend</span>(
							task_t		task);
<span class="enscript-type">extern</span> kern_return_t    <span class="enscript-function-name">task_pidsuspend_locked</span>(
							task_t		task);

<span class="enscript-comment">/* Resumes a previously paused task */</span>
<span class="enscript-type">extern</span> kern_return_t    <span class="enscript-function-name">task_pidresume</span>(
							task_t		task);

<span class="enscript-type">extern</span> kern_return_t	task_send_trace_memory(
							task_t		task,
							uint32_t	pid,
							uint64_t	uniqueid);

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_FREEZE</span>

<span class="enscript-comment">/* Freeze a task's resident pages */</span>
<span class="enscript-type">extern</span> kern_return_t	task_freeze(
							task_t		task,
							uint32_t	*purgeable_count,
							uint32_t	*wired_count,
							uint32_t	*clean_count,
							uint32_t	*dirty_count,
							uint32_t	dirty_budget,
							boolean_t	*shared,
							boolean_t	walk_only);

<span class="enscript-comment">/* Thaw a currently frozen task */</span>
<span class="enscript-type">extern</span> kern_return_t	task_thaw(
							task_t		task);

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CONFIG_FREEZE */</span>

<span class="enscript-comment">/* Halt all other threads in the current task */</span>
<span class="enscript-type">extern</span> kern_return_t	task_start_halt(
							task_t		task);

<span class="enscript-comment">/* Wait for other threads to halt and free halting task resources */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		task_complete_halt(
							task_t		task);

<span class="enscript-type">extern</span> kern_return_t	task_terminate_internal(
							task_t			task);

<span class="enscript-type">extern</span> kern_return_t	task_create_internal(
							task_t		parent_task,
							coalition_t	*parent_coalitions,
							boolean_t	inherit_memory,
							boolean_t	is_64bit,
							task_t		*child_task);	<span class="enscript-comment">/* OUT */</span>

<span class="enscript-type">extern</span> kern_return_t	task_importance(
							task_t			task,
							integer_t		importance);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> 		task_power_info_locked(
							task_t			task,
							task_power_info_t	info,
					       gpu_energy_data_t gpu_energy);

<span class="enscript-type">extern</span> uint64_t		task_gpu_utilisation(
							task_t	 task);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		task_vtimer_set(
					task_t		task,
					integer_t	which);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		task_vtimer_clear(
					task_t		task,
					integer_t	which);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		task_vtimer_update(
					task_t		task,
					integer_t	which,
					uint32_t	*microsecs);

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">TASK_VTIMER_USER</span>		0x01
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">TASK_VTIMER_PROF</span>		0x02
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">TASK_VTIMER_RLIM</span>		0x04

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		task_set_64bit(
					task_t		task,
					boolean_t	is64bit);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		task_backing_store_privileged(
					task_t		task);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		task_set_dyld_info(
    					task_t		task,
					mach_vm_address_t addr,
					mach_vm_size_t size);

<span class="enscript-comment">/* Get number of activations in a task */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>		get_task_numacts(
					task_t		task);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">get_task_numactivethreads</span>(task_t task);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">task_collect_crash_info</span>(task_t task);

<span class="enscript-comment">/* JMM - should just be temporary (implementation in bsd_kern still) */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>	set_bsdtask_info(task_t,<span class="enscript-type">void</span> *);
<span class="enscript-type">extern</span> vm_map_t <span class="enscript-function-name">get_task_map_reference</span>(task_t);
<span class="enscript-type">extern</span> vm_map_t	swap_task_map(task_t, thread_t, vm_map_t, boolean_t);
<span class="enscript-type">extern</span> pmap_t	get_task_pmap(task_t);
<span class="enscript-type">extern</span> uint64_t	get_task_resident_size(task_t);
<span class="enscript-type">extern</span> uint64_t	get_task_compressed(task_t);
<span class="enscript-type">extern</span> uint64_t	get_task_resident_max(task_t);
<span class="enscript-type">extern</span> uint64_t	get_task_phys_footprint(task_t);
<span class="enscript-type">extern</span> uint64_t	get_task_phys_footprint_max(task_t);
<span class="enscript-type">extern</span> uint64_t	get_task_purgeable_size(task_t);
<span class="enscript-type">extern</span> uint64_t	get_task_cpu_time(task_t);
<span class="enscript-type">extern</span> uint64_t <span class="enscript-function-name">get_task_dispatchqueue_offset</span>(task_t);

<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">task_convert_phys_footprint_limit</span>(<span class="enscript-type">int</span>, <span class="enscript-type">int</span> *);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">task_set_phys_footprint_limit_internal</span>(task_t, <span class="enscript-type">int</span>, <span class="enscript-type">int</span> *, boolean_t);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">task_get_phys_footprint_limit</span>(task_t task, <span class="enscript-type">int</span> *limit_mb);

<span class="enscript-type">extern</span> boolean_t	is_kerneltask(task_t task);

<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">check_actforsig</span>(task_t task, thread_t thread, <span class="enscript-type">int</span> setast);

<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">machine_task_get_state</span>(
					task_t task, 
					<span class="enscript-type">int</span> flavor, 
					thread_state_t state, 
					mach_msg_type_number_t *state_count);

<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">machine_task_set_state</span>(
					task_t task, 
					<span class="enscript-type">int</span> flavor, 
					thread_state_t state, 
					mach_msg_type_number_t state_count);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">machine_task_terminate</span>(task_t task);

<span class="enscript-type">struct</span> _task_ledger_indices {
	<span class="enscript-type">int</span> cpu_time;
	<span class="enscript-type">int</span> tkm_private;
	<span class="enscript-type">int</span> tkm_shared;
	<span class="enscript-type">int</span> phys_mem;
	<span class="enscript-type">int</span> wired_mem;
	<span class="enscript-type">int</span> internal;
	<span class="enscript-type">int</span> iokit_mapped;
	<span class="enscript-type">int</span> alternate_accounting;
	<span class="enscript-type">int</span> alternate_accounting_compressed;
	<span class="enscript-type">int</span> phys_footprint;
	<span class="enscript-type">int</span> internal_compressed;
	<span class="enscript-type">int</span> purgeable_volatile;
	<span class="enscript-type">int</span> purgeable_nonvolatile;
	<span class="enscript-type">int</span> purgeable_volatile_compressed;
	<span class="enscript-type">int</span> purgeable_nonvolatile_compressed;
	<span class="enscript-type">int</span> platform_idle_wakeups;
	<span class="enscript-type">int</span> interrupt_wakeups;
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_SCHED_SFI</span>
	<span class="enscript-type">int</span> sfi_wait_times[MAX_SFI_CLASS_ID];
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CONFIG_SCHED_SFI */</span>
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">CONFIG_BANK</span>
	<span class="enscript-type">int</span> cpu_time_billed_to_me;
	<span class="enscript-type">int</span> cpu_time_billed_to_others;
#<span class="enscript-reference">endif</span>
};
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> _task_ledger_indices task_ledgers;

<span class="enscript-comment">/* Begin task_policy */</span>

<span class="enscript-comment">/* value */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_DISABLE</span>             0x0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_ENABLE</span>              0x1

<span class="enscript-comment">/* category */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_INTERNAL</span>            0x0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_EXTERNAL</span>            0x1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_ATTRIBUTE</span>           0x2

<span class="enscript-comment">/* for tracing */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_TASK</span>                0x4
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_THREAD</span>              0x8

<span class="enscript-comment">/* flavors (also DBG_IMPORTANCE subclasses  0x20 - 0x3F) */</span>

<span class="enscript-comment">/* internal or external, thread or task */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_DARWIN_BG</span>           0x21
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_IOPOL</span>               0x22
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_IO</span>                  0x23
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_PASSIVE_IO</span>          0x24

<span class="enscript-comment">/* internal, task only */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_DARWIN_BG_IOPOL</span>     0x27

<span class="enscript-comment">/* task-only attributes */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_TAL</span>                 0x28
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_BOOST</span>               0x29
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_ROLE</span>                0x2A
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_SUPPRESSED_CPU</span>      0x2B
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_TERMINATED</span>          0x2C
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_NEW_SOCKETS_BG</span>      0x2D
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_LOWPRI_CPU</span>          0x2E
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_LATENCY_QOS</span>         0x2F
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_THROUGH_QOS</span>         0x30
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_WATCHERS_BG</span>         0x31

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_SFI_MANAGED</span>         0x34
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_ALL_SOCKETS_BG</span>      0x37

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_BASE_LATENCY_AND_THROUGHPUT_QOS</span>  0x39 <span class="enscript-comment">/* latency as value1, throughput as value2 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_OVERRIDE_LATENCY_AND_THROUGHPUT_QOS</span>  0x3A <span class="enscript-comment">/* latency as value1, throughput as value2 */</span>

<span class="enscript-comment">/* thread-only attributes */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_PIDBIND_BG</span>          0x32
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_WORKQ_BG</span>            0x33
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_QOS</span>                 0x35
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_QOS_OVERRIDE</span>        0x36
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_QOS_AND_RELPRIO</span>     0x38 <span class="enscript-comment">/* QoS as value1, relative priority as value2 */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_POLICY_MAX</span>                 0x3F

<span class="enscript-comment">/* The main entrance to task policy is this function */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">proc_set_task_policy</span>(task_t task, thread_t thread, <span class="enscript-type">int</span> category, <span class="enscript-type">int</span> flavor, <span class="enscript-type">int</span> value);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>  <span class="enscript-function-name">proc_get_task_policy</span>(task_t task, thread_t thread, <span class="enscript-type">int</span> category, <span class="enscript-type">int</span> flavor);

<span class="enscript-comment">/* For attributes that have two scalars as input/output */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">proc_set_task_policy2</span>(task_t task, thread_t thread, <span class="enscript-type">int</span> category, <span class="enscript-type">int</span> flavor, <span class="enscript-type">int</span> value1, <span class="enscript-type">int</span> value2);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">proc_get_task_policy2</span>(task_t task, thread_t thread, <span class="enscript-type">int</span> category, <span class="enscript-type">int</span> flavor, <span class="enscript-type">int</span> *value1, <span class="enscript-type">int</span> *value2);

<span class="enscript-comment">/* For use by kernel threads and others who don't hold a reference on the target thread */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">proc_set_task_policy_thread</span>(task_t task, uint64_t tid, <span class="enscript-type">int</span> category, <span class="enscript-type">int</span> flavor, <span class="enscript-type">int</span> value);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">proc_set_task_spawnpolicy</span>(task_t task, <span class="enscript-type">int</span> apptype, <span class="enscript-type">int</span> qos_clamp, <span class="enscript-type">int</span> role,
                                      ipc_port_t * portwatch_ports, <span class="enscript-type">int</span> portwatch_count);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">task_set_main_thread_qos</span>(task_t task, thread_t main_thread);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">proc_darwin_role_to_task_role</span>(<span class="enscript-type">int</span> darwin_role, <span class="enscript-type">int</span>* task_role);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">proc_task_role_to_darwin_role</span>(<span class="enscript-type">int</span> task_role);


<span class="enscript-comment">/* IO Throttle tiers */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THROTTLE_LEVEL_NONE</span>     -1
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">THROTTLE_LEVEL_TIER0</span>     0      <span class="enscript-comment">/* IOPOL_NORMAL, IOPOL_DEFAULT, IOPOL_PASSIVE */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THROTTLE_LEVEL_THROTTLED</span> 1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THROTTLE_LEVEL_TIER1</span>     1      <span class="enscript-comment">/* IOPOL_STANDARD */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THROTTLE_LEVEL_TIER2</span>     2      <span class="enscript-comment">/* IOPOL_UTILITY */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THROTTLE_LEVEL_TIER3</span>     3      <span class="enscript-comment">/* IOPOL_THROTTLE */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THROTTLE_LEVEL_START</span>     0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THROTTLE_LEVEL_END</span>       3

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THROTTLE_LEVEL_COMPRESSOR_TIER0</span>		THROTTLE_LEVEL_TIER0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THROTTLE_LEVEL_COMPRESSOR_TIER1</span>		THROTTLE_LEVEL_TIER1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THROTTLE_LEVEL_COMPRESSOR_TIER2</span>		THROTTLE_LEVEL_TIER2

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THROTTLE_LEVEL_PAGEOUT_THROTTLED</span>        THROTTLE_LEVEL_TIER2
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THROTTLE_LEVEL_PAGEOUT_UNTHROTTLED</span>      THROTTLE_LEVEL_TIER1

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_IOSCHED</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">IOSCHED_METADATA_TIER</span> 			THROTTLE_LEVEL_TIER1
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CONFIG_IOSCHED */</span>

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">proc_apply_workq_bgthreadpolicy</span>(thread_t thread);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">proc_restore_workq_bgthreadpolicy</span>(thread_t thread);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">proc_get_darwinbgstate</span>(task_t task, uint32_t *flagsp);
<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">proc_task_is_tal</span>(task_t task);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">task_get_apptype</span>(task_t);
<span class="enscript-type">extern</span> integer_t <span class="enscript-function-name">task_grab_latency_qos</span>(task_t task);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">task_policy_create</span>(task_t task, <span class="enscript-type">int</span> parent_boosted);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">thread_policy_create</span>(thread_t thread);

<span class="enscript-comment">/*
 * for IPC importance hooks into task policy
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> task_pend_token {
	uint32_t        tpt_update_sockets      :1,
	                tpt_update_timers       :1,
	                tpt_update_watchers     :1,
	                tpt_update_live_donor   :1,
	                tpt_update_coal_sfi     :1;
} *task_pend_token_t;

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">task_policy_update_complete_unlocked</span>(task_t task, thread_t thread, task_pend_token_t pend_token);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">task_update_boost_locked</span>(task_t task, boolean_t boost_active, task_pend_token_t pend_token);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">task_set_boost_locked</span>(task_t task, boolean_t boost_active);

<span class="enscript-comment">/*
 * Get effective policy
 * Only for use by relevant subsystem, should never be passed into a setter!
 */</span>

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">proc_get_effective_task_policy</span>(task_t task, <span class="enscript-type">int</span> flavor);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">proc_get_effective_thread_policy</span>(thread_t thread, <span class="enscript-type">int</span> flavor);

<span class="enscript-comment">/* temporary compatibility */</span>
<span class="enscript-type">int</span> <span class="enscript-function-name">proc_setthread_saved_importance</span>(thread_t thread, <span class="enscript-type">int</span> importance);

<span class="enscript-type">int</span> <span class="enscript-function-name">proc_get_task_ruse_cpu</span>(task_t task, uint32_t *policyp, uint8_t *percentagep, uint64_t *intervalp, uint64_t *deadlinep);
<span class="enscript-type">int</span> <span class="enscript-function-name">proc_set_task_ruse_cpu</span>(task_t task, uint32_t policy, uint8_t percentage, uint64_t interval, uint64_t deadline, <span class="enscript-type">int</span> cpumon_entitled);
<span class="enscript-type">int</span> <span class="enscript-function-name">proc_clear_task_ruse_cpu</span>(task_t task, <span class="enscript-type">int</span> cpumon_entitled);
thread_t <span class="enscript-function-name">task_findtid</span>(task_t, uint64_t);
<span class="enscript-type">void</span> <span class="enscript-function-name">set_thread_iotier_override</span>(thread_t, <span class="enscript-type">int</span> policy);

boolean_t <span class="enscript-function-name">proc_thread_qos_add_override</span>(task_t task, thread_t thread, uint64_t tid, <span class="enscript-type">int</span> override_qos, boolean_t first_override_for_resource, user_addr_t resource, <span class="enscript-type">int</span> resource_type);
boolean_t <span class="enscript-function-name">proc_thread_qos_remove_override</span>(task_t task, thread_t thread, uint64_t tid, user_addr_t resource, <span class="enscript-type">int</span> resource_type);
boolean_t <span class="enscript-function-name">proc_thread_qos_reset_override</span>(task_t task, thread_t thread, uint64_t tid, user_addr_t resource, <span class="enscript-type">int</span> resource_type);
<span class="enscript-type">void</span> <span class="enscript-function-name">proc_thread_qos_deallocate</span>(thread_t thread);

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_RUSECPU_FLAGS_PROC_LIMIT</span>			0x01
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_RUSECPU_FLAGS_PERTHR_LIMIT</span>			0x02
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TASK_RUSECPU_FLAGS_DEADLINE</span>			0x04
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">TASK_RUSECPU_FLAGS_FATAL_CPUMON</span>			0x08	<span class="enscript-comment">/* CPU usage monitor violations are fatal */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">TASK_RUSECPU_FLAGS_FATAL_WAKEUPSMON</span>		0x10	<span class="enscript-comment">/* wakeups monitor violations are fatal */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">TASK_RUSECPU_FLAGS_PHYS_FOOTPRINT_EXCEPTION</span>	0x20	<span class="enscript-comment">/* exceeding physical footprint generates EXC_RESOURCE */</span>

<span class="enscript-comment">/* BSD call back functions */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">proc_apply_resource_actions</span>(<span class="enscript-type">void</span> * p, <span class="enscript-type">int</span> type, <span class="enscript-type">int</span> action);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">proc_restore_resource_actions</span>(<span class="enscript-type">void</span> * p, <span class="enscript-type">int</span> type, <span class="enscript-type">int</span> action);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">task_restore_resource_actions</span>(task_t task, <span class="enscript-type">int</span> type);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">task_clear_cpuusage</span>(task_t task, <span class="enscript-type">int</span> cpumon_entitled);

<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">task_wakeups_monitor_ctl</span>(task_t task, uint32_t *rate_hz, int32_t *flags);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">task_cpu_usage_monitor_ctl</span>(task_t task, uint32_t *flags);


<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">task_importance_mark_donor</span>(task_t task, boolean_t donating);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">task_importance_mark_live_donor</span>(task_t task, boolean_t donating);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">task_importance_mark_receiver</span>(task_t task, boolean_t receiving);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">task_importance_mark_denap_receiver</span>(task_t task, boolean_t denap);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">task_importance_reset</span>(task_t task);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">task_atm_reset</span>(task_t task);

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">IMPORTANCE_INHERITANCE</span>

<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">task_is_importance_donor</span>(task_t task);
<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">task_is_marked_importance_donor</span>(task_t task);
<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">task_is_marked_live_importance_donor</span>(task_t task);

<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">task_is_importance_receiver</span>(task_t task);
<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">task_is_marked_importance_receiver</span>(task_t task);

<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">task_is_importance_denap_receiver</span>(task_t task);
<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">task_is_marked_importance_denap_receiver</span>(task_t task);

<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">task_is_importance_receiver_type</span>(task_t task);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">task_importance_hold_watchport_assertion</span>(task_t target_task, uint32_t count);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">task_importance_hold_internal_assertion</span>(task_t target_task, uint32_t count);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">task_importance_drop_internal_assertion</span>(task_t target_task, uint32_t count);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">task_importance_hold_file_lock_assertion</span>(task_t target_task, uint32_t count);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">task_importance_drop_file_lock_assertion</span>(task_t target_task, uint32_t count);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">task_importance_hold_legacy_external_assertion</span>(task_t target_task, uint32_t count);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">task_importance_drop_legacy_external_assertion</span>(task_t target_task, uint32_t count);

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* IMPORTANCE_INHERITANCE */</span>

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">task_low_mem_privileged_listener</span>(task_t task, boolean_t new_value, boolean_t *old_value);
<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">task_has_been_notified</span>(task_t task, <span class="enscript-type">int</span> pressurelevel);
<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">task_used_for_purging</span>(task_t task, <span class="enscript-type">int</span> pressurelevel);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">task_mark_has_been_notified</span>(task_t task, <span class="enscript-type">int</span> pressurelevel);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">task_mark_used_for_purging</span>(task_t task, <span class="enscript-type">int</span> pressurelevel);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">task_clear_has_been_notified</span>(task_t task, <span class="enscript-type">int</span> pressurelevel);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">task_clear_used_for_purging</span>(task_t task);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">task_importance_estimate</span>(task_t task);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">task_pid</span>(task_t task);

<span class="enscript-comment">/* End task_policy */</span>

<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">task_purge_volatile_memory</span>(task_t task);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>      <span class="enscript-function-name">task_set_gpu_denied</span>(task_t task, boolean_t denied);
<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">task_is_gpu_denied</span>(task_t task);

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* XNU_KERNEL_PRIVATE */</span>

#<span class="enscript-reference">ifdef</span>	<span class="enscript-variable-name">KERNEL_PRIVATE</span>

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> 	*get_bsdtask_info(task_t);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>	*get_bsdthreadtask_info(thread_t);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">task_bsdtask_kill</span>(task_t);
<span class="enscript-type">extern</span> vm_map_t <span class="enscript-function-name">get_task_map</span>(task_t);
<span class="enscript-type">extern</span> ledger_t	get_task_ledger(task_t);

<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">get_task_pidsuspended</span>(task_t);
<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">get_task_frozen</span>(task_t);

<span class="enscript-comment">/* Convert from a task to a port */</span>
<span class="enscript-type">extern</span> ipc_port_t <span class="enscript-function-name">convert_task_to_port</span>(task_t);
<span class="enscript-type">extern</span> ipc_port_t <span class="enscript-function-name">convert_task_name_to_port</span>(task_name_t);
<span class="enscript-type">extern</span> ipc_port_t <span class="enscript-function-name">convert_task_suspension_token_to_port</span>(task_suspension_token_t task);

<span class="enscript-comment">/* Convert from a port (in this case, an SO right to a task's resume port) to a task. */</span>
<span class="enscript-type">extern</span> task_suspension_token_t <span class="enscript-function-name">convert_port_to_task_suspension_token</span>(ipc_port_t port);

<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">task_suspension_notify</span>(mach_msg_header_t *);

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* KERNEL_PRIVATE */</span>

<span class="enscript-type">extern</span> task_t	kernel_task;

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		task_deallocate(
					task_t		task);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		task_name_deallocate(
					task_name_t		task_name);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		task_suspension_token_deallocate(
					task_suspension_token_t	token);
__END_DECLS

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* _KERN_TASK_H_ */</span>
</pre>
<hr />
</body></html>