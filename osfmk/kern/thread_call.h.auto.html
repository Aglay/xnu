<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>thread_call.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">thread_call.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 1993-1995, 1999-2008 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

<span class="enscript-comment">/*!
 @header thread_call.h
 @discussion Facilities for executing work asynchronously.
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_KERN_THREAD_CALL_H_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_KERN_THREAD_CALL_H_</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/mach_types.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/clock.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/cdefs.h&gt;</span>

<span class="enscript-type">struct</span> thread_call;
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> thread_call *thread_call_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">void</span> *thread_call_param_t;
<span class="enscript-type">typedef</span> <span class="enscript-function-name">void</span> (*thread_call_func_t)(
					thread_call_param_t	param0,
					thread_call_param_t	param1);
<span class="enscript-comment">/*!
 @enum thread_call_priority_t
 @discussion Thread call priorities should not be assumed to have any specific 
 numerical value; they should be interpreted as importances or roles for work 
 items, priorities for which will be reasonably managed by the subsystem.
 @constant THREAD_CALL_PRIORITY_HIGH Importance above everything but realtime.
 Thread calls allocated with this priority execute at extremely high priority, 
 above everything but realtime threads.  They are generally executed  in serial.  
 Though they may execute concurrently under some circumstances, no fan-out is implied.  
 These work items should do very small amounts of work or risk disrupting system
 responsiveness.
 @constant THREAD_CALL_PRIORITY_KERNEL Importance similar to that of normal kernel
 threads.
 @constant THREAD_CALL_PRIORITY_USER Importance similar to that of normal user threads.
 @constant THREAD_CALL_PRIORITY_LOW Very low importance.
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> {
	THREAD_CALL_PRIORITY_HIGH 	= 0,
	THREAD_CALL_PRIORITY_KERNEL 	= 1,
	THREAD_CALL_PRIORITY_USER 	= 2,
	THREAD_CALL_PRIORITY_LOW 	= 3
} thread_call_priority_t;

__BEGIN_DECLS

<span class="enscript-comment">/*!
 @function thread_call_enter
 @abstract Submit a thread call work item for immediate execution.
 @discussion If the work item is already scheduled for delayed execution, and it has
 not yet begun to run, that delayed invocation will be cancelled.  Note that if a
 thread call is rescheduled from its own callback, then multiple invocations of the
 callback may be in flight at the same time.
 @result TRUE if the call was already pending for either delayed or immediate
 execution, FALSE otherwise.
 @param call The thread call to execute.
 */</span>
<span class="enscript-type">extern</span> boolean_t	thread_call_enter(
						thread_call_t		call);
<span class="enscript-comment">/*!
 @function thread_call_enter1
 @abstract Submit a thread call work item for immediate execution, with an extra parameter.
 @discussion This routine is identical to thread_call_enter(), except that 
 the second parameter to the callback is specified.
 @result TRUE if the call was already pending for either delayed or immediate
 execution, FALSE otherwise.
 @param call The thread call to execute.
 @param param1 Parameter to pass callback.
 */</span>
<span class="enscript-type">extern</span> boolean_t	thread_call_enter1(
						thread_call_t		call,
						thread_call_param_t	param1);

<span class="enscript-comment">/*! 
 @function thread_call_enter_delayed
 @abstract Submit a thread call to be executed at some point in the future.
 @discussion If the work item is already scheduled for delayed or immediate execution, 
 and it has not yet begun to run, that invocation will be cancelled in favor of execution
 at the newly specified time.  Note that if a thread call is rescheduled from its own callback, 
 then multiple invocations of the callback may be in flight at the same time.
 @result TRUE if the call was already pending for either delayed or immediate
 execution, FALSE otherwise.
 @param call The thread call to execute.
 @param deadline Time, in absolute time units, at which to execute callback.
 */</span>
<span class="enscript-type">extern</span> boolean_t	thread_call_enter_delayed(
						thread_call_t		call,
						uint64_t		deadline);
<span class="enscript-comment">/*! 
 @function thread_call_enter1_delayed
 @abstract Submit a thread call to be executed at some point in the future, with an extra parameter.
 @discussion This routine is identical to thread_call_enter_delayed(),
 except that a second parameter to the callback is specified.
 @result TRUE if the call was already pending for either delayed or immediate
 execution, FALSE otherwise.
 @param call The thread call to execute.
 @param param1 Second parameter to callback.
 @param deadline Time, in absolute time units, at which to execute callback.
 */</span>
<span class="enscript-type">extern</span> boolean_t	thread_call_enter1_delayed(
						thread_call_t		call,
						thread_call_param_t	param1,
						uint64_t		deadline);
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">XNU_KERNEL_PRIVATE</span>

<span class="enscript-comment">/*
 * Flags to alter the default timer/timeout coalescing behavior
 * on a per-thread_call basis.
 *
 * The SYS urgency classes indicate that the thread_call is not
 * directly related to the current thread at the time the thread_call
 * is entered, so it is ignored in the calculation entirely (only
 * the subclass specified is used).
 *
 * The USER flags indicate that both the current thread scheduling and QoS
 * attributes, in addition to the per-thread_call urgency specification,
 * are used to establish coalescing behavior.
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THREAD_CALL_DELAY_SYS_NORMAL</span>		TIMEOUT_URGENCY_SYS_NORMAL
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THREAD_CALL_DELAY_SYS_CRITICAL</span>		TIMEOUT_URGENCY_SYS_CRITICAL
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THREAD_CALL_DELAY_SYS_BACKGROUND</span>	TIMEOUT_URGENCY_SYS_BACKGROUND

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THREAD_CALL_DELAY_USER_MASK</span>		TIMEOUT_URGENCY_USER_MASK
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THREAD_CALL_DELAY_USER_NORMAL</span>		TIMEOUT_URGENCY_USER_NORMAL
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THREAD_CALL_DELAY_USER_CRITICAL</span>		TIMEOUT_URGENCY_USER_CRITICAL
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THREAD_CALL_DELAY_USER_BACKGROUND</span>	TIMEOUT_URGENCY_USER_BACKGROUND

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THREAD_CALL_DELAY_URGENCY_MASK</span>		TIMEOUT_URGENCY_MASK

<span class="enscript-comment">/*
 * Indicate that a specific leeway value is being provided (otherwise
 * the leeway parameter is ignored).  The supplied value can currently
 * only be used to extend the leeway calculated internally from the
 * urgency class provided.
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THREAD_CALL_DELAY_LEEWAY</span>		TIMEOUT_URGENCY_LEEWAY

<span class="enscript-comment">/*! 
 @function thread_call_enter_delayed_with_leeway
 @abstract Submit a thread call to be executed at some point in the future.
 @discussion If the work item is already scheduled for delayed or immediate execution, 
 and it has not yet begun to run, that invocation will be cancelled in favor of execution
 at the newly specified time.  Note that if a thread call is rescheduled from its own callback, 
 then multiple invocations of the callback may be in flight at the same time.
 @result TRUE if the call was already pending for either delayed or immediate
 execution, FALSE otherwise.
 @param call The thread call to execute.
 @param param1 Second parameter to callback.
 @param deadline Time, in absolute time units, at which to execute callback.
 @param leeway Time delta, in absolute time units, which sets range of time allowing kernel
        to decide appropriate time to run.
 @param flags configuration for timers in kernel.
 */</span>
<span class="enscript-type">extern</span> boolean_t	thread_call_enter_delayed_with_leeway(
						thread_call_t		call,
						thread_call_param_t	param1,
						uint64_t		deadline,
						uint64_t		leeway,
						uint32_t		flags);

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* XNU_KERNEL_PRIVATE */</span>

<span class="enscript-comment">/*!
 @function thread_call_cancel
 @abstract Attempt to cancel a pending invocation of a thread call.
 @discussion Attempt to cancel a thread call which has been scheduled
 for execution with a thread_call_enter* variant.  If the call has not 
 yet begun executing, the pending invocation will be cancelled and TRUE
 will be returned.  If the work item has already begun executing,
 thread_call_cancel will return FALSE immediately; the callback may be
 about to run, currently running, or already done executing.
 @result TRUE if the call was successfully cancelled, FALSE otherwise.
 */</span>
<span class="enscript-type">extern</span> boolean_t	thread_call_cancel(
						thread_call_t		call);
<span class="enscript-comment">/*!
 @function thread_call_cancel_wait
 @abstract Attempt to cancel a pending invocation of a thread call.  
 If unable to cancel, wait for current invocation to finish.
 @discussion Attempt to cancel a thread call which has been scheduled
 for execution with a thread_call_enter* variant.  If the call has not 
 yet begun executing, the pending invocation will be cancelled and TRUE
 will be returned.  If the work item has already begun executing,
 thread_call_cancel_wait waits for the most recent invocation to finish. When
 called on a work item which has already finished, it will return FALSE immediately.
 Note that this routine can only be used on thread calls set up with either
 thread_call_allocate or thread_call_allocate_with_priority, and that invocations
 of the thread call &lt;i&gt;after&lt;/i&gt; the current invocation may be in flight when 
 thread_call_cancel_wait returns.
 @result TRUE if the call was successfully cancelled, FALSE otherwise.
 */</span>
<span class="enscript-type">extern</span> boolean_t	thread_call_cancel_wait(
						thread_call_t		call);

 <span class="enscript-comment">/*!
  @function thread_call_allocate
  @abstract Allocate a thread call to execute with default (high) priority.
  @discussion  Allocates a thread call that will run with properties of 
  THREAD_CALL_PRIORITY_HIGH, binding the first parameter to the callback.
  @param func Callback to invoke when thread call is scheduled.
  @param param0 First argument ot pass to callback.
  @result Thread call which can be passed to thread_call_enter variants.
  */</span>
<span class="enscript-type">extern</span> thread_call_t	thread_call_allocate(
						thread_call_func_t	func,
						thread_call_param_t	param0);

 <span class="enscript-comment">/*!
  @function thread_call_allocate_with_priority
  @abstract Allocate a thread call to execute with a specified priority.
  @discussion Identical to thread_call_allocate, except that priority 
  is specified by caller.
  @param func Callback to invoke when thread call is scheduled.
  @param param0 First argument to pass to callback.
  @param pri Priority of item.
  @result Thread call which can be passed to thread_call_enter variants.
  */</span>
<span class="enscript-type">extern</span> thread_call_t	thread_call_allocate_with_priority(
						thread_call_func_t	func,
						thread_call_param_t	param0,
						thread_call_priority_t  pri);

<span class="enscript-comment">/*!
 @function thread_call_free
 @abstract Release a thread call.
 @discussion Should only be used on thread calls allocated with thread_call_allocate
 or thread_call_allocate_with_priority.  Once thread_call_free has been called,
 no other operations may be performed on a thread call.  If the thread call is
 currently pending, thread_call_free will return FALSE and will have no effect.
 Calling thread_call_free from a thread call's own callback is safe; the work
 item is not considering &quot;pending&quot; at that point.
 @result TRUE if the thread call has been successfully released, else FALSE.
 @param call The thread call to release.
 */</span>
<span class="enscript-type">extern</span> boolean_t	thread_call_free(
						thread_call_t		call);

<span class="enscript-comment">/*!
 @function thread_call_isactive
 @abstract Determine whether a thread call is pending or currently executing.
 @param call Thread call to examine.
 @result TRUE if the thread call is either scheduled for execution (immediately
 or at some point in the future) or is currently executing.
 */</span>
boolean_t		thread_call_isactive(
						thread_call_t call);
__END_DECLS

#<span class="enscript-reference">ifdef</span>	<span class="enscript-variable-name">MACH_KERNEL_PRIVATE</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/call_entry.h&gt;</span>

<span class="enscript-type">struct</span> thread_call {
	<span class="enscript-type">struct</span> call_entry 		tc_call;	<span class="enscript-comment">/* Must be first */</span>
	uint64_t			tc_submit_count;
	uint64_t			tc_finish_count;
	uint64_t			ttd; <span class="enscript-comment">/* Time to deadline at creation */</span>
	uint64_t			tc_soft_deadline;
	thread_call_priority_t		tc_pri;
	uint32_t			tc_flags;
	int32_t				tc_refs;
}; 

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THREAD_CALL_ALLOC</span>		0x01
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THREAD_CALL_WAIT</span>		0x02
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THREAD_CALL_DELAYED</span>		0x04
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THREAD_CALL_RATELIMITED</span>		TIMEOUT_URGENCY_RATELIMITED

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> thread_call thread_call_data_t;

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		thread_call_initialize(<span class="enscript-type">void</span>);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		thread_call_setup(
					thread_call_t			call,
					thread_call_func_t		func,
					thread_call_param_t		param0);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> 		thread_call_delayed_timer_rescan_all(<span class="enscript-type">void</span>);
#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* MACH_KERNEL_PRIVATE */</span>

#<span class="enscript-reference">ifdef</span>	<span class="enscript-variable-name">XNU_KERNEL_PRIVATE</span>

__BEGIN_DECLS

<span class="enscript-comment">/*
 * These routines are equivalent to their thread_call_enter_XXX
 * variants, only the thread_call_t is allocated out of a
 * fixed preallocated pool of memory, and will panic if the pool
 * is exhausted.
 */</span>

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		thread_call_func_delayed(
					thread_call_func_t		func,
					thread_call_param_t		param,
					uint64_t			deadline);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		thread_call_func_delayed_with_leeway(
						thread_call_func_t		func,
						thread_call_param_t		param,
						uint64_t		deadline,
						uint64_t		leeway,
						uint32_t		flags);

<span class="enscript-type">extern</span> boolean_t	thread_call_func_cancel(
						thread_call_func_t	func,
						thread_call_param_t	param,
						boolean_t		cancel_all);
__END_DECLS

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* XNU_KERNEL_PRIVATE */</span>

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* _KERN_THREAD_CALL_H_ */</span>
</pre>
<hr />
</body></html>