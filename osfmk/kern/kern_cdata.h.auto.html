<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>kern_cdata.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">kern_cdata.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2015 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 *
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 *
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 *
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_KERN_CDATA_H_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_KERN_CDATA_H_</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdint.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/mach_types.h&gt;</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCDATA_DESC_MAXLEN</span>          32      <span class="enscript-comment">/* including NULL byte at end */</span>

<span class="enscript-type">struct</span> kcdata_item {
	uint32_t type;
	uint32_t size; <span class="enscript-comment">/* len(data)  */</span>
	uint64_t flags;
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">KERNEL</span>
	<span class="enscript-type">char</span> data[];  <span class="enscript-comment">/* must be at the end */</span>
#<span class="enscript-reference">endif</span>
};

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> kcdata_item * kcdata_item_t;

<span class="enscript-type">enum</span> KCDATA_SUBTYPE_TYPES { KC_ST_CHAR = 1, KC_ST_INT8, KC_ST_UINT8, KC_ST_INT16, KC_ST_UINT16, KC_ST_INT32, KC_ST_UINT32, KC_ST_INT64, KC_ST_UINT64 };
<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> KCDATA_SUBTYPE_TYPES kctype_subtype_t;

<span class="enscript-comment">/*
 * A subtype description structure that defines
 * how a compound data is laid out in memory. This
 * provides on the fly definition of types and consumption
 * by the parser.
 */</span>
<span class="enscript-type">struct</span> kcdata_subtype_descriptor {
	uint8_t              kcs_flags;
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCS_SUBTYPE_FLAGS_NONE</span>    0x0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCS_SUBTYPE_FLAGS_ARRAY</span>   0x1
	uint8_t              kcs_elem_type;                 <span class="enscript-comment">/* restricted to kctype_subtype_t */</span>
	uint16_t             kcs_elem_offset;               <span class="enscript-comment">/* offset in struct where data is found */</span>
	uint32_t             kcs_elem_size;                 <span class="enscript-comment">/* size of element (or) packed state for array type */</span>
	<span class="enscript-type">char</span>                 kcs_name[KCDATA_DESC_MAXLEN];  <span class="enscript-comment">/* max 31 bytes for name of field */</span>
};

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> kcdata_subtype_descriptor * kcdata_subtype_descriptor_t;

<span class="enscript-comment">/*
 * In case of array of basic c types in kctype_subtype_t,
 * size is packed in lower 16 bits and
 * count is packed in upper 16 bits of kcs_elem_size field.
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">KCS_SUBTYPE_PACK_SIZE</span>(e_count,e_size)      (((e_count) &amp; 0xffff) &lt;&lt; 16 | ((e_size) &amp; 0xffff))

<span class="enscript-type">static</span> inline uint32_t
<span class="enscript-function-name">kcs_get_elem_size</span>(kcdata_subtype_descriptor_t d)
{
	<span class="enscript-keyword">if</span> (d-&gt;kcs_flags &amp; KCS_SUBTYPE_FLAGS_ARRAY) {
		<span class="enscript-comment">/* size is composed as ((count &amp;0xffff)&lt;&lt;16 | (elem_size &amp; 0xffff)) */</span>
		<span class="enscript-keyword">return</span> (uint32_t)((d-&gt;kcs_elem_size &amp; 0xffff) * ((d-&gt;kcs_elem_size &amp; 0xffff0000)&gt;&gt;16));
	}
	<span class="enscript-keyword">return</span> d-&gt;kcs_elem_size;
}

<span class="enscript-type">static</span> inline uint32_t
<span class="enscript-function-name">kcs_get_elem_count</span>(kcdata_subtype_descriptor_t d)
{
	<span class="enscript-keyword">if</span> (d-&gt;kcs_flags &amp; KCS_SUBTYPE_FLAGS_ARRAY)
		<span class="enscript-keyword">return</span> (d-&gt;kcs_elem_size &gt;&gt; 16) &amp; 0xffff;
	<span class="enscript-keyword">return</span> 1;
}

<span class="enscript-type">static</span> inline kern_return_t
<span class="enscript-function-name">kcs_set_elem_size</span>(kcdata_subtype_descriptor_t d, uint32_t size, uint32_t count)
{
	<span class="enscript-keyword">if</span> (count &gt; 1) {
		<span class="enscript-comment">/* means we are setting up an array */</span>
		<span class="enscript-keyword">if</span> (size &gt; 0xffff || count &gt; 0xffff)
			<span class="enscript-keyword">return</span> KERN_INVALID_ARGUMENT;
		d-&gt;kcs_elem_size = ((count &amp; 0xffff) &lt;&lt; 16 | (size &amp; 0xffff));
	}
	<span class="enscript-keyword">else</span>
	{
		d-&gt;kcs_elem_size = size;
	}
	<span class="enscript-keyword">return</span> KERN_SUCCESS;
}

<span class="enscript-type">struct</span> kcdata_type_definition {
	uint32_t kct_type_identifier;
	uint32_t kct_num_elements;
	<span class="enscript-type">char</span> kct_name[KCDATA_DESC_MAXLEN];
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">KERNEL</span>
	<span class="enscript-type">struct</span> kcdata_subtype_descriptor kct_elements[];
#<span class="enscript-reference">endif</span>
};

<span class="enscript-comment">/* chunk type definitions. 0 - 0x7ff are reserved  and defined here
 * NOTE: Please update libkdd/kcdata/kcdtypes.c if you make any changes
 * in STACKSHOT_KCTYPE_* types.
 */</span>

<span class="enscript-comment">/*
 * Types with description value.
 * these will have KCDATA_DESC_MAXLEN-1 length string description
 * and rest of KCDATA_ITEM_SIZE() - KCDATA_DESC_MAXLEN bytes as data
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCDATA_TYPE_INVALID</span>              0x0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCDATA_TYPE_STRING_DESC</span>          0x1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCDATA_TYPE_UINT32_DESC</span>          0x2
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCDATA_TYPE_UINT64_DESC</span>          0x3
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCDATA_TYPE_INT32_DESC</span>           0x4
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCDATA_TYPE_INT64_DESC</span>           0x5
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCDATA_TYPE_BINDATA_DESC</span>         0x6

<span class="enscript-comment">/*
 * Compound type definitions
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCDATA_TYPE_ARRAY</span>                0x11       <span class="enscript-comment">/* Array of data */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCDATA_TYPE_TYPEDEFINTION</span>        0x12       <span class="enscript-comment">/* Meta type that describes a type on the fly. */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCDATA_TYPE_CONTAINER_BEGIN</span>      0x13       <span class="enscript-comment">/* Container type which has corresponding CONTAINER_END header.
                                                     * KCDATA_TYPE_CONTAINER_BEGIN has type in the data segment.
                                                     * Both headers have (uint64_t) ID for matching up nested data.
                                                     */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCDATA_TYPE_CONTAINER_END</span>        0x14


<span class="enscript-comment">/*
 * Generic data types that are most commonly used
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCDATA_TYPE_LIBRARY_LOADINFO</span>     0x30       <span class="enscript-comment">/* struct dyld_uuid_info_32 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCDATA_TYPE_LIBRARY_LOADINFO64</span>   0x31       <span class="enscript-comment">/* struct dyld_uuid_info_64 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCDATA_TYPE_TIMEBASE</span>             0x32       <span class="enscript-comment">/* struct mach_timebase_info */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCDATA_TYPE_MACH_ABSOLUTE_TIME</span>   0x33       <span class="enscript-comment">/* uint64_t */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCDATA_TYPE_TIMEVAL</span>              0x34       <span class="enscript-comment">/* struct timeval64 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCDATA_TYPE_USECS_SINCE_EPOCH</span>    0x35       <span class="enscript-comment">/* time in usecs uint64_t */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCDATA_TYPE_BUFFER_END</span>      0xF19158ED

<span class="enscript-comment">/* MAGIC numbers defined for each class of chunked data */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCDATA_BUFFER_BEGIN_CRASHINFO</span>  0xDEADF157   <span class="enscript-comment">/* owner: corpses/task_corpse.h */</span>
						    <span class="enscript-comment">/* type-range: 0x800 - 0x8ff */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCDATA_BUFFER_BEGIN_STACKSHOT</span>  0x59a25807   <span class="enscript-comment">/* owner: sys/stackshot.h */</span>
						    <span class="enscript-comment">/* type-range: 0x900 - 0x9ff */</span>

<span class="enscript-comment">/* next type range number available 0x1000 */</span>

<span class="enscript-comment">/* Common MACROS and library functions */</span>
<span class="enscript-comment">/* make header = sizeof(type, flags, size) */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCDATA_ITEM_HEADER_SIZE</span>         (sizeof(uint32_t) + sizeof(uint32_t) + sizeof(uint64_t))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">KCDATA_ITEM_TYPE</span>(item)          (((kcdata_item_t)(item))-&gt;type)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">KCDATA_ITEM_SIZE</span>(item)          (((kcdata_item_t)(item))-&gt;size)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">KCDATA_ITEM_FLAGS</span>(item)          (((kcdata_item_t)(item))-&gt;flags)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">KCDATA_ITEM_ARRAY_GET_EL_TYPE</span>(item)   ((KCDATA_ITEM_FLAGS(item) &gt;&gt; 32) &amp; UINT32_MAX)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">KCDATA_ITEM_ARRAY_GET_EL_COUNT</span>(item)  (KCDATA_ITEM_FLAGS(item) &amp; UINT32_MAX)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">KCDATA_ITEM_ARRAY_GET_EL_SIZE</span>(item)   (KCDATA_ITEM_SIZE(item) / KCDATA_ITEM_ARRAY_GET_EL_COUNT(item))

#<span class="enscript-reference">define</span> <span class="enscript-function-name">KCDATA_CONTAINER_ID</span>(item)             ((uint64_t)KCDATA_ITEM_FLAGS(item))

#<span class="enscript-reference">define</span> <span class="enscript-function-name">KCDATA_ITEM_NEXT_HEADER</span>(item)   ((kcdata_item_t)((uint64_t)((uintptr_t)(item)) + KCDATA_ITEM_HEADER_SIZE + KCDATA_ITEM_SIZE(item)))

#<span class="enscript-reference">define</span> <span class="enscript-function-name">KCDATA_ITEM_FOREACH</span>(head) for (; KCDATA_ITEM_TYPE(head) != KCDATA_TYPE_BUFFER_END; (head) = KCDATA_ITEM_NEXT_HEADER(head))

<span class="enscript-type">static</span> inline kcdata_item_t
<span class="enscript-function-name">KCDATA_ITEM_FIND_TYPE</span>(kcdata_item_t head, uint32_t type)
{
	KCDATA_ITEM_FOREACH(head)
	{
		<span class="enscript-keyword">if</span> (KCDATA_ITEM_TYPE(head) == type) {
			<span class="enscript-keyword">break</span>;
		}
	}
	<span class="enscript-keyword">return</span> (KCDATA_ITEM_TYPE(head) == type) ? (kcdata_item_t)head : 0;
}

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">KERNEL</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">KCDATA_ITEM_DATA_PTR</span>(item)      (&amp;((kcdata_item_t)(item))-&gt;data)

<span class="enscript-type">static</span> inline uint32_t <span class="enscript-function-name">kcdata_get_container_type</span>(kcdata_item_t buffer) {
	<span class="enscript-keyword">if</span> (KCDATA_ITEM_TYPE(buffer) == KCDATA_TYPE_CONTAINER_BEGIN)
		<span class="enscript-keyword">return</span> *(uint32_t *)KCDATA_ITEM_DATA_PTR(buffer);
	<span class="enscript-keyword">return</span> 0;
}

<span class="enscript-type">static</span> inline <span class="enscript-type">void</span> <span class="enscript-function-name">kcdata_get_data_with_desc</span>(kcdata_item_t buffer, <span class="enscript-type">char</span> **desc_ptr, <span class="enscript-type">void</span> **data_ptr) {
	<span class="enscript-keyword">if</span> (desc_ptr)
		*desc_ptr = (<span class="enscript-type">char</span> *)KCDATA_ITEM_DATA_PTR(buffer);
	<span class="enscript-keyword">if</span> (data_ptr)
		*data_ptr = (<span class="enscript-type">void</span> *)((uintptr_t)KCDATA_ITEM_DATA_PTR(buffer) + KCDATA_DESC_MAXLEN);
}
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL */</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">XNU_KERNEL_PRIVATE</span>

<span class="enscript-comment">/* Structure to save information about corpse data */</span>
<span class="enscript-type">struct</span> kcdata_descriptor {
	uint32_t            kcd_length;
	uint32_t            kcd_flags;
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCFLAG_USE_MEMCOPY</span>  0x0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KCFLAG_USE_COPYOUT</span>  0x1
	mach_vm_address_t   kcd_addr_begin;
	mach_vm_address_t   kcd_addr_end;
};

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> kcdata_descriptor * kcdata_descriptor_t;

kcdata_descriptor_t <span class="enscript-function-name">kcdata_memory_alloc_init</span>(mach_vm_address_t crash_data_p, <span class="enscript-type">unsigned</span> data_type, <span class="enscript-type">unsigned</span> size, <span class="enscript-type">unsigned</span> flags);
kern_return_t <span class="enscript-function-name">kcdata_memory_static_init</span>(kcdata_descriptor_t data, mach_vm_address_t buffer_addr_p, <span class="enscript-type">unsigned</span> data_type, <span class="enscript-type">unsigned</span> size, <span class="enscript-type">unsigned</span> flags);
kern_return_t <span class="enscript-function-name">kcdata_memory_destroy</span>(kcdata_descriptor_t data);
uint64_t <span class="enscript-function-name">kcdata_memory_get_used_bytes</span>(kcdata_descriptor_t kcd);
kern_return_t <span class="enscript-function-name">kcdata_memcpy</span>(kcdata_descriptor_t data, mach_vm_address_t dst_addr, <span class="enscript-type">void</span> *src_addr, uint32_t size);

kern_return_t <span class="enscript-function-name">kcdata_get_memory_addr</span>(kcdata_descriptor_t data, uint32_t type, uint32_t size, mach_vm_address_t *user_addr);
kern_return_t <span class="enscript-function-name">kcdata_get_memory_addr_for_array</span>(kcdata_descriptor_t data, uint32_t type_of_element, uint32_t size_of_element, uint32_t count, mach_vm_address_t *user_addr);
kern_return_t <span class="enscript-function-name">kcdata_add_container_marker</span>(kcdata_descriptor_t data, uint32_t header_type, uint32_t container_type, uint64_t identifier);
kern_return_t <span class="enscript-function-name">kcdata_add_type_definition</span>(kcdata_descriptor_t data, uint32_t type_id, <span class="enscript-type">char</span> *type_name, <span class="enscript-type">struct</span> kcdata_subtype_descriptor *elements_array_addr, uint32_t elements_count);


kern_return_t <span class="enscript-function-name">kcdata_add_uint64_with_description</span>(kcdata_descriptor_t crashinfo, uint64_t data, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *description);
kern_return_t <span class="enscript-function-name">kcdata_add_uint32_with_description</span>(kcdata_descriptor_t crashinfo, uint32_t data, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *description);

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* XNU_KERNEL_PRIVATE */</span>

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* _KERN_CDATA_H_ */</span>
</pre>
<hr />
</body></html>