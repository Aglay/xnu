<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>startup.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">startup.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000-2010 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*
 * @OSF_COPYRIGHT@
 */</span>
<span class="enscript-comment">/* 
 * Mach Operating System
 * Copyright (c) 1991,1990,1989,1988 Carnegie Mellon University
 * All Rights Reserved.
 * 
 * Permission to use, copy, modify and distribute this software and its
 * documentation is hereby granted, provided that both the copyright
 * notice and this permission notice appear in all copies of the
 * software, derivative works or modified versions, and any portions
 * thereof, and that both notices appear in supporting documentation.
 * 
 * CARNEGIE MELLON ALLOWS FREE USE OF THIS SOFTWARE IN ITS &quot;AS IS&quot;
 * CONDITION.  CARNEGIE MELLON DISCLAIMS ANY LIABILITY OF ANY KIND FOR
 * ANY DAMAGES WHATSOEVER RESULTING FROM THE USE OF THIS SOFTWARE.
 * 
 * Carnegie Mellon requests users of this software to return to
 * 
 *  Software Distribution Coordinator  or  <a href="mailto:Software.Distribution@CS.CMU.EDU">Software.Distribution@CS.CMU.EDU</a>
 *  School of Computer Science
 *  Carnegie Mellon University
 *  Pittsburgh PA 15213-3890
 * 
 * any improvements or extensions that they make and grant Carnegie Mellon
 * the rights to redistribute these changes.
 */</span>
<span class="enscript-comment">/*
 * NOTICE: This file was modified by McAfee Research in 2004 to introduce
 * support for mandatory and extensible security protections.  This notice
 * is included in support of clause 2.2 (b) of the Apple Public License,
 * Version 2.0.
 */</span>
<span class="enscript-comment">/*
 */</span>

<span class="enscript-comment">/*
 *	Mach kernel startup.
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;debug.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;xpr_debug.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach_kdp.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/boolean.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/machine.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/thread_act.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/task_special_ports.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/vm_param.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;ipc/ipc_init.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/assert.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/mach_param.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/misc_protos.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/clock.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/coalition.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/cpu_number.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/ledger.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/machine.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/processor.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/sched_prim.h&gt;</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_SCHED_SFI</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/sfi.h&gt;</span>
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/startup.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/task.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/thread.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/timer.h&gt;</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_TELEMETRY</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/telemetry.h&gt;</span>
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/xpr.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/zalloc.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/locks.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/debug.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;corpses/task_corpse.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;prng/random.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;console/serial_protos.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/vm_kern.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/vm_init.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/vm_map.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/vm_object.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/vm_page.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/vm_pageout.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/vm_shared_region.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;machine/pmap.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;machine/commpage.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/version.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/codesign.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/kdebug.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/random.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/waitq.h&gt;</span>


#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_ATM</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;atm/atm_internal.h&gt;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_CSR</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/csr.h&gt;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_BANK</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;bank/bank_internal.h&gt;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">ALTERNATE_DEBUGGER</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;arm64/alternate_debugger.h&gt;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">MACH_KDP</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kdp/kdp.h&gt;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_MACF</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;security/mac_mach_internal.h&gt;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">KPC</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/kpc.h&gt;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">KPERF</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kperf/kperf.h&gt;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">HYPERVISOR</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/hv_support.h&gt;</span>
#<span class="enscript-reference">endif</span>


#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/pmCPU.h&gt;</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span>		kernel_bootstrap_thread(<span class="enscript-type">void</span>);

<span class="enscript-type">static</span> <span class="enscript-type">void</span>		load_context(
					thread_t	thread);
#<span class="enscript-reference">if</span> (<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__i386__</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__x86_64__</span>)) &amp;&amp; <span class="enscript-variable-name">NCOPY_WINDOWS</span> &gt; 0
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">cpu_userwindow_init</span>(<span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">cpu_physwindow_init</span>(<span class="enscript-type">int</span>);
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_ECC_LOGGING</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/ecc.h&gt;</span>
#<span class="enscript-reference">endif</span> 

#<span class="enscript-reference">if</span> (<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__i386__</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__x86_64__</span>)) &amp;&amp; <span class="enscript-variable-name">CONFIG_VMX</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/vmx/vmx_cpu.h&gt;</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">// libkern/OSKextLib.cpp
</span><span class="enscript-type">extern</span> <span class="enscript-type">void</span>	OSKextRemoveKextBootstrap(<span class="enscript-type">void</span>);

<span class="enscript-type">void</span> <span class="enscript-function-name">scale_setup</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">bsd_scale_setup</span>(<span class="enscript-type">int</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> semaphore_max;
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">stackshot_lock_init</span>(<span class="enscript-type">void</span>);

<span class="enscript-comment">/*
 *	Running in virtual memory, on the interrupt stack.
 */</span>

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> serverperfmode;

<span class="enscript-comment">/* size of kernel trace buffer, disabled by default */</span>
<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> new_nkdbufs = 0;
<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> wake_nkdbufs = 0;
<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> write_trace_on_panic = 0;
<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> trace_typefilter = 0;
boolean_t    trace_serial = FALSE;

<span class="enscript-comment">/* mach leak logging */</span>
<span class="enscript-type">int</span> log_leaks = 0;
<span class="enscript-type">int</span> turn_on_log_leaks = 0;

<span class="enscript-type">static</span> inline <span class="enscript-type">void</span>
<span class="enscript-function-name">kernel_bootstrap_log</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *message)
{
<span class="enscript-comment">//	kprintf(&quot;kernel_bootstrap: %s\n&quot;, message);
</span>	kernel_debug_string_simple(message);
}

<span class="enscript-type">static</span> inline <span class="enscript-type">void</span>
<span class="enscript-function-name">kernel_bootstrap_thread_log</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *message)
{
<span class="enscript-comment">//	kprintf(&quot;kernel_bootstrap_thread: %s\n&quot;, message);
</span>	kernel_debug_string_simple(message);
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">kernel_early_bootstrap</span>(<span class="enscript-type">void</span>)
{
	<span class="enscript-comment">/* serverperfmode is needed by timer setup */</span>
        <span class="enscript-keyword">if</span> (PE_parse_boot_argn(<span class="enscript-string">&quot;serverperfmode&quot;</span>, &amp;serverperfmode, <span class="enscript-keyword">sizeof</span> (serverperfmode))) {
                serverperfmode = 1;
        }

	lck_mod_init();

	<span class="enscript-comment">/*
	 * Initialize the timer callout world
	 */</span>
	timer_call_init();

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_SCHED_SFI</span>
	<span class="enscript-comment">/*
	 * Configure SFI classes
	 */</span>
	sfi_early_init();
#<span class="enscript-reference">endif</span>
}

<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">IORamDiskBSDRoot</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">cpm_preallocate_early</span>(<span class="enscript-type">void</span>);

<span class="enscript-type">void</span>
<span class="enscript-function-name">kernel_bootstrap</span>(<span class="enscript-type">void</span>)
{
	kern_return_t	result;
	thread_t	thread;
	<span class="enscript-type">char</span>		namep[16];

	printf(<span class="enscript-string">&quot;%s\n&quot;</span>, version); <span class="enscript-comment">/* log kernel version */</span>

	<span class="enscript-keyword">if</span> (PE_parse_boot_argn(<span class="enscript-string">&quot;-l&quot;</span>, namep, <span class="enscript-keyword">sizeof</span> (namep))) <span class="enscript-comment">/* leaks logging */</span>
		turn_on_log_leaks = 1;

	PE_parse_boot_argn(<span class="enscript-string">&quot;trace&quot;</span>, &amp;new_nkdbufs, <span class="enscript-keyword">sizeof</span> (new_nkdbufs));
	PE_parse_boot_argn(<span class="enscript-string">&quot;trace_wake&quot;</span>, &amp;wake_nkdbufs, <span class="enscript-keyword">sizeof</span> (wake_nkdbufs));
	PE_parse_boot_argn(<span class="enscript-string">&quot;trace_panic&quot;</span>, &amp;write_trace_on_panic, <span class="enscript-keyword">sizeof</span>(write_trace_on_panic));
	PE_parse_boot_argn(<span class="enscript-string">&quot;trace_typefilter&quot;</span>, &amp;trace_typefilter, <span class="enscript-keyword">sizeof</span>(trace_typefilter));

	scale_setup();

	kernel_bootstrap_log(<span class="enscript-string">&quot;vm_mem_bootstrap&quot;</span>);
	vm_mem_bootstrap();

	kernel_bootstrap_log(<span class="enscript-string">&quot;cs_init&quot;</span>);
	cs_init();

	kernel_bootstrap_log(<span class="enscript-string">&quot;vm_mem_init&quot;</span>);
	vm_mem_init();

	machine_info.memory_size = (uint32_t)mem_size;
	machine_info.max_mem = max_mem;
	machine_info.major_version = version_major;
	machine_info.minor_version = version_minor;


#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_TELEMETRY</span>
	kernel_bootstrap_log(<span class="enscript-string">&quot;telemetry_init&quot;</span>);
	telemetry_init();
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_CSR</span>
	kernel_bootstrap_log(<span class="enscript-string">&quot;csr_init&quot;</span>);
	csr_init();
#<span class="enscript-reference">endif</span>

	kernel_bootstrap_log(<span class="enscript-string">&quot;stackshot_lock_init&quot;</span>);	
	stackshot_lock_init();

	kernel_bootstrap_log(<span class="enscript-string">&quot;sched_init&quot;</span>);
	sched_init();

	kernel_bootstrap_log(<span class="enscript-string">&quot;waitq_bootstrap&quot;</span>);
	waitq_bootstrap();

	kernel_bootstrap_log(<span class="enscript-string">&quot;ipc_bootstrap&quot;</span>);
	ipc_bootstrap();

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_MACF</span>
	kernel_bootstrap_log(<span class="enscript-string">&quot;mac_policy_init&quot;</span>);
	mac_policy_init();
#<span class="enscript-reference">endif</span>

	kernel_bootstrap_log(<span class="enscript-string">&quot;ipc_init&quot;</span>);
	ipc_init();

	<span class="enscript-comment">/*
	 * As soon as the virtual memory system is up, we record
	 * that this CPU is using the kernel pmap.
	 */</span>
	kernel_bootstrap_log(<span class="enscript-string">&quot;PMAP_ACTIVATE_KERNEL&quot;</span>);
	PMAP_ACTIVATE_KERNEL(master_cpu);

	kernel_bootstrap_log(<span class="enscript-string">&quot;mapping_free_prime&quot;</span>);
	mapping_free_prime();						<span class="enscript-comment">/* Load up with temporary mapping blocks */</span>

	kernel_bootstrap_log(<span class="enscript-string">&quot;machine_init&quot;</span>);
	machine_init();

	kernel_bootstrap_log(<span class="enscript-string">&quot;clock_init&quot;</span>);
	clock_init();

	ledger_init();

	<span class="enscript-comment">/*
	 *	Initialize the IPC, task, and thread subsystems.
	 */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_COALITIONS</span>
	kernel_bootstrap_log(<span class="enscript-string">&quot;coalitions_init&quot;</span>);
	coalitions_init();
#<span class="enscript-reference">endif</span>

	kernel_bootstrap_log(<span class="enscript-string">&quot;task_init&quot;</span>);
	task_init();

	kernel_bootstrap_log(<span class="enscript-string">&quot;thread_init&quot;</span>);
	thread_init();

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_ATM</span>
	<span class="enscript-comment">/* Initialize the Activity Trace Resource Manager. */</span>
	kernel_bootstrap_log(<span class="enscript-string">&quot;atm_init&quot;</span>);
	atm_init();
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_BANK</span>
	<span class="enscript-comment">/* Initialize the BANK Manager. */</span>
	kernel_bootstrap_log(<span class="enscript-string">&quot;bank_init&quot;</span>);
	bank_init();
#<span class="enscript-reference">endif</span>
	
	<span class="enscript-comment">/* initialize the corpse config based on boot-args */</span>
	corpses_init();

	<span class="enscript-comment">/*
	 *	Create a kernel thread to execute the kernel bootstrap.
	 */</span>
	kernel_bootstrap_log(<span class="enscript-string">&quot;kernel_thread_create&quot;</span>);
	result = kernel_thread_create((thread_continue_t)kernel_bootstrap_thread, NULL, MAXPRI_KERNEL, &amp;thread);

	<span class="enscript-keyword">if</span> (result != KERN_SUCCESS) panic(<span class="enscript-string">&quot;kernel_bootstrap: result = %08X\n&quot;</span>, result);

	thread-&gt;state = TH_RUN;
	thread-&gt;last_made_runnable_time = mach_absolute_time();
	thread_deallocate(thread);

	kernel_bootstrap_log(<span class="enscript-string">&quot;load_context - done&quot;</span>);
	load_context(thread);
	<span class="enscript-comment">/*NOTREACHED*/</span>
}

<span class="enscript-type">int</span> kth_started = 0;

vm_offset_t vm_kernel_addrperm;
vm_offset_t buf_kernel_addrperm;
vm_offset_t vm_kernel_addrperm_ext;

<span class="enscript-comment">/*
 * Now running in a thread.  Kick off other services,
 * invoke user bootstrap, enter pageout loop.
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">kernel_bootstrap_thread</span>(<span class="enscript-type">void</span>)
{
	processor_t		processor = current_processor();

#<span class="enscript-reference">define</span> <span class="enscript-function-name">kernel_bootstrap_thread_kprintf</span>(x...) <span class="enscript-comment">/* kprintf(&quot;kernel_bootstrap_thread: &quot; x) */</span>
	kernel_bootstrap_thread_log(<span class="enscript-string">&quot;idle_thread_create&quot;</span>);
	<span class="enscript-comment">/*
	 * Create the idle processor thread.
	 */</span>
	idle_thread_create(processor);

	<span class="enscript-comment">/*
	 * N.B. Do not stick anything else
	 * before this point.
	 *
	 * Start up the scheduler services.
	 */</span>
	kernel_bootstrap_thread_log(<span class="enscript-string">&quot;sched_startup&quot;</span>);
	sched_startup();

	<span class="enscript-comment">/*
	 * Thread lifecycle maintenance (teardown, stack allocation)
	 */</span>
	kernel_bootstrap_thread_log(<span class="enscript-string">&quot;thread_daemon_init&quot;</span>);
	thread_daemon_init();

	<span class="enscript-comment">/* Create kernel map entry reserve */</span>
	vm_kernel_reserved_entry_init();

	<span class="enscript-comment">/*
	 * Thread callout service.
	 */</span>
	kernel_bootstrap_thread_log(<span class="enscript-string">&quot;thread_call_initialize&quot;</span>);
	thread_call_initialize();

	<span class="enscript-comment">/*
	 * Remain on current processor as
	 * additional processors come online.
	 */</span>
	kernel_bootstrap_thread_log(<span class="enscript-string">&quot;thread_bind&quot;</span>);
	thread_bind(processor);

	<span class="enscript-comment">/*
	 * Initialize ipc thread call support.
	 */</span>
	kernel_bootstrap_thread_log(<span class="enscript-string">&quot;ipc_thread_call_init&quot;</span>);
	ipc_thread_call_init();

	<span class="enscript-comment">/*
	 * Kick off memory mapping adjustments.
	 */</span>
	kernel_bootstrap_thread_log(<span class="enscript-string">&quot;mapping_adjust&quot;</span>);
	mapping_adjust();

	<span class="enscript-comment">/*
	 *	Create the clock service.
	 */</span>
	kernel_bootstrap_thread_log(<span class="enscript-string">&quot;clock_service_create&quot;</span>);
	clock_service_create();

	<span class="enscript-comment">/*
	 *	Create the device service.
	 */</span>
	device_service_create();

	kth_started = 1;
		
#<span class="enscript-reference">if</span> (<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__i386__</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__x86_64__</span>)) &amp;&amp; <span class="enscript-variable-name">NCOPY_WINDOWS</span> &gt; 0
	<span class="enscript-comment">/*
	 * Create and initialize the physical copy window for processor 0
	 * This is required before starting kicking off  IOKit.
	 */</span>
	cpu_physwindow_init(0);
#<span class="enscript-reference">endif</span>


	
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">MACH_KDP</span> 
	kernel_bootstrap_log(<span class="enscript-string">&quot;kdp_init&quot;</span>);
	kdp_init();
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">ALTERNATE_DEBUGGER</span>
	alternate_debugger_init();
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">KPC</span>
	kpc_init();
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_ECC_LOGGING</span>
	ecc_log_init();
#<span class="enscript-reference">endif</span> 

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">KPERF</span>
	kperf_bootstrap();
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">HYPERVISOR</span>
	hv_support_init();
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_TELEMETRY</span>
	kernel_bootstrap_log(<span class="enscript-string">&quot;bootprofile_init&quot;</span>);
	bootprofile_init();
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> (<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__i386__</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__x86_64__</span>)) &amp;&amp; <span class="enscript-variable-name">CONFIG_VMX</span>
	vmx_init();
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> (<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__i386__</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__x86_64__</span>))
	<span class="enscript-keyword">if</span> (kdebug_serial) {
		new_nkdbufs = 1;
		<span class="enscript-keyword">if</span> (trace_typefilter == 0)
			trace_typefilter = 1;
	}
	<span class="enscript-keyword">if</span> (turn_on_log_leaks &amp;&amp; !new_nkdbufs)
		new_nkdbufs = 200000;
	<span class="enscript-keyword">if</span> (trace_typefilter)
		start_kern_tracing_with_typefilter(new_nkdbufs,
						   FALSE,
						   trace_typefilter);
	<span class="enscript-keyword">else</span>
		start_kern_tracing(new_nkdbufs, FALSE);
	<span class="enscript-keyword">if</span> (turn_on_log_leaks)
		log_leaks = 1;

#<span class="enscript-reference">endif</span>

	kernel_bootstrap_log(<span class="enscript-string">&quot;prng_init&quot;</span>);
	prng_cpu_init(master_cpu);

#<span class="enscript-reference">ifdef</span>	<span class="enscript-variable-name">IOKIT</span>
	PE_init_iokit();
#<span class="enscript-reference">endif</span>

	assert(ml_get_interrupts_enabled() == FALSE);
	(<span class="enscript-type">void</span>) spllo();		<span class="enscript-comment">/* Allow interruptions */</span>

#<span class="enscript-reference">if</span> (<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__i386__</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__x86_64__</span>)) &amp;&amp; <span class="enscript-variable-name">NCOPY_WINDOWS</span> &gt; 0
	<span class="enscript-comment">/*
	 * Create and initialize the copy window for processor 0
	 * This also allocates window space for all other processors.
	 * However, this is dependent on the number of processors - so this call
	 * must be after IOKit has been started because IOKit performs processor
	 * discovery.
	 */</span>
	cpu_userwindow_init(0);
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> (!<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__i386__</span>) &amp;&amp; !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__x86_64__</span>))
	<span class="enscript-keyword">if</span> (turn_on_log_leaks &amp;&amp; !new_nkdbufs)
		new_nkdbufs = 200000;
	<span class="enscript-keyword">if</span> (trace_typefilter)
		start_kern_tracing_with_typefilter(new_nkdbufs, FALSE, trace_typefilter);
	<span class="enscript-keyword">else</span>
		start_kern_tracing(new_nkdbufs, FALSE);
	<span class="enscript-keyword">if</span> (turn_on_log_leaks)
		log_leaks = 1;
#<span class="enscript-reference">endif</span>

	<span class="enscript-comment">/*
	 *	Initialize the shared region module.
	 */</span>
	vm_shared_region_init();
	vm_commpage_init();
	vm_commpage_text_init();


#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_MACF</span>
	kernel_bootstrap_log(<span class="enscript-string">&quot;mac_policy_initmach&quot;</span>);
	mac_policy_initmach();
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_SCHED_SFI</span>
	kernel_bootstrap_log(<span class="enscript-string">&quot;sfi_init&quot;</span>);
	sfi_init();
#<span class="enscript-reference">endif</span>

	<span class="enscript-comment">/*
	 * Initialize the globals used for permuting kernel
	 * addresses that may be exported to userland as tokens
	 * using VM_KERNEL_ADDRPERM()/VM_KERNEL_ADDRPERM_EXTERNAL().
	 * Force the random number to be odd to avoid mapping a non-zero
	 * word-aligned address to zero via addition.
	 * Note: at this stage we can use the cryptographically secure PRNG
	 * rather than early_random().
	 */</span>
	read_random(&amp;vm_kernel_addrperm, <span class="enscript-keyword">sizeof</span>(vm_kernel_addrperm));
	vm_kernel_addrperm |= 1;
	read_random(&amp;buf_kernel_addrperm, <span class="enscript-keyword">sizeof</span>(buf_kernel_addrperm));
	buf_kernel_addrperm |= 1;
	read_random(&amp;vm_kernel_addrperm_ext, <span class="enscript-keyword">sizeof</span>(vm_kernel_addrperm_ext));
	vm_kernel_addrperm_ext |= 1;

	vm_set_restrictions();



	<span class="enscript-comment">/*
	 *	Start the user bootstrap.
	 */</span>
#<span class="enscript-reference">ifdef</span>	<span class="enscript-variable-name">MACH_BSD</span>
	bsd_init();
#<span class="enscript-reference">endif</span>

    <span class="enscript-comment">/*
     * Get rid of segments used to bootstrap kext loading. This removes
     * the KLD, PRELINK symtab, LINKEDIT, and symtab segments/load commands.
     */</span>
	OSKextRemoveKextBootstrap();

	serial_keyboard_init();		<span class="enscript-comment">/* Start serial keyboard if wanted */</span>

	vm_page_init_local_q();

	thread_bind(PROCESSOR_NULL);

	<span class="enscript-comment">/*
	 *	Become the pageout daemon.
	 */</span>
	vm_pageout();
	<span class="enscript-comment">/*NOTREACHED*/</span>
}

<span class="enscript-comment">/*
 *	slave_main:
 *
 *	Load the first thread to start a processor.
 */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">slave_main</span>(<span class="enscript-type">void</span> *machine_param)
{
	processor_t		processor = current_processor();
	thread_t		thread;

	<span class="enscript-comment">/*
	 *	Use the idle processor thread if there
	 *	is no dedicated start up thread.
	 */</span>
	<span class="enscript-keyword">if</span> (processor-&gt;next_thread == THREAD_NULL) {
		thread = processor-&gt;idle_thread;
		thread-&gt;continuation = (thread_continue_t)processor_start_thread;
		thread-&gt;parameter = machine_param;
	}
	<span class="enscript-keyword">else</span> {
		thread = processor-&gt;next_thread;
		processor-&gt;next_thread = THREAD_NULL;
	}

	load_context(thread);
	<span class="enscript-comment">/*NOTREACHED*/</span>
}

<span class="enscript-comment">/*
 *	processor_start_thread:
 *
 *	First thread to execute on a started processor.
 *
 *	Called at splsched.
 */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">processor_start_thread</span>(<span class="enscript-type">void</span> *machine_param)
{
	processor_t		processor = current_processor();
	thread_t		self = current_thread();

	slave_machine_init(machine_param);

	<span class="enscript-comment">/*
	 *	If running the idle processor thread,
	 *	reenter the idle loop, else terminate.
	 */</span>
	<span class="enscript-keyword">if</span> (self == processor-&gt;idle_thread)
		thread_block((thread_continue_t)idle_thread);

	thread_terminate(self);
	<span class="enscript-comment">/*NOTREACHED*/</span>
}

<span class="enscript-comment">/*
 *	load_context:
 *
 *	Start the first thread on a processor.
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">load_context</span>(
	thread_t		thread)
{
	processor_t		processor = current_processor();


#<span class="enscript-reference">define</span> <span class="enscript-function-name">load_context_kprintf</span>(x...) <span class="enscript-comment">/* kprintf(&quot;load_context: &quot; x) */</span>

	load_context_kprintf(<span class="enscript-string">&quot;machine_set_current_thread\n&quot;</span>);
	machine_set_current_thread(thread);

	load_context_kprintf(<span class="enscript-string">&quot;processor_up\n&quot;</span>);
	processor_up(processor);

	PMAP_ACTIVATE_KERNEL(processor-&gt;cpu_id);

	<span class="enscript-comment">/*
	 * Acquire a stack if none attached.  The panic
	 * should never occur since the thread is expected
	 * to have reserved stack.
	 */</span>
	load_context_kprintf(<span class="enscript-string">&quot;thread %p, stack %lx, stackptr %lx\n&quot;</span>, thread,
			     thread-&gt;kernel_stack, thread-&gt;machine.kstackptr);
	<span class="enscript-keyword">if</span> (!thread-&gt;kernel_stack) {
		load_context_kprintf(<span class="enscript-string">&quot;stack_alloc_try\n&quot;</span>);
		<span class="enscript-keyword">if</span> (!stack_alloc_try(thread))
			panic(<span class="enscript-string">&quot;load_context&quot;</span>);
	}

	<span class="enscript-comment">/*
	 * The idle processor threads are not counted as
	 * running for load calculations.
	 */</span>
	<span class="enscript-keyword">if</span> (!(thread-&gt;state &amp; TH_IDLE))
		sched_run_incr(thread);

	processor-&gt;active_thread = thread;
	processor-&gt;current_pri = thread-&gt;sched_pri;
	processor-&gt;current_thmode = thread-&gt;sched_mode;
	processor-&gt;deadline = UINT64_MAX;
	thread-&gt;last_processor = processor;

	processor-&gt;last_dispatch = mach_absolute_time();
	timer_start(&amp;thread-&gt;system_timer, processor-&gt;last_dispatch);
	PROCESSOR_DATA(processor, thread_timer) = PROCESSOR_DATA(processor, kernel_timer) = &amp;thread-&gt;system_timer;

	timer_start(&amp;PROCESSOR_DATA(processor, system_state), processor-&gt;last_dispatch);
	PROCESSOR_DATA(processor, current_state) = &amp;PROCESSOR_DATA(processor, system_state);

	PMAP_ACTIVATE_USER(thread, processor-&gt;cpu_id);

	load_context_kprintf(<span class="enscript-string">&quot;machine_load_context\n&quot;</span>);
	machine_load_context(thread);
	<span class="enscript-comment">/*NOTREACHED*/</span>
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">scale_setup</span>()
{
	<span class="enscript-type">int</span> scale = 0;
#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__LP64__</span>)
	typeof(task_max) task_max_base = task_max;

	<span class="enscript-comment">/* Raise limits for servers with &gt;= 16G */</span>
	<span class="enscript-keyword">if</span> ((serverperfmode != 0) &amp;&amp; ((uint64_t)sane_size &gt;= (uint64_t)(16 * 1024 * 1024 *1024ULL))) {
		scale = (<span class="enscript-type">int</span>)((uint64_t)sane_size / (uint64_t)(8 * 1024 * 1024 *1024ULL));
		<span class="enscript-comment">/* limit to 128 G */</span>
		<span class="enscript-keyword">if</span> (scale &gt; 16)
			scale = 16;
		task_max_base = 2500;
	} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> ((uint64_t)sane_size &gt;= (uint64_t)(3 * 1024 * 1024 *1024ULL))
		scale = 2;

	task_max = MAX(task_max, task_max_base * scale);

	<span class="enscript-keyword">if</span> (scale != 0) {
		task_threadmax = task_max;
		thread_max = task_max * 5; 
	}

#<span class="enscript-reference">endif</span>

	bsd_scale_setup(scale);
	
	ipc_space_max = SPACE_MAX;
	ipc_port_max = PORT_MAX;
	ipc_pset_max = SET_MAX;
	semaphore_max = SEMAPHORE_MAX;
}

</pre>
<hr />
</body></html>