<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>waitq.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">waitq.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_WAITQ_H_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_WAITQ_H_</span>
<span class="enscript-comment">/*
 * Copyright (c) 2014-2015 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 *
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 *
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 *
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
#<span class="enscript-reference">ifdef</span>	<span class="enscript-variable-name">KERNEL_PRIVATE</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/mach_types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/sync_policy.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/kern_return.h&gt;</span>		<span class="enscript-comment">/* for kern_return_t */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/kern_types.h&gt;</span>		<span class="enscript-comment">/* for wait_queue_t */</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/queue.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/assert.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/cdefs.h&gt;</span>

<span class="enscript-comment">/*
 * Constants and types used in the waitq APIs
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">WAITQ_ALL_PRIORITIES</span>   (-1)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">WAITQ_PROMOTE_PRIORITY</span> (-2)

<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> e_waitq_lock_state {
	WAITQ_KEEP_LOCKED    = 0x01,
	WAITQ_UNLOCK         = 0x02,
	WAITQ_SHOULD_LOCK    = 0x04,
	WAITQ_ALREADY_LOCKED = 0x08,
	WAITQ_DONT_LOCK      = 0x10,
} waitq_lock_state_t;

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">MACH_KERNEL_PRIVATE</span>

<span class="enscript-comment">/*
 * The opaque waitq structure is here mostly for AIO and selinfo,
 * but could potentially be used by other BSD subsystems.
 */</span>
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">__LP64__</span>
	<span class="enscript-type">struct</span> waitq { <span class="enscript-type">char</span> opaque[32]; };
	<span class="enscript-type">struct</span> waitq_set { <span class="enscript-type">char</span> opaque[48]; };
#<span class="enscript-reference">else</span>
	#<span class="enscript-keyword">if</span> defined(__x86_64__)
		<span class="enscript-type">struct</span> waitq { <span class="enscript-type">char</span> opaque[48]; };
		<span class="enscript-type">struct</span> waitq_set { <span class="enscript-type">char</span> opaque[64]; };
	#<span class="enscript-keyword">else</span>
		<span class="enscript-type">struct</span> waitq { <span class="enscript-type">char</span> opaque[40]; };
		<span class="enscript-type">struct</span> waitq_set { <span class="enscript-type">char</span> opaque[56]; };
	#endif <span class="enscript-comment">/* !x86_64 */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* __LP64__ */</span>

#<span class="enscript-reference">else</span> <span class="enscript-comment">/* MACH_KERNEL_PRIVATE */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/spl.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/simple_lock.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/branch_predicates.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;machine/cpu_number.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;machine/machine_routines.h&gt;</span> <span class="enscript-comment">/* machine_timeout_suspended() */</span>

<span class="enscript-comment">/*
 * The event mask is of 59 bits on 64 bit architeture and 27 bits on
 * 32 bit architecture and so we calculate its size using sizeof(long).
 * If the bitfield for wq_type and wq_fifo is changed, then value of
 * EVENT_MASK_BITS will also change.
 *
 * New plan: this is an optimization anyway, so I'm stealing 32bits
 * from the mask to shrink the waitq object even further.
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_EVENT_MASK_BITS</span>   ((sizeof(uint32_t) * 8) - 5)

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">WAITQ_BOOST_PRIORITY</span> 31

<span class="enscript-type">enum</span> waitq_type {
	WQT_INVALID = 0,
	WQT_QUEUE   = 0x2,
	WQT_SET     = 0x3,
};

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_WAITQ_STATS</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">NWAITQ_BTFRAMES</span> 5
<span class="enscript-type">struct</span> wq_stats {
	uint64_t waits;
	uint64_t wakeups;
	uint64_t clears;
	uint64_t failed_wakeups;

	uintptr_t last_wait[NWAITQ_BTFRAMES];
	uintptr_t last_wakeup[NWAITQ_BTFRAMES];
	uintptr_t last_failed_wakeup[NWAITQ_BTFRAMES];
};
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">/*
 *	struct waitq
 *
 *	This is the definition of the common event wait queue
 *	that the scheduler APIs understand.  It is used
 *	internally by the gerneralized event waiting mechanism
 *	(assert_wait), and also for items that maintain their
 *	own wait queues (such as ports and semaphores).
 *
 *	It is not published to other kernel components.
 *
 *	NOTE:  Hardware locks are used to protect event wait
 *	queues since interrupt code is free to post events to
 *	them.
 */</span>
<span class="enscript-type">struct</span> waitq {
	uint32_t <span class="enscript-comment">/* flags */</span>
		<span class="enscript-reference">waitq_type</span>:2,    <span class="enscript-comment">/* only public field */</span>
		<span class="enscript-reference">waitq_fifo</span>:1,    <span class="enscript-comment">/* fifo wakeup policy? */</span>
		<span class="enscript-reference">waitq_prepost</span>:1, <span class="enscript-comment">/* waitq supports prepost? */</span>
		<span class="enscript-reference">waitq_irq</span>:1,     <span class="enscript-comment">/* waitq requires interrupts disabled */</span>
		<span class="enscript-reference">waitq_eventmask</span>:_EVENT_MASK_BITS;
		<span class="enscript-comment">/* the wait queue set (set-of-sets) to which this queue belongs */</span>
	hw_lock_data_t	waitq_interlock;	<span class="enscript-comment">/* interlock */</span>

	uint64_t waitq_set_id;
	uint64_t waitq_prepost_id;
	queue_head_t	waitq_queue;		<span class="enscript-comment">/* queue of elements */</span>
};

<span class="enscript-comment">/*
 *	struct waitq_set
 *
 *	This is the common definition for a set wait queue.
 */</span>
<span class="enscript-type">struct</span> waitq_set {
	<span class="enscript-type">struct</span> waitq wqset_q;
	uint64_t     wqset_id;
	uint64_t     wqset_prepost_id;
};

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">waitq_bootstrap</span>(<span class="enscript-type">void</span>);

#<span class="enscript-reference">define</span> <span class="enscript-function-name">waitq_is_queue</span>(wq) \
	((wq)-&gt;waitq_type == WQT_QUEUE)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">waitq_is_set</span>(wq) \
	((wq)-&gt;waitq_type == WQT_SET &amp;&amp; ((<span class="enscript-type">struct</span> waitq_set *)(wq))-&gt;wqset_id != 0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">waitqs_is_set</span>(wqs) \
	(((wqs)-&gt;wqset_q.waitq_type == WQT_SET) &amp;&amp; ((wqs)-&gt;wqset_id != 0))

#<span class="enscript-reference">define</span> <span class="enscript-function-name">waitq_valid</span>(wq) \
	((wq) != NULL &amp;&amp; ((wq)-&gt;waitq_type &amp; ~1) == WQT_QUEUE)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">waitq_empty</span>(wq) \
	(queue_empty(&amp;(wq)-&gt;waitq_queue))

#<span class="enscript-reference">define</span> <span class="enscript-function-name">waitq_held</span>(wq) \
	(hw_lock_held(&amp;(wq)-&gt;waitq_interlock))

#<span class="enscript-reference">define</span> <span class="enscript-function-name">waitq_lock_try</span>(wq) \
	(hw_lock_try(&amp;(wq)-&gt;waitq_interlock))

#<span class="enscript-reference">define</span> <span class="enscript-function-name">waitq_wait_possible</span>(thread) \
	((thread)-&gt;waitq == NULL)

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">waitq_lock</span>(<span class="enscript-type">struct</span> waitq *wq);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">waitq_unlock</span>(<span class="enscript-type">struct</span> waitq *wq);

#<span class="enscript-reference">define</span> <span class="enscript-function-name">waitq_set_lock</span>(wqs)		waitq_lock(&amp;(wqs)-&gt;wqset_q)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">waitq_set_unlock</span>(wqs)		waitq_unlock(&amp;(wqs)-&gt;wqset_q)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">waitq_set_lock_try</span>(wqs)		waitq_lock_try(&amp;(wqs)-&gt;wqset_q)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">waitq_set_can_prepost</span>(wqs)	(waitqs_is_set(wqs) &amp;&amp; \
					 (wqs)-&gt;wqset_q.waitq_prepost)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">waitq_set_maybe_preposted</span>(wqs)	((wqs)-&gt;wqset_q.waitq_prepost &amp;&amp; \
					 (wqs)-&gt;wqset_prepost_id &gt; 0)

<span class="enscript-comment">/* assert intent to wait on a locked wait queue */</span>
<span class="enscript-type">extern</span> wait_result_t <span class="enscript-function-name">waitq_assert_wait64_locked</span>(<span class="enscript-type">struct</span> waitq *waitq,
						event64_t wait_event,
						wait_interrupt_t interruptible,
						wait_timeout_urgency_t urgency,
						uint64_t deadline,
						uint64_t leeway,
						thread_t thread);

<span class="enscript-comment">/* pull a thread from its wait queue */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">waitq_pull_thread_locked</span>(<span class="enscript-type">struct</span> waitq *waitq, thread_t thread);

<span class="enscript-comment">/* wakeup all threads waiting for a particular event on locked queue */</span>
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">waitq_wakeup64_all_locked</span>(<span class="enscript-type">struct</span> waitq *waitq,
					       event64_t wake_event,
					       wait_result_t result,
					       uint64_t *reserved_preposts,
					       <span class="enscript-type">int</span> priority,
					       waitq_lock_state_t lock_state);

<span class="enscript-comment">/* wakeup one thread waiting for a particular event on locked queue */</span>
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">waitq_wakeup64_one_locked</span>(<span class="enscript-type">struct</span> waitq *waitq,
					       event64_t wake_event,
					       wait_result_t result,
					       uint64_t *reserved_preposts,
					       <span class="enscript-type">int</span> priority,
					       waitq_lock_state_t lock_state);

<span class="enscript-comment">/* return identity of a thread awakened for a particular &lt;wait_queue,event&gt; */</span>
<span class="enscript-type">extern</span> thread_t <span class="enscript-function-name">waitq_wakeup64_identity_locked</span>(<span class="enscript-type">struct</span> waitq *waitq,
					       event64_t wake_event,
					       wait_result_t result,
					       spl_t *spl,
					       uint64_t *reserved_preposts,
					       waitq_lock_state_t lock_state);

<span class="enscript-comment">/* wakeup thread iff its still waiting for a particular event on locked queue */</span>
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">waitq_wakeup64_thread_locked</span>(<span class="enscript-type">struct</span> waitq *waitq,
						  event64_t wake_event,
						  thread_t thread,
						  wait_result_t result,
						  waitq_lock_state_t lock_state);

<span class="enscript-comment">/* clear all preposts generated by the given waitq */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">waitq_clear_prepost_locked</span>(<span class="enscript-type">struct</span> waitq *waitq, spl_t *s);

<span class="enscript-comment">/* clear all preposts from the given wait queue set */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">waitq_set_clear_preposts_locked</span>(<span class="enscript-type">struct</span> waitq_set *wqset);

<span class="enscript-comment">/* unlink the given waitq from all sets */</span>
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">waitq_unlink_all_locked</span>(<span class="enscript-type">struct</span> waitq *waitq,
					     uint64_t *old_set_id,
					     spl_t *s,
					     <span class="enscript-type">int</span> *dropped_lock);

<span class="enscript-comment">/*
 * clear a thread's boosted priority
 * (given via WAITQ_PROMOTE_PRIORITY in the wakeup function)
 */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">waitq_clear_promotion_locked</span>(<span class="enscript-type">struct</span> waitq *waitq,
					 thread_t thread);

<span class="enscript-comment">/*
 * waitq iteration
 */</span>

<span class="enscript-type">enum</span> waitq_iteration_constant {
	WQ_ITERATE_DROPPED             = -4,
	WQ_ITERATE_INVALID             = -3,
	WQ_ITERATE_ABORTED             = -2,
	WQ_ITERATE_FAILURE             = -1,
	WQ_ITERATE_SUCCESS             =  0,
	WQ_ITERATE_CONTINUE            =  1,
	WQ_ITERATE_BREAK               =  2,
	WQ_ITERATE_BREAK_KEEP_LOCKED   =  3,
	WQ_ITERATE_INVALIDATE_CONTINUE =  4,
	WQ_ITERATE_RESTART             =  5,
	WQ_ITERATE_FOUND               =  6,
	WQ_ITERATE_UNLINKED            =  7,
};

<span class="enscript-comment">/* callback invoked with both 'waitq' and 'wqset' locked */</span>
<span class="enscript-type">typedef</span> <span class="enscript-function-name">int</span> (*waitq_iterator_t)(<span class="enscript-type">void</span> *ctx, <span class="enscript-type">struct</span> waitq *waitq,
				<span class="enscript-type">struct</span> waitq_set *wqset);

<span class="enscript-comment">/* iterate over all sets to which waitq belongs */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">waitq_iterate_sets</span>(<span class="enscript-type">struct</span> waitq *waitq, <span class="enscript-type">void</span> *ctx,
			      waitq_iterator_t it);

<span class="enscript-comment">/* iterator over all waitqs that have preposted to wqset */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">waitq_set_iterate_preposts</span>(<span class="enscript-type">struct</span> waitq_set *wqset,
				      <span class="enscript-type">void</span> *ctx, waitq_iterator_t it, spl_t *s);

<span class="enscript-comment">/*
 * prepost reservation
 */</span>
<span class="enscript-type">extern</span> uint64_t <span class="enscript-function-name">waitq_prepost_reserve</span>(<span class="enscript-type">struct</span> waitq *waitq, <span class="enscript-type">int</span> extra,
				      waitq_lock_state_t lock_state, spl_t *s);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">waitq_prepost_release_reserve</span>(uint64_t id);

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* MACH_KERNEL_PRIVATE */</span>


__BEGIN_DECLS

<span class="enscript-comment">/*
 * waitq init
 */</span>
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">waitq_init</span>(<span class="enscript-type">struct</span> waitq *waitq, <span class="enscript-type">int</span> policy);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">waitq_deinit</span>(<span class="enscript-type">struct</span> waitq *waitq);

<span class="enscript-comment">/*
 * global waitqs
 */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> waitq *<span class="enscript-function-name">_global_eventq</span>(<span class="enscript-type">char</span> *event, size_t event_length);
#<span class="enscript-reference">define</span> <span class="enscript-function-name">global_eventq</span>(event) _global_eventq((char *)&amp;(event), sizeof(event))

<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> waitq *<span class="enscript-function-name">global_waitq</span>(<span class="enscript-type">int</span> index);

<span class="enscript-comment">/*
 * set alloc/init/free
 */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> waitq_set *<span class="enscript-function-name">waitq_set_alloc</span>(<span class="enscript-type">int</span> policy);

<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">waitq_set_init</span>(<span class="enscript-type">struct</span> waitq_set *wqset,
				    <span class="enscript-type">int</span> policy, uint64_t *reserved_link);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">waitq_set_deinit</span>(<span class="enscript-type">struct</span> waitq_set *wqset);

<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">waitq_set_free</span>(<span class="enscript-type">struct</span> waitq_set *wqset);

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">DEVELOPMENT</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">DEBUG</span>)
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_WAITQ_DEBUG</span>
<span class="enscript-type">extern</span> uint64_t <span class="enscript-function-name">wqset_id</span>(<span class="enscript-type">struct</span> waitq_set *wqset);

<span class="enscript-type">struct</span> waitq *<span class="enscript-function-name">wqset_waitq</span>(<span class="enscript-type">struct</span> waitq_set *wqset);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CONFIG_WAITQ_DEBUG */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* DEVELOPMENT || DEBUG */</span>


<span class="enscript-comment">/*
 * set membership
 */</span>
<span class="enscript-type">extern</span> uint64_t <span class="enscript-function-name">waitq_link_reserve</span>(<span class="enscript-type">struct</span> waitq *waitq);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">waitq_link_release</span>(uint64_t id);

<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">waitq_member</span>(<span class="enscript-type">struct</span> waitq *waitq, <span class="enscript-type">struct</span> waitq_set *wqset);

<span class="enscript-comment">/* returns true if the waitq is in at least 1 set */</span>
<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">waitq_in_set</span>(<span class="enscript-type">struct</span> waitq *waitq);


<span class="enscript-comment">/* on success, consumes an reserved_link reference */</span>
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">waitq_link</span>(<span class="enscript-type">struct</span> waitq *waitq,
				<span class="enscript-type">struct</span> waitq_set *wqset,
				waitq_lock_state_t lock_state,
				uint64_t *reserved_link);

<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">waitq_unlink</span>(<span class="enscript-type">struct</span> waitq *waitq, <span class="enscript-type">struct</span> waitq_set *wqset);

<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">waitq_unlink_all</span>(<span class="enscript-type">struct</span> waitq *waitq);

<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">waitq_set_unlink_all</span>(<span class="enscript-type">struct</span> waitq_set *wqset);


<span class="enscript-comment">/*
 * preposts
 */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">waitq_clear_prepost</span>(<span class="enscript-type">struct</span> waitq *waitq);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">waitq_set_clear_preposts</span>(<span class="enscript-type">struct</span> waitq_set *wqset);

<span class="enscript-comment">/*
 * interfaces used primarily by the select/kqueue subsystems
 */</span>
<span class="enscript-type">extern</span> uint64_t <span class="enscript-function-name">waitq_get_prepost_id</span>(<span class="enscript-type">struct</span> waitq *waitq);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>     <span class="enscript-function-name">waitq_unlink_by_prepost_id</span>(uint64_t wqp_id, <span class="enscript-type">struct</span> waitq_set *wqset);

<span class="enscript-comment">/*
 * waitq attributes
 */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">waitq_is_valid</span>(<span class="enscript-type">struct</span> waitq *waitq);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">waitq_set_is_valid</span>(<span class="enscript-type">struct</span> waitq_set *wqset);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">waitq_is_global</span>(<span class="enscript-type">struct</span> waitq *waitq);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">waitq_irq_safe</span>(<span class="enscript-type">struct</span> waitq *waitq);

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CONFIG_WAITQ_STATS</span>
<span class="enscript-comment">/*
 * waitq statistics
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">WAITQ_STATS_VERSION</span> 1
<span class="enscript-type">struct</span> wq_table_stats {
	uint32_t version;
	uint32_t table_elements;
	uint32_t table_used_elems;
	uint32_t table_elem_sz;
	uint32_t table_slabs;
	uint32_t table_slab_sz;

	uint64_t table_num_allocs;
	uint64_t table_num_preposts;
	uint64_t table_num_reservations;

	uint64_t table_max_used;
	uint64_t table_avg_used;
	uint64_t table_max_reservations;
	uint64_t table_avg_reservations;
};

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">waitq_link_stats</span>(<span class="enscript-type">struct</span> wq_table_stats *stats);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">waitq_prepost_stats</span>(<span class="enscript-type">struct</span> wq_table_stats *stats);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CONFIG_WAITQ_STATS */</span>

<span class="enscript-comment">/*
 *
 * higher-level waiting APIs
 *
 */</span>

<span class="enscript-comment">/* assert intent to wait on &lt;waitq,event64&gt; pair */</span>
<span class="enscript-type">extern</span> wait_result_t <span class="enscript-function-name">waitq_assert_wait64</span>(<span class="enscript-type">struct</span> waitq *waitq,
					 event64_t wait_event,
					 wait_interrupt_t interruptible,
					 uint64_t deadline);

<span class="enscript-type">extern</span> wait_result_t <span class="enscript-function-name">waitq_assert_wait64_leeway</span>(<span class="enscript-type">struct</span> waitq *waitq,
						event64_t wait_event,
						wait_interrupt_t interruptible,
						wait_timeout_urgency_t urgency,
						uint64_t deadline,
						uint64_t leeway);

<span class="enscript-comment">/* wakeup the most appropriate thread waiting on &lt;waitq,event64&gt; pair */</span>
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">waitq_wakeup64_one</span>(<span class="enscript-type">struct</span> waitq *waitq,
					event64_t wake_event,
					wait_result_t result,
					<span class="enscript-type">int</span> priority);

<span class="enscript-comment">/* wakeup all the threads waiting on &lt;waitq,event64&gt; pair */</span>
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">waitq_wakeup64_all</span>(<span class="enscript-type">struct</span> waitq *waitq,
					event64_t wake_event,
					wait_result_t result,
					<span class="enscript-type">int</span> priority);

<span class="enscript-comment">/* wakeup a specified thread iff it's waiting on &lt;waitq,event64&gt; pair */</span>
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">waitq_wakeup64_thread</span>(<span class="enscript-type">struct</span> waitq *waitq,
					   event64_t wake_event,
					   thread_t thread,
					   wait_result_t result);
__END_DECLS

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* KERNEL_PRIVATE */</span>
#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* _WAITQ_H_ */</span>
</pre>
<hr />
</body></html>