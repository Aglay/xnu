<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>sched_prim.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">sched_prim.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000-2012 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*
 * @OSF_COPYRIGHT@
 */</span>
<span class="enscript-comment">/* 
 * Mach Operating System
 * Copyright (c) 1991,1990,1989,1988,1987 Carnegie Mellon University
 * All Rights Reserved.
 * 
 * Permission to use, copy, modify and distribute this software and its
 * documentation is hereby granted, provided that both the copyright
 * notice and this permission notice appear in all copies of the
 * software, derivative works or modified versions, and any portions
 * thereof, and that both notices appear in supporting documentation.
 * 
 * CARNEGIE MELLON ALLOWS FREE USE OF THIS SOFTWARE IN ITS &quot;AS IS&quot;
 * CONDITION.  CARNEGIE MELLON DISCLAIMS ANY LIABILITY OF ANY KIND FOR
 * ANY DAMAGES WHATSOEVER RESULTING FROM THE USE OF THIS SOFTWARE.
 * 
 * Carnegie Mellon requests users of this software to return to
 * 
 *  Software Distribution Coordinator  or  <a href="mailto:Software.Distribution@CS.CMU.EDU">Software.Distribution@CS.CMU.EDU</a>
 *  School of Computer Science
 *  Carnegie Mellon University
 *  Pittsburgh PA 15213-3890
 * 
 * any improvements or extensions that they make and grant Carnegie Mellon
 * the rights to redistribute these changes.
 */</span>
<span class="enscript-comment">/*
 */</span>
<span class="enscript-comment">/*
 *	File:	sched_prim.h
 *	Author:	David Golub
 *
 *	Scheduling primitive definitions file
 *
 */</span>

#<span class="enscript-reference">ifndef</span>	<span class="enscript-variable-name">_KERN_SCHED_PRIM_H_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_KERN_SCHED_PRIM_H_</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/boolean.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/machine/vm_types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/kern_return.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/clock.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/kern_types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/thread.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/cdefs.h&gt;</span>

#<span class="enscript-reference">ifdef</span>	<span class="enscript-variable-name">MACH_KERNEL_PRIVATE</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/branch_predicates.h&gt;</span>

<span class="enscript-comment">/* Initialization */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		sched_init(<span class="enscript-type">void</span>);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		sched_startup(<span class="enscript-type">void</span>);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		sched_timebase_init(<span class="enscript-type">void</span>);

<span class="enscript-comment">/* Force a preemption point for a thread and wait for it to stop running */</span>
<span class="enscript-type">extern</span> boolean_t	thread_stop( 
						thread_t	thread,
						boolean_t	until_not_runnable);

<span class="enscript-comment">/* Release a previous stop request */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>			thread_unstop(
						thread_t	thread);

<span class="enscript-comment">/* Wait for a thread to stop running */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>			thread_wait(
						thread_t	thread,
						boolean_t	until_not_runnable);

<span class="enscript-comment">/* Unblock thread on wake up */</span>
<span class="enscript-type">extern</span> boolean_t	thread_unblock(
						thread_t		thread,
						wait_result_t	wresult);

<span class="enscript-comment">/* Unblock and dispatch thread */</span>
<span class="enscript-type">extern</span> kern_return_t	thread_go(
						 	thread_t		thread,
							wait_result_t	wresult);

<span class="enscript-comment">/* Handle threads at context switch */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>			thread_dispatch(
						thread_t		old_thread,
						thread_t		new_thread);

<span class="enscript-comment">/* Switch directly to a particular thread */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>			thread_run(
						thread_t			self,
						thread_continue_t	continuation,
						<span class="enscript-type">void</span>				*parameter,
						thread_t			new_thread);

<span class="enscript-comment">/* Resume thread with new stack */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>			thread_continue(
						thread_t		old_thread);

<span class="enscript-comment">/* Invoke continuation */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		call_continuation(
					thread_continue_t	continuation,
					<span class="enscript-type">void</span>				*parameter,
					wait_result_t		wresult);

<span class="enscript-comment">/* Set the current scheduled priority */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		set_sched_pri(
					thread_t		thread,
					<span class="enscript-type">int</span>				priority);

<span class="enscript-comment">/* Set base priority of the specified thread */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		sched_set_thread_base_priority(
					thread_t		thread,
					<span class="enscript-type">int</span>				priority);

<span class="enscript-comment">/* Set the thread to be categorized as 'background' */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>             <span class="enscript-function-name">sched_set_thread_throttled</span>(thread_t thread,
                                                   boolean_t wants_throttle);

<span class="enscript-comment">/* Set the thread's true scheduling mode */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>             <span class="enscript-function-name">sched_set_thread_mode</span>(thread_t thread,
                                              sched_mode_t mode);
<span class="enscript-comment">/* Demote the true scheduler mode */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>             <span class="enscript-function-name">sched_thread_mode_demote</span>(thread_t thread,
                                                 uint32_t reason);
<span class="enscript-comment">/* Un-demote the true scheduler mode */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>             <span class="enscript-function-name">sched_thread_mode_undemote</span>(thread_t thread,
                                                   uint32_t reason);

<span class="enscript-comment">/* Re-evaluate base priority of thread (thread locked) */</span>
<span class="enscript-type">void</span> <span class="enscript-function-name">thread_recompute_priority</span>(thread_t thread);

<span class="enscript-comment">/* Re-evaluate base priority of thread (thread unlocked) */</span>
<span class="enscript-type">void</span> <span class="enscript-function-name">thread_recompute_qos</span>(thread_t thread);

<span class="enscript-comment">/* Reset scheduled priority of thread */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		thread_recompute_sched_pri(
					thread_t		thread,
					boolean_t		override_depress);

<span class="enscript-comment">/* Periodic scheduler activity */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		sched_init_thread(<span class="enscript-type">void</span> (*)(<span class="enscript-type">void</span>));

<span class="enscript-comment">/* Perform sched_tick housekeeping activities */</span>
<span class="enscript-type">extern</span> boolean_t		can_update_priority(
					thread_t		thread);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		update_priority(
											thread_t		thread);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		lightweight_update_priority(
								thread_t		thread);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>             <span class="enscript-function-name">sched_default_quantum_expire</span>(thread_t thread);

<span class="enscript-comment">/* Idle processor thread */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		idle_thread(<span class="enscript-type">void</span>);

<span class="enscript-type">extern</span> kern_return_t	idle_thread_create(
							processor_t		processor);

<span class="enscript-comment">/* Continuation return from syscall */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>     <span class="enscript-function-name">thread_syscall_return</span>(
                        kern_return_t   ret);

<span class="enscript-comment">/* Context switch */</span>
<span class="enscript-type">extern</span> wait_result_t	thread_block_reason(
							thread_continue_t	continuation,
							<span class="enscript-type">void</span>				*parameter,
							ast_t				reason);

<span class="enscript-comment">/* Reschedule thread for execution */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		thread_setrun(
					thread_t	thread,
					integer_t	options);

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SCHED_TAILQ</span>		1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SCHED_HEADQ</span>		2
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SCHED_PREEMPT</span>	4

<span class="enscript-type">extern</span> uintptr_t sched_thread_on_rt_queue;
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THREAD_ON_RT_RUNQ</span>  ((processor_t)(uintptr_t)&amp;sched_thread_on_rt_queue)

<span class="enscript-type">extern</span> processor_set_t	task_choose_pset(
							task_t			task);

<span class="enscript-comment">/* Bind the current thread to a particular processor */</span>
<span class="enscript-type">extern</span> processor_t		thread_bind(
							processor_t		processor);

<span class="enscript-comment">/* Choose the best processor to run a thread */</span>
<span class="enscript-type">extern</span> processor_t	choose_processor(
									 processor_set_t		pset,
									 processor_t			processor,
									 thread_t			thread);


<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">thread_quantum_init</span>(
								thread_t thread);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		run_queue_init(
					run_queue_t		runq);

<span class="enscript-type">extern</span> thread_t	run_queue_dequeue(
							  run_queue_t		runq,
							  integer_t		options);

<span class="enscript-type">extern</span> boolean_t	run_queue_enqueue(
							  run_queue_t		runq,
							  thread_t			thread,
							  integer_t		options);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>	run_queue_remove(
									 run_queue_t		runq,
									 thread_t			thread);
									  
<span class="enscript-type">struct</span> sched_update_scan_context
{
	uint64_t	earliest_bg_make_runnable_time;
	uint64_t	earliest_normal_make_runnable_time;
	uint64_t	earliest_rt_make_runnable_time;
};
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> sched_update_scan_context *sched_update_scan_context_t;

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">CONFIG_SCHED_TIMESHARE_CORE</span>)

<span class="enscript-type">extern</span> boolean_t        <span class="enscript-function-name">thread_update_add_thread</span>(thread_t thread);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>             <span class="enscript-function-name">thread_update_process_threads</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> boolean_t        <span class="enscript-function-name">runq_scan</span>(run_queue_t runq, sched_update_scan_context_t scan_context);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">sched_timeshare_init</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">sched_timeshare_timebase_init</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">sched_timeshare_maintenance_continue</span>(<span class="enscript-type">void</span>);

<span class="enscript-type">extern</span> boolean_t <span class="enscript-function-name">priority_is_urgent</span>(<span class="enscript-type">int</span> priority);
<span class="enscript-type">extern</span> uint32_t <span class="enscript-function-name">sched_timeshare_initial_quantum_size</span>(thread_t thread);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">sched_compute_timeshare_priority</span>(thread_t thread);

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CONFIG_SCHED_TIMESHARE_CORE */</span>

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>        <span class="enscript-function-name">rt_runq_scan</span>(sched_update_scan_context_t scan_context);

<span class="enscript-comment">/* Remove thread from its run queue */</span>
<span class="enscript-type">extern</span> boolean_t	thread_run_queue_remove(thread_t thread);
thread_t <span class="enscript-function-name">thread_run_queue_remove_for_handoff</span>(thread_t thread);

<span class="enscript-comment">/* Put a thread back in the run queue after being yanked */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">thread_run_queue_reinsert</span>(thread_t thread, integer_t options);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		thread_timer_expire(
					<span class="enscript-type">void</span>			*thread,
					<span class="enscript-type">void</span>			*p1);

<span class="enscript-type">extern</span> boolean_t	thread_eager_preemption(
						thread_t thread);

<span class="enscript-type">extern</span> boolean_t sched_generic_direct_dispatch_to_idle_processors;

<span class="enscript-comment">/* Set the maximum interrupt level for the thread */</span>
__private_extern__ wait_interrupt_t thread_interrupt_level(
						wait_interrupt_t interruptible);

__private_extern__ wait_result_t thread_mark_wait_locked(
						thread_t		 thread,
						wait_interrupt_t interruptible);

<span class="enscript-comment">/* Wake up locked thread directly, passing result */</span>
__private_extern__ kern_return_t clear_wait_internal(
						thread_t		thread,
						wait_result_t	result);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">sched_stats_handle_csw</span>(
							processor_t processor, 
							<span class="enscript-type">int</span> reasons, 
							<span class="enscript-type">int</span> selfpri, 
							<span class="enscript-type">int</span> otherpri);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">sched_stats_handle_runq_change</span>(
									<span class="enscript-type">struct</span> runq_stats *stats, 
									<span class="enscript-type">int</span> old_count);



#<span class="enscript-reference">define</span>	<span class="enscript-function-name">SCHED_STATS_CSW</span>(processor, reasons, selfpri, otherpri) 		\
<span class="enscript-keyword">do</span> { 								\
	<span class="enscript-keyword">if</span> (__builtin_expect(sched_stats_active, 0)) { 	\
		sched_stats_handle_csw((processor), 		\
				(reasons), (selfpri), (otherpri)); 	\
	}							\
} <span class="enscript-keyword">while</span> (0) 


#<span class="enscript-reference">define</span> <span class="enscript-function-name">SCHED_STATS_RUNQ_CHANGE</span>(stats, old_count)		\
<span class="enscript-keyword">do</span> { 								\
	<span class="enscript-keyword">if</span> (__builtin_expect(sched_stats_active, 0)) { 	\
		sched_stats_handle_runq_change((stats), 	\
								(old_count));		\
	}							\
} <span class="enscript-keyword">while</span> (0) 

<span class="enscript-type">extern</span> uint32_t sched_debug_flags;
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SCHED_DEBUG_FLAG_PLATFORM_TRACEPOINTS</span>	0x00000001
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SCHED_DEBUG_FLAG_CHOOSE_PROCESSOR_TRACEPOINTS</span>	0x00000002

#<span class="enscript-reference">define</span> <span class="enscript-function-name">SCHED_DEBUG_PLATFORM_KERNEL_DEBUG_CONSTANT</span>(...) do {						\
		<span class="enscript-keyword">if</span> (__improbable(sched_debug_flags &amp; SCHED_DEBUG_FLAG_PLATFORM_TRACEPOINTS)) { \
			KERNEL_DEBUG_CONSTANT(__VA_ARGS__);							\
		}																\
	} <span class="enscript-keyword">while</span>(0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">SCHED_DEBUG_CHOOSE_PROCESSOR_KERNEL_DEBUG_CONSTANT</span>(...) do {						\
		<span class="enscript-keyword">if</span> (__improbable(sched_debug_flags &amp; SCHED_DEBUG_FLAG_CHOOSE_PROCESSOR_TRACEPOINTS)) { \
			KERNEL_DEBUG_CONSTANT(__VA_ARGS__);							\
		}																\
	} <span class="enscript-keyword">while</span>(0)

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THREAD_URGENCY_NONE</span>		0	<span class="enscript-comment">/* indicates that there is no currently runnable */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THREAD_URGENCY_BACKGROUND</span>	1	<span class="enscript-comment">/* indicates that the thread is marked as a &quot;background&quot; thread */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THREAD_URGENCY_NORMAL</span>		2	<span class="enscript-comment">/* indicates that the thread is marked as a &quot;normal&quot; thread */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">THREAD_URGENCY_REAL_TIME</span>	3	<span class="enscript-comment">/* indicates that the thread is marked as a &quot;real-time&quot; or urgent thread */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">THREAD_URGENCY_MAX</span>		4	<span class="enscript-comment">/* Marker */</span>
<span class="enscript-comment">/* Returns the &quot;urgency&quot; of a thread (provided by scheduler) */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>	thread_get_urgency(
					thread_t	thread,
    				   	uint64_t	*rt_period,
					uint64_t	*rt_deadline);

<span class="enscript-comment">/* Tells the &quot;urgency&quot; of the just scheduled thread (provided by CPU PM) */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>	thread_tell_urgency(
    					<span class="enscript-type">int</span>		urgency,
					uint64_t	rt_period,
					uint64_t	rt_deadline,
					uint64_t	sched_latency,
				    thread_t nthread);

<span class="enscript-comment">/* Tells if there are &quot;active&quot; RT threads in the system (provided by CPU PM) */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>	active_rt_threads(
    					boolean_t	active);

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* MACH_KERNEL_PRIVATE */</span>

__BEGIN_DECLS

#<span class="enscript-reference">ifdef</span>	<span class="enscript-variable-name">XNU_KERNEL_PRIVATE</span>

<span class="enscript-type">extern</span> boolean_t		assert_wait_possible(<span class="enscript-type">void</span>);

<span class="enscript-comment">/* Toggles a global override to turn off CPU Throttling */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CPU_THROTTLE_DISABLE</span>	0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CPU_THROTTLE_ENABLE</span>	1
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>	sys_override_cpu_throttle(<span class="enscript-type">int</span> flag);

<span class="enscript-comment">/*
 ****************** Only exported until BSD stops using ********************
 */</span>

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>			thread_vm_bind_group_add(<span class="enscript-type">void</span>);

<span class="enscript-comment">/* Wake up thread directly, passing result */</span>
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">clear_wait</span>(
						thread_t		thread,
						wait_result_t	result);

<span class="enscript-comment">/* Start thread running */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		thread_bootstrap_return(<span class="enscript-type">void</span>);

<span class="enscript-comment">/* Return from exception (BSD-visible interface) */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		thread_exception_return(<span class="enscript-type">void</span>) __dead2;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SCHED_STRING_MAX_LENGTH</span> (48)
<span class="enscript-comment">/* String declaring the name of the current scheduler */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">char</span> sched_string[SCHED_STRING_MAX_LENGTH];

<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">sched_work_interval_notify</span>(thread_t thread, uint64_t work_interval_id, uint64_t start, uint64_t finish, uint64_t deadline, uint64_t next_start, uint32_t flags);

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* XNU_KERNEL_PRIVATE */</span>

<span class="enscript-comment">/* Context switch */</span>
<span class="enscript-type">extern</span> wait_result_t	thread_block(
							thread_continue_t	continuation);

<span class="enscript-type">extern</span> wait_result_t	thread_block_parameter(
							thread_continue_t	continuation,
							<span class="enscript-type">void</span>				*parameter);

<span class="enscript-comment">/* Declare thread will wait on a particular event */</span>
<span class="enscript-type">extern</span> wait_result_t	assert_wait(
							event_t				event,
							wait_interrupt_t	interruptible);

<span class="enscript-comment">/* Assert that the thread intends to wait with a timeout */</span>
<span class="enscript-type">extern</span> wait_result_t	assert_wait_timeout(
							event_t				event,
							wait_interrupt_t	interruptible,
							uint32_t			interval,
							uint32_t			scale_factor);

<span class="enscript-comment">/* Assert that the thread intends to wait with an urgency, timeout and leeway */</span>
<span class="enscript-type">extern</span> wait_result_t	assert_wait_timeout_with_leeway(
							event_t				event,
							wait_interrupt_t	interruptible,
							wait_timeout_urgency_t	urgency,
							uint32_t			interval,
							uint32_t			leeway,
							uint32_t			scale_factor);

<span class="enscript-type">extern</span> wait_result_t	assert_wait_deadline(
							event_t				event,
							wait_interrupt_t	interruptible,
							uint64_t			deadline);

<span class="enscript-comment">/* Assert that the thread intends to wait with an urgency, deadline, and leeway */</span>
<span class="enscript-type">extern</span> wait_result_t	assert_wait_deadline_with_leeway(
							event_t				event,
							wait_interrupt_t	interruptible,
							wait_timeout_urgency_t	urgency,
							uint64_t			deadline,
							uint64_t			leeway);

<span class="enscript-comment">/* Wake up thread (or threads) waiting on a particular event */</span>
<span class="enscript-type">extern</span> kern_return_t	thread_wakeup_prim(
							event_t				event,
							boolean_t			one_thread,
							wait_result_t			result);

<span class="enscript-type">extern</span> kern_return_t    <span class="enscript-function-name">thread_wakeup_prim_internal</span>(
	                                                event_t				event,
							boolean_t			one_thread,
							wait_result_t			result,
							<span class="enscript-type">int</span>				priority);


#<span class="enscript-reference">define</span> <span class="enscript-function-name">thread_wakeup</span>(x)					\
			thread_wakeup_prim((x), FALSE, THREAD_AWAKENED)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">thread_wakeup_with_result</span>(x, z)		\
			thread_wakeup_prim((x), FALSE, (z))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">thread_wakeup_one</span>(x)				\
			thread_wakeup_prim((x), TRUE, THREAD_AWAKENED)

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">MACH_KERNEL_PRIVATE</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">thread_wakeup_one_with_pri</span>(x, pri)                              \
	                thread_wakeup_prim_internal((x), TRUE, THREAD_AWAKENED, pri)
#<span class="enscript-reference">endif</span>

<span class="enscript-type">extern</span> boolean_t		preemption_enabled(<span class="enscript-type">void</span>);

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">MACH_KERNEL_PRIVATE</span>

<span class="enscript-comment">/*
 * Scheduler algorithm indirection. If only one algorithm is
 * enabled at compile-time, a direction function call is used.
 * If more than one is enabled, calls are dispatched through
 * a function pointer table.
 */</span>

#<span class="enscript-reference">if</span>   !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">CONFIG_SCHED_TRADITIONAL</span>) &amp;&amp; !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">CONFIG_SCHED_PROTO</span>) &amp;&amp; !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">CONFIG_SCHED_GRRR</span>) &amp;&amp; !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">CONFIG_SCHED_MULTIQ</span>)
#<span class="enscript-reference">error</span> <span class="enscript-variable-name">Enable</span> <span class="enscript-variable-name">at</span> <span class="enscript-variable-name">least</span> <span class="enscript-variable-name">one</span> <span class="enscript-variable-name">scheduler</span> <span class="enscript-variable-name">algorithm</span> <span class="enscript-variable-name">in</span> <span class="enscript-variable-name">osfmk</span>/<span class="enscript-variable-name">conf</span>/<span class="enscript-variable-name">MASTER</span>.<span class="enscript-variable-name">XXX</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">define</span> <span class="enscript-function-name">SCHED</span>(f) (sched_current_dispatch-&gt;f)

<span class="enscript-type">struct</span> sched_dispatch_table {
	<span class="enscript-type">const</span> <span class="enscript-type">char</span> *sched_name;
	<span class="enscript-type">void</span>	(*init)(<span class="enscript-type">void</span>);				<span class="enscript-comment">/* Init global state */</span>
	<span class="enscript-type">void</span>	(*timebase_init)(<span class="enscript-type">void</span>);		<span class="enscript-comment">/* Timebase-dependent initialization */</span>
	<span class="enscript-type">void</span>	(*processor_init)(processor_t processor);	<span class="enscript-comment">/* Per-processor scheduler init */</span>
	<span class="enscript-type">void</span>	(*pset_init)(processor_set_t pset);	<span class="enscript-comment">/* Per-processor set scheduler init */</span>

	<span class="enscript-type">void</span>	(*maintenance_continuation)(<span class="enscript-type">void</span>);	<span class="enscript-comment">/* Function called regularly */</span>

	<span class="enscript-comment">/*
	 * Choose a thread of greater or equal priority from the per-processor
	 * runqueue for timeshare/fixed threads
	 */</span>
	thread_t	(*choose_thread)(
								  processor_t		processor,
								  <span class="enscript-type">int</span>				priority,
								  ast_t reason);

	<span class="enscript-comment">/* True if scheduler supports stealing threads */</span>
	boolean_t   steal_thread_enabled;

	<span class="enscript-comment">/*
	 * Steal a thread from another processor in the pset so that it can run
	 * immediately
	 */</span>
	thread_t	(*steal_thread)(
								processor_set_t		pset);

	<span class="enscript-comment">/*
	 * Compute priority for a timeshare thread based on base priority.
	 */</span>
	<span class="enscript-type">int</span> (*compute_timeshare_priority)(thread_t thread);

	<span class="enscript-comment">/*
	 * Pick the best processor for a thread (any kind of thread) to run on.
	 */</span>
	processor_t	(*choose_processor)(
										 processor_set_t		pset,
										 processor_t			processor,
										 thread_t			thread);
	<span class="enscript-comment">/*
	 * Enqueue a timeshare or fixed priority thread onto the per-processor
	 * runqueue
	 */</span>
	boolean_t (*processor_enqueue)(
								 processor_t			processor,
								 thread_t			thread,
								 integer_t			options);

	<span class="enscript-comment">/* Migrate threads away in preparation for processor shutdown */</span>
	<span class="enscript-type">void</span> (*processor_queue_shutdown)(
									 processor_t			processor);

	<span class="enscript-comment">/* Remove the specific thread from the per-processor runqueue */</span>
	boolean_t	(*processor_queue_remove)(
									processor_t		processor,
									thread_t		thread);

	<span class="enscript-comment">/*
	 * Does the per-processor runqueue have any timeshare or fixed priority
	 * threads on it? Called without pset lock held, so should
	 * not assume immutability while executing.
	 */</span>
	boolean_t	(*processor_queue_empty)(processor_t		processor);

	<span class="enscript-comment">/*
	 * Would this priority trigger an urgent preemption if it's sitting
	 * on the per-processor runqueue?
	 */</span>
	boolean_t	(*priority_is_urgent)(<span class="enscript-type">int</span> priority);

	<span class="enscript-comment">/*
	 * Does the per-processor runqueue contain runnable threads that
	 * should cause the currently-running thread to be preempted?
	 */</span>
	ast_t		(*processor_csw_check)(processor_t processor);

	<span class="enscript-comment">/*
	 * Does the per-processor runqueue contain a runnable thread
	 * of &gt; or &gt;= priority, as a preflight for choose_thread() or other
	 * thread selection
	 */</span>
	boolean_t	(*processor_queue_has_priority)(processor_t		processor,
												<span class="enscript-type">int</span>				priority,
												boolean_t		gte);

	<span class="enscript-comment">/* Quantum size for the specified non-realtime thread. */</span>
	uint32_t	(*initial_quantum_size)(thread_t thread);
	
	<span class="enscript-comment">/* Scheduler mode for a new thread */</span>
	sched_mode_t	(*initial_thread_sched_mode)(task_t parent_task);

	<span class="enscript-comment">/*
	 * Is it safe to call update_priority, which may change a thread's
	 * runqueue or other state. This can be used to throttle changes
	 * to dynamic priority.
	 */</span>
	boolean_t	(*can_update_priority)(thread_t thread);

	<span class="enscript-comment">/*
	 * Update both scheduled priority and other persistent state.
	 * Side effects may including migration to another processor's runqueue.
	 */</span>
	<span class="enscript-type">void</span>		(*update_priority)(thread_t thread);

	<span class="enscript-comment">/* Lower overhead update to scheduled priority and state. */</span>
	<span class="enscript-type">void</span>		(*lightweight_update_priority)(thread_t thread);

	<span class="enscript-comment">/* Callback for non-realtime threads when the quantum timer fires */</span>
	<span class="enscript-type">void</span>		(*quantum_expire)(thread_t thread);

	<span class="enscript-comment">/*
	 * Runnable threads on per-processor runqueue. Should only
	 * be used for relative comparisons of load between processors.
	 */</span>
	<span class="enscript-type">int</span>			(*processor_runq_count)(processor_t	processor);

	<span class="enscript-comment">/* Aggregate runcount statistics for per-processor runqueue */</span>
	uint64_t    (*processor_runq_stats_count_sum)(processor_t   processor);

	boolean_t	(*processor_bound_count)(processor_t processor);

	<span class="enscript-type">void</span>		(*thread_update_scan)(sched_update_scan_context_t scan_context);

	<span class="enscript-comment">/*
	* Use processor-&gt;next_thread to pin a thread to an idle
	* processor. If FALSE, threads are enqueued and can
	* be stolen by other processors.
	*/</span>
	boolean_t   direct_dispatch_to_idle_processors;

	<span class="enscript-comment">/* Supports more than one pset */</span>
	boolean_t   multiple_psets_enabled;
	<span class="enscript-comment">/* Supports scheduler groups */</span>
	boolean_t   sched_groups_enabled;
};

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">CONFIG_SCHED_TRADITIONAL</span>)
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> <span class="enscript-type">struct</span> sched_dispatch_table sched_traditional_dispatch;
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> <span class="enscript-type">struct</span> sched_dispatch_table sched_traditional_with_pset_runqueue_dispatch;
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">CONFIG_SCHED_MULTIQ</span>)
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> <span class="enscript-type">struct</span> sched_dispatch_table sched_multiq_dispatch;
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> <span class="enscript-type">struct</span> sched_dispatch_table sched_dualq_dispatch;
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">CONFIG_SCHED_PROTO</span>)
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> <span class="enscript-type">struct</span> sched_dispatch_table sched_proto_dispatch;
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">CONFIG_SCHED_GRRR</span>)
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> <span class="enscript-type">struct</span> sched_dispatch_table sched_grrr_dispatch;
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">/*
 * It is an error to invoke any scheduler-related code
 * before this is set up
 */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> <span class="enscript-type">struct</span> sched_dispatch_table *sched_current_dispatch;

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* MACH_KERNEL_PRIVATE */</span>

__END_DECLS

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* _KERN_SCHED_PRIM_H_ */</span>
</pre>
<hr />
</body></html>