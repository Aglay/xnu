<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>ledger.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">ledger.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2010 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*
 * @OSF_COPYRIGHT@
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_KERN_LEDGER_H_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_KERN_LEDGER_H_</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LEDGER_INFO</span>		0
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LEDGER_ENTRY_INFO</span>	1
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LEDGER_TEMPLATE_INFO</span>	2
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LEDGER_LIMIT</span>		3

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LEDGER_NAME_MAX</span>	32

<span class="enscript-type">struct</span> ledger_info {
	<span class="enscript-type">char</span>	li_name[LEDGER_NAME_MAX];
	int64_t	li_id;
	int64_t	li_entries;
};

<span class="enscript-type">struct</span> ledger_template_info {
	<span class="enscript-type">char</span>		lti_name[LEDGER_NAME_MAX];
	<span class="enscript-type">char</span>		lti_group[LEDGER_NAME_MAX];
	<span class="enscript-type">char</span>		lti_units[LEDGER_NAME_MAX];
};

<span class="enscript-type">struct</span> ledger_entry_info {
        int64_t		lei_balance;
        int64_t		lei_credit;
        int64_t		lei_debit;
        uint64_t	lei_limit;
	uint64_t	lei_refill_period;	<span class="enscript-comment">/* In milliseconds */</span>
	uint64_t	lei_last_refill;	<span class="enscript-comment">/* Time since last refill */</span>
};

<span class="enscript-type">struct</span> ledger_limit_args {
	<span class="enscript-type">char</span>		lla_name[LEDGER_NAME_MAX];
        uint64_t	lla_limit;
        uint64_t	lla_refill_period;
};

#<span class="enscript-reference">ifdef</span>	<span class="enscript-variable-name">KERNEL_PRIVATE</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> ledger_template *ledger_template_t;

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">LEDGER_VALID</span>(ledger)	(ledger != LEDGER_NULL)

<span class="enscript-comment">/* Action to take when a ledger goes into deficit */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LEDGER_ACTION_IGNORE</span>	0x0000
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LEDGER_ACTION_BLOCK</span>	0x0010
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LEDGER_ACTION_CALLBACK</span>	0x0020
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LEDGER_ACTION_MASK</span>	0x00f0

<span class="enscript-comment">/*
 * Types of warnings that trigger a callback.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LEDGER_WARNING_ROSE_ABOVE</span>	1
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LEDGER_WARNING_DIPPED_BELOW</span>	2

<span class="enscript-type">typedef</span> <span class="enscript-function-name">void</span> (*ledger_callback_t)(<span class="enscript-type">int</span> warning, <span class="enscript-type">const</span> <span class="enscript-type">void</span> * param0, <span class="enscript-type">const</span> <span class="enscript-type">void</span> *param1);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ledger_init</span>(<span class="enscript-type">void</span>);

<span class="enscript-type">extern</span> ledger_template_t <span class="enscript-function-name">ledger_template_create</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *name);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ledger_template_dereference</span>(ledger_template_t template);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">ledger_entry_add</span>(ledger_template_t template, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *key,
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> *group, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *units);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ledger_set_callback</span>(ledger_template_t template, <span class="enscript-type">int</span> entry,
	ledger_callback_t callback, <span class="enscript-type">const</span> <span class="enscript-type">void</span> *param0, <span class="enscript-type">const</span> <span class="enscript-type">void</span> *param1);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ledger_track_maximum</span>(ledger_template_t template, <span class="enscript-type">int</span> entry,
	<span class="enscript-type">int</span> period_in_secs);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ledger_panic_on_negative</span>(ledger_template_t template,
					      <span class="enscript-type">int</span> entry);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">ledger_key_lookup</span>(ledger_template_t template, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *key);

<span class="enscript-comment">/* value of entry type */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LEDGER_CREATE_ACTIVE_ENTRIES</span>	0
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LEDGER_CREATE_INACTIVE_ENTRIES</span>	1
<span class="enscript-type">extern</span> ledger_t <span class="enscript-function-name">ledger_instantiate</span>(ledger_template_t template, <span class="enscript-type">int</span> entry_type);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ledger_disable_callback</span>(ledger_t ledger, <span class="enscript-type">int</span> entry);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ledger_enable_callback</span>(ledger_t ledger, <span class="enscript-type">int</span> entry);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ledger_get_limit</span>(ledger_t ledger, <span class="enscript-type">int</span> entry,
	ledger_amount_t *limit);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ledger_set_limit</span>(ledger_t ledger, <span class="enscript-type">int</span> entry,
	ledger_amount_t limit, uint8_t warn_level_percentage);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ledger_get_maximum</span>(ledger_t ledger, <span class="enscript-type">int</span> entry,
	ledger_amount_t *max_observed_balance);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ledger_get_actions</span>(ledger_t ledger, <span class="enscript-type">int</span> entry, <span class="enscript-type">int</span> *actions);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ledger_set_action</span>(ledger_t ledger, <span class="enscript-type">int</span> entry, <span class="enscript-type">int</span> action);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ledger_get_period</span>(ledger_t ledger, <span class="enscript-type">int</span> entry,
    uint64_t *period);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ledger_set_period</span>(ledger_t ledger, <span class="enscript-type">int</span> entry,
    uint64_t period);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ledger_disable_refill</span>(ledger_t l, <span class="enscript-type">int</span> entry);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ledger_entry_setactive</span>(ledger_t ledger, <span class="enscript-type">int</span> entry);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ledger_check_new_balance</span>(ledger_t ledger, <span class="enscript-type">int</span> entry);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ledger_credit</span>(ledger_t ledger, <span class="enscript-type">int</span> entry,
	ledger_amount_t amount);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ledger_debit</span>(ledger_t ledger, <span class="enscript-type">int</span> entry,
	ledger_amount_t amount);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ledger_zero_balance</span>(ledger_t ledger, <span class="enscript-type">int</span> entry);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ledger_get_entries</span>(ledger_t ledger, <span class="enscript-type">int</span> entry,
	ledger_amount_t *credit, ledger_amount_t *debit);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ledger_get_balance</span>(ledger_t ledger, <span class="enscript-type">int</span> entry,
	ledger_amount_t *balance);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ledger_reset_callback_state</span>(ledger_t ledger, <span class="enscript-type">int</span> entry);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ledger_disable_panic_on_negative</span>(ledger_t ledger, <span class="enscript-type">int</span> entry);

<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ledger_rollup</span>(ledger_t to_ledger, ledger_t from_ledger);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ledger_ast</span>(thread_t thread);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">ledger_reference_count</span>(ledger_t ledger);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ledger_reference</span>(ledger_t ledger);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">ledger_dereference</span>(ledger_t ledger);

<span class="enscript-comment">/* Per-pmap ledger operations */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">pmap_ledger_debit</span>(p, e, a) ledger_debit((p)-&gt;ledger, e, a)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">pmap_ledger_credit</span>(p, e, a) ledger_credit((p)-&gt;ledger, e, a)

<span class="enscript-comment">/* Support for ledger() syscall */</span>
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">LEDGER_DEBUG</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">ledger_limit</span>(task_t task, <span class="enscript-type">struct</span> ledger_limit_args *args);
#<span class="enscript-reference">endif</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">ledger_info</span>(task_t task, <span class="enscript-type">struct</span> ledger_info *info);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> 
<span class="enscript-function-name">ledger_get_task_entry_info_multiple</span>(task_t task, <span class="enscript-type">void</span> **buf, <span class="enscript-type">int</span> *len);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">ledger_get_entry_info</span>(ledger_t ledger, <span class="enscript-type">int</span> entry,
                      <span class="enscript-type">struct</span> ledger_entry_info *lei);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">ledger_template_info</span>(<span class="enscript-type">void</span> **buf, <span class="enscript-type">int</span> *len);

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL_PRIVATE */</span>

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* _KERN_LEDGER_H_ */</span>
</pre>
<hr />
</body></html>