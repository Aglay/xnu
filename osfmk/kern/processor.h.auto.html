<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>processor.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">processor.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000-2009 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*
 * @OSF_COPYRIGHT@
 */</span>
<span class="enscript-comment">/* 
 * Mach Operating System
 * Copyright (c) 1991,1990,1989 Carnegie Mellon University
 * All Rights Reserved.
 * 
 * Permission to use, copy, modify and distribute this software and its
 * documentation is hereby granted, provided that both the copyright
 * notice and this permission notice appear in all copies of the
 * software, derivative works or modified versions, and any portions
 * thereof, and that both notices appear in supporting documentation.
 * 
 * CARNEGIE MELLON ALLOWS FREE USE OF THIS SOFTWARE IN ITS &quot;AS IS&quot;
 * CONDITION.  CARNEGIE MELLON DISCLAIMS ANY LIABILITY OF ANY KIND FOR
 * ANY DAMAGES WHATSOEVER RESULTING FROM THE USE OF THIS SOFTWARE.
 * 
 * Carnegie Mellon requests users of this software to return to
 * 
 *  Software Distribution Coordinator  or  <a href="mailto:Software.Distribution@CS.CMU.EDU">Software.Distribution@CS.CMU.EDU</a>
 *  School of Computer Science
 *  Carnegie Mellon University
 *  Pittsburgh PA 15213-3890
 * 
 * any improvements or extensions that they make and grant Carnegie Mellon
 * the rights to redistribute these changes.
 */</span>
<span class="enscript-comment">/*
 */</span>

<span class="enscript-comment">/*
 *	processor.h:	Processor and processor-related definitions.
 */</span>

#<span class="enscript-reference">ifndef</span>	<span class="enscript-variable-name">_KERN_PROCESSOR_H_</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">_KERN_PROCESSOR_H_</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/boolean.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/kern_return.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/kern_types.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/cdefs.h&gt;</span>

#<span class="enscript-reference">ifdef</span>	<span class="enscript-variable-name">MACH_KERNEL_PRIVATE</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/mach_types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/ast.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/cpu_number.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/smp.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/simple_lock.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/locks.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/queue.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/sched.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/sfi_class.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/processor_data.h&gt;</span>

<span class="enscript-type">struct</span> processor_set {
	queue_head_t		active_queue;	<span class="enscript-comment">/* active processors */</span>
	queue_head_t		idle_queue;		<span class="enscript-comment">/* idle processors */</span>
	queue_head_t		idle_secondary_queue;		<span class="enscript-comment">/* idle secondary processors */</span>

	<span class="enscript-type">int</span>					online_processor_count;

	<span class="enscript-type">int</span>					cpu_set_low, cpu_set_hi;
	<span class="enscript-type">int</span>					cpu_set_count;

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">__SMP__</span>
	decl_simple_lock_data(,sched_lock)	<span class="enscript-comment">/* lock for above */</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">CONFIG_SCHED_TRADITIONAL</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">CONFIG_SCHED_MULTIQ</span>)
	<span class="enscript-type">struct</span> run_queue	pset_runq;      <span class="enscript-comment">/* runq for this processor set */</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">CONFIG_SCHED_TRADITIONAL</span>)
	<span class="enscript-type">int</span>					pset_runq_bound_count;
		<span class="enscript-comment">/* # of threads in runq bound to any processor in pset */</span>
#<span class="enscript-reference">endif</span>

	<span class="enscript-comment">/* CPUs that have been sent an unacknowledged remote AST for scheduling purposes */</span>
	uint64_t			pending_AST_cpu_mask;
#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">CONFIG_SCHED_DEFERRED_AST</span>)
	<span class="enscript-comment">/*
	 * A seperate mask, for ASTs that we may be able to cancel.  This is dependent on
	 * some level of support for requesting an AST on a processor, and then quashing
	 * that request later.
	 *
	 * The purpose of this field (and the associated codepaths) is to infer when we
	 * no longer need a processor that is DISPATCHING to come up, and to prevent it
	 * from coming out of IDLE if possible.  This should serve to decrease the number
	 * of spurious ASTs in the system, and let processors spend longer periods in
	 * IDLE.
	 */</span>
	uint64_t			pending_deferred_AST_cpu_mask;
#<span class="enscript-reference">endif</span>

	<span class="enscript-type">struct</span> ipc_port	*	pset_self;		<span class="enscript-comment">/* port for operations */</span>
	<span class="enscript-type">struct</span> ipc_port *	pset_name_self;	<span class="enscript-comment">/* port for information */</span>

	processor_set_t		pset_list;		<span class="enscript-comment">/* chain of associated psets */</span>
	pset_node_t			node;
};

<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> processor_set	pset0;

<span class="enscript-type">struct</span> pset_node {
	processor_set_t		psets;			<span class="enscript-comment">/* list of associated psets */</span>

	pset_node_t			nodes;			<span class="enscript-comment">/* list of associated subnodes */</span>
	pset_node_t			node_list;		<span class="enscript-comment">/* chain of associated nodes */</span>

	pset_node_t			parent;
};

<span class="enscript-type">extern</span> <span class="enscript-type">struct</span> pset_node	pset_node0;

<span class="enscript-type">extern</span> queue_head_t		tasks, terminated_tasks, threads; <span class="enscript-comment">/* Terminated tasks are ONLY for stackshot */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>				tasks_count, terminated_tasks_count, threads_count;
<span class="enscript-function-name">decl_lck_mtx_data</span>(<span class="enscript-type">extern</span>,tasks_threads_lock)

<span class="enscript-type">struct</span> processor {
	queue_chain_t		processor_queue;<span class="enscript-comment">/* idle/active queue link,
										 * MUST remain the first element */</span>
	<span class="enscript-type">int</span>					state;			<span class="enscript-comment">/* See below */</span>
	boolean_t		is_SMT;
	boolean_t		is_recommended;
	<span class="enscript-type">struct</span> thread
						*active_thread,	<span class="enscript-comment">/* thread running on processor */</span>
						*next_thread,	<span class="enscript-comment">/* next thread when dispatched */</span>
						*idle_thread;	<span class="enscript-comment">/* this processor's idle thread. */</span>

	processor_set_t		processor_set;	<span class="enscript-comment">/* assigned set */</span>

	<span class="enscript-type">int</span>					current_pri;	<span class="enscript-comment">/* priority of current thread */</span>
	sched_mode_t		current_thmode;	<span class="enscript-comment">/* sched mode of current thread */</span>
	sfi_class_id_t		current_sfi_class;	<span class="enscript-comment">/* SFI class of current thread */</span>
	<span class="enscript-type">int</span>					cpu_id;			<span class="enscript-comment">/* platform numeric id */</span>

	timer_call_data_t	quantum_timer;	<span class="enscript-comment">/* timer for quantum expiration */</span>
	uint64_t			quantum_end;	<span class="enscript-comment">/* time when current quantum ends */</span>
	uint64_t			last_dispatch;	<span class="enscript-comment">/* time of last dispatch */</span>

	uint64_t			deadline;		<span class="enscript-comment">/* current deadline */</span>
	boolean_t               first_timeslice;                <span class="enscript-comment">/* has the quantum expired since context switch */</span>

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">CONFIG_SCHED_TRADITIONAL</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">CONFIG_SCHED_MULTIQ</span>)
	<span class="enscript-type">struct</span> run_queue	runq;			<span class="enscript-comment">/* runq for this processor */</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">CONFIG_SCHED_TRADITIONAL</span>)
	<span class="enscript-type">int</span>					runq_bound_count; <span class="enscript-comment">/* # of threads bound to this processor */</span>
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">CONFIG_SCHED_GRRR</span>)
	<span class="enscript-type">struct</span> grrr_run_queue	grrr_runq;      <span class="enscript-comment">/* Group Ratio Round-Robin runq */</span>
#<span class="enscript-reference">endif</span>

	processor_t			processor_primary;	<span class="enscript-comment">/* pointer to primary processor for
											 * secondary SMT processors, or a pointer
											 * to ourselves for primaries or non-SMT */</span>
	processor_t		processor_secondary;
	<span class="enscript-type">struct</span> ipc_port *	processor_self;	<span class="enscript-comment">/* port for operations */</span>

	processor_t			processor_list;	<span class="enscript-comment">/* all existing processors */</span>
	processor_data_t	processor_data;	<span class="enscript-comment">/* per-processor data */</span>
};

<span class="enscript-type">extern</span> processor_t		processor_list;
<span class="enscript-type">extern</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>		processor_count;
<span class="enscript-function-name">decl_simple_lock_data</span>(<span class="enscript-type">extern</span>,processor_list_lock)

<span class="enscript-type">extern</span> uint32_t			processor_avail_count;

<span class="enscript-type">extern</span> processor_t		master_processor;

<span class="enscript-type">extern</span> boolean_t		sched_stats_active;

<span class="enscript-comment">/*
 *	Processor state is accessed by locking the scheduling lock
 *	for the assigned processor set.
 *
 *           -------------------- SHUTDOWN
 *          /                     ^     ^
 *        _/                      |      \
 *  OFF_LINE ---&gt; START ---&gt; RUNNING ---&gt; IDLE ---&gt; DISPATCHING
 *         \_________________^   ^ ^______/           /
 *                                \__________________/
 *
 *  Most of these state transitions are externally driven as a
 *  a directive (for instance telling an IDLE processor to start
 *  coming out of the idle state to run a thread). However these
 *  are typically paired with a handshake by the processor itself
 *  to indicate that it has completed a transition of indeterminate
 *  length (for example, the DISPATCHING-&gt;RUNNING or START-&gt;RUNNING
 *  transitions must occur on the processor itself).
 *
 *  The boot processor has some special cases, and skips the START state,
 *  since it has already bootstrapped and is ready to context switch threads.
 *
 *  When a processor is in DISPATCHING or RUNNING state, the current_pri,
 *  current_thmode, and deadline fields should be set, so that other
 *  processors can evaluate if it is an appropriate candidate for preemption.
 */</span>
#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">CONFIG_SCHED_DEFERRED_AST</span>)
<span class="enscript-comment">/*
 *           -------------------- SHUTDOWN
 *          /                     ^     ^
 *        _/                      |      \
 *  OFF_LINE ---&gt; START ---&gt; RUNNING ---&gt; IDLE ---&gt; DISPATCHING
 *         \_________________^   ^ ^______/ ^_____ /  /
 *                                \__________________/
 *
 *  A DISPATCHING processor may be put back into IDLE, if another
 *  processor determines that the target processor will have nothing to do
 *  upon reaching the RUNNING state.  This is racy, but if the target
 *  responds and becomes RUNNING, it will not break the processor state
 *  machine.
 *
 *  This change allows us to cancel an outstanding signal/AST on a processor
 *  (if such an operation is supported through hardware or software), and
 *  push the processor back into the IDLE state as a power optimization.
 */</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PROCESSOR_OFF_LINE</span>		0	<span class="enscript-comment">/* Not available */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PROCESSOR_SHUTDOWN</span>		1	<span class="enscript-comment">/* Going off-line */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PROCESSOR_START</span>			2	<span class="enscript-comment">/* Being started */</span>
<span class="enscript-comment">/*                     			3	   Formerly Inactive (unavailable) */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PROCESSOR_IDLE</span>			4	<span class="enscript-comment">/* Idle (available) */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PROCESSOR_DISPATCHING</span>	5	<span class="enscript-comment">/* Dispatching (idle -&gt; active) */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PROCESSOR_RUNNING</span>		6	<span class="enscript-comment">/* Normal execution */</span>

<span class="enscript-type">extern</span> processor_t	current_processor(<span class="enscript-type">void</span>);

<span class="enscript-comment">/* Lock macros, always acquired and released with interrupts disabled (splsched()) */</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">__SMP__</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">pset_lock</span>(p)			simple_lock(&amp;(p)-&gt;sched_lock)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">pset_unlock</span>(p)			simple_unlock(&amp;(p)-&gt;sched_lock)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">pset_lock_init</span>(p)		simple_lock_init(&amp;(p)-&gt;sched_lock, 0)
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">pset_lock</span>(p)			do { (void)p; } while(0)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">pset_unlock</span>(p)			do { (void)p; } while(0)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">pset_lock_init</span>(p)		do { (void)p; } while(0)
#<span class="enscript-reference">endif</span>

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		processor_bootstrap(<span class="enscript-type">void</span>);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		processor_init(
					processor_t		processor,
					<span class="enscript-type">int</span>				cpu_id,
					processor_set_t	processor_set);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		processor_set_primary(
					processor_t		processor,
					processor_t		primary);

<span class="enscript-type">extern</span> kern_return_t	processor_shutdown(
							processor_t		processor);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		processor_queue_shutdown(
					processor_t		processor);

<span class="enscript-type">extern</span> processor_set_t	processor_pset(
							processor_t		processor);

<span class="enscript-type">extern</span> pset_node_t		pset_node_root(<span class="enscript-type">void</span>);

<span class="enscript-type">extern</span> processor_set_t	pset_create(
							pset_node_t		node);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		pset_init(
					processor_set_t		pset,
					pset_node_t			node);

<span class="enscript-type">extern</span> kern_return_t	processor_info_count(
							processor_flavor_t		flavor,
							mach_msg_type_number_t	*count);

#<span class="enscript-reference">define</span> <span class="enscript-function-name">pset_deallocate</span>(x)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">pset_reference</span>(x)

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>				machine_run_count(
							uint32_t	count);

<span class="enscript-type">extern</span> processor_t		machine_choose_processor(
							processor_set_t		pset,
							processor_t			processor);

#<span class="enscript-reference">define</span> <span class="enscript-function-name">next_pset</span>(p)	(((p)-&gt;pset_list != PROCESSOR_SET_NULL)? (p)-&gt;pset_list: (p)-&gt;node-&gt;psets)

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PSET_THING_TASK</span>		0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PSET_THING_THREAD</span>	1

<span class="enscript-type">extern</span> kern_return_t	processor_set_things(
                    	processor_set_t pset,
			<span class="enscript-type">void</span> **thing_list,
			mach_msg_type_number_t *count,
			<span class="enscript-type">int</span> type);

#<span class="enscript-reference">else</span>	<span class="enscript-comment">/* MACH_KERNEL_PRIVATE */</span>

__BEGIN_DECLS

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		pset_deallocate(
					processor_set_t	pset);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		pset_reference(
					processor_set_t	pset);

__END_DECLS

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* MACH_KERNEL_PRIVATE */</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL_PRIVATE</span>
__BEGIN_DECLS
<span class="enscript-type">extern</span> processor_t	cpu_to_processor(<span class="enscript-type">int</span> cpu);
__END_DECLS

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL_PRIVATE */</span>

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* _KERN_PROCESSOR_H_ */</span>
</pre>
<hr />
</body></html>