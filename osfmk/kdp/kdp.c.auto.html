<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>kdp.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">kdp.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000-2012 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/mach_types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/vm_param.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/appleapiopts.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/debug.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;uuid/uuid.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kdp/kdp_internal.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kdp/kdp_private.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kdp/kdp_core.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libsa/types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/version.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span> <span class="enscript-comment">/* bcopy */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/processor.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/thread.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/clock.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/vm_map.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/vm_kern.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/vm_pageout.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/vm_shared_region.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libkern/OSKextLibPrivate.h&gt;</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DO_ALIGN</span>	1	<span class="enscript-comment">/* align all packet data accesses */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KDP_TEST_HARNESS</span> 0
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">KDP_TEST_HARNESS</span> 
#<span class="enscript-reference">define</span> <span class="enscript-function-name">dprintf</span>(x) kprintf x 
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">dprintf</span>(x)
#<span class="enscript-reference">endif</span>

<span class="enscript-type">static</span> kdp_dispatch_t
    dispatch_table[KDP_INVALID_REQUEST-KDP_CONNECT] =
    {
<span class="enscript-comment">/* 0 */</span>	kdp_connect,
<span class="enscript-comment">/* 1 */</span>	kdp_disconnect,
<span class="enscript-comment">/* 2 */</span>	kdp_hostinfo,
<span class="enscript-comment">/* 3 */</span>	kdp_version,
<span class="enscript-comment">/* 4 */</span>	kdp_maxbytes,
<span class="enscript-comment">/* 5 */</span>	kdp_readmem,
<span class="enscript-comment">/* 6 */</span>	kdp_writemem,
<span class="enscript-comment">/* 7 */</span>	kdp_readregs,
<span class="enscript-comment">/* 8 */</span>	kdp_writeregs,
<span class="enscript-comment">/* 9 */</span> kdp_unknown,
<span class="enscript-comment">/* A */</span> kdp_unknown,
<span class="enscript-comment">/* B */</span>	kdp_suspend,
<span class="enscript-comment">/* C */</span>	kdp_resumecpus,
<span class="enscript-comment">/* D */</span>	kdp_unknown,
<span class="enscript-comment">/* E */</span> kdp_unknown,
<span class="enscript-comment">/* F */</span> kdp_breakpoint_set,
<span class="enscript-comment">/*10 */</span> kdp_breakpoint_remove,
<span class="enscript-comment">/*11 */</span>	kdp_regions,
<span class="enscript-comment">/*12 */</span> kdp_reattach,
<span class="enscript-comment">/*13 */</span> kdp_reboot,
<span class="enscript-comment">/*14 */</span> kdp_readmem64,
<span class="enscript-comment">/*15 */</span> kdp_writemem64,
<span class="enscript-comment">/*16 */</span> kdp_breakpoint64_set,
<span class="enscript-comment">/*17 */</span> kdp_breakpoint64_remove,
<span class="enscript-comment">/*18 */</span> kdp_kernelversion,
<span class="enscript-comment">/*19 */</span> kdp_readphysmem64,
<span class="enscript-comment">/*1A */</span> kdp_writephysmem64,
<span class="enscript-comment">/*1B */</span> kdp_readioport,
<span class="enscript-comment">/*1C */</span> kdp_writeioport,
<span class="enscript-comment">/*1D */</span> kdp_readmsr64,
<span class="enscript-comment">/*1E */</span> kdp_writemsr64,
<span class="enscript-comment">/*1F */</span> kdp_dumpinfo,
    };
    
kdp_glob_t	kdp;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MAX_BREAKPOINTS</span> 100

<span class="enscript-comment">/*
 * Version 11 of the KDP Protocol adds support for 64-bit wide memory
 * addresses (read/write and breakpoints) as well as a dedicated
 * kernelversion request. Version 12 adds read/writing of physical
 * memory with 64-bit wide memory addresses. 
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KDP_VERSION</span> 12

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span>{
	mach_vm_address_t	address;
	uint32_t	bytesused;
	uint8_t		oldbytes[MAX_BREAKINSN_BYTES];
} kdp_breakpoint_record_t;

<span class="enscript-type">static</span> kdp_breakpoint_record_t breakpoint_list[MAX_BREAKPOINTS];
<span class="enscript-type">static</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> breakpoints_initialized = 0;

<span class="enscript-type">int</span> reattach_wait = 0;
<span class="enscript-type">int</span> noresume_on_disconnect = 0;
<span class="enscript-type">extern</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> return_on_panic;

kdp_error_t
<span class="enscript-function-name">kdp_set_breakpoint_internal</span>(
							   mach_vm_address_t	address
							   );

kdp_error_t
<span class="enscript-function-name">kdp_remove_breakpoint_internal</span>(
							   mach_vm_address_t	address
							   );

boolean_t
<span class="enscript-function-name">kdp_packet</span>(
    <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span>	*pkt,
    <span class="enscript-type">int</span>			*len,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
    <span class="enscript-type">static</span> <span class="enscript-type">unsigned</span>	aligned_pkt[1538/<span class="enscript-keyword">sizeof</span>(<span class="enscript-type">unsigned</span>)+1]; <span class="enscript-comment">// max ether pkt
</span>    kdp_pkt_t		*rd = (kdp_pkt_t *)&amp;aligned_pkt;
    size_t		plen = *len;
    kdp_req_t		req;
    boolean_t		ret;
    
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">DO_ALIGN</span>
    bcopy((<span class="enscript-type">char</span> *)pkt, (<span class="enscript-type">char</span> *)rd, <span class="enscript-keyword">sizeof</span>(aligned_pkt));
#<span class="enscript-reference">else</span>
    rd = (kdp_pkt_t *)pkt;
#<span class="enscript-reference">endif</span>
    <span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (rd-&gt;hdr) || rd-&gt;hdr.len != plen) {
	printf(<span class="enscript-string">&quot;kdp_packet bad len pkt %lu hdr %d\n&quot;</span>, plen, rd-&gt;hdr.len);

	<span class="enscript-keyword">return</span> (FALSE);
    }
    
    <span class="enscript-keyword">if</span> (rd-&gt;hdr.is_reply) {
	printf(<span class="enscript-string">&quot;kdp_packet reply recvd req %x seq %x\n&quot;</span>,
	    rd-&gt;hdr.request, rd-&gt;hdr.seq);

	<span class="enscript-keyword">return</span> (FALSE);  
    }
    
    req = rd-&gt;hdr.request;
    <span class="enscript-keyword">if</span> (req &gt;= KDP_INVALID_REQUEST) {
	printf(<span class="enscript-string">&quot;kdp_packet bad request %x len %d seq %x key %x\n&quot;</span>,
	    rd-&gt;hdr.request, rd-&gt;hdr.len, rd-&gt;hdr.seq, rd-&gt;hdr.key);

	<span class="enscript-keyword">return</span> (FALSE);
    }
    
    ret = ((*dispatch_table[req - KDP_CONNECT])(rd, len, reply_port));
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">DO_ALIGN</span>
    bcopy((<span class="enscript-type">char</span> *)rd, (<span class="enscript-type">char</span> *) pkt, *len);
#<span class="enscript-reference">endif</span>
    <span class="enscript-keyword">return</span> ret;
}

<span class="enscript-type">static</span> boolean_t
<span class="enscript-function-name">kdp_unknown</span>(
    kdp_pkt_t		*pkt,
    __unused <span class="enscript-type">int</span>	*len,
    __unused <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
    kdp_pkt_t		*rd = (kdp_pkt_t *)pkt;

    printf(<span class="enscript-string">&quot;kdp_unknown request %x len %d seq %x key %x\n&quot;</span>,
	rd-&gt;hdr.request, rd-&gt;hdr.len, rd-&gt;hdr.seq, rd-&gt;hdr.key);

    <span class="enscript-keyword">return</span> (FALSE);
}

<span class="enscript-type">static</span> boolean_t
<span class="enscript-function-name">kdp_connect</span>(
    kdp_pkt_t		*pkt,
    <span class="enscript-type">int</span>			*len,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
    kdp_connect_req_t	*rq = &amp;pkt-&gt;connect_req;
    size_t		plen = *len;
    kdp_connect_reply_t	*rp = &amp;pkt-&gt;connect_reply;
    uint16_t            rport, eport;
    uint32_t            key;
    uint8_t             seq;

    <span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
	<span class="enscript-keyword">return</span> (FALSE);

    dprintf((<span class="enscript-string">&quot;kdp_connect seq %x greeting %s\n&quot;</span>, rq-&gt;hdr.seq, rq-&gt;greeting));

    rport = rq-&gt;req_reply_port;
    eport = rq-&gt;exc_note_port;
    key   = rq-&gt;hdr.key;
    seq   = rq-&gt;hdr.seq;
    <span class="enscript-keyword">if</span> (kdp.is_conn) {
	<span class="enscript-keyword">if</span> ((seq == kdp.conn_seq) &amp;&amp;	<span class="enscript-comment">/* duplicate request */</span>
            (rport == kdp.reply_port) &amp;&amp;
            (eport == kdp.exception_port) &amp;&amp;
            (key == kdp.session_key))
	    rp-&gt;error = KDPERR_NO_ERROR;
	<span class="enscript-keyword">else</span> 
	    rp-&gt;error = KDPERR_ALREADY_CONNECTED;
    }
    <span class="enscript-keyword">else</span> { 
	kdp.reply_port     = rport;
	kdp.exception_port = eport;
	kdp.is_conn        = TRUE;
	kdp.conn_seq       = seq;
        kdp.session_key    = key;

	rp-&gt;error = KDPERR_NO_ERROR;
    }

    rp-&gt;hdr.is_reply = 1;
    rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);
    
    *reply_port = rport;
    *len = rp-&gt;hdr.len;
    
    <span class="enscript-keyword">if</span> (current_debugger == KDP_CUR_DB)    
    	active_debugger=1;

    <span class="enscript-keyword">return</span> (TRUE);
}

<span class="enscript-type">static</span> boolean_t
<span class="enscript-function-name">kdp_disconnect</span>(
    kdp_pkt_t		*pkt,
    <span class="enscript-type">int</span>			*len,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
    kdp_disconnect_req_t	*rq = &amp;pkt-&gt;disconnect_req;
    size_t			plen = *len;
    kdp_disconnect_reply_t	*rp = &amp;pkt-&gt;disconnect_reply;

    <span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
	<span class="enscript-keyword">return</span> (FALSE);
	
    <span class="enscript-keyword">if</span> (!kdp.is_conn)
	<span class="enscript-keyword">return</span> (FALSE);

    dprintf((<span class="enscript-string">&quot;kdp_disconnect\n&quot;</span>));
 
    *reply_port = kdp.reply_port;

    kdp.reply_port = kdp.exception_port = 0;
    kdp.is_halted = kdp.is_conn = FALSE;
    kdp.exception_seq = kdp.conn_seq = 0;
    kdp.session_key = 0;

    <span class="enscript-keyword">if</span> ((panicstr != NULL) &amp;&amp; (return_on_panic == 0))
	reattach_wait = 1;

    <span class="enscript-keyword">if</span> (noresume_on_disconnect == 1) {
	reattach_wait = 1;
	noresume_on_disconnect = 0;
    }

    rp-&gt;hdr.is_reply = 1;
    rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);
    
    *len = rp-&gt;hdr.len;
    
    <span class="enscript-keyword">if</span> (current_debugger == KDP_CUR_DB)
    	active_debugger=0;

    <span class="enscript-keyword">return</span> (TRUE);
}

<span class="enscript-type">static</span> boolean_t
<span class="enscript-function-name">kdp_reattach</span>(
    kdp_pkt_t		*pkt,
    <span class="enscript-type">int</span>			*len,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
    kdp_reattach_req_t            *rq = &amp;pkt-&gt;reattach_req;

    kdp.is_conn = TRUE;
    kdp_disconnect(pkt, len, reply_port);
    *reply_port = rq-&gt;req_reply_port;
    reattach_wait = 1;
    <span class="enscript-keyword">return</span> (TRUE);
}

<span class="enscript-type">static</span> boolean_t
<span class="enscript-function-name">kdp_hostinfo</span>(
    kdp_pkt_t		*pkt,
    <span class="enscript-type">int</span>			*len,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
    kdp_hostinfo_req_t	*rq = &amp;pkt-&gt;hostinfo_req;
    size_t		plen = *len;
    kdp_hostinfo_reply_t *rp = &amp;pkt-&gt;hostinfo_reply;

    <span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
	<span class="enscript-keyword">return</span> (FALSE);

    dprintf((<span class="enscript-string">&quot;kdp_hostinfo\n&quot;</span>));

    rp-&gt;hdr.is_reply = 1;
    rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);

    kdp_machine_hostinfo(&amp;rp-&gt;hostinfo);

    *reply_port = kdp.reply_port;
    *len = rp-&gt;hdr.len;
    
    <span class="enscript-keyword">return</span> (TRUE);
}

<span class="enscript-type">static</span> boolean_t
<span class="enscript-function-name">kdp_kernelversion</span>(
    kdp_pkt_t		*pkt,
    <span class="enscript-type">int</span>			*len,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
    kdp_kernelversion_req_t	*rq = &amp;pkt-&gt;kernelversion_req;
    size_t		plen = *len;
    kdp_kernelversion_reply_t *rp = &amp;pkt-&gt;kernelversion_reply;
	size_t		slen;
	
    <span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
		<span class="enscript-keyword">return</span> (FALSE);
	
    rp-&gt;hdr.is_reply = 1;
    rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);
	
    dprintf((<span class="enscript-string">&quot;kdp_kernelversion\n&quot;</span>));
    slen = strlcpy(rp-&gt;version, kdp_kernelversion_string, MAX_KDP_DATA_SIZE);
	
    rp-&gt;hdr.len += slen + 1; <span class="enscript-comment">/* strlcpy returns the amount copied with NUL */</span>
	
    *reply_port = kdp.reply_port;
    *len = rp-&gt;hdr.len;
    
    <span class="enscript-keyword">return</span> (TRUE);
}

<span class="enscript-type">static</span> boolean_t
<span class="enscript-function-name">kdp_suspend</span>(
    kdp_pkt_t		*pkt,
    <span class="enscript-type">int</span>			*len,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
    kdp_suspend_req_t	*rq = &amp;pkt-&gt;suspend_req;
    size_t		plen = *len;
    kdp_suspend_reply_t *rp = &amp;pkt-&gt;suspend_reply;

    <span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
	<span class="enscript-keyword">return</span> (FALSE);

    rp-&gt;hdr.is_reply = 1;
    rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);

    dprintf((<span class="enscript-string">&quot;kdp_suspend\n&quot;</span>));

    kdp.is_halted = TRUE;
    
    *reply_port = kdp.reply_port;
    *len = rp-&gt;hdr.len;
    
    <span class="enscript-keyword">return</span> (TRUE);
}

<span class="enscript-type">static</span> boolean_t
<span class="enscript-function-name">kdp_resumecpus</span>(
    kdp_pkt_t		*pkt,
    <span class="enscript-type">int</span>			*len,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
    kdp_resumecpus_req_t	*rq = &amp;pkt-&gt;resumecpus_req;
    size_t			plen = *len;
    kdp_resumecpus_reply_t 	*rp = &amp;pkt-&gt;resumecpus_reply;

    <span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
	<span class="enscript-keyword">return</span> (FALSE);

    rp-&gt;hdr.is_reply = 1;
    rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);

    dprintf((<span class="enscript-string">&quot;kdp_resumecpus %x\n&quot;</span>, rq-&gt;cpu_mask));
    
    kdp.is_halted = FALSE;
    
    *reply_port = kdp.reply_port;
    *len = rp-&gt;hdr.len;
    
    <span class="enscript-keyword">return</span> (TRUE);
}

<span class="enscript-type">static</span> boolean_t
<span class="enscript-function-name">kdp_writemem</span>(
    kdp_pkt_t		*pkt,
    <span class="enscript-type">int</span>			*len,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
    kdp_writemem_req_t	*rq = &amp;pkt-&gt;writemem_req;
    size_t		plen = *len;
    kdp_writemem_reply_t *rp = &amp;pkt-&gt;writemem_reply;
    mach_vm_size_t 	cnt;

    <span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
	<span class="enscript-keyword">return</span> (FALSE);

    <span class="enscript-keyword">if</span> (rq-&gt;nbytes &gt; MAX_KDP_DATA_SIZE)
	rp-&gt;error = KDPERR_BAD_NBYTES;
    <span class="enscript-keyword">else</span> {
	dprintf((<span class="enscript-string">&quot;kdp_writemem addr %x size %d\n&quot;</span>, rq-&gt;address, rq-&gt;nbytes));
	cnt = kdp_machine_vm_write((caddr_t)rq-&gt;data, (mach_vm_address_t)rq-&gt;address, rq-&gt;nbytes);
	rp-&gt;error = KDPERR_ACCESS(rq-&gt;nbytes, cnt);
	dprintf((<span class="enscript-string">&quot;  cnt %lld error %d\n&quot;</span>, cnt, rp-&gt;error));
    }

    rp-&gt;hdr.is_reply = 1;
    rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);

    *reply_port = kdp.reply_port;
    *len = rp-&gt;hdr.len;
    
    <span class="enscript-keyword">return</span> (TRUE);
}

<span class="enscript-type">static</span> boolean_t
<span class="enscript-function-name">kdp_writemem64</span>(
    kdp_pkt_t		*pkt,
    <span class="enscript-type">int</span>			*len,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
    kdp_writemem64_req_t	*rq = &amp;pkt-&gt;writemem64_req;
    size_t		plen = *len;
    kdp_writemem64_reply_t *rp = &amp;pkt-&gt;writemem64_reply;
    mach_vm_size_t 		cnt;
	
    <span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
		<span class="enscript-keyword">return</span> (FALSE);
	
    <span class="enscript-keyword">if</span> (rq-&gt;nbytes &gt; MAX_KDP_DATA_SIZE)
	rp-&gt;error = KDPERR_BAD_NBYTES;
    <span class="enscript-keyword">else</span> {
	dprintf((<span class="enscript-string">&quot;kdp_writemem64 addr %llx size %d\n&quot;</span>, rq-&gt;address, rq-&gt;nbytes));
	cnt = kdp_machine_vm_write((caddr_t)rq-&gt;data, (mach_vm_address_t)rq-&gt;address, (mach_vm_size_t)rq-&gt;nbytes);
	rp-&gt;error = KDPERR_ACCESS(rq-&gt;nbytes, cnt);
	dprintf((<span class="enscript-string">&quot;  cnt %lld error %d\n&quot;</span>, cnt, rp-&gt;error));
    }
	
    rp-&gt;hdr.is_reply = 1;
    rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);
	
    *reply_port = kdp.reply_port;
    *len = rp-&gt;hdr.len;
    
    <span class="enscript-keyword">return</span> (TRUE);
}

<span class="enscript-type">static</span> boolean_t
<span class="enscript-function-name">kdp_writephysmem64</span>(
    kdp_pkt_t		*pkt,
    <span class="enscript-type">int</span>			*len,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
    kdp_writephysmem64_req_t	*rq = &amp;pkt-&gt;writephysmem64_req;
    size_t		plen = *len;
    kdp_writephysmem64_reply_t *rp = &amp;pkt-&gt;writephysmem64_reply;
    mach_vm_size_t 		cnt;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>		size;
	
    <span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
	<span class="enscript-keyword">return</span> (FALSE);
	
    size = rq-&gt;nbytes;
    <span class="enscript-keyword">if</span> (size &gt; MAX_KDP_DATA_SIZE)
	rp-&gt;error = KDPERR_BAD_NBYTES;
    <span class="enscript-keyword">else</span> {
	dprintf((<span class="enscript-string">&quot;kdp_writephysmem64 addr %llx size %d\n&quot;</span>, rq-&gt;address, size));
	cnt = kdp_machine_phys_write(rq, rq-&gt;data, rq-&gt;lcpu);
	rp-&gt;error = KDPERR_ACCESS(size, cnt);
	dprintf((<span class="enscript-string">&quot;  cnt %lld error %d\n&quot;</span>, cnt, rp-&gt;error));
    }
	
    rp-&gt;hdr.is_reply = 1;
    rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);
	
    *reply_port = kdp.reply_port;
    *len = rp-&gt;hdr.len;
    
    <span class="enscript-keyword">return</span> (TRUE);
}

<span class="enscript-type">static</span> boolean_t
<span class="enscript-function-name">kdp_readmem</span>(
    kdp_pkt_t		*pkt,
    <span class="enscript-type">int</span>			*len,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
    kdp_readmem_req_t	*rq = &amp;pkt-&gt;readmem_req;
    size_t		plen = *len;
    kdp_readmem_reply_t *rp = &amp;pkt-&gt;readmem_reply;
    mach_vm_size_t	cnt;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>	size;

    <span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
	<span class="enscript-keyword">return</span> (FALSE);

    rp-&gt;hdr.is_reply = 1;
    rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);

    size = rq-&gt;nbytes;
    <span class="enscript-keyword">if</span> (size &gt; MAX_KDP_DATA_SIZE)
	rp-&gt;error = KDPERR_BAD_NBYTES;
    <span class="enscript-keyword">else</span> {
	dprintf((<span class="enscript-string">&quot;kdp_readmem addr %x size %d\n&quot;</span>, rq-&gt;address, size));
	cnt = kdp_machine_vm_read((mach_vm_address_t)rq-&gt;address, (caddr_t)rp-&gt;data, rq-&gt;nbytes);
	rp-&gt;error = KDPERR_ACCESS(size, cnt);
	dprintf((<span class="enscript-string">&quot;  cnt %lld error %d\n&quot;</span>, cnt, rp-&gt;error));

	rp-&gt;hdr.len += cnt;
    }

    *reply_port = kdp.reply_port;
    *len = rp-&gt;hdr.len;
    
    <span class="enscript-keyword">return</span> (TRUE);
}

<span class="enscript-type">static</span> boolean_t
<span class="enscript-function-name">kdp_readmem64</span>(
    kdp_pkt_t		*pkt,
    <span class="enscript-type">int</span>			*len,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
    kdp_readmem64_req_t	*rq = &amp;pkt-&gt;readmem64_req;
    size_t		plen = *len;
    kdp_readmem64_reply_t *rp = &amp;pkt-&gt;readmem64_reply;
    mach_vm_size_t	cnt;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>	size;

    <span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
		<span class="enscript-keyword">return</span> (FALSE);
	
    rp-&gt;hdr.is_reply = 1;
    rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);
	
    size = rq-&gt;nbytes;
    <span class="enscript-keyword">if</span> (size &gt; MAX_KDP_DATA_SIZE)
	rp-&gt;error = KDPERR_BAD_NBYTES;
    <span class="enscript-keyword">else</span> {
	dprintf((<span class="enscript-string">&quot;kdp_readmem64 addr %llx size %d\n&quot;</span>, rq-&gt;address, size));
	cnt = kdp_machine_vm_read((mach_vm_address_t)rq-&gt;address, (caddr_t)rp-&gt;data, rq-&gt;nbytes);
	rp-&gt;error = KDPERR_ACCESS(size, cnt);
	dprintf((<span class="enscript-string">&quot;  cnt %lld error %d\n&quot;</span>, cnt, rp-&gt;error));
		
	rp-&gt;hdr.len += cnt;
    }
	
    *reply_port = kdp.reply_port;
    *len = rp-&gt;hdr.len;
    
    <span class="enscript-keyword">return</span> (TRUE);
}

<span class="enscript-type">static</span> boolean_t
<span class="enscript-function-name">kdp_readphysmem64</span>(
    kdp_pkt_t		*pkt,
    <span class="enscript-type">int</span>			*len,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
    kdp_readphysmem64_req_t	*rq = &amp;pkt-&gt;readphysmem64_req;
    size_t		plen = *len;
    kdp_readphysmem64_reply_t *rp = &amp;pkt-&gt;readphysmem64_reply;
    mach_vm_size_t	cnt;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>	size;

    <span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
	<span class="enscript-keyword">return</span> (FALSE);
	
    rp-&gt;hdr.is_reply = 1;
    rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);
	
    size = rq-&gt;nbytes;
    <span class="enscript-keyword">if</span> (size &gt; MAX_KDP_DATA_SIZE)
	rp-&gt;error = KDPERR_BAD_NBYTES;
    <span class="enscript-keyword">else</span> {
	dprintf((<span class="enscript-string">&quot;kdp_readphysmem64 addr %llx size %d\n&quot;</span>, rq-&gt;address, size));
	cnt = kdp_machine_phys_read(rq, rp-&gt;data, rq-&gt;lcpu);
	rp-&gt;error = KDPERR_ACCESS(size, cnt);
	dprintf((<span class="enscript-string">&quot;  cnt %lld error %d\n&quot;</span>, cnt, rp-&gt;error));
		
	rp-&gt;hdr.len += cnt;
    }
	
    *reply_port = kdp.reply_port;
    *len = rp-&gt;hdr.len;
    
    <span class="enscript-keyword">return</span> (TRUE);
}

<span class="enscript-type">static</span> boolean_t
<span class="enscript-function-name">kdp_maxbytes</span>(
    kdp_pkt_t		*pkt,
    <span class="enscript-type">int</span>			*len,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
    kdp_maxbytes_req_t	*rq = &amp;pkt-&gt;maxbytes_req;
    size_t		plen = *len;
    kdp_maxbytes_reply_t *rp = &amp;pkt-&gt;maxbytes_reply;

    <span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
	<span class="enscript-keyword">return</span> (FALSE);

    rp-&gt;hdr.is_reply = 1;
    rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);

    dprintf((<span class="enscript-string">&quot;kdp_maxbytes\n&quot;</span>));

    rp-&gt;max_bytes = MAX_KDP_DATA_SIZE;

    *reply_port = kdp.reply_port;
    *len = rp-&gt;hdr.len;
    
    <span class="enscript-keyword">return</span> (TRUE);
}

<span class="enscript-type">static</span> boolean_t
<span class="enscript-function-name">kdp_version</span>(
    kdp_pkt_t		*pkt,
    <span class="enscript-type">int</span>			*len,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
    kdp_version_req_t	*rq = &amp;pkt-&gt;version_req;
    size_t		plen = *len;
    kdp_version_reply_t *rp = &amp;pkt-&gt;version_reply;

    <span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
	<span class="enscript-keyword">return</span> (FALSE);

    rp-&gt;hdr.is_reply = 1;
    rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);

    dprintf((<span class="enscript-string">&quot;kdp_version\n&quot;</span>));

    rp-&gt;version = KDP_VERSION;
    <span class="enscript-keyword">if</span> (!(kdp_flag &amp; KDP_BP_DIS))
      rp-&gt;feature = KDP_FEATURE_BP;
    <span class="enscript-keyword">else</span>
      rp-&gt;feature = 0;
	
    *reply_port = kdp.reply_port;
    *len = rp-&gt;hdr.len;
    
    <span class="enscript-keyword">return</span> (TRUE);
}

<span class="enscript-type">static</span> boolean_t
<span class="enscript-function-name">kdp_regions</span>(
    kdp_pkt_t		*pkt,
    <span class="enscript-type">int</span>			*len,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
    kdp_regions_req_t	*rq = &amp;pkt-&gt;regions_req;
    size_t		plen = *len;
    kdp_regions_reply_t *rp = &amp;pkt-&gt;regions_reply;
    kdp_region_t	*r;	

    <span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
	<span class="enscript-keyword">return</span> (FALSE);

    rp-&gt;hdr.is_reply = 1;
    rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);

    dprintf((<span class="enscript-string">&quot;kdp_regions\n&quot;</span>));

    r = rp-&gt;regions;
    rp-&gt;nregions = 0;

    r-&gt;address = 0;
    r-&gt;nbytes = 0xffffffff;

    r-&gt;protection = VM_PROT_ALL; r++; rp-&gt;nregions++;
    
    rp-&gt;hdr.len += rp-&gt;nregions * <span class="enscript-keyword">sizeof</span> (kdp_region_t);
    
    *reply_port = kdp.reply_port;
    *len = rp-&gt;hdr.len;
    
    <span class="enscript-keyword">return</span> (TRUE);
}

<span class="enscript-type">static</span> boolean_t
<span class="enscript-function-name">kdp_writeregs</span>(
    kdp_pkt_t		*pkt,
    <span class="enscript-type">int</span>			*len,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
    kdp_writeregs_req_t	*rq = &amp;pkt-&gt;writeregs_req;
    size_t		plen = *len;
    <span class="enscript-type">int</span>			size;
    kdp_writeregs_reply_t *rp = &amp;pkt-&gt;writeregs_reply;

    <span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
	<span class="enscript-keyword">return</span> (FALSE);
    
    size = rq-&gt;hdr.len - (<span class="enscript-type">unsigned</span>)<span class="enscript-keyword">sizeof</span>(kdp_hdr_t) - (<span class="enscript-type">unsigned</span>)<span class="enscript-keyword">sizeof</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>);
    rp-&gt;error = kdp_machine_write_regs(rq-&gt;cpu, rq-&gt;flavor, rq-&gt;data, &amp;size);

    rp-&gt;hdr.is_reply = 1;
    rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);
    
    *reply_port = kdp.reply_port;
    *len = rp-&gt;hdr.len;
    
    <span class="enscript-keyword">return</span> (TRUE);
}

<span class="enscript-type">static</span> boolean_t
<span class="enscript-function-name">kdp_readregs</span>(
    kdp_pkt_t		*pkt,
    <span class="enscript-type">int</span>			*len,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
    kdp_readregs_req_t	*rq = &amp;pkt-&gt;readregs_req;
    size_t		plen = *len;
    kdp_readregs_reply_t *rp = &amp;pkt-&gt;readregs_reply;
    <span class="enscript-type">int</span>			size;

    <span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
	<span class="enscript-keyword">return</span> (FALSE);

    rp-&gt;hdr.is_reply = 1;
    rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);
    
    rp-&gt;error = kdp_machine_read_regs(rq-&gt;cpu, rq-&gt;flavor, rp-&gt;data, &amp;size);
    rp-&gt;hdr.len += size;
    
    *reply_port = kdp.reply_port;
    *len = rp-&gt;hdr.len;
    
    <span class="enscript-keyword">return</span> (TRUE);
}


boolean_t 
<span class="enscript-function-name">kdp_breakpoint_set</span>(
    kdp_pkt_t		*pkt,
    <span class="enscript-type">int</span>			*len,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
	kdp_breakpoint_req_t	*rq = &amp;pkt-&gt;breakpoint_req;
	kdp_breakpoint_reply_t *rp = &amp;pkt-&gt;breakpoint_reply;
	size_t		plen = *len;
	kdp_error_t	kerr;
	
	<span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
		<span class="enscript-keyword">return</span> (FALSE);
	
	dprintf((<span class="enscript-string">&quot;kdp_breakpoint_set %x\n&quot;</span>, rq-&gt;address));

	kerr = kdp_set_breakpoint_internal((mach_vm_address_t)rq-&gt;address);
	
	rp-&gt;error = kerr; 
	
	rp-&gt;hdr.is_reply = 1;
	rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);
	*reply_port = kdp.reply_port;
	*len = rp-&gt;hdr.len;
	
	<span class="enscript-keyword">return</span> (TRUE);
}

boolean_t 
<span class="enscript-function-name">kdp_breakpoint64_set</span>(
    kdp_pkt_t		*pkt,
    <span class="enscript-type">int</span>			*len,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
	kdp_breakpoint64_req_t	*rq = &amp;pkt-&gt;breakpoint64_req;
	kdp_breakpoint64_reply_t *rp = &amp;pkt-&gt;breakpoint64_reply;
	size_t		plen = *len;
	kdp_error_t	kerr;
	
	<span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
		<span class="enscript-keyword">return</span> (FALSE);
	
	dprintf((<span class="enscript-string">&quot;kdp_breakpoint64_set %llx\n&quot;</span>, rq-&gt;address));

	kerr = kdp_set_breakpoint_internal((mach_vm_address_t)rq-&gt;address);
	
	rp-&gt;error = kerr; 
	
	rp-&gt;hdr.is_reply = 1;
	rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);
	*reply_port = kdp.reply_port;
	*len = rp-&gt;hdr.len;
	
	<span class="enscript-keyword">return</span> (TRUE);
}

boolean_t 
<span class="enscript-function-name">kdp_breakpoint_remove</span>(
    kdp_pkt_t		*pkt,
    <span class="enscript-type">int</span>			*len,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
	kdp_breakpoint_req_t	*rq = &amp;pkt-&gt;breakpoint_req;
	kdp_breakpoint_reply_t *rp = &amp;pkt-&gt;breakpoint_reply;
	size_t		plen = *len;
	kdp_error_t	kerr;
	<span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
		<span class="enscript-keyword">return</span> (FALSE);
	
	dprintf((<span class="enscript-string">&quot;kdp_breakpoint_remove %x\n&quot;</span>, rq-&gt;address));

	kerr = kdp_remove_breakpoint_internal((mach_vm_address_t)rq-&gt;address);
	
	rp-&gt;error = kerr; 
	
	rp-&gt;hdr.is_reply = 1;
	rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);
	*reply_port = kdp.reply_port;
	*len = rp-&gt;hdr.len;
	
	<span class="enscript-keyword">return</span> (TRUE);
}

boolean_t 
<span class="enscript-function-name">kdp_breakpoint64_remove</span>(
    kdp_pkt_t		*pkt,
    <span class="enscript-type">int</span>			*len,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
	kdp_breakpoint64_req_t	*rq = &amp;pkt-&gt;breakpoint64_req;
	kdp_breakpoint64_reply_t *rp = &amp;pkt-&gt;breakpoint64_reply;
	size_t		plen = *len;
	kdp_error_t	kerr;
	
	<span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
		<span class="enscript-keyword">return</span> (FALSE);
	
	dprintf((<span class="enscript-string">&quot;kdp_breakpoint64_remove %llx\n&quot;</span>, rq-&gt;address));

	kerr = kdp_remove_breakpoint_internal((mach_vm_address_t)rq-&gt;address);
	
	rp-&gt;error = kerr; 
	
	rp-&gt;hdr.is_reply = 1;
	rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);
	*reply_port = kdp.reply_port;
	*len = rp-&gt;hdr.len;
	
	<span class="enscript-keyword">return</span> (TRUE);
}


kdp_error_t
<span class="enscript-function-name">kdp_set_breakpoint_internal</span>(
    mach_vm_address_t	address
)
{
	
	uint8_t		breakinstr[MAX_BREAKINSN_BYTES], oldinstr[MAX_BREAKINSN_BYTES];
	uint32_t	breakinstrsize = <span class="enscript-keyword">sizeof</span>(breakinstr);
	mach_vm_size_t	cnt;
	<span class="enscript-type">int</span>			i;
	
	kdp_machine_get_breakinsn(breakinstr, &amp;breakinstrsize);
	
	<span class="enscript-keyword">if</span>(breakpoints_initialized == 0)
    {
		<span class="enscript-keyword">for</span>(i=0;(i &lt; MAX_BREAKPOINTS); breakpoint_list[i].address=0, i++);
		breakpoints_initialized++;
    }
	
	cnt = kdp_machine_vm_read(address, (caddr_t)&amp;oldinstr, (mach_vm_size_t)breakinstrsize);
	
	<span class="enscript-keyword">if</span> (0 == memcmp(oldinstr, breakinstr, breakinstrsize)) {
		printf(<span class="enscript-string">&quot;A trap was already set at that address, not setting new breakpoint\n&quot;</span>);
		
		<span class="enscript-keyword">return</span> KDPERR_BREAKPOINT_ALREADY_SET;
	}
	
	<span class="enscript-keyword">for</span>(i=0;(i &lt; MAX_BREAKPOINTS) &amp;&amp; (breakpoint_list[i].address != 0); i++);
	
	<span class="enscript-keyword">if</span> (i == MAX_BREAKPOINTS) {
		<span class="enscript-keyword">return</span> KDPERR_MAX_BREAKPOINTS;
	}
	
	breakpoint_list[i].address =  address;
	memcpy(breakpoint_list[i].oldbytes, oldinstr, breakinstrsize);
	breakpoint_list[i].bytesused =  breakinstrsize;
	
	cnt = kdp_machine_vm_write((caddr_t)&amp;breakinstr, address, breakinstrsize);
	
	<span class="enscript-keyword">return</span> KDPERR_NO_ERROR;
}

kdp_error_t
<span class="enscript-function-name">kdp_remove_breakpoint_internal</span>(
    mach_vm_address_t	address
)
{
	mach_vm_size_t	cnt;
	<span class="enscript-type">int</span>		i;
	
	<span class="enscript-keyword">for</span>(i=0;(i &lt; MAX_BREAKPOINTS) &amp;&amp; (breakpoint_list[i].address != address); i++);
	
	<span class="enscript-keyword">if</span> (i == MAX_BREAKPOINTS)
	{
		<span class="enscript-keyword">return</span> KDPERR_BREAKPOINT_NOT_FOUND; 
	}
	
	breakpoint_list[i].address = 0;
	cnt = kdp_machine_vm_write((caddr_t)&amp;breakpoint_list[i].oldbytes, address, breakpoint_list[i].bytesused);
	
	<span class="enscript-keyword">return</span> KDPERR_NO_ERROR;
}

boolean_t
<span class="enscript-function-name">kdp_remove_all_breakpoints</span>(<span class="enscript-type">void</span>)
{
	<span class="enscript-type">int</span> i;
	boolean_t breakpoint_found = FALSE;
	
	<span class="enscript-keyword">if</span> (breakpoints_initialized)
	{
		<span class="enscript-keyword">for</span>(i=0;i &lt; MAX_BREAKPOINTS; i++)
		{
			<span class="enscript-keyword">if</span> (breakpoint_list[i].address)
			{
				kdp_machine_vm_write((caddr_t)&amp;(breakpoint_list[i].oldbytes), (mach_vm_address_t)breakpoint_list[i].address, (mach_vm_size_t)breakpoint_list[i].bytesused);
				breakpoint_found = TRUE;
				breakpoint_list[i].address = 0;
			}
		}
		
		<span class="enscript-keyword">if</span> (breakpoint_found)
			printf(<span class="enscript-string">&quot;kdp_remove_all_breakpoints: found extant breakpoints, removing them.\n&quot;</span>);
	}
	<span class="enscript-keyword">return</span> breakpoint_found;
}

boolean_t
<span class="enscript-function-name">kdp_reboot</span>(
	__unused kdp_pkt_t *pkt,
	__unused <span class="enscript-type">int</span>	*len,
	__unused <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span> *reply_port
)
{
	dprintf((<span class="enscript-string">&quot;kdp_reboot\n&quot;</span>));

	kdp_machine_reboot();
	
	<span class="enscript-keyword">return</span> (TRUE); <span class="enscript-comment">// no, not really, we won't return
</span>}

<span class="enscript-type">static</span> boolean_t
<span class="enscript-function-name">kdp_readioport</span>(
    kdp_pkt_t		*pkt,
    <span class="enscript-type">int</span>			*len,
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
	       )
{
	kdp_readioport_req_t   *rq = &amp;pkt-&gt;readioport_req;
	kdp_readioport_reply_t *rp = &amp;pkt-&gt;readioport_reply;
	size_t plen = *len;

	<span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
		<span class="enscript-keyword">return</span> (FALSE);
	
	rp-&gt;hdr.is_reply = 1;
	rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);
	
	<span class="enscript-keyword">if</span> (rq-&gt;nbytes &gt; MAX_KDP_DATA_SIZE)
		rp-&gt;error = KDPERR_BAD_NBYTES;
	<span class="enscript-keyword">else</span> {
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">KDP_TEST_HARNESS</span>
                uint16_t addr = rq-&gt;address;
#<span class="enscript-reference">endif</span>
		uint16_t size = rq-&gt;nbytes;
		dprintf((<span class="enscript-string">&quot;kdp_readioport addr %x size %d\n&quot;</span>, addr, size));

		rp-&gt;error = kdp_machine_ioport_read(rq, rp-&gt;data, rq-&gt;lcpu);
		<span class="enscript-keyword">if</span> (rp-&gt;error == KDPERR_NO_ERROR)
			rp-&gt;hdr.len += size;
	}
	
	*reply_port = kdp.reply_port;
	*len = rp-&gt;hdr.len;
    
	<span class="enscript-keyword">return</span> (TRUE);
}

<span class="enscript-type">static</span> boolean_t
<span class="enscript-function-name">kdp_writeioport</span>(
	kdp_pkt_t	*pkt,
	<span class="enscript-type">int</span>		*len,
	<span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
                )
{
	kdp_writeioport_req_t   *rq = &amp;pkt-&gt;writeioport_req;
	kdp_writeioport_reply_t *rp = &amp;pkt-&gt;writeioport_reply;
	size_t	plen = *len;
	
	<span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
		<span class="enscript-keyword">return</span> (FALSE);
	
	<span class="enscript-keyword">if</span> (rq-&gt;nbytes &gt; MAX_KDP_DATA_SIZE)
		rp-&gt;error = KDPERR_BAD_NBYTES;
	<span class="enscript-keyword">else</span> {
		dprintf((<span class="enscript-string">&quot;kdp_writeioport addr %x size %d\n&quot;</span>, rq-&gt;address, 
			rq-&gt;nbytes));
		
		rp-&gt;error = kdp_machine_ioport_write(rq, rq-&gt;data, rq-&gt;lcpu);
	}
	
	rp-&gt;hdr.is_reply = 1;
	rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);
	
	*reply_port = kdp.reply_port;
	*len = rp-&gt;hdr.len;
    
	<span class="enscript-keyword">return</span> (TRUE);
}

<span class="enscript-type">static</span> boolean_t
<span class="enscript-function-name">kdp_readmsr64</span>(
	kdp_pkt_t		*pkt,
	<span class="enscript-type">int</span>			*len,
	<span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
)
{
	kdp_readmsr64_req_t   *rq = &amp;pkt-&gt;readmsr64_req;
	kdp_readmsr64_reply_t *rp = &amp;pkt-&gt;readmsr64_reply;
	size_t plen = *len;

	<span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
		<span class="enscript-keyword">return</span> (FALSE);
	
	rp-&gt;hdr.is_reply = 1;
	rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);
	
	dprintf((<span class="enscript-string">&quot;kdp_readmsr64 lcpu %x addr %x\n&quot;</span>, rq-&gt;lcpu, rq-&gt;address));
	rp-&gt;error = kdp_machine_msr64_read(rq, rp-&gt;data, rq-&gt;lcpu);
	<span class="enscript-keyword">if</span> (rp-&gt;error == KDPERR_NO_ERROR)
		rp-&gt;hdr.len += <span class="enscript-keyword">sizeof</span>(uint64_t);
	
	*reply_port = kdp.reply_port;
	*len = rp-&gt;hdr.len;
    
	<span class="enscript-keyword">return</span> (TRUE);
}

<span class="enscript-type">static</span> boolean_t
<span class="enscript-function-name">kdp_writemsr64</span>(
	kdp_pkt_t	*pkt,
	<span class="enscript-type">int</span>		*len,
	<span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
	       )
{
	kdp_writemsr64_req_t   *rq = &amp;pkt-&gt;writemsr64_req;
	kdp_writemsr64_reply_t *rp = &amp;pkt-&gt;writemsr64_reply;
	size_t	plen = *len;
	
	<span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
		<span class="enscript-keyword">return</span> (FALSE);
	
	dprintf((<span class="enscript-string">&quot;kdp_writemsr64 lcpu %x addr %x\n&quot;</span>, rq-&gt;lcpu, rq-&gt;address)); 
	rp-&gt;error = kdp_machine_msr64_write(rq, rq-&gt;data, rq-&gt;lcpu);
	
	rp-&gt;hdr.is_reply = 1;
	rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);
	
	*reply_port = kdp.reply_port;
	*len = rp-&gt;hdr.len;
    
	<span class="enscript-keyword">return</span> (TRUE);
}

<span class="enscript-type">static</span> boolean_t
<span class="enscript-function-name">kdp_dumpinfo</span>(
	kdp_pkt_t	*pkt,
	<span class="enscript-type">int</span>		*len,
	<span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	*reply_port
	       )
{
	kdp_dumpinfo_req_t   *rq = &amp;pkt-&gt;dumpinfo_req;
	kdp_dumpinfo_reply_t *rp = &amp;pkt-&gt;dumpinfo_reply;
	size_t	plen = *len;
	
	<span class="enscript-keyword">if</span> (plen &lt; <span class="enscript-keyword">sizeof</span> (*rq))
		<span class="enscript-keyword">return</span> (FALSE);
	
	dprintf((<span class="enscript-string">&quot;kdp_dumpinfo file=%s destip=%s routerip=%s\n&quot;</span>, rq-&gt;name, rq-&gt;destip, rq-&gt;routerip));
	rp-&gt;hdr.is_reply = 1;
	rp-&gt;hdr.len = <span class="enscript-keyword">sizeof</span> (*rp);
	
        <span class="enscript-keyword">if</span> ((rq-&gt;type &amp; KDP_DUMPINFO_MASK) != KDP_DUMPINFO_GETINFO) {
            kdp_set_dump_info(rq-&gt;type, rq-&gt;name, rq-&gt;destip, rq-&gt;routerip, 
                                rq-&gt;port);
        }

        <span class="enscript-comment">/* gather some stats for reply */</span>
        kdp_get_dump_info(&amp;rp-&gt;type, rp-&gt;name, rp-&gt;destip, rp-&gt;routerip, 
                          &amp;rp-&gt;port);

	*reply_port = kdp.reply_port;
	*len = rp-&gt;hdr.len;
    
	<span class="enscript-keyword">return</span> (TRUE);
}

</pre>
<hr />
</body></html>