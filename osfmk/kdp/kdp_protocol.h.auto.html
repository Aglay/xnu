<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>kdp_protocol.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">kdp_protocol.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_KDP_PROTOCOL_H_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_KDP_PROTOCOL_H_</span>

<span class="enscript-comment">/*
 * Definition of remote debugger protocol.
 */</span>


#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">MACH_KERNEL_PRIVATE</span>
#<span class="enscript-reference">include</span>	<span class="enscript-string">&lt;mach/vm_prot.h&gt;</span>
#<span class="enscript-reference">include</span>	<span class="enscript-string">&lt;stdint.h&gt;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KDP_PROXY_PACK_SUPPORT</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">pack</span>(1)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KDP_PACKED</span>
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KDP_PACKED</span> __attribute__((packed))
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">/*
 * Retransmit parameters
 */</span>
#<span class="enscript-reference">if</span>	<span class="enscript-variable-name">DDEBUG_DEBUG</span> || <span class="enscript-variable-name">DEBUG_DEBUG</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">KDP_REXMIT_SECS</span>		20	<span class="enscript-comment">/* rexmit if no ack in 3 secs */</span>
#<span class="enscript-reference">else</span>	<span class="enscript-comment">/* DDEBUG_DEBUG || DEBUG_DEBUG */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">KDP_REXMIT_SECS</span>		3	<span class="enscript-comment">/* rexmit if no ack in 3 secs */</span>
#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* DDEBUG_DEBUG || DEBUG_DEBUG */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">KDP_REXMIT_TRIES</span>	8	<span class="enscript-comment">/* xmit 8 times, then give up */</span>


<span class="enscript-comment">/*
 * (NMI) Attention Max Wait Time
 * Remote will resume unless KDP requests is received within this
 * many seconds after an attention (nmi) packet is sent.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">KDP_MAX_ATTN_WAIT</span>	30	<span class="enscript-comment">/* wait max of 30 seconds */</span>

<span class="enscript-comment">/*
 * Well-known UDP port, debugger side.
 * FIXME: This is what the 68K guys use, but beats me how they chose it...
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">KDP_REMOTE_PORT</span>		41139	<span class="enscript-comment">/* pick one and register it */</span>

<span class="enscript-comment">/*
 * UDP ports, KDB side. 5 port numbers are reserved for each port (request
 * and exception). This allows multiple KDBs to run on one host.
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">UDP_HOST_COMM_BASE</span>	41140
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">UDP_HOST_EXCEP_BASE</span>	41145
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">NUM_UDP_HOST_PORTS</span>	5

<span class="enscript-comment">/*
 * Requests
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> {
	<span class="enscript-comment">/* connection oriented requests */</span>
	KDP_CONNECT,	KDP_DISCONNECT,

	<span class="enscript-comment">/* obtaining client info */</span>
	KDP_HOSTINFO,	KDP_VERSION,	KDP_MAXBYTES,
	
	<span class="enscript-comment">/* memory access */</span>
	KDP_READMEM,	KDP_WRITEMEM,
	
	<span class="enscript-comment">/* register access */</span>
	KDP_READREGS,	KDP_WRITEREGS,
	
	<span class="enscript-comment">/* executable image info */</span>
	KDP_LOAD,	KDP_IMAGEPATH,
	
	<span class="enscript-comment">/* execution control */</span>
	KDP_SUSPEND,	KDP_RESUMECPUS,
	
	<span class="enscript-comment">/* exception and termination notification, NOT true requests */</span>
	KDP_EXCEPTION,	KDP_TERMINATION,

	<span class="enscript-comment">/* breakpoint control */</span>
	KDP_BREAKPOINT_SET, KDP_BREAKPOINT_REMOVE,
	
	<span class="enscript-comment">/* vm regions */</span>
	KDP_REGIONS,

	<span class="enscript-comment">/* reattach to a connected host */</span>
	KDP_REATTACH,

	<span class="enscript-comment">/* remote reboot request */</span>
	KDP_HOSTREBOOT,

	<span class="enscript-comment">/* memory access (64-bit wide addresses). Version 11 protocol */</span>
	KDP_READMEM64,	KDP_WRITEMEM64,

	<span class="enscript-comment">/* breakpoint control (64-bit wide addresses). Version 11 protocol */</span>
	KDP_BREAKPOINT64_SET, KDP_BREAKPOINT64_REMOVE,
	
	<span class="enscript-comment">/* kernel version string, like &quot;xnu-1234.5~6&quot;. Version 11 protocol */</span>
	KDP_KERNELVERSION,
	
	<span class="enscript-comment">/* physical memory access (64-bit wide addresses). Version 12 protocol */</span>
	KDP_READPHYSMEM64,	KDP_WRITEPHYSMEM64,

        <span class="enscript-comment">/* ioport access (8-, 16-, and 32-bit) */</span>
	KDP_READIOPORT,	KDP_WRITEIOPORT,

        <span class="enscript-comment">/* msr access (64-bit) */</span>
	KDP_READMSR64,	KDP_WRITEMSR64,

        <span class="enscript-comment">/* get/dump panic/corefile info */</span>
        KDP_DUMPINFO,

	<span class="enscript-comment">/* keep this last */</span>
	KDP_INVALID_REQUEST
} kdp_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> {
        KDP_DUMPINFO_GETINFO    = 0x00000000, 
        KDP_DUMPINFO_SETINFO    = 0x00000001, 
        KDP_DUMPINFO_CORE       = 0x00000102, 
        KDP_DUMPINFO_PANICLOG   = 0x00000103, 
        KDP_DUMPINFO_SYSTEMLOG  = 0x00000104, 
        KDP_DUMPINFO_DISABLE    = 0x00000105, 
        KDP_DUMPINFO_MASK       = 0x00000FFF,
        KDP_DUMPINFO_DUMP       = 0x00000100,

        KDP_DUMPINFO_REBOOT     = 0x10000000,
        KDP_DUMPINFO_NORESUME   = 0x20000000,
        KDP_DUMPINFO_RESUME     = 0x00000000, <span class="enscript-comment">/* default behaviour */</span>
        KDP_DUMPINFO_NOINTR     = 0x40000000, <span class="enscript-comment">/* don't interrupt */</span>
        KDP_DUMPINFO_INTR       = 0x00000000, <span class="enscript-comment">/* default behaviour */</span>
} kdp_dumpinfo_t;

<span class="enscript-comment">/*
 * Common KDP packet header
 * NOTE: kgmacros has a non-symboled version of kdp_hdr_t so that some basic information.
 *       can be gathered from a kernel without any symbols. changes to this structure
 *       need to be reflected in kgmacros as well.
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
	kdp_req_t	request:7;	<span class="enscript-comment">/* kdp_req_t, request type */</span>
	<span class="enscript-type">unsigned</span>	is_reply:1;	<span class="enscript-comment">/* 0 =&gt; request, 1 =&gt; reply */</span>
	<span class="enscript-type">unsigned</span>	seq:8;		<span class="enscript-comment">/* sequence number within session */</span>
	<span class="enscript-type">unsigned</span>	len:16;		<span class="enscript-comment">/* length of entire pkt including hdr */</span>
	<span class="enscript-type">unsigned</span>	key;		<span class="enscript-comment">/* session key */</span>
} KDP_PACKED kdp_hdr_t;

<span class="enscript-comment">/*
 * KDP errors
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> {
	KDPERR_NO_ERROR = 0,
	KDPERR_ALREADY_CONNECTED,
	KDPERR_BAD_NBYTES,
	KDPERR_BADFLAVOR,		<span class="enscript-comment">/* bad flavor in w/r regs */</span>
	KDPERR_BAD_ACCESS,		<span class="enscript-comment">/* memory reference failure */</span>

	KDPERR_MAX_BREAKPOINTS = 100,
	KDPERR_BREAKPOINT_NOT_FOUND = 101,
	KDPERR_BREAKPOINT_ALREADY_SET = 102
} kdp_error_t;

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__x86_64__</span>) 
#<span class="enscript-reference">define</span> <span class="enscript-function-name">KDPERR_ACCESS</span>(_req,_ret)  \
	(((_req) == (uint32_t)(_ret)) ? KDPERR_NO_ERROR : KDPERR_BAD_ACCESS)
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">KDPERR_ACCESS</span>(req,cnt)	(KDPERR_NO_ERROR)
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* x86_64 */</span>


<span class="enscript-comment">/*
 * KDP requests and reply packet formats
 */</span>

<span class="enscript-comment">/*
 * KDP_CONNECT
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_CONNECT request */</span>
	kdp_hdr_t	hdr;
	uint16_t	req_reply_port;	<span class="enscript-comment">/* udp port which to send replies */</span>
	uint16_t	exc_note_port;	<span class="enscript-comment">/* udp port which to send exc notes */</span>
	<span class="enscript-type">char</span>		greeting[0];	<span class="enscript-comment">/* &quot;greetings&quot;, nul-terminated */</span>
} KDP_PACKED kdp_connect_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_CONNECT reply */</span>
	kdp_hdr_t	hdr;
	kdp_error_t	error;
} KDP_PACKED kdp_connect_reply_t;

<span class="enscript-comment">/*
 * KDP_DISCONNECT
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_DISCONNECT request */</span>
	kdp_hdr_t	hdr;
} KDP_PACKED kdp_disconnect_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_DISCONNECT reply */</span>
	kdp_hdr_t	hdr;
} KDP_PACKED kdp_disconnect_reply_t;

<span class="enscript-comment">/*
 * KDP_REATTACH
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
  kdp_hdr_t hdr;
  uint16_t req_reply_port; <span class="enscript-comment">/* udp port which to send replies */</span>
} KDP_PACKED kdp_reattach_req_t;

<span class="enscript-comment">/*
 * KDP_HOSTINFO
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_HOSTINFO request */</span>
	kdp_hdr_t	hdr;
} KDP_PACKED kdp_hostinfo_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
	uint32_t		cpus_mask;	<span class="enscript-comment">/* bit is 1 if cpu present */</span>
	uint32_t		cpu_type;
	uint32_t		cpu_subtype;
} KDP_PACKED kdp_hostinfo_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_HOSTINFO reply */</span>
	kdp_hdr_t	hdr;
	kdp_hostinfo_t	hostinfo;
} KDP_PACKED kdp_hostinfo_reply_t;

<span class="enscript-comment">/*
 * KDP_VERSION
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_VERSION request */</span>
	kdp_hdr_t	hdr;
} KDP_PACKED kdp_version_req_t;

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">KDP_FEATURE_BP</span>	0x1	<span class="enscript-comment">/* local breakpoint support */</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_VERSION reply */</span>
	kdp_hdr_t	hdr;
	uint32_t	version;
	uint32_t	feature;
	uint32_t	pad0;
	uint32_t	pad1;
} KDP_PACKED kdp_version_reply_t;

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">VM_PROT_VOLATILE</span>	((vm_prot_t) 0x08)	<span class="enscript-comment">/* not cacheable */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">VM_PROT_SPARSE</span>		((vm_prot_t) 0x10)	<span class="enscript-comment">/* sparse addr space */</span>

<span class="enscript-comment">/*
 * KDP_REGIONS
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_REGIONS request */</span>
	kdp_hdr_t	hdr;
} KDP_PACKED kdp_regions_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
	uint32_t	address;
	uint32_t	nbytes;
	uint32_t	protection;	<span class="enscript-comment">/* vm_prot_t */</span>
} KDP_PACKED kdp_region_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_REGIONS reply */</span>
	kdp_hdr_t	hdr;
	uint32_t	nregions;
	kdp_region_t	regions[0];
} KDP_PACKED kdp_regions_reply_t;

<span class="enscript-comment">/*
 * KDP_MAXBYTES
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_MAXBYTES request */</span>
	kdp_hdr_t	hdr;
} KDP_PACKED kdp_maxbytes_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_MAXBYTES reply */</span>
	kdp_hdr_t	hdr;
	uint32_t	max_bytes;
} KDP_PACKED kdp_maxbytes_reply_t;

<span class="enscript-comment">/*
 * KDP_READMEM
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_READMEM request */</span>
	kdp_hdr_t	hdr;
	uint32_t	address;
	uint32_t	nbytes;
} KDP_PACKED kdp_readmem_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_READMEM reply */</span>
	kdp_hdr_t	hdr;
	kdp_error_t	error;
	<span class="enscript-type">char</span>		data[0];
} KDP_PACKED kdp_readmem_reply_t;

<span class="enscript-comment">/*
 * KDP_READMEM64
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_READMEM64 request */</span>
	kdp_hdr_t	hdr;
	uint64_t	address;
	uint32_t	nbytes;
} KDP_PACKED kdp_readmem64_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_READMEM64 reply */</span>
	kdp_hdr_t	hdr;
	kdp_error_t	error;
	<span class="enscript-type">char</span>		data[0];
} KDP_PACKED kdp_readmem64_reply_t;

<span class="enscript-comment">/*
 * KDP_READPHYSMEM64
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_READPHYSMEM64 request */</span>
	kdp_hdr_t	hdr;
	uint64_t	address;
	uint32_t	nbytes;
	uint16_t        lcpu;
} KDP_PACKED kdp_readphysmem64_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_READPHYSMEM64 reply */</span>
	kdp_hdr_t	hdr;
	kdp_error_t	error;
	<span class="enscript-type">char</span>		data[0];
} KDP_PACKED kdp_readphysmem64_reply_t;

<span class="enscript-comment">/*
 * KDP_WRITEMEM
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_WRITEMEM request */</span>
	kdp_hdr_t	hdr;
	uint32_t	address;
	uint32_t	nbytes;
	<span class="enscript-type">char</span>		data[0];
} KDP_PACKED kdp_writemem_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_WRITEMEM reply */</span>
	kdp_hdr_t	hdr;
	kdp_error_t	error;
} KDP_PACKED kdp_writemem_reply_t;

<span class="enscript-comment">/*
 * KDP_WRITEMEM64
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_WRITEMEM64 request */</span>
	kdp_hdr_t	hdr;
	uint64_t	address;
	uint32_t	nbytes;
	<span class="enscript-type">char</span>		data[0];
} KDP_PACKED kdp_writemem64_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_WRITEMEM64 reply */</span>
	kdp_hdr_t	hdr;
	kdp_error_t	error;
} KDP_PACKED kdp_writemem64_reply_t;

<span class="enscript-comment">/*
 * KDP_WRITEPHYSMEM64
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_WRITEPHYSMEM64 request */</span>
	kdp_hdr_t	hdr;
	uint64_t	address;
	uint32_t	nbytes;
	uint16_t        lcpu;
	<span class="enscript-type">char</span>		data[0];
} KDP_PACKED kdp_writephysmem64_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_WRITEPHYSMEM64 reply */</span>
	kdp_hdr_t	hdr;
	kdp_error_t	error;
} KDP_PACKED kdp_writephysmem64_reply_t;

<span class="enscript-comment">/*
 * KDP_WRITEIOPORT
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_WRITEIOPORT request */</span>
	kdp_hdr_t	hdr;
	uint16_t	lcpu;
	uint16_t	address;
	uint16_t	nbytes;
	<span class="enscript-type">char</span>		data[0];
} KDP_PACKED kdp_writeioport_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_WRITEIOPORT reply */</span>
	kdp_hdr_t	hdr;
	kdp_error_t	error;
} KDP_PACKED kdp_writeioport_reply_t;

<span class="enscript-comment">/*
 * KDP_READIOPORT
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_READIOPORT request */</span>
	kdp_hdr_t	hdr;
	uint16_t	lcpu;
	uint16_t	address;
	uint16_t	nbytes;
} KDP_PACKED kdp_readioport_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_READIOPORT reply */</span>
	kdp_hdr_t	hdr;
	kdp_error_t	error;
	<span class="enscript-type">char</span>		data[0];
} KDP_PACKED kdp_readioport_reply_t;


<span class="enscript-comment">/*
 * KDP_WRITEMSR64
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_WRITEMSR64 request */</span>
	kdp_hdr_t	hdr;
	uint32_t	address;
	uint16_t	lcpu;
	<span class="enscript-type">char</span>		data[0];
} KDP_PACKED kdp_writemsr64_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_WRITEMSR64 reply */</span>
	kdp_hdr_t	hdr;
	kdp_error_t	error;
} KDP_PACKED kdp_writemsr64_reply_t;

<span class="enscript-comment">/*
 * KDP_READMSR64
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_READMSR64 request */</span>
	kdp_hdr_t	hdr;
	uint32_t	address;
	uint16_t	lcpu;
} KDP_PACKED kdp_readmsr64_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_READMSR64 reply */</span>
	kdp_hdr_t	hdr;
	kdp_error_t	error;
	<span class="enscript-type">char</span>		data[0];
} KDP_PACKED kdp_readmsr64_reply_t;


<span class="enscript-comment">/*
 * KDP_READREGS
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_READREGS request */</span>
	kdp_hdr_t	hdr;
	uint32_t	cpu;
	uint32_t	flavor;
} KDP_PACKED kdp_readregs_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_READREGS reply */</span>
	kdp_hdr_t	hdr;
	kdp_error_t	error;		<span class="enscript-comment">/* could be KDPERR_BADFLAVOR */</span>
	<span class="enscript-type">char</span>		data[0];
} KDP_PACKED kdp_readregs_reply_t;

<span class="enscript-comment">/*
 * KDP_WRITEREGS
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_WRITEREGS request */</span>
	kdp_hdr_t	hdr;
	uint32_t	cpu;
	uint32_t	flavor;
	<span class="enscript-type">char</span>		data[0];
} KDP_PACKED kdp_writeregs_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_WRITEREGS reply */</span>
	kdp_hdr_t	hdr;
	kdp_error_t	error;
} KDP_PACKED kdp_writeregs_reply_t;

<span class="enscript-comment">/*
 * KDP_LOAD
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_LOAD request */</span>
	kdp_hdr_t	hdr;
	<span class="enscript-type">char</span>		file_args[0];
} KDP_PACKED kdp_load_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_LOAD reply */</span>
	kdp_hdr_t	hdr;
	kdp_error_t	error;
} KDP_PACKED kdp_load_reply_t;

<span class="enscript-comment">/*
 * KDP_IMAGEPATH
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_IMAGEPATH request */</span>
	kdp_hdr_t	hdr;
} KDP_PACKED kdp_imagepath_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_IMAGEPATH reply */</span>
	kdp_hdr_t	hdr;
	<span class="enscript-type">char</span>		path[0];
} KDP_PACKED kdp_imagepath_reply_t;

<span class="enscript-comment">/*
 * KDP_SUSPEND
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_SUSPEND request */</span>
	kdp_hdr_t	hdr;
} KDP_PACKED kdp_suspend_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_SUSPEND reply */</span>
	kdp_hdr_t	hdr;
} KDP_PACKED kdp_suspend_reply_t;

<span class="enscript-comment">/*
 * KDP_RESUMECPUS
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_RESUMECPUS request */</span>
	kdp_hdr_t	hdr;
	uint32_t	cpu_mask;
} KDP_PACKED kdp_resumecpus_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_RESUMECPUS reply */</span>
	kdp_hdr_t	hdr;
} KDP_PACKED kdp_resumecpus_reply_t;

<span class="enscript-comment">/*
 * KDP_BREAKPOINT_SET and KDP_BREAKPOINT_REMOVE
 */</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
  kdp_hdr_t hdr;
  uint32_t	address;
} KDP_PACKED kdp_breakpoint_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
  kdp_hdr_t hdr;
  kdp_error_t error;
} KDP_PACKED kdp_breakpoint_reply_t;

<span class="enscript-comment">/*
 * KDP_BREAKPOINT64_SET and KDP_BREAKPOINT64_REMOVE
 */</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
	kdp_hdr_t hdr;
	uint64_t	address;
} KDP_PACKED kdp_breakpoint64_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
	kdp_hdr_t hdr;
	kdp_error_t error;
} KDP_PACKED kdp_breakpoint64_reply_t;

<span class="enscript-comment">/*
 * Exception notifications
 * (Exception notifications are not requests, and in fact travel from
 * the remote debugger to the gdb agent KDB.)
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* exc. info for one cpu */</span>
	uint32_t	cpu;
	<span class="enscript-comment">/*
	 * Following info is defined as
	 * per &lt;mach/exception.h&gt;
	 */</span>
	uint32_t	exception;
	uint32_t	code;
	uint32_t	subcode;
} KDP_PACKED kdp_exc_info_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_EXCEPTION notification */</span>
	kdp_hdr_t	hdr;
	uint32_t	n_exc_info;
	kdp_exc_info_t	exc_info[0];
} KDP_PACKED kdp_exception_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_EXCEPTION acknowledgement */</span>
	kdp_hdr_t	hdr;
} KDP_PACKED kdp_exception_ack_t;

<span class="enscript-comment">/*
 * KDP_KERNELVERSION
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_KERNELVERSION request */</span>
	kdp_hdr_t	hdr;
} KDP_PACKED kdp_kernelversion_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_KERNELVERSION reply */</span>
	kdp_hdr_t	hdr;
	<span class="enscript-type">char</span>		version[0];
} KDP_PACKED kdp_kernelversion_reply_t;


<span class="enscript-comment">/*
 * Child termination messages
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> {
	KDP_FAULT = 0,		<span class="enscript-comment">/* child took fault (internal use) */</span>
	KDP_EXIT,		<span class="enscript-comment">/* child exited */</span>
	KDP_POWEROFF,		<span class="enscript-comment">/* child power-off */</span>
	KDP_REBOOT,		<span class="enscript-comment">/* child reboot */</span>
	KDP_COMMAND_MODE	<span class="enscript-comment">/* child exit to mon command_mode */</span>
} kdp_termination_code_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_TERMINATION notification */</span>
	kdp_hdr_t		hdr;
	uint32_t		term_code;	<span class="enscript-comment">/* kdp_termination_code_t */</span>
	uint32_t		exit_code;
} KDP_PACKED kdp_termination_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
	kdp_hdr_t	hdr;
} KDP_PACKED kdp_termination_ack_t;

<span class="enscript-comment">/*
 * KDP_DUMPINFO
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_DUMPINFO request */</span>
	kdp_hdr_t	hdr;
        <span class="enscript-type">char</span>            name[50];       
	<span class="enscript-type">char</span>            destip[16];
	<span class="enscript-type">char</span>            routerip[16];
	uint32_t        port;
	kdp_dumpinfo_t  type;
} KDP_PACKED kdp_dumpinfo_req_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {			<span class="enscript-comment">/* KDP_DUMPINFO reply */</span>
	kdp_hdr_t	hdr;
        <span class="enscript-type">char</span>            name[50];       
	<span class="enscript-type">char</span>            destip[16];
	<span class="enscript-type">char</span>            routerip[16];
	uint32_t        port;
	kdp_dumpinfo_t  type;
} KDP_PACKED kdp_dumpinfo_reply_t;


<span class="enscript-type">typedef</span> <span class="enscript-type">union</span> {
	kdp_hdr_t		hdr;
	kdp_connect_req_t	connect_req;
	kdp_connect_reply_t	connect_reply;
	kdp_disconnect_req_t	disconnect_req;
	kdp_disconnect_reply_t	disconnect_reply;
	kdp_hostinfo_req_t	hostinfo_req;
	kdp_hostinfo_reply_t	hostinfo_reply;
	kdp_version_req_t	version_req;
	kdp_version_reply_t	version_reply;
	kdp_maxbytes_req_t	maxbytes_req;
	kdp_maxbytes_reply_t	maxbytes_reply;
	kdp_readmem_req_t	readmem_req;
	kdp_readmem_reply_t	readmem_reply;
	kdp_readmem64_req_t	readmem64_req;
	kdp_readmem64_reply_t	readmem64_reply;
	kdp_readphysmem64_req_t	readphysmem64_req;
	kdp_readphysmem64_reply_t	readphysmem64_reply;
	kdp_writemem_req_t	writemem_req;
	kdp_writemem_reply_t	writemem_reply;
	kdp_writemem64_req_t	writemem64_req;
	kdp_writemem64_reply_t	writemem64_reply;
	kdp_writephysmem64_req_t	writephysmem64_req;
	kdp_writephysmem64_reply_t	writephysmem64_reply;
	kdp_readregs_req_t	readregs_req;
	kdp_readregs_reply_t	readregs_reply;
	kdp_writeregs_req_t	writeregs_req;
	kdp_writeregs_reply_t	writeregs_reply;
	kdp_load_req_t		load_req;
	kdp_load_reply_t	load_reply;
	kdp_imagepath_req_t	imagepath_req;
	kdp_imagepath_reply_t	imagepath_reply;
	kdp_suspend_req_t	suspend_req;
	kdp_suspend_reply_t	suspend_reply;
	kdp_resumecpus_req_t	resumecpus_req;
	kdp_resumecpus_reply_t	resumecpus_reply;
	kdp_exception_t		exception;
	kdp_exception_ack_t	exception_ack;
	kdp_termination_t	termination;
	kdp_termination_ack_t	termination_ack;
	kdp_breakpoint_req_t	breakpoint_req;
	kdp_breakpoint_reply_t	breakpoint_reply;
	kdp_breakpoint64_req_t	breakpoint64_req;
	kdp_breakpoint64_reply_t	breakpoint64_reply;
	kdp_reattach_req_t	reattach_req;
	kdp_regions_req_t	regions_req;
	kdp_regions_reply_t	regions_reply;
	kdp_kernelversion_req_t	kernelversion_req;
	kdp_kernelversion_reply_t	kernelversion_reply;
	kdp_readioport_req_t	readioport_req;
	kdp_readioport_reply_t	readioport_reply;
	kdp_writeioport_req_t	writeioport_req;
	kdp_writeioport_reply_t	writeioport_reply;
	kdp_readmsr64_req_t	readmsr64_req;
	kdp_readmsr64_reply_t	readmsr64_reply;
	kdp_writemsr64_req_t	writemsr64_req;
	kdp_writemsr64_reply_t	writemsr64_reply;
	kdp_dumpinfo_req_t	dumpinfo_req;
	kdp_dumpinfo_reply_t	dumpinfo_reply;
} kdp_pkt_t;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MAX_KDP_PKT_SIZE</span>	1200	<span class="enscript-comment">/* max packet size */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MAX_KDP_DATA_SIZE</span>	1024	<span class="enscript-comment">/* max r/w data per packet */</span>

<span class="enscript-comment">/*
 * Support relatively small request/responses here.
 * If kgmacros needs to make a larger request, increase
 * this buffer size
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KDP_MANUAL_PACKET_SIZE</span> 128
<span class="enscript-type">struct</span> kdp_manual_pkt {
    <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span>	data[KDP_MANUAL_PACKET_SIZE];
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>	len;
    boolean_t		input;
} KDP_PACKED;

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KDP_PROXY_PACK_SUPPORT</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">pack</span>()
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">endif</span> // <span class="enscript-variable-name">_KDP_PROTOCOL_H_</span>
</pre>
<hr />
</body></html>