<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>vm_compressor.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">vm_compressor.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000-2013 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/kalloc.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/vm_compressor_pager.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/vm_kern.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/vm_page.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/vm_protos.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/WKdm_new.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/vm_object.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;machine/pmap.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/locks.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/kdebug.h&gt;</span>


#<span class="enscript-reference">define</span> <span class="enscript-variable-name">C_SEG_OFFSET_BITS</span>	16
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">C_SEG_BUFSIZE</span>		(1024 * 256)
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">C_SEG_MAX_PAGES</span>		(C_SEG_BUFSIZE / PAGE_SIZE)

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">C_SEG_OFF_LIMIT</span>		(C_SEG_BYTES_TO_OFFSET((C_SEG_BUFSIZE - 128)))
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">C_SEG_ALLOCSIZE</span>		(C_SEG_BUFSIZE)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">C_SEG_MAX_POPULATE_SIZE</span>	(4 * PAGE_SIZE)


#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CHECKSUM_THE_SWAP</span>		0	<span class="enscript-comment">/* Debug swap data */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CHECKSUM_THE_DATA</span>		0	<span class="enscript-comment">/* Debug compressor/decompressor data */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CHECKSUM_THE_COMPRESSED_DATA</span>	0	<span class="enscript-comment">/* Debug compressor/decompressor compressed data */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VALIDATE_C_SEGMENTS</span>		0	<span class="enscript-comment">/* Debug compaction */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">RECORD_THE_COMPRESSED_DATA</span>	0



<span class="enscript-type">struct</span> c_slot {
	uint64_t	c_offset:C_SEG_OFFSET_BITS,
		        <span class="enscript-reference">c_size</span>:12,
		        <span class="enscript-reference">c_packed_ptr</span>:36;
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CHECKSUM_THE_DATA</span>
	<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>	c_hash_data;
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CHECKSUM_THE_COMPRESSED_DATA</span>
	<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>	c_hash_compressed_data;
#<span class="enscript-reference">endif</span>

};

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">C_IS_EMPTY</span>		0
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">C_IS_FREE</span>		1
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">C_IS_FILLING</span>		2
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">C_ON_AGE_Q</span>		3
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">C_ON_SWAPOUT_Q</span>		4
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">C_ON_SWAPPEDOUT_Q</span>	5
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">C_ON_SWAPPEDOUTSPARSE_Q</span>	6
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">C_ON_SWAPPEDIN_Q</span>	7
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">C_ON_MAJORCOMPACT_Q</span>	8
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">C_ON_BAD_Q</span>		9


<span class="enscript-type">struct</span> c_segment {
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">__i386__</span> || <span class="enscript-variable-name">__x86_64__</span>
	lck_mtx_t	c_lock;
#<span class="enscript-reference">else</span> <span class="enscript-comment">/* __i386__ || __x86_64__ */</span>
	lck_spin_t	c_lock;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* __i386__ || __x86_64__ */</span>
	queue_chain_t	c_age_list;
	queue_chain_t	c_list;

	uint64_t	c_generation_id;
	int32_t		c_bytes_used;
	int32_t		c_bytes_unused;
	
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">C_SEG_MAX_LIMIT</span>		(1 &lt;&lt; 19)	<span class="enscript-comment">/* this needs to track the size of c_mysegno */</span>
	uint32_t	c_mysegno:19,
		        <span class="enscript-reference">c_busy</span>:1,
		        <span class="enscript-reference">c_busy_swapping</span>:1,
			<span class="enscript-reference">c_wanted</span>:1,
		        <span class="enscript-reference">c_on_minorcompact_q</span>:1,	<span class="enscript-comment">/* can also be on the age_q, the majorcompact_q or the swappedin_q */</span>

		        <span class="enscript-reference">c_state</span>:4,		<span class="enscript-comment">/* what state is the segment in which dictates which q to find it on */</span>
		        <span class="enscript-reference">c_overage_swap</span>:1,
		        <span class="enscript-reference">c_reserved</span>:4;

	uint16_t	c_firstemptyslot;
	uint16_t	c_nextslot;
	uint32_t	c_nextoffset;
	uint32_t	c_populated_offset;

	uint32_t	c_creation_ts;
	uint32_t	c_swappedin_ts;

	<span class="enscript-type">union</span> {
		int32_t *c_buffer;
		uint64_t c_swap_handle;
	} c_store;

#<span class="enscript-reference">if</span> 	<span class="enscript-variable-name">VALIDATE_C_SEGMENTS</span>
        uint32_t	c_was_minor_compacted;
        uint32_t	c_was_major_compacted;
	uint32_t	c_was_major_donor;
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">CHECKSUM_THE_SWAP</span>	
	<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>	cseg_hash;
	<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>	cseg_swap_size;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* CHECKSUM_THE_SWAP */</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">MACH_ASSERT</span>
	thread_t	c_busy_for_thread;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* MACH_ASSERT */</span>

	<span class="enscript-type">int</span>		c_slot_var_array_len;
	<span class="enscript-type">struct</span>	c_slot	*c_slot_var_array;
	<span class="enscript-type">struct</span>	c_slot	c_slot_fixed_array[0];
};

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">C_SEG_SLOT_VAR_ARRAY_MIN_LEN</span>	C_SEG_MAX_PAGES

<span class="enscript-type">extern</span>	<span class="enscript-type">int</span>		c_seg_fixed_array_len;
<span class="enscript-type">extern</span>	vm_offset_t	c_buffers;
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">C_SEG_BUFFER_ADDRESS</span>(c_segno)	((c_buffers + ((uint64_t)c_segno * (uint64_t)C_SEG_ALLOCSIZE)))

#<span class="enscript-reference">define</span> <span class="enscript-function-name">C_SEG_SLOT_FROM_INDEX</span>(cseg, index)	(index &lt; c_seg_fixed_array_len ? &amp;(cseg-&gt;c_slot_fixed_array[index]) : &amp;(cseg-&gt;c_slot_var_array[index - c_seg_fixed_array_len]))

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">C_SEG_OFFSET_TO_BYTES</span>(off)	((off) * (int) sizeof(int32_t))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">C_SEG_BYTES_TO_OFFSET</span>(bytes)	((bytes) / (int) sizeof(int32_t))

#<span class="enscript-reference">define</span> <span class="enscript-function-name">C_SEG_UNUSED_BYTES</span>(cseg)	(cseg-&gt;c_bytes_unused + (C_SEG_OFFSET_TO_BYTES(cseg-&gt;c_populated_offset - cseg-&gt;c_nextoffset)))

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">C_SEG_OFFSET_ALIGNMENT_MASK</span>	0x3

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">C_SEG_ONDISK_IS_SPARSE</span>(cseg)	((cseg-&gt;c_bytes_used &lt; (C_SEG_BUFSIZE / 2)) ? 1 : 0)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">C_SEG_SHOULD_MINORCOMPACT</span>(cseg)	((C_SEG_UNUSED_BYTES(cseg) &gt;= (C_SEG_BUFSIZE / 3)) ? 1 : 0)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">C_SEG_SHOULD_MAJORCOMPACT</span>(cseg)	(((cseg-&gt;c_bytes_unused + (C_SEG_BUFSIZE - C_SEG_OFFSET_TO_BYTES(c_seg-&gt;c_nextoffset))) &gt;= (C_SEG_BUFSIZE / 8)) ? 1 : 0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">C_SEG_IS_ONDISK</span>(cseg)		((cseg-&gt;c_state == C_ON_SWAPPEDOUT_Q || cseg-&gt;c_state == C_ON_SWAPPEDOUTSPARSE_Q))


#<span class="enscript-reference">define</span> <span class="enscript-function-name">C_SEG_WAKEUP_DONE</span>(cseg)				\
	MACRO_BEGIN					\
	assert((cseg)-&gt;c_busy);				\
	(cseg)-&gt;c_busy = 0;				\
	assert((cseg)-&gt;c_busy_for_thread != NULL);	\
	assert((((cseg)-&gt;c_busy_for_thread = NULL), TRUE));	\
	<span class="enscript-keyword">if</span> ((cseg)-&gt;c_wanted) {				\
		(cseg)-&gt;c_wanted = 0;			\
		thread_wakeup((event_t) (cseg));	\
	}						\
	MACRO_END

#<span class="enscript-reference">define</span> <span class="enscript-function-name">C_SEG_BUSY</span>(cseg)				\
	MACRO_BEGIN					\
	assert((cseg)-&gt;c_busy == 0);			\
	(cseg)-&gt;c_busy = 1;				\
	assert((cseg)-&gt;c_busy_for_thread == NULL);	\
	assert((((cseg)-&gt;c_busy_for_thread = current_thread()), TRUE));	\
	MACRO_END
	


<span class="enscript-type">typedef</span>	<span class="enscript-type">struct</span> c_segment *c_segment_t;
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> c_slot	*c_slot_t;

uint64_t <span class="enscript-function-name">vm_compressor_total_compressions</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">void</span> <span class="enscript-function-name">vm_wake_compactor_swapper</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">void</span> <span class="enscript-function-name">vm_thrashing_jetsam_done</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">void</span> <span class="enscript-function-name">vm_consider_waking_compactor_swapper</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">void</span> <span class="enscript-function-name">vm_consider_swapping</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">void</span> <span class="enscript-function-name">vm_compressor_flush</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">void</span> <span class="enscript-function-name">c_seg_free</span>(c_segment_t);
<span class="enscript-type">void</span> <span class="enscript-function-name">c_seg_free_locked</span>(c_segment_t);
<span class="enscript-type">void</span> <span class="enscript-function-name">c_seg_insert_into_age_q</span>(c_segment_t);

<span class="enscript-type">void</span> <span class="enscript-function-name">vm_decompressor_lock</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">void</span> <span class="enscript-function-name">vm_decompressor_unlock</span>(<span class="enscript-type">void</span>);

<span class="enscript-type">void</span> <span class="enscript-function-name">vm_compressor_delay_trim</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">void</span> <span class="enscript-function-name">vm_compressor_do_warmup</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">void</span> <span class="enscript-function-name">vm_compressor_record_warmup_start</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">void</span> <span class="enscript-function-name">vm_compressor_record_warmup_end</span>(<span class="enscript-type">void</span>);

<span class="enscript-type">int</span>			vm_wants_task_throttled(task_t);
boolean_t		vm_compression_available(<span class="enscript-type">void</span>);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		vm_compressor_swap_init(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		vm_compressor_init_locks(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> lck_rw_t		c_master_lock;

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">ENCRYPTED_SWAP</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		vm_swap_decrypt(c_segment_t);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* ENCRYPTED_SWAP */</span>

<span class="enscript-type">extern</span> <span class="enscript-type">int</span>		vm_swap_low_on_space(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> kern_return_t	vm_swap_get(vm_offset_t, uint64_t, uint64_t);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		vm_swap_free(uint64_t);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		vm_swap_consider_defragmenting(<span class="enscript-type">void</span>);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		c_seg_swapin_requeue(c_segment_t, boolean_t);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		c_seg_swapin(c_segment_t, boolean_t);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		c_seg_wait_on_busy(c_segment_t);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		c_seg_trim_tail(c_segment_t);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		c_seg_switch_state(c_segment_t, <span class="enscript-type">int</span>, boolean_t);

<span class="enscript-type">extern</span> boolean_t	fastwake_recording_in_progress;
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>		compaction_swapper_running;
<span class="enscript-type">extern</span> uint64_t		vm_swap_put_failures;

<span class="enscript-type">extern</span> <span class="enscript-type">int</span>		c_overage_swapped_count;
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>		c_overage_swapped_limit;

<span class="enscript-type">extern</span> queue_head_t	c_minor_list_head;
<span class="enscript-type">extern</span> queue_head_t	c_age_list_head;
<span class="enscript-type">extern</span> queue_head_t	c_swapout_list_head;
<span class="enscript-type">extern</span> queue_head_t	c_swappedout_list_head;
<span class="enscript-type">extern</span> queue_head_t	c_swappedout_sparse_list_head;

<span class="enscript-type">extern</span> uint32_t		c_age_count;
<span class="enscript-type">extern</span> uint32_t		c_swapout_count;
<span class="enscript-type">extern</span> uint32_t		c_swappedout_count;
<span class="enscript-type">extern</span> uint32_t		c_swappedout_sparse_count;

<span class="enscript-type">extern</span> int64_t		compressor_bytes_used;
<span class="enscript-type">extern</span> uint64_t		first_c_segment_to_warm_generation_id;
<span class="enscript-type">extern</span> uint64_t		last_c_segment_to_warm_generation_id;
<span class="enscript-type">extern</span> boolean_t	hibernate_flushing;
<span class="enscript-type">extern</span> boolean_t	hibernate_no_swapspace;
<span class="enscript-type">extern</span> uint32_t		swapout_target_age;

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">c_seg_insert_into_q</span>(queue_head_t *, c_segment_t);

<span class="enscript-type">extern</span> uint32_t	vm_compressor_minorcompact_threshold_divisor;
<span class="enscript-type">extern</span> uint32_t	vm_compressor_majorcompact_threshold_divisor;
<span class="enscript-type">extern</span> uint32_t	vm_compressor_unthrottle_threshold_divisor;
<span class="enscript-type">extern</span> uint32_t	vm_compressor_catchup_threshold_divisor;
<span class="enscript-type">extern</span> uint64_t <span class="enscript-function-name">vm_compressor_compute_elapsed_msecs</span>(clock_sec_t, clock_nsec_t, clock_sec_t, clock_nsec_t);

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PAGE_REPLACEMENT_DISALLOWED</span>(enable)	(enable == TRUE ? lck_rw_lock_shared(&amp;c_master_lock) : lck_rw_done(&amp;c_master_lock))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">PAGE_REPLACEMENT_ALLOWED</span>(enable)	(enable == TRUE ? lck_rw_lock_exclusive(&amp;c_master_lock) : lck_rw_done(&amp;c_master_lock))


#<span class="enscript-reference">define</span> <span class="enscript-variable-name">AVAILABLE_NON_COMPRESSED_MEMORY</span>		(vm_page_active_count + vm_page_inactive_count + vm_page_free_count + vm_page_speculative_count)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">AVAILABLE_MEMORY</span>			(AVAILABLE_NON_COMPRESSED_MEMORY + VM_PAGE_COMPRESSOR_COUNT)

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">VM_PAGE_COMPRESSOR_COMPACT_THRESHOLD</span>		(((AVAILABLE_MEMORY) * 10) / (vm_compressor_minorcompact_threshold_divisor ? vm_compressor_minorcompact_threshold_divisor : 1))
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">VM_PAGE_COMPRESSOR_SWAP_THRESHOLD</span>		(((AVAILABLE_MEMORY) * 10) / (vm_compressor_majorcompact_threshold_divisor ? vm_compressor_majorcompact_threshold_divisor : 1))
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">VM_PAGE_COMPRESSOR_SWAP_UNTHROTTLE_THRESHOLD</span>	(((AVAILABLE_MEMORY) * 10) / (vm_compressor_unthrottle_threshold_divisor ? vm_compressor_unthrottle_threshold_divisor : 1))
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VM_PAGE_COMPRESSOR_SWAP_CATCHUP_THRESHOLD</span>	(((AVAILABLE_MEMORY) * 10) / (vm_compressor_catchup_threshold_divisor ? vm_compressor_catchup_threshold_divisor : 1))

#<span class="enscript-reference">define</span> <span class="enscript-function-name">COMPRESSOR_NEEDS_TO_SWAP</span>() 		((AVAILABLE_NON_COMPRESSED_MEMORY &lt; VM_PAGE_COMPRESSOR_SWAP_THRESHOLD) ? 1 : 0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">VM_PAGEOUT_SCAN_NEEDS_TO_THROTTLE</span>()				\
	(vm_compressor_mode == VM_PAGER_COMPRESSOR_WITH_SWAP &amp;&amp;		\
	 ((AVAILABLE_NON_COMPRESSED_MEMORY &lt; VM_PAGE_COMPRESSOR_SWAP_CATCHUP_THRESHOLD) ? 1 : 0))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">HARD_THROTTLE_LIMIT_REACHED</span>()		((AVAILABLE_NON_COMPRESSED_MEMORY &lt; (VM_PAGE_COMPRESSOR_SWAP_UNTHROTTLE_THRESHOLD) / 2) ? 1 : 0)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">SWAPPER_NEEDS_TO_UNTHROTTLE</span>()		((AVAILABLE_NON_COMPRESSED_MEMORY &lt; VM_PAGE_COMPRESSOR_SWAP_UNTHROTTLE_THRESHOLD) ? 1 : 0)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">COMPRESSOR_NEEDS_TO_MINOR_COMPACT</span>()	((AVAILABLE_NON_COMPRESSED_MEMORY &lt; VM_PAGE_COMPRESSOR_COMPACT_THRESHOLD) ? 1 : 0)

<span class="enscript-comment">/*
 * indicate the need to do a major compaction if
 * the overall set of in-use compression segments
 * becomes sparse... on systems that support pressure
 * driven swapping, this will also cause swapouts to
 * be initiated.
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">COMPRESSOR_NEEDS_TO_MAJOR_COMPACT</span>()	(((c_segment_count &gt;= (c_segments_nearing_limit / 8)) &amp;&amp; \
						  ((c_segment_count * C_SEG_MAX_PAGES) - VM_PAGE_COMPRESSOR_COUNT) &gt; \
						  ((c_segment_count / 8) * C_SEG_MAX_PAGES)) \
						 ? 1 : 0)

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">COMPRESSOR_FREE_RESERVED_LIMIT</span>		128

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">COMPRESSOR_SCRATCH_BUF_SIZE</span> WKdm_SCRATCH_BUF_SIZE


#<span class="enscript-reference">if</span> <span class="enscript-variable-name">RECORD_THE_COMPRESSED_DATA</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> 	 c_compressed_record_init(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> 	 c_compressed_record_write(<span class="enscript-type">char</span> *, <span class="enscript-type">int</span>);
#<span class="enscript-reference">endif</span>


#<span class="enscript-reference">if</span> <span class="enscript-variable-name">__i386__</span> || <span class="enscript-variable-name">__x86_64__</span>
<span class="enscript-type">extern</span> lck_mtx_t	*c_list_lock;
#<span class="enscript-reference">else</span> <span class="enscript-comment">/* __i386__ || __x86_64__ */</span>
<span class="enscript-type">extern</span> lck_spin_t	*c_list_lock;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* __i386__ || __x86_64__ */</span>
</pre>
<hr />
</body></html>