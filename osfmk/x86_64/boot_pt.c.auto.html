<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>boot_pt.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">boot_pt.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2011 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/pmap.h&gt;</span>

<span class="enscript-comment">/*
 * These pagetables are used during early processor startup during
 * the transition from protected mode to 64-bit mode and the jump
 * to high kernel address space.
 *
 * They are required to be at the base of the kernel and specifically
 * the base of the special __HIB section.
 *
 * These tables are statically-defined as physical-zero-based.
 * Startup code in start.s rebases these according to the actual physical
 * base address. 
 */</span>

<span class="enscript-comment">/*
 * NB: This must be located at the kernel's base address!
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PML4_PROT</span> (INTEL_PTE_VALID | INTEL_PTE_WRITE)
pml4_entry_t	BootPML4[PTE_PER_PAGE]
		__attribute__((section(<span class="enscript-string">&quot;__HIB, __bootPT&quot;</span>))) = {
	[0]			= ((uint64_t)(PAGE_SIZE) | PML4_PROT),
	[KERNEL_PML4_INDEX]	= ((uint64_t)(PAGE_SIZE) | PML4_PROT),
};

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PDPT_PROT</span> (INTEL_PTE_VALID | INTEL_PTE_WRITE)
pdpt_entry_t	BootPDPT[PTE_PER_PAGE]
		__attribute__((section(<span class="enscript-string">&quot;__HIB, __bootPT&quot;</span>))) = {
	[0]	= ((uint64_t)(2*PAGE_SIZE) | PDPT_PROT), 
	[1]	= ((uint64_t)(3*PAGE_SIZE) | PDPT_PROT), 
	[2]	= ((uint64_t)(4*PAGE_SIZE) | PDPT_PROT), 
	[3]	= ((uint64_t)(5*PAGE_SIZE) | PDPT_PROT), 
};

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">NPGPTD</span> != 4
#<span class="enscript-reference">error</span> <span class="enscript-variable-name">Please</span> <span class="enscript-variable-name">update</span> <span class="enscript-variable-name">boot_pt</span>.<span class="enscript-variable-name">c</span> <span class="enscript-variable-name">to</span> <span class="enscript-variable-name">reflect</span> <span class="enscript-variable-name">the</span> <span class="enscript-variable-name">new</span> <span class="enscript-variable-name">value</span> <span class="enscript-variable-name">of</span> <span class="enscript-variable-name">NPGPTD</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">MACHINE_BOOTSTRAPPTD</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PDT_PROT</span> (INTEL_PTE_PS | INTEL_PTE_VALID | INTEL_PTE_WRITE)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">ID_MAP_2MEG</span>(x)	[(x)] = ((((uint64_t)(x)) &lt;&lt; 21) | (PDT_PROT)),

#<span class="enscript-reference">define</span> <span class="enscript-function-name">L0</span>(x,n)	 x(n)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">L1</span>(x,n)	 L0(x,n-1)     L0(x,n)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">L2</span>(x,n)  L1(x,n-2)     L1(x,n)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">L3</span>(x,n)  L2(x,n-4)     L2(x,n)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">L4</span>(x,n)  L3(x,n-8)     L3(x,n)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">L5</span>(x,n)  L4(x,n-16)    L4(x,n)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">L6</span>(x,n)  L5(x,n-32)    L5(x,n)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">L7</span>(x,n)  L6(x,n-64)    L6(x,n)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">L8</span>(x,n)  L7(x,n-128)   L7(x,n)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">L9</span>(x,n)  L8(x,n-256)   L8(x,n)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">L10</span>(x,n) L9(x,n-512)   L9(x,n)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">L11</span>(x,n) L10(x,n-1024) L10(x,n)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">FOR_0_TO_2047</span>(x) L11(x,2047)

pd_entry_t	BootPTD[2048]
		__attribute__((section(<span class="enscript-string">&quot;__HIB, __bootPT&quot;</span>))) = {
	FOR_0_TO_2047(ID_MAP_2MEG)
};
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* MACHINE_BOOTSTRAPPTD */</span>
</pre>
<hr />
</body></html>