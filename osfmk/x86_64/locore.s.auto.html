<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>locore.s</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">locore.s&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
/*
 <span class="enscript-keyword">*</span> Copyright (c) 2000-2007 Apple Inc. All rights reserved.
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> This file contains Original Code and/or Modifications of Original Code
 <span class="enscript-keyword">*</span> as defined in and that are subject to the Apple Public Source License
 <span class="enscript-keyword">*</span> Version 2.0 (the 'License'). You may not use this file except in
 <span class="enscript-keyword">*</span> compliance with the License. The rights granted to you under the License
 <span class="enscript-keyword">*</span> may not be used to create, or enable the creation or redistribution of,
 <span class="enscript-keyword">*</span> unlawful or unlicensed copies of an Apple operating system, or to
 <span class="enscript-keyword">*</span> circumvent, violate, or enable the circumvention or violation of, any
 <span class="enscript-keyword">*</span> terms of an Apple operating system software license agreement.
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> Please obtain a copy of the License at
 <span class="enscript-keyword">*</span> <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> The Original Code and all software distributed under the License are
 <span class="enscript-keyword">*</span> distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 <span class="enscript-keyword">*</span> EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 <span class="enscript-keyword">*</span> INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 <span class="enscript-keyword">*</span> FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 <span class="enscript-keyword">*</span> Please see the License for the specific language governing rights and
 <span class="enscript-keyword">*</span> limitations under the License.
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 <span class="enscript-keyword">*/
</span>/*
 <span class="enscript-keyword">*</span> @OSF_COPYRIGHT@
 <span class="enscript-keyword">*/
</span>/* 
 <span class="enscript-keyword">*</span> Mach Operating System
 <span class="enscript-keyword">*</span> Copyright (c) 1991,1990 Carnegie Mellon University
 <span class="enscript-keyword">*</span> All Rights Reserved.
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> Permission to use, copy, modify and distribute this software and its
 <span class="enscript-keyword">*</span> documentation is hereby granted, provided that both the copyright
 <span class="enscript-keyword">*</span> notice and this permission notice appear in all copies of the
 <span class="enscript-keyword">*</span> software, derivative works or modified versions, and any portions
 <span class="enscript-keyword">*</span> thereof, and that both notices appear in supporting documentation.
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> CARNEGIE MELLON ALLOWS FREE USE OF THIS SOFTWARE IN ITS <span class="enscript-string">&quot;AS IS&quot;</span>
 <span class="enscript-keyword">*</span> CONDITION.  CARNEGIE MELLON DISCLAIMS ANY LIABILITY OF ANY KIND FOR
 <span class="enscript-keyword">*</span> ANY DAMAGES WHATSOEVER RESULTING FROM THE USE OF THIS SOFTWARE.
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> Carnegie Mellon requests users of this software to return to
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span>  Software Distribution Coordinator  or  <a href="mailto:Software.Distribution@CS.CMU.EDU">Software.Distribution@CS.CMU.EDU</a>
 <span class="enscript-keyword">*</span>  School of Computer Science
 <span class="enscript-keyword">*</span>  Carnegie Mellon University
 <span class="enscript-keyword">*</span>  Pittsburgh PA 15213-3890
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> any improvements or extensions that they make and grant Carnegie Mellon
 <span class="enscript-keyword">*</span> the rights to redistribute these changes.
 <span class="enscript-keyword">*/
</span>
#include &lt;mach_rt.h&gt;
#include &lt;mach_kdp.h&gt;
#include &lt;mach_assert.h&gt;

#include &lt;sys/errno.h&gt;
#include &lt;i386/asm.h&gt;
#include &lt;i386/cpuid.h&gt;
#include &lt;i386/eflags.h&gt;
#include &lt;i386/proc_reg.h&gt;
#include &lt;i386/trap.h&gt;
#include &lt;assym.s&gt;
#include &lt;mach/exception_types.h&gt;
#include &lt;config_dtrace.h&gt;

#define _ARCH_I386_ASM_HELP_H_          /* Prevent inclusion of user header */
#include &lt;mach/i386/syscall_sw.h&gt;

/*
 <span class="enscript-keyword">*</span> Fault recovery.
 <span class="enscript-keyword">*/
</span>
#ifdef	__MACHO__
#define	RECOVERY_SECTION	.section	__VECTORS, __recover 
#else
#define	RECOVERY_SECTION	.text
#define	RECOVERY_SECTION	.text
#endif

#define	RECOVER_TABLE_START	\
	<span class="enscript-keyword">.align</span> 3		<span class="enscript-comment">; \
	.globl	EXT(recover_table) ;\
</span>LEXT(recover_table)		<span class="enscript-comment">;\
	.text
</span>
#define	RECOVER(addr)		\
	<span class="enscript-keyword">.align</span>	3<span class="enscript-comment">;		\
	.quad	9f		;\
</span>	<span class="enscript-keyword">.quad</span>	addr		<span class="enscript-comment">;\
	.text			;\
</span><span class="enscript-function-name">9:</span>

#define	RECOVER_TABLE_END		\
	<span class="enscript-keyword">.align</span>	3			<span class="enscript-comment">;\
	.globl	EXT(recover_table_end)	;\
</span>LEXT(recover_table_end)			<span class="enscript-comment">;\
	.text
</span>
/*
 <span class="enscript-keyword">*</span> Allocate recovery and table.
 <span class="enscript-keyword">*/
</span>	<span class="enscript-keyword">RECOVERY_SECTION
</span>	<span class="enscript-keyword">RECOVER_TABLE_START
</span>
/*
 <span class="enscript-keyword">*</span> int rdmsr_carefully(uint32_t msr, uint32_t *lo, uint32_t *hi)
 <span class="enscript-keyword">*/
</span>ENTRY(rdmsr_carefully)
	<span class="enscript-keyword">movl</span>	%edi, %ecx
	<span class="enscript-keyword">movq</span>	%rdx, %rdi
	<span class="enscript-keyword">RECOVERY_SECTION
</span>	<span class="enscript-keyword">RECOVER(rdmsr_fail)
</span>	<span class="enscript-keyword">rdmsr
</span>	<span class="enscript-keyword">movl</span>	%eax, (%rsi)
	<span class="enscript-keyword">movl</span>	%edx, (%rdi)
	<span class="enscript-keyword">xorl</span>	%eax, %eax
	<span class="enscript-keyword">ret
</span>
<span class="enscript-function-name">rdmsr_fail:</span>
	<span class="enscript-keyword">movq</span>	$1, %rax
	<span class="enscript-keyword">ret
</span>/*
 <span class="enscript-keyword">*</span> int rdmsr64_carefully(uint32_t msr, uint64_t *val)<span class="enscript-comment">;
 */
</span>
ENTRY(rdmsr64_carefully)
	<span class="enscript-keyword">movl</span>	%edi, %ecx
	<span class="enscript-keyword">RECOVERY_SECTION
</span>	<span class="enscript-keyword">RECOVER(rdmsr64_carefully_fail)
</span>	<span class="enscript-keyword">rdmsr
</span>	<span class="enscript-keyword">movl</span>	%eax, (%rsi)
	<span class="enscript-keyword">movl</span>	%edx, 4(%rsi)
	<span class="enscript-keyword">xorl</span>	%eax, %eax
	<span class="enscript-keyword">ret
</span><span class="enscript-function-name">rdmsr64_carefully_fail:</span>
	<span class="enscript-keyword">movl</span>	$1, %eax
	<span class="enscript-keyword">ret
</span>/*
 <span class="enscript-keyword">*</span> int wrmsr64_carefully(uint32_t msr, uint64_t val)<span class="enscript-comment">;
 */
</span>
ENTRY(wrmsr_carefully)
	<span class="enscript-keyword">movl</span>	%edi, %ecx
	<span class="enscript-keyword">movl</span>	%esi, %eax
	<span class="enscript-keyword">shr</span>	$32, %rsi
	<span class="enscript-keyword">movl</span>	%esi, %edx
	<span class="enscript-keyword">RECOVERY_SECTION
</span>	<span class="enscript-keyword">RECOVER(wrmsr_fail)
</span>	<span class="enscript-keyword">wrmsr
</span>	<span class="enscript-keyword">xorl</span>	%eax, %eax
	<span class="enscript-keyword">ret
</span><span class="enscript-function-name">wrmsr_fail:</span>
	<span class="enscript-keyword">movl</span>	$1, %eax
	<span class="enscript-keyword">ret
</span>
.globl	EXT(thread_exception_return)
.globl	EXT(thread_bootstrap_return)
LEXT(thread_bootstrap_return)
#if CONFIG_DTRACE
	<span class="enscript-keyword">call</span> EXT(dtrace_thread_bootstrap)
#endif

LEXT(thread_exception_return)
	<span class="enscript-keyword">cli
</span>	<span class="enscript-keyword">xorl</span>	%ecx, %ecx		/* don't check if we're in the PFZ */
	<span class="enscript-keyword">jmp</span>	EXT(return_from_trap)

/*
 <span class="enscript-keyword">*</span> Copyin/out from user/kernel address space.
 <span class="enscript-keyword">*</span> rdi:	source address
 <span class="enscript-keyword">*</span> rsi:	destination address
 <span class="enscript-keyword">*</span> rdx:	byte count (in fact, always &lt; 64MB -- see copyio)
 <span class="enscript-keyword">*/
</span>Entry(_bcopy)
	<span class="enscript-keyword">xchg</span>	%rdi, %rsi		/* source %rsi, dest %rdi */

	<span class="enscript-keyword">cld</span>				/* count up */
	<span class="enscript-keyword">mov</span>	%rdx, %rcx		/* move by longwords first */
	<span class="enscript-keyword">shr</span>	$3, %rcx
	<span class="enscript-keyword">RECOVERY_SECTION
</span>	<span class="enscript-keyword">RECOVER(_bcopy_fail)
</span>	<span class="enscript-keyword">rep
</span>	<span class="enscript-keyword">movsq</span>				/* move longwords */

	<span class="enscript-keyword">movl</span>	%edx, %ecx		/* now move remaining bytes */
	<span class="enscript-keyword">andl</span>	$7, %ecx
	<span class="enscript-keyword">RECOVERY_SECTION
</span>	<span class="enscript-keyword">RECOVER(_bcopy_fail)
</span>	<span class="enscript-keyword">rep
</span>	<span class="enscript-keyword">movsb
</span>
	<span class="enscript-keyword">xorl</span>	%eax,%eax		/* return 0 for success */
	<span class="enscript-keyword">ret</span>				/* and return */

<span class="enscript-function-name">_bcopy_fail:</span>
	<span class="enscript-keyword">movl</span>	$(EFAULT),%eax		/* return error for failure */
	<span class="enscript-keyword">ret
</span>
Entry(pmap_safe_read)
	<span class="enscript-keyword">RECOVERY_SECTION
</span>	<span class="enscript-keyword">RECOVER(_pmap_safe_read_fail)
</span>	<span class="enscript-keyword">movq</span>	(%rdi), %rcx
	<span class="enscript-keyword">mov</span>	%rcx, (%rsi)
	<span class="enscript-keyword">mov</span>	$1, %eax
	<span class="enscript-keyword">ret
</span><span class="enscript-function-name">_pmap_safe_read_fail:</span>
	<span class="enscript-keyword">xor</span>	%eax, %eax
	<span class="enscript-keyword">ret
</span>
/*
 <span class="enscript-keyword">*</span> 2-byte copy used by ml_copy_phys().
 <span class="enscript-keyword">*</span> rdi:	source address
 <span class="enscript-keyword">*</span> rsi:	destination address
 <span class="enscript-keyword">*/
</span>Entry(_bcopy2)
	<span class="enscript-keyword">RECOVERY_SECTION
</span>	<span class="enscript-keyword">RECOVER(_bcopy_fail)
</span>	<span class="enscript-keyword">movw</span>	(%rdi), %cx
	<span class="enscript-keyword">RECOVERY_SECTION
</span>	<span class="enscript-keyword">RECOVER(_bcopy_fail)
</span>	<span class="enscript-keyword">movw</span>	%cx, (%rsi)

	<span class="enscript-keyword">xorl</span>	%eax,%eax		/* return 0 for success */
	<span class="enscript-keyword">ret</span>				/* and return */

/*
 <span class="enscript-keyword">*</span> 4-byte copy used by ml_copy_phys().
 <span class="enscript-keyword">*</span> rdi:	source address
 <span class="enscript-keyword">*</span> rsi:	destination address
 <span class="enscript-keyword">*/
</span>Entry(_bcopy4)
	<span class="enscript-keyword">RECOVERY_SECTION
</span>	<span class="enscript-keyword">RECOVER(_bcopy_fail)
</span>	<span class="enscript-keyword">movl</span>	(%rdi), %ecx
	<span class="enscript-keyword">RECOVERY_SECTION
</span>	<span class="enscript-keyword">RECOVER(_bcopy_fail)
</span>	<span class="enscript-keyword">mov</span>	%ecx, (%rsi)

	<span class="enscript-keyword">xorl</span>	%eax,%eax		/* return 0 for success */
	<span class="enscript-keyword">ret</span>				/* and return */

/*
 <span class="enscript-keyword">*</span> 8-byte copy used by ml_copy_phys().
 <span class="enscript-keyword">*</span> rdi:	source address
 <span class="enscript-keyword">*</span> rsi:	destination address
 <span class="enscript-keyword">*/
</span>Entry(_bcopy8)
	<span class="enscript-keyword">RECOVERY_SECTION
</span>	<span class="enscript-keyword">RECOVER(_bcopy_fail)
</span>	<span class="enscript-keyword">movq</span>	(%rdi), %rcx
	<span class="enscript-keyword">RECOVERY_SECTION
</span>	<span class="enscript-keyword">RECOVER(_bcopy_fail)
</span>	<span class="enscript-keyword">mov</span>	%rcx, (%rsi)

	<span class="enscript-keyword">xorl</span>	%eax,%eax		/* return 0 for success */
	<span class="enscript-keyword">ret</span>				/* and return */


	<span class="enscript-keyword">
</span>/*
 <span class="enscript-keyword">*</span> Copyin string from user/kern address space.
 <span class="enscript-keyword">*</span> rdi:	source address
 <span class="enscript-keyword">*</span> rsi:	destination address
 <span class="enscript-keyword">*</span> rdx:	max byte count
 <span class="enscript-keyword">*</span> rcx:	actual byte count (OUT)
 <span class="enscript-keyword">*/
</span>Entry(_bcopystr)
	<span class="enscript-keyword">pushq</span>	%rdi
	<span class="enscript-keyword">xchgq</span>	%rdi, %rsi		/* source %rsi, dest %rdi */

	<span class="enscript-keyword">xorl</span>	%eax,%eax		/* set to 0 here so that high 24 bits */
					<span class="enscript-keyword">/*</span> are 0 for the cmpl against 0 */
<span class="enscript-function-name">2:</span>
	<span class="enscript-keyword">RECOVERY_SECTION
</span>	<span class="enscript-keyword">RECOVER(_bcopystr_fail)</span>		/* copy bytes... */
	<span class="enscript-keyword">movb</span>	(%rsi),%al
	<span class="enscript-keyword">incq</span>	%rsi
	<span class="enscript-keyword">testq</span>	%rdi,%rdi		/* if kernel address is ... */
	<span class="enscript-keyword">jz</span>	3f			/* not NULL */
	<span class="enscript-keyword">movb</span>	%al,(%rdi)		/* copy the byte */
	<span class="enscript-keyword">incq</span>	%rdi
<span class="enscript-function-name">3:</span>
	<span class="enscript-keyword">testl</span>	%eax,%eax		/* did we just stuff the 0-byte? */
	<span class="enscript-keyword">jz</span>	4f			/* yes, return 0 already in %eax */
	<span class="enscript-keyword">decq</span>	%rdx			/* decrement #bytes left in buffer */
	<span class="enscript-keyword">jnz</span>	2b			/* buffer not full, copy another byte */
	<span class="enscript-keyword">movl</span>	$(ENAMETOOLONG),%eax	/* buffer full, no \0: ENAMETOOLONG */
<span class="enscript-function-name">4:</span>
	<span class="enscript-keyword">cmpq</span>	$0,%rcx			/* get OUT len ptr */
	<span class="enscript-keyword">jz</span>	_bcopystr_ret		/* if null, just return */
	<span class="enscript-keyword">subq</span>	(%rsp),%rsi
	<span class="enscript-keyword">movq</span>	%rsi,(%rcx)		/* else set OUT arg to xfer len */
	<span class="enscript-keyword">popq</span>	%rdi			/* restore registers */
<span class="enscript-function-name">_bcopystr_ret:</span>
	<span class="enscript-keyword">ret</span>				/* and return */

<span class="enscript-function-name">_bcopystr_fail:</span>
	<span class="enscript-keyword">popq</span>	%rdi			/* restore registers */
	<span class="enscript-keyword">movl</span>	$(EFAULT),%eax		/* return error for failure */
	<span class="enscript-keyword">ret
</span>
/*
 <span class="enscript-keyword">*</span> Done with recovery table.
 <span class="enscript-keyword">*/
</span>	<span class="enscript-keyword">RECOVERY_SECTION
</span>	<span class="enscript-keyword">RECOVER_TABLE_END
</span>
</pre>
<hr />
</body></html>