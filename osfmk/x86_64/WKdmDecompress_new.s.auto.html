<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>WKdmDecompress_new.s</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">WKdmDecompress_new.s&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
/*
 <span class="enscript-keyword">*</span> Copyright (c) 2000-2013 Apple Inc. All rights reserved.
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> This file contains Original Code and/or Modifications of Original Code
 <span class="enscript-keyword">*</span> as defined in and that are subject to the Apple Public Source License
 <span class="enscript-keyword">*</span> Version 2.0 (the 'License'). You may not use this file except in
 <span class="enscript-keyword">*</span> compliance with the License. The rights granted to you under the License
 <span class="enscript-keyword">*</span> may not be used to create, or enable the creation or redistribution of,
 <span class="enscript-keyword">*</span> unlawful or unlicensed copies of an Apple operating system, or to
 <span class="enscript-keyword">*</span> circumvent, violate, or enable the circumvention or violation of, any
 <span class="enscript-keyword">*</span> terms of an Apple operating system software license agreement.
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> Please obtain a copy of the License at
 <span class="enscript-keyword">*</span> <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> The Original Code and all software distributed under the License are
 <span class="enscript-keyword">*</span> distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 <span class="enscript-keyword">*</span> EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 <span class="enscript-keyword">*</span> INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 <span class="enscript-keyword">*</span> FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 <span class="enscript-keyword">*</span> Please see the License for the specific language governing rights and
 <span class="enscript-keyword">*</span> limitations under the License.
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 <span class="enscript-keyword">*/
</span>
/*
 <span class="enscript-keyword">This</span> file contains x86_64 hand optimized implementation of WKdm memory page decompressor. 

	<span class="enscript-keyword">void</span> WKdm_decompress (WK_word* src_buf, WK_word* dest_buf, WK_word* scratch, __unused__ unsigned int words)<span class="enscript-comment">;

</span>	<span class="enscript-keyword">input</span> :
		<span class="enscript-keyword">src_buf</span> : address of input compressed data buffer
		<span class="enscript-keyword">dest_buf</span> : address of output decompressed buffer 
		<span class="enscript-keyword">scratch</span> : a 16-byte aligned 4k bytes scratch memory provided by the caller
		<span class="enscript-keyword">words</span> : this argument is not used in the implementation

	<span class="enscript-keyword">output</span> :

		<span class="enscript-keyword">the</span> input buffer is decompressed and the dest_buf is written with decompressed data.

	<span class="enscript-keyword">Am</span> algorithm description of the WKdm compress and bit stream format can be found in the WKdm Compress x86_64 assembly code WKdmCompress.s

	<span class="enscript-keyword">The</span> bit stream (*src_buf) consists of 
		<span class="enscript-keyword">a.</span> 12 bytes header
		<span class="enscript-keyword">b.</span> 256 bytes for 1024 packed tags
		<span class="enscript-keyword">c.</span> (varying number of) words for new words not matched to dictionary word. 
		<span class="enscript-keyword">d.</span> (varying number of) 32-bit words for packed 4-bit dict_indices (for class 1 and 3)
		<span class="enscript-keyword">e.</span> (varying number of) 32-bit words for packed 10-bit low bits (for class 1)

	<span class="enscript-keyword">where</span> the header (of 3 words) specifies the ending boundaries (in 32-bit words) from the start of the bit stream of c,d,e, respectively.

	<span class="enscript-keyword">The</span> decompressor 1st unpacking the bit stream component b/d/e into temorary buffers. Then it sequentially decodes the decompressed word as follows

		<span class="enscript-keyword">for</span> (i=0<span class="enscript-comment">;i&lt;1024;i++) {
			tag = *next_tag++
</span>			<span class="enscript-keyword">switch</span> (tag) {
				<span class="enscript-keyword">case</span> 0 : *dest_buf++ = 0<span class="enscript-comment">; break;
				case 1 : dict_word = dictionary[*dict_index]; dictionary[*dict_index++] = *dest_buf++ = dict_word&amp;0xfffffc00 | *LowBits++; break;
</span>				<span class="enscript-keyword">case</span> 2 : x = *new_word++<span class="enscript-comment">; k = (x&gt;&gt;10)&amp;255; k = hashTable[k]; dictionary[k] = *dest_buf++ = x; break;
				case 3 : *dest_buf++ = dictionary[*dict_index++];  break;
</span>			<span class="enscript-keyword">}
</span> <span class="enscript-keyword">
</span> 	<span class="enscript-keyword">cclee,</span> 11/30/12

    <span class="enscript-keyword">Added</span> zero page, single value page, sparse page, early abort optimizations
    <span class="enscript-keyword">rsrini,</span> 09/14/14
*/

#define MZV_MAGIC           $17185      // magic value used to identify MZV page encoding

	<span class="enscript-keyword">.text
</span>
	<span class="enscript-keyword">.globl</span> _WKdm_decompress_new
<span class="enscript-function-name">_WKdm_decompress_new:</span>

	<span class="enscript-keyword">//</span> save registers, and allocate stack memory for local variables

	<span class="enscript-keyword">pushq</span>	%rbp
	<span class="enscript-keyword">movq</span>	%rsp, %rbp
	<span class="enscript-keyword">pushq</span>	%r12
	<span class="enscript-keyword">pushq</span>	%r13
	<span class="enscript-keyword">pushq</span>	%rbx

	<span class="enscript-keyword">subq</span>	$(64+8+16), %rsp

    <span class="enscript-keyword">movl</span>    0(%rdi), %eax               // read the 1st word from the header
    <span class="enscript-keyword">cmpl</span>    MZV_MAGIC, %eax             // is the alternate packer used (i.e. is MZV page)?
    <span class="enscript-keyword">jne</span>     L_default_decompressor      // default decompressor was used

                                        <span class="enscript-keyword">//</span> Mostly Zero Page Handling...
                                        <span class="enscript-keyword">//</span> {
    <span class="enscript-keyword">movq</span>    $0, %rax
<span class="enscript-function-name">1:</span>                                      // Zero out the entire page
    <span class="enscript-keyword">movq</span>    $0, 0(%rsi, %rax)
    <span class="enscript-keyword">movq</span>    $0, 8(%rsi, %rax)
    <span class="enscript-keyword">movq</span>    $0, 16(%rsi, %rax)
    <span class="enscript-keyword">movq</span>    $0, 24(%rsi, %rax)
    <span class="enscript-keyword">movq</span>    $0, 32(%rsi, %rax)
    <span class="enscript-keyword">movq</span>    $0, 40(%rsi, %rax)
    <span class="enscript-keyword">movq</span>    $0, 48(%rsi, %rax)
    <span class="enscript-keyword">movq</span>    $0, 56(%rsi, %rax)
    <span class="enscript-keyword">addq</span>    $64, %rax
    <span class="enscript-keyword">cmpq</span>    $4096, %rax
    <span class="enscript-keyword">jne</span>     1b

    <span class="enscript-keyword">movq</span>    $4, %r12                    // current byte position in src to read from
<span class="enscript-function-name">2:</span>
    <span class="enscript-keyword">movl</span>    0(%rdi, %r12), %eax         // get the word
    <span class="enscript-keyword">movzwq</span>  4(%rdi, %r12), %rdx         // get the index
    <span class="enscript-keyword">movl</span>    %eax, 0(%rsi, %rdx)         // store non-0 word in the destination buffer
    <span class="enscript-keyword">addq</span>    $6, %r12                    // 6 more bytes processed
    <span class="enscript-keyword">cmpl</span>    %ecx, %r12d                 // finished processing all the bytes?
    <span class="enscript-keyword">jne</span>     2b
    <span class="enscript-keyword">jmp</span>     L_done
                                        <span class="enscript-keyword">//</span> }

<span class="enscript-function-name">L_default_decompressor:</span>

	<span class="enscript-keyword">movq</span>	%rsi, %r12					// dest_buf
	<span class="enscript-keyword">movq</span>	%rdx, %r13					// scratch_buf

	<span class="enscript-keyword">//</span> PRELOAD_DICTONARY<span class="enscript-comment">; dictionary starting address : starting address 0(%rsp)
    // NOTE: ALL THE DICTIONARY VALUES MUST BE INITIALIZED TO ZERO TO MIRROR THE COMPRESSOR
</span>#if 1
	<span class="enscript-keyword">movl</span>	$0, 0(%rsp)
	<span class="enscript-keyword">movl</span>	$0, 4(%rsp)
	<span class="enscript-keyword">movl</span>	$0, 8(%rsp)
	<span class="enscript-keyword">movl</span>	$0, 12(%rsp)
	<span class="enscript-keyword">movl</span>	$0, 16(%rsp)
	<span class="enscript-keyword">movl</span>	$0, 20(%rsp)
	<span class="enscript-keyword">movl</span>	$0, 24(%rsp)
	<span class="enscript-keyword">movl</span>	$0, 28(%rsp)
	<span class="enscript-keyword">movl</span>	$0, 32(%rsp)
	<span class="enscript-keyword">movl</span>	$0, 36(%rsp)
	<span class="enscript-keyword">movl</span>	$0, 40(%rsp)
	<span class="enscript-keyword">movl</span>	$0, 44(%rsp)
	<span class="enscript-keyword">movl</span>	$0, 48(%rsp)
	<span class="enscript-keyword">movl</span>	$0, 52(%rsp)
	<span class="enscript-keyword">movl</span>	$0, 56(%rsp)
	<span class="enscript-keyword">movl</span>	$0, 60(%rsp)
#else
	<span class="enscript-keyword">mov</span>		$0x100000001, %rax
	<span class="enscript-keyword">mov</span>		%rax, (%rsp)
	<span class="enscript-keyword">mov</span>		%rax, 8(%rsp)
	<span class="enscript-keyword">mov</span>		%rax, 16(%rsp)
	<span class="enscript-keyword">mov</span>		%rax, 24(%rsp)
	<span class="enscript-keyword">mov</span>		%rax, 32(%rsp)
	<span class="enscript-keyword">mov</span>		%rax, 40(%rsp)
	<span class="enscript-keyword">mov</span>		%rax, 48(%rsp)
	<span class="enscript-keyword">mov</span>		%rax, 56(%rsp)
#endif

	<span class="enscript-keyword">//</span> WK_unpack_2bits(TAGS_AREA_START(src_buf), TAGS_AREA_END(src_buf), tempTagsArray)<span class="enscript-comment">;

</span>	<span class="enscript-keyword">leaq</span>	268(%rdi), %r10				// TAGS_AREA_END
	<span class="enscript-keyword">leaq</span>	12(%rdi), %rax				// TAGS_AREA_START 
	<span class="enscript-keyword">movq</span>	%r13, %rsi					// tempTagsArray
	<span class="enscript-keyword">cmpq</span>	%rax, %r10					// TAGS_AREA_END vs TAGS_AREA_START
	<span class="enscript-keyword">jbe</span>		1f							// if TAGS_AREA_END &lt;= TAGS_AREA_START, skip L_WK_unpack_2bits
	<span class="enscript-keyword">movq</span>	%r13, %rcx					// next_word
	<span class="enscript-keyword">xorl</span>	%r8d, %r8d					// i = 0
	<span class="enscript-keyword">mov</span>		$(50529027&lt;&lt;32)+50529027, %r9
<span class="enscript-function-name">L_WK_unpack_2bits:</span>
	<span class="enscript-keyword">movl</span>	12(%rdi,%r8, 4), %eax
	<span class="enscript-keyword">movl</span>	12(%rdi,%r8, 4), %edx
	<span class="enscript-keyword">shrl</span>	$2, %eax
	<span class="enscript-keyword">shlq</span>	$32, %rax
	<span class="enscript-keyword">orq</span>		%rdx, %rax
	<span class="enscript-keyword">movq</span>	%rax, %rdx
	<span class="enscript-keyword">shrq</span>	$4, %rax
	<span class="enscript-keyword">andq</span>	%r9, %rdx
	<span class="enscript-keyword">andq</span>	%r9, %rax
	<span class="enscript-keyword">incq</span>	%r8							// i++
	<span class="enscript-keyword">movq</span>	%rdx, (%rcx)
	<span class="enscript-keyword">movq</span>	%rax, 8(%rcx)
	<span class="enscript-keyword">addq</span>	$16, %rcx					// next_tags += 16
	<span class="enscript-keyword">cmpq</span>	$64, %r8					// i vs 64
	<span class="enscript-keyword">jne</span>		L_WK_unpack_2bits			// repeat loop until i==64
<span class="enscript-function-name">1:</span>


	<span class="enscript-keyword">//</span> WK_unpack_4bits(QPOS_AREA_START(src_buf), QPOS_AREA_END(src_buf), tempQPosArray)<span class="enscript-comment">;

</span>	<span class="enscript-keyword">mov</span>		4(%rdi), %eax				// WKdm header qpos end
	<span class="enscript-keyword">leaq</span>	(%rdi,%rax,4), %r9			// QPOS_AREA_END
	<span class="enscript-keyword">mov</span>		0(%rdi), %eax				// WKdm header qpos start
	<span class="enscript-keyword">leaq</span>	(%rdi,%rax,4), %r8			// QPOS_AREA_START
	<span class="enscript-keyword">leaq</span>	1024(%r13), %rbx			// tempQPosArray
	<span class="enscript-keyword">cmpq</span>	%r8, %r9					// QPOS_AREA_END vs QPOS_AREA_START
	<span class="enscript-keyword">jbe</span>		1f							// if QPOS_AREA_END &lt;= QPOS_AREA_START, skip L_WK_unpack_4bits
	<span class="enscript-keyword">leaq</span>	8(%rbx), %rcx				// next_qpos

	<span class="enscript-keyword">mov</span>		$(252645135&lt;&lt;32)+252645135, %r11
<span class="enscript-function-name">L_WK_unpack_4bits:</span>
	<span class="enscript-keyword">movl</span>	(%r8), %eax					// w = *next_word
	<span class="enscript-keyword">movl</span>	%eax, %edx					// w
	<span class="enscript-keyword">shlq</span>	$28, %rax
	<span class="enscript-keyword">orq</span>		%rdx, %rax
	<span class="enscript-keyword">addq</span>	$4, %r8						// next_word++
	<span class="enscript-keyword">andq</span>	%r11, %rax
	<span class="enscript-keyword">movq</span>	%rax, -8(%rcx)
	<span class="enscript-keyword">addq</span>	$8, %rcx					// next_qpos+=8
	<span class="enscript-keyword">cmpq</span>	%r8, %r9					// QPOS_AREA_END vs QPOS_AREA_START
	<span class="enscript-keyword">ja</span>		L_WK_unpack_4bits			// repeat loop until QPOS_AREA_END &lt;= QPOS_AREA_START


<span class="enscript-function-name">1:</span>

	<span class="enscript-keyword">//</span> WK_unpack_3_tenbits(LOW_BITS_AREA_START(src_buf), LOW_BITS_AREA_END(src_buf), tempLowBitsArray)<span class="enscript-comment">;

</span>	<span class="enscript-keyword">movl</span>	8(%rdi), %eax				// LOW_BITS_AREA_END offset
	<span class="enscript-keyword">leaq</span>	(%rdi,%rax,4), %rdi			// LOW_BITS_AREA_END
	<span class="enscript-keyword">leaq</span>	2048(%r13), %r11			// tempLowBitsArray
	<span class="enscript-keyword">leaq</span>	4094(%r13), %r13			// final tenbits addr
	<span class="enscript-keyword">sub</span>		%r9, %rdi					// LOW_BITS_AREA_START vs LOW_BITS_AREA_END
	<span class="enscript-keyword">jle</span>		1f							// if START&gt;=END, skip L_WK_unpack_3_tenbits
	<span class="enscript-keyword">movq</span>	%r11, %rcx					// next_low_bits
<span class="enscript-function-name">L_WK_unpack_3_tenbits:</span>
	<span class="enscript-keyword">movl</span>	(%r9), %eax					// w = *next_word, 0:c:b:a
	<span class="enscript-keyword">movl</span>	$(1023&lt;&lt;10), %edx
	<span class="enscript-keyword">movl</span>	$(1023&lt;&lt;20), %r8d
	<span class="enscript-keyword">andl</span>	%eax, %edx					// b &lt;&lt; 10
	<span class="enscript-keyword">andl</span>	%eax, %r8d					// c &lt;&lt; 20
	<span class="enscript-keyword">andq</span>	$1023, %rax
	<span class="enscript-keyword">shll</span>	$6, %edx
	<span class="enscript-keyword">shlq</span>	$12, %r8
	<span class="enscript-keyword">orl</span>		%edx, %eax
	<span class="enscript-keyword">orq</span>		%r8, %rax
	<span class="enscript-keyword">cmp</span>		%r13, %rcx
	<span class="enscript-keyword">je</span>		2f
	<span class="enscript-keyword">mov</span>		%rax, (%rcx)
	<span class="enscript-keyword">jmp</span>		3f
<span class="enscript-function-name">2:</span>	mov		%ax, (%rcx)
<span class="enscript-function-name">3:</span>
	<span class="enscript-keyword">addq</span>	$4, %r9						// next_word++
	<span class="enscript-keyword">addq</span>	$6, %rcx					// next_low_bits += 3
	<span class="enscript-keyword">sub</span>		$4, %rdi
	<span class="enscript-keyword">jg</span>		L_WK_unpack_3_tenbits		// repeat loop if LOW_BITS_AREA_END &gt; next_word
<span class="enscript-function-name">1:</span>


	<span class="enscript-keyword">#define</span>	next_qpos		%rbx
	<span class="enscript-keyword">#define</span>	hash			%r8
	<span class="enscript-keyword">#define</span>	tags_counter	%edi
	<span class="enscript-keyword">#define</span>	dest_buf		%r12
	<span class="enscript-keyword">#define</span> next_full_patt	%r10	

	<span class="enscript-keyword">leaq</span>	_hashLookupTable_new(%rip), hash	// hash look up table
	<span class="enscript-keyword">movl</span>	$1024, tags_counter				// tags_counter
	<span class="enscript-keyword">jmp</span>		L_next

	<span class="enscript-keyword">.align</span> 4,0x90
<span class="enscript-function-name">L_nonpartital:</span>
	<span class="enscript-keyword">jl</span>		L_ZERO_TAG
	<span class="enscript-keyword">cmpb</span>	$2, -1(%rsi)
	<span class="enscript-keyword">je</span>		L_MISS_TAG

<span class="enscript-function-name">L_EXACT_TAG:</span>
	<span class="enscript-keyword">movzbl</span>	(next_qpos), %eax				// qpos = *next_qpos
	<span class="enscript-keyword">incq</span>	next_qpos						// next_qpos++
	<span class="enscript-keyword">decl</span>	tags_counter					// tags_counter--
	<span class="enscript-keyword">movl</span>	(%rsp,%rax,4), %eax				// w = dictionary[qpos]
	<span class="enscript-keyword">movl</span>	%eax, -4(dest_buf)				// *dest_buf = w
	<span class="enscript-keyword">je</span>		L_done

<span class="enscript-function-name">L_next:</span>
	<span class="enscript-keyword">incq</span>	%rsi							// next_tag++
	<span class="enscript-keyword">addq</span>	$4, dest_buf
	<span class="enscript-keyword">cmpb</span>	$1, -1(%rsi)
	<span class="enscript-keyword">jne</span>		L_nonpartital

<span class="enscript-function-name">L_PARTIAL_TAG:</span>
	<span class="enscript-keyword">movzbl</span>	(next_qpos),%edx				// qpos = *next_qpos
	<span class="enscript-keyword">incq</span>	next_qpos						// next_qpos++
	<span class="enscript-keyword">movl</span>	(%rsp,%rdx,4), %eax				// read dictionary word
	<span class="enscript-keyword">andl</span>	$-1024, %eax					// clear lower 10 bits
	<span class="enscript-keyword">or</span>		(%r11), %ax						// pad the lower 10-bits from *next_low_bits
	<span class="enscript-keyword">addq</span>	$2, %r11						// next_low_bits++
	<span class="enscript-keyword">decl</span>	tags_counter					// tags_counter--
	<span class="enscript-keyword">movl</span>	%eax, (%rsp,%rdx,4)				// *dict_location = newly formed word 
	<span class="enscript-keyword">movl</span>	%eax, -4(dest_buf)				// *dest_buf = newly formed word
	<span class="enscript-keyword">jg</span>		L_next							// repeat loop until next_tag==tag_area_end

<span class="enscript-function-name">L_done:</span>

	<span class="enscript-keyword">//</span> release stack memory, restore registers, and return

	<span class="enscript-keyword">addq</span>	$(64+8+16), %rsp
	<span class="enscript-keyword">popq</span>	%rbx
	<span class="enscript-keyword">popq</span>	%r13
	<span class="enscript-keyword">popq</span>	%r12
	<span class="enscript-keyword">leave
</span>	<span class="enscript-keyword">ret
</span>
	<span class="enscript-keyword">.align</span> 4,0x90
<span class="enscript-function-name">L_MISS_TAG:</span>
	<span class="enscript-keyword">movl</span>	(next_full_patt), %edx			// w = *next_full_patt
	<span class="enscript-keyword">movl</span>	(next_full_patt), %eax			// w = *next_full_patt
	<span class="enscript-keyword">shrl</span>	$10, %edx						// w&gt;&gt;10
	<span class="enscript-keyword">addq</span>	$4, next_full_patt				// next_full_patt++
	<span class="enscript-keyword">movzbl</span>	%dl, %edx						// 8-bit hash table index
	<span class="enscript-keyword">movl</span>	%eax, -4(dest_buf)				// *dest_buf = word
	<span class="enscript-keyword">movzbl</span>	(hash,%rdx),%edx				// qpos
	<span class="enscript-keyword">decl</span>	tags_counter					// tags_counter--
	<span class="enscript-keyword">movl</span>	%eax, (%rsp,%rdx)				// dictionary[qpos] = word
	<span class="enscript-keyword">jg</span>		L_next							// repeat the loop
	<span class="enscript-keyword">jmp</span>		L_done

	<span class="enscript-keyword">.align</span> 4,0x90
<span class="enscript-function-name">L_ZERO_TAG:</span>
	<span class="enscript-keyword">decl</span>	tags_counter					// tags_counter--
	<span class="enscript-keyword">movl</span>	$0, -4(dest_buf)					// *dest_buf = 0
	<span class="enscript-keyword">jg</span>		L_next							// repeat the loop
	<span class="enscript-keyword">jmp</span>		L_done


</pre>
<hr />
</body></html>