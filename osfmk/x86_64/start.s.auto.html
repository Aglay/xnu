<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>start.s</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">start.s&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
/*
 <span class="enscript-keyword">*</span> Copyright (c) 2007 Apple Inc. All rights reserved.
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> This file contains Original Code and/or Modifications of Original Code
 <span class="enscript-keyword">*</span> as defined in and that are subject to the Apple Public Source License
 <span class="enscript-keyword">*</span> Version 2.0 (the 'License'). You may not use this file except in
 <span class="enscript-keyword">*</span> compliance with the License. The rights granted to you under the License
 <span class="enscript-keyword">*</span> may not be used to create, or enable the creation or redistribution of,
 <span class="enscript-keyword">*</span> unlawful or unlicensed copies of an Apple operating system, or to
 <span class="enscript-keyword">*</span> circumvent, violate, or enable the circumvention or violation of, any
 <span class="enscript-keyword">*</span> terms of an Apple operating system software license agreement.
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> Please obtain a copy of the License at
 <span class="enscript-keyword">*</span> <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> The Original Code and all software distributed under the License are
 <span class="enscript-keyword">*</span> distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 <span class="enscript-keyword">*</span> EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 <span class="enscript-keyword">*</span> INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 <span class="enscript-keyword">*</span> FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 <span class="enscript-keyword">*</span> Please see the License for the specific language governing rights and
 <span class="enscript-keyword">*</span> limitations under the License.
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 <span class="enscript-keyword">*/
</span>/*
 <span class="enscript-keyword">*</span> @OSF_COPYRIGHT@
 <span class="enscript-keyword">*/
</span>/* 
 <span class="enscript-keyword">*</span> Mach Operating System
 <span class="enscript-keyword">*</span> Copyright (c) 1991,1990 Carnegie Mellon University
 <span class="enscript-keyword">*</span> All Rights Reserved.
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> Permission to use, copy, modify and distribute this software and its
 <span class="enscript-keyword">*</span> documentation is hereby granted, provided that both the copyright
 <span class="enscript-keyword">*</span> notice and this permission notice appear in all copies of the
 <span class="enscript-keyword">*</span> software, derivative works or modified versions, and any portions
 <span class="enscript-keyword">*</span> thereof, and that both notices appear in supporting documentation.
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> CARNEGIE MELLON ALLOWS FREE USE OF THIS SOFTWARE IN ITS <span class="enscript-string">&quot;AS IS&quot;</span>
 <span class="enscript-keyword">*</span> CONDITION.  CARNEGIE MELLON DISCLAIMS ANY LIABILITY OF ANY KIND FOR
 <span class="enscript-keyword">*</span> ANY DAMAGES WHATSOEVER RESULTING FROM THE USE OF THIS SOFTWARE.
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> Carnegie Mellon requests users of this software to return to
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span>  Software Distribution Coordinator  or  <a href="mailto:Software.Distribution@CS.CMU.EDU">Software.Distribution@CS.CMU.EDU</a>
 <span class="enscript-keyword">*</span>  School of Computer Science
 <span class="enscript-keyword">*</span>  Carnegie Mellon University
 <span class="enscript-keyword">*</span>  Pittsburgh PA 15213-3890
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> any improvements or extensions that they make and grant Carnegie Mellon
 <span class="enscript-keyword">*</span> the rights to redistribute these changes.
 <span class="enscript-keyword">*/
</span>/*
 <span class="enscript-keyword">*/
</span>
#include &lt;debug.h&gt;

#include &lt;i386/asm.h&gt;
#include &lt;i386/proc_reg.h&gt;
#include &lt;i386/postcode.h&gt;
#include &lt;assym.s&gt;

#include &lt;i386/cpuid.h&gt;
#include &lt;i386/acpi.h&gt;

.code32


/*
 <span class="enscript-keyword">*</span> Interrupt and bootup stack for initial processor.
 <span class="enscript-keyword">*</span> Note: we switch to a dynamically allocated interrupt stack once VM is up.
 <span class="enscript-keyword">*/
</span>
/* in the __HIB section since the hibernate restore code uses this stack. */
	<span class="enscript-keyword">.section</span> __HIB, __data
	<span class="enscript-keyword">.align</span>	12

	<span class="enscript-keyword">.globl</span>	EXT(low_intstack)
<span class="enscript-function-name">EXT(low_intstack):</span>
	<span class="enscript-keyword">.globl</span>  EXT(gIOHibernateRestoreStack)
<span class="enscript-function-name">EXT(gIOHibernateRestoreStack):</span>

	<span class="enscript-keyword">.space</span>	INTSTACK_SIZE

	<span class="enscript-keyword">.globl</span>	EXT(low_eintstack)
<span class="enscript-function-name">EXT(low_eintstack:</span>)
	<span class="enscript-keyword">.globl</span>  EXT(gIOHibernateRestoreStackEnd)
<span class="enscript-function-name">EXT(gIOHibernateRestoreStackEnd):</span>

	<span class="enscript-keyword">/*</span> back to the regular __DATA section. */

	<span class="enscript-keyword">.section</span> __DATA, __data

/*
 <span class="enscript-keyword">*</span> Stack for machine-check handler.
 <span class="enscript-keyword">*/
</span>	<span class="enscript-keyword">.align</span>	12
	<span class="enscript-keyword">.globl</span>	EXT(mc_task_stack)
<span class="enscript-function-name">EXT(mc_task_stack):</span>
	<span class="enscript-keyword">.space</span>	INTSTACK_SIZE
	<span class="enscript-keyword">.globl</span>	EXT(mc_task_stack_end)
<span class="enscript-function-name">EXT(mc_task_stack_end):</span>

	<span class="enscript-keyword">/*</span> Must not clobber EDI */
#define SWITCH_TO_64BIT_MODE					 \
	<span class="enscript-keyword">movl</span>	$(CR4_PAE),%eax		/* enable PAE */	<span class="enscript-comment">;\
	movl	%eax,%cr4					;\
</span>	<span class="enscript-keyword">movl</span>    $MSR_IA32_EFER,%ecx				<span class="enscript-comment">;\
	rdmsr							;\
</span>	<span class="enscript-keyword">/*</span> enable long mode, NX */				<span class="enscript-comment">;\
	orl	$(MSR_IA32_EFER_LME | MSR_IA32_EFER_NXE),%eax	;\
</span>	<span class="enscript-keyword">wrmsr</span>							<span class="enscript-comment">;\
	movl	$EXT(BootPML4),%eax				;\
</span>	<span class="enscript-keyword">movl</span>	%eax,%cr3					<span class="enscript-comment">;\
	movl	%cr0,%eax					;\
</span>	<span class="enscript-keyword">orl</span>	$(CR0_PG|CR0_WP),%eax	/* enable paging */	<span class="enscript-comment">;\
	movl	%eax,%cr0					;\
</span>	<span class="enscript-keyword">ljmpl</span>	$KERNEL64_CS,$64f				<span class="enscript-comment">;\
64:								;\
</span>	<span class="enscript-keyword">.code64
</span>
/*
 <span class="enscript-keyword">*</span> BSP CPU start here.
 <span class="enscript-keyword">*</span>	eax points to kernbootstruct
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> Environment:
 <span class="enscript-keyword">*</span>	protected mode, no paging, flat 32-bit address space.
 <span class="enscript-keyword">*</span>	(Code/data/stack segments have base == 0, limit == 4G)
 <span class="enscript-keyword">*/
</span>	<span class="enscript-keyword">
</span>.code32
	<span class="enscript-keyword">.text
</span>	<span class="enscript-keyword">.section</span> __HIB, __text
	<span class="enscript-keyword">.align</span>	ALIGN
	<span class="enscript-keyword">.globl</span>	EXT(_start)
	<span class="enscript-keyword">.globl</span>	EXT(pstart)
LEXT(_start)
LEXT(pstart)

/*
 <span class="enscript-keyword">*</span> Here we do the minimal setup to switch from 32 bit mode to 64 bit long mode.
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> Initial memory layout:
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span>	-------------------------
 <span class="enscript-keyword">*</span>	|			|
 <span class="enscript-keyword">*</span>	| Kernel text/data	|
 <span class="enscript-keyword">*</span>	|			|
 <span class="enscript-keyword">*</span>	|-----------------------| Kernel text base addr - 2MB-aligned
 <span class="enscript-keyword">*</span>	| padding		|
 <span class="enscript-keyword">*</span>	|-----------------------|
 <span class="enscript-keyword">*</span>	| __HIB section		|
 <span class="enscript-keyword">*</span>	|-----------------------| Page-aligned
 <span class="enscript-keyword">*</span>	|			|
 <span class="enscript-keyword">*</span>	| padding		|
 <span class="enscript-keyword">*</span>	|			|
 <span class="enscript-keyword">*</span>	------------------------- 0
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*/</span>	
	<span class="enscript-keyword">mov</span>	%eax, %edi	/* save kernbootstruct */

	<span class="enscript-keyword">/*</span> Use low 32-bits of address as 32-bit stack */
	<span class="enscript-keyword">movl</span>	$EXT(low_eintstack), %esp
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">POSTCODE(PSTART_ENTRY)
</span>
	<span class="enscript-keyword">/*
</span>	 <span class="enscript-keyword">*</span> Set up segmentation
	 <span class="enscript-keyword">*/
</span>	<span class="enscript-keyword">movl</span>	$EXT(protected_mode_gdtr), %eax
	<span class="enscript-keyword">lgdtl</span>	(%eax)

	<span class="enscript-keyword">/*
</span>	 <span class="enscript-keyword">*</span> Rebase Boot page tables to kernel base address.
	 <span class="enscript-keyword">*/
</span>	<span class="enscript-keyword">movl</span>	$EXT(BootPML4), %eax			// Level 4:
	<span class="enscript-keyword">add</span>	%eax, 0*8+0(%eax)			//  - 1:1
	<span class="enscript-keyword">add</span>	%eax, KERNEL_PML4_INDEX*8+0(%eax)	//  - kernel space

	<span class="enscript-keyword">movl</span>	$EXT(BootPDPT), %edx			// Level 3:
	<span class="enscript-keyword">add</span>	%eax, 0*8+0(%edx)
	<span class="enscript-keyword">add</span>	%eax, 1*8+0(%edx)
	<span class="enscript-keyword">add</span>	%eax, 2*8+0(%edx)
	<span class="enscript-keyword">add</span>	%eax, 3*8+0(%edx)

	<span class="enscript-keyword">POSTCODE(PSTART_REBASE)
</span>
/* the following code is shared by the master CPU and all slave CPUs */
<span class="enscript-function-name">L_pstart_common:</span>
	<span class="enscript-keyword">/*
</span>	 <span class="enscript-keyword">*</span> switch to 64 bit mode
	 <span class="enscript-keyword">*/
</span>	<span class="enscript-keyword">SWITCH_TO_64BIT_MODE
</span>
	<span class="enscript-keyword">/*</span> Flush data segment selectors */
	<span class="enscript-keyword">xor</span>	%eax, %eax
	<span class="enscript-keyword">mov</span>	%ax, %ss
	<span class="enscript-keyword">mov</span>	%ax, %ds
	<span class="enscript-keyword">mov</span>	%ax, %es
	<span class="enscript-keyword">mov</span>	%ax, %fs
	<span class="enscript-keyword">mov</span>	%ax, %gs

	<span class="enscript-keyword">test</span>	%edi, %edi /* Populate stack canary on BSP */
	<span class="enscript-keyword">jz</span>	Lvstartshim

	<span class="enscript-keyword">mov</span>	$1, %eax
	<span class="enscript-keyword">cpuid
</span>	<span class="enscript-keyword">test</span>	$(1 &lt;&lt; 30), %ecx
	<span class="enscript-keyword">jz</span>	Lnon_rdrand
	<span class="enscript-keyword">rdrand</span>	%rax		/* RAX := 64 bits of DRBG entropy */
	<span class="enscript-keyword">jnc</span>	Lnon_rdrand	/* TODO: complain if DRBG fails at this stage */

<span class="enscript-function-name">Lstore_random_guard:</span>
	<span class="enscript-keyword">xor</span>	%ah, %ah	/* Security: zero second byte of stack canary */
	<span class="enscript-keyword">movq</span>	%rax, ___stack_chk_guard(%rip)
	<span class="enscript-keyword">/*</span> %edi = boot_args_start if BSP */
<span class="enscript-function-name">Lvstartshim:</span>	

	<span class="enscript-keyword">POSTCODE(PSTART_VSTART)
</span>
	<span class="enscript-keyword">/*</span> %edi = boot_args_start */
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">leaq</span>	_vstart(%rip), %rcx
	<span class="enscript-keyword">movq</span>	$0xffffff8000000000, %rax	/* adjust pointer up high */
	<span class="enscript-keyword">or</span>	%rax, %rsp			/* and stack pointer up there */
	<span class="enscript-keyword">or</span>	%rcx, %rax
	<span class="enscript-keyword">andq</span>	$0xfffffffffffffff0, %rsp	/* align stack */
	<span class="enscript-keyword">xorq</span>	%rbp, %rbp			/* zero frame pointer */
	<span class="enscript-keyword">callq</span>	*%rax

<span class="enscript-function-name">Lnon_rdrand:</span>
	<span class="enscript-keyword">rdtsc</span> /* EDX:EAX := TSC */
	<span class="enscript-keyword">/*</span> Distribute low order bits */
	<span class="enscript-keyword">mov</span>	%eax, %ecx
	<span class="enscript-keyword">xor</span>	%al, %ah
	<span class="enscript-keyword">shl</span>	$16, %rcx
	<span class="enscript-keyword">xor</span>	%rcx, %rax
	<span class="enscript-keyword">xor</span>	%eax, %edx

	<span class="enscript-keyword">/*</span> Incorporate ASLR entropy, if any */
	<span class="enscript-keyword">lea</span>	(%rip), %rcx
	<span class="enscript-keyword">shr</span>	$21, %rcx
	<span class="enscript-keyword">movzbl</span>	%cl, %ecx
	<span class="enscript-keyword">shl</span>	$16, %ecx
	<span class="enscript-keyword">xor</span>	%ecx, %edx

	<span class="enscript-keyword">mov</span>	%ah, %cl
	<span class="enscript-keyword">ror</span>	%cl, %edx /* Right rotate EDX (TSC&amp;0xFF ^ (TSC&gt;&gt;8 &amp; 0xFF))&amp;1F */
	<span class="enscript-keyword">shl</span>	$32, %rdx
	<span class="enscript-keyword">xor</span>	%rdx, %rax
	<span class="enscript-keyword">mov</span>	%cl, %al
	<span class="enscript-keyword">jmp</span>	Lstore_random_guard
/*
 <span class="enscript-keyword">*</span> AP (slave) CPUs enter here.
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> Environment:
 <span class="enscript-keyword">*</span>	protected mode, no paging, flat 32-bit address space.
 <span class="enscript-keyword">*</span>	(Code/data/stack segments have base == 0, limit == 4G)
 <span class="enscript-keyword">*/
</span>	<span class="enscript-keyword">.align</span>	ALIGN
	<span class="enscript-keyword">.globl</span>	EXT(slave_pstart)
LEXT(slave_pstart)
	<span class="enscript-keyword">.code32
</span>	<span class="enscript-keyword">cli</span>				/* disable interrupts, so we don`t */
					<span class="enscript-keyword">/*</span> need IDT for a while */
	<span class="enscript-keyword">POSTCODE(SLAVE_PSTART)
</span>
	<span class="enscript-keyword">movl</span>	$EXT(mp_slave_stack) + PAGE_SIZE, %esp

	<span class="enscript-keyword">xor</span> 	%edi, %edi		/* AP, no <span class="enscript-string">&quot;kernbootstruct&quot;</span> */

	<span class="enscript-keyword">jmp</span>	L_pstart_common		/* hop a ride to vstart() */


/* BEGIN HIBERNATE CODE */

.section __HIB, __text
/*
 <span class="enscript-keyword">*</span> This code is linked into the kernel but part of the <span class="enscript-string">&quot;__HIB&quot;</span> section,
 <span class="enscript-keyword">*</span> which means it's used by code running in the special context of restoring
 <span class="enscript-keyword">*</span> the kernel text and data from the hibernation image read by the booter.
 <span class="enscript-keyword">*</span> hibernate_kernel_entrypoint() and everything it calls or references
 <span class="enscript-keyword">*</span> (ie. hibernate_restore_phys_page()) needs to be careful to only touch
 <span class="enscript-keyword">*</span> memory also in the <span class="enscript-string">&quot;__HIB&quot;</span> section.
 <span class="enscript-keyword">*/
</span>
	<span class="enscript-keyword">.align</span>	ALIGN
	<span class="enscript-keyword">.globl</span>	EXT(hibernate_machine_entrypoint)
.code32
LEXT(hibernate_machine_entrypoint)
	<span class="enscript-keyword">movl</span>    %eax, %edi /* regparm(1) calling convention */

	<span class="enscript-keyword">/*</span> Use low 32-bits of address as 32-bit stack */
	<span class="enscript-keyword">movl</span> $EXT(low_eintstack), %esp
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">/*
</span>	 <span class="enscript-keyword">*</span> Set up GDT
	 <span class="enscript-keyword">*/
</span>	<span class="enscript-keyword">movl</span>	$EXT(master_gdtr), %eax
	<span class="enscript-keyword">lgdtl</span>	(%eax)

	<span class="enscript-keyword">/*</span> Switch to 64-bit on the Boot PTs */
	<span class="enscript-keyword">SWITCH_TO_64BIT_MODE
</span>
	<span class="enscript-keyword">leaq</span>	EXT(hibernate_kernel_entrypoint)(%rip),%rcx

	<span class="enscript-keyword">/*</span> adjust the pointers to be up high */
	<span class="enscript-keyword">movq</span>	$0xffffff8000000000, %rax
	<span class="enscript-keyword">orq</span>	%rax, %rsp
	<span class="enscript-keyword">orq</span>	%rcx, %rax

	<span class="enscript-keyword">/*</span> %edi is already filled with header pointer */
	<span class="enscript-keyword">xorl</span>	%esi, %esi			/* zero 2nd arg */
	<span class="enscript-keyword">xorl</span>	%edx, %edx			/* zero 3rd arg */
	<span class="enscript-keyword">xorl</span>	%ecx, %ecx			/* zero 4th arg */
	<span class="enscript-keyword">andq</span>	$0xfffffffffffffff0, %rsp	/* align stack */

	<span class="enscript-keyword">/*</span> call instead of jmp to keep the required stack alignment */
	<span class="enscript-keyword">xorq</span>	%rbp, %rbp			/* zero frame pointer */
	<span class="enscript-keyword">call</span>	*%rax

	<span class="enscript-keyword">/*</span> NOTREACHED */
	<span class="enscript-keyword">hlt
</span>
/* END HIBERNATE CODE */

#if CONFIG_SLEEP
/* BEGIN ACPI WAKEUP CODE */

#include &lt;i386/acpi.h&gt;


/*
 <span class="enscript-keyword">*</span> acpi_wake_start
 <span class="enscript-keyword">*/
</span>
.section __TEXT,__text
.code64

/*
 <span class="enscript-keyword">*</span> acpi_sleep_cpu(acpi_sleep_callback func, void * refcon)
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> Save CPU state before platform sleep. Restore CPU state
 <span class="enscript-keyword">*</span> following wake up.
 <span class="enscript-keyword">*/
</span>
ENTRY(acpi_sleep_cpu)
	<span class="enscript-keyword">push</span>	%rbp
	<span class="enscript-keyword">mov</span>	%rsp, %rbp

	<span class="enscript-keyword">/*</span> save flags */
	<span class="enscript-keyword">pushf
</span>
	<span class="enscript-keyword">/*</span> save general purpose registers */
	<span class="enscript-keyword">push</span> %rax
	<span class="enscript-keyword">push</span> %rbx
	<span class="enscript-keyword">push</span> %rcx
	<span class="enscript-keyword">push</span> %rdx
	<span class="enscript-keyword">push</span> %rbp
	<span class="enscript-keyword">push</span> %rsi
	<span class="enscript-keyword">push</span> %rdi
	<span class="enscript-keyword">push</span> %r8
	<span class="enscript-keyword">push</span> %r9
	<span class="enscript-keyword">push</span> %r10
	<span class="enscript-keyword">push</span> %r11
	<span class="enscript-keyword">push</span> %r12
	<span class="enscript-keyword">push</span> %r13
	<span class="enscript-keyword">push</span> %r14
	<span class="enscript-keyword">push</span> %r15

	<span class="enscript-keyword">mov</span>	%rsp, saved_rsp(%rip)

	<span class="enscript-keyword">/*</span> make sure tlb is flushed */
	<span class="enscript-keyword">mov</span>	%cr3,%rax
	<span class="enscript-keyword">mov</span>	%rax,%cr3
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">/*</span> save control registers */
	<span class="enscript-keyword">mov</span>	%cr0, %rax
	<span class="enscript-keyword">mov</span>	%rax, saved_cr0(%rip)
	<span class="enscript-keyword">mov</span>	%cr2, %rax
	<span class="enscript-keyword">mov</span>	%rax, saved_cr2(%rip)
	<span class="enscript-keyword">mov</span>	%cr3, %rax
	<span class="enscript-keyword">mov</span>	%rax, saved_cr3(%rip)
	<span class="enscript-keyword">mov</span>	%cr4, %rax
	<span class="enscript-keyword">mov</span>	%rax, saved_cr4(%rip)

	<span class="enscript-keyword">/*</span> save segment registers */
	<span class="enscript-keyword">movw</span>	%es, saved_es(%rip)
	<span class="enscript-keyword">movw</span>	%fs, saved_fs(%rip)
	<span class="enscript-keyword">movw</span>	%gs, saved_gs(%rip)
	<span class="enscript-keyword">movw</span>	%ss, saved_ss(%rip)	

	<span class="enscript-keyword">/*</span> save the 64bit user and kernel gs base */
	<span class="enscript-keyword">/*</span> note: user's curently swapped into kernel base MSR */
	<span class="enscript-keyword">mov</span>	$MSR_IA32_KERNEL_GS_BASE, %rcx
	<span class="enscript-keyword">rdmsr
</span>	<span class="enscript-keyword">movl</span>	%eax, saved_ugs_base(%rip)
	<span class="enscript-keyword">movl</span>	%edx, saved_ugs_base+4(%rip)
	<span class="enscript-keyword">swapgs
</span>	<span class="enscript-keyword">rdmsr
</span>	<span class="enscript-keyword">movl</span>	%eax, saved_kgs_base(%rip)
	<span class="enscript-keyword">movl</span>	%edx, saved_kgs_base+4(%rip)
	<span class="enscript-keyword">swapgs
</span>
	<span class="enscript-keyword">/*</span> save descriptor table registers */
	<span class="enscript-keyword">sgdt</span>	saved_gdt(%rip)
	<span class="enscript-keyword">sldt</span>	saved_ldt(%rip)
	<span class="enscript-keyword">sidt</span>	saved_idt(%rip)
	<span class="enscript-keyword">str</span>	saved_tr(%rip)

	<span class="enscript-keyword">/*
</span>	 <span class="enscript-keyword">*</span> Call ACPI function provided by the caller to sleep the platform.
	 <span class="enscript-keyword">*</span> This call will not return on success.
	 <span class="enscript-keyword">*/
</span>
	<span class="enscript-keyword">xchgq</span> %rdi, %rsi
	<span class="enscript-keyword">call</span>	*%rsi

	<span class="enscript-keyword">/*</span> sleep failed, no cpu context lost */
	<span class="enscript-keyword">jmp</span>	wake_restore

.section __HIB, __text
.code32
.globl EXT(acpi_wake_prot)
<span class="enscript-function-name">EXT(acpi_wake_prot):</span>
	<span class="enscript-keyword">/*</span> protected mode, paging disabled */
	<span class="enscript-keyword">movl</span>	$EXT(low_eintstack), %esp

	<span class="enscript-keyword">SWITCH_TO_64BIT_MODE
</span>
	<span class="enscript-keyword">jmp</span>	Lwake_64

.section __TEXT,__text
.code64

.globl EXT(acpi_wake_prot_entry)
<span class="enscript-function-name">EXT(acpi_wake_prot_entry):</span>
	<span class="enscript-keyword">POSTCODE(ACPI_WAKE_PROT_ENTRY)
</span>	<span class="enscript-keyword">/*</span> Return from hibernate code in iokit/Kernel/IOHibernateRestoreKernel.c
	 <span class="enscript-keyword">*/
</span><span class="enscript-function-name">Lwake_64:</span>
	<span class="enscript-keyword">/*
</span>	 <span class="enscript-keyword">*</span> restore cr4, PAE and NXE states in an orderly fashion
	 <span class="enscript-keyword">*/
</span>	<span class="enscript-keyword">mov</span>	saved_cr4(%rip), %rcx
	<span class="enscript-keyword">mov</span>	%rcx, %cr4

	<span class="enscript-keyword">mov</span>	$(MSR_IA32_EFER), %ecx		/* MSR number in ecx */
	<span class="enscript-keyword">rdmsr</span>					/* MSR value in edx:eax */
	<span class="enscript-keyword">or</span>	$(MSR_IA32_EFER_NXE), %eax	/* Set NXE bit in low 32-bits */
	<span class="enscript-keyword">wrmsr</span>					/* Update */

	<span class="enscript-keyword">movq</span>	saved_cr2(%rip), %rax
	<span class="enscript-keyword">mov</span>	%rax, %cr2

	<span class="enscript-keyword">/*</span> restore CR0, paging enabled */
	<span class="enscript-keyword">mov</span>	saved_cr0(%rip), %rax
	<span class="enscript-keyword">mov</span>	%rax, %cr0

	<span class="enscript-keyword">/*</span> restore the page tables */
	<span class="enscript-keyword">mov</span>	saved_cr3(%rip), %rax
	<span class="enscript-keyword">mov</span>	%rax, %cr3

	<span class="enscript-keyword">/*</span> protected mode, paging enabled */
	<span class="enscript-keyword">POSTCODE(ACPI_WAKE_PAGED_ENTRY)
</span>
	<span class="enscript-keyword">/*</span> load null segment selectors */
	<span class="enscript-keyword">xor</span>	%eax, %eax
	<span class="enscript-keyword">movw</span>	%ax, %ss
	<span class="enscript-keyword">movw</span>	%ax, %ds

	<span class="enscript-keyword">/*</span> restore descriptor tables */
	<span class="enscript-keyword">lgdt</span>	saved_gdt(%rip)
	<span class="enscript-keyword">lldt</span>	saved_ldt(%rip)
	<span class="enscript-keyword">lidt</span>	saved_idt(%rip)

	<span class="enscript-keyword">/*</span> restore segment registers */
	<span class="enscript-keyword">movw</span>	saved_es(%rip), %es
	<span class="enscript-keyword">movw</span>	saved_fs(%rip), %fs
	<span class="enscript-keyword">movw</span>	saved_gs(%rip), %gs
	<span class="enscript-keyword">movw</span>	saved_ss(%rip), %ss

	<span class="enscript-keyword">/*</span> restore the 64bit kernel and user gs base */
	<span class="enscript-keyword">mov</span>	$MSR_IA32_KERNEL_GS_BASE, %rcx
	<span class="enscript-keyword">movl</span>	saved_kgs_base(%rip),   %eax 
	<span class="enscript-keyword">movl</span>	saved_kgs_base+4(%rip), %edx 
	<span class="enscript-keyword">wrmsr
</span>	<span class="enscript-keyword">swapgs
</span>	<span class="enscript-keyword">movl</span>	saved_ugs_base(%rip),   %eax 
	<span class="enscript-keyword">movl</span>	saved_ugs_base+4(%rip), %edx 
	<span class="enscript-keyword">wrmsr
</span>
	<span class="enscript-keyword">/*
</span>	 <span class="enscript-keyword">*</span> Restore task register. Before doing this, clear the busy flag
	 <span class="enscript-keyword">*</span> in the TSS descriptor set by the CPU.
	 <span class="enscript-keyword">*/
</span>	<span class="enscript-keyword">lea</span>	saved_gdt(%rip), %rax
	<span class="enscript-keyword">movq</span>	2(%rax), %rdx			/* GDT base, skip limit word */
	<span class="enscript-keyword">movl</span>	$(KERNEL_TSS), %eax		/* TSS segment selector */
	<span class="enscript-keyword">movb</span>	$(K_TSS), 5(%rdx, %rax)		/* clear busy flag */

	<span class="enscript-keyword">ltr</span>	saved_tr(%rip)			/* restore TR */

<span class="enscript-function-name">wake_restore:</span>
	<span class="enscript-keyword">mov</span>	saved_rsp(%rip), %rsp 

	<span class="enscript-keyword">/*</span> restore general purpose registers */
	<span class="enscript-keyword">pop</span> %r15
	<span class="enscript-keyword">pop</span> %r14
	<span class="enscript-keyword">pop</span> %r13
	<span class="enscript-keyword">pop</span> %r12
	<span class="enscript-keyword">pop</span> %r11
	<span class="enscript-keyword">pop</span> %r10
	<span class="enscript-keyword">pop</span> %r9
	<span class="enscript-keyword">pop</span> %r8
	<span class="enscript-keyword">pop</span> %rdi
	<span class="enscript-keyword">pop</span> %rsi
	<span class="enscript-keyword">pop</span> %rbp
	<span class="enscript-keyword">pop</span> %rdx
	<span class="enscript-keyword">pop</span> %rcx
	<span class="enscript-keyword">pop</span> %rbx
	<span class="enscript-keyword">pop</span> %rax

	<span class="enscript-keyword">/*</span> restore flags */
	<span class="enscript-keyword">popf
</span>
	<span class="enscript-keyword">leave
</span>	<span class="enscript-keyword">ret
</span>
/* END ACPI WAKEUP CODE */
#endif /* CONFIG_SLEEP */

/* Code to get from real mode to protected mode */

#define	operand_size_prefix	.byte 0x66
#define	address_size_prefix	.byte 0x67
#define	cs_base_prefix		.byte 0x2e

#define	LJMP(segment,address)			\
	<span class="enscript-keyword">operand_size_prefix</span>			<span class="enscript-comment">;\
	.byte	0xea				;\
</span>	<span class="enscript-keyword">.long</span>	address-EXT(real_mode_bootstrap_base)	<span class="enscript-comment">;\
	.word	segment
</span>
#define	LGDT(address)				\
	<span class="enscript-keyword">cs_base_prefix</span>				<span class="enscript-comment">;\
	address_size_prefix			;\
</span>	<span class="enscript-keyword">operand_size_prefix</span>			<span class="enscript-comment">;\
	.word	0x010f				;\
</span>	<span class="enscript-keyword">.byte</span>	0x15				<span class="enscript-comment">;\
	.long	address-EXT(real_mode_bootstrap_base)
</span>
.section __HIB, __text
.align	12	/* Page align for single bcopy_phys() */
.code32
Entry(real_mode_bootstrap_base)
	<span class="enscript-keyword">cli
</span>
	<span class="enscript-keyword">LGDT(EXT(protected_mode_gdtr))
</span>
	<span class="enscript-keyword">/*</span> set the PE bit of CR0 */
	<span class="enscript-keyword">mov</span>	%cr0, %eax
	<span class="enscript-keyword">inc</span> %eax
	<span class="enscript-keyword">mov</span>	%eax, %cr0 

	<span class="enscript-keyword">/*</span> reload CS register */
	<span class="enscript-keyword">LJMP(KERNEL32_CS,</span> 1f + REAL_MODE_BOOTSTRAP_OFFSET)
<span class="enscript-function-name">1:</span>
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">/*</span> we are in protected mode now */
	<span class="enscript-keyword">/*</span> set up the segment registers */
	<span class="enscript-keyword">mov</span>	$KERNEL_DS, %eax
	<span class="enscript-keyword">movw</span>	%ax, %ds
	<span class="enscript-keyword">movw</span>	%ax, %es
	<span class="enscript-keyword">movw</span>	%ax, %ss
	<span class="enscript-keyword">xor</span>	%eax,%eax
	<span class="enscript-keyword">movw</span>	%ax, %fs
	<span class="enscript-keyword">movw</span>	%ax, %gs

	<span class="enscript-keyword">POSTCODE(SLAVE_STARTPROG_ENTRY);
</span>
	<span class="enscript-keyword">mov</span>	PROT_MODE_START+REAL_MODE_BOOTSTRAP_OFFSET, %ecx
	<span class="enscript-keyword">jmp</span> 	*%ecx

Entry(protected_mode_gdtr)
	<span class="enscript-keyword">.short</span>	160		/* limit (8*20 segs) */
	<span class="enscript-keyword">.quad</span>	EXT(master_gdt)

Entry(real_mode_bootstrap_end)

/* Save area used across sleep/wake */
.section __HIB, __data
.align	2

/* gdtr for real address of master_gdt in HIB (not the aliased address) */
Entry(master_gdtr)			
		<span class="enscript-keyword">.word</span> 160		/* limit (8*20 segs) */
		<span class="enscript-keyword">.quad</span> EXT(master_gdt)

<span class="enscript-function-name">saved_gdt:</span>	.word 0
		<span class="enscript-keyword">.quad</span> 0
<span class="enscript-function-name">saved_rsp:</span>	.quad 0
<span class="enscript-function-name">saved_es:</span>	.word 0
<span class="enscript-function-name">saved_fs:</span>	.word 0
<span class="enscript-function-name">saved_gs:</span>	.word 0
<span class="enscript-function-name">saved_ss:</span>	.word 0
<span class="enscript-function-name">saved_cr0:</span>	.quad 0
<span class="enscript-function-name">saved_cr2:</span>	.quad 0
<span class="enscript-function-name">saved_cr3:</span>	.quad 0
<span class="enscript-function-name">saved_cr4:</span>	.quad 0
<span class="enscript-function-name">saved_idt:</span>	.word 0
		<span class="enscript-keyword">.quad</span> 0
<span class="enscript-function-name">saved_ldt:</span>	.word 0
<span class="enscript-function-name">saved_tr:</span>	.word 0
<span class="enscript-function-name">saved_kgs_base:</span>	.quad 0
<span class="enscript-function-name">saved_ugs_base:</span>	.quad 0

</pre>
<hr />
</body></html>