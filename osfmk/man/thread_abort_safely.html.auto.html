<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>thread_abort_safely.html</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">thread_abort_safely.html&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-keyword">&lt;h2&gt;</span>thread_abort_safely<span class="enscript-keyword">&lt;/h2&gt;</span>
<span class="enscript-keyword">&lt;hr&gt;</span>
<span class="enscript-keyword">&lt;p&gt;</span>
<span class="enscript-keyword">&lt;strong&gt;</span>Function<span class="enscript-keyword">&lt;/strong&gt;</span> - Abort a thread, restartably.
<span class="enscript-keyword">&lt;h3&gt;</span>SYNOPSIS<span class="enscript-keyword">&lt;/h3&gt;</span>
<span class="enscript-keyword">&lt;pre&gt;</span>
<span class="enscript-keyword">&lt;strong&gt;</span>kern_return_t   thread_abort_safely<span class="enscript-keyword">&lt;/strong&gt;</span>
                <span class="enscript-keyword">&lt;strong&gt;</span>(thread_act_t<span class="enscript-keyword">&lt;/strong&gt;</span>                     <span class="enscript-keyword">&lt;var&gt;</span>target_thread<span class="enscript-keyword">&lt;/var&gt;</span><span class="enscript-keyword">&lt;strong&gt;</span>);<span class="enscript-keyword">&lt;/strong&gt;</span>
<span class="enscript-keyword">&lt;/pre&gt;</span>
<span class="enscript-keyword">&lt;h3&gt;</span>PARAMETERS<span class="enscript-keyword">&lt;/h3&gt;</span>
<span class="enscript-keyword">&lt;dl&gt;</span>
<span class="enscript-keyword">&lt;p&gt;</span>
<span class="enscript-keyword">&lt;dt&gt;</span> <span class="enscript-keyword">&lt;var&gt;</span>target_thread<span class="enscript-keyword">&lt;/var&gt;</span> 
<span class="enscript-keyword">&lt;dd&gt;</span>
[in thread send right]
The thread to be aborted.
<span class="enscript-keyword">&lt;/dl&gt;</span>
<span class="enscript-keyword">&lt;h3&gt;</span>DESCRIPTION<span class="enscript-keyword">&lt;/h3&gt;</span>
<span class="enscript-keyword">&lt;p&gt;</span>
The <span class="enscript-keyword">&lt;strong&gt;</span>thread_abort_safely<span class="enscript-keyword">&lt;/strong&gt;</span> function aborts page faults and any message
primitive calls in use by <span class="enscript-keyword">&lt;var&gt;</span>target_thread<span class="enscript-keyword">&lt;/var&gt;</span>.  Scheduling depressions
and clock sleeps are 
also aborted.  The call returns a code indicating that it was
interrupted.  The call 
is interrupted even if the thread (or the task containing it)
is suspended.  If it is 
suspended, the thread receives the interrupt when it resumes.
<span class="enscript-keyword">&lt;p&gt;</span>
If its state is not modified before it resumes, the thread will
retry an aborted 
page fault.  The Mach message trap returns either
<span class="enscript-keyword">&lt;strong&gt;</span>MACH_SEND_INTERRUPTED<span class="enscript-keyword">&lt;/strong&gt;</span> or <span class="enscript-keyword">&lt;strong&gt;</span>MACH_RCV_INTERRUPTED<span class="enscript-keyword">&lt;/strong&gt;</span>, depending
on whether the send or the
receive side was interrupted.  Note, though, that the Mach message trap is 
contained within the <span class="enscript-keyword">&lt;strong&gt;</span>mach_msg<span class="enscript-keyword">&lt;/strong&gt;</span> library routine, which,
by default, retries
interrupted message calls.
<span class="enscript-keyword">&lt;p&gt;</span>
The basic purpose of <span class="enscript-keyword">&lt;strong&gt;</span>thread_abort_safely<span class="enscript-keyword">&lt;/strong&gt;</span> is to let
one thread cleanly stop
another thread (<span class="enscript-keyword">&lt;var&gt;</span>target_thread<span class="enscript-keyword">&lt;/var&gt;</span>).  The target thread is stopped
in such a manner that 
its future execution can be controlled in a predictable way.  When
<span class="enscript-keyword">&lt;strong&gt;</span>thread_abort_safely<span class="enscript-keyword">&lt;/strong&gt;</span> returns (if successful), the target
thread will appear to have just
returned from the kernel (if it had been in kernel mode).
<span class="enscript-keyword">&lt;h3&gt;</span>NOTES<span class="enscript-keyword">&lt;/h3&gt;</span>
<span class="enscript-keyword">&lt;p&gt;</span>
By way of comparison, the <span class="enscript-keyword">&lt;strong&gt;</span>thread_suspend<span class="enscript-keyword">&lt;/strong&gt;</span> function keeps
the target thread 
from executing any further instructions at the user level, including
the return 
from a system call.  The <span class="enscript-keyword">&lt;strong&gt;</span>thread_get_state<span class="enscript-keyword">&lt;/strong&gt;</span> function
returns the thread's user 
state, while <span class="enscript-keyword">&lt;strong&gt;</span>thread_set_state<span class="enscript-keyword">&lt;/strong&gt;</span> allows modification of the user state.
<span class="enscript-keyword">&lt;p&gt;</span>
A problem occurs if a suspended thread had been executing within a system 
call.  In this case, the thread has, not only a user state, but
an associated kernel 
state. (The kernel state cannot be changed with <span class="enscript-keyword">&lt;strong&gt;</span>thread_set_state<span class="enscript-keyword">&lt;/strong&gt;</span>.)
As a result, 
when the thread resumes, the system call can return, producing a change in the 
user state and, possibly, user memory.
<span class="enscript-keyword">&lt;p&gt;</span>
For a thread executing within a system call, <span class="enscript-keyword">&lt;strong&gt;</span>thread_abort_safely<span class="enscript-keyword">&lt;/strong&gt;</span>
aborts the
kernel call from the thread's point of view.  Specifically, it
resets the kernel state so 
that the thread will resume execution at the system call return,
with the return 
code value set to one of the interrupted codes.  The system call itself may
completed entirely, aborted entirely or be partially completed,
depending on when 
the abort is received.  As a result, if the thread's user state
has been modified by 
<span class="enscript-keyword">&lt;strong&gt;</span>thread_set_state<span class="enscript-keyword">&lt;/strong&gt;</span>, it will not be altered un-predictably
by any unexpected
system call side effects.
<span class="enscript-keyword">&lt;p&gt;</span>
For example, to simulate a POSIX signal, use the following sequence of calls:
<span class="enscript-keyword">&lt;dl&gt;</span>
<span class="enscript-keyword">&lt;dd&gt;</span>
<span class="enscript-keyword">&lt;strong&gt;</span>thread_suspend<span class="enscript-keyword">&lt;/strong&gt;</span>\(emTo stop the thread.
<span class="enscript-keyword">&lt;dd&gt;</span>
<span class="enscript-keyword">&lt;strong&gt;</span>thread_abort_safely<span class="enscript-keyword">&lt;/strong&gt;</span>\(emTo interrupt any system call in
progress and set the 
return value to &quot;interrupted&quot;.  Because the thread is already stopped, it will 
not return to user code.
<span class="enscript-keyword">&lt;dd&gt;</span>
<span class="enscript-keyword">&lt;strong&gt;</span>thread_set_state<span class="enscript-keyword">&lt;/strong&gt;</span>\(emTo modify the thread's user state to simulate a
procedure call to the signal handler.
<span class="enscript-keyword">&lt;dd&gt;</span>
<span class="enscript-keyword">&lt;strong&gt;</span>thread_resume<span class="enscript-keyword">&lt;/strong&gt;</span>\(emTo resume execution at the signal handler.
If the thread's 
stack is set up correctly, the thread can return to the interrupted
system call. 
Note that the code to push an extra stack frame and change the registers is 
highly machine dependent.
<span class="enscript-keyword">&lt;/dl&gt;</span>
<span class="enscript-keyword">&lt;h3&gt;</span>CAUTIONS<span class="enscript-keyword">&lt;/h3&gt;</span>
<span class="enscript-keyword">&lt;p&gt;</span>
As a rule, do not use <span class="enscript-keyword">&lt;strong&gt;</span>thread_abort_safely<span class="enscript-keyword">&lt;/strong&gt;</span> on a non-suspended
thread.  This
operation is very risky because it is difficult to know which
system trap, if any, is 
executing and whether an interrupt return will result in some useful action by 
the thread.
<span class="enscript-keyword">&lt;p&gt;</span>
<span class="enscript-keyword">&lt;strong&gt;</span>thread_abort_safely<span class="enscript-keyword">&lt;/strong&gt;</span> will not abort any non-atomic operation
(such as a
multi-page <span class="enscript-keyword">&lt;strong&gt;</span>memory_object_data_supply<span class="enscript-keyword">&lt;/strong&gt;</span> or exception processing)
but will return an 
error instead.  The caller of this function must then allow the
thread to resume 
and attempt to abort it later.  If the thread must be aborted,
even if doing so 
would abort any non-atomic operations, <span class="enscript-keyword">&lt;strong&gt;</span>thread_abort<span class="enscript-keyword">&lt;/strong&gt;</span> would be used.
<span class="enscript-keyword">&lt;h3&gt;</span>RETURN VALUES<span class="enscript-keyword">&lt;/h3&gt;</span>
<span class="enscript-keyword">&lt;dl&gt;</span>
<span class="enscript-keyword">&lt;p&gt;</span>
<span class="enscript-keyword">&lt;dt&gt;</span> <span class="enscript-keyword">&lt;strong&gt;</span>KERN_FAILURE<span class="enscript-keyword">&lt;/strong&gt;</span>
<span class="enscript-keyword">&lt;dd&gt;</span>
The thread is in the middle of a non-restartable operation.
<span class="enscript-keyword">&lt;/dl&gt;</span>
<span class="enscript-keyword">&lt;h3&gt;</span>RELATED INFORMATION<span class="enscript-keyword">&lt;/h3&gt;</span>
<span class="enscript-keyword">&lt;p&gt;</span>
Functions:
<span class="enscript-keyword">&lt;a href=</span><span class="enscript-string">&quot;mach_msg.html&quot;</span><span class="enscript-keyword">&gt;</span><span class="enscript-keyword">&lt;strong&gt;</span>mach_msg<span class="enscript-keyword">&lt;/strong&gt;</span><span class="enscript-keyword">&lt;/a&gt;</span>,
<span class="enscript-keyword">&lt;a href=</span><span class="enscript-string">&quot;thread_get_state.html&quot;</span><span class="enscript-keyword">&gt;</span><span class="enscript-keyword">&lt;strong&gt;</span>thread_get_state<span class="enscript-keyword">&lt;/strong&gt;</span><span class="enscript-keyword">&lt;/a&gt;</span>,
<span class="enscript-keyword">&lt;a href=</span><span class="enscript-string">&quot;thread_info.html&quot;</span><span class="enscript-keyword">&gt;</span><span class="enscript-keyword">&lt;strong&gt;</span>thread_info<span class="enscript-keyword">&lt;/strong&gt;</span><span class="enscript-keyword">&lt;/a&gt;</span>,
<span class="enscript-keyword">&lt;a href=</span><span class="enscript-string">&quot;thread_set_state.html&quot;</span><span class="enscript-keyword">&gt;</span><span class="enscript-keyword">&lt;strong&gt;</span>thread_set_state<span class="enscript-keyword">&lt;/strong&gt;</span><span class="enscript-keyword">&lt;/a&gt;</span>,
<span class="enscript-keyword">&lt;a href=</span><span class="enscript-string">&quot;thread_suspend.html&quot;</span><span class="enscript-keyword">&gt;</span><span class="enscript-keyword">&lt;strong&gt;</span>thread_suspend<span class="enscript-keyword">&lt;/strong&gt;</span><span class="enscript-keyword">&lt;/a&gt;</span>,
<span class="enscript-keyword">&lt;a href=</span><span class="enscript-string">&quot;thread_terminate.html&quot;</span><span class="enscript-keyword">&gt;</span><span class="enscript-keyword">&lt;strong&gt;</span>thread_terminate<span class="enscript-keyword">&lt;/strong&gt;</span><span class="enscript-keyword">&lt;/a&gt;</span>,
<span class="enscript-keyword">&lt;a href=</span><span class="enscript-string">&quot;thread_abort.html&quot;</span><span class="enscript-keyword">&gt;</span><span class="enscript-keyword">&lt;strong&gt;</span>thread_abort<span class="enscript-keyword">&lt;/strong&gt;</span><span class="enscript-keyword">&lt;/a&gt;</span>.
</pre>
<hr />
</body></html>