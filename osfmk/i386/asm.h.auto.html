<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>asm.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">asm.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*
 * @OSF_COPYRIGHT@
 */</span>
<span class="enscript-comment">/* 
 * Mach Operating System
 * Copyright (c) 1991,1990,1989 Carnegie Mellon University
 * All Rights Reserved.
 * 
 * Permission to use, copy, modify and distribute this software and its
 * documentation is hereby granted, provided that both the copyright
 * notice and this permission notice appear in all copies of the
 * software, derivative works or modified versions, and any portions
 * thereof, and that both notices appear in supporting documentation.
 * 
 * CARNEGIE MELLON ALLOWS FREE USE OF THIS SOFTWARE IN ITS &quot;AS IS&quot;
 * CONDITION.  CARNEGIE MELLON DISCLAIMS ANY LIABILITY OF ANY KIND FOR
 * ANY DAMAGES WHATSOEVER RESULTING FROM THE USE OF THIS SOFTWARE.
 * 
 * Carnegie Mellon requests users of this software to return to
 * 
 *  Software Distribution Coordinator  or  <a href="mailto:Software.Distribution@CS.CMU.EDU">Software.Distribution@CS.CMU.EDU</a>
 *  School of Computer Science
 *  Carnegie Mellon University
 *  Pittsburgh PA 15213-3890
 * 
 * any improvements or extensions that they make and grant Carnegie Mellon
 * the rights to redistribute these changes.
 */</span>

#<span class="enscript-reference">ifndef</span>	<span class="enscript-variable-name">_I386_ASM_H_</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">_I386_ASM_H_</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">_KERNEL</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;gprof.h&gt;</span>
#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* _KERNEL */</span>

#<span class="enscript-reference">if</span>	<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">MACH_KERNEL</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">_KERNEL</span>)
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;gprof.h&gt;</span>
#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* MACH_KERNEL || _KERNEL */</span>

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__i386__</span>)

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">S_PC</span>	 (%esp)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">S_ARG0</span>	 4(%esp)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">S_ARG1</span>	 8(%esp)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">S_ARG2</span>	12(%esp)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">S_ARG3</span>	16(%esp)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">S_ARG4</span>	20(%esp)

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">FRAME</span>	pushl %ebp; movl %esp, %ebp
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">EMARF</span>	leave

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">B_LINK</span>	 (%ebp)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">B_PC</span>	 4(%ebp)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">B_ARG0</span>	 8(%ebp)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">B_ARG1</span>	12(%ebp)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">B_ARG2</span>	16(%ebp)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">B_ARG3</span>	20(%ebp)

#<span class="enscript-reference">elif</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__x86_64__</span>)

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">S_PC</span>	 (%rsp)

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">FRAME</span>	pushq %rbp; movq %rsp, %rbp
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">EMARF</span>	leave

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">B_LINK</span>	 (%rbp)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">B_PC</span>	 8(%rbp)

#<span class="enscript-reference">else</span>
#<span class="enscript-reference">error</span> <span class="enscript-variable-name">unsupported</span> <span class="enscript-variable-name">architecture</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">/* There is another definition of ALIGN for .c sources */</span>
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">ASSEMBLER</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ALIGN</span> 4,0x90
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* ASSEMBLER */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">FALIGN</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">FALIGN</span> ALIGN
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">define</span> <span class="enscript-function-name">LB</span>(x,n) n
#<span class="enscript-reference">if</span>	<span class="enscript-variable-name">__STDC__</span>
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">__NO_UNDERSCORES__</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">LCL</span>(x)	L ## x
#<span class="enscript-reference">define</span> <span class="enscript-function-name">EXT</span>(x) _ ## x
#<span class="enscript-reference">define</span> <span class="enscript-function-name">LEXT</span>(x) _ ## x ## :
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">LCL</span>(x)	.L ## x
#<span class="enscript-reference">define</span> <span class="enscript-function-name">EXT</span>(x) x
#<span class="enscript-reference">define</span> <span class="enscript-function-name">LEXT</span>(x) x ## :
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">LBc</span>(x,n) n ## :
#<span class="enscript-reference">define</span> <span class="enscript-function-name">LBb</span>(x,n) n ## b
#<span class="enscript-reference">define</span> <span class="enscript-function-name">LBf</span>(x,n) n ## f
#<span class="enscript-reference">else</span> <span class="enscript-comment">/* __STDC__ */</span>
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">__NO_UNDERSCORES__</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">LCL</span>(x) L<span class="enscript-comment">/**/</span>x
#<span class="enscript-reference">define</span> <span class="enscript-function-name">EXT</span>(x) _<span class="enscript-comment">/**/</span>x
#<span class="enscript-reference">define</span> <span class="enscript-function-name">LEXT</span>(x) _<span class="enscript-comment">/**/</span>x<span class="enscript-comment">/**/</span>:
#<span class="enscript-reference">else</span> <span class="enscript-comment">/* __NO_UNDERSCORES__ */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">LCL</span>(x)	.L<span class="enscript-comment">/**/</span>x
#<span class="enscript-reference">define</span> <span class="enscript-function-name">EXT</span>(x) x
#<span class="enscript-reference">define</span> <span class="enscript-function-name">LEXT</span>(x) x<span class="enscript-comment">/**/</span>:
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* __NO_UNDERSCORES__ */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">LBc</span>(x,n) n<span class="enscript-comment">/**/</span>:
#<span class="enscript-reference">define</span> <span class="enscript-function-name">LBb</span>(x,n) n<span class="enscript-comment">/**/</span>b
#<span class="enscript-reference">define</span> <span class="enscript-function-name">LBf</span>(x,n) n<span class="enscript-comment">/**/</span>f
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* __STDC__ */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SVC</span> .byte 0x9a; .long 0; .word 0x7

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">RPC_SVC</span> .byte 0x9a; .long 0; .word 0xf

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">String</span>	.asciz
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">Value</span>	.word
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Times</span>(a,b) (a*b)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Divide</span>(a,b) (a/b)

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">INB</span>	inb	%dx, %al
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">OUTB</span>	outb	%al, %dx
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">INL</span>	inl	%dx, %eax
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">OUTL</span>	outl	%eax, %dx

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">data16</span>	.byte 0x66
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">addr16</span>	.byte 0x67

#<span class="enscript-reference">if</span> !<span class="enscript-variable-name">GPROF</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MCOUNT</span>

#<span class="enscript-reference">elif</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__SHARED__</span>)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MCOUNT</span>		; .data;\
			.align ALIGN;\
			LBc(x, 8) .<span class="enscript-type">long</span> 0;\
			.text;\
			Gpush;\
			Gload;\
			leal Gotoff(LBb(x,8)),%edx;\
			Egaddr(%eax,_mcount_ptr);\
			Gpop;\
			call *(%eax);

#<span class="enscript-reference">else</span>	<span class="enscript-comment">/* !GPROF, !__SHARED__ */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MCOUNT</span>		; call mcount;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* GPROF */</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">__ELF__</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">ELF_FUNC</span>(x)	.type x,@function
#<span class="enscript-reference">define</span> <span class="enscript-function-name">ELF_DATA</span>(x)	.type x,@object
#<span class="enscript-reference">define</span> <span class="enscript-function-name">ELF_SIZE</span>(x,s)	.size x,s
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">ELF_FUNC</span>(x)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">ELF_DATA</span>(x)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">ELF_SIZE</span>(x,s)
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">Entry</span>(x)	.globl EXT(x); ELF_FUNC(EXT(x)); .align FALIGN; LEXT(x)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ENTRY</span>(x)	Entry(x) MCOUNT
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ENTRY2</span>(x,y)	.globl EXT(x); .globl EXT(y); \
			ELF_FUNC(EXT(x)); ELF_FUNC(EXT(y)); \
			.align FALIGN; LEXT(x); LEXT(y) \
			MCOUNT
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">__STDC__</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ASENTRY</span>(x) 	.globl x; .align FALIGN; x ## : ELF_FUNC(x) MCOUNT
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">ASENTRY</span>(x) 	.globl x; .align FALIGN; x: ELF_FUNC(x) MCOUNT
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* __STDC__ */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">DATA</span>(x)		.globl EXT(x); ELF_DATA(EXT(x)); .align ALIGN; LEXT(x)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">End</span>(x)		ELF_SIZE(x,.-x)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">END</span>(x)		End(EXT(x))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">ENDDATA</span>(x)	END(x)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Enddata</span>(x)	End(x)

<span class="enscript-comment">/*
 * ELF shared library accessor macros.
 * Gpush saves the %ebx register used for the GOT address
 * Gpop pops %ebx if we need a GOT
 * Gload loads %ebx with the GOT address if shared libraries are used
 * Gcall calls an external function.
 * Gotoff allows you to reference local labels.
 * Gotoff2 allows you to reference local labels with an index reg.
 * Gotoff3 allows you to reference local labels with an index reg &amp; size.
 * Gaddr loads up a register with an address of an external item.
 * Gstack is the number of bytes that Gpush pushes on the stack.
 *
 * Varients of the above with E or L prefixes do EXT(name) or LCL(name)
 * respectively.
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">__SHARED__</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">Gpush</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">Gpop</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">Gload</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Gcall</span>(func)		call func
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Gotoff</span>(lab)		lab
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Gotoff2</span>(l,r)		l(r)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Gotoff3</span>(l,r,s)		l(,r,s)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Gaddr</span>(to,lab)		movl $lab,to
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Gcmp</span>(lab,reg)		cmpl $lab,reg
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Gmemload</span>(lab,reg)	movl lab,reg
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Gmemstore</span>(reg,lab,tmp)	movl reg,lab
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">Gstack</span>			0

#<span class="enscript-reference">else</span>
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">__ELF__</span>			<span class="enscript-comment">/* ELF shared libraries */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">Gpush</span>			pushl %ebx
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">Gpop</span>			popl %ebx
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">Gload</span>			call 9f; 9: popl %ebx; addl $_GLOBAL_OFFSET_TABLE_+[.-9b],%ebx
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Gcall</span>(func)		call EXT(func)@PLT
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Gotoff</span>(lab)		lab@GOTOFF(%ebx)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Gotoff2</span>(l,r)		l@GOTOFF(%ebx,r)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Gotoff3</span>(l,r,s)		l@GOTOFF(%ebx,r,s)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Gaddr</span>(to,lab)		movl lab@GOT(%ebx),to
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Gcmp</span>(lab,reg)		cmpl reg,lab@GOT(%ebx)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Gmemload</span>(lab,reg)	movl lab@GOT(%ebx),reg; movl (reg),reg
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Gmemstore</span>(reg,lab,tmp)	movl lab@GOT(%ebx),tmp; movl reg,(tmp)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">Gstack</span>			4

#<span class="enscript-reference">else</span>				<span class="enscript-comment">/* ROSE shared libraries */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">Gpush</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">Gpop</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">Gload</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Gcall</span>(func)		call *9f; .data; .align ALIGN; 9: .long func; .text
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Gotoff</span>(lab)		lab
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Gotoff2</span>(l,r)		l(r)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Gotoff3</span>(l,r,s)		l(,r,s)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Gaddr</span>(to,lab)		movl 9f,to; .data; .align ALIGN; 9: .long lab; .text
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Gcmp</span>(lab,reg)		cmpl reg,9f; .data; .align ALIGN; 9: .long lab; .text
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Gmemload</span>(lab,reg)	movl 9f,reg; movl (reg),reg; .data; .align ALIGN; 9: .long lab; .text
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Gmemstore</span>(reg,lab,tmp)	movl 9f,tmp; movl reg,(tmp); .data; .align ALIGN; 9: .long lab; .text
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">Gstack</span>			0
#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* __ELF__ */</span>
#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* __SHARED__ */</span>

<span class="enscript-comment">/* Egotoff is not provided, since external symbols should not use @GOTOFF
   relocations.  */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Egcall</span>(func)		Gcall(EXT(func))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Egaddr</span>(to,lab)		Gaddr(to,EXT(lab))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Egcmp</span>(lab,reg)		Gcmp(EXT(lab),reg)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Egmemload</span>(lab,reg)	Gmemload(EXT(lab),reg)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Egmemstore</span>(reg,lab,tmp)	Gmemstore(reg,EXT(lab),tmp)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">Lgotoff</span>(lab)		Gotoff(LCL(lab))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Lgotoff2</span>(l,r)		Gotoff2(LCL(l),r)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Lgotoff3</span>(l,r,s)		Gotoff3(LCL(l),r,s)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Lgcmp</span>(lab,reg)		Gcmp(LCL(lab),reg)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Lgmemload</span>(lab,reg)	movl Lgotoff(lab),reg
#<span class="enscript-reference">define</span> <span class="enscript-function-name">Lgmemstore</span>(reg,lab,tmp)	movl reg,Lgotoff(lab)

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">ASSEMBLER</span>
<span class="enscript-comment">/* These defines are here for .c files that wish to reference global symbols
 * within __asm__ statements. 
 */</span>
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">__NO_UNDERSCORES__</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CC_SYM_PREFIX</span> <span class="enscript-string">&quot;_&quot;</span>
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CC_SYM_PREFIX</span> <span class="enscript-string">&quot;&quot;</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* __NO_UNDERSCORES__ */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* ASSEMBLER */</span>

<span class="enscript-comment">/*
 * The following macros make calls into C code.
 * They dynamically align the stack to 16 bytes.
 */</span>
#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__i386__</span>)
<span class="enscript-comment">/*
 * Arguments are moved (not pushed) onto the correctly aligned stack.
 * NOTE: ESI is destroyed in the process, and hence cannot
 * be directly used as a parameter. Users of this macro must
 * independently preserve ESI (a non-volatile) if the routine is
 * intended to be called from C, for instance.
 */</span>

#<span class="enscript-reference">define</span> <span class="enscript-function-name">CCALL</span>(fn)			\
	movl	%esp, %esi		;\
	andl	$0xFFFFFFF0, %esp	;\
	call	EXT(fn)			;\
	movl	%esi, %esp

#<span class="enscript-reference">define</span> <span class="enscript-function-name">CCALL1</span>(fn, arg1)		\
	movl	%esp, %esi		;\
	subl	$4, %esp		;\
	andl	$0xFFFFFFF0, %esp	;\
	movl	arg1, (%esp)		;\
	call	EXT(fn)			;\
	movl	%esi, %esp

#<span class="enscript-reference">define</span> <span class="enscript-function-name">CCALL2</span>(fn, arg1, arg2)		\
	movl	%esp, %esi		;\
	subl	$8, %esp		;\
	andl	$0xFFFFFFF0, %esp	;\
	movl	arg2, 4(%esp)		;\
	movl	arg1, (%esp)		;\
	call	EXT(fn)			;\
	movl	%esi, %esp

<span class="enscript-comment">/* This variant exists to permit adjustment of the stack by &quot;dtrace&quot; */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">CCALL1WITHSP</span>(fn, arg1)		\
	movl	%esp, %esi		;\
	subl	$12, %esp		;\
	andl	$0xFFFFFFF0, %esp	;\
	movl	%esi, 8(%esp)		;\
	leal	8(%esp), %esi		;\
	movl	%esi, 4(%esp)		;\
	movl	arg1, (%esp)		;\
	call	EXT(fn)			;\
	movl	8(%esp), %esp

<span class="enscript-comment">/*
 * CCALL5 is used for callee functions with 3 arguments but
 * where arg2 (a3:a2) and arg3 (a5:a4) are 64-bit values.
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">CCALL5</span>(fn, a1, a2, a3, a4, a5)	\
	movl	%esp, %esi		;\
	subl	$20, %esp		;\
	andl	$0xFFFFFFF0, %esp	;\
	movl	a5, 16(%esp)		;\
	movl	a4, 12(%esp)		;\
	movl	a3,  8(%esp)		;\
	movl	a2,  4(%esp)		;\
	movl	a1,  (%esp)		;\
	call	EXT(fn)			;\
	movl	%esi, %esp

#<span class="enscript-reference">elif</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__x86_64__</span>)

<span class="enscript-comment">/* This variant exists to permit adjustment of the stack by &quot;dtrace&quot; */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">CCALLWITHSP</span>(fn)				 \
	mov	%rsp, %r12			;\
	sub	$8, %rsp			;\
	and	$0xFFFFFFFFFFFFFFF0, %rsp	;\
	mov	%r12, (%rsp)			;\
	leaq	(%rsp), %rsi			;\
	call	EXT(fn)				;\
	mov	(%rsp), %rsp
	
#<span class="enscript-reference">define</span> <span class="enscript-function-name">CCALL</span>(fn)				 \
	mov	%rsp, %r12			;\
	and	$0xFFFFFFFFFFFFFFF0, %rsp	;\
	call	EXT(fn)				;\
	mov	%r12, %rsp

#<span class="enscript-reference">define</span> <span class="enscript-function-name">CCALL1</span>(fn, arg1) 			 \
	mov	arg1, %rdi 			;\
	CCALL(fn)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">CCALL2</span>(fn, arg1, arg2)		 	 \
	mov	arg1, %rdi 			;\
	mov	arg2, %rsi 			;\
	CCALL(fn)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">CCALL3</span>(fn, arg1, arg2, arg3) 		 \
	mov	arg1, %rdi 			;\
	mov	arg2, %rsi 			;\
	mov	arg3, %rdx 			;\
	CCALL(fn)

#<span class="enscript-reference">else</span>
#<span class="enscript-reference">error</span> <span class="enscript-variable-name">unsupported</span> <span class="enscript-variable-name">architecture</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* _I386_ASM_H_ */</span>
</pre>
<hr />
</body></html>