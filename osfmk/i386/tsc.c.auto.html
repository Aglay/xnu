<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>tsc.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">tsc.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2005-2007 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*
 * @OSF_COPYRIGHT@
 */</span>

<span class="enscript-comment">/*
 *	File:		i386/tsc.c
 *	Purpose:	Initializes the TSC and the various conversion
 *			factors needed by other parts of the system.
 */</span>


#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/mach_types.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/cpu_data.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/cpu_number.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/clock.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/host_notify.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/macro_help.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/misc_protos.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/spl.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/assert.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/vm_prot.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/pmap.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/vm_kern.h&gt;</span>		<span class="enscript-comment">/* for kernel_map */</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;architecture/i386/pio.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/machine_cpu.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/cpuid.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/mp.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/machine_routines.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/proc_reg.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/tsc.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/misc_protos.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;pexpert/pexpert.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;machine/limits.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;machine/commpage.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/kdebug.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;pexpert/device_tree.h&gt;</span>

uint64_t	busFCvtt2n = 0;
uint64_t	busFCvtn2t = 0;
uint64_t	tscFreq = 0;
uint64_t	tscFCvtt2n = 0;
uint64_t	tscFCvtn2t = 0;
uint64_t	tscGranularity = 0;
uint64_t	bus2tsc = 0;
uint64_t	busFreq = 0;
uint32_t	flex_ratio = 0;
uint32_t	flex_ratio_min = 0;
uint32_t	flex_ratio_max = 0;

uint64_t	tsc_at_boot = 0;

#<span class="enscript-reference">define</span> <span class="enscript-function-name">bit</span>(n)		(1ULL &lt;&lt; (n))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">bitmask</span>(h,l)	((bit(h)|(bit(h)-1)) &amp; ~(bit(l)-1))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">bitfield</span>(x,h,l)	(((x) &amp; bitmask(h,l)) &gt;&gt; l)

<span class="enscript-comment">/* Decimal powers: */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kilo</span> (1000ULL)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">Mega</span> (kilo * kilo)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">Giga</span> (kilo * Mega)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">Tera</span> (kilo * Giga)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">Peta</span> (kilo * Tera)

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CPU_FAMILY_PENTIUM_M</span>	(0x6)

<span class="enscript-comment">/*
 * This routine extracts a frequency property in Hz from the device tree.
 * Also reads any initial TSC value at boot from the device tree.
 */</span>
<span class="enscript-type">static</span> uint64_t
<span class="enscript-function-name">EFI_get_frequency</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *prop)
{
	uint64_t	frequency = 0;
	DTEntry		entry;
	<span class="enscript-type">void</span>		*value;
	<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>	size;

	<span class="enscript-keyword">if</span> (DTLookupEntry(0, <span class="enscript-string">&quot;/efi/platform&quot;</span>, &amp;entry) != kSuccess) {
		kprintf(<span class="enscript-string">&quot;EFI_get_frequency: didn't find /efi/platform\n&quot;</span>);
		<span class="enscript-keyword">return</span> 0;
	}
	<span class="enscript-keyword">if</span> (DTGetProperty(entry,prop,&amp;value,&amp;size) != kSuccess) {
		kprintf(<span class="enscript-string">&quot;EFI_get_frequency: property %s not found\n&quot;</span>, prop);
		<span class="enscript-keyword">return</span> 0;
	}
	<span class="enscript-keyword">if</span> (size == <span class="enscript-keyword">sizeof</span>(uint64_t)) {
		frequency = *(uint64_t *) value;
		kprintf(<span class="enscript-string">&quot;EFI_get_frequency: read %s value: %llu\n&quot;</span>,
			prop, frequency);
	}

	<span class="enscript-comment">/*
	 * While we're here, see if EFI published an initial TSC value.
	 */</span>
	<span class="enscript-keyword">if</span> (DTGetProperty(entry,<span class="enscript-string">&quot;InitialTSC&quot;</span>,&amp;value,&amp;size) == kSuccess) {
		<span class="enscript-keyword">if</span> (size == <span class="enscript-keyword">sizeof</span>(uint64_t)) {
			tsc_at_boot = *(uint64_t *) value;
			kprintf(<span class="enscript-string">&quot;EFI_get_frequency: read InitialTSC: %llu\n&quot;</span>,
				tsc_at_boot);
		}
	}

	<span class="enscript-keyword">return</span> frequency;
}

<span class="enscript-comment">/*
 * Initialize the various conversion factors needed by code referencing
 * the TSC.
 */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">tsc_init</span>(<span class="enscript-type">void</span>)
{
	boolean_t	N_by_2_bus_ratio = FALSE;

	<span class="enscript-keyword">if</span> (cpuid_vmm_present()) {
		kprintf(<span class="enscript-string">&quot;VMM vendor %u TSC frequency %u KHz bus frequency %u KHz\n&quot;</span>,
				cpuid_vmm_info()-&gt;cpuid_vmm_family,
				cpuid_vmm_info()-&gt;cpuid_vmm_tsc_frequency,
				cpuid_vmm_info()-&gt;cpuid_vmm_bus_frequency);

		<span class="enscript-keyword">if</span> (cpuid_vmm_info()-&gt;cpuid_vmm_tsc_frequency &amp;&amp;
			cpuid_vmm_info()-&gt;cpuid_vmm_bus_frequency) {

			busFreq = (uint64_t)cpuid_vmm_info()-&gt;cpuid_vmm_bus_frequency * kilo;
			busFCvtt2n = ((1 * Giga) &lt;&lt; 32) / busFreq;
			busFCvtn2t = 0xFFFFFFFFFFFFFFFFULL / busFCvtt2n;
			
			tscFreq = (uint64_t)cpuid_vmm_info()-&gt;cpuid_vmm_tsc_frequency * kilo;
			tscFCvtt2n = ((1 * Giga) &lt;&lt; 32) / tscFreq;
			tscFCvtn2t = 0xFFFFFFFFFFFFFFFFULL / tscFCvtt2n;
			
			tscGranularity = tscFreq / busFreq;
			
			bus2tsc = tmrCvt(busFCvtt2n, tscFCvtn2t);

			<span class="enscript-keyword">return</span>;
		}
	}

	<span class="enscript-keyword">switch</span> (cpuid_cpufamily()) {
	<span class="enscript-reference">default</span>: {
		uint64_t msr_flex_ratio;
		uint64_t msr_platform_info;

		<span class="enscript-comment">/* See if FLEX_RATIO is being used */</span>
		msr_flex_ratio = rdmsr64(MSR_FLEX_RATIO);
		msr_platform_info = rdmsr64(MSR_PLATFORM_INFO);
		flex_ratio_min = (uint32_t)bitfield(msr_platform_info, 47, 40);
		flex_ratio_max = (uint32_t)bitfield(msr_platform_info, 15, 8);
		<span class="enscript-comment">/* No BIOS-programed flex ratio. Use hardware max as default */</span>
		tscGranularity = flex_ratio_max;
		<span class="enscript-keyword">if</span> (msr_flex_ratio &amp; bit(16)) {
		 	<span class="enscript-comment">/* Flex Enabled: Use this MSR if less than max */</span>
			flex_ratio = (uint32_t)bitfield(msr_flex_ratio, 15, 8);
			<span class="enscript-keyword">if</span> (flex_ratio &lt; flex_ratio_max)
				tscGranularity = flex_ratio;
		}

		busFreq = EFI_get_frequency(<span class="enscript-string">&quot;FSBFrequency&quot;</span>);
		<span class="enscript-comment">/* If EFI isn't configured correctly, use a constant 
		 * value. See 6036811.
		 */</span>
		<span class="enscript-keyword">if</span> (busFreq == 0)
		    busFreq = BASE_NHM_CLOCK_SOURCE;

		<span class="enscript-keyword">break</span>;
            }
	<span class="enscript-keyword">case</span> <span class="enscript-reference">CPUFAMILY_INTEL_MEROM</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-reference">CPUFAMILY_INTEL_PENRYN</span>: {
		uint64_t	prfsts;

		prfsts = rdmsr64(IA32_PERF_STS);
		tscGranularity = (uint32_t)bitfield(prfsts, 44, 40);
		N_by_2_bus_ratio = (prfsts &amp; bit(46)) != 0;

		busFreq = EFI_get_frequency(<span class="enscript-string">&quot;FSBFrequency&quot;</span>);
	    }
	}

	<span class="enscript-keyword">if</span> (busFreq != 0) {
		busFCvtt2n = ((1 * Giga) &lt;&lt; 32) / busFreq;
		busFCvtn2t = 0xFFFFFFFFFFFFFFFFULL / busFCvtt2n;
	} <span class="enscript-keyword">else</span> {
		panic(<span class="enscript-string">&quot;tsc_init: EFI not supported!\n&quot;</span>);
	}

	kprintf(<span class="enscript-string">&quot; BUS: Frequency = %6d.%06dMHz, &quot;</span>
		<span class="enscript-string">&quot;cvtt2n = %08X.%08X, cvtn2t = %08X.%08X\n&quot;</span>,
		(uint32_t)(busFreq / Mega),
		(uint32_t)(busFreq % Mega), 
		(uint32_t)(busFCvtt2n &gt;&gt; 32), (uint32_t)busFCvtt2n,
		(uint32_t)(busFCvtn2t &gt;&gt; 32), (uint32_t)busFCvtn2t);

	<span class="enscript-keyword">if</span> (tscFreq == busFreq) {
		bus2tsc = 1;
		tscGranularity = 1;
		tscFCvtn2t = busFCvtn2t;
		tscFCvtt2n = busFCvtt2n;
	} <span class="enscript-keyword">else</span> {
		<span class="enscript-comment">/*
		 * Get the TSC increment.  The TSC is incremented by this
		 * on every bus tick.  Calculate the TSC conversion factors
		 * to and from nano-seconds.
		 * The tsc granularity is also called the &quot;bus ratio&quot;.
		 * If the N/2 bit is set this indicates the bus ration is
		 * 0.5 more than this - i.e.  that the true bus ratio
		 * is (2*tscGranularity + 1)/2.
		 */</span>
		<span class="enscript-keyword">if</span> (N_by_2_bus_ratio)
			tscFCvtt2n = busFCvtt2n * 2 / (1 + 2*tscGranularity);
		<span class="enscript-keyword">else</span>
			tscFCvtt2n = busFCvtt2n / tscGranularity;

		tscFreq = ((1 * Giga)  &lt;&lt; 32) / tscFCvtt2n;
		tscFCvtn2t = 0xFFFFFFFFFFFFFFFFULL / tscFCvtt2n;

		<span class="enscript-comment">/*
		 * Calculate conversion from BUS to TSC
		 */</span>
		bus2tsc = tmrCvt(busFCvtt2n, tscFCvtn2t);
	}

	kprintf(<span class="enscript-string">&quot; TSC: Frequency = %6d.%06dMHz, &quot;</span>
		<span class="enscript-string">&quot;cvtt2n = %08X.%08X, cvtn2t = %08X.%08X, gran = %lld%s\n&quot;</span>,
		(uint32_t)(tscFreq / Mega),
		(uint32_t)(tscFreq % Mega), 
		(uint32_t)(tscFCvtt2n &gt;&gt; 32), (uint32_t)tscFCvtt2n,
		(uint32_t)(tscFCvtn2t &gt;&gt; 32), (uint32_t)tscFCvtn2t,
		tscGranularity, N_by_2_bus_ratio ? <span class="enscript-string">&quot; (N/2)&quot;</span> : <span class="enscript-string">&quot;&quot;</span>);
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">tsc_get_info</span>(tscInfo_t *info)
{
	info-&gt;busFCvtt2n     = busFCvtt2n;
	info-&gt;busFCvtn2t     = busFCvtn2t;
	info-&gt;tscFreq        = tscFreq;
	info-&gt;tscFCvtt2n     = tscFCvtt2n;
	info-&gt;tscFCvtn2t     = tscFCvtn2t;
	info-&gt;tscGranularity = tscGranularity;
	info-&gt;bus2tsc        = bus2tsc;
	info-&gt;busFreq        = busFreq;
	info-&gt;flex_ratio     = flex_ratio;
	info-&gt;flex_ratio_min = flex_ratio_min;
	info-&gt;flex_ratio_max = flex_ratio_max;
}
</pre>
<hr />
</body></html>