<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>hpet.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">hpet.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2005-2006 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/vm_param.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/vm_prot.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/machine.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/time_value.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/spl.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/assert.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/debug.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/misc_protos.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/startup.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/clock.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/cpu_data.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/processor.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/vm_page.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/pmap.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/vm_kern.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/cpuid.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/machine_cpu.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/mp.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/machine_routines.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/pmap.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/misc_protos.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/io_map_entries.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;architecture/i386/pio.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/cpuid.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/apic.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/tsc.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/hpet.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/pmCPU.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/cpu_topology.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/cpu_threads.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;pexpert/device_tree.h&gt;</span>

<span class="enscript-comment">/* Decimal powers: */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kilo</span> (1000ULL)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">Mega</span> (kilo * kilo)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">Giga</span> (kilo * Mega)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">Tera</span> (kilo * Giga)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">Peta</span> (kilo * Tera)

vm_offset_t hpetArea = 0;			
uint32_t hpetAreap = 0;			
uint64_t hpetFemto = 0;
uint64_t hpetFreq = 0;
uint64_t hpetCvt = 0;			<span class="enscript-comment">/* (TAKE OUT LATER)  */</span>
uint64_t hpetCvtt2n = 0;
uint64_t hpetCvtn2t = 0;
uint64_t tsc2hpet = 0;
uint64_t hpet2tsc = 0;
uint64_t bus2hpet = 0;
uint64_t hpet2bus = 0;

vm_offset_t rcbaArea = 0;			
uint32_t rcbaAreap = 0;			

<span class="enscript-type">static</span> <span class="enscript-function-name">int</span> (*hpet_req)(uint32_t apicid, <span class="enscript-type">void</span> *arg, hpetRequest_t *hpet) = NULL;
<span class="enscript-type">static</span> <span class="enscript-type">void</span> *hpet_arg = NULL;

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">DEBUG</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">DBG</span>(x...)	kprintf(<span class="enscript-string">&quot;DBG: &quot;</span> x)
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">DBG</span>(x...)
#<span class="enscript-reference">endif</span>

<span class="enscript-type">int</span>
<span class="enscript-function-name">hpet_register_callback</span>(<span class="enscript-type">int</span> (*hpet_reqst)(uint32_t apicid,
					 <span class="enscript-type">void</span> *arg,
					 hpetRequest_t *hpet),
		       <span class="enscript-type">void</span> *arg)
{
    hpet_req = hpet_reqst;
    hpet_arg = arg;
    <span class="enscript-keyword">return</span>(0);
}

<span class="enscript-comment">/*
 * This routine is called to obtain an HPET and have it assigned
 * to a CPU.  It returns 0 if successful and non-zero if one could
 * not be assigned.
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">hpet_request</span>(uint32_t cpu)
{
    hpetRequest_t	hpetReq;
    <span class="enscript-type">int</span>			rc;
    x86_lcpu_t		*lcpu;
    x86_core_t		*core;
    x86_pkg_t		*pkg;
    boolean_t		enabled;

    <span class="enscript-keyword">if</span> (hpet_req == NULL) {
	<span class="enscript-keyword">return</span>(-1);
    }

    <span class="enscript-comment">/*
     * Deal with the case where the CPU # passed in is past the
     * value specified in cpus=n in boot-args.
     */</span>
    <span class="enscript-keyword">if</span> (cpu &gt;= real_ncpus) {
	enabled = ml_set_interrupts_enabled(FALSE);
	lcpu = cpu_to_lcpu(cpu);
	<span class="enscript-keyword">if</span> (lcpu != NULL) {
	    core = lcpu-&gt;core;
	    pkg  = core-&gt;package;

	    <span class="enscript-keyword">if</span> (lcpu-&gt;primary) {
		pkg-&gt;flags |= X86PKG_FL_HAS_HPET;
	    }
	}

	ml_set_interrupts_enabled(enabled);
	<span class="enscript-keyword">return</span>(0);
    }

    rc = (*hpet_req)(ml_get_apicid(cpu), hpet_arg, &amp;hpetReq);
    <span class="enscript-keyword">if</span> (rc != 0) {
	<span class="enscript-keyword">return</span>(rc);
    }

    enabled = ml_set_interrupts_enabled(FALSE);
    lcpu = cpu_to_lcpu(cpu);
    core = lcpu-&gt;core;
    pkg  = core-&gt;package;

    <span class="enscript-comment">/*
     * Compute the address of the HPET.
     */</span>
    core-&gt;Hpet = (hpetTimer_t *)((uint8_t *)hpetArea + hpetReq.hpetOffset);
    core-&gt;HpetVec = hpetReq.hpetVector;

    <span class="enscript-comment">/*
     * Enable interrupts
     */</span>
    core-&gt;Hpet-&gt;Config |= Tn_INT_ENB_CNF;

    <span class="enscript-comment">/*
     * Save the configuration
     */</span>
    core-&gt;HpetCfg = core-&gt;Hpet-&gt;Config;
    core-&gt;HpetCmp = 0;

    <span class="enscript-comment">/*
     * If the CPU is the &quot;primary&quot; for the package, then
     * add the HPET to the package too.
     */</span>
    <span class="enscript-keyword">if</span> (lcpu-&gt;primary) {
	pkg-&gt;Hpet = core-&gt;Hpet;
	pkg-&gt;HpetCfg = core-&gt;HpetCfg;
	pkg-&gt;HpetCmp = core-&gt;HpetCmp;
	pkg-&gt;flags |= X86PKG_FL_HAS_HPET;
    }

    ml_set_interrupts_enabled(enabled);

    <span class="enscript-keyword">return</span>(0);
}

<span class="enscript-comment">/*
 * Map the RCBA area.
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">map_rcbaArea</span>(<span class="enscript-type">void</span>)
{
	<span class="enscript-comment">/*
	 * Get RCBA area physical address and map it
	 */</span>
	outl(cfgAdr, lpcCfg | (0xF0 &amp; 0xFC));
	rcbaAreap = inl(cfgDat | (0xF0 &amp; 0x03));
	rcbaArea = io_map_spec(rcbaAreap &amp; -4096, PAGE_SIZE * 4, VM_WIMG_IO);
	kprintf(<span class="enscript-string">&quot;RCBA: vaddr = %lX, paddr = %08X\n&quot;</span>, (<span class="enscript-type">unsigned</span> <span class="enscript-type">long</span>)rcbaArea, rcbaAreap);
}

<span class="enscript-comment">/*
 * Initialize the HPET
 */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">hpet_init</span>(<span class="enscript-type">void</span>)
{
	<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>	*xmod;

	map_rcbaArea();

	<span class="enscript-comment">/*
	 * Is the HPET memory already enabled?
	 * If not, set address and enable.
	 */</span>
	xmod = (uint32_t *)(rcbaArea + 0x3404);	<span class="enscript-comment">/* Point to the HPTC */</span>
	uint32_t hptc = *xmod;			<span class="enscript-comment">/* Get HPET config */</span>
	DBG(<span class="enscript-string">&quot;    current RCBA.HPTC:  %08X\n&quot;</span>, *xmod);
	<span class="enscript-keyword">if</span>(!(hptc &amp; hptcAE)) {
		DBG(<span class="enscript-string">&quot;HPET memory is not enabled, &quot;</span>
		    <span class="enscript-string">&quot;enabling and assigning to 0xFED00000 (hope that's ok)\n&quot;</span>);
		*xmod = (hptc &amp; ~3) | hptcAE;
	}

	<span class="enscript-comment">/*
	 * Get physical address of HPET and map it.
	 */</span>
	hpetAreap = hpetAddr | ((hptc &amp; 3) &lt;&lt; 12);
	hpetArea = io_map_spec(hpetAreap &amp; -4096, PAGE_SIZE * 4, VM_WIMG_IO);
	kprintf(<span class="enscript-string">&quot;HPET: vaddr = %lX, paddr = %08X\n&quot;</span>, (<span class="enscript-type">unsigned</span> <span class="enscript-type">long</span>)hpetArea, hpetAreap);

	<span class="enscript-comment">/*
	 * Extract the HPET tick rate.
	 * The period of the HPET is reported in femtoseconds (10**-15s)
	 * and convert to frequency in hertz.
	 */</span>
	hpetFemto = (uint32_t)(((hpetReg_t *)hpetArea)-&gt;GCAP_ID &gt;&gt; 32);
	hpetFreq = (1 * Peta) / hpetFemto;

	<span class="enscript-comment">/*
	 * The conversion factor is the number of nanoseconds per HPET tick
	 * with about 32 bits of fraction.  The value is converted to a
	 * base-2 fixed point number.  To convert from HPET to nanoseconds,
	 * multiply the value by the conversion factor using 96-bit arithmetic,
	 * then shift right 32 bits.  If the value is known to be small,
	 * 64-bit arithmetic will work.
	 */</span>

	<span class="enscript-comment">/*
	 * Begin conversion of base 10 femtoseconds to base 2, calculate:
	 *  - HPET ticks to nanoseconds conversion in base 2 fraction (* 2**32)
	 *  - nanoseconds to HPET ticks conversion
	 */</span>
	hpetCvtt2n = (uint64_t)hpetFemto &lt;&lt; 32;
	hpetCvtt2n = hpetCvtt2n / 1000000ULL;
	hpetCvtn2t = 0xFFFFFFFFFFFFFFFFULL / hpetCvtt2n;
	kprintf(<span class="enscript-string">&quot;HPET: Frequency = %6d.%04dMHz, &quot;</span>
		<span class="enscript-string">&quot;cvtt2n = %08X.%08X, cvtn2t = %08X.%08X\n&quot;</span>,
		(uint32_t)(hpetFreq / Mega), (uint32_t)(hpetFreq % Mega), 
		(uint32_t)(hpetCvtt2n &gt;&gt; 32), (uint32_t)hpetCvtt2n,
		(uint32_t)(hpetCvtn2t &gt;&gt; 32), (uint32_t)hpetCvtn2t);


	<span class="enscript-comment">/* (TAKE OUT LATER)
	 * Begin conversion of base 10 femtoseconds to base 2
	 * HPET ticks to nanoseconds in base 2 fraction (times 1048576)
	 */</span>
	hpetCvt = (uint64_t)hpetFemto &lt;&lt; 20;
	hpetCvt = hpetCvt / 1000000ULL;

	<span class="enscript-comment">/* Calculate conversion from TSC to HPET */</span>
	tsc2hpet = tmrCvt(tscFCvtt2n, hpetCvtn2t);
	DBG(<span class="enscript-string">&quot; CVT: TSC to HPET = %08X.%08X\n&quot;</span>,
	    (uint32_t)(tsc2hpet &gt;&gt; 32), (uint32_t)tsc2hpet);

	<span class="enscript-comment">/* Calculate conversion from HPET to TSC */</span>
	hpet2tsc = tmrCvt(hpetCvtt2n, tscFCvtn2t);
	DBG(<span class="enscript-string">&quot; CVT: HPET to TSC = %08X.%08X\n&quot;</span>,
	    (uint32_t)(hpet2tsc &gt;&gt; 32), (uint32_t)hpet2tsc);

	<span class="enscript-comment">/* Calculate conversion from BUS to HPET */</span>
	bus2hpet = tmrCvt(busFCvtt2n, hpetCvtn2t);
	DBG(<span class="enscript-string">&quot; CVT: BUS to HPET = %08X.%08X\n&quot;</span>,
	    (uint32_t)(bus2hpet &gt;&gt; 32), (uint32_t)bus2hpet);

	<span class="enscript-comment">/* Calculate conversion from HPET to BUS */</span>
	hpet2bus = tmrCvt(hpetCvtt2n, busFCvtn2t);
	DBG(<span class="enscript-string">&quot; CVT: HPET to BUS = %08X.%08X\n&quot;</span>,
	    (uint32_t)(hpet2bus &gt;&gt; 32), (uint32_t)hpet2bus);
}

<span class="enscript-comment">/*
 * This routine is used to get various information about the HPET
 * without having to export gobs of globals.  It fills in a data
 * structure with the info.
 */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">hpet_get_info</span>(hpetInfo_t *info)
{
    info-&gt;hpetCvtt2n = hpetCvtt2n;
    info-&gt;hpetCvtn2t = hpetCvtn2t;
    info-&gt;tsc2hpet   = tsc2hpet;
    info-&gt;hpet2tsc   = hpet2tsc;
    info-&gt;bus2hpet   = bus2hpet;
    info-&gt;hpet2bus   = hpet2bus;
    <span class="enscript-comment">/*
     * XXX
     * We're repurposing the rcbaArea so we can use the HPET.
     * Eventually we'll rename this correctly.
     */</span>
    info-&gt;rcbaArea   = hpetArea;
    info-&gt;rcbaAreap  = hpetAreap;
}


<span class="enscript-comment">/*
 * This routine is called by the HPET driver
 * when it assigns an HPET timer to a processor.
 *
 * XXX with the new callback into the HPET driver,
 * this routine will be deprecated.
 */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">ml_hpet_cfg</span>(uint32_t cpu, uint32_t hpetVect)
{
	uint64_t	*hpetVaddr;
	hpetTimer_t	*hpet;
	x86_lcpu_t	*lcpu;
	x86_core_t	*core;
	x86_pkg_t	*pkg;
	boolean_t	enabled;
	
	<span class="enscript-keyword">if</span>(cpu &gt; 1) {
		panic(<span class="enscript-string">&quot;ml_hpet_cfg: invalid cpu = %d\n&quot;</span>, cpu);
	}

	lcpu = cpu_to_lcpu(cpu);
	core = lcpu-&gt;core;
	pkg  = core-&gt;package;

	<span class="enscript-comment">/*
	 * Only deal with the primary CPU for the package.
	 */</span>
	<span class="enscript-keyword">if</span> (!lcpu-&gt;primary)
	    <span class="enscript-keyword">return</span>;

	enabled = ml_set_interrupts_enabled(FALSE);

	<span class="enscript-comment">/* Calculate address of the HPET for this processor */</span>
	hpetVaddr = (uint64_t *)(((uintptr_t)&amp;(((hpetReg_t *)hpetArea)-&gt;TIM1_CONF)) + (cpu &lt;&lt; 5));
	hpet = (hpetTimer_t *)hpetVaddr;

	DBG(<span class="enscript-string">&quot;ml_hpet_cfg: HPET for cpu %d at %p, vector = %d\n&quot;</span>,
	     cpu, hpetVaddr, hpetVect);

	<span class="enscript-comment">/* Save the address and vector of the HPET for this processor */</span>
	core-&gt;Hpet = hpet;
	core-&gt;HpetVec = hpetVect;

	<span class="enscript-comment">/*
	 * Enable interrupts
	 */</span>
	core-&gt;Hpet-&gt;Config |= Tn_INT_ENB_CNF;

	<span class="enscript-comment">/* Save the configuration */</span>
	core-&gt;HpetCfg = core-&gt;Hpet-&gt;Config;
	core-&gt;HpetCmp = 0;

	<span class="enscript-comment">/*
	 * We're only doing this for the primary CPU, so go
	 * ahead and add the HPET to the package too.
	 */</span>
	pkg-&gt;Hpet = core-&gt;Hpet;
	pkg-&gt;HpetVec = core-&gt;HpetVec;
	pkg-&gt;HpetCfg = core-&gt;HpetCfg;
	pkg-&gt;HpetCmp = core-&gt;HpetCmp;
	pkg-&gt;flags |= X86PKG_FL_HAS_HPET;

	ml_set_interrupts_enabled(enabled);
}

<span class="enscript-comment">/*
 * This is the HPET interrupt handler.
 *
 * It just hands off to the power management code so that the
 * appropriate things get done there.
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">HPETInterrupt</span>(<span class="enscript-type">void</span>)
{

	<span class="enscript-comment">/* All we do here is to bump the count */</span>
	x86_package()-&gt;HpetInt++;

	<span class="enscript-comment">/*
	 * Let power management do it's thing.
	 */</span>
	pmHPETInterrupt();

	<span class="enscript-comment">/* Return and show that the 'rupt has been handled... */</span>
	<span class="enscript-keyword">return</span> 1;
}


<span class="enscript-type">static</span> hpetReg_t saved_hpet;

<span class="enscript-type">void</span>
<span class="enscript-function-name">hpet_save</span>(<span class="enscript-type">void</span>)
{
	hpetReg_t	*from = (hpetReg_t *) hpetArea;
	hpetReg_t	*to = &amp;saved_hpet;

	to-&gt;GEN_CONF  = from-&gt;GEN_CONF;
	to-&gt;TIM0_CONF = from-&gt;TIM0_CONF;
	to-&gt;TIM0_COMP = from-&gt;TIM0_COMP;
	to-&gt;TIM1_CONF = from-&gt;TIM1_CONF;
	to-&gt;TIM1_COMP = from-&gt;TIM1_COMP;
	to-&gt;TIM2_CONF = from-&gt;TIM2_CONF;
	to-&gt;TIM2_COMP = from-&gt;TIM2_COMP;
	to-&gt;MAIN_CNT  = from-&gt;MAIN_CNT;
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">hpet_restore</span>(<span class="enscript-type">void</span>)
{
	hpetReg_t	*from = &amp;saved_hpet;
	hpetReg_t	*to = (hpetReg_t *) hpetArea;

	<span class="enscript-comment">/*
	 * Is the HPET memory already enabled?
	 * If not, set address and enable.
	 */</span>
	uint32_t *hptcp = (uint32_t *)(rcbaArea + 0x3404);
	uint32_t hptc = *hptcp;
	<span class="enscript-keyword">if</span>(!(hptc &amp; hptcAE)) {
		DBG(<span class="enscript-string">&quot;HPET memory is not enabled, &quot;</span>
		    <span class="enscript-string">&quot;enabling and assigning to 0xFED00000 (hope that's ok)\n&quot;</span>);
		*hptcp = (hptc &amp; ~3) | hptcAE;
	}

	to-&gt;GEN_CONF  = from-&gt;GEN_CONF &amp; ~1;

	to-&gt;TIM0_CONF = from-&gt;TIM0_CONF;
	to-&gt;TIM0_COMP = from-&gt;TIM0_COMP;
	to-&gt;TIM1_CONF = from-&gt;TIM1_CONF;
	to-&gt;TIM1_COMP = from-&gt;TIM1_COMP;
	to-&gt;TIM2_CONF = from-&gt;TIM2_CONF;
	to-&gt;TIM2_COMP = from-&gt;TIM2_COMP;
	to-&gt;GINTR_STA = -1ULL;
	to-&gt;MAIN_CNT  = from-&gt;MAIN_CNT;

	to-&gt;GEN_CONF = from-&gt;GEN_CONF;
}

<span class="enscript-comment">/*
 *      Read the HPET timer
 *
 */</span>
uint64_t
<span class="enscript-function-name">rdHPET</span>(<span class="enscript-type">void</span>)
{
	hpetReg_t		*hpetp = (hpetReg_t *) hpetArea;
	<span class="enscript-type">volatile</span> uint32_t	*regp = (uint32_t *) &amp;hpetp-&gt;MAIN_CNT;
	uint32_t		high;
	uint32_t		low;

	<span class="enscript-keyword">do</span> {
		high = *(regp + 1);
		low = *regp;
	} <span class="enscript-keyword">while</span> (high != *(regp + 1));

	<span class="enscript-keyword">return</span> (((uint64_t) high) &lt;&lt; 32) | low;
}
</pre>
<hr />
</body></html>