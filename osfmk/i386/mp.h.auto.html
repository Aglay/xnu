<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>mp.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">mp.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000-2012 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*
 * @OSF_COPYRIGHT@
 */</span>
<span class="enscript-comment">/* 
 * Mach Operating System
 * Copyright (c) 1991,1990 Carnegie Mellon University
 * All Rights Reserved.
 * 
 * Permission to use, copy, modify and distribute this software and its
 * documentation is hereby granted, provided that both the copyright
 * notice and this permission notice appear in all copies of the
 * software, derivative works or modified versions, and any portions
 * thereof, and that both notices appear in supporting documentation.
 * 
 * CARNEGIE MELLON ALLOWS FREE USE OF THIS SOFTWARE IN ITS &quot;AS IS&quot;
 * CONDITION.  CARNEGIE MELLON DISCLAIMS ANY LIABILITY OF ANY KIND FOR
 * ANY DAMAGES WHATSOEVER RESULTING FROM THE USE OF THIS SOFTWARE.
 * 
 * Carnegie Mellon requests users of this software to return to
 * 
 *  Software Distribution Coordinator  or  <a href="mailto:Software.Distribution@CS.CMU.EDU">Software.Distribution@CS.CMU.EDU</a>
 *  School of Computer Science
 *  Carnegie Mellon University
 *  Pittsburgh PA 15213-3890
 * 
 * any improvements or extensions that they make and grant Carnegie Mellon
 * the rights to redistribute these changes.
 */</span>

<span class="enscript-comment">/*
 */</span>
#<span class="enscript-reference">ifdef</span>	<span class="enscript-variable-name">KERNEL_PRIVATE</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_I386_MP_H_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_I386_MP_H_</span>

<span class="enscript-comment">//#define	MP_DEBUG 1
</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/apic.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/mp_events.h&gt;</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MAX_CPUS</span>	64		<span class="enscript-comment">/* 8 * sizeof(cpumask_t) */</span>

#<span class="enscript-reference">ifndef</span>	<span class="enscript-variable-name">ASSEMBLER</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdint.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/cdefs.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/boolean.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/kern_return.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/i386/thread_status.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/vm_types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/simple_lock.h&gt;</span>

__BEGIN_DECLS

<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">intel_startCPU</span>(<span class="enscript-type">int</span> slot_num);
<span class="enscript-type">extern</span> kern_return_t <span class="enscript-function-name">intel_startCPU_fast</span>(<span class="enscript-type">int</span> slot_num);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">i386_init_slave</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">i386_init_slave_fast</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">smp_init</span>(<span class="enscript-type">void</span>);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">cpu_interrupt</span>(<span class="enscript-type">int</span> cpu);
__END_DECLS

<span class="enscript-type">extern</span>	<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>	real_ncpus;		<span class="enscript-comment">/* real number of cpus */</span>
<span class="enscript-type">extern</span>	<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>	max_ncpus;		<span class="enscript-comment">/* max number of cpus */</span>
<span class="enscript-function-name">decl_simple_lock_data</span>(<span class="enscript-type">extern</span>,kdb_lock)	<span class="enscript-comment">/* kdb lock		*/</span>

__BEGIN_DECLS

<span class="enscript-type">extern</span>  <span class="enscript-type">void</span>	console_init(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span>	<span class="enscript-type">void</span>	*console_cpu_alloc(boolean_t boot_cpu);
<span class="enscript-type">extern</span>	<span class="enscript-type">void</span>	console_cpu_free(<span class="enscript-type">void</span> *console_buf);

<span class="enscript-type">extern</span>	<span class="enscript-type">int</span>	kdb_cpu;		<span class="enscript-comment">/* current cpu running kdb	*/</span>
<span class="enscript-type">extern</span>	<span class="enscript-type">int</span>	kdb_debug;
<span class="enscript-type">extern</span>	<span class="enscript-type">int</span>	kdb_active[];

<span class="enscript-type">extern</span>	<span class="enscript-type">volatile</span> boolean_t mp_kdp_trap;
<span class="enscript-type">extern</span> 	<span class="enscript-type">volatile</span> boolean_t force_immediate_debugger_NMI;
<span class="enscript-type">extern</span>  <span class="enscript-type">volatile</span> boolean_t pmap_tlb_flush_timeout;
<span class="enscript-type">extern</span>  <span class="enscript-type">volatile</span> usimple_lock_t spinlock_timed_out;
<span class="enscript-type">extern</span>  <span class="enscript-type">volatile</span> uint32_t spinlock_owner_cpu;
<span class="enscript-type">extern</span>  uint32_t <span class="enscript-function-name">spinlock_timeout_NMI</span>(uintptr_t thread_addr);

<span class="enscript-type">extern</span>	uint64_t	LastDebuggerEntryAllowance;

<span class="enscript-type">extern</span>	<span class="enscript-type">void</span>	mp_kdp_enter(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span>	<span class="enscript-type">void</span>	mp_kdp_exit(<span class="enscript-type">void</span>);

<span class="enscript-type">extern</span>	boolean_t	mp_recent_debugger_activity(<span class="enscript-type">void</span>);

<span class="enscript-comment">/*
 * All cpu rendezvous:
 */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mp_rendezvous</span>(
		<span class="enscript-type">void</span> (*setup_func)(<span class="enscript-type">void</span> *),
		<span class="enscript-type">void</span> (*action_func)(<span class="enscript-type">void</span> *),
		<span class="enscript-type">void</span> (*teardown_func)(<span class="enscript-type">void</span> *),
		<span class="enscript-type">void</span> *arg);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mp_rendezvous_no_intrs</span>(
		<span class="enscript-type">void</span> (*action_func)(<span class="enscript-type">void</span> *),
		<span class="enscript-type">void</span> *arg);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mp_rendezvous_break_lock</span>(<span class="enscript-type">void</span>);

<span class="enscript-comment">/*
 * All cpu broadcast.
 * Called from thread context, this blocks until all active cpus have
 * run action_func:
 */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mp_broadcast</span>(
		<span class="enscript-type">void</span> (*action_func)(<span class="enscript-type">void</span> *),
		<span class="enscript-type">void</span> *arg);
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">MACH_KDP</span>
<span class="enscript-type">typedef</span> <span class="enscript-function-name">long</span> (*kdp_x86_xcpu_func_t) (<span class="enscript-type">void</span> *arg0, <span class="enscript-type">void</span> *arg1, uint16_t lcpu);

<span class="enscript-type">extern</span>  <span class="enscript-type">long</span> <span class="enscript-function-name">kdp_x86_xcpu_invoke</span>(<span class="enscript-type">const</span> uint16_t lcpu, 
                                 kdp_x86_xcpu_func_t func, 
                                 <span class="enscript-type">void</span> *arg0, <span class="enscript-type">void</span> *arg1);
<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span>	{KDP_XCPU_NONE = 0xffff, KDP_CURRENT_LCPU = 0xfffe} kdp_cpu_t;
#<span class="enscript-reference">endif</span>

<span class="enscript-type">typedef</span> uint32_t cpu_t;
<span class="enscript-type">typedef</span> <span class="enscript-type">volatile</span> uint64_t cpumask_t;
<span class="enscript-type">static</span> inline cpumask_t
<span class="enscript-function-name">cpu_to_cpumask</span>(cpu_t cpu)
{
	<span class="enscript-keyword">return</span> (cpu &lt; MAX_CPUS) ? (1ULL &lt;&lt; cpu) : 0;
}
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CPUMASK_ALL</span>	0xffffffffffffffffULL
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CPUMASK_SELF</span>	cpu_to_cpumask(cpu_number())
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CPUMASK_OTHERS</span>	(CPUMASK_ALL &amp; ~CPUMASK_SELF)

<span class="enscript-comment">/* Initialation routing called at processor registration */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mp_cpus_call_cpu_init</span>(<span class="enscript-type">int</span> cpu);

<span class="enscript-comment">/*
 * Invoke a function (possibly NULL) on a set of cpus specified by a mask.
 * The mask may include the local cpu.
 * If the mode is:
 *	- ASYNC:  other cpus make their calls in parallel
 * 	- SYNC:   the calls are performed serially in logical cpu order
 * 	- NOSYNC: the calls are queued
 * Unless the mode is NOSYNC, mp_cpus_call() returns when the function has been
 * called on all specified cpus.
 * The return value is the number of cpus where the call was made or queued.
 * The action function is called with interrupts disabled.
 */</span>
<span class="enscript-type">extern</span> cpu_t <span class="enscript-function-name">mp_cpus_call</span>(
		cpumask_t	cpus,
		mp_sync_t	mode,
		<span class="enscript-type">void</span>		(*action_func)(<span class="enscript-type">void</span> *),
		<span class="enscript-type">void</span>		*arg);
<span class="enscript-type">extern</span> cpu_t <span class="enscript-function-name">mp_cpus_call1</span>(
		cpumask_t	cpus,
		mp_sync_t	mode,
		<span class="enscript-type">void</span>		(*action_func)(<span class="enscript-type">void</span> *, <span class="enscript-type">void</span>*),
		<span class="enscript-type">void</span>		*arg0,
		<span class="enscript-type">void</span>		*arg1,
		cpumask_t	*cpus_calledp,
		cpumask_t	*cpus_notcalledp);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mp_cpus_NMIPI</span>(cpumask_t cpus);

<span class="enscript-comment">/* Interrupt a set of cpus, forcing an exit out of non-root mode */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mp_cpus_kick</span>(cpumask_t cpus);
<span class="enscript-comment">/*
 * Power-management-specific SPI to:
 *  - register a callout function, and
 *  - request the callout (if registered) on a given cpu.
 */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">PM_interrupt_register</span>(<span class="enscript-type">void</span> (*fn)(<span class="enscript-type">void</span>));
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">cpu_PM_interrupt</span>(<span class="enscript-type">int</span> cpu);

__END_DECLS

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">MP_DEBUG</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
	uint64_t	time;
	<span class="enscript-type">int</span>		cpu;
	mp_event_t	event;
} cpu_signal_event_t;

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LOG_NENTRIES</span>	100
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
	uint64_t		count[MP_LAST];
	<span class="enscript-type">int</span>			next_entry;
	cpu_signal_event_t	entry[LOG_NENTRIES];
} cpu_signal_event_log_t;

<span class="enscript-type">extern</span> cpu_signal_event_log_t	*cpu_signal[];
<span class="enscript-type">extern</span> cpu_signal_event_log_t	*cpu_handle[];

#<span class="enscript-reference">define</span> <span class="enscript-function-name">DBGLOG</span>(log,_cpu,_event) {					\
	boolean_t		spl = ml_set_interrupts_enabled(FALSE);	\
	cpu_signal_event_log_t	*logp = log[cpu_number()];		\
	<span class="enscript-type">int</span>			next = logp-&gt;next_entry;		\
	cpu_signal_event_t	*eventp = &amp;logp-&gt;entry[next];		\
									\
	logp-&gt;count[_event]++;						\
									\
	eventp-&gt;time = rdtsc64();					\
	eventp-&gt;cpu = _cpu;						\
	eventp-&gt;event = _event;						\
	<span class="enscript-keyword">if</span> (next == (LOG_NENTRIES - 1))					\
		logp-&gt;next_entry = 0;					\
	<span class="enscript-keyword">else</span>								\
		logp-&gt;next_entry++;					\
									\
	(<span class="enscript-type">void</span>) ml_set_interrupts_enabled(spl);				\
}

#<span class="enscript-reference">define</span> <span class="enscript-function-name">DBGLOG_CPU_INIT</span>(cpu)	{					\
	cpu_signal_event_log_t	**sig_logpp = &amp;cpu_signal[cpu];		\
	cpu_signal_event_log_t	**hdl_logpp = &amp;cpu_handle[cpu];		\
									\
	<span class="enscript-keyword">if</span> (*sig_logpp == NULL &amp;&amp;					\
		kmem_alloc(kernel_map,					\
			(vm_offset_t *) sig_logpp,			\
			<span class="enscript-keyword">sizeof</span>(cpu_signal_event_log_t)) != KERN_SUCCESS)\
		panic(<span class="enscript-string">&quot;DBGLOG_CPU_INIT cpu_signal allocation failed\n&quot;</span>);\
	bzero(*sig_logpp, <span class="enscript-keyword">sizeof</span>(cpu_signal_event_log_t));		\
	<span class="enscript-keyword">if</span> (*hdl_logpp == NULL &amp;&amp;					\
		kmem_alloc(kernel_map,					\
			(vm_offset_t *) hdl_logpp,			\
			<span class="enscript-keyword">sizeof</span>(cpu_signal_event_log_t)) != KERN_SUCCESS)\
		panic(<span class="enscript-string">&quot;DBGLOG_CPU_INIT cpu_handle allocation failed\n&quot;</span>);\
	bzero(*hdl_logpp, <span class="enscript-keyword">sizeof</span>(cpu_signal_event_log_t));		\
}
#<span class="enscript-reference">else</span>	<span class="enscript-comment">/* MP_DEBUG */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">DBGLOG</span>(log,_cpu,_event)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">DBGLOG_CPU_INIT</span>(cpu)
#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* MP_DEBUG */</span>

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* ASSEMBLER */</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">ASSEMBLER</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">i_bit</span>(bit, word)	((long)(*(word)) &amp; (1L &lt;&lt; (bit)))
#<span class="enscript-reference">else</span>
<span class="enscript-function-name">__attribute__</span>((always_inline)) <span class="enscript-type">static</span> inline <span class="enscript-type">long</span> 
<span class="enscript-function-name">i_bit_impl</span>(<span class="enscript-type">long</span> word, <span class="enscript-type">long</span> bit) {
	<span class="enscript-type">long</span> bitmask = 1L &lt;&lt; bit;
	<span class="enscript-keyword">return</span> word &amp; bitmask;
}
#<span class="enscript-reference">define</span> <span class="enscript-function-name">i_bit</span>(bit, word)	i_bit_impl((long)(*(word)), bit)
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span>	<span class="enscript-variable-name">MACH_RT</span>

#<span class="enscript-reference">if</span>   <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__x86_64__</span>)

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_DISABLE_PREEMPTION</span> 					\
	incl	%gs:CPU_PREEMPTION_LEVEL

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_ENABLE_PREEMPTION</span> 					\
	decl	%gs:CPU_PREEMPTION_LEVEL		;	\
	jne	9f					;	\
	call	EXT(kernel_preempt_check)		;	\
<span class="enscript-reference">9</span>:	

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_ENABLE_PREEMPTION_NO_CHECK</span>				\
	decl	%gs:CPU_PREEMPTION_LEVEL

#<span class="enscript-reference">else</span>
#<span class="enscript-reference">error</span> <span class="enscript-variable-name">Unsupported</span> <span class="enscript-variable-name">architecture</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">/* x86_64 just calls through to the other macro directly */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DISABLE_PREEMPTION</span>		_DISABLE_PREEMPTION
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ENABLE_PREEMPTION</span>		_ENABLE_PREEMPTION
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ENABLE_PREEMPTION_NO_CHECK</span>	_ENABLE_PREEMPTION_NO_CHECK
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MP_DISABLE_PREEMPTION</span>		_DISABLE_PREEMPTION
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MP_ENABLE_PREEMPTION</span>		_ENABLE_PREEMPTION
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MP_ENABLE_PREEMPTION_NO_CHECK</span> 	_ENABLE_PREEMPTION_NO_CHECK

#<span class="enscript-reference">else</span>	<span class="enscript-comment">/* MACH_RT */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DISABLE_PREEMPTION</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ENABLE_PREEMPTION</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ENABLE_PREEMPTION_NO_CHECK</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MP_DISABLE_PREEMPTION</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MP_ENABLE_PREEMPTION</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MP_ENABLE_PREEMPTION_NO_CHECK</span>
#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* MACH_RT */</span>

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* _I386_MP_H_ */</span>

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL_PRIVATE */</span>
</pre>
<hr />
</body></html>