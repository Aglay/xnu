<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>lapic.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">lapic.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2008-2010 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*
 * @OSF_COPYRIGHT@
 * 
 */</span>
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_I386_LAPIC_H_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_I386_LAPIC_H_</span>

<span class="enscript-comment">/*
 * Legacy mode definitions.
 * The register offsets are no longer used by XNU - see LAPIC_MMIO_OFFSET().
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_START</span>			0xFEE00000
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_SIZE</span>			0x00000400

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_ID</span>			0x00000020
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ID_SHIFT</span>		24
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ID_MASK</span>		0xFF
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_VERSION</span>			0x00000030
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_VERSION_MASK</span>	0xFF
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_TPR</span>			0x00000080
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_TPR_MASK</span>		0xFF
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_APR</span>			0x00000090
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_APR_MASK</span>		0xFF
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_PPR</span>			0x000000A0
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_PPR_MASK</span>		0xFF
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_EOI</span>			0x000000B0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_REMOTE_READ</span>		0x000000C0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_LDR</span>			0x000000D0
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_LDR_SHIFT</span>		24
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_DFR</span>			0x000000E0
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_DFR_FLAT</span>		0xFFFFFFFF
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_DFR_CLUSTER</span>	0x0FFFFFFF
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_DFR_SHIFT</span>         28
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_SVR</span>			0x000000F0
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_SVR_MASK</span>		0x0FF
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_SVR_ENABLE</span>	0x100
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_SVR_FOCUS_OFF</span>	0x200
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_ISR_BASE</span>			0x00000100
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_TMR_BASE</span>			0x00000180
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_IRR_BASE</span>			0x00000200
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_ERROR_STATUS</span>		0x00000280
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_LVT_CMCI</span>			0x000002F0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_ICR</span>			0x00000300
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ICR_VECTOR_MASK</span>	0x000FF
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ICR_DM_MASK</span>	0x00700
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ICR_DM_FIXED</span>	0x00000
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ICR_DM_LOWEST</span>	0x00100
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ICR_DM_SMI</span>	0x00200
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ICR_DM_REMOTE</span>	0x00300
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ICR_DM_NMI</span>	0x00400
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ICR_DM_INIT</span>	0x00500
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ICR_DM_STARTUP</span>	0x00600
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ICR_DM_LOGICAL</span>	0x00800
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ICR_DS_PENDING</span>	0x01000
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ICR_LEVEL_ASSERT</span>	0x04000
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ICR_TRIGGER_LEVEL</span>	0x08000
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ICR_RR_MASK</span>	0x30000
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ICR_RR_INVALID</span>	0x00000
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ICR_RR_INPROGRESS</span>	0x10000
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ICR_RR_VALID</span>	0x20000
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ICR_DSS_MASK</span>	0xC0000
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ICR_DSS_DEST</span>	0x00000
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ICR_DSS_SELF</span>	0x40000
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ICR_DSS_ALL</span>	0x80000
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ICR_DSS_OTHERS</span>	0xC0000
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_ICRD</span>			0x00000310
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_ICRD_DEST_SHIFT</span>	24
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_LVT_TIMER</span>			0x00000320
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_LVT_THERMAL</span>		0x00000330
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_LVT_PERFCNT</span>		0x00000340
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_LVT_LINT0</span>			0x00000350
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_LVT_LINT1</span>			0x00000360
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_LVT_ERROR</span>			0x00000370
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_LVT_VECTOR_MASK</span>	0x000FF
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_LVT_DM_SHIFT</span>	8
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_LVT_DM_MASK</span>	0x00007
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_LVT_DM_FIXED</span>	0x00000
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_LVT_DM_NMI</span>	0x00400
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_LVT_DM_EXTINT</span>	0x00700
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_LVT_DS_PENDING</span>	0x01000
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_LVT_IP_PLRITY_LOW</span>	0x02000
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_LVT_REMOTE_IRR</span>	0x04000
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_LVT_TM_LEVEL</span>	0x08000
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_LVT_MASKED</span>	0x10000
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_LVT_PERIODIC</span>	0x20000
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_LVT_TSC_DEADLINE</span>	0x40000
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_LVT_TMR_SHIFT</span>	17
#<span class="enscript-reference">define</span>		<span class="enscript-variable-name">LAPIC_LVT_TMR_MASK</span>	3
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_TIMER_INITIAL_COUNT</span>	0x00000380
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_TIMER_CURRENT_COUNT</span>	0x00000390
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_TIMER_DIVIDE_CONFIG</span>	0x000003E0
<span class="enscript-comment">/* divisor encoded by bits 0,1,3 with bit 2 always 0: */</span>
#<span class="enscript-reference">define</span> 	<span class="enscript-variable-name">LAPIC_TIMER_DIVIDE_MASK</span>	0x0000000F
#<span class="enscript-reference">define</span> 	<span class="enscript-variable-name">LAPIC_TIMER_DIVIDE_2</span>	0x00000000
#<span class="enscript-reference">define</span> 	<span class="enscript-variable-name">LAPIC_TIMER_DIVIDE_4</span>	0x00000001
#<span class="enscript-reference">define</span> 	<span class="enscript-variable-name">LAPIC_TIMER_DIVIDE_8</span>	0x00000002
#<span class="enscript-reference">define</span> 	<span class="enscript-variable-name">LAPIC_TIMER_DIVIDE_16</span>	0x00000003
#<span class="enscript-reference">define</span> 	<span class="enscript-variable-name">LAPIC_TIMER_DIVIDE_32</span>	0x00000008
#<span class="enscript-reference">define</span> 	<span class="enscript-variable-name">LAPIC_TIMER_DIVIDE_64</span>	0x00000009
#<span class="enscript-reference">define</span> 	<span class="enscript-variable-name">LAPIC_TIMER_DIVIDE_128</span>	0x0000000A
#<span class="enscript-reference">define</span> 	<span class="enscript-variable-name">LAPIC_TIMER_DIVIDE_1</span>	0x0000000B

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_ID_MAX</span>			(LAPIC_ID_MASK)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">CPU_NUMBER</span>(r)				\
	movl	%gs:CPU_NUMBER_GS,r

#<span class="enscript-reference">ifndef</span>	<span class="enscript-variable-name">ASSEMBLER</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> {
	ID			= 0x02,
	VERSION			= 0x03,
	TPR			= 0x08,
	APR			= 0x09,
	PPR			= 0x0A,
	EOI			= 0x0B,
	REMOTE_READ		= 0x0C,
	LDR			= 0x0D,
	DFR			= 0x0E,
	SVR			= 0x0F,
	ISR_BASE		= 0x10,
	TMR_BASE		= 0x18,
	IRR_BASE		= 0x20,
	ERROR_STATUS		= 0x28,
	LVT_CMCI		= 0x2F,
	ICR			= 0x30,
	ICRD			= 0x31,
	LVT_TIMER		= 0x32,
	LVT_THERMAL		= 0x33,
	LVT_PERFCNT		= 0x34,
	LVT_LINT0		= 0x35,
	LVT_LINT1		= 0x36,
	LVT_ERROR		= 0x37,
	TIMER_INITIAL_COUNT	= 0x38,
	TIMER_CURRENT_COUNT	= 0x39,
	TIMER_DIVIDE_CONFIG	= 0x3E,
} lapic_register_t;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_MMIO_PBASE</span>	0xFEE00000	<span class="enscript-comment">/* Default physical MMIO addr */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_MMIO_VBASE</span>	lapic_vbase	<span class="enscript-comment">/* Actual virtual mapped addr */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_MSR_BASE</span>		0x800

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">LAPIC_MMIO_OFFSET</span>(reg)	(reg &lt;&lt; 4)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">LAPIC_MSR_OFFSET</span>(reg)	(reg)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">LAPIC_MMIO</span>(reg)		((volatile uint32_t *) \
					(LAPIC_MMIO_VBASE + LAPIC_MMIO_OFFSET(reg)))
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">LAPIC_MSR</span>(reg)		(LAPIC_MSR_BASE + LAPIC_MSR_OFFSET(reg))

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
	<span class="enscript-type">void</span>		(*init)		(<span class="enscript-type">void</span>);
	uint32_t	(*read)		(lapic_register_t);
	<span class="enscript-type">void</span>		(*write)	(lapic_register_t, uint32_t);
	uint64_t	(*read_icr)	(<span class="enscript-type">void</span>);
	<span class="enscript-type">void</span>		(*write_icr)	(uint32_t, uint32_t);
} lapic_ops_table_t;
<span class="enscript-type">extern</span>  lapic_ops_table_t *lapic_ops;

#<span class="enscript-reference">define</span> <span class="enscript-function-name">LAPIC_INIT</span>()			lapic_ops-&gt;init();
#<span class="enscript-reference">define</span> <span class="enscript-function-name">LAPIC_WRITE</span>(reg,val)		lapic_ops-&gt;write(reg, val)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">LAPIC_READ</span>(reg)			lapic_ops-&gt;read(reg)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">LAPIC_READ_OFFSET</span>(reg,off)	LAPIC_READ((reg)+(off))
#<span class="enscript-reference">define</span> <span class="enscript-function-name">LAPIC_READ_ICR</span>()		lapic_ops-&gt;read_icr()
#<span class="enscript-reference">define</span> <span class="enscript-function-name">LAPIC_WRITE_ICR</span>(dst,cmd)	lapic_ops-&gt;write_icr(dst, cmd)

<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> {
	periodic,
	one_shot
} lapic_timer_mode_t;
<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> {	
	divide_by_1   = LAPIC_TIMER_DIVIDE_1,
	divide_by_2   = LAPIC_TIMER_DIVIDE_2,
	divide_by_4   = LAPIC_TIMER_DIVIDE_4,
	divide_by_8   = LAPIC_TIMER_DIVIDE_8,
	divide_by_16  = LAPIC_TIMER_DIVIDE_16,
	divide_by_32  = LAPIC_TIMER_DIVIDE_32,
	divide_by_64  = LAPIC_TIMER_DIVIDE_64,
	divide_by_128 = LAPIC_TIMER_DIVIDE_128
} lapic_timer_divide_t;
<span class="enscript-type">typedef</span> uint32_t lapic_timer_count_t;

<span class="enscript-comment">/*
 * By default, use high vectors to leave vector space for systems
 * with multiple I/O APIC's. However some systems that boot with
 * local APIC disabled will hang in SMM when vectors greater than
 * 0x5F are used. Those systems are not expected to have I/O APIC
 * so 16 (0x50 - 0x40) vectors for legacy PIC support is perfect.
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_DEFAULT_INTERRUPT_BASE</span>	0xD0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_REDUCED_INTERRUPT_BASE</span>	0x50
<span class="enscript-comment">/*
 * Specific lapic interrupts are relative to this base
 * in priority order from high to low:
 */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_PERFCNT_INTERRUPT</span>		0xF
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_INTERPROCESSOR_INTERRUPT</span>	0xE
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_TIMER_INTERRUPT</span>		0xD
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_THERMAL_INTERRUPT</span>		0xC
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_ERROR_INTERRUPT</span>		0xB
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_SPURIOUS_INTERRUPT</span>	0xA
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_CMCI_INTERRUPT</span>		0x9
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_PMC_SW_INTERRUPT</span>		0x8
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_PM_INTERRUPT</span>		0x7
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_KICK_INTERRUPT</span>		0x6

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_PMC_SWI_VECTOR</span>		(LAPIC_DEFAULT_INTERRUPT_BASE + LAPIC_PMC_SW_INTERRUPT)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_TIMER_VECTOR</span>		(LAPIC_DEFAULT_INTERRUPT_BASE + LAPIC_TIMER_INTERRUPT)

<span class="enscript-comment">/* The vector field is ignored for NMI interrupts via the LAPIC
 * or otherwise, so this is not an offset from the interrupt
 * base.
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_NMI_INTERRUPT</span>		0x2
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LAPIC_FUNC_TABLE_SIZE</span>		(LAPIC_PERFCNT_INTERRUPT + 1)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">LAPIC_VECTOR</span>(src) \
	(lapic_interrupt_base + LAPIC_##src##_INTERRUPT)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">LAPIC_ISR_IS_SET</span>(base,src) \
	(LAPIC_READ_OFFSET(ISR_BASE,(base+LAPIC_##src##_INTERRUPT)/32) \
		&amp; (1 &lt;&lt;((base + LAPIC_##src##_INTERRUPT)%32)))

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		lapic_init(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		lapic_configure(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		lapic_shutdown(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		lapic_smm_restore(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> boolean_t	lapic_probe(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		lapic_dump(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		lapic_cpu_map_dump(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>		lapic_interrupt(
				<span class="enscript-type">int</span> interrupt, x86_saved_state_t *state);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		lapic_end_of_interrupt(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		lapic_unmask_perfcnt_interrupt(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		lapic_set_perfcnt_interrupt_mask(boolean_t);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		lapic_send_ipi(<span class="enscript-type">int</span> cpu, <span class="enscript-type">int</span> interupt);

<span class="enscript-type">extern</span> <span class="enscript-type">int</span>		lapic_to_cpu[];
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>		cpu_to_lapic[];
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>		lapic_interrupt_base;
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		lapic_cpu_map_init(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		lapic_cpu_map(<span class="enscript-type">int</span> lapic, <span class="enscript-type">int</span> cpu_num);
<span class="enscript-type">extern</span> uint32_t		ml_get_apicid(uint32_t cpu);
<span class="enscript-type">extern</span> uint32_t		ml_get_cpuid(uint32_t lapic_index);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		lapic_config_timer(
				boolean_t		interrupt,
				lapic_timer_mode_t	mode,
				lapic_timer_divide_t 	divisor);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		lapic_set_timer_fast(
				lapic_timer_count_t	initial_count);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		lapic_set_timer(
				boolean_t		interrupt,
				lapic_timer_mode_t	mode,
				lapic_timer_divide_t 	divisor,
				lapic_timer_count_t	initial_count);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		lapic_get_timer(
				lapic_timer_mode_t	*mode,
				lapic_timer_divide_t	*divisor,
				lapic_timer_count_t	*initial_count,
				lapic_timer_count_t	*current_count);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		lapic_config_tsc_deadline_timer(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		lapic_set_tsc_deadline_timer(uint64_t deadline);
<span class="enscript-type">extern</span> uint64_t		lapic_get_tsc_deadline_timer(<span class="enscript-type">void</span>);

<span class="enscript-type">typedef</span>	<span class="enscript-type">int</span> (*i386_intr_func_t)(x86_saved_state_t *state);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		lapic_set_intr_func(<span class="enscript-type">int</span> intr, i386_intr_func_t func);

<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		lapic_set_pmi_func(i386_intr_func_t);

<span class="enscript-type">static</span> inline <span class="enscript-type">void</span>	lapic_set_timer_func(i386_intr_func_t func)
{
	lapic_set_intr_func(LAPIC_VECTOR(TIMER), func);
}
<span class="enscript-comment">/* We don't support dynamic adjustment of the LAPIC timer base vector here
 * it's effectively incompletely supported elsewhere as well.
 */</span>
<span class="enscript-type">static</span> inline <span class="enscript-type">void</span>	lapic_timer_swi(<span class="enscript-type">void</span>) {
	__asm__ __volatile__(<span class="enscript-string">&quot;int %0&quot;</span> :: <span class="enscript-string">&quot;i&quot;</span>(LAPIC_DEFAULT_INTERRUPT_BASE + LAPIC_TIMER_INTERRUPT):<span class="enscript-string">&quot;memory&quot;</span>);
}

<span class="enscript-type">static</span> inline <span class="enscript-type">void</span>	lapic_set_thermal_func(i386_intr_func_t func)
{
	lapic_set_intr_func(LAPIC_VECTOR(THERMAL), func);
}
<span class="enscript-type">static</span> inline <span class="enscript-type">void</span>	lapic_set_cmci_func(i386_intr_func_t func)
{
	lapic_set_intr_func(LAPIC_VECTOR(CMCI), func);
}
<span class="enscript-type">static</span> inline <span class="enscript-type">void</span>	lapic_set_pm_func(i386_intr_func_t func)
{
	lapic_set_intr_func(LAPIC_VECTOR(PM), func);
}

<span class="enscript-type">extern</span> boolean_t	lapic_is_interrupt_pending(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span> boolean_t	lapic_is_interrupting(uint8_t vector);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		lapic_interrupt_counts(uint64_t intrs[256]);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		lapic_disable_timer(<span class="enscript-type">void</span>);

<span class="enscript-type">extern</span> uint8_t		lapic_get_cmci_vector(<span class="enscript-type">void</span>);

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MAX_LAPICIDS</span>	(LAPIC_ID_MAX+1)
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">MP_DEBUG</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">LAPIC_CPU_MAP_DUMP</span>()	lapic_cpu_map_dump()
#<span class="enscript-reference">define</span> <span class="enscript-function-name">LAPIC_DUMP</span>()		lapic_dump()
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">LAPIC_CPU_MAP_DUMP</span>()
#<span class="enscript-reference">define</span> <span class="enscript-function-name">LAPIC_DUMP</span>()
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* MP_DEBUG */</span>

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* ASSEMBLER */</span>

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* _I386_LAPIC_H_ */</span>

</pre>
<hr />
</body></html>