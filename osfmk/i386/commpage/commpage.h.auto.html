<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>commpage.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">commpage.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2003-2012 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_I386_COMMPAGE_H</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_I386_COMMPAGE_H</span>

#<span class="enscript-reference">ifndef</span>	<span class="enscript-variable-name">__ASSEMBLER__</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdint.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/boolean.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/vm_types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;machine/cpu_capabilities.h&gt;</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* __ASSEMBLER__ */</span>

<span class="enscript-comment">/* When trying to acquire a spinlock or mutex, we will spin in
 * user mode for awhile, before entering the kernel to relinquish.
 * MP_SPIN_TRIES is the initial value of _COMM_PAGE_SPIN_COUNT.
 * The idea is that _COMM_PAGE_SPIN_COUNT will be adjusted up or
 * down as the machine is plugged in/out, etc.
 * At present spinlocks do not use _COMM_PAGE_SPIN_COUNT.
 * They use MP_SPIN_TRIES directly.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MP_SPIN_TRIES</span>	1000


<span class="enscript-comment">/* The following macro is used to generate the 64-bit commpage address for a given
 * routine, based on its 32-bit address.  This is used in the kernel to compile
 * the 64-bit commpage.  Since the kernel can be a 32-bit object, cpu_capabilities.h
 * only defines the 32-bit address.
 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">_COMM_PAGE_32_TO_64</span>( ADDRESS )	( ADDRESS + _COMM_PAGE64_START_ADDRESS - _COMM_PAGE32_START_ADDRESS )


#<span class="enscript-reference">ifdef</span>	<span class="enscript-variable-name">__ASSEMBLER__</span>

#<span class="enscript-reference">define</span> <span class="enscript-function-name">COMMPAGE_DESCRIPTOR_NAME</span>(label)  _commpage_ ## label

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">COMMPAGE_DESCRIPTOR_FIELD_POINTER</span> .quad
#<span class="enscript-reference">define</span> <span class="enscript-function-name">COMMPAGE_DESCRIPTOR_REFERENCE</span>(label) \
	.quad COMMPAGE_DESCRIPTOR_NAME(label)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">COMMPAGE_FUNCTION_START</span>(label,codetype,alignment) \
.text								;\
.code ## codetype						;\
.align alignment, 0x90						;\
L ## label ## :

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">COMMPAGE_DESCRIPTOR</span>(label,address)			\
L ## label ## _end:						;\
.set L ## label ## _size, L ## label ## _end - L ## label	;\
.const_data							;\
.private_extern COMMPAGE_DESCRIPTOR_NAME(label)			;\
<span class="enscript-function-name">COMMPAGE_DESCRIPTOR_NAME</span>(label) ## :				;\
    COMMPAGE_DESCRIPTOR_FIELD_POINTER	L ## label 		;\
    .<span class="enscript-type">long</span>				L ## label ## _size	;\
    .<span class="enscript-type">long</span>				address			;\
.text


<span class="enscript-comment">/* COMMPAGE_CALL(target,from,start)
 *
 * This macro compiles a relative near call to one
 * commpage routine from another.
 * The assembler cannot handle this directly because the code
 * is not being assembled at the address at which it will execute.
 * The alternative to this macro would be to use an
 * indirect call, which is slower because the target of an
 * indirect branch is poorly predicted.
 * The macro arguments are:
 *	target = the commpage routine we are calling
 *	from   = the commpage routine we are in now
 *	start  = the label at the start of the code for this func
 * This is admitedly ugly and fragile.  Is there a better way?
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">COMMPAGE_CALL</span>(target,from,start)			\
	COMMPAGE_CALL_INTERNAL(target,from,start,__LINE__)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">COMMPAGE_CALL_INTERNAL</span>(target,from,start,unique)	\
	.byte 0xe8						;\
.set UNIQUEID(unique), L ## start - . + target - from - 4	;\
	.<span class="enscript-type">long</span>	UNIQUEID(unique)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">UNIQUEID</span>(name)	L ## name

#<span class="enscript-reference">else</span> <span class="enscript-comment">/* __ASSEMBLER__ */</span>

<span class="enscript-comment">/* Each potential commpage routine is described by one of these.
 * Note that the COMMPAGE_DESCRIPTOR macro (above), used in
 * assembly language, must agree with this.
 */</span>
 
<span class="enscript-type">typedef</span>	<span class="enscript-type">struct</span>	commpage_descriptor	{
    <span class="enscript-type">void</span>		*code_address;				<span class="enscript-comment">// address of code
</span>    uint32_t	 	code_length;				<span class="enscript-comment">// length in bytes
</span>    uint32_t		commpage_address;			<span class="enscript-comment">// put at this address (_COMM_PAGE_BCOPY etc)
</span>} commpage_descriptor;


<span class="enscript-comment">/* Warning: following structure must match the layout of the commpage.  */</span>
<span class="enscript-comment">/* This is the data starting at _COMM_PAGE_TIME_DATA_START, ie for nanotime() and gettimeofday() */</span>

<span class="enscript-type">typedef</span>	<span class="enscript-type">volatile</span> <span class="enscript-type">struct</span>	commpage_time_data	{
	uint64_t	nt_tsc_base;				<span class="enscript-comment">// _COMM_PAGE_NT_TSC_BASE
</span>	uint32_t	nt_scale;				<span class="enscript-comment">// _COMM_PAGE_NT_SCALE
</span>	uint32_t	nt_shift;				<span class="enscript-comment">// _COMM_PAGE_NT_SHIFT
</span>	uint64_t	nt_ns_base;				<span class="enscript-comment">// _COMM_PAGE_NT_NS_BASE
</span>	uint32_t	nt_generation;				<span class="enscript-comment">// _COMM_PAGE_NT_GENERATION
</span>	uint32_t	gtod_generation;			<span class="enscript-comment">// _COMM_PAGE_GTOD_GENERATION
</span>	uint64_t	gtod_ns_base;				<span class="enscript-comment">// _COMM_PAGE_GTOD_NS_BASE
</span>	uint64_t	gtod_sec_base;				<span class="enscript-comment">// _COMM_PAGE_GTOD_SEC_BASE
</span>} commpage_time_data;


<span class="enscript-type">extern</span>	<span class="enscript-type">char</span>	*commPagePtr32;				<span class="enscript-comment">// virt address of 32-bit commpage in kernel map
</span><span class="enscript-type">extern</span>	<span class="enscript-type">char</span>	*commPagePtr64;				<span class="enscript-comment">// ...and of 64-bit commpage
</span>
<span class="enscript-type">extern</span>	<span class="enscript-type">void</span>	commpage_set_timestamp(uint64_t abstime, uint64_t secs);
<span class="enscript-type">extern</span>	<span class="enscript-type">void</span>	commpage_disable_timestamp( <span class="enscript-type">void</span> );
<span class="enscript-type">extern</span>  <span class="enscript-type">void</span>	commpage_set_nanotime(uint64_t tsc_base, uint64_t ns_base, uint32_t scale, uint32_t shift);
<span class="enscript-type">extern</span>	<span class="enscript-type">void</span>	commpage_set_memory_pressure(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>  pressure);
<span class="enscript-type">extern</span>	<span class="enscript-type">void</span>	commpage_set_spin_count(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>  count);
<span class="enscript-type">extern</span>	<span class="enscript-type">void</span>	commpage_sched_gen_inc(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span>	<span class="enscript-type">void</span>	commpage_update_active_cpus(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span>	<span class="enscript-type">void</span>	commpage_update_mach_approximate_time(uint64_t abstime);
<span class="enscript-type">extern</span>	<span class="enscript-type">void</span>	commpage_update_kdebug_enable(<span class="enscript-type">void</span>);
<span class="enscript-type">extern</span>	<span class="enscript-type">void</span>	commpage_update_atm_diagnostic_config(uint32_t);

<span class="enscript-type">extern</span>	uint32_t	commpage_is_in_pfz32(uint32_t);
<span class="enscript-type">extern</span>	uint32_t	commpage_is_in_pfz64(addr64_t);

#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* __ASSEMBLER__ */</span>

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* _I386_COMMPAGE_H */</span>
</pre>
<hr />
</body></html>