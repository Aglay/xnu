<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>fifo_queues.s</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">fifo_queues.s&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
/*
 <span class="enscript-keyword">*</span> Copyright (c) 2008 Apple Computer, Inc. All rights reserved.
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> This file contains Original Code and/or Modifications of Original Code
 <span class="enscript-keyword">*</span> as defined in and that are subject to the Apple Public Source License
 <span class="enscript-keyword">*</span> Version 2.0 (the 'License'). You may not use this file except in
 <span class="enscript-keyword">*</span> compliance with the License. The rights granted to you under the License
 <span class="enscript-keyword">*</span> may not be used to create, or enable the creation or redistribution of,
 <span class="enscript-keyword">*</span> unlawful or unlicensed copies of an Apple operating system, or to
 <span class="enscript-keyword">*</span> circumvent, violate, or enable the circumvention or violation of, any
 <span class="enscript-keyword">*</span> terms of an Apple operating system software license agreement.
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> Please obtain a copy of the License at
 <span class="enscript-keyword">*</span> <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> The Original Code and all software distributed under the License are
 <span class="enscript-keyword">*</span> distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 <span class="enscript-keyword">*</span> EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 <span class="enscript-keyword">*</span> INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 <span class="enscript-keyword">*</span> FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 <span class="enscript-keyword">*</span> Please see the License for the specific language governing rights and
 <span class="enscript-keyword">*</span> limitations under the License.
 <span class="enscript-keyword">*</span> 
 <span class="enscript-keyword">*</span> @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 <span class="enscript-keyword">*/
</span>
#include &lt;sys/appleapiopts.h&gt;
#include &lt;machine/cpu_capabilities.h&gt;
#include &lt;machine/commpage.h&gt;
#include &lt;mach/i386/syscall_sw.h&gt;


/* PREEMPTION FREE ZONE (PFZ)
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> A portion of the commpage is speacial-cased by the kernel to be <span class="enscript-string">&quot;preemption free&quot;</span>,
 <span class="enscript-keyword">*</span> ie as if we had disabled interrupts in user mode.  This facilitates writing
 <span class="enscript-keyword">*</span> <span class="enscript-string">&quot;nearly-lockless&quot;</span> code, for example code that must be serialized by a spinlock but
 <span class="enscript-keyword">*</span> which we do not want to preempt while the spinlock is held.
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> The PFZ is implemented by collecting all the <span class="enscript-string">&quot;preemption-free&quot;</span> code into a single
 <span class="enscript-keyword">*</span> contiguous region of the commpage.  Register %ebx is used as a flag register<span class="enscript-comment">;
 * before entering the PFZ, %ebx is cleared.  If some event occurs that would normally
</span> <span class="enscript-keyword">*</span> result in a premption while in the PFZ, the kernel sets %ebx nonzero instead of
 <span class="enscript-keyword">*</span> preempting.  Then, when the routine leaves the PFZ we check %ebx and
 <span class="enscript-keyword">*</span> if nonzero execute a special <span class="enscript-string">&quot;pfz_exit&quot;</span> syscall to take the delayed preemption.
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> PFZ code must bound the amount of time spent in the PFZ, in order to control
 <span class="enscript-keyword">*</span> latency.  Backward branches are dangerous and must not be used in a way that
 <span class="enscript-keyword">*</span> could inadvertently create a long-running loop.
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> Because they cannot be implemented reasonably without a lock, we put the <span class="enscript-string">&quot;atomic&quot;</span>
 <span class="enscript-keyword">*</span> FIFO enqueue and dequeue in the PFZ.  As long as we don't take a page fault trying to
 <span class="enscript-keyword">*</span> access queue elements, these implementations behave nearly-locklessly.
 <span class="enscript-keyword">*</span> But we still must take a spinlock to serialize, and in case of page faults.
 <span class="enscript-keyword">*/
</span>
/* Work around 10062261 with a dummy non-local symbol */
<span class="enscript-function-name">fifo_queue_dummy_symbol:</span>	

/*
 <span class="enscript-keyword">*</span>	typedef	volatile struct {
 <span class="enscript-keyword">*</span>		void	*opaque1<span class="enscript-comment">;  &lt;-- ptr to first queue element or null
 *		void	*opaque2;  &lt;-- ptr to last queue element or null
</span> <span class="enscript-keyword">*</span>		int	 opaque3<span class="enscript-comment">;  &lt;-- spinlock
 *	} OSFifoQueueHead;
</span> <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> void  OSAtomicFifoEnqueue( OSFifoQueueHead *list, void *new, size_t offset)<span class="enscript-comment">;
 */
</span>

/* Subroutine to make a preempt syscall.  Called when we notice %ebx is
 <span class="enscript-keyword">*</span> nonzero after returning from a PFZ subroutine.
 <span class="enscript-keyword">*</span> When we enter kernel:
 <span class="enscript-keyword">*</span>	%edx = return address
 <span class="enscript-keyword">*</span>	%ecx = stack ptr
 <span class="enscript-keyword">*</span> Destroys %eax, %ecx, and %edx.
 <span class="enscript-keyword">*/
</span>COMMPAGE_FUNCTION_START(preempt, 32, 4)
	<span class="enscript-keyword">popl</span>	%edx		// get return address
	<span class="enscript-keyword">movl</span>	%esp,%ecx	// save stack ptr here
	<span class="enscript-keyword">movl</span>	$(-58),%eax	/* 58 = pfz_exit */
	<span class="enscript-keyword">xorl</span>	%ebx,%ebx	// clear <span class="enscript-string">&quot;preemption pending&quot;</span> flag
	<span class="enscript-keyword">sysenter
</span>COMMPAGE_DESCRIPTOR(preempt,_COMM_PAGE_PREEMPT)


/* Subroutine to back off if we cannot get the spinlock.  Called
 <span class="enscript-keyword">*</span> after a few attempts inline in the PFZ subroutines.  This code is
 <span class="enscript-keyword">*</span> not in the PFZ.
 <span class="enscript-keyword">*</span>	%edi = ptr to queue head structure
 <span class="enscript-keyword">*</span>	%ebx = preemption flag (nonzero if preemption pending)
 <span class="enscript-keyword">*</span> Destroys %eax.
 <span class="enscript-keyword">*/
</span>COMMPAGE_FUNCTION_START(backoff, 32, 4)
	<span class="enscript-keyword">testl</span>	%ebx,%ebx	// does kernel want to preempt us?
	<span class="enscript-keyword">jz</span>	1f		// no
	<span class="enscript-keyword">xorl</span>	%ebx,%ebx	// yes, clear flag
	<span class="enscript-keyword">pushl</span>	%edx		// preserve regs used by preempt syscall
	<span class="enscript-keyword">pushl</span>	%ecx
	<span class="enscript-keyword">COMMPAGE_CALL(_COMM_PAGE_PREEMPT,_COMM_PAGE_BACKOFF,backoff)
</span>	<span class="enscript-keyword">popl</span>	%ecx
	<span class="enscript-keyword">popl</span>	%edx
<span class="enscript-function-name">1:</span>
	<span class="enscript-keyword">pause</span>			// SMT-friendly backoff
	<span class="enscript-keyword">cmpl</span>	$0,8(%edi)	// sniff the lockword
	<span class="enscript-keyword">jnz</span>	1b		// loop if still taken
	<span class="enscript-keyword">ret</span>			// lockword is free, so reenter PFZ
COMMPAGE_DESCRIPTOR(backoff,_COMM_PAGE_BACKOFF)


/* Preemption-free-zone routine to FIFO Enqueue:
 <span class="enscript-keyword">*</span>	%edi = ptr to queue head structure
 <span class="enscript-keyword">*</span>	%esi = ptr to element to enqueue
 <span class="enscript-keyword">*</span>	%edx = offset of link field in elements
 <span class="enscript-keyword">*</span>	%ebx = preemption flag (kernel sets nonzero if we should preempt)
 <span class="enscript-keyword">*/
</span> <span class="enscript-keyword">
</span>COMMPAGE_FUNCTION_START(pfz_enqueue, 32, 4)
	<span class="enscript-keyword">movl</span>	    $0,(%edx,%esi)  // zero forward link in new element
<span class="enscript-function-name">1:</span>
	<span class="enscript-keyword">xorl</span>	    %eax, %eax
	<span class="enscript-keyword">orl</span>	    $-1, %ecx
	<span class="enscript-keyword">lock
</span>	<span class="enscript-keyword">cmpxchgl</span>    %ecx, 8(%edi)   // try to take the spinlock
	<span class="enscript-keyword">jz</span>	    2f		    // got it
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">pause
</span>	<span class="enscript-keyword">xorl</span>	    %eax, %eax
	<span class="enscript-keyword">lock
</span>	<span class="enscript-keyword">cmpxchgl</span>    %ecx, 8(%edi)   // try 2nd time to take the spinlock
	<span class="enscript-keyword">jz</span>	    2f		    // got it
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">pause
</span>	<span class="enscript-keyword">xorl</span>	    %eax, %eax
	<span class="enscript-keyword">lock
</span>	<span class="enscript-keyword">cmpxchgl</span>    %ecx, 8(%edi)   // try 3rd time to take the spinlock
	<span class="enscript-keyword">jz</span>	    2f		    // got it
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">COMMPAGE_CALL(_COMM_PAGE_BACKOFF,_COMM_PAGE_PFZ_ENQUEUE,pfz_enqueue)
</span>	<span class="enscript-keyword">jmp</span>	    1b		    // loop to try again
<span class="enscript-function-name">2:</span>
	<span class="enscript-keyword">movl</span>	    4(%edi),%ecx    // get ptr to last element in q
	<span class="enscript-keyword">testl</span>	    %ecx,%ecx	    // q null?
	<span class="enscript-keyword">jnz</span>	    3f		    // no
	<span class="enscript-keyword">movl</span>	    %esi,(%edi)	    // q empty so this is first element
	<span class="enscript-keyword">jmp</span>	    4f
<span class="enscript-function-name">3:</span>
	<span class="enscript-keyword">movl</span>	    %esi,(%edx,%ecx) // point to new element from last
<span class="enscript-function-name">4:</span>
	<span class="enscript-keyword">movl</span>	    %esi,4(%edi)    // new element becomes last in q
	<span class="enscript-keyword">movl</span>	    $0,8(%edi)	    // unlock spinlock
	<span class="enscript-keyword">ret
</span>COMMPAGE_DESCRIPTOR(pfz_enqueue,_COMM_PAGE_PFZ_ENQUEUE)


/* Preemption-free-zone routine to FIFO Dequeue:
 <span class="enscript-keyword">*</span>	%edi = ptr to queue head structure
 <span class="enscript-keyword">*</span>	%edx = offset of link field in elements
 <span class="enscript-keyword">*</span>	%ebx = preemption flag (kernel sets nonzero if we should preempt)
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> Returns with next element (or 0) in %eax.
 <span class="enscript-keyword">*/
</span> <span class="enscript-keyword">
</span>COMMPAGE_FUNCTION_START(pfz_dequeue, 32, 4)
<span class="enscript-function-name">1:</span>
	<span class="enscript-keyword">xorl</span>	    %eax, %eax
	<span class="enscript-keyword">orl</span>	    $-1, %ecx
	<span class="enscript-keyword">lock
</span>	<span class="enscript-keyword">cmpxchgl</span>    %ecx, 8(%edi)   // try to take the spinlock
	<span class="enscript-keyword">jz</span>	    2f		    // got it
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">pause
</span>	<span class="enscript-keyword">xorl</span>	    %eax, %eax
	<span class="enscript-keyword">lock
</span>	<span class="enscript-keyword">cmpxchgl</span>    %ecx, 8(%edi)   // try 2nd time to take the spinlock
	<span class="enscript-keyword">jz</span>	    2f		    // got it
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">pause
</span>	<span class="enscript-keyword">xorl</span>	    %eax, %eax
	<span class="enscript-keyword">lock
</span>	<span class="enscript-keyword">cmpxchgl</span>    %ecx, 8(%edi)   // try 3rd time to take the spinlock
	<span class="enscript-keyword">jz</span>	    2f		    // got it
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">COMMPAGE_CALL(_COMM_PAGE_BACKOFF,_COMM_PAGE_PFZ_DEQUEUE,pfz_dequeue)
</span>	<span class="enscript-keyword">jmp</span>	    1b		    // loop to try again
<span class="enscript-function-name">2:</span>
	<span class="enscript-keyword">movl</span>	    (%edi),%eax	    // get ptr to first element in q
	<span class="enscript-keyword">testl</span>	    %eax,%eax	    // q null?
	<span class="enscript-keyword">jz</span>	    4f		    // yes
	<span class="enscript-keyword">movl</span>	    (%edx,%eax),%esi// get ptr to 2nd element in q
	<span class="enscript-keyword">testl</span>	    %esi,%esi	    // is there a 2nd element?
	<span class="enscript-keyword">jnz</span>	    3f		    // yes
	<span class="enscript-keyword">movl</span>	    %esi,4(%edi)    // clear <span class="enscript-string">&quot;last&quot;</span> field of q head
<span class="enscript-function-name">3:</span>
	<span class="enscript-keyword">movl</span>	    %esi,(%edi)	    // update <span class="enscript-string">&quot;first&quot;</span> field of q head
<span class="enscript-function-name">4:</span>
	<span class="enscript-keyword">movl</span>	    $0,8(%edi)	    // unlock spinlock
	<span class="enscript-keyword">ret
</span>COMMPAGE_DESCRIPTOR(pfz_dequeue,_COMM_PAGE_PFZ_DEQUEUE)




/************************* x86_64 versions follow **************************/


/*
 <span class="enscript-keyword">*</span>	typedef	volatile struct {
 <span class="enscript-keyword">*</span>		void	*opaque1<span class="enscript-comment">;  &lt;-- ptr to first queue element or null
 *		void	*opaque2;  &lt;-- ptr to last queue element or null
</span> <span class="enscript-keyword">*</span>		int	 opaque3<span class="enscript-comment">;  &lt;-- spinlock
 *	} OSFifoQueueHead;
</span> <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> void  OSAtomicFifoEnqueue( OSFifoQueueHead *list, void *new, size_t offset)<span class="enscript-comment">;
 */
</span>

/* Subroutine to make a preempt syscall.  Called when we notice %ebx is
 <span class="enscript-keyword">*</span> nonzero after returning from a PFZ subroutine.  Not in PFZ.
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> All registers preserved (but does clear the %ebx preemption flag).
 <span class="enscript-keyword">*/
</span>COMMPAGE_FUNCTION_START(preempt_64, 64, 4)
	<span class="enscript-keyword">pushq</span>	%rax
	<span class="enscript-keyword">pushq</span>	%rcx
	<span class="enscript-keyword">pushq</span>	%r11
	<span class="enscript-keyword">movl</span>	$(SYSCALL_CONSTRUCT_MACH(58)),%eax	/* 58 = pfz_exit */
	<span class="enscript-keyword">xorl</span>	%ebx,%ebx
	<span class="enscript-keyword">syscall
</span>	<span class="enscript-keyword">popq</span>	%r11
	<span class="enscript-keyword">popq</span>	%rcx
	<span class="enscript-keyword">popq</span>	%rax
	<span class="enscript-keyword">ret
</span>COMMPAGE_DESCRIPTOR(preempt_64,_COMM_PAGE_PREEMPT)


/* Subroutine to back off if we cannot get the spinlock.  Called
 <span class="enscript-keyword">*</span> after a few attempts inline in the PFZ subroutines.  This code is
 <span class="enscript-keyword">*</span> not in the PFZ.
 <span class="enscript-keyword">*</span>	%rdi = ptr to queue head structure
 <span class="enscript-keyword">*</span>	%ebx = preemption flag (nonzero if preemption pending)
 <span class="enscript-keyword">*</span> Uses: %rax.
 <span class="enscript-keyword">*/
</span>COMMPAGE_FUNCTION_START(backoff_64, 64, 4)
	<span class="enscript-keyword">testl</span>	%ebx,%ebx	// does kernel want to preempt us?
	<span class="enscript-keyword">jz</span>	1f		// no
	<span class="enscript-keyword">COMMPAGE_CALL(_COMM_PAGE_PREEMPT,_COMM_PAGE_BACKOFF,backoff_64)
</span><span class="enscript-function-name">1:</span>
	<span class="enscript-keyword">pause</span>			// SMT-friendly backoff
	<span class="enscript-keyword">cmpl</span>	$0,16(%rdi)	// sniff the lockword
	<span class="enscript-keyword">jnz</span>	1b		// loop if still taken
	<span class="enscript-keyword">ret</span>			// lockword is free, so reenter PFZ
COMMPAGE_DESCRIPTOR(backoff_64,_COMM_PAGE_BACKOFF)


/* Preemption-free-zone routine to FIFO Enqueue:
 <span class="enscript-keyword">*</span>	%rdi = ptr to queue head structure
 <span class="enscript-keyword">*</span>	%rsi = ptr to new element to enqueue
 <span class="enscript-keyword">*</span>	%rdx = offset of link field in elements
 <span class="enscript-keyword">*</span>	%ebx = preemption flag (kernel sets nonzero if we should preempt)
 <span class="enscript-keyword">*/
</span> <span class="enscript-keyword">
</span>COMMPAGE_FUNCTION_START(pfz_enqueue_64, 64, 4)
	<span class="enscript-keyword">movq</span>	    $0,(%rdx,%rsi)  // zero forward link in new element
<span class="enscript-function-name">1:</span>
	<span class="enscript-keyword">xorl</span>	    %eax, %eax
	<span class="enscript-keyword">orl</span>	    $-1, %ecx
	<span class="enscript-keyword">lock
</span>	<span class="enscript-keyword">cmpxchgl</span>    %ecx,16(%rdi)   // try to take the spinlock
	<span class="enscript-keyword">jz</span>	    2f		    // got it
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">pause
</span>	<span class="enscript-keyword">xorl</span>	    %eax, %eax
	<span class="enscript-keyword">lock
</span>	<span class="enscript-keyword">cmpxchgl</span>    %ecx,16(%rdi)   // try 2nd time to take the spinlock
	<span class="enscript-keyword">jz</span>	    2f		    // got it
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">pause
</span>	<span class="enscript-keyword">xorl</span>	    %eax, %eax
	<span class="enscript-keyword">lock
</span>	<span class="enscript-keyword">cmpxchgl</span>    %ecx,16(%rdi)   // try 3rd time to take the spinlock
	<span class="enscript-keyword">jz</span>	    2f		    // got it
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">COMMPAGE_CALL(_COMM_PAGE_BACKOFF,_COMM_PAGE_PFZ_ENQUEUE,pfz_enqueue_64)
</span>	<span class="enscript-keyword">jmp</span>	    1b		    // loop to try again
<span class="enscript-function-name">2:</span>
	<span class="enscript-keyword">movq</span>	    8(%rdi),%rcx    // get ptr to last element in q
	<span class="enscript-keyword">testq</span>	    %rcx,%rcx	    // q null?
	<span class="enscript-keyword">jnz</span>	    3f		    // no
	<span class="enscript-keyword">movq</span>	    %rsi,(%rdi)	    // q empty so this is first element
	<span class="enscript-keyword">jmp</span>	    4f
<span class="enscript-function-name">3:</span>
	<span class="enscript-keyword">movq</span>	    %rsi,(%rdx,%rcx) // point to new element from last
<span class="enscript-function-name">4:</span>
	<span class="enscript-keyword">movq</span>	    %rsi,8(%rdi)    // new element becomes last in q
	<span class="enscript-keyword">movl</span>	    $0,16(%rdi)	    // unlock spinlock
	<span class="enscript-keyword">ret
</span>COMMPAGE_DESCRIPTOR(pfz_enqueue_64,_COMM_PAGE_PFZ_ENQUEUE)



/* Preemption-free-zone routine to FIFO Dequeue:
 <span class="enscript-keyword">*</span>	%rdi = ptr to queue head structure
 <span class="enscript-keyword">*</span>	%rdx = offset of link field in elements
 <span class="enscript-keyword">*</span>	%ebx = preemption flag (kernel sets nonzero if we should preempt)
 <span class="enscript-keyword">*
</span> <span class="enscript-keyword">*</span> Returns with next element (or 0) in %rax.
 <span class="enscript-keyword">*/
</span> <span class="enscript-keyword">
</span>COMMPAGE_FUNCTION_START(pfz_dequeue_64, 64, 4)
<span class="enscript-function-name">1:</span>
	<span class="enscript-keyword">xorl</span>	    %eax, %eax
	<span class="enscript-keyword">orl</span>	    $-1, %ecx
	<span class="enscript-keyword">lock
</span>	<span class="enscript-keyword">cmpxchgl</span>    %ecx,16(%rdi)   // try to take the spinlock
	<span class="enscript-keyword">jz</span>	    2f		    // got it
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">pause
</span>	<span class="enscript-keyword">xorl</span>	    %eax, %eax
	<span class="enscript-keyword">lock
</span>	<span class="enscript-keyword">cmpxchgl</span>    %ecx,16(%rdi)   // try 2nd time to take the spinlock
	<span class="enscript-keyword">jz</span>	    2f		    // got it
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">pause
</span>	<span class="enscript-keyword">xorl</span>	    %eax, %eax
	<span class="enscript-keyword">lock
</span>	<span class="enscript-keyword">cmpxchgl</span>    %ecx,16(%rdi)   // try 3rd time to take the spinlock
	<span class="enscript-keyword">jz</span>	    2f		    // got it
	<span class="enscript-keyword">
</span>	<span class="enscript-keyword">COMMPAGE_CALL(_COMM_PAGE_BACKOFF,_COMM_PAGE_PFZ_DEQUEUE,pfz_dequeue_64)
</span>	<span class="enscript-keyword">jmp</span>	    1b		    // loop to try again
<span class="enscript-function-name">2:</span>
	<span class="enscript-keyword">movq</span>	    (%rdi),%rax	    // get ptr to first element in q
	<span class="enscript-keyword">testq</span>	    %rax,%rax	    // q null?
	<span class="enscript-keyword">jz</span>	    4f		    // yes
	<span class="enscript-keyword">movq</span>	    (%rdx,%rax),%rsi// get ptr to 2nd element in q
	<span class="enscript-keyword">testq</span>	    %rsi,%rsi	    // is there a 2nd element?
	<span class="enscript-keyword">jnz</span>	    3f		    // yes
	<span class="enscript-keyword">movq</span>	    %rsi,8(%rdi)    // no - clear <span class="enscript-string">&quot;last&quot;</span> field of q head
<span class="enscript-function-name">3:</span>
	<span class="enscript-keyword">movq</span>	    %rsi,(%rdi)	    // update <span class="enscript-string">&quot;first&quot;</span> field of q head
<span class="enscript-function-name">4:</span>
	<span class="enscript-keyword">movl</span>	    $0,16(%rdi)	    // unlock spinlock
	<span class="enscript-keyword">ret
</span>COMMPAGE_DESCRIPTOR(pfz_dequeue_64,_COMM_PAGE_PFZ_DEQUEUE)
</pre>
<hr />
</body></html>