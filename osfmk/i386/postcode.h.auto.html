<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>postcode.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">postcode.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2008 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">ifndef</span>	<span class="enscript-variable-name">_I386_POSTCODE_H_</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">_I386_POSTCODE_H_</span>

<span class="enscript-comment">/*
 * Postcodes are no longer enabled by default in the DEBUG kernel
 * because platforms may not have builtin port 0x80 support.
 * To re-enable postcode outpout, uncomment the following define:
 */</span>
<span class="enscript-comment">//#define DEBUG_POSTCODE 1
</span>
<span class="enscript-comment">/* Define this to delay about 1 sec after posting each code */</span>
<span class="enscript-comment">//#define POSTCODE_DELAY 1
</span>
<span class="enscript-comment">/* The POSTCODE is port 0x80 */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">POSTPORT</span> 0x80

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">SPINCOUNT</span>	300000000
#<span class="enscript-reference">define</span> <span class="enscript-function-name">CPU_PAUSE</span>()	rep; nop

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">DEBUG_POSTCODE</span>
<span class="enscript-comment">/*
 * Macro to output byte value to postcode, destoying register al.
 * Additionally, if POSTCODE_DELAY, spin for about a second.
 */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">POSTCODE_DELAY</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">POSTCODE_AL</span>			\
        outb    %al,$(POSTPORT);	\
	movl	$(SPINCOUNT), %eax;	\
<span class="enscript-reference">1</span>:					\
	CPU_PAUSE();			\
	decl	%eax;			\
	jne	1b
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">POSTCODE_AX</span>			\
        outw    %ax,$(POSTPORT);	\
	movl	$(SPINCOUNT), %eax;	\
<span class="enscript-reference">1</span>:					\
	CPU_PAUSE();			\
	decl	%eax;			\
	jne	1b
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">POSTCODE_AL</span>			\
        outb    %al,$(POSTPORT)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">POSTCODE_AX</span>			\
        outw    %ax,$(POSTPORT)
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* POSTCODE_DELAY */</span>

#<span class="enscript-reference">define</span> <span class="enscript-function-name">POSTCODE</span>(XX)			\
	mov	$(XX), %al;		\
	POSTCODE_AL

#<span class="enscript-reference">define</span> <span class="enscript-function-name">POSTCODE2</span>(XXXX)			\
	mov	$(XXXX), %ax;		\
	POSTCODE_AX

<span class="enscript-comment">/* Output byte value to postcode, without destoying register eax */</span> 
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">POSTCODE_SAVE_EAX</span>(XX)		\
	push	%eax;			\
	POSTCODE(XX);			\
	pop	%eax

<span class="enscript-comment">/*
 * Display a 32-bit value to the post card - low byte to high byte
 * Entry: value in %ebx
 * Exit: %ebx preserved; %eax destroyed
 */</span> 
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">POSTCODE32_EBX</span>			\
	roll	$8, %ebx;		\
	movl	%ebx, %eax;		\
	POSTCODE_AL;			\
					\
	roll	$8, %ebx;		\
	movl	%ebx, %eax;		\
	POSTCODE_AL;			\
					\
	roll	$8, %ebx;		\
	movl	%ebx, %eax;		\
	POSTCODE_AL;			\
					\
	roll	$8, %ebx;		\
	movl	%ebx, %eax;		\
	POSTCODE_AL

#<span class="enscript-reference">else</span>	<span class="enscript-comment">/* DEBUG_POSTCODE */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">POSTCODE_AL</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">POSTCODE_AX</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">POSTCODE</span>(X)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">POSTCODE2</span>(X)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">POSTCODE_SAVE_EAX</span>(X)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">POSTCODE32_EBX</span>
#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* DEBUG_POSTCODE */</span>

<span class="enscript-comment">/*
 * The following postcodes are defined for stages of early startup:
 */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PSTART_ENTRY</span>			0xFF
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PSTART_REBASE</span>			0xFE
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PSTART_BEFORE_PAGING</span>		0xFE
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PSTART_VSTART</span>			0xFD
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VSTART_ENTRY</span>			0xFC
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VSTART_IDLE_PTS_INIT</span>		0xFB
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VSTART_PHYSMAP_INIT</span>		0xFA
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VSTART_DESC_ALIAS_INIT</span>		0xF9
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VSTART_SET_CR3</span>			0xF8
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VSTART_CPU_DESC_INIT</span>		0xF7
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VSTART_CPU_MODE_INIT</span>		0xF6
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VSTART_EXIT</span>			0xF5
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">I386_INIT_ENTRY</span>			0xF4
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CPU_INIT_D</span>			0xF3
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PE_INIT_PLATFORM_D</span>		0xF2

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">SLAVE_STARTPROG_ENTRY</span>		0xEF
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">SLAVE_PSTART</span>			0xEE
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">I386_INIT_SLAVE</span>			0xED

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PANIC_DOUBLE_FAULT</span>		0xDF	<span class="enscript-comment">/* Double Fault exception */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PANIC_MACHINE_CHECK</span>		0xDE	<span class="enscript-comment">/* Machine-Check */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">MP_KDP_ENTER</span>			0xDB	<span class="enscript-comment">/* Machine in kdp DeBugger */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">PANIC_HLT</span>			0xD1	<span class="enscript-comment">/* Die an early death */</span> 
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">NO_64BIT</span>			0x64	<span class="enscript-comment">/* No 64-bit support yet */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ACPI_WAKE_START_ENTRY</span>		0xCF
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ACPI_WAKE_PROT_ENTRY</span>		0xCE
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ACPI_WAKE_PAGED_ENTRY</span>		0xCD

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CPU_IA32_ENABLE_ENTRY</span>		0xBF
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CPU_IA32_ENABLE_EXIT</span>		0xBE
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ML_LOAD_DESC64_ENTRY</span>		0xBD
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ML_LOAD_DESC64_GDT</span>		0xBC
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ML_LOAD_DESC64_IDT</span>		0xBB
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ML_LOAD_DESC64_LDT</span>		0xBA
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ML_LOAD_DESC64_EXIT</span>		0xB9
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CPU_IA32_DISABLE_ENTRY</span>		0xB8
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">CPU_IA32_DISABLE_EXIT</span>		0xB7

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">ASSEMBLER</span>
inline <span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">_postcode_delay</span>(uint32_t	spincount)
{
	asm <span class="enscript-type">volatile</span>(<span class="enscript-string">&quot;1:			\n\t&quot;</span>
	             <span class="enscript-string">&quot;  rep; nop;		\n\t&quot;</span>	
		     <span class="enscript-string">&quot;  decl %%eax;		\n\t&quot;</span>
		     <span class="enscript-string">&quot;  jne 1b&quot;</span>
		     : : <span class="enscript-string">&quot;a&quot;</span> (spincount));
}
inline <span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">_postcode</span>(uint8_t	xx)
{
	asm <span class="enscript-type">volatile</span>(<span class="enscript-string">&quot;outb %0, %1&quot;</span> : : <span class="enscript-string">&quot;a&quot;</span> (xx), <span class="enscript-string">&quot;N&quot;</span> (POSTPORT));
}
inline <span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">_postcode2</span>(uint16_t	xxxx)
{
	asm <span class="enscript-type">volatile</span>(<span class="enscript-string">&quot;outw %0, %1&quot;</span> : : <span class="enscript-string">&quot;a&quot;</span> (xxxx), <span class="enscript-string">&quot;N&quot;</span> (POSTPORT));
}
#<span class="enscript-reference">if</span>	<span class="enscript-variable-name">DEBUG_POSTCODE</span>
inline <span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">postcode</span>(uint8_t	xx)
{
	_postcode(xx);
#<span class="enscript-reference">if</span>	<span class="enscript-variable-name">POSTCODE_DELAY</span>
	_postcode_delay(SPINCOUNT);
#<span class="enscript-reference">endif</span>
}
inline <span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">postcode2</span>(uint8_t	xxxx)
{
	_postcode2(xxxx);
#<span class="enscript-reference">if</span>	<span class="enscript-variable-name">POSTCODE_DELAY</span>
	_postcode_delay(SPINCOUNT);
#<span class="enscript-reference">endif</span>
}
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">postcode</span>(xx) do {} while(0)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">postcode2</span>(xxxx) do {} while(0)
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* _I386_POSTCODE_H_ */</span>
</pre>
<hr />
</body></html>