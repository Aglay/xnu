<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>panic_hooks.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">panic_hooks.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2014 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;panic_hooks.h&quot;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/queue.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/locks.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/thread.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/WKdm_new.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;pexpert/boot.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;pmap.h&quot;</span>

<span class="enscript-type">struct</span> panic_hook {
	uint32_t			magic1;
	queue_chain_t		chain;
	thread_t			thread;
	panic_hook_fn_t 	hook_fn;
	uint32_t			magic2;
};

<span class="enscript-type">typedef</span> <span class="enscript-type">char</span> check1_[<span class="enscript-keyword">sizeof</span>(<span class="enscript-type">struct</span> panic_hook)
					 &lt;= <span class="enscript-keyword">sizeof</span>(panic_hook_t) ? 1 : -1];
<span class="enscript-type">typedef</span> <span class="enscript-type">char</span> check2_[PAGE_SIZE == 4096 ? 1 : -1];

<span class="enscript-type">static</span> hw_lock_data_t 	panic_hooks_lock;
<span class="enscript-type">static</span> queue_head_t 	panic_hooks;
<span class="enscript-type">static</span> uint8_t		 	panic_dump_buf[8192];

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PANIC_HOOK_MAGIC1</span>		0x4A1C400C
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PANIC_HOOK_MAGIC2</span>		0xC004C1A4

<span class="enscript-type">void</span> <span class="enscript-function-name">panic_hooks_init</span>(<span class="enscript-type">void</span>)
{
	hw_lock_init(&amp;panic_hooks_lock);
	queue_init(&amp;panic_hooks);
}

<span class="enscript-type">void</span> <span class="enscript-function-name">panic_hook</span>(panic_hook_t *hook_, panic_hook_fn_t hook_fn)
{
	<span class="enscript-type">struct</span> panic_hook *hook = (<span class="enscript-type">struct</span> panic_hook *)hook_;

	hook-&gt;magic1 	= PANIC_HOOK_MAGIC1;
	hook-&gt;magic2 	= PANIC_HOOK_MAGIC2;
	hook-&gt;hook_fn 	= hook_fn;
	hook-&gt;thread	= current_thread();

	hw_lock_lock(&amp;panic_hooks_lock);
	queue_enter(&amp;panic_hooks, hook, <span class="enscript-type">struct</span> panic_hook *, chain);
	hw_lock_unlock(&amp;panic_hooks_lock);
}

<span class="enscript-type">void</span> <span class="enscript-function-name">panic_unhook</span>(panic_hook_t *hook_)
{
	<span class="enscript-type">struct</span> panic_hook *hook = (<span class="enscript-type">struct</span> panic_hook *)hook_;

	hw_lock_lock(&amp;panic_hooks_lock);
	queue_remove(&amp;panic_hooks, hook, <span class="enscript-type">struct</span> panic_hook *, chain);
	hw_lock_unlock(&amp;panic_hooks_lock);
}

<span class="enscript-type">void</span> <span class="enscript-function-name">panic_check_hook</span>(<span class="enscript-type">void</span>)
{
	<span class="enscript-type">struct</span> panic_hook *hook;
	thread_t thread = current_thread();
	uint32_t count = 0;

	queue_iterate(&amp;panic_hooks, hook, <span class="enscript-type">struct</span> panic_hook *, chain) {
		<span class="enscript-keyword">if</span> (++count &gt; 1024
			|| !kvtophys((vm_offset_t)hook)
			|| !kvtophys((vm_offset_t)hook + <span class="enscript-keyword">sizeof</span> (*hook) - 1)
			|| hook-&gt;magic1 != PANIC_HOOK_MAGIC1
			|| hook-&gt;magic2 != PANIC_HOOK_MAGIC2
			|| !kvtophys((vm_offset_t)hook-&gt;hook_fn))
			<span class="enscript-keyword">return</span>;

		<span class="enscript-keyword">if</span> (hook-&gt;thread == thread) {
			hook-&gt;hook_fn((panic_hook_t *)hook);
			<span class="enscript-keyword">return</span>;
		}
	}
}

<span class="enscript-comment">/*
 * addr should be page aligned and len should be multiple of page
 * size.  This will currently only work if each page can be compressed
 * to no more than 4095 bytes.
 *
 * Remember the debug buffer isn't very big so don't try and dump too
 * much.
 */</span>
<span class="enscript-type">void</span> <span class="enscript-function-name">panic_dump_mem</span>(<span class="enscript-type">const</span> <span class="enscript-type">void</span> *addr, <span class="enscript-type">int</span> len)
{
	<span class="enscript-type">void</span> *scratch = panic_dump_buf + 4096;

	<span class="enscript-keyword">for</span> (; len &gt; 0; addr = (<span class="enscript-type">const</span> uint8_t *)addr + PAGE_SIZE, len -= PAGE_SIZE) {
		<span class="enscript-keyword">if</span> (!kvtophys((vm_offset_t)addr))
			<span class="enscript-keyword">continue</span>;

		<span class="enscript-comment">// 4095 is multiple of 3 -- see below
</span>		<span class="enscript-type">int</span> n = WKdm_compress_new((<span class="enscript-type">const</span> WK_word *)addr, (WK_word *)(<span class="enscript-type">void</span> *)panic_dump_buf,
								  scratch, 4095);

		<span class="enscript-keyword">if</span> (n == -1)
			<span class="enscript-keyword">return</span>; <span class="enscript-comment">// Give up
</span>
		kdb_log(<span class="enscript-string">&quot;%p: &quot;</span>, addr);

		<span class="enscript-comment">// Dump out base64
</span>		<span class="enscript-type">static</span> <span class="enscript-type">char</span> base64_table[] = <span class="enscript-string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>
			<span class="enscript-string">&quot;abcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span>;

		<span class="enscript-comment">// Pad to multiple of 3
</span>		<span class="enscript-keyword">switch</span> (n % 3) {
		<span class="enscript-keyword">case</span> <span class="enscript-reference">1</span>:
			panic_dump_buf[n++] = 0;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">2</span>:
			panic_dump_buf[n++] = 0;
		}

		uint8_t *p = panic_dump_buf;
		<span class="enscript-keyword">while</span> (n) {
			uint8_t c;

			c = p[0] &gt;&gt; 2;
			consdebug_log(base64_table[c]);

			c = (p[0] &lt;&lt; 4 | p[1] &gt;&gt; 4) &amp; 0x3f;
			consdebug_log(base64_table[c]);

			c = (p[1] &lt;&lt; 2 | p[2] &gt;&gt; 6) &amp; 0x3f;
			consdebug_log(base64_table[c]);

			c = p[2] &amp; 0x3f;
			consdebug_log(base64_table[c]);

			p += 3;
			n -= 3;
		}

		consdebug_log(<span class="enscript-string">'\n'</span>);
	}
}

boolean_t <span class="enscript-function-name">panic_phys_range_before</span>(<span class="enscript-type">const</span> <span class="enscript-type">void</span> *addr, uint64_t *pphys, 
							 panic_phys_range_t *range)
{
	*pphys = kvtophys((vm_offset_t)addr);

	<span class="enscript-type">const</span> boot_args *args = PE_state.bootArgs;

	<span class="enscript-keyword">if</span> (!kvtophys((vm_offset_t)args))
		<span class="enscript-keyword">return</span> FALSE;

	<span class="enscript-type">const</span> EfiMemoryRange *r = PHYSMAP_PTOV((uintptr_t)args-&gt;MemoryMap), *closest = NULL;
	<span class="enscript-type">const</span> uint32_t size = args-&gt;MemoryMapDescriptorSize;
	<span class="enscript-type">const</span> uint32_t count = args-&gt;MemoryMapSize / size;

	<span class="enscript-keyword">if</span> (count &gt; 1024)	<span class="enscript-comment">// Sanity check
</span>		<span class="enscript-keyword">return</span> FALSE;

	<span class="enscript-keyword">for</span> (uint32_t i = 0; i &lt; count; ++i, r = (<span class="enscript-type">const</span> EfiMemoryRange *)(<span class="enscript-type">const</span> <span class="enscript-type">void</span> *)((<span class="enscript-type">const</span> uint8_t *)r + size)) {
		<span class="enscript-keyword">if</span> (r-&gt;PhysicalStart + r-&gt;NumberOfPages * PAGE_SIZE &gt; *pphys)
			<span class="enscript-keyword">continue</span>;

		<span class="enscript-keyword">if</span> (!closest || r-&gt;PhysicalStart &gt; closest-&gt;PhysicalStart)
			closest = r;
	}

	<span class="enscript-keyword">if</span> (!closest)
		<span class="enscript-keyword">return</span> FALSE;

	range-&gt;type 		= closest-&gt;Type;
	range-&gt;phys_start 	= closest-&gt;PhysicalStart;
	range-&gt;len 			= closest-&gt;NumberOfPages * PAGE_SIZE;

	<span class="enscript-keyword">return</span> TRUE;
}
</pre>
<hr />
</body></html>