<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>bsd_i386_native.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">bsd_i386_native.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2010-2012 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach_rt.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach_debug.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach_ldebug.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/kern_return.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/mach_traps.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/thread_status.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/vm_param.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/counters.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/cpu_data.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/mach_param.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/task.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/thread.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/sched_prim.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/misc_protos.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/assert.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/debug.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/spl.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/syscall_sw.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;ipc/ipc_port.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/vm_kern.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/pmap.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/cpu_number.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/eflags.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/proc_reg.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/tss.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/user_ldt.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/fpu.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/machdep_call.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/vmparam.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/mp_desc.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/misc_protos.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/thread.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/trap.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;i386/seg.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/i386/syscall_sw.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/syscall.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/kdebug.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/errno.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;../bsd/sys/sysent.h&gt;</span>


<span class="enscript-comment">/*
 * Duplicate parent state in child
 * for U**X fork.
 */</span>
kern_return_t
<span class="enscript-function-name">machine_thread_dup</span>(
    thread_t		parent,
    thread_t		child
)
{
	
	pcb_t		parent_pcb = THREAD_TO_PCB(parent);
	pcb_t		child_pcb = THREAD_TO_PCB(child);

	<span class="enscript-comment">/*
	 * Copy over the x86_saved_state registers
	 */</span>
	<span class="enscript-keyword">if</span> (thread_is_64bit(parent))
		bcopy(USER_REGS64(parent), USER_REGS64(child), <span class="enscript-keyword">sizeof</span>(x86_saved_state64_t));
	<span class="enscript-keyword">else</span>
		bcopy(USER_REGS32(parent), USER_REGS32(child), <span class="enscript-keyword">sizeof</span>(x86_saved_state32_t));

	<span class="enscript-comment">/*
	 * Check to see if parent is using floating point
	 * and if so, copy the registers to the child
	 */</span>
	fpu_dup_fxstate(parent, child);

#<span class="enscript-reference">ifdef</span>	<span class="enscript-variable-name">MACH_BSD</span>
	<span class="enscript-comment">/*
	 * Copy the parent's cthread id and USER_CTHREAD descriptor, if 32-bit.
	 */</span>
	child_pcb-&gt;cthread_self = parent_pcb-&gt;cthread_self;
	<span class="enscript-keyword">if</span> (!thread_is_64bit(parent))
		child_pcb-&gt;cthread_desc = parent_pcb-&gt;cthread_desc;

	<span class="enscript-comment">/*
	 * FIXME - should a user specified LDT, TSS and V86 info
	 * be duplicated as well?? - probably not.
	 */</span>
	<span class="enscript-comment">// duplicate any use LDT entry that was set I think this is appropriate.
</span>        <span class="enscript-keyword">if</span> (parent_pcb-&gt;uldt_selector!= 0) {
	        child_pcb-&gt;uldt_selector = parent_pcb-&gt;uldt_selector;
		child_pcb-&gt;uldt_desc = parent_pcb-&gt;uldt_desc;
	}
#<span class="enscript-reference">endif</span>

	<span class="enscript-keyword">return</span> (KERN_SUCCESS);
}

<span class="enscript-type">void</span> <span class="enscript-function-name">thread_set_parent</span>(thread_t parent, <span class="enscript-type">int</span> pid);

<span class="enscript-type">void</span>
<span class="enscript-function-name">thread_set_parent</span>(thread_t parent, <span class="enscript-type">int</span> pid)
{
	pal_register_cache_state(parent, DIRTY);

	<span class="enscript-keyword">if</span> (thread_is_64bit(parent)) {
		x86_saved_state64_t	*iss64;

		iss64 = USER_REGS64(parent);

		iss64-&gt;rax = pid;
		iss64-&gt;rdx = 0;
		iss64-&gt;isf.rflags &amp;= ~EFL_CF;
	} <span class="enscript-keyword">else</span> {
		x86_saved_state32_t	*iss32;

		iss32 = USER_REGS32(parent);

		iss32-&gt;eax = pid;
		iss32-&gt;edx = 0;
		iss32-&gt;efl &amp;= ~EFL_CF;
	}
}

<span class="enscript-comment">/*
 * thread_fast_set_cthread_self: Sets the machine kernel thread ID of the
 * current thread to the given thread ID; fast version for 32-bit processes
 *
 * Parameters:    self                    Thread ID to set
 *                
 * Returns:        0                      Success
 *                !0                      Not success
 */</span>
kern_return_t
<span class="enscript-function-name">thread_fast_set_cthread_self</span>(uint32_t self)
{
	machine_thread_set_tsd_base(current_thread(), self);
	<span class="enscript-keyword">return</span> (USER_CTHREAD); <span class="enscript-comment">/* N.B.: not a kern_return_t! */</span>
}

<span class="enscript-comment">/*
 * thread_fast_set_cthread_self64: Sets the machine kernel thread ID of the
 * current thread to the given thread ID; fast version for 64-bit processes 
 *
 * Parameters:    self                    Thread ID
 *                
 * Returns:        0                      Success
 *                !0                      Not success
 */</span>
kern_return_t
<span class="enscript-function-name">thread_fast_set_cthread_self64</span>(uint64_t self)
{
	machine_thread_set_tsd_base(current_thread(), self);
	<span class="enscript-keyword">return</span> (USER_CTHREAD); <span class="enscript-comment">/* N.B.: not a kern_return_t! */</span>
}

<span class="enscript-comment">/*
 * thread_set_user_ldt routine is the interface for the user level
 * settable ldt entry feature.  allowing a user to create arbitrary
 * ldt entries seems to be too large of a security hole, so instead
 * this mechanism is in place to allow user level processes to have
 * an ldt entry that can be used in conjunction with the FS register.
 *
 * Swapping occurs inside the pcb.c file along with initialization
 * when a thread is created. The basic functioning theory is that the
 * pcb-&gt;uldt_selector variable will contain either 0 meaning the
 * process has not set up any entry, or the selector to be used in
 * the FS register. pcb-&gt;uldt_desc contains the actual descriptor the
 * user has set up stored in machine usable ldt format.
 *
 * Currently one entry is shared by all threads (USER_SETTABLE), but
 * this could be changed in the future by changing how this routine
 * allocates the selector. There seems to be no real reason at this
 * time to have this added feature, but in the future it might be
 * needed.
 *
 * address is the linear address of the start of the data area size
 * is the size in bytes of the area flags should always be set to 0
 * for now. in the future it could be used to set R/W permisions or
 * other functions. Currently the segment is created as a data segment
 * up to 1 megabyte in size with full read/write permisions only.
 *
 * this call returns the segment selector or -1 if any error occurs
 */</span>
kern_return_t
<span class="enscript-function-name">thread_set_user_ldt</span>(uint32_t address, uint32_t size, uint32_t flags)
{
	pcb_t pcb;
	<span class="enscript-type">struct</span> fake_descriptor temp;

	<span class="enscript-keyword">if</span> (flags != 0)
		<span class="enscript-keyword">return</span> -1;		<span class="enscript-comment">// flags not supported
</span>	<span class="enscript-keyword">if</span> (size &gt; 0xFFFFF)
		<span class="enscript-keyword">return</span> -1;		<span class="enscript-comment">// size too big, 1 meg is the limit
</span>
	mp_disable_preemption();

	<span class="enscript-comment">// create a &quot;fake&quot; descriptor so we can use fix_desc()
</span>	<span class="enscript-comment">// to build a real one...
</span>	<span class="enscript-comment">//   32 bit default operation size
</span>	<span class="enscript-comment">//   standard read/write perms for a data segment
</span>	pcb = THREAD_TO_PCB(current_thread());
	temp.offset = address;
	temp.lim_or_seg = size;
	temp.size_or_wdct = SZ_32;
	temp.access = ACC_P|ACC_PL_U|ACC_DATA_W;

	<span class="enscript-comment">// turn this into a real descriptor
</span>	fix_desc(&amp;temp,1);

	<span class="enscript-comment">// set up our data in the pcb
</span>	pcb-&gt;uldt_desc = *(<span class="enscript-type">struct</span> real_descriptor*)&amp;temp;
	pcb-&gt;uldt_selector = USER_SETTABLE;		<span class="enscript-comment">// set the selector value
</span>
	<span class="enscript-comment">// now set it up in the current table...
</span>	*ldt_desc_p(USER_SETTABLE) = *(<span class="enscript-type">struct</span> real_descriptor*)&amp;temp;

	mp_enable_preemption();

	<span class="enscript-keyword">return</span> USER_SETTABLE;
}
</pre>
<hr />
</body></html>