<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>cpu_topology.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">cpu_topology.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2003-2010 Apple Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">KERNEL_PRIVATE</span>
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_I386_CPU_TOPOLOGY_H_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_I386_CPU_TOPOLOGY_H_</span>

<span class="enscript-comment">/*
 * This was originally part of cpu_threads.h.  It was split out so that
 * these structures could be referenced without pulling in all of the headers
 * required for the definition of cpu_data.  These data structures are
 * used by KEXTs in order to deal with the physical topology.
 *
 * NOTE: this header must stand on its own as much as possible
 * and not be dependent upon any unexported, kernel-private header.
 */</span>

<span class="enscript-comment">/*
 * Cache structure that can be used to identify the cache heirarchy.
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> x86_cpu_cache
{
    <span class="enscript-type">struct</span> x86_cpu_cache *next;		<span class="enscript-comment">/* next cache at this level/lcpu */</span>
    <span class="enscript-type">struct</span> x86_die	*die;		<span class="enscript-comment">/* die containing this cache (only for LLC) */</span>
    uint8_t		maxcpus;	<span class="enscript-comment">/* maximum # of cpus that can share */</span>
    uint8_t		nlcpus;		<span class="enscript-comment">/* # of logical cpus sharing this cache */</span>
    uint8_t		type;		<span class="enscript-comment">/* type of cache */</span>
    uint8_t		level;		<span class="enscript-comment">/* level of cache */</span>
    uint16_t		ways;		<span class="enscript-comment">/* # of ways in cache */</span>
    uint16_t		partitions;	<span class="enscript-comment">/* # of partitions in cache */</span>
    uint16_t		line_size;	<span class="enscript-comment">/* size of a cache line */</span>
    uint32_t		cache_size;	<span class="enscript-comment">/* total size of cache */</span>
    <span class="enscript-type">struct</span> x86_lcpu	*cpus[0];	<span class="enscript-comment">/* cpus sharing this cache */</span>
} x86_cpu_cache_t;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CPU_CACHE_TYPE_DATA</span>	1	<span class="enscript-comment">/* data cache */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CPU_CACHE_TYPE_INST</span>	2	<span class="enscript-comment">/* instruction cache */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CPU_CACHE_TYPE_UNIF</span>	3	<span class="enscript-comment">/* unified cache */</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CPU_CACHE_DEPTH_L1</span>	0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CPU_CACHE_DEPTH_L2</span>	1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CPU_CACHE_DEPTH_L3</span>	2

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MAX_CACHE_DEPTH</span>		3	<span class="enscript-comment">/* deepest cache */</span>

<span class="enscript-type">struct</span> pmc;
<span class="enscript-type">struct</span> cpu_data;
<span class="enscript-type">struct</span> mca_state;

<span class="enscript-comment">/*
 * Define the states that a (logical) CPU can be in.
 *
 * LCPU_OFF	This indicates that the CPU is &quot;off&quot;.  It requires a full
 *		restart.  This is the state of a CPU when the system first
 *		boots or when it comes out of &quot;sleep&quot; (aka S3/S5).
 *
 * LCPU_HALT	This indicates that the CPU has been &quot;halted&quot;.  It has been
 *		removed from the system but still retains its internal state
 *		so that it can be quickly brought back on-line.
 *
 * LCPU_NONSCHED	This indicates that the CPU is not schedulable.  It
 *		will still appear in the system as a viable CPU however no
 *		work will be sceduled on it.
 *
 * LCPU_PAUSE	This indicates that the CPU is &quot;paused&quot;.  This is usually
 *		done only during kernel debug.
 *
 * LCPU_IDLE	This indicates that the CPU is idle.  The scheduler has
 *		determined that there is no work for this CPU to do.
 *
 * LCPU_RUN	This indicates that the CPU is running code and performing work.
 *
 * In normal system operation, CPUs will usually be transitioning between
 * LCPU_IDLE and LCPU_RUN.
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> lcpu_state
{
    LCPU_OFF		= 0,	<span class="enscript-comment">/* 0 so the right thing happens on boot */</span>
    LCPU_HALT		= 1,
    LCPU_NONSCHED	= 2,
    LCPU_PAUSE		= 3,
    LCPU_IDLE		= 4,
    LCPU_RUN		= 5,
} lcpu_state_t;

<span class="enscript-comment">/*
 * In each topology structure there are two numbers: a logical number and a
 * physical number.
 *
 * The logical numbers represent the ID of that structure
 * relative to the enclosing structure and always starts at 0.  So when using
 * logical numbers, it is necessary to specify all elements in the topology
 * (ie to &quot;name&quot; a logical CPU using logical numbers, 4 numbers are required:
 * package, die, core, logical CPU).
 *
 * The physical numbers represent the ID of that structure and is unique (for
 * that structure) across the entire topology.
 *
 * The logical CPU structure contains a third number which is the CPU number.
 * This number is identical to the CPU number used in other parts of the kernel.
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> x86_lcpu
{
    <span class="enscript-type">struct</span> x86_lcpu	*next_in_core;	<span class="enscript-comment">/* next logical cpu in core */</span>
    <span class="enscript-type">struct</span> x86_lcpu	*next_in_die;	<span class="enscript-comment">/* next logical cpu in die */</span>
    <span class="enscript-type">struct</span> x86_lcpu	*next_in_pkg;	<span class="enscript-comment">/* next logical cpu in package */</span>
    <span class="enscript-type">struct</span> x86_lcpu	*lcpu;		<span class="enscript-comment">/* pointer back to self */</span>
    <span class="enscript-type">struct</span> x86_core	*core;		<span class="enscript-comment">/* core containing the logical cpu */</span>
    <span class="enscript-type">struct</span> x86_die	*die;		<span class="enscript-comment">/* die containing the logical cpu */</span>
    <span class="enscript-type">struct</span> x86_pkg	*package;	<span class="enscript-comment">/* package containing the logical cpu */</span>
    <span class="enscript-type">struct</span> cpu_data	*cpu;		<span class="enscript-comment">/* cpu_data structure */</span>
    uint32_t		flags;
    uint32_t		cpu_num;	<span class="enscript-comment">/* cpu number */</span>
    uint32_t		lnum;		<span class="enscript-comment">/* logical cpu number (within core) */</span>
    uint32_t		pnum;		<span class="enscript-comment">/* physical cpu number */</span>
    boolean_t		master;		<span class="enscript-comment">/* logical cpu is the master (boot) CPU */</span>
    boolean_t		primary;	<span class="enscript-comment">/* logical cpu is primary CPU in package */</span>
    <span class="enscript-type">volatile</span> lcpu_state_t	state;	<span class="enscript-comment">/* state of the logical CPU */</span>
    <span class="enscript-type">volatile</span> boolean_t	stopped;	<span class="enscript-comment">/* used to indicate that the CPU has &quot;stopped&quot; */</span>
    uint64_t		rtcPop;		<span class="enscript-comment">/* next timer pop programmed */</span>
    uint64_t		rtcDeadline;	<span class="enscript-comment">/* next etimer-requested deadline */</span>
    x86_cpu_cache_t	*caches[MAX_CACHE_DEPTH];
    <span class="enscript-type">void</span>		*pmStats;	<span class="enscript-comment">/* Power management stats for lcpu */</span>
    <span class="enscript-type">void</span>		*pmState;	<span class="enscript-comment">/* Power management state for lcpu */</span>
} x86_lcpu_t;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">X86CORE_FL_PRESENT</span>	0x80000000	<span class="enscript-comment">/* core is present */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">X86CORE_FL_READY</span>	0x40000000	<span class="enscript-comment">/* core struct is init'd */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">X86CORE_FL_HAS_HPET</span>	0x10000000	<span class="enscript-comment">/* core has HPET assigned */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">X86CORE_FL_HALTED</span>	0x00008000	<span class="enscript-comment">/* core is halted */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">X86CORE_FL_IDLE</span>		0x00004000	<span class="enscript-comment">/* core is idle */</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> x86_core
{
    <span class="enscript-type">struct</span> x86_core	*next_in_die;	<span class="enscript-comment">/* next core in die */</span>
    <span class="enscript-type">struct</span> x86_core	*next_in_pkg;	<span class="enscript-comment">/* next core in package */</span>
    <span class="enscript-type">struct</span> x86_die	*die;		<span class="enscript-comment">/* die containing the core */</span>
    <span class="enscript-type">struct</span> x86_pkg	*package;	<span class="enscript-comment">/* package containing core */</span>
    <span class="enscript-type">struct</span> x86_lcpu	*lcpus;		<span class="enscript-comment">/* list of logical cpus in core */</span>
    uint32_t		flags;
    uint32_t		lcore_num;	<span class="enscript-comment">/* logical core # (unique within die) */</span>
    uint32_t		pcore_num;	<span class="enscript-comment">/* physical core # (globally unique) */</span>
    uint32_t		num_lcpus;	<span class="enscript-comment">/* Number of logical cpus */</span>
    uint32_t		active_lcpus;	<span class="enscript-comment">/* Number of {running, idle} cpus */</span>
    <span class="enscript-type">void</span>		*pmStats;	<span class="enscript-comment">/* Power management stats for core */</span>
    <span class="enscript-type">void</span>		*pmState;	<span class="enscript-comment">/* Power management state for core */</span>
} x86_core_t;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">X86DIE_FL_PRESENT</span>	0x80000000	<span class="enscript-comment">/* die is present */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">X86DIE_FL_READY</span>		0x40000000	<span class="enscript-comment">/* die struct is init'd */</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> x86_die
{
    <span class="enscript-type">struct</span> x86_die	*next_in_pkg;	<span class="enscript-comment">/* next die in package */</span>
    <span class="enscript-type">struct</span> x86_lcpu	*lcpus;		<span class="enscript-comment">/* list of lcpus in die */</span>
    <span class="enscript-type">struct</span> x86_core	*cores;		<span class="enscript-comment">/* list of cores in die */</span>
    <span class="enscript-type">struct</span> x86_pkg	*package;	<span class="enscript-comment">/* package containing the die */</span>
    uint32_t		flags;
    uint32_t		ldie_num;	<span class="enscript-comment">/* logical die # (unique to package) */</span>
    uint32_t		pdie_num;	<span class="enscript-comment">/* physical die # (globally unique) */</span>
    uint32_t		num_cores;	<span class="enscript-comment">/* Number of cores in die */</span>
    x86_cpu_cache_t	*LLC;		<span class="enscript-comment">/* LLC contained in this die */</span>
    <span class="enscript-type">void</span>		*pmStats;	<span class="enscript-comment">/* Power Management stats for die */</span>
    <span class="enscript-type">void</span>		*pmState;	<span class="enscript-comment">/* Power Management state for die */</span>
} x86_die_t;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">X86PKG_FL_PRESENT</span>	0x80000000	<span class="enscript-comment">/* package is present */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">X86PKG_FL_READY</span>		0x40000000	<span class="enscript-comment">/* package struct init'd */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">X86PKG_FL_HAS_HPET</span>	0x10000000	<span class="enscript-comment">/* package has HPET assigned */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">X86PKG_FL_HALTED</span>	0x00008000	<span class="enscript-comment">/* package is halted */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">X86PKG_FL_IDLE</span>		0x00004000	<span class="enscript-comment">/* package is idle */</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> x86_pkg
{
    <span class="enscript-type">struct</span> x86_pkg	*next;		<span class="enscript-comment">/* next package */</span>
    <span class="enscript-type">struct</span> x86_lcpu	*lcpus;		<span class="enscript-comment">/* list of logical cpus in package */</span>
    <span class="enscript-type">struct</span> x86_core	*cores;		<span class="enscript-comment">/* list of cores in package */</span>
    <span class="enscript-type">struct</span> x86_die	*dies;		<span class="enscript-comment">/* list of dies in package */</span>
    uint32_t		flags;
    uint32_t		lpkg_num;	<span class="enscript-comment">/* logical package # */</span>
    uint32_t		ppkg_num;	<span class="enscript-comment">/* physical package # */</span>
    uint32_t		num_dies;	<span class="enscript-comment">/* number of dies in package */</span>
    <span class="enscript-type">void</span>		*pmStats;	<span class="enscript-comment">/* Power Management stats for package*/</span>
    <span class="enscript-type">void</span>		*pmState;	<span class="enscript-comment">/* Power Management state for package*/</span>
    <span class="enscript-type">struct</span> mca_state	*mca_state;	<span class="enscript-comment">/* MCA state for memory errors */</span>
    uint64_t		package_idle_exits;
    uint32_t		num_idle;
} x86_pkg_t;

<span class="enscript-type">extern</span> x86_pkg_t	*x86_pkgs;	<span class="enscript-comment">/* root of all CPU packages */</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> x86_topology_parameters
{
    uint32_t		LLCDepth;
    uint32_t		nCoresSharingLLC;
    uint32_t		nLCPUsSharingLLC;
    uint32_t		maxSharingLLC;
    uint32_t		nLThreadsPerCore;
    uint32_t		nPThreadsPerCore;
    uint32_t		nLCoresPerDie;
    uint32_t		nPCoresPerDie;
    uint32_t		nLDiesPerPackage;
    uint32_t		nPDiesPerPackage;
    uint32_t		nLThreadsPerDie;
    uint32_t		nPThreadsPerDie;
    uint32_t		nLThreadsPerPackage;
    uint32_t		nPThreadsPerPackage;
    uint32_t		nLCoresPerPackage;
    uint32_t		nPCoresPerPackage;
    uint32_t		nPackages;
    boolean_t		stable;
} x86_topology_parameters_t;

<span class="enscript-comment">/* Called after cpu discovery */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span>		cpu_topology_sort(<span class="enscript-type">int</span> ncpus);
<span class="enscript-type">extern</span> kern_return_t	cpu_topology_start_cpu(<span class="enscript-type">int</span> cpunum);


#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* _I386_CPU_TOPOLOGY_H_ */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* KERNEL_PRIVATE */</span>
</pre>
<hr />
</body></html>