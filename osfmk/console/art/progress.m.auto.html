<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>progress.m</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">progress.m&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
//
//cc progress.m -framework AppKit -Wall; ./a.out &gt;/tmp/xx.c; cc /tmp/xx.c -Wall; <span class="enscript-type">cat</span> /tmp/xx.c 

#import &lt;Foundation/Foundation.h&gt;
#import &lt;AppKit/AppKit.h&gt;
#import &lt;stdlib.h&gt;
#import &lt;stdint.h&gt;
#include &lt;getopt.h&gt;
#import &lt;string.h&gt;


#define MAX_COLORS 256

typedef struct {
    uint8_t r;
    uint8_t g;
    uint8_t b;
} pixel_t;

static uint32_t clut_size = 0;
static pixel_t clut<span class="enscript-type">[</span>MAX_COLORS<span class="enscript-type">]</span>;

static uint8_t 
lookup_color(uint8_t r, uint8_t g, uint8_t b)
{
    unsigned int <span class="enscript-type">i</span>;

    <span class="enscript-keyword">for</span> (<span class="enscript-type">i</span> = 0; <span class="enscript-type">i</span> &lt; clut_size; <span class="enscript-type">i</span>++) {
        <span class="enscript-keyword">if</span> (clut<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span>.r == r &amp;&amp;
            clut<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span>.g == g &amp;&amp;
            clut<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span>.b == b) {
          <span class="enscript-keyword">return</span> <span class="enscript-type">i</span>;
        }
    }
    <span class="enscript-keyword">if</span> (clut_size &gt;= MAX_COLORS) {
        printf(&quot;Image must have no <span class="enscript-type">more</span> than 256 <span class="enscript-type">unique</span> pixel colors\n&quot;);
        exit(1);
    }
    clut<span class="enscript-type">[</span>clut_size<span class="enscript-type">]</span>.r = r;
    clut<span class="enscript-type">[</span>clut_size<span class="enscript-type">]</span>.g = g;
    clut<span class="enscript-type">[</span>clut_size<span class="enscript-type">]</span>.b = b;
  
  <span class="enscript-keyword">return</span> (uint8_t)clut_size++;;
}

void print_buffer (uint8_t * buffer, size_t width, size_t height, size_t row)
{
  printf(&quot;{&quot;);
  <span class="enscript-keyword">for</span> (int y = 0; y &lt; height; y++)
  {
    printf(&quot;\n    &quot;);
    <span class="enscript-keyword">for</span> (int x = 0; x &lt; width; x++)
    {  
	printf(&quot;0x<span class="enscript-comment">%02x,&quot;, buffer[x + y*row]);
</span>    }
  }
  printf(&quot;\n}&quot;);
}

int onefile(const <span class="enscript-type">char</span> * filename, int w, int h)
{
    int       <span class="enscript-type">size</span>;
    uint8_t   color;
  
    FILE *file;
    <span class="enscript-keyword">if</span> ((file = <span class="enscript-type">fopen</span>(filename, &quot;r&quot;)) == NULL) {
        <span class="enscript-type">fclose</span>(file);
        printf (&quot;ERROR!!! can <span class="enscript-type">not</span> open resource file <span class="enscript-type">[</span><span class="enscript-comment">%s]\n&quot;, filename);
</span>        <span class="enscript-keyword">return</span> 1;
    }
    <span class="enscript-type">fclose</span>(file);
  
    NSString* filePath = <span class="enscript-type">[</span>NSString stringWithUTF8String:filename<span class="enscript-type">]</span>;
    NSData* fileData = <span class="enscript-type">[</span>NSData dataWithContentsOfFile:filePath<span class="enscript-type">]</span>;
    NSBitmapImageRep* bitmapImageRep = <span class="enscript-type">[</span><span class="enscript-type">[</span>NSBitmapImageRep alloc<span class="enscript-type">]</span> initWithData:fileData<span class="enscript-type">]</span>;
    NSSize imageSize = <span class="enscript-type">[</span>bitmapImageRep <span class="enscript-type">size</span><span class="enscript-type">]</span>;
  
    size_t image_length = (int)imageSize.width * (int)imageSize.height;
    uint8_t* uncompressed_color_buffer = malloc(image_length);
    uint8_t* uncompressed_alpha_buffer = malloc(image_length);

    bzero(clut, sizeof(clut));
  
    clut_size = 0;
    <span class="enscript-type">size</span> = 0;
  
    <span class="enscript-keyword">for</span> (int y = 0; y &lt; imageSize.height; y++) {
      <span class="enscript-keyword">for</span> (int x = 0; x &lt; imageSize.width; x++) {
        NSUInteger pixel<span class="enscript-type">[</span>4<span class="enscript-type">]</span> = {};
        <span class="enscript-type">[</span>bitmapImageRep getPixel:pixel atX:x y:y<span class="enscript-type">]</span>;

        color = lookup_color((uint8_t)pixel<span class="enscript-type">[</span>0<span class="enscript-type">]</span>,
                             (uint8_t)pixel<span class="enscript-type">[</span>1<span class="enscript-type">]</span>,
                             (uint8_t)pixel<span class="enscript-type">[</span>2<span class="enscript-type">]</span>);

	assert(color &lt;= 1);
	uint8_t alpha = pixel<span class="enscript-type">[</span>3<span class="enscript-type">]</span>;
	assert((alpha != 0) == color);

	alpha = 255 - alpha;
      
        uncompressed_color_buffer<span class="enscript-type">[</span><span class="enscript-type">size</span><span class="enscript-type">]</span> = color;
        uncompressed_alpha_buffer<span class="enscript-type">[</span><span class="enscript-type">size</span><span class="enscript-type">]</span> = alpha;
        <span class="enscript-type">size</span>++;
      }
    }

    assert(clut_size == 2);
    assert(clut<span class="enscript-type">[</span>0<span class="enscript-type">]</span>.r == 0);
    assert(clut<span class="enscript-type">[</span>0<span class="enscript-type">]</span>.g == 0);
    assert(clut<span class="enscript-type">[</span>0<span class="enscript-type">]</span>.b == 0);
    assert(clut<span class="enscript-type">[</span>1<span class="enscript-type">]</span>.r == 0xff);
    assert(clut<span class="enscript-type">[</span>1<span class="enscript-type">]</span>.g == 0xff);
    assert(clut<span class="enscript-type">[</span>1<span class="enscript-type">]</span>.b == 0xff);

    printf(&quot;\n&quot;);

    assert(w &lt;= imageSize.width);
    assert(h &lt;= imageSize.height);
 
    print_buffer (uncompressed_alpha_buffer, w, h, imageSize.width);
  
    <span class="enscript-keyword">if</span> (uncompressed_color_buffer != NULL) {
      free (uncompressed_color_buffer);
    }
    <span class="enscript-keyword">if</span> (uncompressed_alpha_buffer != NULL) {
      free (uncompressed_alpha_buffer);
    }
  
    <span class="enscript-keyword">return</span> 0;
}


int main (int argc, <span class="enscript-type">char</span> * argv<span class="enscript-type">[</span><span class="enscript-type">]</span>)
{
   printf(&quot;#include &lt;stdint.h&gt;\n\n&quot;);


   printf(&quot;\nstatic const unsigned <span class="enscript-type">char</span> progressmeter_leftcap1x<span class="enscript-type">[</span>2<span class="enscript-type">]</span><span class="enscript-type">[</span><span class="enscript-comment">%d * %d] = {&quot;, 9, 18);
</span>   onefile(&quot;ProgressBarFullLeftEndCap.png&quot;, 9, 18);
   printf(&quot;,&quot;);
   onefile(&quot;ProgressBarEmptyLeftEndCap.png&quot;, 9, 18);
   printf(&quot;};\n&quot;);

   printf(&quot;\nstatic const unsigned <span class="enscript-type">char</span> progressmeter_leftcap2x<span class="enscript-type">[</span>2<span class="enscript-type">]</span><span class="enscript-type">[</span>4 * <span class="enscript-comment">%d * %d] = {&quot;, 9, 18);
</span>   onefile(&quot;<a href="mailto:ProgressBarFullLeftEndCap@2x.png">ProgressBarFullLeftEndCap@2x.png</a>&quot;, 2*9, 2*18);
   printf(&quot;,&quot;);
   onefile(&quot;<a href="mailto:ProgressBarEmptyLeftEndCap@2x.png">ProgressBarEmptyLeftEndCap@2x.png</a>&quot;, 2*9, 2*18);
   printf(&quot;};\n&quot;);

   printf(&quot;\nstatic const unsigned <span class="enscript-type">char</span> progressmeter_middle1x<span class="enscript-type">[</span>2<span class="enscript-type">]</span><span class="enscript-type">[</span><span class="enscript-comment">%d * %d] = {&quot;, 1, 18);
</span>   onefile(&quot;ProgressBarFullMiddle.png&quot;, 1, 18);
   printf(&quot;,&quot;);
   onefile(&quot;ProgressBarEmptyMiddle.png&quot;, 1, 18);
   printf(&quot;};\n&quot;);

   printf(&quot;\nstatic const unsigned <span class="enscript-type">char</span> progressmeter_middle2x<span class="enscript-type">[</span>2<span class="enscript-type">]</span><span class="enscript-type">[</span>2 * <span class="enscript-comment">%d * %d] = {&quot;, 1, 18);
</span>   onefile(&quot;<a href="mailto:ProgressBarFullMiddle@2x.png">ProgressBarFullMiddle@2x.png</a>&quot;, 1, 2*18);
   printf(&quot;,&quot;);
   onefile(&quot;<a href="mailto:ProgressBarEmptyMiddle@2x.png">ProgressBarEmptyMiddle@2x.png</a>&quot;, 1, 2*18);
   printf(&quot;};\n&quot;);

   printf(&quot;\nstatic const unsigned <span class="enscript-type">char</span> progressmeter_rightcap1x<span class="enscript-type">[</span>2<span class="enscript-type">]</span><span class="enscript-type">[</span><span class="enscript-comment">%d * %d] = {&quot;, 9, 18);
</span>   onefile(&quot;ProgressBarFullRightEndCap.png&quot;, 9, 18);
   printf(&quot;,&quot;);
   onefile(&quot;ProgressBarEmptyRightEndCap.png&quot;, 9, 18);
   printf(&quot;};\n&quot;);

   printf(&quot;\nstatic const unsigned <span class="enscript-type">char</span> progressmeter_rightcap2x<span class="enscript-type">[</span>2<span class="enscript-type">]</span><span class="enscript-type">[</span>4 * <span class="enscript-comment">%d * %d] = {&quot;, 9, 18);
</span>   onefile(&quot;<a href="mailto:ProgressBarFullRightEndCap@2x.png">ProgressBarFullRightEndCap@2x.png</a>&quot;, 2*9, 2*18);
   printf(&quot;,&quot;);
   onefile(&quot;<a href="mailto:ProgressBarEmptyRightEndCap@2x.png">ProgressBarEmptyRightEndCap@2x.png</a>&quot;, 2*9, 2*18);
   printf(&quot;};\n&quot;);


}

</pre>
<hr />
</body></html>