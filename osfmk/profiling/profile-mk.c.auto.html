<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>profile-mk.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">profile-mk.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2000 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_OSREFERENCE_LICENSE_HEADER_START@
 * 
 * This file contains Original Code and/or Modifications of Original Code
 * as defined in and that are subject to the Apple Public Source License
 * Version 2.0 (the 'License'). You may not use this file except in
 * compliance with the License. The rights granted to you under the License
 * may not be used to create, or enable the creation or redistribution of,
 * unlawful or unlicensed copies of an Apple operating system, or to
 * circumvent, violate, or enable the circumvention or violation of, any
 * terms of an Apple operating system software license agreement.
 * 
 * Please obtain a copy of the License at
 * <a href="http://www.opensource.apple.com/apsl/">http://www.opensource.apple.com/apsl/</a> and read it before using this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
 * Please see the License for the specific language governing rights and
 * limitations under the License.
 * 
 * @APPLE_OSREFERENCE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/*
 * @OSF_COPYRIGHT@
 */</span>
<span class="enscript-comment">/*
 * Microkernel interface to common profiling.
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;profiling/profile-mk.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/cpu_number.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/processor.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/spl.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;kern/misc_protos.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;vm/vm_kern.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/vm_param.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;device/ds_routines.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;device/io_req.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;device/buf.h&gt;</span>

<span class="enscript-type">extern</span> <span class="enscript-type">char</span> etext[], pstart[];

<span class="enscript-type">void</span> *
<span class="enscript-function-name">_profile_alloc_pages</span> (size_t size)
{
	vm_offset_t addr;

	<span class="enscript-comment">/*
	 * For the MK, we can't support allocating pages at runtime, because we
	 * might be at interrupt level, so abort if we didn't size the table
	 * properly.
	 */</span>

	<span class="enscript-keyword">if</span> (PROFILE_VARS(0)-&gt;active) {
		panic(<span class="enscript-string">&quot;Call to _profile_alloc_pages while profiling is running.&quot;</span>);
	}

	<span class="enscript-keyword">if</span> (kmem_alloc(kernel_map, &amp;addr, size)) {
		panic(<span class="enscript-string">&quot;Could not allocate memory for profiling&quot;</span>);
	}

	memset((<span class="enscript-type">void</span> *)addr, <span class="enscript-string">'\0'</span>, size);
	<span class="enscript-keyword">if</span> (PROFILE_VARS(0)-&gt;debug) {
		printf(<span class="enscript-string">&quot;Allocated %d bytes for profiling, address 0x%x\n&quot;</span>, (<span class="enscript-type">int</span>)size, (<span class="enscript-type">int</span>)addr);
	}

	<span class="enscript-keyword">return</span>((caddr_t)addr);
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">_profile_free_pages</span>(<span class="enscript-type">void</span> *addr, size_t size)
{
	<span class="enscript-keyword">if</span> (PROFILE_VARS(0)-&gt;debug) {
		printf(<span class="enscript-string">&quot;Freed %d bytes for profiling, address 0x%x\n&quot;</span>, (<span class="enscript-type">int</span>)size, (<span class="enscript-type">int</span>)addr);
	}

	kmem_free(kernel_map, (vm_offset_t)addr, size);
	<span class="enscript-keyword">return</span>;
}

<span class="enscript-type">void</span> <span class="enscript-function-name">_profile_error</span>(<span class="enscript-type">struct</span> profile_vars *pv)
{
	panic(<span class="enscript-string">&quot;Fatal error in profiling&quot;</span>);
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">kmstartup</span>(<span class="enscript-type">void</span>)
{
	prof_uptrint_t textsize;
	prof_uptrint_t monsize;
	prof_uptrint_t lowpc;
	prof_uptrint_t highpc;
	<span class="enscript-type">struct</span> profile_vars *pv;

	<span class="enscript-comment">/*
	 * round lowpc and highpc to multiples of the density we're using
	 * so the rest of the scaling (here and in gprof) stays in ints.
	 */</span>

	lowpc = ROUNDDOWN((prof_uptrint_t)&amp;pstart[0], HISTFRACTION*<span class="enscript-keyword">sizeof</span>(LHISTCOUNTER));
	highpc = ROUNDUP((prof_uptrint_t)&amp;etext[0], HISTFRACTION*<span class="enscript-keyword">sizeof</span>(LHISTCOUNTER));
	textsize = highpc - lowpc;
	monsize = (textsize / HISTFRACTION) * <span class="enscript-keyword">sizeof</span>(LHISTCOUNTER);

	pv = PROFILE_VARS(0);

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">DEBUG_PROFILE</span>
	pv-&gt;debug = 1;
#<span class="enscript-reference">endif</span>
	pv-&gt;page_size = PAGE_SIZE;
	_profile_md_init(pv, PROFILE_GPROF, PROFILE_ALLOC_MEM_YES);

	<span class="enscript-comment">/* Profil related variables */</span>
	pv-&gt;profil_buf = _profile_alloc (pv, monsize, ACONTEXT_PROFIL);
	pv-&gt;profil_info.highpc = highpc;
	pv-&gt;profil_info.lowpc = lowpc;
	pv-&gt;profil_info.text_len = textsize;
	pv-&gt;profil_info.profil_len = monsize;
	pv-&gt;profil_info.counter_size = <span class="enscript-keyword">sizeof</span>(LHISTCOUNTER);
	pv-&gt;profil_info.scale = 0x10000 / HISTFRACTION;
	pv-&gt;stats.profil_buckets = monsize / <span class="enscript-keyword">sizeof</span>(LHISTCOUNTER);

	<span class="enscript-comment">/* Other gprof variables */</span>
	pv-&gt;stats.my_cpu = 0;
	pv-&gt;stats.max_cpu = 1;  <span class="enscript-comment">/* initial number of cpus */</span>
	pv-&gt;init = 1;
	pv-&gt;active = 1;
	pv-&gt;use_dci = 0;
	pv-&gt;use_profil = 1;
	pv-&gt;check_funcs = 1;		<span class="enscript-comment">/* for now */</span>

	<span class="enscript-keyword">if</span> (pv-&gt;debug) {
		printf(<span class="enscript-string">&quot;Profiling kernel, s_textsize=%ld, monsize=%ld [0x%lx..0x%lx], cpu = %d\n&quot;</span>,
			 (<span class="enscript-type">long</span>)textsize,
			(<span class="enscript-type">long</span>)monsize,
			(<span class="enscript-type">long</span>)lowpc,
			(<span class="enscript-type">long</span>)highpc,
			0);
	}

	_profile_md_start();
}

<span class="enscript-comment">/* driver component */</span>

<span class="enscript-type">int</span>
<span class="enscript-function-name">gprofprobe</span>(caddr_t port, <span class="enscript-type">void</span> *ctlr)
{
	<span class="enscript-keyword">return</span>(1);
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">gprofattach</span>(<span class="enscript-type">void</span>)
{
	kmstartup();
	<span class="enscript-keyword">return</span>;
}

<span class="enscript-comment">/* struct bus_device *gprofinfo[NGPROF]; */</span>
<span class="enscript-type">struct</span> bus_device *gprofinfo[1];

<span class="enscript-type">struct</span>	bus_driver	gprof_driver = {
	gprofprobe, 0, gprofattach, 0, 0, <span class="enscript-string">&quot;gprof&quot;</span>, gprofinfo, <span class="enscript-string">&quot;gprofc&quot;</span>, 0, 0};


io_return_t
<span class="enscript-function-name">gprofopen</span>(dev_t dev,
	  <span class="enscript-type">int</span> flags,
	  io_req_t ior)
{
	ior-&gt;io_error = D_SUCCESS;
	<span class="enscript-keyword">return</span>(0);
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">gprofclose</span>(dev_t dev)
{
	<span class="enscript-keyword">return</span>;
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">gprofstrategy</span>(io_req_t ior)
{
	<span class="enscript-type">void</span> *sys_ptr = (<span class="enscript-type">void</span> *)0;

	<span class="enscript-type">long</span> count = _profile_kgmon(!(ior-&gt;io_op &amp; IO_READ),
				    ior-&gt;io_count,
				    ior-&gt;io_recnum,
				    1,
				    &amp;sys_ptr,
				    (<span class="enscript-type">void</span> (*)(kgmon_control_t))0);

	<span class="enscript-keyword">if</span> (count &lt; 0) {
		ior-&gt;io_error = D_INVALID_RECNUM;

	} <span class="enscript-keyword">else</span> {
		<span class="enscript-keyword">if</span> (count &gt; 0 &amp;&amp; sys_ptr != (<span class="enscript-type">void</span> *)0) {
			<span class="enscript-keyword">if</span> (ior-&gt;io_op &amp; IO_READ) {
				memcpy((<span class="enscript-type">void</span> *)ior-&gt;io_data, sys_ptr, count);
			} <span class="enscript-keyword">else</span> {
				memcpy(sys_ptr, (<span class="enscript-type">void</span> *)ior-&gt;io_data, count);
			}
		}

		ior-&gt;io_error = D_SUCCESS;
		ior-&gt;io_residual = ior-&gt;io_count - count;
	}

	iodone(ior);
}

io_return_t
<span class="enscript-function-name">gprofread</span>(dev_t dev,
	  io_req_t ior)
{
	<span class="enscript-keyword">return</span>(block_io(gprofstrategy, minphys, ior));
}

io_return_t
<span class="enscript-function-name">gprofwrite</span>(dev_t dev,
	   io_req_t ior)
{
	<span class="enscript-keyword">return</span> (block_io(gprofstrategy, minphys, ior));
}
</pre>
<hr />
</body></html>