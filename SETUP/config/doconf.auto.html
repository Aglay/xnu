<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>doconf</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">doconf&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-reference">#!/bin/csh -f
</span><span class="enscript-keyword">set</span> <span class="enscript-builtin">path</span> = ($<span class="enscript-builtin">path</span> .)
<span class="enscript-comment">######################################################################
</span><span class="enscript-comment"># HISTORY
</span><span class="enscript-comment">#  1-Dec-87  Michael Young (mwyoung) at Carnegie-Mellon University
</span><span class="enscript-comment">#	Added &quot;-verbose&quot; switch, so this script produces no output
</span><span class="enscript-comment">#	in the normal case.
</span><span class="enscript-comment">#
</span><span class="enscript-comment"># 10-Oct-87  Mike Accetta (mja) at Carnegie-Mellon University
</span><span class="enscript-comment">#	Flushed cmu_*.h and spin_locks.h
</span><span class="enscript-comment">#	[ V5.1(XF18) ]
</span><span class="enscript-comment">#
</span><span class="enscript-comment">#  6-Apr-87  Avadis Tevanian (avie) at Carnegie-Mellon University
</span><span class="enscript-comment">#	Use MASTER.local and MASTER.&lt;machine&gt;.local for generation of
</span><span class="enscript-comment">#	configuration files in addition to MASTER and MASTER.&lt;machine&gt;.
</span><span class="enscript-comment">#
</span><span class="enscript-comment"># 25-Mar-87  Mike Accetta (mja) at Carnegie-Mellon University
</span><span class="enscript-comment">#	Removed use of obsolete wb_*.h files when building the feature
</span><span class="enscript-comment">#	list;  modified to save the previous configuration file and
</span><span class="enscript-comment">#	display the differences between it and the new file.
</span><span class="enscript-comment">#	[ V5.1(F8) ]
</span><span class="enscript-comment">#
</span><span class="enscript-comment"># 25-Mar-87  Avadis Tevanian (avie) at Carnegie-Mellon University
</span><span class="enscript-comment">#	If there is no /etc/machine just print out a message telling
</span><span class="enscript-comment">#	user to use the -cpu option.  I thought this script was supposed
</span><span class="enscript-comment">#	to work even without a /etc/machine, but it doesn't... and this
</span><span class="enscript-comment">#	is the easiest way out.
</span><span class="enscript-comment">#
</span><span class="enscript-comment"># 13-Mar-87  Mike Accetta (mja) at Carnegie-Mellon University
</span><span class="enscript-comment">#	Added &quot;romp_fpa.h&quot; file to extra features for the RT.
</span><span class="enscript-comment">#	[ V5.1(F7) ]
</span><span class="enscript-comment">#
</span><span class="enscript-comment"># 11-Mar-87  Mike Accetta (mja) at Carnegie-Mellon University
</span><span class="enscript-comment">#	Updated to maintain the appropriate configuration features file
</span><span class="enscript-comment">#	in the &quot;machine&quot; directory whenever the corresponding
</span><span class="enscript-comment">#	configuration is generated.  This replaces the old mechanism of
</span><span class="enscript-comment">#	storing this directly in the &lt;sys/features.h&gt; file since it was
</span><span class="enscript-comment">#	machine dependent and also precluded building programs for more
</span><span class="enscript-comment">#	than one configuration from the same set of sources.
</span><span class="enscript-comment">#	[ V5.1(F6) ]
</span><span class="enscript-comment">#
</span><span class="enscript-comment"># 21-Feb-87  Mike Accetta (mja) at Carnegie-Mellon University
</span><span class="enscript-comment">#	Fixed to require wired-in cpu type names for only those
</span><span class="enscript-comment">#	machines where the kernel name differs from that provided by
</span><span class="enscript-comment">#	/etc/machine (i.e. IBMRT =&gt; ca and SUN =&gt; sun3);  updated to
</span><span class="enscript-comment">#	permit configuration descriptions in both machine indepedent
</span><span class="enscript-comment">#	and dependent master configuration files so that attributes can
</span><span class="enscript-comment">#	be grouped accordingly.
</span><span class="enscript-comment">#	[ V5.1(F3) ]
</span><span class="enscript-comment">#
</span><span class="enscript-comment"># 17-Jan-87  Mike Accetta (mja) at Carnegie-Mellon University
</span><span class="enscript-comment">#	Updated to work from any directory at the same level as
</span><span class="enscript-comment">#	&quot;conf&quot;; generate configuration from both MASTER and
</span><span class="enscript-comment">#	MASTER.&lt;machine-type&gt; files; added -cpu switch.
</span><span class="enscript-comment">#	[ V5.1(F1) ]
</span><span class="enscript-comment">#
</span><span class="enscript-comment"># 18-Aug-86  Mike Accetta (mja) at Carnegie-Mellon University
</span><span class="enscript-comment">#	Added -make switch and changed meaning of -config;  upgraded to
</span><span class="enscript-comment">#	allow multiple attributes per configuration and to define
</span><span class="enscript-comment">#	configurations in terms of these attributes within MASTER.
</span><span class="enscript-comment">#
</span><span class="enscript-comment"># 14-Apr-83  Mike Accetta (mja) at Carnegie-Mellon University
</span><span class="enscript-comment">#	Added -config switch to only run /etc/config without 
</span><span class="enscript-comment">#	&quot;make depend&quot; and &quot;make&quot;.
</span><span class="enscript-comment">#
</span><span class="enscript-comment">######################################################################
</span>
<span class="enscript-keyword">set</span> prog=$0
<span class="enscript-keyword">set</span> prog=$prog<span class="enscript-keyword">:</span>t
<span class="enscript-keyword">set</span> <span class="enscript-builtin">nonomatch</span>
<span class="enscript-keyword">set</span> OBJDIR=../BUILD
<span class="enscript-keyword">set</span> SOURCEDIR=.
<span class="enscript-keyword">set</span> CONFIG_DIR=$OBJROOT/SETUP/config
<span class="enscript-keyword">set</span> MASTER_CONF_DIR=.

<span class="enscript-keyword">unset</span> doconfig
<span class="enscript-keyword">unset</span> beverbose
<span class="enscript-keyword">unset</span> MACHINE
<span class="enscript-keyword">unset</span> profile
<span class="enscript-keyword">unset</span> SOC_CONFIG

<span class="enscript-keyword">while</span> ($<span class="enscript-comment">#argv &gt;= 1)
</span>    <span class="enscript-keyword">if</span> (<span class="enscript-string">&quot;$argv[1]&quot;</span> =~ -*) <span class="enscript-keyword">then</span>
        <span class="enscript-keyword">switch</span> (<span class="enscript-string">&quot;$argv[1]&quot;</span>)
	<span class="enscript-keyword">case</span> <span class="enscript-string">&quot;-c&quot;</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">&quot;-config&quot;</span>:
	    <span class="enscript-keyword">set</span> doconfig
	    <span class="enscript-keyword">breaksw</span>
	<span class="enscript-keyword">case</span> <span class="enscript-string">&quot;-cpu&quot;</span>:
	    <span class="enscript-keyword">if</span> ($<span class="enscript-comment">#argv &lt; 2) then
</span>		<span class="enscript-keyword">echo</span> <span class="enscript-string">&quot;${prog}: missing argument to ${argv[1]}&quot;</span>
		<span class="enscript-keyword">exit</span> 1
	    <span class="enscript-keyword">endif</span>
	    <span class="enscript-keyword">set</span> MACHINE=<span class="enscript-string">&quot;$argv[2]&quot;</span>
	    <span class="enscript-keyword">shift</span>
	    <span class="enscript-keyword">breaksw</span>
	<span class="enscript-keyword">case</span> <span class="enscript-string">&quot;-soc&quot;</span>:
	    <span class="enscript-keyword">if</span> ($<span class="enscript-comment">#argv &lt; 2) then
</span>		<span class="enscript-keyword">echo</span> <span class="enscript-string">&quot;${prog}: missing argument to ${argv[1]}&quot;</span>
		<span class="enscript-keyword">exit</span> 1
	    <span class="enscript-keyword">endif</span>
	    <span class="enscript-keyword">set</span> SOC_CONFIG=<span class="enscript-string">&quot;$argv[2]&quot;</span>
	    <span class="enscript-keyword">shift</span>
	    <span class="enscript-keyword">breaksw</span>
	<span class="enscript-keyword">case</span> <span class="enscript-string">&quot;-d&quot;</span>:
	    <span class="enscript-keyword">if</span> ($<span class="enscript-comment">#argv &lt; 2) then
</span>		<span class="enscript-keyword">echo</span> <span class="enscript-string">&quot;${prog}: missing argument to ${argv[1]}&quot;</span>
		<span class="enscript-keyword">exit</span> 1
	    <span class="enscript-keyword">endif</span>
	    <span class="enscript-keyword">set</span> OBJDIR=<span class="enscript-string">&quot;$argv[2]&quot;</span>
	    <span class="enscript-keyword">shift</span>
	    <span class="enscript-keyword">breaksw</span>
	<span class="enscript-keyword">case</span> <span class="enscript-string">&quot;-m&quot;</span>:
	    <span class="enscript-keyword">if</span> ($<span class="enscript-comment">#argv &lt; 2) then
</span>		<span class="enscript-keyword">echo</span> <span class="enscript-string">&quot;${prog}: missing argument to ${argv[1]}&quot;</span>
		<span class="enscript-keyword">exit</span> 1
	    <span class="enscript-keyword">endif</span>
	    <span class="enscript-keyword">set</span> MASTER_CONF_DIR=<span class="enscript-string">&quot;$argv[2]&quot;</span>
	    <span class="enscript-keyword">shift</span>
	    <span class="enscript-keyword">breaksw</span>
	<span class="enscript-keyword">case</span> <span class="enscript-string">&quot;-s&quot;</span>:
	    <span class="enscript-keyword">if</span> ($<span class="enscript-comment">#argv &lt; 2) then
</span>		<span class="enscript-keyword">echo</span> <span class="enscript-string">&quot;${prog}: missing argument to ${argv[1]}&quot;</span>
		<span class="enscript-keyword">exit</span> 1
	    <span class="enscript-keyword">endif</span>
	    <span class="enscript-keyword">set</span> SOURCEDIR=<span class="enscript-string">&quot;$argv[2]&quot;</span>
	    <span class="enscript-keyword">shift</span>
	    <span class="enscript-keyword">breaksw</span>
	<span class="enscript-keyword">case</span> <span class="enscript-string">&quot;-verbose&quot;</span>:
	    <span class="enscript-keyword">set</span> beverbose
	    <span class="enscript-keyword">breaksw</span>
	<span class="enscript-keyword">case</span> <span class="enscript-string">&quot;-p&quot;</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">&quot;-profile&quot;</span>:
	    <span class="enscript-keyword">set</span> profile
	    <span class="enscript-keyword">breaksw</span>
	<span class="enscript-keyword">default</span>:
	    <span class="enscript-keyword">echo</span> <span class="enscript-string">&quot;${prog}: ${argv[1]}: unknown switch&quot;</span>
	    <span class="enscript-keyword">exit</span> 1
	    <span class="enscript-keyword">breaksw</span>
	<span class="enscript-keyword">endsw</span>
	<span class="enscript-keyword">shift</span>
    <span class="enscript-keyword">else</span>
	<span class="enscript-keyword">break</span>
    <span class="enscript-keyword">endif</span>
<span class="enscript-keyword">end</span>

<span class="enscript-keyword">if</span> ($<span class="enscript-comment">#argv == 0) set argv=(GENERIC)
</span>
<span class="enscript-keyword">if</span> (! $?MACHINE) <span class="enscript-keyword">then</span>
    <span class="enscript-keyword">echo</span> <span class="enscript-string">&quot;${prog}: MACHINE not set&quot;</span>
    <span class="enscript-keyword">exit</span> 1
<span class="enscript-keyword">endif</span>

<span class="enscript-keyword">set</span> cpu=`<span class="enscript-keyword">echo</span> $MACHINE | tr A-Z a-z`
<span class="enscript-keyword">set</span> ID=`<span class="enscript-keyword">echo</span> $MACHINE | tr a-z A-Z`
<span class="enscript-keyword">set</span> MASTER_DIR=${MASTER_CONF_DIR}
<span class="enscript-keyword">set</span> MASTER =   ${MASTER_DIR}/MASTER
<span class="enscript-keyword">set</span> MASTER_CPU=${MASTER}.${cpu}
<span class="enscript-keyword">set</span> MASTER_CPU_PER_SOC=${MASTER}.${cpu}.${SOC_CONFIG}
<span class="enscript-keyword">if</span> (-f $MASTER_CPU_PER_SOC) <span class="enscript-keyword">set</span> MASTER_CPU = ${MASTER_CPU_PER_SOC}

<span class="enscript-keyword">foreach</span> SYS ($<span class="enscript-builtin">argv</span>)
    <span class="enscript-keyword">set</span> SYSID=${SYS}_${ID}
    <span class="enscript-keyword">set</span> SYSCONF=$OBJDIR/config.$SYSID
    <span class="enscript-keyword">set</span> BLDDIR=$OBJDIR
    <span class="enscript-keyword">if</span> ($?beverbose) <span class="enscript-keyword">then</span>
	<span class="enscript-keyword">echo</span> <span class="enscript-string">&quot;[ generating $SYSID from $MASTER_DIR/MASTER{,.$cpu}{,.local} ]&quot;</span>
    <span class="enscript-keyword">endif</span>
    <span class="enscript-keyword">echo</span> +$SYS \
    | \
    cat $MASTER $MASTER_CPU - \
        $MASTER $MASTER_CPU \
    | \
    sed -n \
	-e <span class="enscript-string">&quot;/^+/{&quot;</span> \
	   -e <span class="enscript-string">&quot;s;[-+];#&amp;;gp&quot;</span> \
	      -e 't loop' \
	   -e ': loop' \
           -e 'n' \
	   -e '/^<span class="enscript-comment">#/b loop' \
</span>	   -e '/^$/b loop' \
	   -e 's;^\([^<span class="enscript-comment">#]*\).*#[ 	]*&lt;\(.*\)&gt;[ 	]*$;\2#\1;' \
</span>	      -e 't not' \
	   -e 's;\([^<span class="enscript-comment">#]*\).*;#\1;' \
</span>	      -e 't not' \
	   -e ': not' \
	   -e 's;[ 	]*$;;' \
	   -e 's;^\!\(.*\);\1<span class="enscript-comment">#\!;' \
</span>	   -e 'p' \
	      -e 't loop' \
           -e 'b loop' \
	-e '}' \
	-e <span class="enscript-string">&quot;/^[^#]/d&quot;</span> \
	-e 's;	; ;g' \
	-e <span class="enscript-string">&quot;s;^# *\([^ ]*\)[ ]*=[ ]*\[\(.*\)\].*;\1#\2;p&quot;</span> \
    | \
    awk '-F<span class="enscript-comment">#' '\
</span>part == 0 &amp;&amp; $1 != <span class="enscript-string">&quot;&quot;</span> {\
	m[$1]=m[$1] <span class="enscript-string">&quot; &quot;</span> $2;\
	next;\
}\
part == 0 &amp;&amp; $1 == <span class="enscript-string">&quot;&quot;</span> {\
	for (i=NF;i&gt;1;i--){\
		s=substr($i,2);\
		c[++na]=substr($i,1,1);\
		a[na]=s;\
	}\
	<span class="enscript-keyword">while</span> (na &gt; 0){\
		s=a[na];\
		d=c[na--];\
		<span class="enscript-keyword">if</span> (m[s] == <span class="enscript-string">&quot;&quot;</span>) {\
			f[s]=d;\
		} <span class="enscript-keyword">else</span> {\
			nx=split(m[s],x,<span class="enscript-string">&quot; &quot;</span>);\
			for (j=nx;j&gt;0;j--) {\
				z=x[j];\
				a[++na]=z;\
				c[na]=d;\
			}\
		}\
	}\
	part=1;\
	next;\
}\
part != 0 {\
	<span class="enscript-keyword">if</span> ($1 != <span class="enscript-string">&quot;&quot;</span>) {\
		n=split($1,x,<span class="enscript-string">&quot;,&quot;</span>);\
		ok=0;\
		for (i=1;i&lt;=n;i++) {\
			<span class="enscript-keyword">if</span> (f[x[i]] == <span class="enscript-string">&quot;+&quot;</span>) {\
				ok=1;\
			}\
		}\
		<span class="enscript-keyword">if</span> (NF &gt; 2 &amp;&amp; ok == 0 || NF &lt;= 2 &amp;&amp; ok != 0) {\
			print $2; \
		}\
	} <span class="enscript-keyword">else</span> { \
		print $2; \
	}\
}\
' &gt;$SYSCONF.new
    <span class="enscript-keyword">if</span> (-z $SYSCONF.new) <span class="enscript-keyword">then</span>
	<span class="enscript-keyword">echo</span> <span class="enscript-string">&quot;${prog}: ${$SYSID}: no such configuration in $MASTER_DIR/MASTER{,.$cpu}&quot;</span>
	rm -f $SYSCONF.new
    <span class="enscript-keyword">endif</span>
<span class="enscript-comment">#
</span><span class="enscript-comment"># These paths are used by config.
</span><span class="enscript-comment">#
</span><span class="enscript-comment"># &quot;builddir&quot; is the name of the directory where kernel binaries
</span><span class="enscript-comment"># are put.  It is a single path element, never absolute, and is
</span><span class="enscript-comment"># always relative to &quot;objectdir&quot;.  &quot;builddir&quot; is used by config
</span><span class="enscript-comment"># solely to determine where to put files created by &quot;config&quot; (e.g.
</span><span class="enscript-comment"># the created Makefile and *.h's.)
</span><span class="enscript-comment">#
</span><span class="enscript-comment"># &quot;objectdir&quot; is the name of the directory which will hold &quot;builddir&quot;.
</span><span class="enscript-comment"># It is a path; if relative, it is relative to the current directory
</span><span class="enscript-comment"># where config is run.  It's sole use is to be prepended to &quot;builddir&quot;
</span><span class="enscript-comment"># to indicate where config-created files are to be placed (see above).
</span><span class="enscript-comment">#
</span><span class="enscript-comment"># &quot;sourcedir&quot; is the location of the sources used to build the kernel.
</span><span class="enscript-comment"># It is a path; if relative, it is relative to the directory specified
</span><span class="enscript-comment"># by the concatenation of &quot;objectdir&quot; and &quot;builddir&quot; (i.e. where the
</span><span class="enscript-comment"># kernel binaries are put).
</span><span class="enscript-comment">#
</span>    <span class="enscript-keyword">echo</span> 'builddir	<span class="enscript-string">&quot;.&quot;</span>'			&gt;&gt; $SYSCONF.new
    <span class="enscript-keyword">echo</span> 'objectdir	<span class="enscript-string">&quot;'$OBJDIR'&quot;</span>'		&gt;&gt; $SYSCONF.new
    <span class="enscript-keyword">set</span> SRCDIR=`dirname $SOURCE`
    <span class="enscript-keyword">echo</span> 'sourcedir	<span class="enscript-string">&quot;'$SRCROOT'&quot;</span>'		&gt;&gt; $SYSCONF.new
    <span class="enscript-keyword">if</span> (-f $SYSCONF) <span class="enscript-keyword">then</span>
	diff $SYSCONF $SYSCONF.new
	rm -f $SYSCONF.old
	mv $SYSCONF $SYSCONF.old
    <span class="enscript-keyword">endif</span>
    rm -f $SYSCONF
    mv $SYSCONF.new $SYSCONF
    <span class="enscript-keyword">if</span> ($?doconfig) <span class="enscript-keyword">then</span>
        <span class="enscript-keyword">if</span> ($?beverbose) <span class="enscript-keyword">then</span>
	    <span class="enscript-keyword">echo</span> <span class="enscript-string">&quot;[ configuring $SYSID ]&quot;</span>
        <span class="enscript-keyword">endif</span>
	<span class="enscript-keyword">if</span> ($?profile) <span class="enscript-keyword">then</span>
	    $CONFIG_DIR/config -c $SOURCEDIR -p $SYSCONF
	<span class="enscript-keyword">else</span>
	    $CONFIG_DIR/config -c $SOURCEDIR $SYSCONF
	<span class="enscript-keyword">endif</span>
    <span class="enscript-keyword">endif</span>
<span class="enscript-keyword">end</span>
</pre>
<hr />
</body></html>