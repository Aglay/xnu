<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>main.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">main.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 1999-2009 Apple Inc. All rights reserved.
 *
 * @APPLE_LICENSE_HEADER_START@
 * 
 * &quot;Portions Copyright (c) 1999 Apple Computer, Inc.  All Rights
 * Reserved.  This file contains Original Code and/or Modifications of
 * Original Code as defined in and that are subject to the Apple Public
 * Source License Version 1.0 (the 'License').  You may not use this file
 * except in compliance with the License.  Please obtain a copy of the
 * License at <a href="http://www.apple.com/publicsource">http://www.apple.com/publicsource</a> and read it before using
 * this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE OR NON-INFRINGEMENT.  Please see the
 * License for the specific language governing rights and limitations
 * under the License.&quot;
 * 
 * @APPLE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/* 
 * Mach Operating System
 * Copyright (c) 1990 Carnegie-Mellon University
 * Copyright (c) 1989 Carnegie-Mellon University
 * Copyright (c) 1988 Carnegie-Mellon University
 * Copyright (c) 1987 Carnegie-Mellon University
 * All rights reserved.  The CMU software License Agreement specifies
 * the terms and conditions for use and redistribution.
 */</span>

<span class="enscript-comment">/*
 * Copyright (c) 1980 Regents of the University of California.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms are permitted
 * provided that the above copyright notice and this paragraph are
 * duplicated in all such forms and that any documentation,
 * advertising materials, and other materials related to such
 * distribution and use acknowledge that the software was developed
 * by the University of California, Berkeley.  The name of the
 * University may not be used to endorse or promote products derived
 * from this software without specific prior written permission.
 * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED
 * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">lint</span>
<span class="enscript-type">char</span> copyright[] =
<span class="enscript-string">&quot;@(#) Copyright (c) 1980 Regents of the University of California.\n\
 All rights reserved.\n&quot;</span>;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* not lint */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">lint</span>
<span class="enscript-type">static</span> <span class="enscript-type">char</span> sccsid[] __attribute__((used)) = <span class="enscript-string">&quot;@(#)main.c	5.9 (Berkeley) 6/18/88&quot;</span>;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* not lint */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdio.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;ctype.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;parser.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;config.h&quot;</span>

<span class="enscript-comment">/*
 * Config builds a set of files for building a UNIX
 * system given a description of the desired system.
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">main</span>(<span class="enscript-type">int</span> argc, <span class="enscript-type">char</span> *argv[])
{

	source_directory = <span class="enscript-string">&quot;..&quot;</span>;	<span class="enscript-comment">/* default */</span>
	object_directory = <span class="enscript-string">&quot;..&quot;</span>;
	config_directory = (<span class="enscript-type">char</span> *) 0;
	<span class="enscript-keyword">while</span> ((argc &gt; 1) &amp;&amp; (argv[1][0] == <span class="enscript-string">'-'</span>)) {
		<span class="enscript-type">char</span>		*c;

		argv++; argc--;
		<span class="enscript-keyword">for</span> (c = &amp;argv[0][1]; *c ; c++) {
			<span class="enscript-keyword">switch</span> (*c) {
				<span class="enscript-keyword">case</span> <span class="enscript-string">'b'</span>:
					build_directory = argv[1];
					<span class="enscript-keyword">goto</span> <span class="enscript-reference">check_arg</span>;

				<span class="enscript-keyword">case</span> <span class="enscript-string">'d'</span>:
					source_directory = argv[1];
					<span class="enscript-keyword">goto</span> <span class="enscript-reference">check_arg</span>;

				<span class="enscript-keyword">case</span> <span class="enscript-string">'o'</span>:
					object_directory = argv[1];
					<span class="enscript-keyword">goto</span> <span class="enscript-reference">check_arg</span>;

				<span class="enscript-keyword">case</span> <span class="enscript-string">'c'</span>:
					config_directory = argv[1];

				 <span class="enscript-reference">check_arg</span>:
				 	<span class="enscript-keyword">if</span> (argv[1] == (<span class="enscript-type">char</span> *) 0)
						<span class="enscript-keyword">goto</span> <span class="enscript-reference">usage_error</span>;
					argv++; argc--;
					<span class="enscript-keyword">break</span>;

				<span class="enscript-keyword">case</span> <span class="enscript-string">'p'</span>:
					profiling++;
					<span class="enscript-keyword">break</span>;
				<span class="enscript-reference">default</span>:
					<span class="enscript-keyword">goto</span> <span class="enscript-reference">usage_error</span>;
			}
		}
	}
	<span class="enscript-keyword">if</span> (config_directory == (<span class="enscript-type">char</span> *) 0) {
		config_directory =
			malloc((<span class="enscript-type">unsigned</span>) strlen(source_directory) + 6);
		(<span class="enscript-type">void</span>) sprintf(config_directory, <span class="enscript-string">&quot;%s/conf&quot;</span>, source_directory);
	}
	<span class="enscript-keyword">if</span> (argc != 2) {
		<span class="enscript-reference">usage_error</span>: ;
		fprintf(stderr, <span class="enscript-string">&quot;usage: config [ -bcdo dir ] [ -p ] sysname\n&quot;</span>);
		exit(1);
	}
	<span class="enscript-keyword">if</span> (!build_directory)
		build_directory = argv[1];
	<span class="enscript-keyword">if</span> (freopen(argv[1], <span class="enscript-string">&quot;r&quot;</span>, stdin) == NULL) {
		perror(argv[1]);
		exit(2);
	}
	dtab = NULL;
	confp = &amp;conf_list;
	opt = 0;
	<span class="enscript-keyword">if</span> (yyparse())
		exit(3);

	mkioconf();			<span class="enscript-comment">/* ioconf.c */</span>
	makefile();			<span class="enscript-comment">/* build Makefile */</span>
	headers();			<span class="enscript-comment">/* make a lot of .h files */</span>

	<span class="enscript-keyword">return</span> 0;
}

<span class="enscript-comment">/*
 * get_word
 *	returns EOF on end of file
 *	NULL on end of line
 *	pointer to the word otherwise
 */</span>
<span class="enscript-type">const</span> <span class="enscript-type">char</span> *
<span class="enscript-function-name">get_word</span>(FILE *fp)
{
	<span class="enscript-type">static</span> <span class="enscript-type">char</span> line[80];
	<span class="enscript-type">register</span> <span class="enscript-type">int</span> ch;
	<span class="enscript-type">register</span> <span class="enscript-type">char</span> *cp;

	<span class="enscript-keyword">while</span> ((ch = getc(fp)) != EOF)
		<span class="enscript-keyword">if</span> (ch != <span class="enscript-string">' '</span> &amp;&amp; ch != <span class="enscript-string">'\t'</span>)
			<span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">if</span> (ch == EOF)
		<span class="enscript-keyword">return</span> ((<span class="enscript-type">char</span> *)EOF);
	<span class="enscript-keyword">if</span> (ch == <span class="enscript-string">'\n'</span>)
		<span class="enscript-keyword">return</span> (NULL);
	<span class="enscript-keyword">if</span> (ch == <span class="enscript-string">'|'</span>)
		<span class="enscript-keyword">return</span>( <span class="enscript-string">&quot;|&quot;</span>);
	cp = line;
	*cp++ = ch;
	<span class="enscript-keyword">while</span> ((ch = getc(fp)) != EOF) {
		<span class="enscript-keyword">if</span> (isspace(ch))
			<span class="enscript-keyword">break</span>;
		*cp++ = ch;
	}
	*cp = 0;
	<span class="enscript-keyword">if</span> (ch == EOF)
		<span class="enscript-keyword">return</span> ((<span class="enscript-type">char</span> *)EOF);
	(<span class="enscript-type">void</span>) ungetc(ch, fp);
	<span class="enscript-keyword">return</span> (line);
}

<span class="enscript-comment">/*
 * get_rest
 *	returns EOF on end of file
 *	NULL on end of line
 *	pointer to the word otherwise
 */</span>
<span class="enscript-type">char</span> *
<span class="enscript-function-name">get_rest</span>(FILE *fp)
{
	<span class="enscript-type">static</span> <span class="enscript-type">char</span> line[80];
	<span class="enscript-type">register</span> <span class="enscript-type">int</span> ch;
	<span class="enscript-type">register</span> <span class="enscript-type">char</span> *cp;

	cp = line;
	<span class="enscript-keyword">while</span> ((ch = getc(fp)) != EOF) {
		<span class="enscript-keyword">if</span> (ch == <span class="enscript-string">'\n'</span>)
			<span class="enscript-keyword">break</span>;
		*cp++ = ch;
	}
	*cp = 0;
	<span class="enscript-keyword">if</span> (ch == EOF)
		<span class="enscript-keyword">return</span> ((<span class="enscript-type">char</span> *)EOF);
	<span class="enscript-keyword">return</span> (line);
}

<span class="enscript-comment">/*
 * prepend the path to a filename
 */</span>
<span class="enscript-type">char</span> *
<span class="enscript-function-name">path</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *file)
{
	<span class="enscript-type">register</span> <span class="enscript-type">char</span> *cp;

	cp = malloc((<span class="enscript-type">unsigned</span>)(strlen(build_directory)+
			       strlen(file)+
			       strlen(object_directory)+
			       3));
	(<span class="enscript-type">void</span>) sprintf(cp, <span class="enscript-string">&quot;%s/%s/%s&quot;</span>, object_directory, build_directory, file);
	<span class="enscript-keyword">return</span> (cp);
}
</pre>
<hr />
</body></html>