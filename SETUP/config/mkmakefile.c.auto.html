<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>mkmakefile.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">mkmakefile.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 1999 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_LICENSE_HEADER_START@
 * 
 * &quot;Portions Copyright (c) 1999 Apple Computer, Inc.  All Rights
 * Reserved.  This file contains Original Code and/or Modifications of
 * Original Code as defined in and that are subject to the Apple Public
 * Source License Version 1.0 (the 'License').  You may not use this file
 * except in compliance with the License.  Please obtain a copy of the
 * License at <a href="http://www.apple.com/publicsource">http://www.apple.com/publicsource</a> and read it before using
 * this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE OR NON-INFRINGEMENT.  Please see the
 * License for the specific language governing rights and limitations
 * under the License.&quot;
 * 
 * @APPLE_LICENSE_HEADER_END@
 */</span>
<span class="enscript-comment">/* 
 * Mach Operating System
 * Copyright (c) 1990 Carnegie-Mellon University
 * Copyright (c) 1989 Carnegie-Mellon University
 * Copyright (c) 1988 Carnegie-Mellon University
 * Copyright (c) 1987 Carnegie-Mellon University
 * All rights reserved.  The CMU software License Agreement specifies
 * the terms and conditions for use and redistribution.
 */</span>

<span class="enscript-comment">/*
 * Copyright (c) 1980 Regents of the University of California.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms are permitted
 * provided that the above copyright notice and this paragraph are
 * duplicated in all such forms and that any documentation,
 * advertising materials, and other materials related to such
 * distribution and use acknowledge that the software was developed
 * by the University of California, Berkeley.  The name of the
 * University may not be used to endorse or promote products derived
 * from this software without specific prior written permission.
 * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED
 * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">lint</span>
<span class="enscript-type">static</span> <span class="enscript-type">char</span> sccsid[] __attribute__((used)) = <span class="enscript-string">&quot;@(#)mkmakefile.c	5.21 (Berkeley) 6/18/88&quot;</span>;
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* not lint */</span>

<span class="enscript-comment">/*
 * Build the makefile for the system, from
 * the information in the files files and the
 * additional files for the machine being compiled to.
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdio.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;unistd.h&gt;</span>	<span class="enscript-comment">/* for unlink */</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;ctype.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;parser.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;config.h&quot;</span>

<span class="enscript-type">void</span>	read_files(<span class="enscript-type">void</span>);
<span class="enscript-type">void</span>	do_objs(FILE *fp, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *msg, <span class="enscript-type">int</span> ext);
<span class="enscript-type">void</span>	do_files(FILE *fp, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *msg, <span class="enscript-type">char</span> ext);
<span class="enscript-type">void</span>	do_machdep(FILE *ofp);
<span class="enscript-type">void</span>	do_rules(FILE *f);
<span class="enscript-type">void</span>	copy_dependencies(FILE *makin, FILE *makout);

<span class="enscript-type">struct</span> file_list *<span class="enscript-function-name">fl_lookup</span>(<span class="enscript-type">char</span> *file);
<span class="enscript-type">struct</span> file_list *<span class="enscript-function-name">fltail_lookup</span>(<span class="enscript-type">char</span> *file);
<span class="enscript-type">struct</span> file_list *<span class="enscript-function-name">new_fent</span>(<span class="enscript-type">void</span>);

<span class="enscript-type">void</span>	put_source_file_name(FILE *fp, <span class="enscript-type">struct</span> file_list *tp);


#<span class="enscript-reference">define</span> <span class="enscript-function-name">next_word</span>(fp, wd) \
	{ <span class="enscript-type">register</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> *word = get_word(fp); \
	  <span class="enscript-keyword">if</span> (word == (<span class="enscript-type">char</span> *)EOF) \
		<span class="enscript-keyword">return</span>; \
	  <span class="enscript-keyword">else</span> \
		wd = word; \
	}

<span class="enscript-type">static</span>	<span class="enscript-type">struct</span> file_list *fcur;
<span class="enscript-type">const</span> <span class="enscript-type">char</span> *<span class="enscript-function-name">tail</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *fn);
<span class="enscript-type">char</span> *<span class="enscript-function-name">allCaps</span>(<span class="enscript-type">char</span> *str);

<span class="enscript-comment">/*
 * Lookup a file, by name.
 */</span>
<span class="enscript-type">struct</span> file_list *
<span class="enscript-function-name">fl_lookup</span>(<span class="enscript-type">char</span> *file)
{
	<span class="enscript-type">register</span> <span class="enscript-type">struct</span> file_list *fp;

	<span class="enscript-keyword">for</span> (fp = ftab ; fp != 0; fp = fp-&gt;f_next) {
		<span class="enscript-keyword">if</span> (eq(fp-&gt;f_fn, file))
			<span class="enscript-keyword">return</span> (fp);
	}
	<span class="enscript-keyword">return</span> (0);
}

<span class="enscript-comment">/*
 * Lookup a file, by final component name.
 */</span>
<span class="enscript-type">struct</span> file_list *
<span class="enscript-function-name">fltail_lookup</span>(<span class="enscript-type">char</span> *file)
{
	<span class="enscript-type">register</span> <span class="enscript-type">struct</span> file_list *fp;

	<span class="enscript-keyword">for</span> (fp = ftab ; fp != 0; fp = fp-&gt;f_next) {
		<span class="enscript-keyword">if</span> (eq(tail(fp-&gt;f_fn), tail(file)))
			<span class="enscript-keyword">return</span> (fp);
	}
	<span class="enscript-keyword">return</span> (0);
}

<span class="enscript-comment">/*
 * Make a new file list entry
 */</span>
<span class="enscript-type">struct</span> file_list *
<span class="enscript-function-name">new_fent</span>(<span class="enscript-type">void</span>)
{
	<span class="enscript-type">register</span> <span class="enscript-type">struct</span> file_list *fp;

	fp = (<span class="enscript-type">struct</span> file_list *) malloc(<span class="enscript-keyword">sizeof</span> *fp);
	fp-&gt;f_needs = 0;
	fp-&gt;f_next = 0;
	fp-&gt;f_flags = 0;
	fp-&gt;f_type = 0;
	fp-&gt;f_extra = (<span class="enscript-type">char</span> *) 0;
	<span class="enscript-keyword">if</span> (fcur == 0)
		fcur = ftab = fp;
	<span class="enscript-keyword">else</span>
		fcur-&gt;f_next = fp;
	fcur = fp;
	<span class="enscript-keyword">return</span> (fp);
}

<span class="enscript-type">char</span>	*COPTS;

<span class="enscript-type">const</span> <span class="enscript-type">char</span> *
<span class="enscript-function-name">get_VPATH</span>(<span class="enscript-type">void</span>)
{
    <span class="enscript-type">static</span> <span class="enscript-type">char</span> *vpath = NULL;

    <span class="enscript-keyword">if</span> ((vpath == NULL) &amp;&amp;
	((vpath = getenv(<span class="enscript-string">&quot;VPATH&quot;</span>)) != NULL) &amp;&amp;
	(*vpath != <span class="enscript-string">':'</span>)) {
	<span class="enscript-type">register</span> <span class="enscript-type">char</span> *buf = malloc((<span class="enscript-type">unsigned</span>)(strlen(vpath) + 2));

	vpath = strcat(strcpy(buf, <span class="enscript-string">&quot;:&quot;</span>), vpath);
    }

    <span class="enscript-keyword">return</span> vpath ? vpath : <span class="enscript-string">&quot;&quot;</span>;
}


<span class="enscript-comment">/*
 * Build the makefile from the skeleton
 */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">makefile</span>(<span class="enscript-type">void</span>)
{
	FILE *ifp, *ofp;
	FILE *dfp;
	<span class="enscript-type">char</span> pname[BUFSIZ];
	<span class="enscript-type">char</span> line[BUFSIZ];
	<span class="enscript-type">struct</span> opt *op;

	read_files();
	(<span class="enscript-type">void</span>) sprintf(line, <span class="enscript-string">&quot;%s/Makefile.template&quot;</span>, config_directory);
	ifp = fopenp(VPATH, line, pname, <span class="enscript-string">&quot;r&quot;</span>);
	<span class="enscript-keyword">if</span> (ifp == 0) {
		perror(line);
		exit(1);
	}
	dfp = fopen(path(<span class="enscript-string">&quot;Makefile&quot;</span>), <span class="enscript-string">&quot;r&quot;</span>);
	rename(path(<span class="enscript-string">&quot;Makefile&quot;</span>), path(<span class="enscript-string">&quot;Makefile.old&quot;</span>));
	unlink(path(<span class="enscript-string">&quot;Makefile.old&quot;</span>));
	ofp = fopen(path(<span class="enscript-string">&quot;Makefile&quot;</span>), <span class="enscript-string">&quot;w&quot;</span>);
	<span class="enscript-keyword">if</span> (ofp == 0) {
		perror(path(<span class="enscript-string">&quot;Makefile&quot;</span>));
		exit(1);
	}
	fprintf(ofp, <span class="enscript-string">&quot;SOURCE_DIR=%s\n&quot;</span>, source_directory);

	fprintf(ofp, <span class="enscript-string">&quot;export CONFIG_DEFINES =&quot;</span>);
	<span class="enscript-keyword">if</span> (profiling)
		fprintf(ofp, <span class="enscript-string">&quot; -DGPROF&quot;</span>);

	<span class="enscript-keyword">for</span> (op = opt; op; op = op-&gt;op_next)
		<span class="enscript-keyword">if</span> (op-&gt;op_value)
			fprintf(ofp, <span class="enscript-string">&quot; -D%s=\&quot;%s\&quot;&quot;</span>, op-&gt;op_name, op-&gt;op_value);
		<span class="enscript-keyword">else</span>
			fprintf(ofp, <span class="enscript-string">&quot; -D%s&quot;</span>, op-&gt;op_name);
	fprintf(ofp, <span class="enscript-string">&quot;\n&quot;</span>);
	<span class="enscript-keyword">for</span> (op = mkopt; op; op = op-&gt;op_next)
		<span class="enscript-keyword">if</span> (op-&gt;op_value)
			fprintf(ofp, <span class="enscript-string">&quot;%s=%s\n&quot;</span>, op-&gt;op_name, op-&gt;op_value);
		<span class="enscript-keyword">else</span>
			fprintf(ofp, <span class="enscript-string">&quot;%s\n&quot;</span>, op-&gt;op_name);

	<span class="enscript-keyword">while</span> (fgets(line, BUFSIZ, ifp) != 0) {
		<span class="enscript-keyword">if</span> (*line == <span class="enscript-string">'%'</span>)
			<span class="enscript-keyword">goto</span> <span class="enscript-reference">percent</span>;
		<span class="enscript-keyword">if</span> (profiling &amp;&amp; strncmp(line, <span class="enscript-string">&quot;COPTS=&quot;</span>, 6) == 0) {
			<span class="enscript-type">register</span> <span class="enscript-type">char</span> *cp;
			fprintf(ofp,
				<span class="enscript-string">&quot;GPROF.EX=$(SOURCE_DIR)/machdep/%s/gmon.ex\n&quot;</span>, machinename);
			cp = index(line, <span class="enscript-string">'\n'</span>);
			<span class="enscript-keyword">if</span> (cp)
				*cp = 0;
			cp = line + 6;
			<span class="enscript-keyword">while</span> (*cp &amp;&amp; (*cp == <span class="enscript-string">' '</span> || *cp == <span class="enscript-string">'\t'</span>))
				cp++;
			COPTS = malloc((<span class="enscript-type">unsigned</span>)(strlen(cp) + 1));
			<span class="enscript-keyword">if</span> (COPTS == 0) {
				printf(<span class="enscript-string">&quot;config: out of memory\n&quot;</span>);
				exit(1);
			}
			strcpy(COPTS, cp);
			fprintf(ofp, <span class="enscript-string">&quot;%s -pg\n&quot;</span>, line);
			<span class="enscript-keyword">continue</span>;
		}
		fprintf(ofp, <span class="enscript-string">&quot;%s&quot;</span>, line);
		<span class="enscript-keyword">continue</span>;
	<span class="enscript-reference">percent</span>:
		<span class="enscript-keyword">if</span> (eq(line, <span class="enscript-string">&quot;%OBJS\n&quot;</span>)) {
			do_objs(ofp, <span class="enscript-string">&quot;OBJS=&quot;</span>, -1);
		} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (eq(line, <span class="enscript-string">&quot;%CFILES\n&quot;</span>)) {
			do_files(ofp, <span class="enscript-string">&quot;CFILES=&quot;</span>, <span class="enscript-string">'c'</span>);
			do_objs(ofp, <span class="enscript-string">&quot;COBJS=&quot;</span>, <span class="enscript-string">'c'</span>);
		} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (eq(line, <span class="enscript-string">&quot;%CXXFILES\n&quot;</span>)) {
			do_files(ofp, <span class="enscript-string">&quot;CXXFILES=&quot;</span>, <span class="enscript-string">'p'</span>);
			do_objs(ofp, <span class="enscript-string">&quot;CXXOBJS=&quot;</span>, <span class="enscript-string">'p'</span>);
		} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (eq(line, <span class="enscript-string">&quot;%SFILES\n&quot;</span>)) {
			do_files(ofp, <span class="enscript-string">&quot;SFILES=&quot;</span>, <span class="enscript-string">'s'</span>);
			do_objs(ofp, <span class="enscript-string">&quot;SOBJS=&quot;</span>, <span class="enscript-string">'s'</span>);
		} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (eq(line, <span class="enscript-string">&quot;%MACHDEP\n&quot;</span>)) {
			do_machdep(ofp);
		} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (eq(line, <span class="enscript-string">&quot;%RULES\n&quot;</span>))
			do_rules(ofp);
		<span class="enscript-keyword">else</span>
			fprintf(stderr,
			    <span class="enscript-string">&quot;Unknown %% construct in generic makefile: %s&quot;</span>,
			    line);
	}
	<span class="enscript-keyword">if</span> (dfp != NULL)
	{
		copy_dependencies(dfp, ofp);
		(<span class="enscript-type">void</span>) fclose(dfp);
	}
	(<span class="enscript-type">void</span>) fclose(ifp);
	(<span class="enscript-type">void</span>) fclose(ofp);
}

<span class="enscript-comment">/*
 * Read in the information about files used in making the system.
 * Store it in the ftab linked list.
 */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">read_files</span>(<span class="enscript-type">void</span>)
{
	FILE *fp;
	<span class="enscript-type">register</span> <span class="enscript-type">struct</span> file_list *tp, *pf;
	<span class="enscript-type">register</span> <span class="enscript-type">struct</span> device *dp;
	<span class="enscript-type">register</span> <span class="enscript-type">struct</span> opt *op;
	<span class="enscript-type">const</span> <span class="enscript-type">char</span> *wd;
	<span class="enscript-type">char</span> *this, *needs;
	<span class="enscript-type">const</span> <span class="enscript-type">char</span> *devorprof;
	<span class="enscript-type">int</span> options;
	<span class="enscript-type">int</span> not_option;
	<span class="enscript-type">char</span> pname[BUFSIZ];
	<span class="enscript-type">char</span> fname[1024];
	<span class="enscript-type">char</span> *rest = (<span class="enscript-type">char</span> *) 0;
	<span class="enscript-type">int</span> nreqs, first = 1, isdup;

	ftab = 0;
	(<span class="enscript-type">void</span>) sprintf(fname, <span class="enscript-string">&quot;%s/files&quot;</span>, config_directory);
<span class="enscript-reference">openit</span>:
	fp = fopenp(VPATH, fname, pname, <span class="enscript-string">&quot;r&quot;</span>);
	<span class="enscript-keyword">if</span> (fp == 0) {
		perror(fname);
		exit(1);
	}
<span class="enscript-reference">next</span>:
	options = 0;
	rest = (<span class="enscript-type">char</span> *) 0;
	<span class="enscript-comment">/*
	 * filename	[ standard | optional ]
	 *	[ dev* | profiling-routine ] [ device-driver]
	 */</span>
	wd = get_word(fp);
	<span class="enscript-keyword">if</span> (wd == (<span class="enscript-type">char</span> *)EOF) {
		(<span class="enscript-type">void</span>) fclose(fp);
		<span class="enscript-keyword">if</span> (first == 1) {
			(<span class="enscript-type">void</span>) sprintf(fname, <span class="enscript-string">&quot;%s/files.%s&quot;</span>, config_directory, machinename);
			first++;
			<span class="enscript-keyword">goto</span> <span class="enscript-reference">openit</span>;
		}
		<span class="enscript-keyword">return</span>;
	}
	<span class="enscript-keyword">if</span> (wd == 0)
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">next</span>;
	<span class="enscript-comment">/*
	 *  Allow comment lines beginning witha '#' character.
	 */</span>
	<span class="enscript-keyword">if</span> (*wd == <span class="enscript-string">'#'</span>)
	{
		<span class="enscript-keyword">while</span> ((wd=get_word(fp)) &amp;&amp; wd != (<span class="enscript-type">char</span> *)EOF)
			;
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">next</span>;
	}

	this = ns(wd);
	next_word(fp, wd);
	<span class="enscript-keyword">if</span> (wd == 0) {
		printf(<span class="enscript-string">&quot;%s: No type for %s.\n&quot;</span>,
		    fname, this);
		exit(1);
	}
	<span class="enscript-keyword">if</span> ((pf = fl_lookup(this)) &amp;&amp; (pf-&gt;f_type != INVISIBLE || pf-&gt;f_flags))
		isdup = 1;
	<span class="enscript-keyword">else</span>
		isdup = 0;
	tp = 0;
	nreqs = 0;
	devorprof = <span class="enscript-string">&quot;&quot;</span>;
	needs = 0;
	<span class="enscript-keyword">if</span> (eq(wd, <span class="enscript-string">&quot;standard&quot;</span>))
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">checkdev</span>;
	<span class="enscript-keyword">if</span> (!eq(wd, <span class="enscript-string">&quot;optional&quot;</span>)) {
		printf(<span class="enscript-string">&quot;%s: %s must be optional or standard\n&quot;</span>, fname, this);
		exit(1);
	}
	<span class="enscript-keyword">if</span> (strncmp(this, <span class="enscript-string">&quot;OPTIONS/&quot;</span>, 8) == 0)
		options++;
	not_option = 0;
<span class="enscript-reference">nextopt</span>:
	next_word(fp, wd);
	<span class="enscript-keyword">if</span> (wd == 0)
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">doneopt</span>;
	<span class="enscript-keyword">if</span> (eq(wd, <span class="enscript-string">&quot;not&quot;</span>)) {
		not_option = !not_option;
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">nextopt</span>;
	}
	devorprof = wd;
	<span class="enscript-keyword">if</span> (eq(wd, <span class="enscript-string">&quot;device-driver&quot;</span>) || eq(wd, <span class="enscript-string">&quot;profiling-routine&quot;</span>)) {
		next_word(fp, wd);
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">save</span>;
	}
	nreqs++;
	<span class="enscript-keyword">if</span> (needs == 0 &amp;&amp; nreqs == 1)
		needs = ns(wd);
	<span class="enscript-keyword">if</span> (isdup)
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">invis</span>;
	<span class="enscript-keyword">if</span> (options)
	{
		<span class="enscript-type">struct</span> opt *lop = 0;
		<span class="enscript-type">struct</span> device tdev;

		<span class="enscript-comment">/*
		 *  Allocate a pseudo-device entry which we will insert into
		 *  the device list below.  The flags field is set non-zero to
		 *  indicate an internal entry rather than one generated from
		 *  the configuration file.  The slave field is set to define
		 *  the corresponding symbol as 0 should we fail to find the
		 *  option in the option list.
		 */</span>
		init_dev(&amp;tdev);
		tdev.d_name = ns(wd);
		tdev.d_type = PSEUDO_DEVICE;
		tdev.d_flags++;
		tdev.d_slave = 0;

		<span class="enscript-keyword">for</span> (op=opt; op; lop=op, op=op-&gt;op_next)
		{
			<span class="enscript-type">char</span> *od = allCaps(ns(wd));

			<span class="enscript-comment">/*
			 *  Found an option which matches the current device
			 *  dependency identifier.  Set the slave field to
			 *  define the option in the header file.
			 */</span>
			<span class="enscript-keyword">if</span> (strcmp(op-&gt;op_name, od) == 0)
			{
				tdev.d_slave = 1;
				<span class="enscript-keyword">if</span> (lop == 0)
					opt = op-&gt;op_next;
				<span class="enscript-keyword">else</span>
					lop-&gt;op_next = op-&gt;op_next;
				free(op);
				op = 0;
			 }
			free(od);
			<span class="enscript-keyword">if</span> (op == 0)
				<span class="enscript-keyword">break</span>;
		}
		newdev(&amp;tdev);
	}
 	<span class="enscript-keyword">for</span> (dp = dtab; dp != 0; dp = dp-&gt;d_next) {
		<span class="enscript-keyword">if</span> (eq(dp-&gt;d_name, wd) &amp;&amp; (dp-&gt;d_type != PSEUDO_DEVICE || dp-&gt;d_slave)) {
			<span class="enscript-keyword">if</span> (not_option)
				<span class="enscript-keyword">goto</span> <span class="enscript-reference">invis</span>;	<span class="enscript-comment">/* dont want file if option present */</span>
			<span class="enscript-keyword">else</span>
				<span class="enscript-keyword">goto</span> <span class="enscript-reference">nextopt</span>;
		}
	}
	<span class="enscript-keyword">if</span> (not_option)
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">nextopt</span>;		<span class="enscript-comment">/* want file if option missing */</span>

	<span class="enscript-keyword">for</span> (op = opt; op != 0; op = op-&gt;op_next)
		<span class="enscript-keyword">if</span> (op-&gt;op_value == 0 &amp;&amp; opteq(op-&gt;op_name, wd)) {
			<span class="enscript-keyword">if</span> (nreqs == 1) {
				free(needs);
				needs = 0;
			}
			<span class="enscript-keyword">goto</span> <span class="enscript-reference">nextopt</span>;
		}

<span class="enscript-reference">invis</span>:
	<span class="enscript-keyword">while</span> ((wd = get_word(fp)) != 0)
		;
	<span class="enscript-keyword">if</span> (tp == 0)
		tp = new_fent();
	tp-&gt;f_fn = this;
	tp-&gt;f_type = INVISIBLE;
	tp-&gt;f_needs = needs;
	tp-&gt;f_flags = isdup;
	<span class="enscript-keyword">goto</span> <span class="enscript-reference">next</span>;

<span class="enscript-reference">doneopt</span>:
	<span class="enscript-keyword">if</span> (nreqs == 0) {
		printf(<span class="enscript-string">&quot;%s: what is %s optional on?\n&quot;</span>,
		    fname, this);
		exit(1);
	}

<span class="enscript-reference">checkdev</span>:
	<span class="enscript-keyword">if</span> (wd) {
		<span class="enscript-keyword">if</span> (*wd == <span class="enscript-string">'|'</span>)
			<span class="enscript-keyword">goto</span> <span class="enscript-reference">getrest</span>;
		next_word(fp, wd);
		<span class="enscript-keyword">if</span> (wd) {
			devorprof = wd;
			next_word(fp, wd);
		}
	}

<span class="enscript-reference">save</span>:
<span class="enscript-reference">getrest</span>:
	<span class="enscript-keyword">if</span> (wd) {
		<span class="enscript-keyword">if</span> (*wd == <span class="enscript-string">'|'</span>) {
			rest = ns(get_rest(fp));
		} <span class="enscript-keyword">else</span> {
			printf(<span class="enscript-string">&quot;%s: syntax error describing %s\n&quot;</span>,
			       fname, this);
			exit(1);
		}
	}
	<span class="enscript-keyword">if</span> (eq(devorprof, <span class="enscript-string">&quot;profiling-routine&quot;</span>) &amp;&amp; profiling == 0)
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">next</span>;
	<span class="enscript-keyword">if</span> (tp == 0)
		tp = new_fent();
	tp-&gt;f_fn = this;
	tp-&gt;f_extra = rest;
	<span class="enscript-keyword">if</span> (options)
		tp-&gt;f_type = INVISIBLE;
	<span class="enscript-keyword">else</span>
	<span class="enscript-keyword">if</span> (eq(devorprof, <span class="enscript-string">&quot;device-driver&quot;</span>))
		tp-&gt;f_type = DRIVER;
	<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (eq(devorprof, <span class="enscript-string">&quot;profiling-routine&quot;</span>))
		tp-&gt;f_type = PROFILING;
	<span class="enscript-keyword">else</span>
		tp-&gt;f_type = NORMAL;
	tp-&gt;f_flags = 0;
	tp-&gt;f_needs = needs;
	<span class="enscript-keyword">if</span> (pf &amp;&amp; pf-&gt;f_type == INVISIBLE)
		pf-&gt;f_flags = 1;		<span class="enscript-comment">/* mark as duplicate */</span>
	<span class="enscript-keyword">goto</span> <span class="enscript-reference">next</span>;
}

<span class="enscript-type">int</span>
<span class="enscript-function-name">opteq</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *cp, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *dp)
{
	<span class="enscript-type">char</span> c, d;

	<span class="enscript-keyword">for</span> (; ; cp++, dp++) {
		<span class="enscript-keyword">if</span> (*cp != *dp) {
			c = isupper(*cp) ? tolower(*cp) : *cp;
			d = isupper(*dp) ? tolower(*dp) : *dp;
			<span class="enscript-keyword">if</span> (c != d)
				<span class="enscript-keyword">return</span> (0);
		}
		<span class="enscript-keyword">if</span> (*cp == 0)
			<span class="enscript-keyword">return</span> (1);
	}
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">put_source_file_name</span>(FILE *fp, <span class="enscript-type">struct</span> file_list *tp)
{
	<span class="enscript-keyword">if</span> ((tp-&gt;f_fn[0] == <span class="enscript-string">'.'</span>) &amp;&amp; (tp-&gt;f_fn[1] == <span class="enscript-string">'/'</span>))
		fprintf(fp, <span class="enscript-string">&quot;%s &quot;</span>, tp-&gt;f_fn);
	 <span class="enscript-keyword">else</span>
		fprintf(fp, <span class="enscript-string">&quot;$(SOURCE_DIR)/%s &quot;</span>, tp-&gt;f_fn);
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">do_objs</span>(FILE *fp, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *msg, <span class="enscript-type">int</span> ext)
{
	<span class="enscript-type">register</span> <span class="enscript-type">struct</span> file_list *tp;
	<span class="enscript-type">register</span> <span class="enscript-type">int</span> lpos, len;
	<span class="enscript-type">char</span> *cp;
	<span class="enscript-type">char</span> och;
	<span class="enscript-type">const</span> <span class="enscript-type">char</span> *sp;

	fprintf(fp, <span class="enscript-string">&quot;%s&quot;</span>, msg);
	lpos = strlen(msg);
	<span class="enscript-keyword">for</span> (tp = ftab; tp != 0; tp = tp-&gt;f_next) {
		<span class="enscript-keyword">if</span> (tp-&gt;f_type == INVISIBLE)
			<span class="enscript-keyword">continue</span>;

		<span class="enscript-comment">/*
		 *	Check for '.o' file in list
		 */</span>
		cp = tp-&gt;f_fn + (len = strlen(tp-&gt;f_fn)) - 1;
		<span class="enscript-keyword">if</span> (ext != -1 &amp;&amp; *cp != ext)
			<span class="enscript-keyword">continue</span>;
		<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (*cp == <span class="enscript-string">'o'</span>) {
			<span class="enscript-keyword">if</span> (len + lpos &gt; 72) {
				lpos = 8;
				fprintf(fp, <span class="enscript-string">&quot;\\\n\t&quot;</span>);
			}
			put_source_file_name(fp, tp);
			fprintf(fp, <span class="enscript-string">&quot; &quot;</span>);
			lpos += len + 1;
			<span class="enscript-keyword">continue</span>;
		}
		sp = tail(tp-&gt;f_fn);
		cp = (<span class="enscript-type">char</span> *)sp + (len = strlen(sp)) - 1;
		och = *cp;
		*cp = <span class="enscript-string">'o'</span>;
		<span class="enscript-keyword">if</span> (len + lpos &gt; 72) {
			lpos = 8;
			fprintf(fp, <span class="enscript-string">&quot;\\\n\t&quot;</span>);
		}
		fprintf(fp, <span class="enscript-string">&quot;%s &quot;</span>, sp);
		lpos += len + 1;
		*cp = och;
	}
	putc(<span class="enscript-string">'\n'</span>, fp);
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">do_files</span>(FILE *fp, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *msg, <span class="enscript-type">char</span> ext)
{
	<span class="enscript-type">register</span> <span class="enscript-type">struct</span> file_list *tp;
	<span class="enscript-type">register</span> <span class="enscript-type">int</span> lpos, len=0; <span class="enscript-comment">/* dvw: init to 0 */</span>

	fprintf(fp, <span class="enscript-string">&quot;%s&quot;</span>, msg);
	lpos = 8;
	<span class="enscript-keyword">for</span> (tp = ftab; tp != 0; tp = tp-&gt;f_next) {
		<span class="enscript-keyword">if</span> (tp-&gt;f_type == INVISIBLE)
			<span class="enscript-keyword">continue</span>;
		<span class="enscript-keyword">if</span> (tp-&gt;f_fn[strlen(tp-&gt;f_fn)-1] != ext)
			<span class="enscript-keyword">continue</span>;
		<span class="enscript-comment">/*
		 * Always generate a newline.
		 * Our Makefile's aren't readable anyway.
		 */</span>

		lpos = 8;
		fprintf(fp, <span class="enscript-string">&quot;\\\n\t&quot;</span>);
		put_source_file_name(fp, tp);
		lpos += len + 1;
	}
	putc(<span class="enscript-string">'\n'</span>, fp);
}

<span class="enscript-comment">/*
 *  Include machine dependent makefile in output
 */</span>

<span class="enscript-type">void</span>
<span class="enscript-function-name">do_machdep</span>(FILE *ofp)
{
	FILE *ifp;
	<span class="enscript-type">char</span> pname[BUFSIZ];
	<span class="enscript-type">char</span> line[BUFSIZ];

	(<span class="enscript-type">void</span>) sprintf(line, <span class="enscript-string">&quot;%s/Makefile.%s&quot;</span>, config_directory, machinename);
	ifp = fopenp(VPATH, line, pname, <span class="enscript-string">&quot;r&quot;</span>);
	<span class="enscript-keyword">if</span> (ifp == 0) {
		perror(line);
		exit(1);
	}
	<span class="enscript-keyword">while</span> (fgets(line, BUFSIZ, ifp) != 0) {
		<span class="enscript-keyword">if</span> (profiling &amp;&amp; (strncmp(line, <span class="enscript-string">&quot;LIBS=&quot;</span>, 5) == 0)) 
			fprintf(ofp,<span class="enscript-string">&quot;LIBS=${LIBS_P}\n&quot;</span>);
		<span class="enscript-keyword">else</span>
			fputs(line, ofp);
	}
	fclose(ifp);
}

<span class="enscript-type">const</span> <span class="enscript-type">char</span> *
<span class="enscript-function-name">tail</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *fn)
{
	<span class="enscript-type">register</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> *cp;

	cp = rindex(fn, <span class="enscript-string">'/'</span>);
	<span class="enscript-keyword">if</span> (cp == 0)
		<span class="enscript-keyword">return</span> (fn);
	<span class="enscript-keyword">return</span> (cp+1);
}

<span class="enscript-comment">/*
 * Create the makerules for each file
 * which is part of the system.
 * Devices are processed with the special c2 option -i
 * which avoids any problem areas with i/o addressing
 * (e.g. for the VAX); assembler files are processed by as.
 */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">do_rules</span>(FILE *f)
{
	<span class="enscript-type">char</span> *cp;
	<span class="enscript-type">char</span> *np, och;
	<span class="enscript-type">const</span> <span class="enscript-type">char</span> *tp;
	<span class="enscript-type">register</span> <span class="enscript-type">struct</span> file_list *ftp;
	<span class="enscript-type">const</span> <span class="enscript-type">char</span> *extras = <span class="enscript-string">&quot;&quot;</span>; <span class="enscript-comment">/* dvw: init to &quot;&quot; */</span>
	<span class="enscript-type">char</span> *source_dir;
	<span class="enscript-type">char</span> och_upper;
	<span class="enscript-type">const</span> <span class="enscript-type">char</span> *nl = <span class="enscript-string">&quot;&quot;</span>;

	<span class="enscript-keyword">for</span> (ftp = ftab; ftp != 0; ftp = ftp-&gt;f_next) {
		<span class="enscript-keyword">if</span> (ftp-&gt;f_type == INVISIBLE)
			<span class="enscript-keyword">continue</span>;
		cp = (np = ftp-&gt;f_fn) + strlen(ftp-&gt;f_fn) - 1;
		och = *cp;
		<span class="enscript-comment">/*
			*	Don't compile '.o' files
			*/</span>
		<span class="enscript-keyword">if</span> (och == <span class="enscript-string">'o'</span>)
			<span class="enscript-keyword">continue</span>;
		<span class="enscript-comment">/*
			*	Determine where sources should come from
			*/</span>
		<span class="enscript-keyword">if</span> ((np[0] == <span class="enscript-string">'.'</span>) &amp;&amp; (np[1] == <span class="enscript-string">'/'</span>)) {
			source_dir = <span class="enscript-string">&quot;&quot;</span>;
			np += 2;
		} <span class="enscript-keyword">else</span>
			source_dir = <span class="enscript-string">&quot;$(SOURCE_DIR)/&quot;</span>;
		*cp = <span class="enscript-string">'\0'</span>;
		tp = tail(np);	<span class="enscript-comment">/* dvw: init tp before 'if' */</span>
		fprintf(f, <span class="enscript-string">&quot;-include %sd\n&quot;</span>, tp);
		fprintf(f, <span class="enscript-string">&quot;%so: %s%s%c\n&quot;</span>, tp, source_dir, np, och);
		<span class="enscript-keyword">if</span> (och == <span class="enscript-string">'s'</span>) {
			fprintf(f, <span class="enscript-string">&quot;\t${S_RULE_0}\n&quot;</span>);
			fprintf(f, <span class="enscript-string">&quot;\t${S_RULE_1A}%s%.*s${S_RULE_1B}%s\n&quot;</span>,
					source_dir, (<span class="enscript-type">int</span>)(tp-np), np, nl);
			fprintf(f, <span class="enscript-string">&quot;\t${S_RULE_2}%s\n&quot;</span>, nl);
			<span class="enscript-keyword">continue</span>;
		}
		extras = <span class="enscript-string">&quot;&quot;</span>;
		<span class="enscript-keyword">switch</span> (ftp-&gt;f_type) {
	
		<span class="enscript-keyword">case</span> <span class="enscript-reference">NORMAL</span>:
			<span class="enscript-keyword">goto</span> <span class="enscript-reference">common</span>;
			<span class="enscript-keyword">break</span>;
	
		<span class="enscript-keyword">case</span> <span class="enscript-reference">DRIVER</span>:
			extras = <span class="enscript-string">&quot;_D&quot;</span>;
			<span class="enscript-keyword">goto</span> <span class="enscript-reference">common</span>;
			<span class="enscript-keyword">break</span>;
	
		<span class="enscript-keyword">case</span> <span class="enscript-reference">PROFILING</span>:
			<span class="enscript-keyword">if</span> (!profiling)
				<span class="enscript-keyword">continue</span>;
			<span class="enscript-keyword">if</span> (COPTS == 0) {
				fprintf(stderr,
					<span class="enscript-string">&quot;config: COPTS undefined in generic makefile&quot;</span>);
				COPTS = <span class="enscript-string">&quot;&quot;</span>;
			}
			extras = <span class="enscript-string">&quot;_P&quot;</span>;
			<span class="enscript-keyword">goto</span> <span class="enscript-reference">common</span>;
	
		<span class="enscript-reference">common</span>:
			och_upper = och + <span class="enscript-string">'A'</span> - <span class="enscript-string">'a'</span>;
			fprintf(f, <span class="enscript-string">&quot;\t${%c_RULE_0%s}\n&quot;</span>, och_upper, extras);
			fprintf(f, <span class="enscript-string">&quot;\t${%c_RULE_1A%s}&quot;</span>, och_upper, extras);
			<span class="enscript-keyword">if</span> (ftp-&gt;f_extra)
				fprintf(f, <span class="enscript-string">&quot;%s&quot;</span>, ftp-&gt;f_extra);
			fprintf(f, <span class="enscript-string">&quot;%s%.*s${%c_RULE_1B%s}%s\n&quot;</span>,
					source_dir, (<span class="enscript-type">int</span>)(tp-np), np, och_upper, extras, nl);

			<span class="enscript-comment">/* While we are still using CTF, any build that normally does not support CTF will
			 * a &quot;standard&quot; compile done as well that we can harvest CTF information from; do
			 * that here.
			 */</span>
			fprintf(f, <span class="enscript-string">&quot;\t${%c_CTFRULE_1A%s}&quot;</span>, och_upper, extras);
			<span class="enscript-keyword">if</span> (ftp-&gt;f_extra)
				fprintf(f, <span class="enscript-string">&quot;%s&quot;</span>, ftp-&gt;f_extra);
			fprintf(f, <span class="enscript-string">&quot;%s%.*s${%c_CTFRULE_1B%s}%s\n&quot;</span>,
					source_dir, (<span class="enscript-type">int</span>)(tp-np), np, och_upper, extras, nl);

			fprintf(f, <span class="enscript-string">&quot;\t${%c_RULE_2%s}%s\n&quot;</span>, och_upper, extras, nl);
			fprintf(f, <span class="enscript-string">&quot;\t${%c_CTFRULE_2%s}%s\n&quot;</span>, och_upper, extras, nl);
			<span class="enscript-keyword">break</span>;
	
		<span class="enscript-reference">default</span>:
			printf(<span class="enscript-string">&quot;Don't know rules for %s\n&quot;</span>, np);
			<span class="enscript-keyword">break</span>;
		}
		*cp = och;
	}
}

<span class="enscript-type">char</span> *
<span class="enscript-function-name">allCaps</span>(str)
	<span class="enscript-type">register</span> <span class="enscript-type">char</span> *str;
{
	<span class="enscript-type">register</span> <span class="enscript-type">char</span> *cp = str;

	<span class="enscript-keyword">while</span> (*str) {
		<span class="enscript-keyword">if</span> (islower(*str))
			*str = toupper(*str);
		str++;
	}
	<span class="enscript-keyword">return</span> (cp);
}

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">OLDSALUTATION</span> <span class="enscript-string">&quot;# DO NOT DELETE THIS LINE&quot;</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LINESIZE</span> 1024
<span class="enscript-type">static</span> <span class="enscript-type">char</span> makbuf[LINESIZE];		<span class="enscript-comment">/* one line buffer for makefile */</span>

<span class="enscript-type">void</span>
<span class="enscript-function-name">copy_dependencies</span>(FILE *makin, FILE *makout)
{
	<span class="enscript-type">register</span> <span class="enscript-type">int</span> oldlen = (<span class="enscript-keyword">sizeof</span> OLDSALUTATION - 1);

	<span class="enscript-keyword">while</span> (fgets(makbuf, LINESIZE, makin) != NULL) {
		<span class="enscript-keyword">if</span> (! strncmp(makbuf, OLDSALUTATION, oldlen))
			<span class="enscript-keyword">break</span>;
	}
	<span class="enscript-keyword">while</span> (fgets(makbuf, LINESIZE, makin) != NULL) {
		<span class="enscript-keyword">if</span> (oldlen != 0)
		{
			<span class="enscript-keyword">if</span> (makbuf[0] == <span class="enscript-string">'\n'</span>)
				<span class="enscript-keyword">continue</span>;
			<span class="enscript-keyword">else</span>
				oldlen = 0;
		}
		fputs(makbuf, makout);
	}
}
</pre>
<hr />
</body></html>