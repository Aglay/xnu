<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>kcdata.py</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">kcdata.py&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">#!/usr/bin/env python
</span><span class="enscript-keyword">import</span> sys
<span class="enscript-keyword">import</span> struct
<span class="enscript-keyword">import</span> mmap
<span class="enscript-keyword">import</span> json
<span class="enscript-keyword">import</span> cgitb
<span class="enscript-keyword">import</span> copy
<span class="enscript-keyword">import</span> re
<span class="enscript-keyword">import</span> base64
<span class="enscript-keyword">import</span> argparse
<span class="enscript-keyword">import</span> os
<span class="enscript-keyword">import</span> shlex
<span class="enscript-keyword">import</span> subprocess

cgitb.enable(format=<span class="enscript-string">'text'</span>)

kcdata_type_<span class="enscript-keyword">def</span> <span class="enscript-function-name">= {
</span>    <span class="enscript-string">'KCDATA_TYPE_INVALID'</span>:              0x0,
    <span class="enscript-string">'KCDATA_TYPE_STRING_DESC'</span>:          0x1,
    <span class="enscript-string">'KCDATA_TYPE_UINT32_DESC'</span>:          0x2,
    <span class="enscript-string">'KCDATA_TYPE_UINT64_DESC'</span>:          0x3,
    <span class="enscript-string">'KCDATA_TYPE_INT32_DESC'</span>:           0x4,
    <span class="enscript-string">'KCDATA_TYPE_INT64_DESC'</span>:           0x5,
    <span class="enscript-string">'KCDATA_TYPE_BINDATA_DESC'</span>:         0x6,
    <span class="enscript-string">'KCDATA_TYPE_ARRAY'</span>:                0x11,
    <span class="enscript-string">'KCDATA_TYPE_TYPEDEFINTION'</span>:        0x12,
    <span class="enscript-string">'KCDATA_TYPE_CONTAINER_BEGIN'</span>:      0x13,
    <span class="enscript-string">'KCDATA_TYPE_CONTIANER_END'</span>:        0x14,
    <span class="enscript-string">'KCDATA_TYPE_LIBRARY_LOADINFO'</span>:     0x30,
    <span class="enscript-string">'KCDATA_TYPE_LIBRARY_LOADINFO64'</span>:   0x31,
    <span class="enscript-string">'KCDATA_TYPE_TIMEBASE'</span>:             0x32,
    <span class="enscript-comment">#'KCDATA_TYPE_MACH_ABSOLUTE_TIME':   0x33,
</span>    <span class="enscript-string">'KCDATA_TYPE_TIMEVAL'</span>:              0x34,
    <span class="enscript-string">'KCDATA_TYPE_USECS_SINCE_EPOCH'</span>:    0x35,
    <span class="enscript-string">'STACKSHOT_KCCONTAINER_TASK'</span>:       0x903,
    <span class="enscript-string">'STACKSHOT_KCCONTAINER_THREAD'</span>:     0x904,
    <span class="enscript-string">'STACKSHOT_KCTYPE_KERN_STACKFRAME'</span>: 0x90A,
    <span class="enscript-string">'STACKSHOT_KCTYPE_KERN_STACKFRAME64'</span>: 0x90B,
    <span class="enscript-string">'STACKSHOT_KCTYPE_USER_STACKFRAME'</span>: 0x90C,
    <span class="enscript-string">'STACKSHOT_KCTYPE_USER_STACKFRAME64'</span>: 0x90D,
    <span class="enscript-string">'STACKSHOT_KCTYPE_BOOTARGS'</span>:        0x90E,
    <span class="enscript-string">'STACKSHOT_KCTYPE_OSVERSION'</span>:       0x90F,
    <span class="enscript-string">'STACKSHOT_KCTYPE_KERN_PAGE_SIZE'</span>:  0x910,
    <span class="enscript-string">'STACKSHOT_KCTYPE_JETSAM_LEVEL'</span>:    0x911,
    <span class="enscript-string">'KCDATA_TYPE_BUFFER_END'</span>:      0xF19158ED,


    <span class="enscript-string">'TASK_CRASHINFO_EXTMODINFO'</span>:           0x801,
    <span class="enscript-string">'TASK_CRASHINFO_BSDINFOWITHUNIQID'</span>:    0x802,
    <span class="enscript-string">'TASK_CRASHINFO_TASKDYLD_INFO'</span>:        0x803,
    <span class="enscript-string">'TASK_CRASHINFO_UUID'</span>:                 0x804,
    <span class="enscript-string">'TASK_CRASHINFO_PID'</span>:                  0x805,
    <span class="enscript-string">'TASK_CRASHINFO_PPID'</span>:                 0x806,
    <span class="enscript-string">'TASK_CRASHINFO_RUSAGE'</span>:               0x807,
    <span class="enscript-string">'TASK_CRASHINFO_RUSAGE_INFO'</span>:          0x808,
    <span class="enscript-string">'TASK_CRASHINFO_PROC_NAME'</span>:            0x809,
    <span class="enscript-string">'TASK_CRASHINFO_PROC_STARTTIME'</span>:       0x80B,
    <span class="enscript-string">'TASK_CRASHINFO_USERSTACK'</span>:            0x80C,
    <span class="enscript-string">'TASK_CRASHINFO_ARGSLEN'</span>:              0x80D,
    <span class="enscript-string">'TASK_CRASHINFO_EXCEPTION_CODES'</span>:      0x80E,
    <span class="enscript-string">'TASK_CRASHINFO_PROC_PATH'</span>:            0x80F,
    <span class="enscript-string">'TASK_CRASHINFO_PROC_CSFLAGS'</span>:         0x810,
    <span class="enscript-string">'TASK_CRASHINFO_PROC_STATUS'</span>:          0x811,
    <span class="enscript-string">'TASK_CRASHINFO_UID'</span>:                  0x812,
    <span class="enscript-string">'TASK_CRASHINFO_GID'</span>:                  0x813,
    <span class="enscript-string">'TASK_CRASHINFO_PROC_ARGC'</span>:            0x814,
    <span class="enscript-string">'TASK_CRASHINFO_PROC_FLAGS'</span>:           0x815,
    <span class="enscript-string">'TASK_CRASHINFO_CPUTYPE'</span>:              0x816,
    <span class="enscript-string">'TASK_CRASHINFO_WORKQUEUEINFO'</span>:        0x817,
    <span class="enscript-string">'TASK_CRASHINFO_RESPONSIBLE_PID'</span>:      0x818,
    <span class="enscript-string">'TASK_CRASHINFO_DIRTY_FLAGS'</span>:          0x819,
    <span class="enscript-string">'TASK_CRASHINFO_CRASHED_THREADID'</span>:     0x81A,

    <span class="enscript-string">'KCDATA_BUFFER_BEGIN_CRASHINFO'</span>:  0xDEADF157,
    <span class="enscript-string">'KCDATA_BUFFER_BEGIN_STACKSHOT'</span>:  0x59a25807
}
kcdata_type_def_rev = dict((v, k) <span class="enscript-keyword">for</span> k, v <span class="enscript-keyword">in</span> kcdata_type_def.iteritems())

KNOWN_TYPES_COLLECTION = {}


<span class="enscript-keyword">def</span> <span class="enscript-function-name">enum</span>(**args):
    <span class="enscript-keyword">return</span> type(<span class="enscript-string">'enum'</span>, (), args)

KCSUBTYPE_TYPE = enum(KC_ST_CHAR=1, KC_ST_INT8=2, KC_ST_UINT8=3, KC_ST_INT16=4, KC_ST_UINT16=5, KC_ST_INT32=6, KC_ST_UINT32=7, KC_ST_INT64=8, KC_ST_UINT64=9)


<span class="enscript-keyword">class</span> KCSubTypeElement(object):
    <span class="enscript-string">&quot;&quot;&quot;convert kcdata_subtype_descriptor to &quot;&quot;&quot;</span>
    _unpack_formats = (None, <span class="enscript-string">'c'</span>, <span class="enscript-string">'b'</span>, <span class="enscript-string">'B'</span>, <span class="enscript-string">'h'</span>, <span class="enscript-string">'H'</span>, <span class="enscript-string">'i'</span>, <span class="enscript-string">'I'</span>, <span class="enscript-string">'q'</span>, <span class="enscript-string">'Q'</span>)
    _ctypes = (<span class="enscript-string">'Unknown'</span>, <span class="enscript-string">'char'</span>, <span class="enscript-string">'int8_t'</span>, <span class="enscript-string">'uint8_t'</span>, <span class="enscript-string">'int16_t'</span>, <span class="enscript-string">'uint16_t'</span>, <span class="enscript-string">'int32_t'</span>, <span class="enscript-string">'uint32_t'</span>, <span class="enscript-string">'int64_t'</span>, <span class="enscript-string">'uint64_t'</span>)

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__init__</span>(self, st_name, st_type, st_size, st_offset=0, st_flag=0, custom_repr=None):
        self.name = st_name
        self.offset = st_offset
        self.type_id = st_type
        <span class="enscript-keyword">if</span> st_type &lt;= 0 <span class="enscript-keyword">or</span> st_type &gt; KCSUBTYPE_TYPE.KC_ST_UINT64:
            <span class="enscript-keyword">raise</span> ValueError(<span class="enscript-string">&quot;Invalid type passed %d&quot;</span> % st_type)
        self.unpack_fmt = KCSubTypeElement._unpack_formats[self.type_id]
        self.size = st_size
        self.totalsize = st_size
        self.count = 1
        self.is_array_type = False
        self.custom_JsonRepr = custom_repr
        <span class="enscript-keyword">if</span> (st_flag &amp; 0x1) == 0x1:
            self.is_array_type = True
            self.size = st_size &amp; 0xffff
            self.count = (st_size &gt;&gt; 16) &amp; 0xffff
            self.totalsize = self.size * self.count

    @staticmethod
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetSizeForArray</span>(el_count, el_size):
        <span class="enscript-keyword">return</span> ((el_count &amp; 0xffff) &lt;&lt; 16) | (el_size &amp; 0xffff)

    @staticmethod
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">FromBinaryTypeData</span>(byte_data):
        (st_flag, st_type, st_offset, st_size, st_name) = struct.unpack_from(<span class="enscript-string">'=BBHI32s'</span>, byte_data)
        st_name = st_name.rstrip(<span class="enscript-string">'\x00'</span>)
        <span class="enscript-keyword">return</span> KCSubTypeElement(st_name, st_type, st_size, st_offset, st_flag)

    @staticmethod
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">FromBasicCtype</span>(st_name, st_type, st_offset=0):
        <span class="enscript-keyword">if</span> st_type &lt;= 0 <span class="enscript-keyword">or</span> st_type &gt; KCSUBTYPE_TYPE.KC_ST_UINT64:
            <span class="enscript-keyword">raise</span> ValueError(<span class="enscript-string">&quot;Invalid type passed %d&quot;</span> % st_type)
        st_size = struct.calcsize(KCSubTypeElement._unpack_formats[st_type])
        st_flag = 0
        retval = KCSubTypeElement(st_name, st_type, st_size, st_offset, st_flag, KCSubTypeElement._get_naked_element_value)
        <span class="enscript-keyword">return</span> retval

    @staticmethod
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">FromKCSubTypeElement</span>(other, name_override=<span class="enscript-string">''</span>):
        _copy = copy.copy(other)
        <span class="enscript-keyword">if</span> name_override:
            _copy.name = name_override
        <span class="enscript-keyword">return</span> copy

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetName</span>(self):
        <span class="enscript-keyword">return</span> self.name

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetTotalSize</span>(self):
        <span class="enscript-keyword">return</span> self.totalsize

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetValueAsString</span>(self, base_data, array_pos=0):
        <span class="enscript-keyword">return</span> str(self.GetValue(base_data, array_pos))

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetValue</span>(self, base_data, array_pos=0):
        <span class="enscript-keyword">return</span> struct.unpack_from(self.unpack_fmt, base_data[self.offset + (array_pos * self.size):])[0]

    @staticmethod
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">_get_naked_element_value</span>(elementValue, elementName):
        <span class="enscript-keyword">return</span> json.dumps(elementValue)

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__str__</span>(self):
        <span class="enscript-keyword">if</span> self.is_array_type:
            <span class="enscript-keyword">return</span> <span class="enscript-string">'[%d,%d] %s  %s[%d];'</span> % (self.offset, self.totalsize, self.GetCTypeDesc(), self.name, self.count)
        <span class="enscript-keyword">return</span> <span class="enscript-string">'[%d,%d] %s  %s;'</span> % (self.offset, self.totalsize, self.GetCTypeDesc(), self.name)

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__repr__</span>(self):
        <span class="enscript-keyword">return</span> str(self)

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetCTypeDesc</span>(self):
        <span class="enscript-keyword">return</span> KCSubTypeElement._ctypes[self.type_id]

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetStringRepr</span>(self, base_data):
        <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> self.is_array_type:
            <span class="enscript-keyword">return</span> self.GetValueAsString(base_data)
        <span class="enscript-keyword">if</span> self.type_id == KCSUBTYPE_TYPE.KC_ST_CHAR:
            str_len = self.count
            <span class="enscript-keyword">if</span> len(base_data) &lt; str_len:
                str_len = len(base_data)
            str_arr = []
            <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> range(str_len):
                _v = self.GetValue(base_data, i)
                <span class="enscript-keyword">if</span> ord(_v) == 0:
                    <span class="enscript-keyword">break</span>
                str_arr.append(self.GetValueAsString(base_data, i))

            <span class="enscript-keyword">return</span> <span class="enscript-string">'&quot;'</span> + <span class="enscript-string">''</span>.join(str_arr) + <span class="enscript-string">'&quot;'</span>
        o = <span class="enscript-string">'['</span> + <span class="enscript-string">','</span>.join([self.GetValueAsString(base_data, i) <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> range(self.count)]) + <span class="enscript-string">']'</span>
        <span class="enscript-keyword">return</span> o

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetJsonRepr</span>(self, base_data):
        <span class="enscript-keyword">if</span> self.custom_JsonRepr:
            <span class="enscript-keyword">if</span> self.is_array_type:
                e_data = [self.GetValue(base_data, i) <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> range(self.count)]
            <span class="enscript-keyword">else</span>:
                e_data = self.GetValue(base_data)
            <span class="enscript-keyword">return</span> self.custom_JsonRepr(e_data, self.name)
        <span class="enscript-keyword">return</span> self.GetStringRepr(base_data)


<span class="enscript-keyword">class</span> KCTypeDescription(object):
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__init__</span>(self, t_type_id, t_elements=[], t_name=<span class="enscript-string">'anon'</span>, custom_repr=None):
        self.type_id = t_type_id
        self.elements = t_elements
        self.name = t_name
        self.totalsize = 0
        self.custom_JsonRepr = custom_repr
        <span class="enscript-keyword">for</span> e <span class="enscript-keyword">in</span> self.elements:
            self.totalsize += e.GetTotalSize()

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">ValidateData</span>(self, base_data):
        <span class="enscript-keyword">if</span> len(base_data) &gt;= self.totalsize:
            <span class="enscript-keyword">return</span> True
        <span class="enscript-keyword">return</span> False

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetTypeID</span>(self):
        <span class="enscript-keyword">return</span> self.type_id

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetName</span>(self):
        <span class="enscript-keyword">return</span> self.name

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__str__</span>(self):
        o = <span class="enscript-string">'%s {\n\t'</span> % self.name + <span class="enscript-string">&quot;\n\t&quot;</span>.join([str(e) <span class="enscript-keyword">for</span> e <span class="enscript-keyword">in</span> self.elements]) + <span class="enscript-string">'\n};'</span>
        <span class="enscript-keyword">return</span> o

    @staticmethod
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">FromKCTypeDescription</span>(other, t_type_id, t_name):
        retval = KCTypeDescription(t_type_id, other.elements, t_name, other.custom_JsonRepr)
        <span class="enscript-keyword">return</span> retval

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetJsonRepr</span>(self, base_data):
        <span class="enscript-keyword">if</span> self.custom_JsonRepr:
            <span class="enscript-keyword">return</span> self.custom_JsonRepr([e.GetValue(base_data) <span class="enscript-keyword">for</span> e <span class="enscript-keyword">in</span> self.elements])
        o = <span class="enscript-string">'{'</span> + <span class="enscript-string">&quot;, &quot;</span>.join([<span class="enscript-string">'&quot;%s&quot;: %s'</span> % (e.GetName(), e.GetJsonRepr(base_data)) <span class="enscript-keyword">for</span> e <span class="enscript-keyword">in</span> self.elements]) + <span class="enscript-string">'}'</span>
        <span class="enscript-keyword">return</span> o


<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetTypeNameForKey</span>(k):
    retval = <span class="enscript-string">&quot;0x%x&quot;</span> % k
    <span class="enscript-keyword">if</span> k <span class="enscript-keyword">in</span> KNOWN_TYPES_COLLECTION:
        retval = KNOWN_TYPES_COLLECTION[k].GetName()
    <span class="enscript-keyword">elif</span> k <span class="enscript-keyword">in</span> kcdata_type_def_rev:
        retval = kcdata_type_def_rev[k]
    <span class="enscript-keyword">return</span> retval


<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetTypeForName</span>(n):
    ret = 0
    <span class="enscript-keyword">if</span> n <span class="enscript-keyword">in</span> kcdata_type_def:
        ret = kcdata_type_def[n]
    <span class="enscript-keyword">return</span> ret


<span class="enscript-keyword">class</span> KCObject(object):
    <span class="enscript-string">&quot;&quot;&quot;
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__init__</span>(self, type_code, data, flags=0, field_name=<span class="enscript-string">''</span>):
        self.i_type = type_code
        self.i_data = data
        self.i_size = len(data)
        self.i_name = field_name
        self.i_flags = flags
        self.obj_collection = []
        self.obj = {}
        self.is_container_type = False
        self.is_array_type = False
        self.is_naked_type = False
        <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> field_name:
            self.i_name = GetTypeNameForKey(type_code)
        self.ParseData()

    @staticmethod
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">FromKCItem</span>(kcitem):
        <span class="enscript-keyword">return</span> KCObject(kcitem.i_type, kcitem.i_data, kcitem.i_flags)

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">IsContainerType</span>(self):
        <span class="enscript-keyword">return</span> self.is_container_type

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">IsContainerEnd</span>(self):
        <span class="enscript-keyword">if</span> self.i_type <span class="enscript-keyword">in</span> (GetTypeForName(<span class="enscript-string">'KCDATA_TYPE_CONTIANER_END'</span>), GetTypeForName(<span class="enscript-string">'KCDATA_TYPE_BUFFER_END'</span>)):
            <span class="enscript-keyword">return</span> True
        <span class="enscript-keyword">return</span> False

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetJsonRepr</span>(self):
        <span class="enscript-keyword">if</span> self.is_array_type:
            <span class="enscript-keyword">return</span> <span class="enscript-string">'['</span> + <span class="enscript-string">', '</span>.join([i.GetJsonRepr() <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> self.obj_collection]) + <span class="enscript-string">']'</span>
        <span class="enscript-comment">#if self.is_array_type:
</span>        <span class="enscript-comment">#    return '&quot;%s&quot; : [' % self.i_name + ', '.join([i.GetJsonRepr() for i in self.obj_collection]) + ']'
</span>        <span class="enscript-keyword">if</span> self.is_container_type:
            <span class="enscript-keyword">raise</span> NotImplementedError(<span class="enscript-string">&quot;Containter types should not have come here&quot;</span>)
        <span class="enscript-keyword">if</span> self.i_type <span class="enscript-keyword">in</span> KNOWN_TYPES_COLLECTION:
            <span class="enscript-keyword">return</span> KNOWN_TYPES_COLLECTION[self.i_type].GetJsonRepr(self.i_data)
        <span class="enscript-keyword">if</span> self.is_naked_type:
            <span class="enscript-keyword">return</span> json.dumps(self.obj)

        <span class="enscript-keyword">raise</span> NotImplementedError(<span class="enscript-string">&quot;Broken GetJsonRepr implementation&quot;</span>)

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">ParseData</span>(self):
        <span class="enscript-keyword">if</span> self.i_type == GetTypeForName(<span class="enscript-string">'KCDATA_TYPE_CONTAINER_BEGIN'</span>):
            self.is_container_type = True
            self.obj[<span class="enscript-string">'uniqID'</span>] = self.i_flags
            self.i_name = str(self.obj[<span class="enscript-string">'uniqID'</span>])
            self.obj[<span class="enscript-string">'typeID'</span>] = struct.unpack_from(<span class="enscript-string">'I'</span>, self.i_data)[0]

        <span class="enscript-keyword">elif</span> self.i_type <span class="enscript-keyword">in</span> (GetTypeForName(<span class="enscript-string">'KCDATA_BUFFER_BEGIN_CRASHINFO'</span>), GetTypeForName(<span class="enscript-string">'KCDATA_BUFFER_BEGIN_STACKSHOT'</span>)):
            self.is_container_type = True
            self.obj[<span class="enscript-string">'uniqID'</span>] = self.i_name
            self.obj[<span class="enscript-string">'typeID'</span>] = self.i_type

        <span class="enscript-keyword">elif</span> self.i_type == GetTypeForName(<span class="enscript-string">'KCDATA_TYPE_CONTIANER_END'</span>):
            self.obj[<span class="enscript-string">'uniqID'</span>] = self.i_flags

        <span class="enscript-keyword">elif</span> self.i_type == GetTypeForName(<span class="enscript-string">'KCDATA_TYPE_BUFFER_END'</span>):
            self.obj = <span class="enscript-string">''</span>

        <span class="enscript-keyword">elif</span> self.i_type == GetTypeForName(<span class="enscript-string">'KCDATA_TYPE_UINT32_DESC'</span>):
            self.is_naked_type = True
            u_d = struct.unpack_from(<span class="enscript-string">'32sI'</span>, self.i_data)
            self.i_name = u_d[0].strip(chr(0))
            self.obj = u_d[1]

        <span class="enscript-keyword">elif</span> self.i_type == GetTypeForName(<span class="enscript-string">'KCDATA_TYPE_UINT64_DESC'</span>):
            self.is_naked_type = True
            u_d = struct.unpack_from(<span class="enscript-string">'32sQ'</span>, self.i_data)
            self.i_name = u_d[0].strip(chr(0))
            self.obj = u_d[1]

        <span class="enscript-keyword">elif</span> self.i_type == GetTypeForName(<span class="enscript-string">'KCDATA_TYPE_TYPEDEFINTION'</span>):
            self.is_naked_type = True
            u_d = struct.unpack_from(<span class="enscript-string">'II32s'</span>, self.i_data)
            self.obj[<span class="enscript-string">'name'</span>] = u_d[2].strip(chr(0))
            self.i_name = <span class="enscript-string">&quot;typedef&lt;%s&gt;&quot;</span> % self.obj[<span class="enscript-string">'name'</span>]
            self.obj[<span class="enscript-string">'typeID'</span>] = u_d[0]
            self.obj[<span class="enscript-string">'numOfFields'</span>] = u_d[1]
            element_arr = []
            <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> range(u_d[1]):
                e = KCSubTypeElement.FromBinaryTypeData(self.i_data[40+(i*40):])
                <span class="enscript-comment">#print str(e)
</span>                element_arr.append(e)
            type_desc = KCTypeDescription(u_d[0], element_arr, self.obj[<span class="enscript-string">'name'</span>])
            <span class="enscript-comment">#print str(type_desc)
</span>            self.obj[<span class="enscript-string">'fields'</span>] = [str(e) <span class="enscript-keyword">for</span> e <span class="enscript-keyword">in</span> element_arr]
            KNOWN_TYPES_COLLECTION[type_desc.GetTypeID()] = type_desc

        <span class="enscript-keyword">elif</span> self.i_type == GetTypeForName(<span class="enscript-string">'KCDATA_TYPE_ARRAY'</span>):
            self.is_array_type = True
            e_t = (self.i_flags &gt;&gt; 32) &amp; 0xffffffff
            e_c = self.i_flags &amp; 0xffffffff
            e_s = self.i_size / e_c
            self.obj[<span class="enscript-string">'typeID'</span>] = e_t
            self.i_name = GetTypeNameForKey(e_t)
            self.i_type = e_t
            self.obj[<span class="enscript-string">'numOfElements'</span>] = e_c
            self.obj[<span class="enscript-string">'sizeOfElement'</span>] = e_s
            <span class="enscript-comment">#populate the array here by recursive creation of KCObject
</span>            <span class="enscript-keyword">for</span> _i <span class="enscript-keyword">in</span> range(e_c):
                _o = KCObject(e_t, self.i_data[(_i * e_s):(_i * e_s) + e_s])
                self.obj_collection.append(_o)
        <span class="enscript-keyword">elif</span> self.i_type <span class="enscript-keyword">in</span> KNOWN_TYPES_COLLECTION:
            self.i_name = KNOWN_TYPES_COLLECTION[self.i_type].GetName()
            self.is_naked_type = True
        <span class="enscript-keyword">else</span>:
            self.is_naked_type = True
            <span class="enscript-comment">#self.obj = &quot;data of len %d&quot; % len(self.i_data)
</span>            <span class="enscript-comment">#self.obj = ''.join([&quot;%x&quot; % ki for ki in struct.unpack('%dB' % len(self.i_data), self.i_data)])
</span>            self.obj = base64.b64encode(self.i_data)


<span class="enscript-keyword">class</span> KCContainerObject(KCObject):
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__init__</span>(self, *args, **kwargs):
        KCObject.__init__(self, *args, **kwargs)
        self.obj_container_dict = {}
        self.obj_nested_objs = {}

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetJsonRepr</span>(self):
        o = <span class="enscript-string">'&quot;%s&quot;'</span> % self.obj[<span class="enscript-string">'uniqID'</span>] + <span class="enscript-string">' : { &quot;typeID&quot; : %d ,'</span> % self.obj[<span class="enscript-string">'typeID'</span>]
        <span class="enscript-keyword">for</span> (k, v) <span class="enscript-keyword">in</span> self.obj_container_dict.items():
            <span class="enscript-keyword">if</span> v.IsContainerType():
                o += v.GetJsonRepr() + <span class="enscript-string">&quot;,&quot;</span>
            <span class="enscript-keyword">else</span>:
                o += <span class="enscript-string">' &quot;%s&quot; : '</span> % k + v.GetJsonRepr() + <span class="enscript-string">&quot;,&quot;</span>

        <span class="enscript-keyword">for</span> (k, v) <span class="enscript-keyword">in</span> self.obj_nested_objs.items():
            o += <span class="enscript-string">'&quot;%s&quot; : {'</span> % k + <span class="enscript-string">&quot;,&quot;</span>.join([vi.GetJsonRepr() <span class="enscript-keyword">for</span> vi <span class="enscript-keyword">in</span> v.values()]) + <span class="enscript-string">&quot;} ,&quot;</span>

        o = o.rstrip(<span class="enscript-string">','</span>) + <span class="enscript-string">&quot;}&quot;</span>

        <span class="enscript-keyword">return</span> o

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">AddObject</span>(self, kco):
        <span class="enscript-keyword">if</span> kco.IsContainerEnd():
            <span class="enscript-keyword">return</span>
        <span class="enscript-keyword">if</span> kco.IsContainerType():
            type_name = GetTypeNameForKey(kco.obj[<span class="enscript-string">'typeID'</span>])
            <span class="enscript-keyword">if</span> type_name <span class="enscript-keyword">not</span> <span class="enscript-keyword">in</span> self.obj_nested_objs:
                self.obj_nested_objs[type_name] = {}
            self.obj_nested_objs[type_name][kco.i_name] = kco
            <span class="enscript-keyword">return</span>
        self.obj_container_dict[kco.i_name] = kco


<span class="enscript-keyword">class</span> KCData_item:
    <span class="enscript-string">&quot;&quot;&quot; a basic kcdata_item type object.
    &quot;&quot;&quot;</span>
    header_size = 16  <span class="enscript-comment"># (uint32_t + uint32_t + uint64_t)
</span>
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__init__</span>(self, item_type, item_size, item_flags, item_data):
        self.i_type = item_type
        self.i_size = item_size
        self.i_flags = item_flags
        self.i_data = item_data
        self._buf_pos = None

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__init__</span>(self, barray, pos=0):
        <span class="enscript-string">&quot;&quot;&quot; create an object by parsing data from bytes array
            returns : obj - if data is readable
                      raises ValueError if something is not ok.
        &quot;&quot;&quot;</span>
        self.i_type = struct.unpack(<span class="enscript-string">'I'</span>, barray[pos:pos+4])[0]     <span class="enscript-comment"># int.from_bytes(barray[pos:pos+4])
</span>        self.i_size = struct.unpack(<span class="enscript-string">'I'</span>, barray[pos+4:pos+8])[0]   <span class="enscript-comment"># int.from_bytes(barray[pos+4:pos+8])
</span>        self.i_flags = struct.unpack(<span class="enscript-string">'Q'</span>, barray[pos+8:pos+16])[0]  <span class="enscript-comment"># int.from_bytes(barray[pos+8:pos+16])
</span>        self.i_data = barray[pos+16: (pos + 16 + self.i_size)]
        self._buf_pos = pos

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__len__</span>(self):
        <span class="enscript-keyword">return</span> self.i_size + KCData_item.header_size

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetHeaderDescription</span>(self):
        outs = <span class="enscript-string">&quot;type: 0x%x size: 0x%x flags: 0x%x&quot;</span> % (self.i_type, self.i_size, self.i_flags)
        <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> self._buf_pos <span class="enscript-keyword">is</span> None:
            outs = <span class="enscript-string">&quot;pos: 0x%x&quot;</span> % self._buf_pos + outs
        <span class="enscript-keyword">return</span> outs

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__str__</span>(self):
        <span class="enscript-keyword">return</span> self.GetHeaderDescription()


<span class="enscript-keyword">def</span> <span class="enscript-function-name">kcdata_item_iterator</span>(filename):
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> filename:
        <span class="enscript-keyword">return</span>
    with open(filename, <span class="enscript-string">&quot;r+b&quot;</span>) as f:
        fmap = mmap.mmap(f.fileno(), 0)
        file_len = len(fmap)
        curpos = 0
        <span class="enscript-keyword">while</span> curpos &lt; file_len:
            item = KCData_item(fmap, curpos)
            <span class="enscript-keyword">yield</span> item
            curpos += len(item)
        fmap.close()


<span class="enscript-keyword">def</span> <span class="enscript-function-name">_get_data_element</span>(elementValues):
    <span class="enscript-keyword">return</span> json.dumps(elementValues[-1])

KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'KCDATA_TYPE_UINT32_DESC'</span>)] = KCTypeDescription(GetTypeForName(<span class="enscript-string">'KCDATA_TYPE_UINT32_DESC'</span>), (
    KCSubTypeElement(<span class="enscript-string">'desc'</span>, KCSUBTYPE_TYPE.KC_ST_CHAR, KCSubTypeElement.GetSizeForArray(32, 1), 0, 1),
    KCSubTypeElement(<span class="enscript-string">'data'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 4, 32, 0)
),
    <span class="enscript-string">'KCDATA_TYPE_UINT32_DESC'</span>,
    _get_data_element
)

KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'KCDATA_TYPE_UINT64_DESC'</span>)] = KCTypeDescription(GetTypeForName(<span class="enscript-string">'KCDATA_TYPE_UINT64_DESC'</span>), (
    KCSubTypeElement(<span class="enscript-string">'desc'</span>, KCSUBTYPE_TYPE.KC_ST_CHAR, KCSubTypeElement.GetSizeForArray(32, 1), 0, 1),
    KCSubTypeElement(<span class="enscript-string">'data'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 8, 32, 0)
),
    <span class="enscript-string">'KCDATA_TYPE_UINT64_DESC'</span>,
    _get_data_element
)

KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'KCDATA_TYPE_TIMEBASE'</span>)] = KCTypeDescription(GetTypeForName(<span class="enscript-string">'KCDATA_TYPE_TIMEBASE'</span>), (
    KCSubTypeElement(<span class="enscript-string">'numerator'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 4, 0, 0),
    KCSubTypeElement(<span class="enscript-string">'denominator'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 8, 4, 0)
),
    <span class="enscript-string">'timebase_info'</span>
)


STACKSHOT_IO_NUM_PRIORITIES = 4
KNOWN_TYPES_COLLECTION[0x901] = KCTypeDescription(0x901, (
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'disk_reads_count'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 0),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'disk_reads_size'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 8),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'disk_writes_count'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 16),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'disk_writes_size'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 24),
    KCSubTypeElement(<span class="enscript-string">'io_priority_count'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, KCSubTypeElement.GetSizeForArray(STACKSHOT_IO_NUM_PRIORITIES, 8), 32, 1),
    KCSubTypeElement(<span class="enscript-string">'io_priority_size'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, KCSubTypeElement.GetSizeForArray(STACKSHOT_IO_NUM_PRIORITIES, 8), 32 + (STACKSHOT_IO_NUM_PRIORITIES * 8), 1),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'paging_count'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 32 + 2 * (STACKSHOT_IO_NUM_PRIORITIES * 8)),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'paging_size'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 40 + 2 * (STACKSHOT_IO_NUM_PRIORITIES * 8)),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'non_paging_count'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 48 + 2 * (STACKSHOT_IO_NUM_PRIORITIES * 8)),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'non_paging_size'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 56 + 2 * (STACKSHOT_IO_NUM_PRIORITIES * 8)),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'data_count'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 64 + 2 * (STACKSHOT_IO_NUM_PRIORITIES * 8)),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'data_size'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 72 + 2 * (STACKSHOT_IO_NUM_PRIORITIES * 8)),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'metadata_count'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 80 + 2 * (STACKSHOT_IO_NUM_PRIORITIES * 8)),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'metadata_size'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 88 + 2 * (STACKSHOT_IO_NUM_PRIORITIES * 8))
),
    <span class="enscript-string">'io_statistics'</span>
)

KNOWN_TYPES_COLLECTION[0x902] = KCTypeDescription(0x902, (
    KCSubTypeElement(<span class="enscript-string">'snapshot_magic'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 4, 4 * 0, 0),
    KCSubTypeElement(<span class="enscript-string">'free_pages'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 4, 4 * 1, 0),
    KCSubTypeElement(<span class="enscript-string">'active_pages'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 4, 4 * 2, 0),
    KCSubTypeElement(<span class="enscript-string">'inactive_pages'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 4, 4 * 3, 0),
    KCSubTypeElement(<span class="enscript-string">'purgeable_pages'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 4, 4 * 4, 0),
    KCSubTypeElement(<span class="enscript-string">'wired_pages'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 4, 4 * 5, 0),
    KCSubTypeElement(<span class="enscript-string">'speculative_pages'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 4, 4 * 6, 0),
    KCSubTypeElement(<span class="enscript-string">'throttled_pages'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 4, 4 * 7, 0),
    KCSubTypeElement(<span class="enscript-string">'filebacked_pages'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 4, 4 * 8, 0),
    KCSubTypeElement(<span class="enscript-string">'compressions'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 4, 4 * 9, 0),
    KCSubTypeElement(<span class="enscript-string">'decompressions'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 4, 4 * 10, 0),
    KCSubTypeElement(<span class="enscript-string">'compressor_size'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 4, 4 * 11, 0),
    KCSubTypeElement(<span class="enscript-string">'busy_buffer_count'</span>, KCSUBTYPE_TYPE.KC_ST_INT32, 4, 4 * 12, 0),
    KCSubTypeElement(<span class="enscript-string">'pages_wanted'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 4, 4 * 13, 0),
    KCSubTypeElement(<span class="enscript-string">'pages_reclaimed'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 4, 4 * 14, 0),
    KCSubTypeElement(<span class="enscript-string">'pages_wanted_reclaimed_valid'</span>, KCSUBTYPE_TYPE.KC_ST_UINT8, 1, 4 * 15, 0)
),
    <span class="enscript-string">'mem_and_io_snapshot'</span>
)


KNOWN_TYPES_COLLECTION[0x905] = KCTypeDescription(0x905, (
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'unique_pid'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 0),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ss_flags'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 8),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'user_time_in_terminated_threads'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 16),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'system_time_in_terminated_threads'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 24),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'p_start_sec'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 32),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'task_size'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 40),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'task_max_resident_size'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 48),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'suspend_count'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 56),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'faults'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 60),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'pageins'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 64),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'cow_faults'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 68),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'was_throttled'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 72),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'did_throttle'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 76),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'latency_qos'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 80),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'pid'</span>, KCSUBTYPE_TYPE.KC_ST_INT32, 84),
    KCSubTypeElement(<span class="enscript-string">'p_comm'</span>, KCSUBTYPE_TYPE.KC_ST_CHAR, KCSubTypeElement.GetSizeForArray(32, 1), 88, 1)
),
    <span class="enscript-string">'task_snapshot_v2'</span>
)

KNOWN_TYPES_COLLECTION[0x906] = KCTypeDescription(0x906, (
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'thread_id'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 0),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'wait_event'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 8),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'continuation'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 16),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'total_syscalls'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 24),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'voucher_identifier'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 32),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'dqserialnum'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 40),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'user_time'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 48),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'sys_time'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 56),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ss_flags'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 64),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'last_run_time'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 72),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'last_made_runnable_time'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 80),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'state'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 88),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'sched_flags'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 92),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'base_priority'</span>, KCSUBTYPE_TYPE.KC_ST_INT16, 96),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'sched_priority'</span>, KCSUBTYPE_TYPE.KC_ST_INT16, 98),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ts_eqos'</span>, KCSUBTYPE_TYPE.KC_ST_UINT8, 100),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ts_rqos'</span>, KCSUBTYPE_TYPE.KC_ST_UINT8, 101),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ts_rqos_override'</span>, KCSUBTYPE_TYPE.KC_ST_UINT8, 102),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'io_tier'</span>, KCSUBTYPE_TYPE.KC_ST_UINT8, 103),
),
    <span class="enscript-string">'thread_snapshot_v2'</span>
)

KNOWN_TYPES_COLLECTION[0x909] = KCSubTypeElement(<span class="enscript-string">'pth_name'</span>, KCSUBTYPE_TYPE.KC_ST_CHAR, KCSubTypeElement.GetSizeForArray(64, 1), 0, 1)


<span class="enscript-keyword">def</span> <span class="enscript-function-name">_get_uuid_json_data</span>(elementValues, elementName):
    <span class="enscript-keyword">return</span> <span class="enscript-string">'&quot;&lt;%s&gt;&quot;'</span> % <span class="enscript-string">''</span>.join(<span class="enscript-string">&quot;%02x&quot;</span> % i <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> elementValues)

KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'KCDATA_TYPE_LIBRARY_LOADINFO64'</span>)] = KCTypeDescription(GetTypeForName(<span class="enscript-string">'KCDATA_TYPE_LIBRARY_LOADINFO64'</span>), (
    KCSubTypeElement(<span class="enscript-string">'loadAddress'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 8, 0, 0),
    KCSubTypeElement(<span class="enscript-string">'imageUUID'</span>, KCSUBTYPE_TYPE.KC_ST_UINT8, KCSubTypeElement.GetSizeForArray(16, 1), 8, 1, _get_uuid_json_data)
),
    <span class="enscript-string">'dyld_load_info'</span>
)

KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'KCDATA_TYPE_LIBRARY_LOADINFO'</span>)] = KCTypeDescription(GetTypeForName(<span class="enscript-string">'KCDATA_TYPE_LIBRARY_LOADINFO'</span>), (
    KCSubTypeElement(<span class="enscript-string">'loadAddress'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 4, 0, 0),
    KCSubTypeElement(<span class="enscript-string">'imageUUID'</span>, KCSUBTYPE_TYPE.KC_ST_UINT8, KCSubTypeElement.GetSizeForArray(16, 1), 4, 1, _get_uuid_json_data)
),
    <span class="enscript-string">'dyld_load_info'</span>
)

KNOWN_TYPES_COLLECTION[0x908] = KCTypeDescription.FromKCTypeDescription(KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'KCDATA_TYPE_LIBRARY_LOADINFO64'</span>)], 0x908, <span class="enscript-string">'shared_cache_dyld_info'</span>)

KNOWN_TYPES_COLLECTION[0x33] = KCSubTypeElement(<span class="enscript-string">'mach_absolute_time'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 8, 0, 0, KCSubTypeElement._get_naked_element_value)
KNOWN_TYPES_COLLECTION[0x907] = KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'donating_pids'</span>, KCSUBTYPE_TYPE.KC_ST_INT32)

KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'KCDATA_TYPE_USECS_SINCE_EPOCH'</span>)] = KCSubTypeElement(<span class="enscript-string">'usecs_since_epoch'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 8, 0, 0, KCSubTypeElement._get_naked_element_value)

KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'STACKSHOT_KCTYPE_KERN_STACKFRAME'</span>)] = KCTypeDescription(GetTypeForName(<span class="enscript-string">'STACKSHOT_KCTYPE_KERN_STACKFRAME'</span>), (
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'lr'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'sp'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 4)
),
    <span class="enscript-string">'kernel_stack_frames'</span>
)

KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'STACKSHOT_KCTYPE_USER_STACKFRAME'</span>)] = KCTypeDescription.FromKCTypeDescription(
    KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'STACKSHOT_KCTYPE_KERN_STACKFRAME'</span>)],
    GetTypeForName(<span class="enscript-string">'STACKSHOT_KCTYPE_USER_STACKFRAME'</span>),
    <span class="enscript-string">'user_stack_frames'</span>
)

KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'STACKSHOT_KCTYPE_KERN_STACKFRAME64'</span>)] = KCTypeDescription(GetTypeForName(<span class="enscript-string">'STACKSHOT_KCTYPE_KERN_STACKFRAME64'</span>), (
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'lr'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64),
    KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'sp'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 8)
),
    <span class="enscript-string">'kernel_stack_frames'</span>
)

KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'STACKSHOT_KCTYPE_USER_STACKFRAME64'</span>)] = KCTypeDescription.FromKCTypeDescription(
    KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'STACKSHOT_KCTYPE_KERN_STACKFRAME64'</span>)],
    GetTypeForName(<span class="enscript-string">'STACKSHOT_KCTYPE_USER_STACKFRAME64'</span>),
    <span class="enscript-string">'user_stack_frames'</span>
)

KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'STACKSHOT_KCTYPE_OSVERSION'</span>)] = KCSubTypeElement(<span class="enscript-string">'osversion'</span>, KCSUBTYPE_TYPE.KC_ST_CHAR,
                          KCSubTypeElement.GetSizeForArray(256, 1), 0, 1)

KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'STACKSHOT_KCTYPE_BOOTARGS'</span>)] = KCSubTypeElement(<span class="enscript-string">'bootargs'</span>, KCSUBTYPE_TYPE.KC_ST_CHAR,
                           KCSubTypeElement.GetSizeForArray(256, 1), 0, 1)

KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'STACKSHOT_KCTYPE_KERN_PAGE_SIZE'</span>)] = KCSubTypeElement(<span class="enscript-string">'kernel_page_size'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 4, 0, 0, KCSubTypeElement._get_naked_element_value)

KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'STACKSHOT_KCTYPE_JETSAM_LEVEL'</span>)] = KCSubTypeElement(<span class="enscript-string">'jetsam_level'</span>, KCSUBTYPE_TYPE.KC_ST_UINT32, 4, 0, 0, KCSubTypeElement._get_naked_element_value)


<span class="enscript-comment">#KNOWN_TYPES_COLLECTION[0x907] = KCSubTypeElement('donating_pids', KCSUBTYPE_TYPE.KC_ST_UINT32, 4, 0, 0, KCSubTypeElement._get_naked_element_value)
</span>KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'TASK_CRASHINFO_PID'</span>)] = KCSubTypeElement(<span class="enscript-string">'pid'</span>, KCSUBTYPE_TYPE.KC_ST_INT32, 4, 0, 0)
KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'TASK_CRASHINFO_PPID'</span>)] = KCSubTypeElement(<span class="enscript-string">'ppid'</span>, KCSUBTYPE_TYPE.KC_ST_INT32, 4, 0, 0)
KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'TASK_CRASHINFO_PROC_NAME'</span>)] = KCSubTypeElement(<span class="enscript-string">'p_comm'</span>, KCSUBTYPE_TYPE.KC_ST_CHAR,
                           KCSubTypeElement.GetSizeForArray(32, 1), 0, 1)
KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'TASK_CRASHINFO_USERSTACK'</span>)] = KCSubTypeElement(<span class="enscript-string">'userstack_ptr'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 8, 0, 0)
KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'TASK_CRASHINFO_ARGSLEN'</span>)] = KCSubTypeElement(<span class="enscript-string">'p_argslen'</span>, KCSUBTYPE_TYPE.KC_ST_INT32, 4, 0, 0)

KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'TASK_CRASHINFO_PROC_PATH'</span>)] = KCSubTypeElement(<span class="enscript-string">'p_path'</span>, KCSUBTYPE_TYPE.KC_ST_CHAR,
                           KCSubTypeElement.GetSizeForArray(1024, 1), 0, 1)
KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'TASK_CRASHINFO_PROC_CSFLAGS'</span>)] = KCSubTypeElement(<span class="enscript-string">'p_csflags'</span>, KCSUBTYPE_TYPE.KC_ST_INT32, 4, 0, 0)
KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'TASK_CRASHINFO_UID'</span>)] = KCSubTypeElement(<span class="enscript-string">'uid'</span>, KCSUBTYPE_TYPE.KC_ST_INT32, 4, 0, 0)
KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'TASK_CRASHINFO_GID'</span>)] = KCSubTypeElement(<span class="enscript-string">'gid'</span>, KCSUBTYPE_TYPE.KC_ST_INT32, 4, 0, 0)
KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'TASK_CRASHINFO_PROC_ARGC'</span>)] = KCSubTypeElement(<span class="enscript-string">'argc'</span>, KCSUBTYPE_TYPE.KC_ST_INT32, 4, 0, 0)
KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'TASK_CRASHINFO_PROC_FLAGS'</span>)] = KCSubTypeElement(<span class="enscript-string">'p_flags'</span>, KCSUBTYPE_TYPE.KC_ST_INT32, 4, 0, 0)
KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'TASK_CRASHINFO_CPUTYPE'</span>)] = KCSubTypeElement(<span class="enscript-string">'cputype'</span>, KCSUBTYPE_TYPE.KC_ST_INT32, 4, 0, 0)
KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'TASK_CRASHINFO_RESPONSIBLE_PID'</span>)] = KCSubTypeElement(<span class="enscript-string">'responsible_pid'</span>, KCSUBTYPE_TYPE.KC_ST_INT32, 4, 0, 0)
KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'TASK_CRASHINFO_DIRTY_FLAGS'</span>)] = KCSubTypeElement(<span class="enscript-string">'dirty_flags'</span>, KCSUBTYPE_TYPE.KC_ST_INT32, 4, 0, 0)
KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'TASK_CRASHINFO_CRASHED_THREADID'</span>)] = KCSubTypeElement(<span class="enscript-string">'crashed_threadid'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 8, 0, 0)

KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'TASK_CRASHINFO_PROC_STATUS'</span>)] = KCSubTypeElement(<span class="enscript-string">'p_status'</span>, KCSUBTYPE_TYPE.KC_ST_UINT8, 1, 0, 0)

KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'TASK_CRASHINFO_BSDINFOWITHUNIQID'</span>)] = KCTypeDescription(GetTypeForName(<span class="enscript-string">'TASK_CRASHINFO_BSDINFOWITHUNIQID'</span>),
    (   KCSubTypeElement(<span class="enscript-string">'p_uuid'</span>, KCSUBTYPE_TYPE.KC_ST_UINT8, KCSubTypeElement.GetSizeForArray(16, 1), 0, 1),
        KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'p_uniqueid'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 16),
        KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'p_puniqueid'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 24)
    ),
    <span class="enscript-string">'proc_uniqidentifierinfo'</span>)

KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'TASK_CRASHINFO_EXCEPTION_CODES'</span>)] = KCSubTypeElement(<span class="enscript-string">'TASK_CRASHINFO_EXCEPTION_CODES'</span>, KCSUBTYPE_TYPE.KC_ST_INT64,
    KCSubTypeElement.GetSizeForArray(2,8), 0, 1)

KNOWN_TYPES_COLLECTION[GetTypeForName(<span class="enscript-string">'TASK_CRASHINFO_RUSAGE_INFO'</span>)] = KCTypeDescription(GetTypeForName(<span class="enscript-string">'TASK_CRASHINFO_RUSAGE_INFO'</span>),
    (
        KCSubTypeElement(<span class="enscript-string">'ri_uuid'</span>, KCSUBTYPE_TYPE.KC_ST_UINT8, KCSubTypeElement.GetSizeForArray(16, 1), 0, 1),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_user_time'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 16),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_system_time'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 24),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_pkg_idle_wkups'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 32),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_interrupt_wkups'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 40),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_pageins'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 48),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_wired_size'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 56),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_resident_size'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 64),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_phys_footprint'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 72),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_proc_start_abstime'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 80),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_proc_exit_abstime'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 88),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_child_user_time'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 96),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_child_system_time'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 104),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_child_pkg_idle_wkups'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 112),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_child_interrupt_wkups'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 120),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_child_pageins'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 128),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_child_elapsed_abstime'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 136),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_diskio_bytesread'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 144),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_diskio_byteswritten'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 152),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_cpu_time_qos_default'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 160),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_cpu_time_qos_maintenance'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 168),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_cpu_time_qos_background'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 176),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_cpu_time_qos_utility'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 184),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_cpu_time_qos_legacy'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 192),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_cpu_time_qos_user_initiated'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 200),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_cpu_time_qos_user_interactive'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 208),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_billed_system_time'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 216),
            KCSubTypeElement.FromBasicCtype(<span class="enscript-string">'ri_serviced_system_time'</span>, KCSUBTYPE_TYPE.KC_ST_UINT64, 224)
    ),
    <span class="enscript-string">'rusage_info_v3'</span>)

<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetSecondsFromMATime</span>(mat, tb):
    <span class="enscript-keyword">return</span> (float(mat) * tb[<span class="enscript-string">'numerator'</span>]) / tb[<span class="enscript-string">'denominator'</span>]

<span class="enscript-keyword">def</span> <span class="enscript-function-name">FindLibraryForAddress</span>(liblist, address):
    current_lib = None
    <span class="enscript-keyword">for</span> l <span class="enscript-keyword">in</span> liblist:
        <span class="enscript-keyword">if</span> address &gt;= l[1]:
            current_lib = l
    <span class="enscript-keyword">return</span> current_lib

<span class="enscript-keyword">def</span> <span class="enscript-function-name">FindIndexOfLibInCatalog</span>(catalog, lib):
    index = None
    i = 0
    <span class="enscript-keyword">for</span> l <span class="enscript-keyword">in</span> catalog:
        <span class="enscript-keyword">if</span> l[0] == lib[0] <span class="enscript-keyword">and</span> l[1] == lib[1]:
            index = i
            <span class="enscript-keyword">break</span>
        i += 1

    <span class="enscript-keyword">if</span> index <span class="enscript-keyword">is</span> None:
        catalog.append(lib)
        index = len(catalog) - 1

    <span class="enscript-keyword">return</span> index

<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetOffsetOfAddressForLib</span>(lib, address):
    <span class="enscript-keyword">return</span> (address - lib[1])

<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetSymbolInfoForFrame</span>(catalog, liblist, address):
    lib = FindLibraryForAddress(liblist, address)
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> lib:
        lib = [<span class="enscript-string">&quot;00000000000000000000000000000000&quot;</span>,0,<span class="enscript-string">&quot;A&quot;</span>]
    offset = GetOffsetOfAddressForLib(lib, address)
    index = FindIndexOfLibInCatalog(catalog, lib)
    <span class="enscript-keyword">return</span> [index, offset]

<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetStateDescription</span>(s):
    retval = []
    TH_WAIT = 0x01
    TH_SUSP = 0x02
    TH_RUN = 0x04
    TH_UNINT = 0x08
    TH_TERMINATE = 0x10
    TH_TERMINATE2 = 0x20
    TH_IDLE = 0x80
    <span class="enscript-keyword">if</span> (s &amp; TH_WAIT):
        retval.append(<span class="enscript-string">&quot;TH_WAIT&quot;</span>)
    <span class="enscript-keyword">if</span> (s &amp; TH_SUSP):
        retval.append(<span class="enscript-string">&quot;TH_SUSP&quot;</span>)
    <span class="enscript-keyword">if</span> (s &amp; TH_RUN):
        retval.append(<span class="enscript-string">&quot;TH_RUN&quot;</span>)
    <span class="enscript-keyword">if</span> (s &amp; TH_UNINT):
        retval.append(<span class="enscript-string">&quot;TH_UNINT&quot;</span>)
    <span class="enscript-keyword">if</span> (s &amp; TH_TERMINATE):
        retval.append(<span class="enscript-string">&quot;TH_TERMINATE&quot;</span>)
    <span class="enscript-keyword">if</span> (s &amp; TH_TERMINATE2):
        retval.append(<span class="enscript-string">&quot;TH_TERMINATE2&quot;</span>)
    <span class="enscript-keyword">if</span> (s &amp; TH_IDLE):
        retval.append(<span class="enscript-string">&quot;TH_IDLE&quot;</span>)
    <span class="enscript-keyword">return</span> retval

<span class="enscript-keyword">def</span> <span class="enscript-function-name">SaveStackshotReport</span>(j, outfile_name, dsc_uuid, dsc_libs_arr):
    <span class="enscript-keyword">import</span> time
    <span class="enscript-keyword">from</span> operator <span class="enscript-keyword">import</span> itemgetter, attrgetter
    ss = j.get(<span class="enscript-string">'KCDATA_BUFFER_BEGIN_STACKSHOT'</span>)
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> ss:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;No KCDATA_BUFFER_BEGIN_STACKSHOT object found. Skipping writing report.&quot;</span>
        <span class="enscript-keyword">return</span>
    timestamp = ss.get(<span class="enscript-string">'usecs_since_epoch'</span>, int(time.time()))
    timestamp = time.strftime(<span class="enscript-string">&quot;%Y-%m-%d %H:%M:%S %z&quot;</span>,time.gmtime(timestamp))
    os_version = ss.get(<span class="enscript-string">'osversion'</span>, <span class="enscript-string">'Unknown'</span>)
    timebase = ss.get(<span class="enscript-string">'timebase_info'</span>, {<span class="enscript-string">&quot;denominator&quot;</span>: 1, <span class="enscript-string">&quot;numerator&quot;</span>: 1})
    dsc_common = [ss.get(<span class="enscript-string">'shared_cache_dyld_info'</span>)[<span class="enscript-string">'imageUUID'</span>].strip(<span class="enscript-string">'&lt;&gt;'</span>),
                  ss.get(<span class="enscript-string">'shared_cache_dyld_info'</span>)[<span class="enscript-string">'loadAddress'</span>],
                  <span class="enscript-string">&quot;C&quot;</span>
                 ]

    dsc_libs = []
    <span class="enscript-keyword">if</span> dsc_common[0].replace(<span class="enscript-string">'-'</span>, <span class="enscript-string">''</span>).lower() == dsc_uuid:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;SUCCESS: Found Matching dyld shared cache uuid. Loading library load addresses from layout provided.&quot;</span>
        _load_addr = dsc_common[1]
        <span class="enscript-comment">#print _load_addr
</span>        <span class="enscript-comment">#print dsc_libs_arr
</span>        <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> dsc_libs_arr:
            _uuid = i[2].lower().replace(<span class="enscript-string">'-'</span>,<span class="enscript-string">''</span>).strip()
            _addr = int(i[0], 16) + _load_addr
            dsc_libs.append([_uuid, _addr, <span class="enscript-string">&quot;P&quot;</span>])
            <span class="enscript-comment">#print &quot;adding &quot;, [_uuid, _addr, &quot;C&quot;]
</span>
    AllImageCatalog = []
    obj = {}
    obj[<span class="enscript-string">&quot;kernel&quot;</span>] = os_version
    obj[<span class="enscript-string">&quot;date&quot;</span>] = timestamp
    obj[<span class="enscript-string">&quot;reason&quot;</span>] = <span class="enscript-string">&quot;kernel panic stackshot&quot;</span>
    obj[<span class="enscript-string">&quot;incident&quot;</span>] = <span class="enscript-string">&quot;ABCDEFGH-1234-56IJ-789K-0LMNOPQRSTUV&quot;</span>
    obj[<span class="enscript-string">&quot;crashReporterKey&quot;</span>] = <span class="enscript-string">&quot;12ab34cd45aabbccdd6712ab34cd45aabbccdd67&quot;</span>
    obj[<span class="enscript-string">&quot;bootArgs&quot;</span>] = ss.get(<span class="enscript-string">'bootargs'</span>,<span class="enscript-string">''</span>)
    obj[<span class="enscript-string">&quot;frontmostPids&quot;</span>] = [0]
    obj[<span class="enscript-string">&quot;exception&quot;</span>] = <span class="enscript-string">&quot;0xDEADF157&quot;</span>
    obj[<span class="enscript-string">&quot;processByPid&quot;</span>] = {}
    processByPid = obj[<span class="enscript-string">&quot;processByPid&quot;</span>]
    ssplist = ss.get(<span class="enscript-string">'STACKSHOT_KCCONTAINER_TASK'</span>, {})
    kern_load_info = []
    <span class="enscript-keyword">if</span> <span class="enscript-string">&quot;0&quot;</span> <span class="enscript-keyword">in</span> ssplist:
        kl_infos = ssplist[<span class="enscript-string">&quot;0&quot;</span>].get(<span class="enscript-string">&quot;dyld_load_info&quot;</span>, [])
        <span class="enscript-keyword">for</span> dlinfo <span class="enscript-keyword">in</span> kl_infos:
            kern_load_info.append([dlinfo[<span class="enscript-string">'imageUUID'</span>].strip(<span class="enscript-string">'&lt;&gt;'</span>), dlinfo[<span class="enscript-string">'loadAddress'</span>], <span class="enscript-string">&quot;K&quot;</span>])
    <span class="enscript-keyword">for</span> pid,piddata <span class="enscript-keyword">in</span> ssplist.iteritems():
        processByPid[str(pid)] = {}
        tsnap = processByPid[str(pid)]
        pr_lib_dsc = dsc_common
        <span class="enscript-keyword">if</span> <span class="enscript-string">'shared_cache_dyld_info'</span> <span class="enscript-keyword">in</span> tsnap:
            pr_lib_dsc = [tsnap.get(<span class="enscript-string">'shared_cache_dyld_info'</span>)[<span class="enscript-string">'imageUUID'</span>].strip(<span class="enscript-string">'&lt;&gt;'</span>),
                          tsnap.get(<span class="enscript-string">'shared_cache_dyld_info'</span>)[<span class="enscript-string">'loadAddress'</span>],
                          <span class="enscript-string">&quot;C&quot;</span>
                         ]

        pr_libs = []
        <span class="enscript-keyword">if</span> len(dsc_libs) == 0:
            pr_libs.append(pr_lib_dsc)
        _lib_type = <span class="enscript-string">&quot;P&quot;</span>
        <span class="enscript-keyword">if</span> int(pid) == 0:
            _lib_type = <span class="enscript-string">&quot;K&quot;</span>
            pr_libs = []
        <span class="enscript-keyword">else</span>:
            <span class="enscript-keyword">for</span> dlinfo <span class="enscript-keyword">in</span> piddata.get(<span class="enscript-string">'dyld_load_info'</span>,[]):
                pr_libs.append([dlinfo[<span class="enscript-string">'imageUUID'</span>].strip(<span class="enscript-string">'&lt;&gt;'</span>), dlinfo[<span class="enscript-string">'loadAddress'</span>], _lib_type])

        pr_libs.extend(kern_load_info)
        pr_libs.extend(dsc_libs)

        pr_libs.sort(key=itemgetter(1))

        tasksnap = piddata[<span class="enscript-string">'task_snapshot_v2'</span>]
        tsnap[<span class="enscript-string">&quot;pid&quot;</span>] = tasksnap[<span class="enscript-string">&quot;pid&quot;</span>]
        tsnap[<span class="enscript-string">&quot;residentMemoryBytes&quot;</span>] = tasksnap[<span class="enscript-string">&quot;task_size&quot;</span>]
        tsnap[<span class="enscript-string">&quot;timesDidThrottle&quot;</span>] = tasksnap[<span class="enscript-string">&quot;did_throttle&quot;</span>]
        tsnap[<span class="enscript-string">&quot;systemTimeTask&quot;</span>] = GetSecondsFromMATime(tasksnap[<span class="enscript-string">&quot;system_time_in_terminated_threads&quot;</span>], timebase)
        tsnap[<span class="enscript-string">&quot;pageIns&quot;</span>] = tasksnap[<span class="enscript-string">&quot;pageins&quot;</span>]
        tsnap[<span class="enscript-string">&quot;pageFaults&quot;</span>] = tasksnap[<span class="enscript-string">&quot;faults&quot;</span>]
        tsnap[<span class="enscript-string">&quot;userTimeTask&quot;</span>] = GetSecondsFromMATime(tasksnap[<span class="enscript-string">&quot;user_time_in_terminated_threads&quot;</span>], timebase)
        tsnap[<span class="enscript-string">&quot;procname&quot;</span>] = tasksnap[<span class="enscript-string">&quot;p_comm&quot;</span>]
        tsnap[<span class="enscript-string">&quot;copyOnWriteFaults&quot;</span>] = tasksnap[<span class="enscript-string">&quot;cow_faults&quot;</span>]
        tsnap[<span class="enscript-string">&quot;timesThrottled&quot;</span>] = tasksnap[<span class="enscript-string">&quot;was_throttled&quot;</span>]
        tsnap[<span class="enscript-string">&quot;threadById&quot;</span>] = {}
        threadByID = tsnap[<span class="enscript-string">&quot;threadById&quot;</span>]
        thlist = piddata.get(<span class="enscript-string">'STACKSHOT_KCCONTAINER_THREAD'</span>, {})
        <span class="enscript-keyword">for</span> tid,thdata <span class="enscript-keyword">in</span> thlist.iteritems():
            threadByID[str(tid)] = {}
            thsnap = threadByID[str(tid)]
            threadsnap = thdata[<span class="enscript-string">&quot;thread_snapshot_v2&quot;</span>]
            thsnap[<span class="enscript-string">&quot;userTime&quot;</span>] = GetSecondsFromMATime(threadsnap[<span class="enscript-string">&quot;user_time&quot;</span>], timebase)
            thsnap[<span class="enscript-string">&quot;id&quot;</span>] = threadsnap[<span class="enscript-string">&quot;thread_id&quot;</span>]
            thsnap[<span class="enscript-string">&quot;basePriority&quot;</span>] = threadsnap[<span class="enscript-string">&quot;base_priority&quot;</span>]
            thsnap[<span class="enscript-string">&quot;systemTime&quot;</span>] = threadsnap[<span class="enscript-string">&quot;sys_time&quot;</span>]
            thsnap[<span class="enscript-string">&quot;schedPriority&quot;</span>] = threadsnap[<span class="enscript-string">&quot;sched_priority&quot;</span>]
            thsnap[<span class="enscript-string">&quot;state&quot;</span>] = GetStateDescription(threadsnap[<span class="enscript-string">'state'</span>])
            thsnap[<span class="enscript-string">&quot;qosEffective&quot;</span>] = threadsnap[<span class="enscript-string">&quot;ts_eqos&quot;</span>]
            thsnap[<span class="enscript-string">&quot;qosRequested&quot;</span>] = threadsnap[<span class="enscript-string">&quot;ts_rqos&quot;</span>]

            <span class="enscript-keyword">if</span> threadsnap[<span class="enscript-string">'continuation'</span>]:
                thsnap[<span class="enscript-string">&quot;continuation&quot;</span>] = GetSymbolInfoForFrame(AllImageCatalog, pr_libs, threadsnap[<span class="enscript-string">'continuation'</span>])
            <span class="enscript-keyword">if</span> <span class="enscript-string">&quot;kernel_stack_frames&quot;</span> <span class="enscript-keyword">in</span> thdata:
                kuserframes = []
                <span class="enscript-keyword">for</span> f <span class="enscript-keyword">in</span> thdata[<span class="enscript-string">&quot;kernel_stack_frames&quot;</span>]:
                    kuserframes.append(GetSymbolInfoForFrame(AllImageCatalog, pr_libs, f[<span class="enscript-string">'lr'</span>]))
                thsnap[<span class="enscript-string">&quot;kernelFrames&quot;</span>] = kuserframes

            <span class="enscript-keyword">if</span> <span class="enscript-string">&quot;user_stack_frames&quot;</span> <span class="enscript-keyword">in</span> thdata:
                uframes = []
                <span class="enscript-keyword">for</span> f <span class="enscript-keyword">in</span> thdata[<span class="enscript-string">&quot;user_stack_frames&quot;</span>]:
                    uframes.append(GetSymbolInfoForFrame(AllImageCatalog, pr_libs, f[<span class="enscript-string">'lr'</span>]))
                thsnap[<span class="enscript-string">&quot;userFrames&quot;</span>] = uframes
            <span class="enscript-keyword">if</span> threadsnap[<span class="enscript-string">'wait_event'</span>]:
                thsnap[<span class="enscript-string">&quot;waitEvent&quot;</span>] = GetSymbolInfoForFrame(AllImageCatalog, pr_libs, threadsnap[<span class="enscript-string">'wait_event'</span>])

    obj[<span class="enscript-string">'binaryImages'</span>] = AllImageCatalog
    fh = open(outfile_name, <span class="enscript-string">&quot;w&quot;</span>)
    fh.write(<span class="enscript-string">'{&quot;bug_type&quot;:&quot;288&quot;, &quot;timestamp&quot;:&quot;'</span>+ timestamp +<span class="enscript-string">'&quot;, &quot;os_version&quot;:&quot;'</span>+ os_version +<span class="enscript-string">'&quot;}\n'</span>)
    fh.write(json.dumps(obj, sort_keys=False, indent=2, separators=(<span class="enscript-string">','</span>, <span class="enscript-string">': '</span>)))
    fh.close()

<span class="enscript-comment">## Base utils for interacting with shell ##
</span><span class="enscript-keyword">def</span> <span class="enscript-function-name">RunCommand</span>(bash_cmd_string, get_stderr = True):
    <span class="enscript-string">&quot;&quot;&quot;
        returns: (int,str) : exit_code and output_str
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;RUNNING: %s&quot;</span> % bash_cmd_string
    cmd_args = shlex.split(bash_cmd_string)
    output_str = <span class="enscript-string">&quot;&quot;</span>
    exit_code = 0
    <span class="enscript-keyword">try</span>:
        <span class="enscript-keyword">if</span> get_stderr:
            output_str = subprocess.check_output(cmd_args, stderr=subprocess.STDOUT)
        <span class="enscript-keyword">else</span>:
            output_str = subprocess.check_output(cmd_args, stderr=None)
    <span class="enscript-keyword">except</span> subprocess.CalledProcessError, e:
        exit_code = e.returncode
    <span class="enscript-keyword">finally</span>:
        <span class="enscript-keyword">return</span> (exit_code, output_str)

<span class="enscript-keyword">def</span> <span class="enscript-function-name">ProcessDyldSharedCacheFile</span>(shared_cache_file_path, sdk_str=<span class="enscript-string">&quot;&quot;</span>):
    <span class="enscript-string">&quot;&quot;&quot; returns (uuid, text_info) output from shared_cache_util.
                In case of error None is returned and err message is printed to stdout.
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> os.path.exists(shared_cache_file_path):
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;File path: %s does not exists&quot;</span> % shared_cache_file_path
        <span class="enscript-keyword">return</span> None
    <span class="enscript-keyword">if</span> sdk_str:
        sdk_str = <span class="enscript-string">' -sdk &quot;%s&quot; '</span> % sdk_str
    (c, so) = RunCommand(<span class="enscript-string">&quot;xcrun {} -find dyld_shared_cache_util&quot;</span>.format(sdk_str))
    <span class="enscript-keyword">if</span> c:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Failed to find path to dyld_shared_cache_util. Exit code: %d , message: %s&quot;</span> % (c,so)
        <span class="enscript-keyword">return</span> None
    dyld_shared_cache_util = so.strip()
    (c, so) = RunCommand(<span class="enscript-string">&quot;{} -info {}&quot;</span>.format(dyld_shared_cache_util, shared_cache_file_path))
    <span class="enscript-keyword">if</span> c:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Failed to get uuid info from %s&quot;</span> % shared_cache_file_path
        <span class="enscript-keyword">print</span> so
        <span class="enscript-keyword">return</span> None

    uuid = so.splitlines()[0].split(<span class="enscript-string">&quot;: &quot;</span>)[-1].strip().replace(<span class="enscript-string">&quot;-&quot;</span>,<span class="enscript-string">&quot;&quot;</span>).lower()
    
    (c, so) = RunCommand(<span class="enscript-string">&quot;{} -text_info {}&quot;</span>.format(dyld_shared_cache_util, shared_cache_file_path))
    <span class="enscript-keyword">if</span> c:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Failed to get text_info from %s&quot;</span> % shared_cache_file_path
        <span class="enscript-keyword">print</span> so
        <span class="enscript-keyword">return</span> None
    
    <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Found %s uuid: %s&quot;</span> % (shared_cache_file_path, uuid)
    text_info = so

    <span class="enscript-keyword">return</span> (uuid, so)

parser = argparse.ArgumentParser(description=<span class="enscript-string">&quot;Decode a kcdata binary file.&quot;</span>)
parser.add_argument(<span class="enscript-string">&quot;-l&quot;</span>, <span class="enscript-string">&quot;--listtypes&quot;</span>, action=<span class="enscript-string">&quot;store_true&quot;</span>, required=False, default=False,
                    help=<span class="enscript-string">&quot;List all known types&quot;</span>,
                    dest=<span class="enscript-string">&quot;list_known_types&quot;</span>)

parser.add_argument(<span class="enscript-string">&quot;-s&quot;</span>, <span class="enscript-string">&quot;--stackshot&quot;</span>, required=False, default=False,
                    help=<span class="enscript-string">&quot;Generate a stackshot report file&quot;</span>,
                    dest=<span class="enscript-string">&quot;stackshot_file&quot;</span>)

parser.add_argument(<span class="enscript-string">&quot;-U&quot;</span>, <span class="enscript-string">&quot;--uuid&quot;</span>, required=False, default=<span class="enscript-string">&quot;&quot;</span>, help=<span class="enscript-string">&quot;UUID of dyld shared cache to be analysed and filled in libs of stackshot report&quot;</span>, dest=<span class="enscript-string">&quot;uuid&quot;</span>)
parser.add_argument(<span class="enscript-string">&quot;-L&quot;</span>, <span class="enscript-string">&quot;--layout&quot;</span>, required=False, type=argparse.FileType(<span class="enscript-string">&quot;r&quot;</span>), help=<span class="enscript-string">&quot;Path to layout file for DyldSharedCache. You can generate one by doing \n\tbash$xcrun -sdk &lt;sdk&gt; dyld_shared_cache_util -text_info &lt;/path/to/dyld_shared_cache&gt; &quot;</span>, dest=<span class="enscript-string">&quot;layout&quot;</span>)
parser.add_argument(<span class="enscript-string">&quot;-S&quot;</span>, <span class="enscript-string">&quot;--sdk&quot;</span>, required=False, default=<span class="enscript-string">&quot;&quot;</span>, help=<span class="enscript-string">&quot;sdk property passed to xcrun command to find the required tools. Default is empty string.&quot;</span>, dest=<span class="enscript-string">&quot;sdk&quot;</span>)
parser.add_argument(<span class="enscript-string">&quot;-D&quot;</span>, <span class="enscript-string">&quot;--dyld_shared_cache&quot;</span>, required=False, default=<span class="enscript-string">&quot;&quot;</span>, help=<span class="enscript-string">&quot;Path to dyld_shared_cache built by B&amp;I&quot;</span>, dest=<span class="enscript-string">&quot;dsc&quot;</span>)
parser.add_argument(<span class="enscript-string">&quot;kcdata_file&quot;</span>, type=argparse.FileType(<span class="enscript-string">'r'</span>), help=<span class="enscript-string">&quot;Path to a kcdata binary file.&quot;</span>)



<span class="enscript-keyword">if</span> __name__ == <span class="enscript-string">'__main__'</span>:
    args = parser.parse_args()

    <span class="enscript-keyword">if</span> args.list_known_types:
        <span class="enscript-keyword">for</span> (n, t) <span class="enscript-keyword">in</span> KNOWN_TYPES_COLLECTION.items():
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;%d : %s &quot;</span> % (n, str(t))
        sys.exit(1)

    file_name = args.kcdata_file.name
    master_objs = []
    master_container = None
    current_container = None
    <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> kcdata_item_iterator(file_name):
        <span class="enscript-comment">#print &quot;processed &quot; + str(i)
</span>        o = KCObject.FromKCItem(i)
        <span class="enscript-keyword">if</span> o.IsContainerType():
            o = KCContainerObject(i.i_type, i.i_data, i.i_flags)

        <span class="enscript-keyword">if</span> current_container <span class="enscript-keyword">is</span> None:
            master_objs.append(o)
            current_container = o
            master_container = o
        <span class="enscript-keyword">else</span>:
            current_container.AddObject(o)

        <span class="enscript-keyword">if</span> o.IsContainerType():
            master_objs.append(current_container)
            current_container = o

        <span class="enscript-keyword">if</span> o.IsContainerEnd():
            current_container = master_objs.pop()
    str_data = <span class="enscript-string">&quot;{&quot;</span> + master_container.GetJsonRepr() + <span class="enscript-string">&quot;}&quot;</span>
    <span class="enscript-keyword">try</span>:
        json_obj = json.loads(str_data)
        dsc_uuid = None
        dsc_libs_arr = []
        libs_re = re.compile(<span class="enscript-string">&quot;^\s*(0x[a-fA-F0-9]+)\s-&gt;\s(0x[a-fA-F0-9]+)\s+&lt;([a-fA-F0-9\-]+)&gt;\s+.*$&quot;</span>, re.MULTILINE)
        <span class="enscript-keyword">if</span> args.uuid <span class="enscript-keyword">and</span> args.layout:
            dsc_uuid = args.uuid.strip().replace(<span class="enscript-string">&quot;-&quot;</span>,<span class="enscript-string">''</span>).lower()
            dsc_libs_arr = libs_re.findall(args.layout.read())

        <span class="enscript-keyword">if</span> args.dsc:
            _ret = ProcessDyldSharedCacheFile(args.dsc, args.sdk)
            <span class="enscript-keyword">if</span> _ret:
                dsc_uuid = _ret[0]
                dsc_libs_arr = libs_re.findall(_ret[1])

        <span class="enscript-keyword">if</span> args.stackshot_file:
            SaveStackshotReport(json_obj, args.stackshot_file, dsc_uuid, dsc_libs_arr)
        <span class="enscript-keyword">else</span>:
            <span class="enscript-keyword">print</span> json.dumps(json_obj, sort_keys=True, indent=4, separators=(<span class="enscript-string">','</span>, <span class="enscript-string">': '</span>))

    <span class="enscript-keyword">except</span> Exception, e:
        <span class="enscript-keyword">raise</span>
        <span class="enscript-keyword">print</span> e
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;--------------------------------------------&quot;</span>*3
        <span class="enscript-keyword">print</span> str_data
</pre>
<hr />
</body></html>