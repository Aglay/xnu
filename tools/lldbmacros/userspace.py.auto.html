<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>userspace.py</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">userspace.py&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-keyword">from</span> xnu <span class="enscript-keyword">import</span> *
<span class="enscript-keyword">from</span> utils <span class="enscript-keyword">import</span> *
<span class="enscript-keyword">from</span> process <span class="enscript-keyword">import</span> *
<span class="enscript-keyword">from</span> pmap <span class="enscript-keyword">import</span> *
<span class="enscript-keyword">import</span> struct

<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetBinaryNameForPC</span>(pc_val, user_lib_info = None):
    <span class="enscript-string">&quot;&quot;&quot; find the binary in user_lib_info that the passed pc_val falls in range of.
        params:
            pc_val : int - integer form of the pc address
            user_lib_info: [] of [] which hold start, end, binary name
        returns:
            str - Name of binary or &quot;unknown&quot; if not found.
    &quot;&quot;&quot;</span>
    retval = <span class="enscript-string">&quot;unknown&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> user_lib_info:
        <span class="enscript-keyword">return</span> retval
    matches = []
    <span class="enscript-keyword">for</span> info <span class="enscript-keyword">in</span> user_lib_info:
        <span class="enscript-keyword">if</span> pc_val &gt;= info[0] <span class="enscript-keyword">and</span> pc_val &lt;= info[1]:
            matches.append((pc_val - info[0], info[2]))
    matches.sort()
    <span class="enscript-keyword">if</span> matches:
        retval = matches[0][1]
    <span class="enscript-keyword">return</span> retval

<span class="enscript-keyword">def</span> <span class="enscript-function-name">ShowX86UserStack</span>(thread, user_lib_info = None):
    <span class="enscript-string">&quot;&quot;&quot; Display user space stack frame and pc addresses.
        params:
            thread: obj referencing thread value
        returns:
            Nothing
    &quot;&quot;&quot;</span>
    iss = Cast(thread.machine.iss, <span class="enscript-string">'x86_saved_state_t *'</span>)
    abi = int(iss.flavor)
    user_ip = 0
    user_frame = 0
    user_abi_ret_offset = 0
    <span class="enscript-keyword">if</span> abi == 0xf:
        debuglog(<span class="enscript-string">&quot;User process is 64 bit&quot;</span>)
        user_ip = iss.uss.ss_64.isf.rip
        user_frame = iss.uss.ss_64.rbp
        user_abi_ret_offset = 8
        user_abi_type = <span class="enscript-string">&quot;uint64_t&quot;</span>
    <span class="enscript-keyword">else</span>:
        debuglog(<span class="enscript-string">&quot;user process is 32 bit&quot;</span>)
        user_ip = iss.uss.ss_32.eip
        user_frame = iss.uss.ss_32.ebp
        user_abi_ret_offset = 4
        user_abi_type = <span class="enscript-string">&quot;uint32_t&quot;</span>

    <span class="enscript-keyword">if</span> user_ip == 0:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;This activation does not appear to have a valid user context.&quot;</span>
        <span class="enscript-keyword">return</span> False

    cur_ip = user_ip
    cur_frame = user_frame
    debuglog(<span class="enscript-string">&quot;ip= 0x%x , fr = 0x%x &quot;</span> % (cur_ip, cur_frame))

    frameformat = <span class="enscript-string">&quot;{0:d} FP: 0x{1:x} PC: 0x{2:x}&quot;</span>
    <span class="enscript-keyword">if</span> user_lib_info <span class="enscript-keyword">is</span> <span class="enscript-keyword">not</span> None:
        frameformat = <span class="enscript-string">&quot;{0:d} {3: &lt;30s} 0x{2:x}&quot;</span>
    <span class="enscript-keyword">print</span> frameformat.format(0, cur_frame, cur_ip, GetBinaryNameForPC(cur_ip, user_lib_info))

    <span class="enscript-keyword">print</span> kern.Symbolicate(cur_ip)

    frameno = 0
    <span class="enscript-keyword">while</span> True:
        frameno = frameno + 1
        frame = GetUserDataAsString(thread.task, unsigned(cur_frame), user_abi_ret_offset*2)
        cur_ip = _ExtractDataFromString(frame, user_abi_ret_offset, user_abi_type)
        cur_frame = _ExtractDataFromString(frame, 0, user_abi_type)
        <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> cur_frame <span class="enscript-keyword">or</span> cur_frame == 0x0000000800000008:
            <span class="enscript-keyword">break</span>
        <span class="enscript-keyword">print</span> frameformat.format(frameno, cur_frame, cur_ip, GetBinaryNameForPC(cur_ip, user_lib_info))
        <span class="enscript-keyword">print</span> kern.Symbolicate(cur_ip)
    <span class="enscript-keyword">return</span>

<span class="enscript-keyword">def</span> <span class="enscript-function-name">_PrintARMUserStack</span>(task, cur_pc, cur_fp, framesize, frametype, frameformat, user_lib_info=None):
    <span class="enscript-keyword">if</span> cur_pc == 0:
        <span class="enscript-string">&quot;No valid user context for this activation.&quot;</span>
        <span class="enscript-keyword">return</span>
    frameno = 0
    <span class="enscript-keyword">print</span> frameformat.format(frameno, cur_fp, cur_pc, GetBinaryNameForPC(cur_pc, user_lib_info))
    <span class="enscript-keyword">while</span> True:
        frameno = frameno + 1
        frame = GetUserDataAsString(task, cur_fp, framesize)
        cur_fp = _ExtractDataFromString(frame, 0, frametype)
        cur_pc = _ExtractDataFromString(frame, (framesize / 2), frametype)
        <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> cur_fp:
            <span class="enscript-keyword">break</span>
        <span class="enscript-keyword">print</span> frameformat.format(frameno, cur_fp, cur_pc, GetBinaryNameForPC(cur_pc, user_lib_info))

<span class="enscript-keyword">def</span> <span class="enscript-function-name">ShowARMUserStack</span>(thread, user_lib_info = None):
    cur_pc = unsigned(thread.machine.PcbData.pc)
    cur_fp = unsigned(thread.machine.PcbData.r[7])
    frameformat = <span class="enscript-string">&quot;{0:&gt;2d} FP: 0x{1:x}  PC: 0x{2:x}&quot;</span>
    <span class="enscript-keyword">if</span> user_lib_info <span class="enscript-keyword">is</span> <span class="enscript-keyword">not</span> None:
        frameformat = <span class="enscript-string">&quot;{0:&gt;2d} {3: &lt;30s}  0x{2:0&gt;8x}&quot;</span>
    framesize = 8
    frametype = <span class="enscript-string">&quot;uint32_t&quot;</span>
    _PrintARMUserStack(thread.task, cur_pc, cur_fp, framesize, frametype, frameformat, user_lib_info=user_lib_info)

<span class="enscript-keyword">def</span> <span class="enscript-function-name">ShowARM64UserStack</span>(thread, user_lib_info = None):
    SAVED_STATE_FLAVOR_ARM=20
    SAVED_STATE_FLAVOR_ARM64=21
    upcb = thread.machine.upcb
    flavor = upcb.ash.flavor
    frameformat = <span class="enscript-string">&quot;{0:&gt;2d} FP: 0x{1:x}  PC: 0x{2:x}&quot;</span>
    <span class="enscript-keyword">if</span> flavor == SAVED_STATE_FLAVOR_ARM64:
        cur_pc = unsigned(upcb.uss.ss_64.pc)
        cur_fp = unsigned(upcb.uss.ss_64.fp)
        <span class="enscript-keyword">if</span> user_lib_info <span class="enscript-keyword">is</span> <span class="enscript-keyword">not</span> None:
            frameformat = <span class="enscript-string">&quot;{0:&gt;2d} {3: &lt;30s}  0x{2:x}&quot;</span>
        framesize = 16
        frametype = <span class="enscript-string">&quot;uint64_t&quot;</span>
    <span class="enscript-keyword">elif</span> flavor == SAVED_STATE_FLAVOR_ARM:
        cur_pc = unsigned(upcb.uss.ss_32.pc)
        cur_fp = unsigned(upcb.uss.ss_32.r[7])
        <span class="enscript-keyword">if</span> user_lib_info <span class="enscript-keyword">is</span> <span class="enscript-keyword">not</span> None:
            frameformat = <span class="enscript-string">&quot;{0:&gt;2d}: {3: &lt;30s}  0x{2:x}&quot;</span>
        framesize = 8
        frametype = <span class="enscript-string">&quot;uint32_t&quot;</span>
    <span class="enscript-keyword">else</span>:
        <span class="enscript-keyword">raise</span> RuntimeError(<span class="enscript-string">&quot;Thread {0} has an invalid flavor {1}&quot;</span>.format(unsigned(thread), flavor))

    _PrintARMUserStack(thread.task, cur_pc, cur_fp, framesize, frametype, frameformat, user_lib_info=user_lib_info)


@lldb_command(<span class="enscript-string">'showthreaduserstack'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">ShowThreadUserStack</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Show user stack for a given thread.
        Syntax: (lldb) showthreaduserstack &lt;thread_ptr&gt;
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> cmd_args:
        <span class="enscript-keyword">raise</span> ArgumentError(<span class="enscript-string">&quot;Insufficient arguments&quot;</span>)

    thread = kern.GetValueFromAddress(ArgumentStringToInt(cmd_args[0]), <span class="enscript-string">'thread *'</span>)
    <span class="enscript-keyword">if</span> kern.arch == <span class="enscript-string">&quot;x86_64&quot;</span>:
        ShowX86UserStack(thread)
    <span class="enscript-keyword">elif</span> kern.arch == <span class="enscript-string">&quot;arm&quot;</span>:
        ShowARMUserStack(thread)
    <span class="enscript-keyword">elif</span> kern.arch == <span class="enscript-string">&quot;arm64&quot;</span>:
        ShowARM64UserStack(thread)
    <span class="enscript-keyword">return</span> True

@lldb_command(<span class="enscript-string">'printuserdata'</span>,<span class="enscript-string">'XO:'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">PrintUserspaceData</span>(cmd_args=None, cmd_options={}):
    <span class="enscript-string">&quot;&quot;&quot; Read userspace data for given task and print based on format provided.
        Syntax: (lldb) printuserdata &lt;task_t&gt; &lt;uspace_address&gt; &lt;format_specifier&gt;
        params:
            &lt;task_t&gt; : pointer to task
            &lt;uspace_address&gt; : address to user space memory
            &lt;format_specifier&gt; : String representation for processing the data and printing it.
                                 e.g Q -&gt; unsigned long long, q -&gt; long long, I -&gt; unsigned int, i -&gt; int
                                 10i -&gt; 10 ints, 20s -&gt; 20 character string, s -&gt; null terminated string
                                 See: <a href="https://docs.python.org/2/library/struct.html#format-characters">https://docs.python.org/2/library/struct.html#format-characters</a>
        options:
            -X : print all values in hex.
            -O &lt;file path&gt;: Save data to file 
    &quot;&quot;&quot;</span>

    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> cmd_args <span class="enscript-keyword">or</span> len(cmd_args) &lt; 3:
        <span class="enscript-keyword">raise</span> ArgumentError(<span class="enscript-string">&quot;Insufficient arguments&quot;</span>)
    task = kern.GetValueFromAddress(cmd_args[0], <span class="enscript-string">'task *'</span>)
    uspace_addr = ArgumentStringToInt(cmd_args[1])
    format_specifier_str = cmd_args[2]
    user_data_len = 0
    <span class="enscript-keyword">if</span> format_specifier_str == <span class="enscript-string">&quot;s&quot;</span>:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;0x%x: &quot;</span> % uspace_addr + GetUserspaceString(task, uspace_addr)
        <span class="enscript-keyword">return</span> True

    <span class="enscript-keyword">try</span>:
        user_data_len = struct.calcsize(format_specifier_str)
    <span class="enscript-keyword">except</span> Exception, e:
        <span class="enscript-keyword">raise</span> ArgumentError(<span class="enscript-string">&quot;Invalid format specifier provided.&quot;</span>)

    user_data_string = GetUserDataAsString(task, uspace_addr, user_data_len)
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> user_data_string:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Could not read any data from userspace address.&quot;</span>
        <span class="enscript-keyword">return</span> False
    <span class="enscript-keyword">if</span> <span class="enscript-string">&quot;-O&quot;</span> <span class="enscript-keyword">in</span> cmd_options:
        fh = open(cmd_options[<span class="enscript-string">&quot;-O&quot;</span>],<span class="enscript-string">&quot;w&quot;</span>)
        fh.write(user_data_string)
        fh.close()
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Written %d bytes to %s.&quot;</span> % (user_data_len, cmd_options[<span class="enscript-string">'-O'</span>])
        <span class="enscript-keyword">return</span> True
    upacked_data = struct.unpack(format_specifier_str, user_data_string)
    element_size = user_data_len / len(upacked_data)
    <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> range(len(upacked_data)):
        <span class="enscript-keyword">if</span> <span class="enscript-string">&quot;-X&quot;</span> <span class="enscript-keyword">in</span> cmd_options:
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;0x%x: &quot;</span> % (uspace_addr + i*element_size) + hex(upacked_data[i])
        <span class="enscript-keyword">else</span>:
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;0x%x: &quot;</span> % (uspace_addr + i*element_size) + str(upacked_data[i])

    <span class="enscript-keyword">return</span> True


@lldb_command(<span class="enscript-string">'showtaskuserargs'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">ShowTaskUserArgs</span>(cmd_args=None, cmd_options={}):
    <span class="enscript-string">&quot;&quot;&quot; Read the process argv, env, and apple strings from the user stack
        Syntax: (lldb) showtaskuserargs &lt;task_t&gt;
        params:
            &lt;task_t&gt; : pointer to task
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> cmd_args <span class="enscript-keyword">or</span> len(cmd_args) != 1:
        <span class="enscript-keyword">raise</span> ArgumentError(<span class="enscript-string">&quot;Insufficient arguments&quot;</span>)

    task = kern.GetValueFromAddress(cmd_args[0], <span class="enscript-string">'task *'</span>)
    proc = Cast(task.bsd_info, <span class="enscript-string">'proc *'</span>)

    format_string = <span class="enscript-string">&quot;Q&quot;</span> <span class="enscript-keyword">if</span> kern.ptrsize == 8 <span class="enscript-keyword">else</span> <span class="enscript-string">&quot;I&quot;</span>

    string_area_size = proc.p_argslen
    string_area_addr = proc.user_stack - string_area_size

    string_area = GetUserDataAsString(task, string_area_addr, string_area_size)
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> string_area:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Could not read any data from userspace address.&quot;</span>
        <span class="enscript-keyword">return</span> False

    i = 0
    pos = string_area_addr - kern.ptrsize

    <span class="enscript-keyword">for</span> name <span class="enscript-keyword">in</span> [<span class="enscript-string">&quot;apple&quot;</span>, <span class="enscript-string">&quot;env&quot;</span>, <span class="enscript-string">&quot;argv&quot;</span>] :
        <span class="enscript-keyword">while</span> True:
            <span class="enscript-keyword">if</span> name == <span class="enscript-string">&quot;argv&quot;</span> :
                <span class="enscript-keyword">if</span> i == proc.p_argc:
                    <span class="enscript-keyword">break</span>
                i += 1

            pos -= kern.ptrsize

            user_data_string = GetUserDataAsString(task, pos, kern.ptrsize)
            ptr = struct.unpack(format_string, user_data_string)[0]          

            <span class="enscript-keyword">if</span> ptr == 0:
                <span class="enscript-keyword">break</span>

            <span class="enscript-keyword">if</span> string_area_addr &lt;= ptr <span class="enscript-keyword">and</span> ptr &lt; string_area_addr+string_area_size :
                string_offset = ptr - string_area_addr
                string = string_area[string_offset:];
            <span class="enscript-keyword">else</span>:
                string = GetUserspaceString(task, ptr)

            <span class="enscript-keyword">print</span> name + <span class="enscript-string">&quot;[]: &quot;</span> + string

    <span class="enscript-keyword">return</span> True


@lldb_command(<span class="enscript-string">'showtaskuserstacks'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">ShowTaskUserStacks</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Print out the user stack for each thread in a task, followed by the user libraries.
        Syntax: (lldb) showtaskuserstacks &lt;task_t&gt;
        The format is compatible with CrashTracer. You can also use the speedtracer plugin as follows
        (lldb) showtaskuserstacks &lt;task_t&gt; -p speedtracer

        Note: the address ranges are approximations. Also the list may not be completely accurate. This command expects memory read failures
        and hence will skip a library if unable to read information. Please use your good judgement and not take the output as accurate
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> cmd_args:
        <span class="enscript-keyword">raise</span> ArgumentError(<span class="enscript-string">&quot;Insufficient arguments&quot;</span>)

    task = kern.GetValueFromAddress(cmd_args[0], <span class="enscript-string">'task *'</span>)
    <span class="enscript-comment">#print GetTaskSummary.header + &quot; &quot; + GetProcSummary.header
</span>    pval = Cast(task.bsd_info, <span class="enscript-string">'proc *'</span>)
    <span class="enscript-comment">#print GetTaskSummary(task) + &quot; &quot; + GetProcSummary(pval) + &quot;\n \n&quot;
</span>    crash_report_format_string = <span class="enscript-string">&quot;&quot;&quot;\
Process:         {pid: &lt;10d}
Path:            {path: &lt;50s}
Identifier:      {pname: &lt;30s}
Version:         ??? (???)
Code Type:       {parch: &lt;20s}
Parent Process:  {ppname: &gt;20s}[{ppid:d}]

Date/Time:       {timest:s}.000 -0800
OS Version:      {osversion: &lt;20s}
Report Version:  8

Exception Type:  n/a
Exception Codes: n/a
Crashed Thread:  0

Application Specific Information:
Synthetic crash log generated from Kernel userstacks

&quot;&quot;&quot;</span>
    user_lib_rex = re.compile(<span class="enscript-string">&quot;([0-9a-fx]+)\s-\s([0-9a-fx]+)\s+(.*?)\s&quot;</span>, re.IGNORECASE|re.MULTILINE)
    <span class="enscript-keyword">from</span> datetime <span class="enscript-keyword">import</span> datetime
    ts = datetime.fromtimestamp(int(pval.p_start.tv_sec))
    date_string = ts.strftime(<span class="enscript-string">'%Y-%m-%d %H:%M:%S'</span>)
    is_64 = False
    <span class="enscript-keyword">if</span> pval.p_flag &amp; 0x4 :
        is_64 = True

    parch_s = <span class="enscript-string">&quot;&quot;</span>
    <span class="enscript-keyword">if</span> kern.arch == <span class="enscript-string">&quot;x86_64&quot;</span> <span class="enscript-keyword">or</span> kern.arch == <span class="enscript-string">&quot;i386&quot;</span>:
        osversion = <span class="enscript-string">&quot;Mac OS X 10.8&quot;</span>
        parch_s = <span class="enscript-string">&quot;I386 (32 bit)&quot;</span>
        <span class="enscript-keyword">if</span> is_64:
            parch_s = <span class="enscript-string">&quot;X86-64 (Native)&quot;</span>
    <span class="enscript-keyword">else</span>:
        parch_s = kern.arch
        osversion = <span class="enscript-string">&quot;iOS&quot;</span>
    osversion += <span class="enscript-string">&quot; ({:s})&quot;</span>.format(kern.globals.osversion)
    <span class="enscript-keyword">print</span> crash_report_format_string.format(pid = pval.p_pid,
            pname = pval.p_comm,
            path = pval.p_comm,
            ppid = pval.p_ppid,
            ppname = GetProcNameForPid(pval.p_ppid),
            timest = date_string,
            parch = parch_s,
            osversion = osversion

        )
    <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Binary Images:&quot;</span>
    ShowTaskUserLibraries([hex(task)])
    usertask_lib_info = [] <span class="enscript-comment"># will host [startaddr, endaddr, lib_name] entries
</span>    <span class="enscript-keyword">for</span> entry <span class="enscript-keyword">in</span> ShowTaskUserLibraries.found_images:
        <span class="enscript-comment">#print &quot;processing line %s&quot; % line
</span>        arr = user_lib_rex.findall(entry[3])
        <span class="enscript-comment">#print &quot;%r&quot; % arr
</span>        <span class="enscript-keyword">if</span> len(arr) == 0 :
            <span class="enscript-keyword">continue</span>
        usertask_lib_info.append([int(arr[0][0],16), int(arr[0][1],16), str(arr[0][2]).strip()])

    printthread_user_stack_ptr = ShowX86UserStack
    <span class="enscript-keyword">if</span> kern.arch == <span class="enscript-string">&quot;arm&quot;</span>:
        printthread_user_stack_ptr = ShowARMUserStack
    <span class="enscript-keyword">elif</span> kern.arch ==<span class="enscript-string">&quot;arm64&quot;</span>:
        printthread_user_stack_ptr = ShowARM64UserStack

    counter = 0
    <span class="enscript-keyword">for</span> thval <span class="enscript-keyword">in</span> IterateQueue(task.threads, <span class="enscript-string">'thread *'</span>, <span class="enscript-string">'task_threads'</span>):
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;\nThread {0:d} name:0x{1:x}\nThread {0:d}:&quot;</span>.format(counter, thval)
        counter += 1
        <span class="enscript-keyword">try</span>:
            printthread_user_stack_ptr(thval, usertask_lib_info)
        <span class="enscript-keyword">except</span> Exception as exc_err:
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Failed to show user stack for thread 0x{0:x}&quot;</span>.format(thval)
            <span class="enscript-keyword">if</span> config[<span class="enscript-string">'debug'</span>]:
                <span class="enscript-keyword">raise</span> exc_err
            <span class="enscript-keyword">else</span>:
                <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Enable debugging ('(lldb) xnudebug debug') to see detailed trace.&quot;</span>
    <span class="enscript-keyword">return</span>


<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetUserDataAsString</span>(task, addr, size):
    <span class="enscript-string">&quot;&quot;&quot; Get data from task's address space as a string of bytes
        params:
            task: task object from which to extract information
            addr: int - start address to get data from.
            size: int - no of bytes to read.
        returns:
            str - a stream of bytes. Empty string if read fails.
    &quot;&quot;&quot;</span>
    err = lldb.SBError()
    <span class="enscript-keyword">if</span> GetConnectionProtocol() == <span class="enscript-string">&quot;kdp&quot;</span>:
        kdp_pmap_addr = unsigned(addressof(kern.globals.kdp_pmap))
        <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt64ToMemoryAddress(unsigned(task.map.pmap), kdp_pmap_addr):
            debuglog(<span class="enscript-string">&quot;Failed to write in kdp_pmap from GetUserDataAsString.&quot;</span>)
            <span class="enscript-keyword">return</span> <span class="enscript-string">&quot;&quot;</span>
        content = LazyTarget.GetProcess().ReadMemory(addr, size, err)
        <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> err.Success():
            debuglog(<span class="enscript-string">&quot;Failed to read process memory. Error: &quot;</span> + err.description)
            <span class="enscript-keyword">return</span> <span class="enscript-string">&quot;&quot;</span>
        <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt64ToMemoryAddress(0, kdp_pmap_addr):
            debuglog(<span class="enscript-string">&quot;Failed to reset in kdp_pmap from GetUserDataAsString.&quot;</span>)
            <span class="enscript-keyword">return</span> <span class="enscript-string">&quot;&quot;</span>
    <span class="enscript-keyword">elif</span> kern.arch <span class="enscript-keyword">in</span> [<span class="enscript-string">'arm'</span>, <span class="enscript-string">'arm64'</span>, <span class="enscript-string">'x86_64'</span>] <span class="enscript-keyword">and</span> long(size) &lt; (2 * kern.globals.page_size):
        <span class="enscript-comment"># Without the benefit of a KDP stub on the target, try to
</span>        <span class="enscript-comment"># find the user task's physical mapping and memcpy the data.
</span>        <span class="enscript-comment"># If it straddles a page boundary, copy in two passes
</span>        range1_addr = long(addr)
        range1_size = long(size)
        <span class="enscript-keyword">if</span> kern.StraddlesPage(range1_addr, range1_size):
            range2_addr = long(kern.TruncPage(range1_addr + range1_size))
            range2_size = long(range1_addr + range1_size - range2_addr)
            range1_size = long(range2_addr - range1_addr)
        <span class="enscript-keyword">else</span>:
            range2_addr = 0
            range2_size = 0
            range2_in_kva = 0

        paddr_range1 = PmapWalk(task.map.pmap, range1_addr, vSILENT)
        <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> paddr_range1:
            debuglog(<span class="enscript-string">&quot;Not mapped task 0x{:x} address 0x{:x}&quot;</span>.format(task, addr))
            <span class="enscript-keyword">return</span> <span class="enscript-string">&quot;&quot;</span>

        range1_in_kva = kern.PhysToKernelVirt(paddr_range1)
        content = LazyTarget.GetProcess().ReadMemory(range1_in_kva, range1_size, err)
        <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> err.Success():
            <span class="enscript-keyword">raise</span> RuntimeError(<span class="enscript-string">&quot;Failed to read process memory. Error: &quot;</span> + err.description)

        <span class="enscript-keyword">if</span> range2_addr:
            paddr_range2 = PmapWalk(task.map.pmap, range2_addr, vSILENT)
            <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> paddr_range2:
                debuglog(<span class="enscript-string">&quot;Not mapped task 0x{:x} address 0x{:x}&quot;</span>.format(task, addr))
                <span class="enscript-keyword">return</span> <span class="enscript-string">&quot;&quot;</span>
            range2_in_kva = kern.PhysToKernelVirt(paddr_range2)
            content += LazyTarget.GetProcess().ReadMemory(range2_in_kva, range2_size, err)
            <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> err.Success():
                <span class="enscript-keyword">raise</span> RuntimeError(<span class="enscript-string">&quot;Failed to read process memory. Error: &quot;</span> + err.description)
    <span class="enscript-keyword">else</span>:
        <span class="enscript-keyword">raise</span> NotImplementedError(<span class="enscript-string">&quot;GetUserDataAsString does not support this configuration&quot;</span>)

    <span class="enscript-keyword">return</span> content

<span class="enscript-keyword">def</span> <span class="enscript-function-name">_ExtractDataFromString</span>(strdata, offset, data_type, length=0):
    <span class="enscript-string">&quot;&quot;&quot; Extract specific data from string buffer
        params:
            strdata: str - string data give from GetUserDataAsString
            offset: int - 0 based offset into the data.
            data_type: str - defines what type to be read as. Supported values are:
                             'uint64_t', 'uint32_t', 'string'
            length: int - used when data_type=='string'
        returns
            None - if extraction failed.
            obj - based on what is requested in data_type
    &quot;&quot;&quot;</span>
    unpack_str = <span class="enscript-string">&quot;s&quot;</span>
    <span class="enscript-keyword">if</span> data_type == <span class="enscript-string">'uint64_t'</span>:
        length = 8
        unpack_str = <span class="enscript-string">&quot;Q&quot;</span>
    <span class="enscript-keyword">elif</span> data_type == <span class="enscript-string">&quot;uint32_t&quot;</span>:
        length = 4
        unpack_str = <span class="enscript-string">&quot;I&quot;</span>
    <span class="enscript-keyword">else</span>:
        unpack_str= <span class="enscript-string">&quot;%ds&quot;</span> % length

    data_len = len(strdata)
    <span class="enscript-keyword">if</span> offset &gt; data_len <span class="enscript-keyword">or</span> (offset + length) &gt; data_len <span class="enscript-keyword">or</span> offset &lt; 0:
        debuglog(<span class="enscript-string">&quot;Invalid arguments to _ExtractDataFromString.&quot;</span>)
        <span class="enscript-keyword">return</span> 0
    <span class="enscript-keyword">return</span> struct.unpack(unpack_str, strdata[offset:(offset + length)])[0]

<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetUserspaceString</span>(task, string_address):
    <span class="enscript-string">&quot;&quot;&quot; Maps 32 bytes at a time and packs as string
        params:
            task: obj - referencing task to read data from
            string_address: int - address where the image path is stored
        returns:
            str - string path of the file. &quot;&quot; if failed to read.
    &quot;&quot;&quot;</span>
    done = False
    retval = <span class="enscript-string">&quot;&quot;</span>

    <span class="enscript-keyword">if</span> string_address == 0:
        done = True

    <span class="enscript-keyword">while</span> <span class="enscript-keyword">not</span> done:
        str_data = GetUserDataAsString(task, string_address, 32)
        <span class="enscript-keyword">if</span> len(str_data) == 0:
            <span class="enscript-keyword">break</span>
        i = 0
        <span class="enscript-keyword">while</span> i &lt; 32:
            <span class="enscript-keyword">if</span> ord(str_data[i]):
                retval += str_data[i]
            <span class="enscript-keyword">else</span>:
                <span class="enscript-keyword">break</span>
            i += 1
        <span class="enscript-keyword">if</span> i &lt; 32:
            done = True
        <span class="enscript-keyword">else</span>:
            string_address += 32
    <span class="enscript-keyword">return</span> retval

<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetImageInfo</span>(task, mh_image_address, mh_path_address, approx_end_address=None):
    <span class="enscript-string">&quot;&quot;&quot; Print user library informaiton.
        params:
            task : obj referencing the task for which Image info printed
            mh_image_address : int - address which has image info
            mh_path_address : int - address which holds path name string
            approx_end_address: int - address which lldbmacros think is end address.
        returns:
            str - string representing image info. &quot;&quot; if failure to read data.
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> approx_end_address:
        image_end_load_address = int(approx_end_address) -1
    <span class="enscript-keyword">else</span>:
        image_end_load_address = int(mh_image_address) + 0xffffffff

    print_format = <span class="enscript-string">&quot;0x{0:x} - 0x{1:x} {2: &lt;50s} (??? - ???) &lt;{3: &lt;36s}&gt; {4: &lt;50s}&quot;</span>
    <span class="enscript-comment"># 32 bytes enough for mach_header/mach_header_64
</span>    mh_data = GetUserDataAsString(task, mh_image_address, 32)
    <span class="enscript-keyword">if</span> len(mh_data) == 0:
        debuglog(<span class="enscript-string">&quot;unable to get userdata for task 0x{:x} img_addr 0x{:x} path_address 0x{:x}&quot;</span>.format(
            task, mh_image_address, mh_path_address))
        <span class="enscript-keyword">return</span> <span class="enscript-string">&quot;&quot;</span>
    mh_magic = _ExtractDataFromString(mh_data, (4 * 0), <span class="enscript-string">&quot;uint32_t&quot;</span>)
    mh_cputype = _ExtractDataFromString(mh_data,(4 * 1), <span class="enscript-string">&quot;uint32_t&quot;</span>)
    mh_cpusubtype = _ExtractDataFromString(mh_data,(4 * 2), <span class="enscript-string">&quot;uint32_t&quot;</span>)
    mh_filetype = _ExtractDataFromString(mh_data,(4 * 3), <span class="enscript-string">&quot;uint32_t&quot;</span>)
    mh_ncmds = _ExtractDataFromString(mh_data,(4 * 4), <span class="enscript-string">&quot;uint32_t&quot;</span>)
    mh_sizeofcmds = _ExtractDataFromString(mh_data,(4 * 5), <span class="enscript-string">&quot;uint32_t&quot;</span>)
    mh_flags = _ExtractDataFromString(mh_data,(4 * 6), <span class="enscript-string">&quot;uint32_t&quot;</span>)

    <span class="enscript-keyword">if</span> mh_magic == 0xfeedfacf:
        mh_64 = True
        lc_address = mh_image_address + 32
    <span class="enscript-keyword">else</span>:
        mh_64 = False
        lc_address = mh_image_address + 28

    lc_idx = 0
    uuid_data = 0
    found_uuid_data = False
    retval = None
    <span class="enscript-keyword">while</span> lc_idx &lt; mh_ncmds:
        <span class="enscript-comment"># 24 bytes is the size of uuid_command
</span>        lcmd_data = GetUserDataAsString(task, lc_address, 24)
        lc_cmd = _ExtractDataFromString(lcmd_data, 4 * 0, <span class="enscript-string">&quot;uint32_t&quot;</span>)
        lc_cmd_size = _ExtractDataFromString(lcmd_data, 4 * 1, <span class="enscript-string">&quot;uint32_t&quot;</span>)
        lc_data = _ExtractDataFromString(lcmd_data, 4*2, <span class="enscript-string">&quot;string&quot;</span>, 16)

        uuid_out_string = <span class="enscript-string">&quot;&quot;</span>
        path_out_string = <span class="enscript-string">&quot;&quot;</span>

        <span class="enscript-keyword">if</span> lc_cmd == 0x1b:
            <span class="enscript-comment"># need to print the uuid now.
</span>            uuid_data = [ord(x) <span class="enscript-keyword">for</span> x <span class="enscript-keyword">in</span> lc_data]
            found_uuid_data = True
            uuid_out_string = <span class="enscript-string">&quot;{a[0]:02X}{a[1]:02X}{a[2]:02X}{a[3]:02X}-{a[4]:02X}{a[5]:02X}-{a[6]:02X}{a[7]:02X}-{a[8]:02X}{a[9]:02X}-{a[10]:02X}{a[11]:02X}{a[12]:02X}{a[13]:02X}{a[14]:02X}{a[15]:02X}&quot;</span>.format(a=uuid_data)
            <span class="enscript-comment">#also print image path
</span>            path_out_string = GetUserspaceString(task, mh_path_address)
            path_base_name = path_out_string.split(<span class="enscript-string">&quot;/&quot;</span>)[-1]
            retval = print_format.format(mh_image_address, image_end_load_address, path_base_name, uuid_out_string, path_out_string)
        <span class="enscript-keyword">elif</span> lc_cmd == 0xe:
            ShowTaskUserLibraries.exec_load_path = lc_address + _ExtractDataFromString(lcmd_data, 4*2, <span class="enscript-string">&quot;uint32_t&quot;</span>)
            debuglog(<span class="enscript-string">&quot;Found load command to be 0xe for address %s&quot;</span> % hex(ShowTaskUserLibraries.exec_load_path))
        lc_address = lc_address + lc_cmd_size
        lc_idx += 1

    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> found_uuid_data:
        path_out_string = GetUserspaceString(task, mh_path_address)
        path_base_name = path_out_string.split(<span class="enscript-string">&quot;/&quot;</span>)[-1]
        uuid_out_string = <span class="enscript-string">&quot;&quot;</span>

        retval = print_format.format(mh_image_address, image_end_load_address, path_base_name, uuid_out_string, path_out_string)
    <span class="enscript-keyword">return</span> retval

@static_var(<span class="enscript-string">&quot;found_images&quot;</span>, []) <span class="enscript-comment"># holds entries of format (startaddr, endaddr, image_path_addr, infostring)
</span>@static_var(<span class="enscript-string">&quot;exec_load_path&quot;</span>, 0)
@lldb_command(<span class="enscript-string">&quot;showtaskuserlibraries&quot;</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">ShowTaskUserLibraries</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Show binary images known by dyld in target task
        For a given user task, inspect the dyld shared library state and print information about all Mach-O images.
        Syntax: (lldb)showtaskuserlibraries &lt;task_t&gt;
        Note: the address ranges are approximations. Also the list may not be completely accurate. This command expects memory read failures
        and hence will skip a library if unable to read information. Please use your good judgement and not take the output as accurate
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> cmd_args:
        <span class="enscript-keyword">raise</span> ArgumentError(<span class="enscript-string">&quot;Insufficient arguments&quot;</span>)

    <span class="enscript-comment">#reset the found_images array
</span>    ShowTaskUserLibraries.found_images = []

    task = kern.GetValueFromAddress(cmd_args[0], <span class="enscript-string">'task_t'</span>)
    is_task_64 = int(task.t_flags) &amp; 0x1
    dyld_all_image_infos_address = unsigned(task.all_image_info_addr)
    debuglog(<span class="enscript-string">&quot;dyld_all_image_infos_address = %s&quot;</span> % hex(dyld_all_image_infos_address))

    cur_data_offset = 0
    <span class="enscript-keyword">if</span> dyld_all_image_infos_address == 0:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;No dyld shared library information available for task&quot;</span>
        <span class="enscript-keyword">return</span> False
    
    debuglog(<span class="enscript-string">&quot;Extracting version information.&quot;</span>)
    vers_info_data = GetUserDataAsString(task, dyld_all_image_infos_address, 112)
    version = _ExtractDataFromString(vers_info_data, cur_data_offset, <span class="enscript-string">&quot;uint32_t&quot;</span>)
    cur_data_offset += 4
    <span class="enscript-keyword">if</span> version &gt; 14:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Unknown dyld all_image_infos version number %d&quot;</span> % version
    image_info_count = _ExtractDataFromString(vers_info_data, cur_data_offset, <span class="enscript-string">&quot;uint32_t&quot;</span>)
    debuglog(<span class="enscript-string">&quot;version = %d count = %d is_task_64 = %s&quot;</span> % (version, image_info_count, repr(is_task_64)))

    ShowTaskUserLibraries.exec_load_path = 0
    <span class="enscript-keyword">if</span> is_task_64:
        image_info_size = 24
        image_info_array_address = _ExtractDataFromString(vers_info_data, 8, <span class="enscript-string">&quot;uint64_t&quot;</span>)
        dyld_load_address = _ExtractDataFromString(vers_info_data, 8*4, <span class="enscript-string">&quot;uint64_t&quot;</span>)
        dyld_all_image_infos_address_from_struct = _ExtractDataFromString(vers_info_data, 8*13, <span class="enscript-string">&quot;uint64_t&quot;</span>)
    <span class="enscript-keyword">else</span>:
        image_info_size = 12
        image_info_array_address = _ExtractDataFromString(vers_info_data, 4*2, <span class="enscript-string">&quot;uint32_t&quot;</span>)
        dyld_load_address = _ExtractDataFromString(vers_info_data, 4*5, <span class="enscript-string">&quot;uint32_t&quot;</span>)
        dyld_all_image_infos_address_from_struct = _ExtractDataFromString(vers_info_data, 4*14, <span class="enscript-string">&quot;uint32_t&quot;</span>)
    <span class="enscript-comment"># Account for ASLR slide before dyld can fix the structure
</span>    dyld_load_address = dyld_load_address + (dyld_all_image_infos_address - dyld_all_image_infos_address_from_struct)

    i = 0
    image_info_list = []
    <span class="enscript-keyword">while</span> i &lt; image_info_count:
        image_info_address = image_info_array_address + i * image_info_size
        debuglog(<span class="enscript-string">&quot;i = %d, image_info_address = %s, image_info_size = %d&quot;</span> % (i, hex(image_info_address), image_info_size))
        n_im_info_addr = None
        img_data = <span class="enscript-string">&quot;&quot;</span>
        <span class="enscript-keyword">try</span>:
            img_data = GetUserDataAsString(task, image_info_address, image_info_size)
        <span class="enscript-keyword">except</span> Exception, e:
            debuglog(<span class="enscript-string">&quot;Failed to read user data for task 0x{:x} addr 0x{:x}, exception {:s}&quot;</span>.format(task, image_info_address, str(e)))
            <span class="enscript-keyword">pass</span>

        <span class="enscript-keyword">if</span> is_task_64:
            image_info_addr = _ExtractDataFromString(img_data, 0, <span class="enscript-string">&quot;uint64_t&quot;</span>)
            image_info_path = _ExtractDataFromString(img_data, 8, <span class="enscript-string">&quot;uint64_t&quot;</span>)
        <span class="enscript-keyword">else</span>:
            image_info_addr = _ExtractDataFromString(img_data, 0, <span class="enscript-string">&quot;uint32_t&quot;</span>)
            image_info_path = _ExtractDataFromString(img_data, 4, <span class="enscript-string">&quot;uint32_t&quot;</span>)

        <span class="enscript-keyword">if</span> image_info_addr :
            debuglog(<span class="enscript-string">&quot;Found image: image_info_addr = %s, image_info_path= %s&quot;</span> % (hex(image_info_addr), hex(image_info_path)))
            image_info_list.append((image_info_addr, image_info_path))
        i += 1

    image_info_list.sort()
    num_images_found = len(image_info_list)

    <span class="enscript-keyword">for</span> ii <span class="enscript-keyword">in</span> range(num_images_found):
        n_im_info_addr = dyld_load_address
        <span class="enscript-keyword">if</span> ii + 1 &lt; num_images_found:
            n_im_info_addr = image_info_list[ii+1][0]

        image_info_addr = image_info_list[ii][0]
        image_info_path = image_info_list[ii][1]
        <span class="enscript-keyword">try</span>:
            image_print_s = GetImageInfo(task, image_info_addr, image_info_path, approx_end_address=n_im_info_addr)
            <span class="enscript-keyword">if</span> len(image_print_s) &gt; 0:
                <span class="enscript-keyword">print</span> image_print_s
                ShowTaskUserLibraries.found_images.append((image_info_addr, n_im_info_addr, image_info_path, image_print_s))
            <span class="enscript-keyword">else</span>:
                debuglog(<span class="enscript-string">&quot;Failed to print image info for task 0x{:x} image_info 0x{:x}&quot;</span>.format(task, image_info_addr))
        <span class="enscript-keyword">except</span> Exception,e:
            <span class="enscript-keyword">if</span> config[<span class="enscript-string">'debug'</span>]:
                <span class="enscript-keyword">raise</span> e

    <span class="enscript-comment"># load_path might get set when the main executable is processed.
</span>    <span class="enscript-keyword">if</span> ShowTaskUserLibraries.exec_load_path != 0:
        debuglog(<span class="enscript-string">&quot;main executable load_path is set.&quot;</span>)
        image_print_s = GetImageInfo(task, dyld_load_address, ShowTaskUserLibraries.exec_load_path)
        <span class="enscript-keyword">if</span> len(image_print_s) &gt; 0:
            <span class="enscript-keyword">print</span> image_print_s
            ShowTaskUserLibraries.found_images.append((dyld_load_address, dyld_load_address + 0xffffffff,
                    ShowTaskUserLibraries.exec_load_path, image_print_s))
        <span class="enscript-keyword">else</span>:
            debuglog(<span class="enscript-string">&quot;Failed to print image for main executable for task 0x{:x} dyld_load_addr 0x{:x}&quot;</span>.format(task, dyld_load_address))
    <span class="enscript-keyword">else</span>:
        debuglog(<span class="enscript-string">&quot;Falling back to vm entry method for finding executable load address&quot;</span>)
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;# NOTE: Failed to find executable using all_image_infos. Using fuzzy match to find best possible load address for executable.&quot;</span>
        ShowTaskLoadInfo([cmd_args[0]])
    <span class="enscript-keyword">return</span>

@lldb_command(<span class="enscript-string">&quot;showtaskuserdyldinfo&quot;</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">ShowTaskUserDyldInfo</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Inspect the dyld global info for the given user task &amp; print out all fields including error messages
        Syntax: (lldb)showtaskuserdyldinfo &lt;task_t&gt;
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> cmd_args == None <span class="enscript-keyword">or</span> len(cmd_args) &lt; 1:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;No arguments passed&quot;</span>
        <span class="enscript-keyword">print</span> ShowTaskUserDyldInfo.__doc__.strip()
        <span class="enscript-keyword">return</span>

    out_str = <span class="enscript-string">&quot;&quot;</span>
    task = kern.GetValueFromAddress(cmd_args[0], <span class="enscript-string">'task_t'</span>)
    is_task_64 = int(task.t_flags) &amp; 0x1
    dyld_all_image_infos_address = unsigned(task.all_image_info_addr)
    <span class="enscript-keyword">if</span> dyld_all_image_infos_address == 0:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;No dyld shared library information available for task&quot;</span>
        <span class="enscript-keyword">return</span> False
    vers_info_data = GetUserDataAsString(task, dyld_all_image_infos_address, 112)
    dyld_all_image_infos_version = _ExtractDataFromString(vers_info_data, 0, <span class="enscript-string">&quot;uint32_t&quot;</span>)
    <span class="enscript-keyword">if</span> dyld_all_image_infos_version &gt; 14:
        out_str += <span class="enscript-string">&quot;Unknown dyld all_image_infos version number %d&quot;</span> % dyld_all_image_infos_version

    <span class="enscript-comment"># Find fields by byte offset. We assume at least version 9 is supported
</span>    <span class="enscript-keyword">if</span> is_task_64:
        dyld_all_image_infos_infoArrayCount = _ExtractDataFromString(vers_info_data, 4, <span class="enscript-string">&quot;uint32_t&quot;</span>)
        dyld_all_image_infos_infoArray = _ExtractDataFromString(vers_info_data, 8, <span class="enscript-string">&quot;uint64_t&quot;</span>)
        dyld_all_image_infos_notification = _ExtractDataFromString(vers_info_data, 16, <span class="enscript-string">&quot;uint64_t&quot;</span>)
        dyld_all_image_infos_processDetachedFromSharedRegion = _ExtractDataFromString(vers_info_data, 24, <span class="enscript-string">&quot;string&quot;</span>)
        dyld_all_image_infos_libSystemInitialized = _ExtractDataFromString(vers_info_data, 25, <span class="enscript-string">&quot;string&quot;</span>)
        dyld_all_image_infos_dyldImageLoadAddress = _ExtractDataFromString(vers_info_data, 32, <span class="enscript-string">&quot;uint64_t&quot;</span>)
        dyld_all_image_infos_jitInfo = _ExtractDataFromString(vers_info_data, 40, <span class="enscript-string">&quot;uint64_t&quot;</span>)
        dyld_all_image_infos_dyldVersion = _ExtractDataFromString(vers_info_data, 48, <span class="enscript-string">&quot;uint64_t&quot;</span>)
        dyld_all_image_infos_errorMessage = _ExtractDataFromString(vers_info_data, 56, <span class="enscript-string">&quot;uint64_t&quot;</span>)
        dyld_all_image_infos_terminationFlags = _ExtractDataFromString(vers_info_data, 64, <span class="enscript-string">&quot;uint64_t&quot;</span>)
        dyld_all_image_infos_coreSymbolicationShmPage = _ExtractDataFromString(vers_info_data, 72, <span class="enscript-string">&quot;uint64_t&quot;</span>)
        dyld_all_image_infos_systemOrderFlag = _ExtractDataFromString(vers_info_data, 80, <span class="enscript-string">&quot;uint64_t&quot;</span>)
        dyld_all_image_infos_uuidArrayCount = _ExtractDataFromString(vers_info_data, 88, <span class="enscript-string">&quot;uint64_t&quot;</span>)
        dyld_all_image_infos_uuidArray = _ExtractDataFromString(vers_info_data, 96, <span class="enscript-string">&quot;uint64_t&quot;</span>)
        dyld_all_image_infos_dyldAllImageInfosAddress = _ExtractDataFromString(vers_info_data, 104, <span class="enscript-string">&quot;uint64_t&quot;</span>)
    <span class="enscript-keyword">else</span>:
        dyld_all_image_infos_infoArrayCount = _ExtractDataFromString(vers_info_data, 4, <span class="enscript-string">&quot;uint32_t&quot;</span>)
        dyld_all_image_infos_infoArray = _ExtractDataFromString(vers_info_data, 8, <span class="enscript-string">&quot;uint32_t&quot;</span>)
        dyld_all_image_infos_notification = _ExtractDataFromString(vers_info_data, 12, <span class="enscript-string">&quot;uint32_t&quot;</span>)
        dyld_all_image_infos_processDetachedFromSharedRegion = _ExtractDataFromString(vers_info_data, 16, <span class="enscript-string">&quot;string&quot;</span>)
        dyld_all_image_infos_libSystemInitialized = _ExtractDataFromString(vers_info_data, 17, <span class="enscript-string">&quot;string&quot;</span>)
        dyld_all_image_infos_dyldImageLoadAddress = _ExtractDataFromString(vers_info_data, 20, <span class="enscript-string">&quot;uint32_t&quot;</span>)
        dyld_all_image_infos_jitInfo = _ExtractDataFromString(vers_info_data, 24, <span class="enscript-string">&quot;uint32_t&quot;</span>)
        dyld_all_image_infos_dyldVersion = _ExtractDataFromString(vers_info_data, 28, <span class="enscript-string">&quot;uint32_t&quot;</span>)
        dyld_all_image_infos_errorMessage = _ExtractDataFromString(vers_info_data, 32, <span class="enscript-string">&quot;uint32_t&quot;</span>)
        dyld_all_image_infos_terminationFlags = _ExtractDataFromString(vers_info_data, 36, <span class="enscript-string">&quot;uint32_t&quot;</span>)
        dyld_all_image_infos_coreSymbolicationShmPage = _ExtractDataFromString(vers_info_data, 40, <span class="enscript-string">&quot;uint32_t&quot;</span>)
        dyld_all_image_infos_systemOrderFlag = _ExtractDataFromString(vers_info_data, 44, <span class="enscript-string">&quot;uint32_t&quot;</span>)
        dyld_all_image_infos_uuidArrayCount = _ExtractDataFromString(vers_info_data, 48, <span class="enscript-string">&quot;uint32_t&quot;</span>)
        dyld_all_image_infos_uuidArray = _ExtractDataFromString(vers_info_data, 52, <span class="enscript-string">&quot;uint32_t&quot;</span>)
        dyld_all_image_infos_dyldAllImageInfosAddress = _ExtractDataFromString(vers_info_data, 56, <span class="enscript-string">&quot;uint32_t&quot;</span>)

    dyld_all_imfo_infos_slide = (dyld_all_image_infos_address - dyld_all_image_infos_dyldAllImageInfosAddress)
    dyld_all_image_infos_dyldVersion_postslide = (dyld_all_image_infos_dyldVersion + dyld_all_imfo_infos_slide)

    path_out = GetUserspaceString(task, dyld_all_image_infos_dyldVersion_postslide)
    out_str += <span class="enscript-string">&quot;[dyld-{:s}]\n&quot;</span>.format(path_out)
    out_str += <span class="enscript-string">&quot;version \t\t\t\t: {:d}\n&quot;</span>.format(dyld_all_image_infos_version)
    out_str += <span class="enscript-string">&quot;infoArrayCount \t\t\t\t: {:d}\n&quot;</span>.format(dyld_all_image_infos_infoArrayCount)
    out_str += <span class="enscript-string">&quot;infoArray \t\t\t\t: {:#x}\n&quot;</span>.format(dyld_all_image_infos_infoArray)
    out_str += <span class="enscript-string">&quot;notification \t\t\t\t: {:#x}\n&quot;</span>.format(dyld_all_image_infos_notification)
    
    out_str += <span class="enscript-string">&quot;processDetachedFromSharedRegion \t: &quot;</span>
    <span class="enscript-keyword">if</span> dyld_all_image_infos_processDetachedFromSharedRegion != <span class="enscript-string">&quot;&quot;</span>:
        out_str += <span class="enscript-string">&quot;TRUE\n&quot;</span>.format(dyld_all_image_infos_processDetachedFromSharedRegion)
    <span class="enscript-keyword">else</span>:
        out_str += <span class="enscript-string">&quot;FALSE\n&quot;</span>
    
    out_str += <span class="enscript-string">&quot;libSystemInitialized \t\t\t: &quot;</span>
    <span class="enscript-keyword">if</span> dyld_all_image_infos_libSystemInitialized != <span class="enscript-string">&quot;&quot;</span>:
        out_str += <span class="enscript-string">&quot;TRUE\n&quot;</span>.format(dyld_all_image_infos_libSystemInitialized)
    <span class="enscript-keyword">else</span>:
        out_str += <span class="enscript-string">&quot;FALSE\n&quot;</span>
        
    out_str += <span class="enscript-string">&quot;dyldImageLoadAddress \t\t\t: {:#x}\n&quot;</span>.format(dyld_all_image_infos_dyldImageLoadAddress)
    out_str += <span class="enscript-string">&quot;jitInfo \t\t\t\t: {:#x}\n&quot;</span>.format(dyld_all_image_infos_jitInfo)
    out_str += <span class="enscript-string">&quot;\ndyldVersion \t\t\t\t: {:#x}&quot;</span>.format(dyld_all_image_infos_dyldVersion)
    <span class="enscript-keyword">if</span> (dyld_all_imfo_infos_slide != 0):
        out_str += <span class="enscript-string">&quot; (currently {:#x})\n&quot;</span>.format(dyld_all_image_infos_dyldVersion_postslide)
    <span class="enscript-keyword">else</span>:
        out_str += <span class="enscript-string">&quot;\n&quot;</span>

    out_str += <span class="enscript-string">&quot;errorMessage \t\t\t\t: {:#x}\n&quot;</span>.format(dyld_all_image_infos_errorMessage)
    <span class="enscript-keyword">if</span> dyld_all_image_infos_errorMessage != 0:
        out_str += GetUserspaceString(task, dyld_all_image_infos_errorMessage)

    out_str += <span class="enscript-string">&quot;terminationFlags \t\t\t: {:#x}\n&quot;</span>.format(dyld_all_image_infos_terminationFlags)
    out_str += <span class="enscript-string">&quot;coreSymbolicationShmPage \t\t: {:#x}\n&quot;</span>.format(dyld_all_image_infos_coreSymbolicationShmPage)
    out_str += <span class="enscript-string">&quot;systemOrderFlag \t\t\t: {:#x}\n&quot;</span>.format(dyld_all_image_infos_systemOrderFlag)
    out_str += <span class="enscript-string">&quot;uuidArrayCount \t\t\t\t: {:#x}\n&quot;</span>.format(dyld_all_image_infos_uuidArrayCount)
    out_str += <span class="enscript-string">&quot;uuidArray \t\t\t\t: {:#x}\n&quot;</span>.format(dyld_all_image_infos_uuidArray)
    out_str += <span class="enscript-string">&quot;dyldAllImageInfosAddress \t\t: {:#x}&quot;</span>.format(dyld_all_image_infos_dyldAllImageInfosAddress)
    <span class="enscript-keyword">if</span> (dyld_all_imfo_infos_slide != 0):
        out_str += <span class="enscript-string">&quot; (currently {:#x})\n&quot;</span>.format(dyld_all_image_infos_address)
    <span class="enscript-keyword">else</span>:
        out_str += <span class="enscript-string">&quot;\n&quot;</span>

    <span class="enscript-keyword">if</span> is_task_64:
        dyld_all_image_infos_address = dyld_all_image_infos_address + 112
        dyld_all_image_infos_v10 = GetUserDataAsString(task, dyld_all_image_infos_address, 64)
        dyld_all_image_infos_initialImageCount = _ExtractDataFromString(dyld_all_image_infos_v10, 112-112, <span class="enscript-string">&quot;uint64_t&quot;</span>)
        dyld_all_image_infos_errorKind = _ExtractDataFromString(dyld_all_image_infos_v10, 120-112, <span class="enscript-string">&quot;uint64_t&quot;</span>)
        dyld_all_image_infos_errorClientOfDylibPath = _ExtractDataFromString(dyld_all_image_infos_v10, 128-112, <span class="enscript-string">&quot;uint64_t&quot;</span>)
        dyld_all_image_infos_errorTargetDylibPath = _ExtractDataFromString(dyld_all_image_infos_v10, 136-112, <span class="enscript-string">&quot;uint64_t&quot;</span>)
        dyld_all_image_infos_errorSymbol = _ExtractDataFromString(dyld_all_image_infos_v10, 144-112, <span class="enscript-string">&quot;uint64_t&quot;</span>)
        dyld_all_image_infos_sharedCacheSlide = _ExtractDataFromString(dyld_all_image_infos_v10, 152-112, <span class="enscript-string">&quot;uint64_t&quot;</span>)
        dyld_all_image_infos_sharedCacheUUID = _ExtractDataFromString(dyld_all_image_infos_v10, 160-112, <span class="enscript-string">&quot;string&quot;</span>)
    <span class="enscript-keyword">else</span>:
        dyld_all_image_infos_address = dyld_all_image_infos_address + 60
        dyld_all_image_infos_v10 = GetUserDataAsString(task, dyld_all_image_infos_address, 40)
        dyld_all_image_infos_initialImageCount = _ExtractDataFromString(dyld_all_image_infos_v10, 60-60, <span class="enscript-string">&quot;uint32_t&quot;</span>)
        dyld_all_image_infos_errorKind = _ExtractDataFromString(dyld_all_image_infos_v10, 64-60, <span class="enscript-string">&quot;uint32_t&quot;</span>)
        dyld_all_image_infos_errorClientOfDylibPath = _ExtractDataFromString(dyld_all_image_infos_v10, 68-60, <span class="enscript-string">&quot;uint32_t&quot;</span>)
        dyld_all_image_infos_errorTargetDylibPath = _ExtractDataFromString(dyld_all_image_infos_v10, 72-60, <span class="enscript-string">&quot;uint32_t&quot;</span>)
        dyld_all_image_infos_errorSymbol = _ExtractDataFromString(dyld_all_image_infos_v10, 76-60, <span class="enscript-string">&quot;uint32_t&quot;</span>)
        dyld_all_image_infos_sharedCacheSlide = _ExtractDataFromString(dyld_all_image_infos_v10, 80-60, <span class="enscript-string">&quot;uint32_t&quot;</span>)
        dyld_all_image_infos_sharedCacheUUID = _ExtractDataFromString(dyld_all_image_infos_v10, 84-60, <span class="enscript-string">&quot;string&quot;</span>)

    <span class="enscript-keyword">if</span> dyld_all_image_infos_version &gt;= 10:
        out_str += <span class="enscript-string">&quot;\ninitialImageCount \t\t\t: {:#x}\n&quot;</span>.format(dyld_all_image_infos_initialImageCount)

    <span class="enscript-keyword">if</span> dyld_all_image_infos_version &gt;= 11:
        out_str += <span class="enscript-string">&quot;errorKind \t\t\t\t: {:#x}\n&quot;</span>.format(dyld_all_image_infos_errorKind)
        out_str += <span class="enscript-string">&quot;errorClientOfDylibPath \t\t\t: {:#x}\n&quot;</span>.format(dyld_all_image_infos_errorClientOfDylibPath)
        <span class="enscript-keyword">if</span> dyld_all_image_infos_errorClientOfDylibPath != 0:
            out_str += <span class="enscript-string">&quot;\t\t\t\t&quot;</span>
            out_str += GetUserspaceString(task, dyld_all_image_infos_errorClientOfDylibPath)
            out_str += <span class="enscript-string">&quot;\n&quot;</span>
        out_str += <span class="enscript-string">&quot;errorTargetDylibPath \t\t\t: {:#x}\n&quot;</span>.format(dyld_all_image_infos_errorTargetDylibPath)
        <span class="enscript-keyword">if</span> dyld_all_image_infos_errorTargetDylibPath != 0:
            out_str += <span class="enscript-string">&quot;\t\t\t\t&quot;</span>
            out_str += GetUserspaceString(task, dyld_all_image_infos_errorTargetDylibPath)
            out_str += <span class="enscript-string">&quot;\n&quot;</span>
        out_str += <span class="enscript-string">&quot;errorSymbol \t\t\t\t: {:#x}\n&quot;</span>.format(dyld_all_image_infos_errorSymbol)
        <span class="enscript-keyword">if</span> dyld_all_image_infos_errorSymbol != 0:
            out_str += <span class="enscript-string">&quot;\t\t\t\t&quot;</span>
            out_str += GetUserspaceString(task, dyld_all_image_infos_errorSymbol)
            out_str += <span class="enscript-string">&quot;\n&quot;</span>

        <span class="enscript-keyword">if</span> dyld_all_image_infos_version &gt;= 12:
            out_str += <span class="enscript-string">&quot;sharedCacheSlide \t\t\t: {:#x}\n&quot;</span>.format(dyld_all_image_infos_sharedCacheSlide)
        <span class="enscript-keyword">if</span> dyld_all_image_infos_version &gt;= 13 <span class="enscript-keyword">and</span> dyld_all_image_infos_sharedCacheUUID != <span class="enscript-string">&quot;&quot;</span>:
            out_str += <span class="enscript-string">&quot;sharedCacheUUID \t\t\t: {:s}\n&quot;</span>.format(dyld_all_image_infos_sharedCacheUUID)
    <span class="enscript-keyword">else</span>:
        out_str += <span class="enscript-string">&quot;No dyld information available for task\n&quot;</span>
    <span class="enscript-keyword">print</span> out_str

<span class="enscript-comment"># Macro: showosmalloc
</span>@lldb_type_summary([<span class="enscript-string">'OSMallocTag'</span>])
@header(<span class="enscript-string">&quot;{0: &lt;20s} {1: &gt;5s} {2: ^16s} {3: &lt;5s} {4: &lt;40s}&quot;</span>.format(<span class="enscript-string">&quot;TAG&quot;</span>, <span class="enscript-string">&quot;COUNT&quot;</span>, <span class="enscript-string">&quot;STATE&quot;</span>, <span class="enscript-string">&quot;ATTR&quot;</span>, <span class="enscript-string">&quot;NAME&quot;</span>))
<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetOSMallocTagSummary</span>(malloc_tag):
    <span class="enscript-string">&quot;&quot;&quot; Summarize the given OSMalloc tag.
        params:
          malloc_tag : value - value representing a _OSMallocTag_ * in kernel
        returns:
          out_str - string summary of the OSMalloc tag.
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> malloc_tag:
        <span class="enscript-keyword">return</span> <span class="enscript-string">&quot;Invalid malloc tag value: 0x0&quot;</span>

    out_str = <span class="enscript-string">&quot;{: &lt;#20x} {: &gt;5d} {: ^#16x} {: &lt;5d} {: &lt;40s}\n&quot;</span>.format(malloc_tag,
        malloc_tag.OSMT_refcnt, malloc_tag.OSMT_state, malloc_tag.OSMT_attr, malloc_tag.OSMT_name)
    <span class="enscript-keyword">return</span> out_str

@lldb_command(<span class="enscript-string">'showosmalloc'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">ShowOSMalloc</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Print the outstanding allocation count of OSMalloc tags
        Usage: showosmalloc
    &quot;&quot;&quot;</span>
    summary_str = <span class="enscript-string">&quot;&quot;</span>
    tag_headp = Cast(addressof(kern.globals.OSMalloc_tag_list), <span class="enscript-string">'struct _OSMallocTag_ *'</span>)
    tagp = Cast(tag_headp.OSMT_link.next, <span class="enscript-string">'struct _OSMallocTag_ *'</span>)
    summary_str += GetOSMallocTagSummary.header + <span class="enscript-string">&quot;\n&quot;</span>
    <span class="enscript-keyword">while</span> tagp != tag_headp:
        summary_str += GetOSMallocTagSummary(tagp)
        tagp = Cast(tagp.OSMT_link.next, <span class="enscript-string">'struct _OSMallocTag_ *'</span>)

    <span class="enscript-keyword">print</span> summary_str

<span class="enscript-comment"># EndMacro: showosmalloc
</span>

@lldb_command(<span class="enscript-string">'savekcdata'</span>, <span class="enscript-string">'T:O:'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">SaveKCDataToFile</span>(cmd_args=None, cmd_options={}):
    <span class="enscript-string">&quot;&quot;&quot; Save the data referred by the kcdata_descriptor structure.
        options:
            -T: &lt;task_t&gt; pointer to task if memory referenced is in userstask.
            -O: &lt;output file path&gt; path to file to save data. default: /tmp/kcdata.&lt;timestamp&gt;.bin
        Usage: (lldb) savekcdata &lt;kcdata_descriptor_t&gt; -T &lt;task_t&gt; -O /path/to/outputfile.bin
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> cmd_args:
        <span class="enscript-keyword">raise</span> ArgumentError(<span class="enscript-string">'Please provide the kcdata descriptor.'</span>)

    kcdata = kern.GetValueFromAddress(cmd_args[0], <span class="enscript-string">'kcdata_descriptor_t'</span>)

    outputfile = <span class="enscript-string">'/tmp/kcdata.{:s}.bin'</span>.format(str(time.time()))
    task = None
    <span class="enscript-keyword">if</span> <span class="enscript-string">'-O'</span> <span class="enscript-keyword">in</span> cmd_options:
        outputfile = cmd_options[<span class="enscript-string">'-O'</span>]
    <span class="enscript-keyword">if</span> <span class="enscript-string">'-T'</span> <span class="enscript-keyword">in</span> cmd_options:
        task = kern.GetValueFromAddress(cmd_options[<span class="enscript-string">'-T'</span>], <span class="enscript-string">'task_t'</span>)

    memory_begin_address = unsigned(kcdata.kcd_addr_begin)
    memory_size = 16 + unsigned(kcdata.kcd_addr_end) - memory_begin_address
    flags_copyout = unsigned(kcdata.kcd_flags)
    <span class="enscript-keyword">if</span> flags_copyout:
        <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> task:
            <span class="enscript-keyword">raise</span> ArgumentError(<span class="enscript-string">'Invalid task pointer provided.'</span>)
        memory_data = GetUserDataAsString(task, memory_begin_address, memory_size)
    <span class="enscript-keyword">else</span>:
        data_ptr = kern.GetValueFromAddress(memory_begin_address, <span class="enscript-string">'uint8_t *'</span>)
        memory_data = []
        <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> range(memory_size):
            memory_data.append(chr(data_ptr[i]))
            <span class="enscript-keyword">if</span> i % 50000 == 0:
                <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;%d of %d            \r&quot;</span> % (i, memory_size),
        memory_data = <span class="enscript-string">''</span>.join(memory_data)

    <span class="enscript-keyword">if</span> len(memory_data) != memory_size:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Failed to read {:d} bytes from address {: &lt;#020x}&quot;</span>.format(memory_size, memory_begin_address)
        <span class="enscript-keyword">return</span> False

    fh = open(outputfile, <span class="enscript-string">'w'</span>)
    fh.write(memory_data)
    fh.close()
    <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Saved {:d} bytes to file {:s}&quot;</span>.format(memory_size, outputfile)
    <span class="enscript-keyword">return</span> True



</pre>
<hr />
</body></html>