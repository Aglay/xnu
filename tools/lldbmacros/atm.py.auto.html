<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>atm.py</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">atm.py&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-keyword">from</span> xnu <span class="enscript-keyword">import</span> *
<span class="enscript-keyword">from</span> utils <span class="enscript-keyword">import</span> *


@lldb_type_summary([<span class="enscript-string">'atm_value'</span>, <span class="enscript-string">'atm_value_t'</span>])
@header(<span class="enscript-string">&quot;{0: &lt;20s} {1: &lt;16s} {2: &lt;20s} {3: &lt;16s}&quot;</span>.format(<span class="enscript-string">&quot;atm_value&quot;</span>, <span class="enscript-string">&quot;aid&quot;</span>, <span class="enscript-string">&quot;voucher_value&quot;</span>, <span class="enscript-string">&quot;sync&quot;</span>))
<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetATMValueSummary</span>(atm_value):
    <span class="enscript-string">&quot;&quot;&quot; Summarizes the atm_value
        params: atm_value = value object of type atm_value_t
        returns: string with the summary of the type.
    &quot;&quot;&quot;</span>
    format_str = <span class="enscript-string">&quot;{0: &lt;#020x} {1: &lt;16d} {2: &lt;#020x} {3: &lt;16d}&quot;</span>
    out_string = format_str.format(atm_value, unsigned(atm_value.aid), atm_value, atm_value.sync)
    <span class="enscript-keyword">return</span> out_string


@lldb_type_summary([<span class="enscript-string">'atm_task_descriptor'</span>, <span class="enscript-string">'atm_task_descriptor_t'</span>])
@header(<span class="enscript-string">&quot;{0: &lt;20s} {1: &lt;20s} {2: &lt;16s} {3: &lt;16s} {4: &lt;10s}&quot;</span>.format(<span class="enscript-string">&quot;task_descriptor&quot;</span>, <span class="enscript-string">&quot;trace_buffer&quot;</span>, <span class="enscript-string">&quot;buffer_size&quot;</span>, <span class="enscript-string">&quot;refcount&quot;</span>, <span class="enscript-string">&quot;flags&quot;</span>))
<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetATMTaskDescriptorSummary</span>(descriptor):
    <span class="enscript-string">&quot;&quot;&quot; Summarizes atm_task_descriptor object
        params: descriptor - value object of type atm_task_descriptor_t
        returns: string - containing the description.
    &quot;&quot;&quot;</span>
    format_str = <span class="enscript-string">&quot;{0: &lt;#020x} {1: &lt;#020x} {2: &lt;#016x} {3: &lt;16d} {4: &lt;10s}&quot;</span>
    flags_str = <span class="enscript-string">&quot;&quot;</span>
    <span class="enscript-keyword">if</span> unsigned(descriptor.flags) &amp; 0x1:
        flags_str = <span class="enscript-string">&quot;DEAD&quot;</span>
    out_string = format_str.format(descriptor, descriptor.trace_buffer, descriptor.trace_buffer_size, descriptor.reference_count, flags_str)

    <span class="enscript-comment">#if DEVELOPMENT
</span>    <span class="enscript-keyword">if</span> hasattr(descriptor, <span class="enscript-string">'task'</span>):
        out_string += <span class="enscript-string">&quot;  &quot;</span> + GetTaskSummary(descriptor.task) + <span class="enscript-string">&quot; &quot;</span>  + GetProcNameForTask(descriptor.task) 
    <span class="enscript-comment">#endif
</span>
    <span class="enscript-keyword">return</span> out_string

<span class="enscript-comment"># Macro: showatmvaluelisteners
</span>@lldb_command(<span class="enscript-string">'showatmvaluelisteners'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">ShowATMValueListeners</span>(cmd_args=None, cmd_options={}):
    <span class="enscript-string">&quot;&quot;&quot; show a list of listeners for an atm_value object.
        Usage: (lldb)showatmvaluelisteners &lt;atm_value_t&gt;
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> cmd_args:
        <span class="enscript-keyword">raise</span> ArgumentError(<span class="enscript-string">&quot;Please provide arguments&quot;</span>)

    atm_val = kern.GetValueFromAddress(cmd_args[0], <span class="enscript-string">'atm_value_t'</span>)
    <span class="enscript-keyword">print</span> GetATMValueSummary.header
    <span class="enscript-keyword">print</span> GetATMValueSummary(atm_val)
    header_str = <span class="enscript-string">&quot;{0: &lt;20s} &quot;</span>.format(<span class="enscript-string">&quot;#guard&quot;</span>) + GetATMTaskDescriptorSummary.header
    <span class="enscript-comment">#if DEVELOPMENT
</span>    header_str += <span class="enscript-string">&quot;  &quot;</span> +  GetTaskSummary.header + <span class="enscript-string">&quot; procname&quot;</span>
    <span class="enscript-comment">#endif
</span>    <span class="enscript-keyword">print</span> header_str
    <span class="enscript-keyword">for</span> listener <span class="enscript-keyword">in</span> IterateQueue(atm_val.listeners, <span class="enscript-string">'atm_link_object_t'</span>, <span class="enscript-string">'listeners_element'</span>):
        listener_summary = <span class="enscript-string">&quot;{0: &lt;#020x}&quot;</span>.format(listener.guard)
        listener_summary += <span class="enscript-string">&quot; &quot;</span> + GetATMTaskDescriptorSummary(listener.descriptor)
        <span class="enscript-keyword">print</span> listener_summary
    <span class="enscript-keyword">return</span> 
<span class="enscript-comment"># EndMacro: showatmvaluelisteners
</span>

<span class="enscript-comment">#if DEVELOPMENT
</span>
<span class="enscript-comment"># Macro: showallatmallocatedvalueslist
</span>@lldb_command(<span class="enscript-string">'showallatmallocatedvalueslist'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">ShowAllATMAllocatedValuesList</span>(cmd_args=None, cmd_options={}):
    <span class="enscript-string">&quot;&quot;&quot; A DEVELOPMENT macro that walks the list of all allocated atm_value objects
        and prints them.
        usage: (lldb) showallatmallocatedvalueslist
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> hasattr(kern.globals, <span class="enscript-string">'atm_values_list'</span>):
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;It seems you are running a build of kernel that does not have the list of all atm_values_list.&quot;</span>
        <span class="enscript-keyword">return</span> False
    <span class="enscript-keyword">print</span> GetATMValueSummary.header
    <span class="enscript-keyword">for</span> v <span class="enscript-keyword">in</span> IterateQueue(kern.globals.atm_values_list, <span class="enscript-string">'atm_value_t'</span>, <span class="enscript-string">'value_elt'</span>):
        <span class="enscript-keyword">print</span> GetATMValueSummary(v)
    <span class="enscript-keyword">return</span> True
<span class="enscript-comment"># EndMacro: showallatmallocatedvalueslist
</span>
<span class="enscript-comment"># Macro: showallatmdescriptors
</span>@lldb_command(<span class="enscript-string">'showallatmdescriptors'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">ShowAllATMDescriptors</span>(cmd_args=None, cmd_options={}):
    <span class="enscript-string">&quot;&quot;&quot; A DEVELOPMENT macro that walks the list of all atm_descriptors_list
        and prints the summary for each.
        usage: (lldb) showallatmdescriptors
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> hasattr(kern.globals, <span class="enscript-string">'atm_descriptors_list'</span>):
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;It seems you are running a build of kernel that does not have the list of all atm_descriptors_list.&quot;</span>
        <span class="enscript-keyword">return</span> False

    <span class="enscript-keyword">print</span> GetATMTaskDescriptorSummary.header
    <span class="enscript-keyword">for</span> d <span class="enscript-keyword">in</span> IterateQueue(kern.globals.atm_descriptors_list, <span class="enscript-string">'atm_task_descriptor_t'</span>, <span class="enscript-string">'descriptor_elt'</span>):
        <span class="enscript-keyword">print</span> GetATMTaskDescriptorSummary(d)
    <span class="enscript-keyword">return</span> True 
<span class="enscript-comment"># EndMacro
</span><span class="enscript-comment">#endif
</span></pre>
<hr />
</body></html>