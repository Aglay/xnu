<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>kdp.py</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">kdp.py&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-keyword">from</span> xnu <span class="enscript-keyword">import</span> *
<span class="enscript-keyword">from</span> utils <span class="enscript-keyword">import</span> *
<span class="enscript-keyword">import</span> sys

<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetKDPPacketHeaderInt</span>(request=0, is_reply=False, seq=0, length=0, key=0):
    <span class="enscript-string">&quot;&quot;&quot; create a 64 bit number that could be saved as pkt_hdr_t
        params:
            request:int   - 7 bit kdp_req_t request type
            is_reply:bool - False =&gt; request, True =&gt; reply 
            seq: int      - 8  sequence number within session 
            length: int   - 16 bit length of entire pkt including hdr 
            key: int      - session key 
        returns:
            int - 64 bit number to be saved in memory
    &quot;&quot;&quot;</span>
    retval = request 
    <span class="enscript-keyword">if</span> is_reply:
        retval = 1&lt;&lt;7 |retval
    retval = (seq &lt;&lt; 8) | retval
    retval = (length &lt;&lt; 16) | retval
    <span class="enscript-comment">#retval = (retval &lt;&lt; 32) | key
</span>    retval = (key &lt;&lt; 32) | retval
    <span class="enscript-keyword">return</span> retval


<span class="enscript-keyword">def</span> <span class="enscript-function-name">KDPDumpInfo</span>(subcmd, file_name=<span class="enscript-string">&quot;&quot;</span>, dest_ip=<span class="enscript-string">&quot;&quot;</span>, router_ip=<span class="enscript-string">&quot;&quot;</span>, port=0):
    <span class="enscript-string">&quot;&quot;&quot; Setup the state for DUMP INFO commands for sending coredump etc
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-string">&quot;kdp&quot;</span> != GetConnectionProtocol():
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Target is not connected over kdp. Nothing to do here.&quot;</span>
        <span class="enscript-keyword">return</span> False
    input_address = unsigned(addressof(kern.globals.manual_pkt.input))
    len_address = unsigned(addressof(kern.globals.manual_pkt.len))
    data_address = unsigned(addressof(kern.globals.manual_pkt.data))
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt32ToMemoryAddress(0, input_address):
        <span class="enscript-keyword">return</span> False

    kdp_pkt_size = GetType(<span class="enscript-string">'kdp_dumpinfo_req_t'</span>).GetByteSize()
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt32ToMemoryAddress(kdp_pkt_size, len_address):
        <span class="enscript-keyword">return</span> False

    data_addr = int(addressof(kern.globals.manual_pkt))
    pkt = kern.GetValueFromAddress(data_addr, <span class="enscript-string">'kdp_dumpinfo_req_t *'</span>)
    <span class="enscript-keyword">if</span> len(file_name) &gt; 49:
        file_name = file_name[:49]
    <span class="enscript-keyword">if</span> len(dest_ip) &gt; 15:
        dest_ip = dest_ip[:15]
    <span class="enscript-keyword">if</span> len(router_ip) &gt; 15:
        router_ip = router_ip[:15]

    header_value =GetKDPPacketHeaderInt(request=GetEnumValue(<span class="enscript-string">'kdp_req_t::KDP_DUMPINFO'</span>), length=kdp_pkt_size)
    <span class="enscript-comment"># 0x1f is same as KDP_DUMPINFO
</span>    <span class="enscript-keyword">if</span> ( WriteInt64ToMemoryAddress((header_value), int(addressof(pkt.hdr))) <span class="enscript-keyword">and</span>
         WriteInt32ToMemoryAddress(subcmd, int(addressof(pkt.type))) <span class="enscript-keyword">and</span>
         WriteStringToMemoryAddress(file_name, int(addressof(pkt.name))) <span class="enscript-keyword">and</span>
         WriteStringToMemoryAddress(dest_ip, int(addressof(pkt.destip))) <span class="enscript-keyword">and</span>
         WriteStringToMemoryAddress(router_ip, int(addressof(pkt.routerip)))
         ):
         <span class="enscript-comment">#We have saved important data successfully
</span>        <span class="enscript-keyword">if</span> port &gt; 0:
            <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt32ToMemoryAddress(port, int(addressof(pkt.port))):
                <span class="enscript-keyword">return</span> False
        <span class="enscript-keyword">if</span> WriteInt32ToMemoryAddress(1, input_address):
            <span class="enscript-keyword">return</span> True
    <span class="enscript-keyword">return</span> False

@lldb_command(<span class="enscript-string">'sendcore'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">KDPSendCore</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot;  Configure kernel to send a coredump to the specified IP
    Syntax: sendcore &lt;IP address&gt; [filename]
    Configure the kernel to transmit a kernel coredump to a server (kdumpd) 
    at the specified IP address. This is useful when the remote target has
    not been previously configured to transmit coredumps, and you wish to
    preserve kernel state for later examination. NOTE: You must issue a &quot;continue&quot;
    command after using this macro to trigger the kernel coredump. The kernel
    will resume waiting in the debugger after completion of the coredump. You
    may disable coredumps by executing the &quot;disablecore&quot; macro. You can 
    optionally specify the filename to be used for the generated core file.

    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> cmd_args == None <span class="enscript-keyword">or</span> len(cmd_args) &lt; 1:
        <span class="enscript-keyword">print</span> KDPSendCore.__doc__
        <span class="enscript-keyword">return</span> False
    ip_address = cmd_args[0]
    filename=<span class="enscript-string">&quot;&quot;</span>
    <span class="enscript-keyword">if</span> len(cmd_args) &gt;=2:
        filename = cmd_args[1].strip()
    retval = KDPDumpInfo(GetEnumValue(<span class="enscript-string">'kdp_dumpinfo_t::KDP_DUMPINFO_CORE'</span>), file_name=filename, dest_ip=ip_address)
    <span class="enscript-keyword">if</span> retval:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Remote system has been setup for coredump. Please detach/continue the system. &quot;</span>
        <span class="enscript-keyword">return</span> True
    <span class="enscript-keyword">else</span>:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Something went wrong. Failed to setup the coredump on the target.&quot;</span>
        <span class="enscript-keyword">return</span> False

    
@lldb_command(<span class="enscript-string">'sendsyslog'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">KDPSendSyslog</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Configure kernel to send a system log to the specified IP
        Syntax: sendsyslog &lt;IP address&gt; [filename]
        Configure the kernel to transmit a kernel system log to a server (kdumpd) 
        at the specified IP address. NOTE: You must issue a &quot;continue&quot;
        command after using this macro to trigger the kernel system log. The kernel
        will resume waiting in the debugger after completion. You can optionally
        specify the name to be used for the generated system log.
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> cmd_args == None <span class="enscript-keyword">or</span> len(cmd_args) &lt; 1:
        <span class="enscript-keyword">print</span> KDPSendSyslog.__doc__
        <span class="enscript-keyword">return</span> False
    ip_address = cmd_args[0]
    filename =<span class="enscript-string">&quot;&quot;</span>
    <span class="enscript-keyword">if</span> len(cmd_args) &gt;=2:
        filename = cmd_args[1].strip()
    retval = KDPDumpInfo(GetEnumValue(<span class="enscript-string">'kdp_dumpinfo_t::KDP_DUMPINFO_SYSTEMLOG'</span>), file_name = filename, dest_ip = ip_address)
    <span class="enscript-keyword">if</span> retval:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Remote system has been setup to send system log. please detach/continue the system.&quot;</span>
        <span class="enscript-keyword">return</span> True
    <span class="enscript-keyword">else</span>:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Something went wrong. Failed to setup the systemlog on the target.&quot;</span>
        <span class="enscript-keyword">return</span> False

@lldb_command(<span class="enscript-string">'sendpaniclog'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">KDPSendPaniclog</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Configure kernel to send a panic log to the specified IP
        Syntax: sendpaniclog &lt;IP address&gt; [filename]
        Configure the kernel to transmit a kernel paniclog to a server (kdumpd) 
        at the specified IP address. NOTE: You must issue a &quot;continue&quot;
        command after using this macro to trigger the kernel panic log. The kernel
        will resume waiting in the debugger after completion. You can optionally
        specify the name to be used for the generated panic log.
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> cmd_args == None <span class="enscript-keyword">or</span> len(cmd_args) &lt; 1:
        <span class="enscript-keyword">print</span> KDPSendPaniclog.__doc__
        <span class="enscript-keyword">return</span> False
    ip_address = cmd_args[0]
    filename =<span class="enscript-string">&quot;&quot;</span>
    <span class="enscript-keyword">if</span> len(cmd_args) &gt;=2:
        filename = cmd_args[1].strip()
    retval = KDPDumpInfo(GetEnumValue(<span class="enscript-string">'kdp_dumpinfo_t::KDP_DUMPINFO_PANICLOG'</span>), file_name = filename, dest_ip = ip_address)
    <span class="enscript-keyword">if</span> retval:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Remote system has been setup to send panic log. please detach/continue the system.&quot;</span>
        <span class="enscript-keyword">return</span> True
    <span class="enscript-keyword">else</span>:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Something went wrong. Failed to setup the paniclog on the target.&quot;</span>
        <span class="enscript-keyword">return</span> False


@lldb_command(<span class="enscript-string">'disablecore'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">KDPDisableCore</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Configure the kernel to disable coredump transmission
        Reconfigures the kernel so that it no longer transmits kernel coredumps. This
        complements the &quot;sendcore&quot; macro, but it may be used if the kernel has been
        configured to transmit coredumps through boot-args as well.

    &quot;&quot;&quot;</span>
    retval = KDPDumpInfo(GetEnumValue(<span class="enscript-string">'kdp_dumpinfo_t::KDP_DUMPINFO_DISABLE'</span>))
    <span class="enscript-keyword">if</span> retval :
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Disabled coredump functionality on remote system.&quot;</span>
    <span class="enscript-keyword">else</span>:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Failed to disable coredump functionality.&quot;</span>
    <span class="enscript-keyword">return</span> retval

@lldb_command(<span class="enscript-string">'resume_on'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">KDPResumeON</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; The target system will resume when detaching  or exiting from lldb. 
        This is the default behavior.
    &quot;&quot;&quot;</span>
    subcmd = GetEnumValue(<span class="enscript-string">'kdp_dumpinfo_t::KDP_DUMPINFO_SETINFO'</span>) | GetEnumValue(<span class="enscript-string">'kdp_dumpinfo_t::KDP_DUMPINFO_RESUME'</span>) 
    retval = KDPDumpInfo(subcmd)
    <span class="enscript-keyword">if</span> retval :
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Target system will resume on detaching from lldb.&quot;</span>
    <span class="enscript-keyword">else</span>:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Failed to enable resume functionality.&quot;</span>
    <span class="enscript-keyword">return</span> retval

@lldb_command(<span class="enscript-string">'resume_off'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">KDPResumeON</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; The target system will not resume when detaching  or exiting from lldb. 
    &quot;&quot;&quot;</span>
    subcmd = GetEnumValue(<span class="enscript-string">'kdp_dumpinfo_t::KDP_DUMPINFO_SETINFO'</span>) | GetEnumValue(<span class="enscript-string">'kdp_dumpinfo_t::KDP_DUMPINFO_NORESUME'</span>) 
    retval = KDPDumpInfo(subcmd)
    <span class="enscript-keyword">if</span> retval :
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Target system will not resume on detaching from lldb.&quot;</span>
    <span class="enscript-keyword">else</span>:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Failed to disable resume functionality.&quot;</span>
    <span class="enscript-keyword">return</span> retval



@lldb_command(<span class="enscript-string">'getdumpinfo'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">KDPGetDumpInfo</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Retrieve the current remote dump settings.
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> KDPDumpInfo(GetEnumValue(<span class="enscript-string">'kdp_dumpinfo_t::KDP_DUMPINFO_GETINFO'</span>)):
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Failed to get dump settings.&quot;</span>
        <span class="enscript-keyword">return</span> False
    dumpinfo = Cast(addressof(kern.globals.manual_pkt.data), <span class="enscript-string">'kdp_dumpinfo_reply_t *'</span>)
    target_dump_type = int(dumpinfo.type)
    <span class="enscript-keyword">if</span> target_dump_type &amp; GetEnumValue(<span class="enscript-string">'kdp_dumpinfo_t::KDP_DUMPINFO_REBOOT'</span>):
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;System will reboot after kernel info gets dumped.&quot;</span>
    <span class="enscript-keyword">else</span>:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;System will not reboot after kernel info gets dumped.&quot;</span>
    <span class="enscript-keyword">if</span> target_dump_type &amp; GetEnumValue(<span class="enscript-string">'kdp_dumpinfo_t::KDP_DUMPINFO_RESUME'</span>):
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;System will allow a re-attach after KDP disconnect.&quot;</span>
    <span class="enscript-keyword">else</span>:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;System will not allow a re-attach after KDP disconnect.&quot;</span>
    target_dump_type = target_dump_type &amp; GetEnumValue(<span class="enscript-string">'kdp_dumpinfo_t::KDP_DUMPINFO_MASK'</span>)
    <span class="enscript-keyword">if</span> target_dump_type == GetEnumValue(<span class="enscript-string">'kdp_dumpinfo_t::KDP_DUMPINFO_DISABLE'</span>):
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Kernel not setup for remote dumps.&quot;</span>
    <span class="enscript-keyword">else</span>:
        kern_dump_type = <span class="enscript-string">''</span>
        <span class="enscript-keyword">if</span> target_dump_type == GetEnumValue(<span class="enscript-string">'kdp_dumpinfo_t::KDP_DUMPINFO_CORE'</span>):
            kern_dump_type = <span class="enscript-string">&quot;Core File&quot;</span>
        <span class="enscript-keyword">elif</span> target_dump_type == GetEnumValue(<span class="enscript-string">'kdp_dumpinfo_t::KDP_DUMPINFO_PANICLOG'</span>):
            kern_dump_type = <span class="enscript-string">&quot;Panic Log&quot;</span>
        <span class="enscript-keyword">elif</span> target_dump_type == GetEnumValue(<span class="enscript-string">'kdp_dumpinfo_t::KDP_DUMPINFO_SYSTEMLOG'</span>):
            kern_dump_type = <span class="enscript-string">&quot;System Log&quot;</span>
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Kernel dump type:&quot;</span> + kern_dump_type
        fname = <span class="enscript-string">&quot;(autogenerated)&quot;</span>
        <span class="enscript-keyword">if</span> int(dumpinfo.name[0]) != 0:
            fname = str(dumpinfo.name)
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Filename: &quot;</span> + fname
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Network Info: {:s} [{:d}] , Router: {:s}&quot;</span>.format(dumpinfo.destip, dumpinfo.port, dumpinfo.routerip)
    <span class="enscript-comment"># end of get dump info
</span>

@lldb_command(<span class="enscript-string">'kdp-reenter'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">KDPReenter</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Schedules reentry into the debugger 
        after &lt;seconds&gt; seconds, and resumes the target.
        usage: kdp-reenter &lt;seconds&gt;
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> len(cmd_args) &lt; 1:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Please provide valid time in seconds&quot;</span>
        <span class="enscript-keyword">print</span> KDPReenter.__doc__
        <span class="enscript-keyword">return</span> False

    <span class="enscript-keyword">if</span> <span class="enscript-string">&quot;kdp&quot;</span> != GetConnectionProtocol():
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Target is not connected over kdp. Nothing to do here.&quot;</span>
        <span class="enscript-keyword">return</span> False

    num_seconds = ArgumentStringToInt(cmd_args[0])
    milliseconds_to_sleep = num_seconds * 1000
    <span class="enscript-keyword">if</span> WriteInt32ToMemoryAddress(milliseconds_to_sleep, addressof(kern.globals.kdp_reentry_deadline)):
        lldb.debugger.HandleCommand(<span class="enscript-string">'process continue'</span>)
        <span class="enscript-keyword">return</span> True
    <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Failed to setup kdp-reentry.&quot;</span>
    <span class="enscript-keyword">return</span> False

@lldb_command(<span class="enscript-string">'kdp-reboot'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">KDPReboot</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Restart the remote target
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-string">&quot;kdp&quot;</span> != GetConnectionProtocol():
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Target is not connected over kdp. Nothing to do here.&quot;</span>
        <span class="enscript-keyword">return</span> False

    <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Rebooting the remote machine.&quot;</span>
    lldb.debugger.HandleCommand(<span class="enscript-string">'process plugin packet send --command 0x13'</span>)
    lldb.debugger.HandleCommand(<span class="enscript-string">'detach'</span>)
    <span class="enscript-keyword">return</span> True

@lldb_command(<span class="enscript-string">'setdumpinfo'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">KDPSetDumpInfo</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Configure the current remote dump settings. 
        Specify &quot;&quot; if you want to use the defaults (filename) or previously configured
        settings (ip/router). Specify 0 for the port if you wish to 
        use the previously configured/default setting for that.
        Syntax: setdumpinfo &lt;filename&gt; &lt;ip&gt; &lt;router&gt; &lt;port&gt;
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> cmd_args:
        <span class="enscript-keyword">print</span> KDPSetDumpInfo.__doc__
        <span class="enscript-keyword">return</span> False
    <span class="enscript-keyword">if</span> len(cmd_args) &lt; 4:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Not enough arguments.&quot;</span>
        <span class="enscript-keyword">print</span> KDPSetDumpInfo.__doc__
        <span class="enscript-keyword">return</span> False
    portnum = ArgumentStringToInt(cmd_args[3])
    retval = KDPDumpInfo(GetEnumValue(<span class="enscript-string">'kdp_dumpinfo_t::KDP_DUMPINFO_SETINFO'</span>), cmd_args[0], cmd_args[1], cmd_args[2], portnum)
    <span class="enscript-keyword">if</span> retval:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Successfully saved the dumpinfo.&quot;</span>
    <span class="enscript-keyword">else</span>:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Failed to save the dumpinfo.&quot;</span>
    <span class="enscript-keyword">return</span> retval

</pre>
<hr />
</body></html>