<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>ipcimportancedetail.py</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">ipcimportancedetail.py&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-keyword">from</span> xnu <span class="enscript-keyword">import</span> *

<span class="enscript-string">&quot;&quot;&quot;
Recursive ipc importance chain viewing macro. This file incorporates complex python datastructures
interspersed with cvalue based objects from lldb interface. 
&quot;&quot;&quot;</span>

<span class="enscript-keyword">class</span> TaskNode(object):
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__init__</span>(self, task_kobj):
        self.task = task_kobj
        self.importance_refs = []
    
    @staticmethod
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetHeaderString</span>():
        <span class="enscript-keyword">return</span> GetTaskSummary.header + <span class="enscript-string">&quot; &quot;</span> + GetProcSummary.header + <span class="enscript-string">&quot; {: &lt;18s}&quot;</span>.format(<span class="enscript-string">&quot;task_imp_base&quot;</span>)

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__str__</span>(self):
        out_arr = []
        <span class="enscript-keyword">if</span> unsigned(self.task) != 0: 
            out_arr.append(GetTaskSummary(self.task) + <span class="enscript-string">&quot; &quot;</span> + GetProcSummary(Cast(self.task.bsd_info, <span class="enscript-string">'proc *'</span>)) + <span class="enscript-string">&quot; {: &lt;#018x}&quot;</span>.format(self.task.task_imp_base) )
        <span class="enscript-keyword">else</span>:
            out_arr.append(<span class="enscript-string">&quot;Unknown task.&quot;</span>)
        <span class="enscript-comment">#out_arr.append(&quot;TASK: {: &lt;#018x} {: &lt;s}&quot;.format(self.task, GetProcNameForTask(self.task))
</span>        <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> self.importance_refs:
            out_arr.append(<span class="enscript-string">&quot;\t&quot;</span> + i.GetBackRefChain())
        <span class="enscript-keyword">return</span> <span class="enscript-string">&quot;\n&quot;</span>.join(out_arr)

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">AddImportanceNode</span>(self, iinode):
        self.importance_refs.append(iinode)

<span class="enscript-keyword">class</span> IIINode(object):
    <span class="enscript-string">&quot;&quot;&quot;docstring for IIINode&quot;&quot;&quot;</span>
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__init__</span>(self, elem, parentNode):
        super(IIINode, self).__init__()
        self.elem = elem
        self.children = []
        self.parent = parentNode

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">addChildNode</span>(self, elemNode):
        self.children.append(elemNode)

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__str__</span>(self):
        <span class="enscript-keyword">if</span> unsigned(self.elem.iii_elem.iie_bits) &amp; 0x80000000:
            <span class="enscript-keyword">return</span> GetIPCImportanceInheritSummary(self.elem)
        <span class="enscript-keyword">else</span>:
            <span class="enscript-keyword">return</span> GetIPCImportantTaskSummary(self.elem)
    
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetShortSummary</span>(self):
        to_task = self.GetToTask()
        <span class="enscript-keyword">if</span> unsigned(self.elem.iii_elem.iie_bits) &amp; 0x80000000:
            <span class="enscript-keyword">return</span> <span class="enscript-string">&quot;{: &lt;#018x} INH ({:d}){: &lt;s}&quot;</span>.format(self.elem, GetProcPIDForTask(to_task), GetProcNameForTask(to_task))
        <span class="enscript-keyword">else</span>:
            <span class="enscript-keyword">return</span> <span class="enscript-string">&quot;{: &lt;#018x} IIT ({:d}){: &lt;s}&quot;</span>.format(self.elem, GetProcPIDForTask(to_task), GetProcNameForTask(to_task))

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetChildSummaries</span>(self, prefix=<span class="enscript-string">&quot;\t&quot;</span>):
        retval = []
        <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> self.children:
            retval.append(prefix + str(i))
            retval.append(i.GetChildSummaries(prefix+<span class="enscript-string">&quot;\t&quot;</span>))
        <span class="enscript-keyword">return</span> <span class="enscript-string">&quot;\n&quot;</span>.join(retval)

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetToTask</span>(self):
        <span class="enscript-keyword">if</span> unsigned(self.elem.iii_elem.iie_bits) &amp; 0x80000000:
            <span class="enscript-keyword">return</span> self.elem.iii_to_task.iit_task
        <span class="enscript-keyword">else</span>:
            <span class="enscript-keyword">return</span> self.elem.iit_task

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetParentNode</span>(self):
        <span class="enscript-keyword">return</span> self.parent

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetBackRefChain</span>(self):
        out_str = <span class="enscript-string">&quot;&quot;</span>
        cur_elem = self.elem
        out_str += self.GetShortSummary()
        from_elem = Cast(cur_elem.iii_from_elem, <span class="enscript-string">'ipc_importance_inherit *'</span>)
        <span class="enscript-comment"># NOTE: We are exploiting the layout of iit and iii to have iie at the begining.
</span>        <span class="enscript-comment"># so casting one to another is fine as long as we tread carefully.
</span>        
        <span class="enscript-keyword">while</span> unsigned(from_elem.iii_elem.iie_bits) &amp; 0x80000000:
            out_str += <span class="enscript-string">&quot; &lt;- {: &lt;#018x} INH ({:d}){: &lt;s}&quot;</span>.format(from_elem, GetProcPIDForTask(from_elem.iii_to_task.iit_task), GetProcNameForTask(from_elem.iii_to_task.iit_task))
            from_elem = Cast(from_elem.iii_from_elem, <span class="enscript-string">'ipc_importance_inherit *'</span>)

        <span class="enscript-keyword">if</span> unsigned(from_elem.iii_elem.iie_bits) &amp; 0x80000000 == 0:
            iit_elem = Cast(from_elem, <span class="enscript-string">'ipc_importance_task *'</span>)
            out_str += <span class="enscript-string">&quot; &lt;- {: &lt;#018x} IIT ({:d}){: &lt;s}&quot;</span>.format(iit_elem, GetProcPIDForTask(iit_elem.iit_task), GetProcNameForTask(iit_elem.iit_task))
        
        <span class="enscript-keyword">return</span> out_str

        <span class="enscript-comment">#unused
</span>        cur_elem = self
        <span class="enscript-keyword">while</span> cur_elem.parent:
            out_str += <span class="enscript-string">&quot;&lt;-&quot;</span> + cur_elem.GetShortSummary()
            cur_elem = cur_elem.GetParentNode()
        <span class="enscript-keyword">return</span> out_str
        
<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetIIIListFromIIE</span>(iie, rootnode):
    <span class="enscript-string">&quot;&quot;&quot; walk the iii queue and find each III element in a list format
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> IterateQueue(iie.iie_inherits, <span class="enscript-string">'struct ipc_importance_inherit *'</span>,  <span class="enscript-string">'iii_inheritance'</span>):
        iieNode = IIINode(i, rootnode)
        <span class="enscript-keyword">if</span> unsigned(i.iii_elem.iie_bits) &amp; 0x80000000:
            rootnode.addChildNode(iieNode)
            GetIIIListFromIIE(i.iii_elem, iieNode)
            GetTaskNodeByKernelTaskObj(iieNode.GetToTask()).AddImportanceNode(iieNode)
    <span class="enscript-keyword">return</span> 

AllTasksCollection = {}
<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetTaskNodeByKernelTaskObj</span>(task_kobj):
    <span class="enscript-keyword">global</span> AllTasksCollection
    key = hex(unsigned(task_kobj))
    <span class="enscript-keyword">if</span> key <span class="enscript-keyword">not</span> <span class="enscript-keyword">in</span> AllTasksCollection:
        AllTasksCollection[key] = TaskNode(task_kobj)
    <span class="enscript-keyword">return</span> AllTasksCollection[key]
    


@lldb_command(<span class="enscript-string">'showallipcimportance'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">ShowInheritanceChains</span>(cmd_args=[], cmd_options={}):
    <span class="enscript-string">&quot;&quot;&quot; show boost inheritance chains.
        Usage: (lldb) showboostinheritancechains  &lt;task_t&gt;
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">print</span> <span class="enscript-string">' '</span> + GetIPCImportantTaskSummary.header + <span class="enscript-string">' '</span> + GetIPCImportanceElemSummary.header
    <span class="enscript-keyword">for</span> task <span class="enscript-keyword">in</span> kern.tasks:
        <span class="enscript-keyword">if</span> unsigned(task.task_imp_base):
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot; &quot;</span> + GetIPCImportantTaskSummary(task.task_imp_base) + <span class="enscript-string">' '</span> + GetIPCImportanceElemSummary(addressof(task.task_imp_base.iit_elem))
            base_node = IIINode(Cast(task.task_imp_base, <span class="enscript-string">'ipc_importance_inherit *'</span>), None)
            GetIIIListFromIIE(task.task_imp_base.iit_elem, base_node)
            <span class="enscript-keyword">print</span> base_node.GetChildSummaries(prefix=<span class="enscript-string">&quot;\t\t&quot;</span>)
    
    <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;\n\n ======================== TASK REVERSE CHAIN OF IMPORTANCES =========================&quot;</span>
    <span class="enscript-keyword">print</span> TaskNode.GetHeaderString()
    <span class="enscript-keyword">for</span> k <span class="enscript-keyword">in</span> AllTasksCollection.keys():
        t = AllTasksCollection[k]
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;\n&quot;</span> + str(t)

</pre>
<hr />
</body></html>