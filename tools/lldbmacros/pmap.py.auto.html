<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>pmap.py</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">pmap.py&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-keyword">from</span> xnu <span class="enscript-keyword">import</span> *
<span class="enscript-keyword">import</span> xnudefines
<span class="enscript-keyword">from</span> kdp <span class="enscript-keyword">import</span> *
<span class="enscript-keyword">from</span> utils <span class="enscript-keyword">import</span> *

<span class="enscript-keyword">def</span> <span class="enscript-function-name">ReadPhysInt</span>(phys_addr, bitsize = 64, cpuval = None):
    <span class="enscript-string">&quot;&quot;&quot; Read a physical memory data based on address.
        params:
            phys_addr : int - Physical address to read
            bitsize   : int - defines how many bytes to read. defaults to 64 bit
            cpuval    : None (optional)
        returns:
            int - int value read from memory. in case of failure 0xBAD10AD is returned.
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-string">&quot;kdp&quot;</span> == GetConnectionProtocol():
        <span class="enscript-keyword">return</span> KDPReadPhysMEM(phys_addr, bitsize)

    <span class="enscript-comment">#NO KDP. Attempt to use physical memory
</span>    paddr_in_kva = kern.PhysToKernelVirt(long(phys_addr))
    <span class="enscript-keyword">if</span> paddr_in_kva :
        <span class="enscript-keyword">if</span> bitsize == 64 :
            <span class="enscript-keyword">return</span> kern.GetValueFromAddress(paddr_in_kva, <span class="enscript-string">'uint64_t *'</span>).GetSBValue().Dereference().GetValueAsUnsigned()
        <span class="enscript-keyword">if</span> bitsize == 32 :
            <span class="enscript-keyword">return</span> kern.GetValueFromAddress(paddr_in_kva, <span class="enscript-string">'uint32_t *'</span>).GetSBValue().Dereference().GetValueAsUnsigned()
        <span class="enscript-keyword">if</span> bitsize == 16 :
            <span class="enscript-keyword">return</span> kern.GetValueFromAddress(paddr_in_kva, <span class="enscript-string">'uint16_t *'</span>).GetSBValue().Dereference().GetValueAsUnsigned()
        <span class="enscript-keyword">if</span> bitsize == 8 :
            <span class="enscript-keyword">return</span> kern.GetValueFromAddress(paddr_in_kva, <span class="enscript-string">'uint8_t *'</span>).GetSBValue().Dereference().GetValueAsUnsigned()
    <span class="enscript-keyword">return</span> 0xBAD10AD

@lldb_command(<span class="enscript-string">'readphys'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">ReadPhys</span>(cmd_args = None):
    <span class="enscript-string">&quot;&quot;&quot; Reads the specified untranslated address
        The argument is interpreted as a physical address, and the 64-bit word
        addressed is displayed.
        usage: readphys &lt;nbits&gt; &lt;address&gt;
        nbits: 8,16,32,64
        address: 1234 or 0x1234
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> cmd_args == None <span class="enscript-keyword">or</span> len(cmd_args) &lt; 2:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Insufficient arguments.&quot;</span>, ReadPhys.__doc__
        <span class="enscript-keyword">return</span> False
    <span class="enscript-keyword">else</span>:
        nbits = ArgumentStringToInt(cmd_args[0])
        phys_addr = ArgumentStringToInt(cmd_args[1])
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;{0: &lt;#x}&quot;</span>.format(ReadPhysInt(phys_addr, nbits))
    <span class="enscript-keyword">return</span> True

lldb_alias(<span class="enscript-string">'readphys8'</span>, <span class="enscript-string">'readphys 8 '</span>)
lldb_alias(<span class="enscript-string">'readphys16'</span>, <span class="enscript-string">'readphys 16 '</span>)
lldb_alias(<span class="enscript-string">'readphys32'</span>, <span class="enscript-string">'readphys 32 '</span>)
lldb_alias(<span class="enscript-string">'readphys64'</span>, <span class="enscript-string">'readphys 64 '</span>)

<span class="enscript-keyword">def</span> <span class="enscript-function-name">KDPReadPhysMEM</span>(address, bits):
    <span class="enscript-string">&quot;&quot;&quot; Setup the state for READPHYSMEM64 commands for reading data via kdp
        params:
            address : int - address where to read the data from
            bits : int - number of bits in the intval (8/16/32/64)
        returns:
            int: read value from memory.
            0xBAD10AD: if failed to read data.
    &quot;&quot;&quot;</span>
    retval = 0xBAD10AD
    <span class="enscript-keyword">if</span> <span class="enscript-string">&quot;kdp&quot;</span> != GetConnectionProtocol():
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Target is not connected over kdp. Nothing to do here.&quot;</span>
        <span class="enscript-keyword">return</span> retval

    input_address = unsigned(addressof(kern.globals.manual_pkt.input))
    len_address = unsigned(addressof(kern.globals.manual_pkt.len))
    data_address = unsigned(addressof(kern.globals.manual_pkt.data))
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt32ToMemoryAddress(0, input_address):
        <span class="enscript-keyword">return</span> retval

    kdp_pkt_size = GetType(<span class="enscript-string">'kdp_readphysmem64_req_t'</span>).GetByteSize()
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt32ToMemoryAddress(kdp_pkt_size, len_address):
        <span class="enscript-keyword">return</span> retval

    data_addr = int(addressof(kern.globals.manual_pkt))
    pkt = kern.GetValueFromAddress(data_addr, <span class="enscript-string">'kdp_readphysmem64_req_t *'</span>)

    header_value =GetKDPPacketHeaderInt(request=GetEnumValue(<span class="enscript-string">'kdp_req_t::KDP_READPHYSMEM64'</span>), length=kdp_pkt_size)

    <span class="enscript-keyword">if</span> ( WriteInt64ToMemoryAddress((header_value), int(addressof(pkt.hdr))) <span class="enscript-keyword">and</span>
         WriteInt64ToMemoryAddress(address, int(addressof(pkt.address))) <span class="enscript-keyword">and</span>
         WriteInt32ToMemoryAddress((bits/8), int(addressof(pkt.nbytes))) <span class="enscript-keyword">and</span>
         WriteInt16ToMemoryAddress(xnudefines.lcpu_self, int(addressof(pkt.lcpu)))
         ):

        <span class="enscript-keyword">if</span> WriteInt32ToMemoryAddress(1, input_address):
            <span class="enscript-comment"># now read data from the kdp packet
</span>            data_address = unsigned(addressof(kern.GetValueFromAddress(int(addressof(kern.globals.manual_pkt.data)), <span class="enscript-string">'kdp_readphysmem64_reply_t *'</span>).data))
            <span class="enscript-keyword">if</span> bits == 64 :
                retval =  kern.GetValueFromAddress(data_address, <span class="enscript-string">'uint64_t *'</span>).GetSBValue().Dereference().GetValueAsUnsigned()
            <span class="enscript-keyword">if</span> bits == 32 :
                retval =  kern.GetValueFromAddress(data_address, <span class="enscript-string">'uint32_t *'</span>).GetSBValue().Dereference().GetValueAsUnsigned()
            <span class="enscript-keyword">if</span> bits == 16 :
                retval =  kern.GetValueFromAddress(data_address, <span class="enscript-string">'uint16_t *'</span>).GetSBValue().Dereference().GetValueAsUnsigned()
            <span class="enscript-keyword">if</span> bits == 8 :
                retval =  kern.GetValueFromAddress(data_address, <span class="enscript-string">'uint8_t *'</span>).GetSBValue().Dereference().GetValueAsUnsigned()
    <span class="enscript-keyword">return</span> retval


<span class="enscript-keyword">def</span> <span class="enscript-function-name">KDPWritePhysMEM</span>(address, intval, bits):
    <span class="enscript-string">&quot;&quot;&quot; Setup the state for WRITEPHYSMEM64 commands for saving data in kdp
        params:
            address : int - address where to save the data
            intval : int - integer value to be stored in memory
            bits : int - number of bits in the intval (8/16/32/64)
        returns:
            boolean: True if the write succeeded.
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-string">&quot;kdp&quot;</span> != GetConnectionProtocol():
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Target is not connected over kdp. Nothing to do here.&quot;</span>
        <span class="enscript-keyword">return</span> False
    input_address = unsigned(addressof(kern.globals.manual_pkt.input))
    len_address = unsigned(addressof(kern.globals.manual_pkt.len))
    data_address = unsigned(addressof(kern.globals.manual_pkt.data))
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt32ToMemoryAddress(0, input_address):
        <span class="enscript-keyword">return</span> False

    kdp_pkt_size = GetType(<span class="enscript-string">'kdp_writephysmem64_req_t'</span>).GetByteSize()
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt32ToMemoryAddress(kdp_pkt_size, len_address):
        <span class="enscript-keyword">return</span> False

    data_addr = int(addressof(kern.globals.manual_pkt))
    pkt = kern.GetValueFromAddress(data_addr, <span class="enscript-string">'kdp_writephysmem64_req_t *'</span>)

    header_value =GetKDPPacketHeaderInt(request=GetEnumValue(<span class="enscript-string">'kdp_req_t::KDP_WRITEPHYSMEM64'</span>), length=kdp_pkt_size)

    <span class="enscript-keyword">if</span> ( WriteInt64ToMemoryAddress((header_value), int(addressof(pkt.hdr))) <span class="enscript-keyword">and</span>
         WriteInt64ToMemoryAddress(address, int(addressof(pkt.address))) <span class="enscript-keyword">and</span>
         WriteInt32ToMemoryAddress((bits/8), int(addressof(pkt.nbytes))) <span class="enscript-keyword">and</span>
         WriteInt16ToMemoryAddress(xnudefines.lcpu_self, int(addressof(pkt.lcpu)))
         ):

        <span class="enscript-keyword">if</span> bits == 8:
            <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt8ToMemoryAddress(intval, int(addressof(pkt.data))):
                <span class="enscript-keyword">return</span> False
        <span class="enscript-keyword">if</span> bits == 16:
            <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt16ToMemoryAddress(intval, int(addressof(pkt.data))):
                <span class="enscript-keyword">return</span> False
        <span class="enscript-keyword">if</span> bits == 32:
            <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt32ToMemoryAddress(intval, int(addressof(pkt.data))):
                <span class="enscript-keyword">return</span> False
        <span class="enscript-keyword">if</span> bits == 64:
            <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt64ToMemoryAddress(intval, int(addressof(pkt.data))):
                <span class="enscript-keyword">return</span> False
        <span class="enscript-keyword">if</span> WriteInt32ToMemoryAddress(1, input_address):
            <span class="enscript-keyword">return</span> True
    <span class="enscript-keyword">return</span> False


<span class="enscript-keyword">def</span> <span class="enscript-function-name">WritePhysInt</span>(phys_addr, int_val, bitsize = 64):
    <span class="enscript-string">&quot;&quot;&quot; Write and integer value in a physical memory data based on address.
        params:
            phys_addr : int - Physical address to read
            int_val   : int - int value to write in memory
            bitsize   : int - defines how many bytes to read. defaults to 64 bit
        returns:
            bool - True if write was successful.
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-string">&quot;kdp&quot;</span> == GetConnectionProtocol():
        <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> KDPWritePhysMEM(phys_addr, int_val, bitsize):
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Failed to write via KDP.&quot;</span>
            <span class="enscript-keyword">return</span> False
        <span class="enscript-keyword">return</span> True
    <span class="enscript-comment">#We are not connected via KDP. So do manual math and savings.
</span>    <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Failed: Write to physical memory is not supported for %s connection.&quot;</span> % GetConnectionProtocol()
    <span class="enscript-keyword">return</span> False

@lldb_command(<span class="enscript-string">'writephys'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">WritePhys</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; writes to the specified untranslated address
        The argument is interpreted as a physical address, and the 64-bit word
        addressed is displayed.
        usage: writephys &lt;nbits&gt; &lt;address&gt; &lt;value&gt;
        nbits: 8,16,32,64
        address: 1234 or 0x1234
        value: int value to be written
        ex. (lldb)writephys 16 0x12345abcd 0x25
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> cmd_args == None <span class="enscript-keyword">or</span> len(cmd_args) &lt; 3:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Invalid arguments.&quot;</span>, WritePhys.__doc__
    <span class="enscript-keyword">else</span>:
        nbits = ArgumentStringToInt(cmd_args[0])
        phys_addr = ArgumentStringToInt(cmd_args[1])
        int_value = ArgumentStringToInt(cmd_args[2])
        <span class="enscript-keyword">print</span> WritePhysInt(phys_addr, int_value, nbits)


lldb_alias(<span class="enscript-string">'writephys8'</span>, <span class="enscript-string">'writephys 8 '</span>)
lldb_alias(<span class="enscript-string">'writephys16'</span>, <span class="enscript-string">'writephys 16 '</span>)
lldb_alias(<span class="enscript-string">'writephys32'</span>, <span class="enscript-string">'writephys 32 '</span>)
lldb_alias(<span class="enscript-string">'writephys64'</span>, <span class="enscript-string">'writephys 64 '</span>)


<span class="enscript-keyword">def</span> <span class="enscript-function-name">_PT_Step</span>(paddr, index, verbose_level = vSCRIPT):
    <span class="enscript-string">&quot;&quot;&quot;
     Step to lower-level page table and print attributes
       paddr: current page table entry physical address
       index: current page table entry index (0..511)
       verbose_level:    vHUMAN: print nothing
                         vSCRIPT: print basic information
                         vDETAIL: print basic information and hex table dump
     returns: (pt_paddr, pt_valid, pt_large)
       pt_paddr: next level page table entry physical address
                      or null if invalid
       pt_valid: 1 if $kgm_pt_paddr is valid, 0 if the walk
                      should be aborted
       pt_large: 1 if kgm_pt_paddr is a page frame address
                      of a large page and not another page table entry
    &quot;&quot;&quot;</span>
    entry_addr = paddr + (8 * index)
    entry = ReadPhysInt(entry_addr, 64, xnudefines.lcpu_self )
    out_string = <span class="enscript-string">''</span>
    <span class="enscript-keyword">if</span> verbose_level &gt;= vDETAIL:
        <span class="enscript-keyword">for</span> pte_loop <span class="enscript-keyword">in</span> range(0, 512):
            paddr_tmp = paddr + (8 * pte_loop)
            out_string += <span class="enscript-string">&quot;{0: &lt;#020x}:\t {1: &lt;#020x}\n&quot;</span>.format(paddr_tmp, ReadPhysInt(paddr_tmp, 64, xnudefines.lcpu_self))
    paddr_mask = ~((0xfff&lt;&lt;52) | 0xfff)
    paddr_large_mask =  ~((0xfff&lt;&lt;52) | 0x1fffff)
    pt_valid = False
    pt_large = False
    pt_paddr = 0
    <span class="enscript-keyword">if</span> verbose_level &lt; vSCRIPT:
        <span class="enscript-keyword">if</span> entry &amp; 0x1 :
            pt_valid = True
            pt_large = False
            pt_paddr = entry &amp; paddr_mask
            <span class="enscript-keyword">if</span> entry &amp; (0x1 &lt;&lt;7):
                pt_large = True
                pt_paddr = entry &amp; paddr_large_mask
    <span class="enscript-keyword">else</span>:
        out_string+= <span class="enscript-string">&quot;{0: &lt;#020x}:\n\t{1:#020x}\n\t&quot;</span>.format(entry_addr, entry)
        <span class="enscript-keyword">if</span> entry &amp; 0x1:
            out_string += <span class="enscript-string">&quot; valid&quot;</span>
            pt_paddr = entry &amp; paddr_mask
            pt_valid = True
        <span class="enscript-keyword">else</span>:
            out_string += <span class="enscript-string">&quot; invalid&quot;</span>
            pt_paddr = 0
            pt_valid = False
            <span class="enscript-keyword">if</span> entry &amp; (0x1 &lt;&lt; 62):
                out_string += <span class="enscript-string">&quot; compressed&quot;</span>
            <span class="enscript-comment">#Stop decoding other bits
</span>            entry = 0
        <span class="enscript-keyword">if</span> entry &amp; (0x1 &lt;&lt; 1):
            out_string += <span class="enscript-string">&quot; writable&quot;</span>
        <span class="enscript-keyword">else</span>:
            out_string += <span class="enscript-string">&quot; read-only&quot;</span>

        <span class="enscript-keyword">if</span> entry &amp; (0x1 &lt;&lt; 2):
            out_string += <span class="enscript-string">&quot; user&quot;</span>
        <span class="enscript-keyword">else</span>:
            out_string += <span class="enscript-string">&quot; supervisor&quot;</span>

        <span class="enscript-keyword">if</span> entry &amp; (0x1 &lt;&lt; 3):
            out_string += <span class="enscript-string">&quot; PWT&quot;</span>

        <span class="enscript-keyword">if</span> entry &amp; (0x1 &lt;&lt; 4):
            out_string += <span class="enscript-string">&quot; PCD&quot;</span>

        <span class="enscript-keyword">if</span> entry &amp; (0x1 &lt;&lt; 5):
            out_string += <span class="enscript-string">&quot; accessed&quot;</span>

        <span class="enscript-keyword">if</span> entry &amp; (0x1 &lt;&lt; 6):
            out_string += <span class="enscript-string">&quot; dirty&quot;</span>

        <span class="enscript-keyword">if</span> entry &amp; (0x1 &lt;&lt; 7):
            out_string += <span class="enscript-string">&quot; large&quot;</span>
            pt_large = True
        <span class="enscript-keyword">else</span>:
            pt_large = False

        <span class="enscript-keyword">if</span> entry &amp; (0x1 &lt;&lt; 8):
            out_string += <span class="enscript-string">&quot; global&quot;</span>

        <span class="enscript-keyword">if</span> entry &amp; (0x3 &lt;&lt; 9):
            out_string += <span class="enscript-string">&quot; avail:{0:x}&quot;</span>.format((entry &gt;&gt; 9) &amp; 0x3)

        <span class="enscript-keyword">if</span> entry &amp; (0x1 &lt;&lt; 63):
            out_string += <span class="enscript-string">&quot; noexec&quot;</span>
    <span class="enscript-keyword">print</span> out_string
    <span class="enscript-keyword">return</span> (pt_paddr, pt_valid, pt_large)

<span class="enscript-keyword">def</span> <span class="enscript-function-name">_PT_StepEPT</span>(paddr, index, verbose_level = vSCRIPT):
    <span class="enscript-string">&quot;&quot;&quot;
     Step to lower-level page table and print attributes for EPT pmap
       paddr: current page table entry physical address
       index: current page table entry index (0..511)
       verbose_level:    vHUMAN: print nothing
                         vSCRIPT: print basic information
                         vDETAIL: print basic information and hex table dump
     returns: (pt_paddr, pt_valid, pt_large)
       pt_paddr: next level page table entry physical address
                      or null if invalid
       pt_valid: 1 if $kgm_pt_paddr is valid, 0 if the walk
                      should be aborted
       pt_large: 1 if kgm_pt_paddr is a page frame address
                      of a large page and not another page table entry
    &quot;&quot;&quot;</span>
    entry_addr = paddr + (8 * index)
    entry = ReadPhysInt(entry_addr, 64, xnudefines.lcpu_self )
    out_string = <span class="enscript-string">''</span>
    <span class="enscript-keyword">if</span> verbose_level &gt;= vDETAIL:
        <span class="enscript-keyword">for</span> pte_loop <span class="enscript-keyword">in</span> range(0, 512):
            paddr_tmp = paddr + (8 * pte_loop)
            out_string += <span class="enscript-string">&quot;{0: &lt;#020x}:\t {1: &lt;#020x}\n&quot;</span>.format(paddr_tmp, ReadPhysInt(paddr_tmp, 64, xnudefines.lcpu_self))
    paddr_mask = ~((0xfff&lt;&lt;52) | 0xfff)
    paddr_large_mask =  ~((0xfff&lt;&lt;52) | 0x1fffff)
    pt_valid = False
    pt_large = False
    pt_paddr = 0
    <span class="enscript-keyword">if</span> verbose_level &lt; vSCRIPT:
        <span class="enscript-keyword">if</span> entry &amp; 0x7 :
            pt_valid = True
            pt_large = False
            pt_paddr = entry &amp; paddr_mask
            <span class="enscript-keyword">if</span> entry &amp; (0x1 &lt;&lt;7):
                pt_large = True
                pt_paddr = entry &amp; paddr_large_mask
    <span class="enscript-keyword">else</span>:
        out_string+= <span class="enscript-string">&quot;{0: &lt;#020x}:\n\t{1:#020x}\n\t&quot;</span>.format(entry_addr, entry)
        <span class="enscript-keyword">if</span> entry &amp; 0x7:
            out_string += <span class="enscript-string">&quot;valid&quot;</span>
            pt_paddr = entry &amp; paddr_mask
            pt_valid = True
        <span class="enscript-keyword">else</span>:
            out_string += <span class="enscript-string">&quot;invalid&quot;</span>
            pt_paddr = 0
            pt_valid = False
            <span class="enscript-keyword">if</span> entry &amp; (0x1 &lt;&lt; 62):
                out_string += <span class="enscript-string">&quot; compressed&quot;</span>
            <span class="enscript-comment">#Stop decoding other bits
</span>            entry = 0
        <span class="enscript-keyword">if</span> entry &amp; 0x1:
            out_string += <span class="enscript-string">&quot; readable&quot;</span>
        <span class="enscript-keyword">else</span>:
            out_string += <span class="enscript-string">&quot; no read&quot;</span>
        <span class="enscript-keyword">if</span> entry &amp; (0x1 &lt;&lt; 1):
            out_string += <span class="enscript-string">&quot; writable&quot;</span>
        <span class="enscript-keyword">else</span>:
            out_string += <span class="enscript-string">&quot; no write&quot;</span>

        <span class="enscript-keyword">if</span> entry &amp; (0x1 &lt;&lt; 2):
            out_string += <span class="enscript-string">&quot; executable&quot;</span>
        <span class="enscript-keyword">else</span>:
            out_string += <span class="enscript-string">&quot; no exec&quot;</span>

        ctype = entry &amp; 0x38
        <span class="enscript-keyword">if</span> ctype == 0x30:
            out_string += <span class="enscript-string">&quot; cache-WB&quot;</span>
        <span class="enscript-keyword">elif</span> ctype == 0x28:
            out_string += <span class="enscript-string">&quot; cache-WP&quot;</span>
        <span class="enscript-keyword">elif</span> ctype == 0x20:
            out_string += <span class="enscript-string">&quot; cache-WT&quot;</span>
        <span class="enscript-keyword">elif</span> ctype == 0x8:
            out_string += <span class="enscript-string">&quot; cache-WC&quot;</span>
        <span class="enscript-keyword">else</span>:
            out_string += <span class="enscript-string">&quot; cache-NC&quot;</span>

        <span class="enscript-keyword">if</span> (entry &amp; 0x40) == 0x40:
            out_string += <span class="enscript-string">&quot; Ignore-PTA&quot;</span>

        <span class="enscript-keyword">if</span> (entry &amp; 0x100) == 0x100:
            out_string += <span class="enscript-string">&quot; accessed&quot;</span>

        <span class="enscript-keyword">if</span> (entry &amp; 0x200) == 0x200:
            out_string += <span class="enscript-string">&quot; dirty&quot;</span>

        <span class="enscript-keyword">if</span> entry &amp; (0x1 &lt;&lt; 7):
            out_string += <span class="enscript-string">&quot; large&quot;</span>
            pt_large = True
        <span class="enscript-keyword">else</span>:
            pt_large = False
    <span class="enscript-keyword">print</span> out_string
    <span class="enscript-keyword">return</span> (pt_paddr, pt_valid, pt_large)

<span class="enscript-keyword">def</span> <span class="enscript-function-name">_PmapL4Walk</span>(pmap_addr_val,vaddr, ept_pmap, verbose_level = vSCRIPT):
    <span class="enscript-string">&quot;&quot;&quot; Walk the l4 pmap entry.
        params: pmap_addr_val - core.value representing kernel data of type pmap_addr_t
        vaddr : int - virtual address to walk
    &quot;&quot;&quot;</span>
    is_cpu64_bit = int(kern.globals.cpu_64bit)
    pt_paddr = unsigned(pmap_addr_val)
    pt_valid = (unsigned(pmap_addr_val) != 0)
    pt_large = 0
    pframe_offset = 0
    <span class="enscript-keyword">if</span> pt_valid <span class="enscript-keyword">and</span> is_cpu64_bit:
        <span class="enscript-comment"># Lookup bits 47:39 of linear address in PML4T
</span>        pt_index = (vaddr &gt;&gt; 39) &amp; 0x1ff
        pframe_offset = vaddr &amp; 0x7fffffffff
        <span class="enscript-keyword">if</span> verbose_level &gt; vHUMAN :
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;pml4 (index {0:d}):&quot;</span>.format(pt_index)
        <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span>(ept_pmap):
            (pt_paddr, pt_valid, pt_large) = _PT_Step(pt_paddr, pt_index, verbose_level)
        <span class="enscript-keyword">else</span>:
            (pt_paddr, pt_valid, pt_large) = _PT_StepEPT(pt_paddr, pt_index, verbose_level)
    <span class="enscript-keyword">if</span> pt_valid:
        <span class="enscript-comment"># Lookup bits 38:30 of the linear address in PDPT
</span>        pt_index = (vaddr &gt;&gt; 30) &amp; 0x1ff
        pframe_offset = vaddr &amp; 0x3fffffff
        <span class="enscript-keyword">if</span> verbose_level &gt; vHUMAN:
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;pdpt (index {0:d}):&quot;</span>.format(pt_index)
        <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span>(ept_pmap):
            (pt_paddr, pt_valid, pt_large) = _PT_Step(pt_paddr, pt_index, verbose_level)
        <span class="enscript-keyword">else</span>:
            (pt_paddr, pt_valid, pt_large) = _PT_StepEPT(pt_paddr, pt_index, verbose_level)
    <span class="enscript-keyword">if</span> pt_valid <span class="enscript-keyword">and</span> <span class="enscript-keyword">not</span> pt_large:
        <span class="enscript-comment">#Lookup bits 29:21 of the linear address in PDPT
</span>        pt_index = (vaddr &gt;&gt; 21) &amp; 0x1ff
        pframe_offset = vaddr &amp; 0x1fffff
        <span class="enscript-keyword">if</span> verbose_level &gt; vHUMAN:
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;pdt (index {0:d}):&quot;</span>.format(pt_index)
        <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span>(ept_pmap):
            (pt_paddr, pt_valid, pt_large) = _PT_Step(pt_paddr, pt_index, verbose_level)
        <span class="enscript-keyword">else</span>:
            (pt_paddr, pt_valid, pt_large) = _PT_StepEPT(pt_paddr, pt_index, verbose_level)
    <span class="enscript-keyword">if</span> pt_valid <span class="enscript-keyword">and</span> <span class="enscript-keyword">not</span> pt_large:
        <span class="enscript-comment">#Lookup bits 20:21 of linear address in PT
</span>        pt_index = (vaddr &gt;&gt; 12) &amp; 0x1ff
        pframe_offset = vaddr &amp; 0xfff
        <span class="enscript-keyword">if</span> verbose_level &gt; vHUMAN:
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;pt (index {0:d}):&quot;</span>.format(pt_index)
        <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span>(ept_pmap):
            (pt_paddr, pt_valid, pt_large) = _PT_Step(pt_paddr, pt_index, verbose_level)
        <span class="enscript-keyword">else</span>:
            (pt_paddr, pt_valid, pt_large) = _PT_StepEPT(pt_paddr, pt_index, verbose_level)
    paddr = 0
    paddr_isvalid = False
    <span class="enscript-keyword">if</span> pt_valid:
        paddr = pt_paddr + pframe_offset
        paddr_isvalid = True

    <span class="enscript-keyword">if</span> verbose_level &gt; vHUMAN:
        <span class="enscript-keyword">if</span> paddr_isvalid:
            pvalue = ReadPhysInt(paddr, 32, xnudefines.lcpu_self)
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;phys {0: &lt;#020x}: {1: &lt;#020x}&quot;</span>.format(paddr, pvalue)
        <span class="enscript-keyword">else</span>:
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;no translation&quot;</span>

    <span class="enscript-keyword">return</span> paddr

<span class="enscript-keyword">def</span> <span class="enscript-function-name">_PmapWalkARMLevel1Section</span>(tte, vaddr, verbose_level = vSCRIPT):
    paddr = 0
    out_string = <span class="enscript-string">&quot;&quot;</span>
    <span class="enscript-comment">#Supersection or just section?
</span>    <span class="enscript-keyword">if</span> (tte &amp; 0x40000) == 0x40000:
        paddr = ( (tte &amp; 0xFF000000) | (vaddr &amp; 0x00FFFFFF) )
    <span class="enscript-keyword">else</span>:
        paddr = ( (tte &amp; 0xFFF00000) | (vaddr &amp; 0x000FFFFF) )

    <span class="enscript-keyword">if</span> verbose_level &gt;= vSCRIPT:
        out_string += <span class="enscript-string">&quot;{0: &lt;#020x}\n\t{1: &lt;#020x}\n\t&quot;</span>.format(addressof(tte), tte)
        <span class="enscript-comment">#bit [1:0] evaluated in PmapWalkARM
</span>        <span class="enscript-comment"># B bit 2
</span>        b_bit = (tte &amp; 0x4) &gt;&gt; 2
        <span class="enscript-comment"># C bit 3
</span>        c_bit = (tte &amp; 0x8) &gt;&gt; 3
        <span class="enscript-comment">#XN bit 4
</span>        <span class="enscript-keyword">if</span> (tte &amp; 0x10) :
            out_string += <span class="enscript-string">&quot;no-execute&quot;</span>
        <span class="enscript-keyword">else</span>:
            out_string += <span class="enscript-string">&quot;execute&quot;</span>
        <span class="enscript-comment">#Domain bit [8:5] if not supersection
</span>        <span class="enscript-keyword">if</span> (tte &amp; 0x40000) == 0x0:
            out_string += <span class="enscript-string">&quot; domain ({:d})&quot;</span>.format(((tte &amp; 0x1e0) &gt;&gt; 5) )
        <span class="enscript-comment">#IMP bit 9
</span>        out_string += <span class="enscript-string">&quot; imp({:d})&quot;</span>.format( ((tte &amp; 0x200) &gt;&gt; 9) )
        <span class="enscript-comment"># AP bit 15 and [11:10] merged to a single 3 bit value
</span>        access = ( (tte &amp; 0xc00) &gt;&gt; 10 ) | ((tte &amp; 0x8000) &gt;&gt; 13)
        out_string += xnudefines.arm_level2_access_strings[access]

        <span class="enscript-comment">#TEX bit [14:12]
</span>        tex_bits = ((tte &amp; 0x7000) &gt;&gt; 12)
        <span class="enscript-comment">#Print TEX, C , B all together
</span>        out_string += <span class="enscript-string">&quot; TEX:C:B({:d}{:d}{:d}:{:d}:{:d})&quot;</span>.format(
                                                                    1 <span class="enscript-keyword">if</span> (tex_bits &amp; 0x4) <span class="enscript-keyword">else</span> 0,
                                                                    1 <span class="enscript-keyword">if</span> (tex_bits &amp; 0x2) <span class="enscript-keyword">else</span> 0,
                                                                    1 <span class="enscript-keyword">if</span> (tex_bits &amp; 0x1) <span class="enscript-keyword">else</span> 0,
                                                                    c_bit,
                                                                    b_bit
                                                                    )
        <span class="enscript-comment"># S bit 16
</span>        <span class="enscript-keyword">if</span> tte &amp; 0x10000:
            out_string += <span class="enscript-string">&quot; shareable&quot;</span>
        <span class="enscript-keyword">else</span>:
            out_string += <span class="enscript-string">&quot; not-shareable&quot;</span>
        <span class="enscript-comment"># nG bit 17
</span>        <span class="enscript-keyword">if</span> tte &amp; 0x20000 :
            out_string += <span class="enscript-string">&quot; not-global&quot;</span>
        <span class="enscript-keyword">else</span>:
            out_string += <span class="enscript-string">&quot; global&quot;</span>
        <span class="enscript-comment"># Supersection bit 18
</span>        <span class="enscript-keyword">if</span> tte &amp; 0x40000:
            out_string += <span class="enscript-string">&quot; supersection&quot;</span>
        <span class="enscript-keyword">else</span>:
            out_string += <span class="enscript-string">&quot; section&quot;</span>
        <span class="enscript-comment">#NS bit 19
</span>        <span class="enscript-keyword">if</span> tte &amp; 0x80000 :
            out_string += <span class="enscript-string">&quot; no-secure&quot;</span>
        <span class="enscript-keyword">else</span>:
            out_string += <span class="enscript-string">&quot; secure&quot;</span>

    <span class="enscript-keyword">print</span> out_string
    <span class="enscript-keyword">return</span> paddr



<span class="enscript-keyword">def</span> <span class="enscript-function-name">_PmapWalkARMLevel2</span>(tte, vaddr, verbose_level = vSCRIPT):
    <span class="enscript-string">&quot;&quot;&quot; Pmap walk the level 2 tte.
        params:
          tte - value object
          vaddr - int
        returns: str - description of the tte + additional informaiton based on verbose_level
    &quot;&quot;&quot;</span>
    pte_base = kern.PhysToKernelVirt(tte &amp; 0xFFFFFC00)
    pte_index = (vaddr &gt;&gt; 12) &amp; 0xFF
    pte_base_val = kern.GetValueFromAddress(pte_base, <span class="enscript-string">'pt_entry_t *'</span>)
    pte = pte_base_val[pte_index]
    out_string = <span class="enscript-string">''</span>
    <span class="enscript-keyword">if</span> verbose_level &gt;= vSCRIPT:
        out_string += <span class="enscript-string">&quot;{0: &lt;#020x}\n\t{1: &lt;#020x}\n\t&quot;</span>.format(addressof(tte), tte)
        <span class="enscript-comment"># bit [1:0] evaluated in PmapWalkARM
</span>        <span class="enscript-comment"># NS bit 3
</span>        <span class="enscript-keyword">if</span> tte &amp; 0x8:
            out_string += <span class="enscript-string">' no-secure'</span>
        <span class="enscript-keyword">else</span>:
            out_string += <span class="enscript-string">' secure'</span>
        <span class="enscript-comment">#Domain bit [8:5]
</span>        out_string += <span class="enscript-string">&quot; domain({:d})&quot;</span>.format(((tte &amp; 0x1e0) &gt;&gt; 5))
        <span class="enscript-comment"># IMP bit 9
</span>        out_string += <span class="enscript-string">&quot; imp({:d})&quot;</span>.format( ((tte &amp; 0x200) &gt;&gt; 9))
        out_string += <span class="enscript-string">&quot;\n&quot;</span>
    <span class="enscript-keyword">if</span> verbose_level &gt;= vSCRIPT:
        out_string += <span class="enscript-string">&quot;second-level table (index {:d}):\n&quot;</span>.format(pte_index)
    <span class="enscript-keyword">if</span> verbose_level &gt;= vDETAIL:
        <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> range(256):
            tmp = pte_base_val[i]
            out_string += <span class="enscript-string">&quot;{0: &lt;#020x}:\t{1: &lt;#020x}\n&quot;</span>.format(addressof(tmp), unsigned(tmp))

    paddr = 0
    <span class="enscript-keyword">if</span> pte &amp; 0x2:
        paddr = (unsigned(pte) &amp; 0xFFFFF000) | (vaddr &amp; 0xFFF)

    <span class="enscript-keyword">if</span> verbose_level &gt;= vSCRIPT:
        out_string += <span class="enscript-string">&quot; {0: &lt;#020x}\n\t{1: &lt;#020x}\n\t&quot;</span>.format(addressof(pte), unsigned(pte))
        <span class="enscript-keyword">if</span> (pte &amp; 0x3) == 0x0:
            out_string += <span class="enscript-string">&quot; invalid&quot;</span>
        <span class="enscript-keyword">else</span>:
            <span class="enscript-keyword">if</span> (pte &amp; 0x3) == 0x1:
                out_string += <span class="enscript-string">&quot; large&quot;</span>
                <span class="enscript-comment"># XN bit 15
</span>                <span class="enscript-keyword">if</span> pte &amp; 0x8000 == 0x8000:
                    out_string+= <span class="enscript-string">&quot; no-execute&quot;</span>
                <span class="enscript-keyword">else</span>:
                    out_string += <span class="enscript-string">&quot; execute&quot;</span>
            <span class="enscript-keyword">else</span>:
                out_string += <span class="enscript-string">&quot; small&quot;</span>
                <span class="enscript-comment"># XN bit 0
</span>                <span class="enscript-keyword">if</span> (pte &amp; 0x1) == 0x01:
                    out_string += <span class="enscript-string">&quot; no-execute&quot;</span>
                <span class="enscript-keyword">else</span>:
                    out_string += <span class="enscript-string">&quot; execute&quot;</span>
            <span class="enscript-comment"># B bit 2
</span>            b_bit = (pte &amp; 0x4) &gt;&gt; 2
            c_bit = (pte &amp; 0x8) &gt;&gt; 3
            <span class="enscript-comment"># AP bit 9 and [5:4], merged to a single 3-bit value
</span>            access = (pte &amp; 0x30) &gt;&gt; 4 | (pte &amp; 0x200) &gt;&gt; 7
            out_string += xnudefines.arm_level2_access_strings[access]

            <span class="enscript-comment">#TEX bit [14:12] for large, [8:6] for small
</span>            tex_bits = ((pte &amp; 0x1c0) &gt;&gt; 6)
            <span class="enscript-keyword">if</span> (pte &amp; 0x3) == 0x1:
                tex_bits = ((pte &amp; 0x7000) &gt;&gt; 12)

            <span class="enscript-comment"># Print TEX, C , B alltogether
</span>            out_string += <span class="enscript-string">&quot; TEX:C:B({:d}{:d}{:d}:{:d}:{:d})&quot;</span>.format(
                                                                    1 <span class="enscript-keyword">if</span> (tex_bits &amp; 0x4) <span class="enscript-keyword">else</span> 0,
                                                                    1 <span class="enscript-keyword">if</span> (tex_bits &amp; 0x2) <span class="enscript-keyword">else</span> 0,
                                                                    1 <span class="enscript-keyword">if</span> (tex_bits &amp; 0x1) <span class="enscript-keyword">else</span> 0,
                                                                    c_bit,
                                                                    b_bit
                                                                    )
            <span class="enscript-comment"># S bit 10
</span>            <span class="enscript-keyword">if</span> pte &amp; 0x400 :
                out_string += <span class="enscript-string">&quot; shareable&quot;</span>
            <span class="enscript-keyword">else</span>:
                out_string += <span class="enscript-string">&quot; not-shareable&quot;</span>

            <span class="enscript-comment"># nG bit 11
</span>            <span class="enscript-keyword">if</span> pte &amp; 0x800:
                out_string += <span class="enscript-string">&quot; not-global&quot;</span>
            <span class="enscript-keyword">else</span>:
                out_string += <span class="enscript-string">&quot; global&quot;</span>
    <span class="enscript-keyword">print</span> out_string
    <span class="enscript-keyword">return</span> paddr
    <span class="enscript-comment">#end of level 2 walking of arm
</span>

<span class="enscript-keyword">def</span> <span class="enscript-function-name">PmapWalkARM</span>(pmap, vaddr, verbose_level = vHUMAN):
    <span class="enscript-string">&quot;&quot;&quot; Pmap walking for ARM kernel.
        params:
          pmapval: core.value - representing pmap_t in kernel
          vaddr:  int     - integer representing virtual address to walk
    &quot;&quot;&quot;</span>
    paddr = 0
    <span class="enscript-comment"># shift by TTESHIFT (20) to get tte index
</span>    tte_index = ((vaddr - unsigned(pmap.min)) &gt;&gt; 20 )
    tte = pmap.tte[tte_index]
    <span class="enscript-keyword">if</span> verbose_level &gt;= vSCRIPT:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;First-level table (index {:d}):&quot;</span>.format(tte_index)
    <span class="enscript-keyword">if</span> verbose_level &gt;= vDETAIL:
        <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> range(0, 4096):
            ptr = unsigned(addressof(pmap.tte[i]))
            val = unsigned(pmap.tte[i])
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;{0: &lt;#020x}:\t {1: &lt;#020x}&quot;</span>.format(ptr, val)
    <span class="enscript-keyword">if</span> (tte &amp; 0x3) == 0x1:
        paddr = _PmapWalkARMLevel2(tte, vaddr, verbose_level)
    <span class="enscript-keyword">elif</span> (tte &amp; 0x3) == 0x2 :
        paddr = _PmapWalkARMLevel1Section(tte, vaddr, verbose_level)
    <span class="enscript-keyword">else</span>:
        paddr = 0
        <span class="enscript-keyword">if</span> verbose_level &gt;= vSCRIPT:
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Invalid First-Level Translation Table Entry: {0: #020x}&quot;</span>.format(tte)

    <span class="enscript-keyword">if</span> verbose_level &gt;= vHUMAN:
        <span class="enscript-keyword">if</span> paddr:
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Translation of {:#x} is {:#x}.&quot;</span>.format(vaddr, paddr)
        <span class="enscript-keyword">else</span>:
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;(no translation)&quot;</span>

    <span class="enscript-keyword">return</span> paddr

<span class="enscript-keyword">def</span> <span class="enscript-function-name">PmapWalkX86_64</span>(pmapval, vaddr, verbose_level = vSCRIPT):
    <span class="enscript-string">&quot;&quot;&quot;
        params: pmapval - core.value representing pmap_t in kernel
        vaddr:  int     - int representing virtual address to walk
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> pmapval.pm_cr3 != 0:
        <span class="enscript-keyword">if</span> verbose_level &gt; vHUMAN:
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Using normal Intel PMAP from pm_cr3\n&quot;</span>
        <span class="enscript-keyword">return</span> _PmapL4Walk(pmapval.pm_cr3, vaddr, 0, config[<span class="enscript-string">'verbosity'</span>])
    <span class="enscript-keyword">else</span>:
        <span class="enscript-keyword">if</span> verbose_level &gt; vHUMAN:
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Using EPT pmap from pm_eptp\n&quot;</span>
        <span class="enscript-keyword">return</span> _PmapL4Walk(pmapval.pm_eptp, vaddr, 1, config[<span class="enscript-string">'verbosity'</span>])

<span class="enscript-keyword">def</span> <span class="enscript-function-name">assert_64bit</span>(val):
    <span class="enscript-keyword">assert</span>(val &lt; 2**64)

ARM64_TTE_SIZE = 8
ARM64_VMADDR_BITS = 48

<span class="enscript-keyword">def</span> <span class="enscript-function-name">PmapBlockOffsetMaskARM64</span>(level):
    <span class="enscript-keyword">assert</span> level &gt;= 1 <span class="enscript-keyword">and</span> level &lt;= 3
    page_size = kern.globals.arm_hardware_page_size
    ttentries = (page_size / ARM64_TTE_SIZE)
    <span class="enscript-keyword">return</span> page_size * (ttentries ** (3 - level)) - 1

<span class="enscript-keyword">def</span> <span class="enscript-function-name">PmapBlockBaseMaskARM64</span>(level):
    <span class="enscript-keyword">assert</span> level &gt;= 1 <span class="enscript-keyword">and</span> level &lt;= 3
    page_size = kern.globals.arm_hardware_page_size
    <span class="enscript-keyword">return</span> ((1 &lt;&lt; ARM64_VMADDR_BITS) - 1) &amp; ~PmapBlockOffsetMaskARM64(level)

<span class="enscript-keyword">def</span> <span class="enscript-function-name">PmapIndexMaskARM64</span>(level):
    <span class="enscript-keyword">assert</span> level &gt;= 1 <span class="enscript-keyword">and</span> level &lt;= 3
    page_size = kern.globals.arm_hardware_page_size
    ttentries = (page_size / ARM64_TTE_SIZE)
    <span class="enscript-keyword">return</span> page_size * (ttentries ** (3 - level) * (ttentries - 1))

<span class="enscript-keyword">def</span> <span class="enscript-function-name">PmapIndexDivideARM64</span>(level):
    <span class="enscript-keyword">assert</span> level &gt;= 1 <span class="enscript-keyword">and</span> level &lt;= 3
    page_size = kern.globals.arm_hardware_page_size
    ttentries = (page_size / ARM64_TTE_SIZE)
    <span class="enscript-keyword">return</span> page_size * (ttentries ** (3 - level))

<span class="enscript-keyword">def</span> <span class="enscript-function-name">PmapTTnIndexARM64</span>(vaddr, level):
    <span class="enscript-keyword">assert</span>(type(vaddr) <span class="enscript-keyword">in</span> (long, int))
    assert_64bit(vaddr)

    <span class="enscript-keyword">return</span> (vaddr &amp; PmapIndexMaskARM64(level)) // PmapIndexDivideARM64(level)

<span class="enscript-keyword">def</span> <span class="enscript-function-name">PmapDecodeTTEARM64</span>(tte, level):
    <span class="enscript-keyword">assert</span>(type(tte) == long)
    <span class="enscript-keyword">assert</span>(type(level) == int)
    assert_64bit(tte)

    <span class="enscript-keyword">if</span> tte &amp; 0x1 == 0x1:
        <span class="enscript-keyword">if</span> (tte &amp; 0x2 == 0x2) <span class="enscript-keyword">and</span> (level != 0x3):
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Type       = Table pointer.&quot;</span>
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Table addr = {:#x}.&quot;</span>.format(tte &amp; 0xfffffffff000)
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;PXN        = {:#x}.&quot;</span>.format((tte &gt;&gt; 59) &amp; 0x1)
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;XN         = {:#x}.&quot;</span>.format((tte &gt;&gt; 60) &amp; 0x1)
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;AP         = {:#x}.&quot;</span>.format((tte &gt;&gt; 61) &amp; 0x3)
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;NS         = {:#x}&quot;</span>.format(tte &gt;&gt; 63)
        <span class="enscript-keyword">else</span>:
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Type       = Block.&quot;</span>
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;AttrIdx    = {:#x}.&quot;</span>.format((tte &gt;&gt; 2) &amp; 0x7)
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;NS         = {:#x}.&quot;</span>.format((tte &gt;&gt; 5) &amp; 0x1)
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;AP         = {:#x}.&quot;</span>.format((tte &gt;&gt; 6) &amp; 0x3)
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;SH         = {:#x}.&quot;</span>.format((tte &gt;&gt; 8) &amp; 0x3)
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;AF         = {:#x}.&quot;</span>.format((tte &gt;&gt; 10) &amp; 0x1)
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;nG         = {:#x}.&quot;</span>.format((tte &gt;&gt; 11) &amp; 0x1)
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;HINT       = {:#x}.&quot;</span>.format((tte &gt;&gt; 52) &amp; 0x1)
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;PXN        = {:#x}.&quot;</span>.format((tte &gt;&gt; 53) &amp; 0x1)
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;XN         = {:#x}.&quot;</span>.format((tte &gt;&gt; 54) &amp; 0x1)
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;SW Use     = {:#x}.&quot;</span>.format((tte &gt;&gt; 55) &amp; 0xf)
    <span class="enscript-keyword">else</span>:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Invalid.&quot;</span>

    <span class="enscript-keyword">return</span>

<span class="enscript-keyword">def</span> <span class="enscript-function-name">PmapWalkARM64</span>(pmap, vaddr, verbose_level = vHUMAN):
    <span class="enscript-keyword">assert</span>(type(pmap) == core.cvalue.value)
    <span class="enscript-keyword">assert</span>(type(vaddr) <span class="enscript-keyword">in</span> (long, int))
    page_size = kern.globals.arm_hardware_page_size
    page_offset_mask = (page_size - 1)
    page_base_mask = ((1 &lt;&lt; ARM64_VMADDR_BITS) - 1) &amp; (~page_offset_mask)

    assert_64bit(vaddr)
    paddr = -1

    tt1_index = PmapTTnIndexARM64(vaddr, 1)
    tt2_index = PmapTTnIndexARM64(vaddr, 2)
    tt3_index = PmapTTnIndexARM64(vaddr, 3)

    <span class="enscript-comment"># L1
</span>    tte = long(unsigned(pmap.tte[tt1_index]))
    <span class="enscript-keyword">assert</span>(type(tte) == long)
    assert_64bit(tte)

    <span class="enscript-keyword">if</span> verbose_level &gt;= vSCRIPT:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;L1 entry: {:#x}&quot;</span>.format(tte)
    <span class="enscript-keyword">if</span> verbose_level &gt;= vDETAIL:
        PmapDecodeTTEARM64(tte, 1)

    <span class="enscript-keyword">if</span> tte &amp; 0x1 == 0x1:
        <span class="enscript-comment"># Check for L1 block entry
</span>        <span class="enscript-keyword">if</span> tte &amp; 0x2 == 0x0:
            <span class="enscript-comment"># Handle L1 block entry
</span>            paddr = tte &amp; PmapBlockBaseMaskARM64(1)
            paddr = paddr | (vaddr &amp; PmapBlockOffsetMaskARM64(1))
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;phys: {:#x}&quot;</span>.format(paddr)
        <span class="enscript-keyword">else</span>:
            <span class="enscript-comment"># Handle L1 table entry
</span>            l2_phys = (tte &amp; page_base_mask) + (ARM64_TTE_SIZE * tt2_index)
            <span class="enscript-keyword">assert</span>(type(l2_phys) == long)

            l2_virt = kern.PhysToKernelVirt(l2_phys)
            <span class="enscript-keyword">assert</span>(type(l2_virt) == long)

            <span class="enscript-keyword">if</span> verbose_level &gt;= vDETAIL:
                <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;L2 physical address: {:#x}. L2 virtual address: {:#x}&quot;</span>.format(l2_phys, l2_virt)

            <span class="enscript-comment"># L2
</span>            ttep = kern.GetValueFromAddress(l2_virt, <span class="enscript-string">&quot;tt_entry_t*&quot;</span>)
            tte = long(unsigned(dereference(ttep)))
            <span class="enscript-keyword">assert</span>(type(tte) == long)

            <span class="enscript-keyword">if</span> verbose_level &gt;= vSCRIPT:
                <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;L2 entry: {:#0x}&quot;</span>.format(tte)
            <span class="enscript-keyword">if</span> verbose_level &gt;= vDETAIL:
                PmapDecodeTTEARM64(tte, 2)

            <span class="enscript-keyword">if</span> tte &amp; 0x1 == 0x1:
                <span class="enscript-comment"># Check for L2 block entry
</span>                <span class="enscript-keyword">if</span> tte &amp; 0x2 == 0x0:
                    <span class="enscript-comment"># Handle L2 block entry
</span>                    paddr = tte &amp; PmapBlockBaseMaskARM64(2)
                    paddr = paddr | (vaddr &amp; PmapBlockOffsetMaskARM64(2))
                <span class="enscript-keyword">else</span>:
                    <span class="enscript-comment"># Handle L2 table entry
</span>                    l3_phys = (tte &amp; page_base_mask) + (ARM64_TTE_SIZE * tt3_index)
                    <span class="enscript-keyword">assert</span>(type(l3_phys) == long)

                    l3_virt = kern.PhysToKernelVirt(l3_phys)
                    <span class="enscript-keyword">assert</span>(type(l3_virt) == long)

                    <span class="enscript-keyword">if</span> verbose_level &gt;= vDETAIL:
                        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;L3 physical address: {:#x}. L3 virtual address: {:#x}&quot;</span>.format(l3_phys, l3_virt)

                    <span class="enscript-comment"># L3
</span>                    ttep = kern.GetValueFromAddress(l3_virt, <span class="enscript-string">&quot;tt_entry_t*&quot;</span>)
                    tte = long(unsigned(dereference(ttep)))
                    <span class="enscript-keyword">assert</span>(type(tte) == long)

                    <span class="enscript-keyword">if</span> verbose_level &gt;= vSCRIPT:
                        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;L3 entry: {:#0x}&quot;</span>.format(tte)
                    <span class="enscript-keyword">if</span> verbose_level &gt;= vDETAIL:
                        PmapDecodeTTEARM64(tte, 3)

                    <span class="enscript-keyword">if</span> tte &amp; 0x3 == 0x3:
                        paddr = tte &amp; page_base_mask
                        paddr = paddr | (vaddr &amp; page_offset_mask)
                    <span class="enscript-keyword">elif</span> verbose_level &gt;= vHUMAN:
                        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;L3 entry invalid: {:#x}\n&quot;</span>.format(tte)
            <span class="enscript-keyword">elif</span> verbose_level &gt;= vHUMAN: <span class="enscript-comment"># tte &amp; 0x1 == 0x1
</span>                <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;L2 entry invalid: {:#x}\n&quot;</span>.format(tte)
    <span class="enscript-keyword">elif</span> verbose_level &gt;= vHUMAN:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;L1 entry invalid: {:#x}\n&quot;</span>.format(tte)

    <span class="enscript-keyword">if</span> verbose_level &gt;= vHUMAN:
        <span class="enscript-keyword">if</span> paddr:
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Translation of {:#x} is {:#x}.&quot;</span>.format(vaddr, paddr)
        <span class="enscript-keyword">else</span>:
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;(no translation)&quot;</span>

    <span class="enscript-keyword">return</span> paddr

<span class="enscript-keyword">def</span> <span class="enscript-function-name">PmapWalk</span>(pmap, vaddr, verbose_level = vHUMAN):
    <span class="enscript-keyword">if</span> kern.arch == <span class="enscript-string">'x86_64'</span>:
        <span class="enscript-keyword">return</span> PmapWalkX86_64(pmap, vaddr, verbose_level)
    <span class="enscript-keyword">elif</span> kern.arch == <span class="enscript-string">'arm'</span>:
        <span class="enscript-keyword">return</span> PmapWalkARM(pmap, vaddr, verbose_level)
    <span class="enscript-keyword">elif</span> kern.arch == <span class="enscript-string">'arm64'</span>:
        <span class="enscript-keyword">return</span> PmapWalkARM64(pmap, vaddr, verbose_level)
    <span class="enscript-keyword">else</span>:
        <span class="enscript-keyword">raise</span> NotImplementedError(<span class="enscript-string">&quot;PmapWalk does not support {0}&quot;</span>.format(kern.arch))

@lldb_command(<span class="enscript-string">'pmap_walk'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">PmapWalkHelper</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Perform a page-table walk in &lt;pmap&gt; for &lt;virtual_address&gt;.
        Syntax: (lldb) pmap_walk &lt;pmap&gt; &lt;virtual_address&gt; [-v] [-e]
            Multiple -v's can be specified for increased verbosity
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> cmd_args == None <span class="enscript-keyword">or</span> len(cmd_args) &lt; 2:
        <span class="enscript-keyword">raise</span> ArgumentError(<span class="enscript-string">&quot;Too few arguments to pmap_walk.&quot;</span>)

    pmap = kern.GetValueAsType(cmd_args[0], <span class="enscript-string">'pmap_t'</span>)
    addr = unsigned(kern.GetValueFromAddress(cmd_args[1], <span class="enscript-string">'void *'</span>))
    PmapWalk(pmap, addr, config[<span class="enscript-string">'verbosity'</span>])
    <span class="enscript-keyword">return</span>
</pre>
<hr />
</body></html>