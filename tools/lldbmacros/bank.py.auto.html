<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>bank.py</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">bank.py&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-keyword">from</span> xnu <span class="enscript-keyword">import</span> *
<span class="enscript-keyword">from</span> utils <span class="enscript-keyword">import</span> *


@lldb_type_summary([<span class="enscript-string">'bank_element'</span>, <span class="enscript-string">'bank_element_t'</span>])
@header(<span class="enscript-string">&quot;{0: &lt;20s} {1: &lt;16s} {2: &lt;16s} {3: &lt;16s} {4: &lt;16s} {5: &lt;20s} {6: &lt;20s}&quot;</span>.format(<span class="enscript-string">&quot;bank_element&quot;</span>, <span class="enscript-string">&quot;type&quot;</span>, <span class="enscript-string">&quot;ref_count&quot;</span>, <span class="enscript-string">&quot;sync&quot;</span>, <span class="enscript-string">&quot;pid&quot;</span>, <span class="enscript-string">&quot;task&quot;</span>, <span class="enscript-string">&quot;process_name&quot;</span>))
<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetBankElementSummary</span>(bank_element):
    <span class="enscript-string">&quot;&quot;&quot; Summarizes the bank element
        params: bank_element = value of the object of type bank_element_t
        returns: String with summary of the type.
    &quot;&quot;&quot;</span>
    format_str = <span class="enscript-string">&quot;{0: &lt;#020x} {1: &lt;16s} {2: &lt;16d} {3: &lt;16d} {4: &lt;16d}&quot;</span>

    <span class="enscript-keyword">if</span> bank_element.be_type == 0:
      out_string = format_str.format(bank_element, <span class="enscript-string">&quot;BANK_TASK&quot;</span>, unsigned(bank_element.be_refs), unsigned(bank_element.be_made), bank_element.be_pid)
    <span class="enscript-keyword">else</span>:
      out_string = format_str.format(bank_element, <span class="enscript-string">&quot;BANK_ACCOUNT&quot;</span>, unsigned(bank_element.be_refs), unsigned(bank_element.be_made), bank_element.be_pid)

    <span class="enscript-comment">#if DEVELOPMENT
</span>    format_str = <span class="enscript-string">&quot;{0: &lt;#020x} {1: &lt;20s}&quot;</span>
    <span class="enscript-keyword">if</span> hasattr(bank_element, <span class="enscript-string">'be_task'</span>):
      out_string += <span class="enscript-string">&quot; &quot;</span> + format_str.format(bank_element.be_task, GetProcNameForTask(bank_element.be_task))
    <span class="enscript-comment">#endif
</span>
    <span class="enscript-keyword">return</span> out_string


@lldb_type_summary([<span class="enscript-string">'bank_task'</span>, <span class="enscript-string">'bank_task_t'</span>])
@header(<span class="enscript-string">&quot;{0: &lt;20s} {1: &lt;16s} {2: &lt;20s} {3: &lt;16s} {4: &lt;16s} {5: &lt;20s} {6: &lt;20s}&quot;</span>.format(<span class="enscript-string">&quot;bank_task&quot;</span>, <span class="enscript-string">&quot;pid&quot;</span>, <span class="enscript-string">&quot;ledger&quot;</span>, <span class="enscript-string">&quot;ref_count&quot;</span>, <span class="enscript-string">&quot;sync&quot;</span>, <span class="enscript-string">&quot;task&quot;</span>, <span class="enscript-string">&quot;process_name&quot;</span>))
<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetBankTaskSummary</span>(bank_task):
    <span class="enscript-string">&quot;&quot;&quot; Summarizes the bank task
        params: bank_task = value of the object of type bank_task_t
        returns: String with summary of the type.
    &quot;&quot;&quot;</span>

    format_str = <span class="enscript-string">&quot;{0: &lt;#020x} {1: &lt;16d} {2: &lt;#020x} {3: &lt;16d} {4: &lt;16d}&quot;</span>
    out_string = format_str.format(bank_task, bank_task.bt_elem.be_pid, bank_task.bt_creditcard, unsigned(bank_task.bt_elem.be_refs), unsigned(bank_task.bt_elem.be_made))

    <span class="enscript-comment">#if DEVELOPMENT
</span>    format_str = <span class="enscript-string">&quot;{0: &lt;#020x} {1: &lt;20s}&quot;</span>
    <span class="enscript-keyword">if</span> hasattr(bank_task.bt_elem, <span class="enscript-string">'be_task'</span>):
      out_string += <span class="enscript-string">&quot; &quot;</span> + format_str.format(bank_task.bt_elem.be_task, GetProcNameForTask(bank_task.bt_elem.be_task))
    <span class="enscript-comment">#endif
</span>    <span class="enscript-keyword">return</span> out_string


@lldb_type_summary([<span class="enscript-string">'bank_account'</span>, <span class="enscript-string">'bank_account_t'</span>])
@header(<span class="enscript-string">&quot;{0: &lt;20s} {1: &lt;16s} {2: &lt;16s} {3: &lt;20s} {4: &lt;16s} {5: &lt;16s} {6: &lt;20s} {7: &lt;20s} {8: &lt;20s} {9: &lt;20s}&quot;</span>.format(<span class="enscript-string">&quot;bank_account&quot;</span>, <span class="enscript-string">&quot;holder_pid&quot;</span>, <span class="enscript-string">&quot;merchant_pid&quot;</span>, <span class="enscript-string">&quot;chit_ledger&quot;</span>, <span class="enscript-string">&quot;ref_count&quot;</span>, <span class="enscript-string">&quot;sync&quot;</span>, <span class="enscript-string">&quot;holder_task&quot;</span>, <span class="enscript-string">&quot;holder_process&quot;</span>, <span class="enscript-string">&quot;merchant_task&quot;</span>, <span class="enscript-string">&quot;merchant_process&quot;</span>))
<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetBankAccountSummary</span>(bank_account):
    <span class="enscript-string">&quot;&quot;&quot; Summarizes the bank account
        params: bank_task = value of the object of type bank_account_t
        returns: String with summary of the type.
    &quot;&quot;&quot;</span>

    format_str = <span class="enscript-string">&quot;{0: &lt;#020x} {1: &lt;16d} {2: &lt;16d} {3: &lt;#020x} {4: &lt;16d} {5: &lt;16d}&quot;</span>
    out_string = format_str.format(bank_account, bank_account.ba_holder.bt_elem.be_pid, bank_account.ba_merchant.bt_elem.be_pid, bank_account.ba_bill, unsigned(bank_account.ba_elem.be_refs), unsigned(bank_account.ba_elem.be_made))

    <span class="enscript-comment">#if DEVELOPMENT
</span>    format_str = <span class="enscript-string">&quot;{0: &lt;#020x} {1: &lt;20s}&quot;</span>
    <span class="enscript-keyword">if</span> hasattr(bank_account.ba_holder.bt_elem, <span class="enscript-string">'be_task'</span>):
      out_string += <span class="enscript-string">&quot; &quot;</span> + format_str.format(bank_account.ba_holder.bt_elem.be_task, GetProcNameForTask(bank_account.ba_holder.bt_elem.be_task))
    <span class="enscript-keyword">if</span> hasattr(bank_account.ba_merchant.bt_elem, <span class="enscript-string">'be_task'</span>):
      out_string += <span class="enscript-string">&quot; &quot;</span> + format_str.format(bank_account.ba_merchant.bt_elem.be_task, GetProcNameForTask(bank_account.ba_merchant.bt_elem.be_task))
    <span class="enscript-comment">#endif
</span>    <span class="enscript-keyword">return</span> out_string


<span class="enscript-comment"># Macro: showbankaccountstopay
</span>@lldb_command(<span class="enscript-string">'showbankaccountstopay'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">ShowBankAccountsToPay</span>(cmd_args=None, cmd_options={}):
    <span class="enscript-string">&quot;&quot;&quot; show a list of merchant bank tasks for a bank_task object.
        Usage: (lldb)showbankaccountstopay &lt;bank_task_t&gt;
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> cmd_args:
      <span class="enscript-keyword">raise</span> ArgumentError(<span class="enscript-string">&quot;Please provide arguments&quot;</span>)

    bank_task = kern.GetValueFromAddress(cmd_args[0], <span class="enscript-string">'bank_task_t'</span>)
    <span class="enscript-keyword">print</span> GetBankTaskSummary.header
    <span class="enscript-keyword">print</span> GetBankTaskSummary(bank_task)
    <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;List of Accounts to Pay.&quot;</span>
    header_str = GetBankAccountSummary.header
    <span class="enscript-keyword">print</span> header_str

    <span class="enscript-keyword">for</span> bank_account <span class="enscript-keyword">in</span> IterateQueue(bank_task.bt_accounts_to_pay, <span class="enscript-string">'bank_account_t'</span>, <span class="enscript-string">'ba_next_acc_to_pay'</span>):
      <span class="enscript-keyword">print</span> GetBankAccountSummary(bank_account)
    <span class="enscript-keyword">return</span>
<span class="enscript-comment"># EndMacro: showbankaccountstopay
</span>

<span class="enscript-comment"># Macro: showbankaccountstocharge
</span>@lldb_command(<span class="enscript-string">'showbankaccountstocharge'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">ShowBankAccountsToCharge</span>(cmd_args=None, cmd_options={}):
    <span class="enscript-string">&quot;&quot;&quot; show a list of holder bank tasks for a bank_task object.
        Usage: (lldb)showbankaccountstocharge &lt;bank_task_t&gt;
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> cmd_args:
      <span class="enscript-keyword">raise</span> ArgumentError(<span class="enscript-string">&quot;Please provide arguments&quot;</span>)

    bank_task = kern.GetValueFromAddress(cmd_args[0], <span class="enscript-string">'bank_task_t'</span>)
    <span class="enscript-keyword">print</span> GetBankTaskSummary.header
    <span class="enscript-keyword">print</span> GetBankTaskSummary(bank_task)
    <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;List of Accounts to Charge.&quot;</span>
    header_str = GetBankAccountSummary.header
    <span class="enscript-keyword">print</span> header_str

    <span class="enscript-keyword">for</span> bank_account <span class="enscript-keyword">in</span> IterateQueue(bank_task.bt_accounts_to_charge, <span class="enscript-string">'bank_account_t'</span>, <span class="enscript-string">'ba_next_acc_to_charge'</span>):
      <span class="enscript-keyword">print</span> GetBankAccountSummary(bank_account)
    <span class="enscript-keyword">return</span>
<span class="enscript-comment"># EndMacro: showbankaccountstocharge
</span>

<span class="enscript-comment">#if DEVELOPMENT
</span>
<span class="enscript-comment"># Macro: showallbanktasklist
</span>@lldb_command(<span class="enscript-string">'showallbanktasklist'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">ShowAllBankTaskList</span>(cmd_args=None, cmd_options={}):
    <span class="enscript-string">&quot;&quot;&quot; A DEVELOPMENT macro that walks the list of all allocated bank_task objects
        and prints them.
        usage: (lldb) showallbanktasklist
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> hasattr(kern.globals, <span class="enscript-string">'bank_tasks_list'</span>):
      <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;It seems you are running a build of kernel that does not have the list of all bank_tasks_list.&quot;</span>
      <span class="enscript-keyword">return</span> False
    <span class="enscript-keyword">print</span> GetBankTaskSummary.header
    <span class="enscript-keyword">for</span> bank_task <span class="enscript-keyword">in</span> IterateQueue(kern.globals.bank_tasks_list, <span class="enscript-string">'bank_task_t'</span>, <span class="enscript-string">'bt_global_elt'</span>):
      <span class="enscript-keyword">print</span> GetBankTaskSummary(bank_task)
    <span class="enscript-keyword">return</span> True
<span class="enscript-comment"># EndMacro showallbanktasklist
</span>

<span class="enscript-comment"># Macro: showallbankaccountlist
</span>@lldb_command(<span class="enscript-string">'showallbankaccountlist'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">ShowAllBankAccountList</span>(cmd_args=None, cmd_options={}):
    <span class="enscript-string">&quot;&quot;&quot; A DEVELOPMENT macro that walks the list of all allocated bank_account objects
        and prints them.
        usage: (lldb) showallbankaccountlist
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> hasattr(kern.globals, <span class="enscript-string">'bank_accounts_list'</span>):
      <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;It seems you are running a build of kernel that does not have the list of all bank_accounts_list.&quot;</span>
      <span class="enscript-keyword">return</span> False
    <span class="enscript-keyword">print</span> GetBankAccountSummary.header
    <span class="enscript-keyword">for</span> bank_account <span class="enscript-keyword">in</span> IterateQueue(kern.globals.bank_accounts_list, <span class="enscript-string">'bank_account_t'</span>, <span class="enscript-string">'ba_global_elt'</span>):
      <span class="enscript-keyword">print</span> GetBankAccountSummary(bank_account)
    <span class="enscript-keyword">return</span> True
<span class="enscript-comment"># EndMacro showallbankaccountlist
</span><span class="enscript-comment">#endif
</span></pre>
<hr />
</body></html>