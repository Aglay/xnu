<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>cvalue.py</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">cvalue.py&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-string">&quot;&quot;&quot;
Defines a class value which encapsulates the basic lldb Scripting Bridge APIs. This provides an easy
wrapper to extract information from C based constructs. 
 |------- core.value------------|
 | |--lldb Scripting Bridge--|  |
 | |    |--lldb core--|      |  |   
 | |-------------------------|  |
 |------------------------------|
Use the member function GetSBValue() to access the base Scripting Bridge value.
&quot;&quot;&quot;</span>
<span class="enscript-keyword">import</span> lldb
<span class="enscript-keyword">import</span> re
<span class="enscript-keyword">from</span> lazytarget <span class="enscript-keyword">import</span> *

_cstring_rex = re.compile(<span class="enscript-string">&quot;((?:\s*|const\s+)\s*char(?:\s+\*|\s+[A-Za-z_0-9]*\s*\[|)\s*)&quot;</span>,re.MULTILINE|re.DOTALL)

<span class="enscript-keyword">class</span> value(object):
    <span class="enscript-string">'''A class designed to wrap lldb.SBValue() objects so the resulting object
    can be used as a variable would be in code. So if you have a Point structure
    variable in your code in the current frame named &quot;pt&quot;, you can initialize an instance
    of this class with it:
    
    pt = lldb.value(lldb.frame.FindVariable(&quot;pt&quot;))
    print pt
    print pt.x
    print pt.y

    pt = lldb.value(lldb.frame.FindVariable(&quot;rectangle_array&quot;))
    print rectangle_array[12]
    print rectangle_array[5].origin.x'''</span>
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__init__</span>(self, sbvalue):
        <span class="enscript-comment">#_sbval19k84obscure747 is specifically chosen to be obscure. 
</span>        <span class="enscript-comment">#This avoids conflicts when attributes could mean any field value in code
</span>        self._sbval19k84obscure747 = sbvalue
        self._sbval19k84obscure747_type = sbvalue.GetType()
        self._sbval19k84obscure747_is_ptr = sbvalue.GetType().IsPointerType()
        self.sbvalue = sbvalue

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__nonzero__</span>(self):
        <span class="enscript-keyword">return</span> ( self._sbval19k84obscure747.__nonzero__() <span class="enscript-keyword">and</span> self._GetValueAsUnsigned() != 0 )

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__repr__</span>(self):
        <span class="enscript-keyword">return</span> self._sbval19k84obscure747.__str__()
    
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__cmp__</span>(self, other):
        <span class="enscript-keyword">if</span> type(other) <span class="enscript-keyword">is</span> int:
            me = int(self)
            <span class="enscript-keyword">if</span> type(me) <span class="enscript-keyword">is</span> long:
                other = long(other)
            <span class="enscript-keyword">return</span> me.__cmp__(other)
        <span class="enscript-keyword">if</span> type(other) <span class="enscript-keyword">is</span> value:
            <span class="enscript-keyword">return</span> int(self).__cmp__(int(other))
        <span class="enscript-keyword">raise</span> TypeError(<span class="enscript-string">&quot;Cannot compare value with this type&quot;</span>)
    
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__str__</span>(self):
        <span class="enscript-keyword">global</span> _cstring_rex
        type_name = self._sbval19k84obscure747_type.GetName()
        <span class="enscript-keyword">if</span> len(_cstring_rex.findall(type_name)) &gt; 0 :
            <span class="enscript-keyword">return</span> self._GetValueAsString()
        summary = self._sbval19k84obscure747.GetSummary()
        <span class="enscript-keyword">if</span> summary:
            <span class="enscript-keyword">return</span> summary.strip(<span class="enscript-string">'&quot;'</span>)
        <span class="enscript-keyword">return</span> self._sbval19k84obscure747.__str__()

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__getitem__</span>(self, key):
        <span class="enscript-comment"># Allow array access if this value has children...
</span>        <span class="enscript-keyword">if</span> type(key) <span class="enscript-keyword">is</span> slice:
            _start = int(key.start)
            _end = int(key.stop)
            _step = 1
            <span class="enscript-keyword">if</span> key.step != None:
                _step = int(key.step)
            retval = []
            <span class="enscript-keyword">while</span> _start &lt; _end:
                retval.append(self[_start])
                _start += _step
            <span class="enscript-keyword">return</span> retval
        <span class="enscript-keyword">if</span> type(key) <span class="enscript-keyword">in</span> (int, long):
            <span class="enscript-keyword">return</span> value(self._sbval19k84obscure747.GetValueForExpressionPath(<span class="enscript-string">&quot;[%i]&quot;</span> % key))
        <span class="enscript-keyword">if</span> type(key) <span class="enscript-keyword">is</span> value:
            <span class="enscript-keyword">return</span> value(self._sbval19k84obscure747.GetValueForExpressionPath(<span class="enscript-string">&quot;[%i]&quot;</span> % int(key)))
        <span class="enscript-keyword">raise</span> TypeError(<span class="enscript-string">&quot;Cannot fetch Array item for this type&quot;</span>)

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__getattr__</span>(self, name):
        child_sbvalue = self._sbval19k84obscure747.GetChildMemberWithName (name)
        <span class="enscript-keyword">if</span> child_sbvalue:
            <span class="enscript-keyword">return</span> value(child_sbvalue)
        <span class="enscript-keyword">raise</span> AttributeError(<span class="enscript-string">&quot;No field by name: &quot;</span>+name )

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__add__</span>(self, other):
        <span class="enscript-keyword">return</span> int(self) + int(other)
    
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__radd__</span>(self, other):
        <span class="enscript-keyword">return</span> int(self) + int(other)
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__sub__</span>(self, other):
        <span class="enscript-keyword">return</span> int(self) - int(other)
    
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__rsub__</span>(self, other):
        <span class="enscript-keyword">return</span> int(other) - int(self)
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__mul__</span>(self, other):
        <span class="enscript-keyword">return</span> int(self) * int(other)
    
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__rmul__</span>(self, other):
        <span class="enscript-keyword">return</span> int(self) * int(other)
    
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__floordiv__</span>(self, other):
        <span class="enscript-keyword">return</span> int(self) // int(other)
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__mod__</span>(self, other):
        <span class="enscript-keyword">return</span> int(self) % int(other)
    
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__rmod__</span>(self, other):
        <span class="enscript-keyword">return</span> int(other) % int(self)
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__divmod__</span>(self, other):
        <span class="enscript-keyword">return</span> int(self) % int(other)
    
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__rdivmod__</span>(self, other):
        <span class="enscript-keyword">return</span> int(other) % int(self)
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__pow__</span>(self, other):
        <span class="enscript-keyword">return</span> int(self) ** int(other)
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__lshift__</span>(self, other):
        <span class="enscript-keyword">return</span> int(self) &lt;&lt; int(other)
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__rshift__</span>(self, other):
        <span class="enscript-keyword">return</span> int(self) &gt;&gt; int(other)
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__and__</span>(self, other):
        <span class="enscript-keyword">return</span> int(self) &amp; int(other)
    
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__rand</span>(self, other):
        <span class="enscript-keyword">return</span> int(self) &amp; int(other)
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__xor__</span>(self, other):
        <span class="enscript-keyword">return</span> int(self) ^ int(other)
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__or__</span>(self, other):
        <span class="enscript-keyword">return</span> int(self) | int(other)
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__div__</span>(self, other):
        <span class="enscript-keyword">return</span> int(self) / int(other)
    
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__rdiv__</span>(self, other):
        <span class="enscript-keyword">return</span> int(other)/int(self)
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__truediv__</span>(self, other):
        <span class="enscript-keyword">return</span> int(self) / int(other)
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__iadd__</span>(self, other):
        result = self.__add__(other)
        self._sbval19k84obscure747.SetValueFromCString (str(result))
        <span class="enscript-keyword">return</span> result
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__isub__</span>(self, other):
        result = self.__sub__(other)
        self._sbval19k84obscure747.SetValueFromCString (str(result))
        <span class="enscript-keyword">return</span> result
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__imul__</span>(self, other):
        result = self.__mul__(other)
        self._sbval19k84obscure747.SetValueFromCString (str(result))
        <span class="enscript-keyword">return</span> result
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__idiv__</span>(self, other):
        result = self.__div__(other)
        self._sbval19k84obscure747.SetValueFromCString (str(result))
        <span class="enscript-keyword">return</span> result
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__itruediv__</span>(self, other):
        result = self.__truediv__(other)
        self._sbval19k84obscure747.SetValueFromCString (str(result))
        <span class="enscript-keyword">return</span> result
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__ifloordiv__</span>(self, other):
        result =  self.__floordiv__(self, other)
        self._sbval19k84obscure747.SetValueFromCString (str(result))
        <span class="enscript-keyword">return</span> result
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__imod__</span>(self, other):
        result =  self.__and__(self, other)
        self._sbval19k84obscure747.SetValueFromCString (str(result))
        <span class="enscript-keyword">return</span> result
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__ipow__</span>(self, other):
        result = self.__pow__(self, other)
        self._sbval19k84obscure747.SetValueFromCString (str(result))
        <span class="enscript-keyword">return</span> result
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__ipow__</span>(self, other, modulo):
        result = self.__pow__(self, other, modulo)
        self._sbval19k84obscure747.SetValueFromCString (str(result))
        <span class="enscript-keyword">return</span> result
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__ilshift__</span>(self, other):
        result = self.__lshift__(other)
        self._sbval19k84obscure747.SetValueFromCString (str(result))
        <span class="enscript-keyword">return</span> result
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__irshift__</span>(self, other):
        result =  self.__rshift__(other)
        self._sbval19k84obscure747.SetValueFromCString (str(result))
        <span class="enscript-keyword">return</span> result
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__iand__</span>(self, other):
        result =  self.__and__(self, other)
        self._sbval19k84obscure747.SetValueFromCString (str(result))
        <span class="enscript-keyword">return</span> result
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__ixor__</span>(self, other):
        result =  self.__xor__(self, other)
        self._sbval19k84obscure747.SetValueFromCString (str(result))
        <span class="enscript-keyword">return</span> result
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__ior__</span>(self, other):
        result =  self.__ior__(self, other)
        self._sbval19k84obscure747.SetValueFromCString (str(result))
        <span class="enscript-keyword">return</span> result
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__neg__</span>(self):
        <span class="enscript-keyword">return</span> -int(self)
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__pos__</span>(self):
        <span class="enscript-keyword">return</span> +int(self)
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__abs__</span>(self):
        <span class="enscript-keyword">return</span> abs(int(self))
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__invert__</span>(self):
        <span class="enscript-keyword">return</span> ~int(self)
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__complex__</span>(self):
        <span class="enscript-keyword">return</span> complex (int(self))
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__int__</span>(self):
        <span class="enscript-keyword">if</span> self._sbval19k84obscure747_is_ptr:
            <span class="enscript-keyword">return</span> self._GetValueAsUnsigned()
        tname= self._sbval19k84obscure747_type.GetName()
        <span class="enscript-keyword">if</span> tname.find(<span class="enscript-string">'uint'</span>) &gt;= 0 <span class="enscript-keyword">or</span> tname.find(<span class="enscript-string">'unsigned'</span>) &gt;= 0:
            <span class="enscript-keyword">return</span> self._GetValueAsUnsigned()
        retval = self._sbval19k84obscure747.GetValueAsSigned()
        <span class="enscript-comment"># &lt;rdar://problem/12481949&gt; lldb python: GetValueAsSigned does not return the correct value
</span>        <span class="enscript-keyword">if</span> (retval &amp; 0x80000000):
            retval = retval - 0x100000000
        <span class="enscript-keyword">return</span> retval
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__long__</span>(self):
        <span class="enscript-keyword">return</span> self._sbval19k84obscure747.GetValueAsSigned()
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__float__</span>(self):
        <span class="enscript-keyword">return</span> float (self._sbval19k84obscure747.GetValueAsSigned())
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__oct__</span>(self):
        <span class="enscript-keyword">return</span> <span class="enscript-string">'0%o'</span> % self._GetValueAsUnsigned()
        
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__hex__</span>(self):
        <span class="enscript-keyword">return</span> <span class="enscript-string">'0x%x'</span> % self._GetValueAsUnsigned()

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__eq__</span>(self, other):
        self_err = lldb.SBError()
        other_err = lldb.SBError()
        self_val = self._sbval19k84obscure747.GetValueAsUnsigned(self_err)
        <span class="enscript-keyword">if</span> self_err.fail:
                <span class="enscript-keyword">raise</span> ValueError(<span class="enscript-string">&quot;unable to extract value of self&quot;</span>)
        <span class="enscript-keyword">if</span> type(other) <span class="enscript-keyword">is</span> value:
            other_val = other._sbval19k84obscure747.GetValueAsUnsigned(other_err)
            <span class="enscript-keyword">if</span> other_err.fail:
                <span class="enscript-keyword">raise</span> ValueError(<span class="enscript-string">&quot;unable to extract value of other&quot;</span>)
            <span class="enscript-keyword">return</span> self_val == other_val
        <span class="enscript-keyword">if</span> type(other) <span class="enscript-keyword">is</span> int:
            <span class="enscript-keyword">return</span> int(self) == other
        <span class="enscript-keyword">raise</span> TypeError(<span class="enscript-string">&quot;Equality operation is not defined for this type.&quot;</span>)
                                                                    
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__neq__</span>(self, other):
        <span class="enscript-keyword">return</span> <span class="enscript-keyword">not</span> self.__eq__(other)
    
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetSBValue</span>(self):
        <span class="enscript-keyword">return</span> self._sbval19k84obscure747
    
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__getstate__</span>(self):
        err = lldb.SBError()
        <span class="enscript-keyword">if</span> self._sbval19k84obscure747_is_ptr:
            addr = self._sbval19k84obscure747.GetValueAsUnsigned()
            size = self._sbval19k84obscure747_type.GetPointeeType().GetByteSize()
        <span class="enscript-keyword">else</span>:
            addr = self._sbval19k84obscure747.AddressOf().GetValueAsUnsigned()
            size = self._sbval19k84obscure747_type.GetByteSize()
        
        content = LazyTarget.GetProcess().ReadMemory(addr, size, err)
        <span class="enscript-keyword">if</span> err.fail:
            content = <span class="enscript-string">''</span>
        <span class="enscript-keyword">return</span> content

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">_GetValueAsSigned</span>(self):
        serr = lldb.SBError()
        retval = self._sbval19k84obscure747.GetValueAsSigned(serr)
        <span class="enscript-keyword">if</span> serr.success:
            <span class="enscript-keyword">return</span> retval
        <span class="enscript-keyword">raise</span> ValueError(<span class="enscript-string">&quot;Failed to read signed data. &quot;</span>+ str(self._sbval19k84obscure747) +<span class="enscript-string">&quot;(type =&quot;</span> + str(self._sbval19k84obscure747_type) + <span class="enscript-string">&quot;) Error description: &quot;</span> + serr.GetCString())
    
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">_GetValueAsUnsigned</span>(self):
        serr = lldb.SBError()
        retval = self._sbval19k84obscure747.GetValueAsUnsigned(serr)
        <span class="enscript-keyword">if</span> serr.success:
            <span class="enscript-keyword">return</span> retval
        <span class="enscript-keyword">raise</span> ValueError(<span class="enscript-string">&quot;Failed to read unsigned data. &quot;</span>+ str(self._sbval19k84obscure747) +<span class="enscript-string">&quot;(type =&quot;</span> + str(self._sbval19k84obscure747_type) + <span class="enscript-string">&quot;) Error description: &quot;</span> + serr.GetCString())
    
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">_GetValueAsString</span>(self, offset = 0, maxlen = 1024):
        serr = lldb.SBError()
        sbdata = None
        <span class="enscript-keyword">if</span> self._sbval19k84obscure747.TypeIsPointerType():
            sbdata = self._sbval19k84obscure747.GetPointeeData(offset, maxlen)
        <span class="enscript-keyword">else</span>:
            sbdata = self._sbval19k84obscure747.GetData()
        
        retval = <span class="enscript-string">''</span>
        bytesize = sbdata.GetByteSize()
        <span class="enscript-keyword">if</span> bytesize == 0 :
            <span class="enscript-comment">#raise ValueError('Unable to read value as string')
</span>            <span class="enscript-keyword">return</span> <span class="enscript-string">''</span>
        <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> range(0, bytesize) :
            serr.Clear()
            ch = chr(sbdata.GetUnsignedInt8(serr, i))
            <span class="enscript-keyword">if</span> serr.fail :
                <span class="enscript-keyword">raise</span> ValueError(<span class="enscript-string">&quot;Unable to read string data: &quot;</span> + serr.GetCString())
            <span class="enscript-keyword">if</span> ch == <span class="enscript-string">'\0'</span>:
                <span class="enscript-keyword">break</span>
            retval += ch
        <span class="enscript-keyword">return</span> retval 
    
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__format__</span>(self, format_spec):
        ret_format = <span class="enscript-string">&quot;{0:&quot;</span>+format_spec+<span class="enscript-string">&quot;}&quot;</span>
        <span class="enscript-comment"># typechar is last char. see <a href="http://www.python.org/dev/peps/pep-3101/">http://www.python.org/dev/peps/pep-3101/</a>
</span>        type_spec=format_spec.strip().lower()[-1]
        <span class="enscript-keyword">if</span> type_spec == <span class="enscript-string">'x'</span>:
            <span class="enscript-keyword">return</span> ret_format.format(self._GetValueAsUnsigned())
        <span class="enscript-keyword">if</span> type_spec == <span class="enscript-string">'d'</span>:
            <span class="enscript-keyword">return</span> ret_format.format(int(self))
        <span class="enscript-keyword">if</span> type_spec == <span class="enscript-string">'s'</span>:
            <span class="enscript-keyword">return</span> ret_format.format(str(self))
        <span class="enscript-keyword">if</span> type_spec == <span class="enscript-string">'o'</span>:
            <span class="enscript-keyword">return</span> ret_format.format(int(oct(self)))
        <span class="enscript-keyword">if</span> type_spec == <span class="enscript-string">'c'</span>:
            <span class="enscript-keyword">return</span> ret_format.format(int(self))
        
        <span class="enscript-keyword">return</span> <span class="enscript-string">&quot;unknown format &quot;</span> + format_spec + str(self)
        
        
<span class="enscript-keyword">def</span> <span class="enscript-function-name">unsigned</span>(val):
    <span class="enscript-string">&quot;&quot;&quot; Helper function to get unsigned value from core.value
        params: val - value (see value class above) representation of an integer type
        returns: int which is unsigned. 
        raises : ValueError if the type cannot be represented as unsigned int.
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> type(val) <span class="enscript-keyword">is</span> value:
        <span class="enscript-keyword">return</span> val._GetValueAsUnsigned()
    <span class="enscript-keyword">return</span> int(val)

<span class="enscript-keyword">def</span> <span class="enscript-function-name">sizeof</span>(t):
    <span class="enscript-string">&quot;&quot;&quot; Find the byte size of a type. 
        params: t - str : ex 'time_spec' returns equivalent of sizeof(time_spec) in C
                t - value: ex a value object. returns size of the object
        returns: int - byte size length 
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> type(t) <span class="enscript-keyword">is</span> value :
        <span class="enscript-keyword">return</span> t.GetSBValue().GetByteSize()
    <span class="enscript-keyword">if</span> type(t) <span class="enscript-keyword">is</span> str:
        <span class="enscript-keyword">return</span> gettype(t).GetByteSize()
    <span class="enscript-keyword">raise</span> ValueError(<span class="enscript-string">&quot;Cannot get sizeof. Invalid argument&quot;</span>)
    
        
<span class="enscript-keyword">def</span> <span class="enscript-function-name">dereference</span>(val):
    <span class="enscript-string">&quot;&quot;&quot; Get a dereferenced obj for a pointer type obj
        params: val - value object representing a pointer type C construct in lldb
        returns: value - value
        ex. val = dereference(ptr_obj) #python
        is same as
            obj_ptr = (int *)0x1234  #C
            val = *obj_ptr           #C
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> type(val) <span class="enscript-keyword">is</span> value <span class="enscript-keyword">and</span> val.GetSBValue().TypeIsPointerType():
        <span class="enscript-keyword">return</span> value(val.GetSBValue().Dereference())
    <span class="enscript-keyword">raise</span> TypeError(<span class="enscript-string">'Cannot dereference this type.'</span>)
        
<span class="enscript-keyword">def</span> <span class="enscript-function-name">addressof</span>(val):
    <span class="enscript-string">&quot;&quot;&quot; Get address of a core.value object. 
        params: val - value object representing a C construct in lldb
        returns: value - value object referring to 'type(val) *' type
        ex. addr = addressof(hello_obj)  #python 
        is same as
           uintptr_t addr = (uintptr_t)&amp;hello_obj  #C
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> type(val) <span class="enscript-keyword">is</span> value:
        <span class="enscript-keyword">return</span> value(val.GetSBValue().AddressOf())
    <span class="enscript-keyword">raise</span> TypeError(<span class="enscript-string">&quot;Cannot do addressof for non-value type objects&quot;</span>)

<span class="enscript-keyword">def</span> <span class="enscript-function-name">cast</span>(obj, target_type):
    <span class="enscript-string">&quot;&quot;&quot; Type cast an object to another C type.
        params:
            obj - core.value  object representing some C construct in lldb
            target_type - str : ex 'char *'
                        - lldb.SBType :
    &quot;&quot;&quot;</span>
    dest_type = target_type
    <span class="enscript-keyword">if</span> type(target_type) <span class="enscript-keyword">is</span> str:
        dest_type = gettype(target_type)
    <span class="enscript-keyword">elif</span> type(target_type) <span class="enscript-keyword">is</span> value:
        dest_type = target_type.GetSBValue().GetType()

    <span class="enscript-keyword">if</span> type(obj) <span class="enscript-keyword">is</span> value :
        <span class="enscript-keyword">return</span> value(obj.GetSBValue().Cast(dest_type))
    <span class="enscript-keyword">elif</span> type(obj) <span class="enscript-keyword">is</span> int:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;ERROR: You cannot cast an 'int' to %s, please use kern.GetValueFromAddress() for such purposes.&quot;</span> % str(target_type) 
    <span class="enscript-keyword">raise</span> TypeError(<span class="enscript-string">&quot;object of type %s cannot be casted to %s&quot;</span> % (str(type(obj)), str(target_type)))

_value_types_cache={}

<span class="enscript-keyword">def</span> <span class="enscript-function-name">gettype</span>(target_type):
    <span class="enscript-string">&quot;&quot;&quot; Returns lldb.SBType of the given target_type
        params:
            target_type - str, ex. 'char', 'uint32_t' etc
        returns:
            lldb.SBType - SBType corresponding to the given target_type
        raises:
            NameError  - Incase the type is not identified
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">global</span> _value_types_cache
    target_type = str(target_type).strip()
    <span class="enscript-keyword">if</span> target_type <span class="enscript-keyword">not</span> <span class="enscript-keyword">in</span> _value_types_cache:
        tmp_type = None
        <span class="enscript-keyword">if</span> target_type.endswith(<span class="enscript-string">'*'</span>) :
            tmp_type = LazyTarget.GetTarget().FindFirstType(target_type.rstrip(<span class="enscript-string">'*'</span>).strip())
            <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> tmp_type.IsValid():
                <span class="enscript-keyword">raise</span> NameError(<span class="enscript-string">'Unable to Cast to type '</span>+target_type)
            tmp_type = tmp_type.GetPointerType()
        <span class="enscript-keyword">else</span> :
            tmp_type = LazyTarget.GetTarget().FindFirstType(target_type)
            <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> tmp_type.IsValid():
                <span class="enscript-keyword">raise</span> NameError(<span class="enscript-string">'Unable to Cast to type '</span>+target_type)
        _value_types_cache[target_type] = tmp_type
    <span class="enscript-keyword">return</span> _value_types_cache[target_type]

<span class="enscript-keyword">def</span> <span class="enscript-function-name">getfieldoffset</span>(struct_type, field_name):
    <span class="enscript-string">&quot;&quot;&quot; Returns the byte offset of a field inside a given struct
        params:
            struct_type - str or lldb.SBType, ex. 'struct ipc_port *' or port.gettype()
            field_name  - str, name of the field inside the struct ex. 'ip_messages'
        returns:
            int - byte offset of the field_name inside the struct_type
        raises:
            TypeError  - - In case the struct_type has no field with the name field_name
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> type(struct_type) == str:
        struct_type = gettype(struct_type)
    offset = 0
    <span class="enscript-keyword">for</span> field <span class="enscript-keyword">in</span> struct_type.get_fields_array():
        <span class="enscript-keyword">if</span> str(field.GetName()) == field_name:
            <span class="enscript-keyword">return</span> field.GetOffsetInBytes()
    <span class="enscript-keyword">raise</span> TypeError(<span class="enscript-string">'Field name &quot;%s&quot; not found in type &quot;%s&quot;'</span> % (field_name, str(struct_type)))

<span class="enscript-keyword">def</span> <span class="enscript-function-name">islong</span>(x):
    <span class="enscript-string">&quot;&quot;&quot; Returns True if a string represents a long integer, False otherwise
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">try</span>:
        long(x,16)
    <span class="enscript-keyword">except</span> ValueError:
        <span class="enscript-keyword">try</span>:
            long(x)
        <span class="enscript-keyword">except</span> ValueError:
            <span class="enscript-keyword">return</span> False
    <span class="enscript-keyword">return</span> True

<span class="enscript-keyword">def</span> <span class="enscript-function-name">readmemory</span>(val):
    <span class="enscript-string">&quot;&quot;&quot; Returns a string of hex data that is referenced by the value.
        params: val - a value object. 
        return: str - string of hex bytes. 
        raises: TypeError if val is not a valid type
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> type(val) <span class="enscript-keyword">is</span> value:
        <span class="enscript-keyword">raise</span> TypeError(<span class="enscript-string">'%s is not of type value'</span> % str(type(val)))
    <span class="enscript-keyword">return</span> val.__getstate__()
</pre>
<hr />
</body></html>