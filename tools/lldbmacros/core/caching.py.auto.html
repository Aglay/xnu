<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>caching.py</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">caching.py&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-string">&quot;&quot;&quot; 
A basic caching module for xnu debug macros to use.
It is recommended to use [Get|Save][Static|Dynamic]CacheData() apis for 
your caching needs. These APIs will handle the case of clearing caches when 
a debugger continues and stops or hit a breakpoint. 

Use Static caches for data that will not change if the program is run and stopped again. e.g. typedata, version numbers etc.
An example invocation could be like
def getDSYMPathForUUID(uuid):
    # Get the data from cache
    cached_data = caching.GetStaticCacheData('dsym.for.uuid', {})
    
    if uuid in cached_data:
        return cached_data[uuid]
    else:
        path = #get info for uuid
        cached_data[uuid] = path

    # save the cached_data object to cache.
    caching.SaveStaticCacheData('dsym.for.uuid', cached_data)
    
    return cached_data[uuid]

And use Dynamic caches for things like thread data, zones information etc. 
These will automatically be dropped when debugger continues the target 
An example use of Dynamic cache could be as follows

def GetExecutablePathForPid(pid):
    # Get the data from cache
    cached_data = caching.GetDynamicCacheData('exec_for_path', {})
    
    if pid in cached_data:
        return cached_data[pid]
    else:
        exec_path = &quot;/path/to/exec&quot;  #get exec path for pid
        cached_data[pid] = path

    # save the cached_data object to cache.
    caching.SaveDynamicCacheData('exec_for_path', cached_data)
    
    return cached_data[pid]

&quot;&quot;&quot;</span>

<span class="enscript-comment">#Private Routines and objects
</span>
<span class="enscript-keyword">from</span> configuration <span class="enscript-keyword">import</span> *

<span class="enscript-keyword">import</span> sys

<span class="enscript-string">&quot;&quot;&quot;
The format for the saved data dictionaries is 
{
    'key' : (valueobj, versno),
    ...
}

The versno is an int defining the version of obj. In case of version mismatch it will set valueobj to default upon access.

&quot;&quot;&quot;</span>
_static_data = {}
_dynamic_data = {}



<span class="enscript-keyword">def</span> <span class="enscript-function-name">_GetDebuggerSessionID</span>():
    <span class="enscript-string">&quot;&quot;&quot; A default callable function that _GetCurrentSessionID uses to 
        identify a stopped session.
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">return</span> 0

<span class="enscript-keyword">def</span> <span class="enscript-function-name">_GetCurrentSessionID</span>():
    <span class="enscript-string">&quot;&quot;&quot; Get the current session id. This will update whenever
        system is continued or if there is new information that would
        cause the dynamic cache to be deleted.

        returns: int - session id number.
    &quot;&quot;&quot;</span>
    session_id = _GetDebuggerSessionID()
    <span class="enscript-keyword">return</span> session_id;


<span class="enscript-comment">#Public APIs 
</span>
<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetSizeOfCache</span>():
    <span class="enscript-string">&quot;&quot;&quot; Returns number of bytes held in cache.
        returns:
            int - size of cache including static and dynamic
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">global</span> _static_data, _dynamic_data
    <span class="enscript-keyword">return</span> sys.getsizeof(_static_data) + sys.getsizeof(_dynamic_data)


<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetStaticCacheData</span>(key, default_value = None):
    <span class="enscript-string">&quot;&quot;&quot; Get cached object based on key from the cache of static information. 
        params:
            key: str - a unique string identifying your data.
            default_value : obj - an object that should be returned if key is not found.
        returns:
            default_value - if the static cache does not have your data.
            obj  - The data obj saved with SaveStaticCacheData()
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">global</span> _static_data
    key = str(key)
    <span class="enscript-keyword">if</span> key <span class="enscript-keyword">in</span> _static_data:
        <span class="enscript-keyword">return</span> _static_data[key][0]
    <span class="enscript-keyword">return</span> default_value

<span class="enscript-keyword">def</span> <span class="enscript-function-name">SaveStaticCacheData</span>(key, value):
    <span class="enscript-string">&quot;&quot;&quot; Save data into the cache identified by key.
        It will overwrite any data that was previously associated with key
        params:
            key  : str - a unique string identifying your data
            value: obj - any object that is to be cached.
        returns:
            Nothing
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">global</span> _static_data

    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> config[<span class="enscript-string">'CacheStaticData'</span>]:
        <span class="enscript-keyword">return</span>
    
    key = str(key)
    _static_data[key] = (value, _GetCurrentSessionID())
    <span class="enscript-keyword">return</span>


<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetDynamicCacheData</span>(key, default_value=None):
    <span class="enscript-string">&quot;&quot;&quot; Get cached object based on key from the cache of dynamic information.
        params:
            key: str - a unique string identifying cached object
            default_value : obj - an object that should be returned if key is not found.
        returns:
            default_value - if dynamic cache does not have data or if the saved version mismatches with current session id.
            obj  - The data obj saved with SaveDynamicCacheData()
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">global</span> _dynamic_data
    key = str(key)
    <span class="enscript-keyword">if</span> key <span class="enscript-keyword">in</span> _dynamic_data:
        <span class="enscript-keyword">if</span> _GetCurrentSessionID() == _dynamic_data[key][1]:
            <span class="enscript-keyword">return</span> _dynamic_data[key][0]
        <span class="enscript-keyword">else</span>:
            <span class="enscript-keyword">del</span> _dynamic_data[key]

    <span class="enscript-keyword">return</span> default_value


<span class="enscript-keyword">def</span> <span class="enscript-function-name">SaveDynamicCacheData</span>(key, value):
    <span class="enscript-string">&quot;&quot;&quot; Save data into the cache identified by key.
        It will overwrite any data that was previously associated with key
        params:
            key  : str - a unique string identifying your data
            value: obj - any object that is to be cached.
        returns:
            Nothing
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">global</span> _dynamic_data

    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> config[<span class="enscript-string">'CacheDynamicData'</span>]:
        <span class="enscript-keyword">return</span>

    key = str(key)
    _dynamic_data[key] = (value, _GetCurrentSessionID())

    <span class="enscript-keyword">return</span>
</pre>
<hr />
</body></html>