<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>operating_system.py</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">operating_system.py&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">#!/usr/bin/python
</span><span class="enscript-comment">#
</span>
<span class="enscript-comment">#source of register info is from <a href="http://opensource.apple.com/source/gdb/gdb-962/src/gdb/arm-tdep.c">http://opensource.apple.com/source/gdb/gdb-962/src/gdb/arm-tdep.c</a>
</span><span class="enscript-keyword">import</span> lldb
<span class="enscript-keyword">import</span> struct
osplugin_target_obj = None

<span class="enscript-keyword">class</span> PluginValue(lldb.SBValue):
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetChildMemberWithName</span>(val, name):
        val_type = val.GetType()
        <span class="enscript-keyword">if</span> val_type.IsPointerType() == True:
            val_type = val_type.GetPointeeType()
        <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> range(val_type.GetNumberOfFields()):
            <span class="enscript-keyword">if</span> name == val_type.GetFieldAtIndex(i).GetName():
                <span class="enscript-keyword">return</span> PluginValue(val.GetChildAtIndex(i))
        <span class="enscript-keyword">return</span> None

<span class="enscript-keyword">class</span> Armv8_RegisterSet(object):
    <span class="enscript-string">&quot;&quot;&quot; register info set for armv8 64 bit architecture&quot;&quot;&quot;</span>
    register_info = { <span class="enscript-string">'sets'</span> : [<span class="enscript-string">'GPR'</span>],
                  <span class="enscript-string">'registers'</span>: [
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x0'</span>  , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>:  0, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>: 0, <span class="enscript-string">'dwarf'</span>: 0, <span class="enscript-string">'alt-name'</span>:<span class="enscript-string">'arg1'</span>, <span class="enscript-string">'generic'</span>:<span class="enscript-string">'arg1'</span>},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x1'</span>  , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>:  8, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>: 1, <span class="enscript-string">'dwarf'</span>: 1, <span class="enscript-string">'alt-name'</span>:<span class="enscript-string">'arg2'</span>, <span class="enscript-string">'generic'</span>:<span class="enscript-string">'arg2'</span>},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x2'</span>  , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>: 16, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>: 2, <span class="enscript-string">'dwarf'</span>: 2, <span class="enscript-string">'alt-name'</span>:<span class="enscript-string">'arg3'</span>, <span class="enscript-string">'generic'</span>:<span class="enscript-string">'arg3'</span>},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x3'</span>  , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>: 24, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>: 3, <span class="enscript-string">'dwarf'</span>: 3, <span class="enscript-string">'alt-name'</span>:<span class="enscript-string">'arg4'</span>, <span class="enscript-string">'generic'</span>:<span class="enscript-string">'arg4'</span>},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x4'</span>  , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>: 32, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>: 4, <span class="enscript-string">'dwarf'</span>: 4, <span class="enscript-string">'alt-name'</span>:<span class="enscript-string">'arg5'</span>, <span class="enscript-string">'generic'</span>:<span class="enscript-string">'arg5'</span>},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x5'</span>  , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>: 40, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>: 5, <span class="enscript-string">'dwarf'</span>: 5, <span class="enscript-string">'alt-name'</span>:<span class="enscript-string">'arg6'</span>, <span class="enscript-string">'generic'</span>:<span class="enscript-string">'arg6'</span>},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x6'</span>  , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>: 48, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>: 6, <span class="enscript-string">'dwarf'</span>: 6, <span class="enscript-string">'alt-name'</span>:<span class="enscript-string">'arg7'</span>, <span class="enscript-string">'generic'</span>:<span class="enscript-string">'arg7'</span>},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x7'</span>  , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>: 56, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>: 7, <span class="enscript-string">'dwarf'</span>: 7, <span class="enscript-string">'alt-name'</span>:<span class="enscript-string">'arg8'</span>, <span class="enscript-string">'generic'</span>:<span class="enscript-string">'arg8'</span>},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x8'</span>  , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>: 64, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>: 8, <span class="enscript-string">'dwarf'</span>: 8},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x9'</span>  , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>: 72, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>: 9, <span class="enscript-string">'dwarf'</span>: 9},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x10'</span> , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>: 80, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:10, <span class="enscript-string">'dwarf'</span>:10},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x11'</span> , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>: 88, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:11, <span class="enscript-string">'dwarf'</span>:11},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x12'</span> , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>: 96, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:12, <span class="enscript-string">'dwarf'</span>:12},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x13'</span> , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>:104, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:13, <span class="enscript-string">'dwarf'</span>:13},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x14'</span> , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>:112, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:14, <span class="enscript-string">'dwarf'</span>:14},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x15'</span> , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>:120, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:15, <span class="enscript-string">'dwarf'</span>:15},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x16'</span> , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>:128, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:16, <span class="enscript-string">'dwarf'</span>:16},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x17'</span> , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>:136, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:17, <span class="enscript-string">'dwarf'</span>:17},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x18'</span> , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>:144, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:18, <span class="enscript-string">'dwarf'</span>:18},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x19'</span> , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>:152, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:19, <span class="enscript-string">'dwarf'</span>:19},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x20'</span> , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>:160, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:20, <span class="enscript-string">'dwarf'</span>:20},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x21'</span> , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>:168, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:21, <span class="enscript-string">'dwarf'</span>:21},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x22'</span> , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>:176, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:22, <span class="enscript-string">'dwarf'</span>:22},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x23'</span> , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>:184, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:23, <span class="enscript-string">'dwarf'</span>:23},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x24'</span> , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>:192, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:24, <span class="enscript-string">'dwarf'</span>:24},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x25'</span> , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>:200, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:25, <span class="enscript-string">'dwarf'</span>:25},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x26'</span> , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>:208, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:26, <span class="enscript-string">'dwarf'</span>:26},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x27'</span> , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>:216, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:27, <span class="enscript-string">'dwarf'</span>:27},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'x28'</span> , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>:224, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:28, <span class="enscript-string">'dwarf'</span>:28},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'fp'</span>  , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>:232, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:29, <span class="enscript-string">'dwarf'</span>:29, <span class="enscript-string">'alt-name'</span>: <span class="enscript-string">'fp'</span>, <span class="enscript-string">'generic'</span>:<span class="enscript-string">'fp'</span>},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'lr'</span>  , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>:240, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:30, <span class="enscript-string">'dwarf'</span>:30, <span class="enscript-string">'alt-name'</span>: <span class="enscript-string">'lr'</span>, <span class="enscript-string">'generic'</span>:<span class="enscript-string">'lr'</span>},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'sp'</span>  , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>:248, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:31, <span class="enscript-string">'dwarf'</span>:31, <span class="enscript-string">'alt-name'</span>: <span class="enscript-string">'sp'</span>, <span class="enscript-string">'generic'</span>:<span class="enscript-string">'sp'</span>},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'pc'</span>  , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>:256, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:32, <span class="enscript-string">'dwarf'</span>:32, <span class="enscript-string">'alt-name'</span>: <span class="enscript-string">'pc'</span>, <span class="enscript-string">'generic'</span>:<span class="enscript-string">'pc'</span>},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'far'</span> , <span class="enscript-string">'bitsize'</span>:64, <span class="enscript-string">'offset'</span>:264, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'cpsr'</span>, <span class="enscript-string">'bitsize'</span>:32, <span class="enscript-string">'offset'</span>:272, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:33, <span class="enscript-string">'dwarf'</span>:33, <span class="enscript-string">'generic'</span>:<span class="enscript-string">'flags'</span>},
    {<span class="enscript-string">'name'</span>: <span class="enscript-string">'esr'</span> , <span class="enscript-string">'bitsize'</span>:32, <span class="enscript-string">'offset'</span>:276, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0},
    ]
    }

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__init__</span>(self):
        self.switch_context_address = osplugin_target_obj.FindSymbols(<span class="enscript-string">'Switch_context'</span>)[0].GetSymbol().GetStartAddress().GetLoadAddress(osplugin_target_obj)
        self.ResetRegisterValues()
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">ResetRegisterValues</span>(self):
        self.x0 = 0
        self.x1 = 0
        self.x2 = 0
        self.x3 = 0
        self.x4 = 0
        self.x5 = 0
        self.x6 = 0
        self.x7 = 0
        self.x8 = 0
        self.x9 = 0
        self.x10 = 0
        self.x11 = 0
        self.x12 = 0
        self.x13 = 0
        self.x14 = 0
        self.x15 = 0
        self.x16 = 0
        self.x17 = 0
        self.x18 = 0
        self.x19 = 0
        self.x20 = 0
        self.x21 = 0
        self.x22 = 0
        self.x23 = 0
        self.x24 = 0
        self.x25 = 0
        self.x26 = 0
        self.x27 = 0
        self.x28 = 0
        self.fp = 0
        self.lr = 0
        self.sp = 0
        self.pc = 0
        self.far = 0
        self.cpsr = 0
        self.esr = 0

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__str__</span>(self):
        <span class="enscript-keyword">return</span> <span class="enscript-string">&quot;&quot;&quot; pc = &quot;&quot;&quot;</span>

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetPackedRegisterState</span>(self):
        <span class="enscript-keyword">return</span> struct.pack(<span class="enscript-string">'34QII'</span>, self.x0, self.x1, self.x2, self.x3, self.x4, self.x5,
            self.x6, self.x7, self.x8, self.x9, self.x10, self.x11, self.x12, self.x13,
            self.x14, self.x15, self.x16, self.x17, self.x18, self.x19, self.x20, self.x21,
            self.x22, self.x23, self.x24, self.x25, self.x26, self.x27, self.x28, self.fp,
            self.lr, self.sp, self.pc, self.far, self.cpsr, self.esr)

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">ReadRegisterDataFromKDPSavedState</span>(self, kdp_state, kernel_version):
        <span class="enscript-string">&quot;&quot;&quot; Setup register values from KDP saved information.
        &quot;&quot;&quot;</span>
        saved_state = kernel_version.CreateValueFromExpression(None, <span class="enscript-string">'(struct arm_saved_state64 *) '</span> + str(kdp_state.GetValueAsUnsigned()))
        saved_state = saved_state.Dereference()
        saved_state = PluginValue(saved_state)
        self.ResetRegisterValues()
        self.x0 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(0).GetValueAsUnsigned()
        self.x1 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(1).GetValueAsUnsigned()
        self.x2 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(2).GetValueAsUnsigned()
        self.x3 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(3).GetValueAsUnsigned()
        self.x4 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(4).GetValueAsUnsigned()
        self.x5 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(5).GetValueAsUnsigned()
        self.x6 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(6).GetValueAsUnsigned()
        self.x7 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(7).GetValueAsUnsigned()
        self.x8 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(8).GetValueAsUnsigned()
        self.x9 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(9).GetValueAsUnsigned()
        self.x10 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(10).GetValueAsUnsigned()
        self.x11 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(11).GetValueAsUnsigned()
        self.x12 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(12).GetValueAsUnsigned()
        self.x13 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(13).GetValueAsUnsigned()
        self.x14 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(14).GetValueAsUnsigned()
        self.x15 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(15).GetValueAsUnsigned()
        self.x16 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(16).GetValueAsUnsigned()
        self.x17 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(17).GetValueAsUnsigned()
        self.x18 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(18).GetValueAsUnsigned()
        self.x19 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(19).GetValueAsUnsigned()
        self.x20 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(20).GetValueAsUnsigned()
        self.x21 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(21).GetValueAsUnsigned()
        self.x22 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(22).GetValueAsUnsigned()
        self.x23 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(23).GetValueAsUnsigned()
        self.x24 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(24).GetValueAsUnsigned()
        self.x25 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(25).GetValueAsUnsigned()
        self.x26 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(26).GetValueAsUnsigned()
        self.x27 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(27).GetValueAsUnsigned()
        self.x28 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(28).GetValueAsUnsigned()
        self.fp = saved_state.GetChildMemberWithName(<span class="enscript-string">'fp'</span>).GetValueAsUnsigned()
        self.lr = saved_state.GetChildMemberWithName(<span class="enscript-string">'lr'</span>).GetValueAsUnsigned()
        self.sp = saved_state.GetChildMemberWithName(<span class="enscript-string">'sp'</span>).GetValueAsUnsigned()
        self.pc = saved_state.GetChildMemberWithName(<span class="enscript-string">'pc'</span>).GetValueAsUnsigned()
        self.far = saved_state.GetChildMemberWithName(<span class="enscript-string">'far'</span>).GetValueAsUnsigned()
        self.cpsr = saved_state.GetChildMemberWithName(<span class="enscript-string">'cpsr'</span>).GetValueAsUnsigned()
        self.esr = saved_state.GetChildMemberWithName(<span class="enscript-string">'esr'</span>).GetValueAsUnsigned()
        <span class="enscript-keyword">return</span> self

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">ReadRegisterDataFromKernelStack</span>(self, kstack_saved_state_addr, kernel_version):
        saved_state = kernel_version.CreateValueFromExpression(None, <span class="enscript-string">'(struct arm_saved_state64 *) '</span>+ str(kstack_saved_state_addr))
        saved_state = saved_state.Dereference()
        saved_state = PluginValue(saved_state)
        self.ResetRegisterValues()
        self.x0 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(0).GetValueAsUnsigned()
        self.x1 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(1).GetValueAsUnsigned()
        self.x2 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(2).GetValueAsUnsigned()
        self.x3 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(3).GetValueAsUnsigned()
        self.x4 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(4).GetValueAsUnsigned()
        self.x5 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(5).GetValueAsUnsigned()
        self.x6 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(6).GetValueAsUnsigned()
        self.x7 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(7).GetValueAsUnsigned()
        self.x8 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(8).GetValueAsUnsigned()
        self.x9 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(9).GetValueAsUnsigned()
        self.x10 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(10).GetValueAsUnsigned()
        self.x11 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(11).GetValueAsUnsigned()
        self.x12 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(12).GetValueAsUnsigned()
        self.x13 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(13).GetValueAsUnsigned()
        self.x14 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(14).GetValueAsUnsigned()
        self.x15 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(15).GetValueAsUnsigned()
        self.x16 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(16).GetValueAsUnsigned()
        self.x17 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(17).GetValueAsUnsigned()
        self.x18 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(18).GetValueAsUnsigned()
        self.x19 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(19).GetValueAsUnsigned()
        self.x20 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(20).GetValueAsUnsigned()
        self.x21 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(21).GetValueAsUnsigned()
        self.x22 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(22).GetValueAsUnsigned()
        self.x23 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(23).GetValueAsUnsigned()
        self.x24 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(24).GetValueAsUnsigned()
        self.x25 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(25).GetValueAsUnsigned()
        self.x26 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(26).GetValueAsUnsigned()
        self.x27 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(27).GetValueAsUnsigned()
        self.x28 = saved_state.GetChildMemberWithName(<span class="enscript-string">'x'</span>).GetChildAtIndex(28).GetValueAsUnsigned()
        self.fp = saved_state.GetChildMemberWithName(<span class="enscript-string">'fp'</span>).GetValueAsUnsigned()
        self.lr = saved_state.GetChildMemberWithName(<span class="enscript-string">'lr'</span>).GetValueAsUnsigned()
        self.sp = saved_state.GetChildMemberWithName(<span class="enscript-string">'sp'</span>).GetValueAsUnsigned()
        <span class="enscript-comment"># pc for a blocked thread is treated to be the next instruction it would run after thread switch.
</span>        self.pc = self.switch_context_address
        self.far = saved_state.GetChildMemberWithName(<span class="enscript-string">'far'</span>).GetValueAsUnsigned()
        self.cpsr = saved_state.GetChildMemberWithName(<span class="enscript-string">'cpsr'</span>).GetValueAsUnsigned()
        self.esr = saved_state.GetChildMemberWithName(<span class="enscript-string">'esr'</span>).GetValueAsUnsigned()
        <span class="enscript-keyword">return</span> self

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">ReadRegisterDataFromContinuation</span>(self, continuation_ptr):
        self.ResetRegisterValues()
        self.pc = continuation_ptr
        <span class="enscript-keyword">return</span> self

    @classmethod
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetRegisterInfo</span>(cls, regnum):
        <span class="enscript-keyword">if</span> regnum &lt; 0 <span class="enscript-keyword">or</span> regnum &gt; len(cls.register_info[<span class="enscript-string">'registers'</span>]):
            <span class="enscript-keyword">return</span> <span class="enscript-string">''</span>
            
        reginfo = cls.register_info[<span class="enscript-string">'registers'</span>][regnum]
        retval = <span class="enscript-string">''</span>
        <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> reginfo.keys():
            v_str = str(reginfo[i])
            <span class="enscript-keyword">if</span> i == <span class="enscript-string">'set'</span>:
                v_str = <span class="enscript-string">'General Purpose Registers'</span>
            retval += <span class="enscript-string">&quot;%s:%s;&quot;</span> % (str(i), v_str)
        <span class="enscript-keyword">return</span> retval



<span class="enscript-keyword">class</span> Armv7_RegisterSet(object):
    <span class="enscript-string">&quot;&quot;&quot; register info set for armv7 32 bit architecture &quot;&quot;&quot;</span>
    register_info = { <span class="enscript-string">'sets'</span> : [<span class="enscript-string">'GPR'</span>],
                  <span class="enscript-string">'registers'</span>: [
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'r0'</span>   , <span class="enscript-string">'bitsize'</span> : 32, <span class="enscript-string">'offset'</span> :  0, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>: 0, <span class="enscript-string">'dwarf'</span> : 0},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'r1'</span>   , <span class="enscript-string">'bitsize'</span> : 32, <span class="enscript-string">'offset'</span> :  4, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>: 1, <span class="enscript-string">'dwarf'</span> : 1},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'r2'</span>   , <span class="enscript-string">'bitsize'</span> : 32, <span class="enscript-string">'offset'</span> :  8, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>: 2, <span class="enscript-string">'dwarf'</span> : 2},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'r3'</span>   , <span class="enscript-string">'bitsize'</span> : 32, <span class="enscript-string">'offset'</span> : 12, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>: 3, <span class="enscript-string">'dwarf'</span> : 3},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'r4'</span>   , <span class="enscript-string">'bitsize'</span> : 32, <span class="enscript-string">'offset'</span> : 16, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>: 4, <span class="enscript-string">'dwarf'</span> : 4},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'r5'</span>   , <span class="enscript-string">'bitsize'</span> : 32, <span class="enscript-string">'offset'</span> : 20, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>: 5, <span class="enscript-string">'dwarf'</span> : 5},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'r6'</span>   , <span class="enscript-string">'bitsize'</span> : 32, <span class="enscript-string">'offset'</span> : 24, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>: 6, <span class="enscript-string">'dwarf'</span> : 6},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'r7'</span>   , <span class="enscript-string">'bitsize'</span> : 32, <span class="enscript-string">'offset'</span> : 28, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>: 7, <span class="enscript-string">'dwarf'</span> : 7},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'r8'</span>   , <span class="enscript-string">'bitsize'</span> : 32, <span class="enscript-string">'offset'</span> : 32, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>: 8, <span class="enscript-string">'dwarf'</span> : 8},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'r9'</span>   , <span class="enscript-string">'bitsize'</span> : 32, <span class="enscript-string">'offset'</span> : 36, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>: 9, <span class="enscript-string">'dwarf'</span> : 9},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'r10'</span>  , <span class="enscript-string">'bitsize'</span> : 32, <span class="enscript-string">'offset'</span> : 40, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:10, <span class="enscript-string">'dwarf'</span> :10},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'r11'</span>  , <span class="enscript-string">'bitsize'</span> : 32, <span class="enscript-string">'offset'</span> : 44, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:11, <span class="enscript-string">'dwarf'</span> :11, <span class="enscript-string">'alt-name'</span>: <span class="enscript-string">'fp'</span>, <span class="enscript-string">'generic'</span>: <span class="enscript-string">'fp'</span>},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'r12'</span>  , <span class="enscript-string">'bitsize'</span> : 32, <span class="enscript-string">'offset'</span> : 48, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:12, <span class="enscript-string">'dwarf'</span> :12},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'sp'</span>   , <span class="enscript-string">'bitsize'</span> : 32, <span class="enscript-string">'offset'</span> : 52, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:13, <span class="enscript-string">'dwarf'</span> :13, <span class="enscript-string">'generic'</span>: <span class="enscript-string">'sp'</span>},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'lr'</span>   , <span class="enscript-string">'bitsize'</span> : 32, <span class="enscript-string">'offset'</span> : 56, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:14, <span class="enscript-string">'dwarf'</span> :14, <span class="enscript-string">'generic'</span>: <span class="enscript-string">'lr'</span>},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'pc'</span>   , <span class="enscript-string">'bitsize'</span> : 32, <span class="enscript-string">'offset'</span> : 60, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:15, <span class="enscript-string">'dwarf'</span> :15, <span class="enscript-string">'generic'</span>: <span class="enscript-string">'pc'</span>},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'cpsr'</span> , <span class="enscript-string">'bitsize'</span> : 32, <span class="enscript-string">'offset'</span> : 64, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0, <span class="enscript-string">'gcc'</span>:16, <span class="enscript-string">'dwarf'</span> :16, <span class="enscript-string">'generic'</span>:<span class="enscript-string">'flags'</span>},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'fsr'</span>  , <span class="enscript-string">'bitsize'</span> : 32, <span class="enscript-string">'offset'</span> : 68, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'far'</span>  , <span class="enscript-string">'bitsize'</span> : 32, <span class="enscript-string">'offset'</span> : 72, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>, <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>, <span class="enscript-string">'set'</span>:0}
        ]
        }

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__init__</span>(self):
        self.switch_context_address = osplugin_target_obj.FindSymbols(<span class="enscript-string">'load_reg'</span>)[0].GetSymbol().GetStartAddress().GetLoadAddress(osplugin_target_obj) + 8
        self.ResetRegisterValues()
    
    @classmethod
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetRegisterInfo</span>(cls, regnum):
        <span class="enscript-keyword">if</span> regnum &lt; 0 <span class="enscript-keyword">or</span> regnum &gt; len(cls.register_info[<span class="enscript-string">'registers'</span>]):
            <span class="enscript-keyword">return</span> <span class="enscript-string">''</span>
            
        reginfo = cls.register_info[<span class="enscript-string">'registers'</span>][regnum]
        retval = <span class="enscript-string">''</span>
        <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> reginfo.keys():
            v_str = str(reginfo[i])
            <span class="enscript-keyword">if</span> i == <span class="enscript-string">'set'</span>:
                v_str = <span class="enscript-string">'General Purpose Registers'</span>
            retval += <span class="enscript-string">&quot;%s:%s;&quot;</span> % (str(i), v_str)
        <span class="enscript-keyword">return</span> retval

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">ResetRegisterValues</span>(self):
        self.r0 = 0
        self.r1 = 0
        self.r2 = 0
        self.r3 = 0
        self.r4 = 0
        self.r5 = 0
        self.r6 = 0
        self.r7 = 0
        self.r8 = 0
        self.r9 = 0
        self.r10 = 0
        self.r11 = 0
        self.r12 = 0
        self.sp = 0
        self.lr = 0
        self.pc = 0
        self.cpsr = 0
        self.fsr = 0
        self.far = 0

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__str__</span>(self):
        <span class="enscript-keyword">return</span> <span class="enscript-string">&quot;&quot;&quot;
            r0 = {o.r0: &lt;#010x}
            r1 = {o.r1: &lt;#010x}
            r2 = {o.r2: &lt;#010x}
            r3 = {o.r3: &lt;#010x}
            r4 = {o.r4: &lt;#010x}
            r5 = {o.r5: &lt;#010x}
            r6 = {o.r6: &lt;#010x}
            r7 = {o.r7: &lt;#010x}
            r8 = {o.r8: &lt;#010x}
            r9 = {o.r9: &lt;#010x}
            r10 = {o.r10: &lt;#010x}
            r11 = {o.r11: &lt;#010x}
            r12 = {o.r12: &lt;#010x}
            sp = {o.sp: &lt;#010x}
            lr = {o.lr: &lt;#010x}
            pc = {o.pc: &lt;#010x}
            cpsr = {o.cpsr: &lt;#010x}
            fsr = {o.fsr : &lt;#010x}
            far = {o.far : &lt;#010x}
            &quot;&quot;&quot;</span>.format(o=self)

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetPackedRegisterState</span>(self):
        <span class="enscript-keyword">return</span> struct.pack(<span class="enscript-string">'19I'</span>, self.r0, self.r1, self.r2, self.r3,
            self.r4, self.r5, self.r6, self.r7,
            self.r8, self.r9, self.r10, self.r11,
            self.r12, self.sp, self.lr, self.pc,
            self.cpsr, self.fsr, self.far)

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">ReadRegisterDataFromKDPSavedState</span>(self, kdp_state, kernel_version):
        saved_state = kernel_version.CreateValueFromExpression(None, <span class="enscript-string">'(struct arm_saved_state *) '</span> + str(kdp_state.GetValueAsUnsigned()))
        saved_state = saved_state.Dereference()
        saved_state = PluginValue(saved_state)
        self.ResetRegisterValues()
        self.r0 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(0).GetValueAsUnsigned()
        self.r1 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(1).GetValueAsUnsigned()
        self.r2 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(2).GetValueAsUnsigned()
        self.r3 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(3).GetValueAsUnsigned()
        self.r4 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(4).GetValueAsUnsigned()
        self.r5 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(5).GetValueAsUnsigned()
        self.r6 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(6).GetValueAsUnsigned()
        self.r7 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(7).GetValueAsUnsigned()
        self.r8 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(8).GetValueAsUnsigned()
        self.r9 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(9).GetValueAsUnsigned()
        self.r10 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(10).GetValueAsUnsigned()
        self.r11 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(11).GetValueAsUnsigned()
        self.r12 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(12).GetValueAsUnsigned()
        self.sp = saved_state.GetChildMemberWithName(<span class="enscript-string">'sp'</span>).GetValueAsUnsigned()
        self.lr = saved_state.GetChildMemberWithName(<span class="enscript-string">'lr'</span>).GetValueAsUnsigned()
        self.pc = saved_state.GetChildMemberWithName(<span class="enscript-string">'pc'</span>).GetValueAsUnsigned()
        self.cpsr = saved_state.GetChildMemberWithName(<span class="enscript-string">'cpsr'</span>).GetValueAsUnsigned()
        self.fsr = saved_state.GetChildMemberWithName(<span class="enscript-string">'fsr'</span>).GetValueAsUnsigned()
        self.far = saved_state.GetChildMemberWithName(<span class="enscript-string">'far'</span>).GetValueAsUnsigned()
        <span class="enscript-keyword">return</span> self

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">ReadRegisterDataFromKernelStack</span>(self, kstack_saved_state_addr, kernel_version):
        saved_state = kernel_version.CreateValueFromExpression(None, <span class="enscript-string">'(struct arm_saved_state *) '</span>+ str(kstack_saved_state_addr))
        saved_state = saved_state.Dereference()
        saved_state = PluginValue(saved_state)
        self.ResetRegisterValues()
        self.r0 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(0).GetValueAsUnsigned()
        self.r1 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(1).GetValueAsUnsigned()
        self.r2 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(2).GetValueAsUnsigned()
        self.r3 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(3).GetValueAsUnsigned()
        self.r4 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(4).GetValueAsUnsigned()
        self.r5 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(5).GetValueAsUnsigned()
        self.r6 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(6).GetValueAsUnsigned()
        self.r7 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(7).GetValueAsUnsigned()
        self.r8 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(8).GetValueAsUnsigned()
        self.r9 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(9).GetValueAsUnsigned()
        self.r10 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(10).GetValueAsUnsigned()
        self.r11 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(11).GetValueAsUnsigned()
        self.r12 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r'</span>).GetChildAtIndex(12).GetValueAsUnsigned()
        self.sp = saved_state.GetChildMemberWithName(<span class="enscript-string">'sp'</span>).GetValueAsUnsigned()
        self.lr = saved_state.GetChildMemberWithName(<span class="enscript-string">'lr'</span>).GetValueAsUnsigned()
        <span class="enscript-comment"># pc for a blocked thread is treated to be the next instruction it would run after thread switch.
</span>        self.pc = self.switch_context_address
        self.cpsr = saved_state.GetChildMemberWithName(<span class="enscript-string">'cpsr'</span>).GetValueAsUnsigned()
        self.fsr = saved_state.GetChildMemberWithName(<span class="enscript-string">'fsr'</span>).GetValueAsUnsigned()
        self.far = saved_state.GetChildMemberWithName(<span class="enscript-string">'far'</span>).GetValueAsUnsigned()
        <span class="enscript-keyword">return</span> self

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">ReadRegisterDataFromContinuation</span>(self, continuation_ptr):
        self.ResetRegisterValues()
        self.pc = continuation_ptr
        <span class="enscript-keyword">return</span> self


<span class="enscript-keyword">class</span> I386_RegisterSet(object):
    <span class="enscript-string">&quot;&quot;&quot; register info set for i386 architecture
    &quot;&quot;&quot;</span>
    register_info = { <span class="enscript-string">'sets'</span> : [<span class="enscript-string">'GPR'</span>],
                  <span class="enscript-string">'registers'</span>: [
        { <span class="enscript-string">'name'</span>: <span class="enscript-string">'eax'</span>   , <span class="enscript-string">'bitsize'</span>: 32, <span class="enscript-string">'offset'</span> : 0, <span class="enscript-string">'encoding'</span>: <span class="enscript-string">'uint'</span> , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span> , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 0, <span class="enscript-string">'dwarf'</span>: 0},
        { <span class="enscript-string">'name'</span>: <span class="enscript-string">'ebx'</span>   , <span class="enscript-string">'bitsize'</span>: 32, <span class="enscript-string">'offset'</span> : 4, <span class="enscript-string">'encoding'</span>: <span class="enscript-string">'uint'</span> , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span> , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 3, <span class="enscript-string">'dwarf'</span>: 3},
        { <span class="enscript-string">'name'</span>: <span class="enscript-string">'ecx'</span>   , <span class="enscript-string">'bitsize'</span>: 32, <span class="enscript-string">'offset'</span> : 8, <span class="enscript-string">'encoding'</span>: <span class="enscript-string">'uint'</span> , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span> , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 1, <span class="enscript-string">'dwarf'</span>: 1},
        { <span class="enscript-string">'name'</span>: <span class="enscript-string">'edx'</span>   , <span class="enscript-string">'bitsize'</span>: 32, <span class="enscript-string">'offset'</span> :12, <span class="enscript-string">'encoding'</span>: <span class="enscript-string">'uint'</span> , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span> , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 2, <span class="enscript-string">'dwarf'</span>: 2},
        { <span class="enscript-string">'name'</span>: <span class="enscript-string">'edi'</span>   , <span class="enscript-string">'bitsize'</span>: 32, <span class="enscript-string">'offset'</span> :16, <span class="enscript-string">'encoding'</span>: <span class="enscript-string">'uint'</span> , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span> , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 7, <span class="enscript-string">'dwarf'</span>: 7},
        { <span class="enscript-string">'name'</span>: <span class="enscript-string">'esi'</span>   , <span class="enscript-string">'bitsize'</span>: 32, <span class="enscript-string">'offset'</span> :20, <span class="enscript-string">'encoding'</span>: <span class="enscript-string">'uint'</span> , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span> , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 6, <span class="enscript-string">'dwarf'</span>: 6},
        { <span class="enscript-string">'name'</span>: <span class="enscript-string">'ebp'</span>   , <span class="enscript-string">'bitsize'</span>: 32, <span class="enscript-string">'offset'</span> :24, <span class="enscript-string">'encoding'</span>: <span class="enscript-string">'uint'</span> , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span> , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 4, <span class="enscript-string">'dwarf'</span>: 5, <span class="enscript-string">'generic'</span>: <span class="enscript-string">'fp'</span>, <span class="enscript-string">'alt-name'</span>: <span class="enscript-string">'fp'</span>},
        { <span class="enscript-string">'name'</span>: <span class="enscript-string">'esp'</span>   , <span class="enscript-string">'bitsize'</span>: 32, <span class="enscript-string">'offset'</span> :28, <span class="enscript-string">'encoding'</span>: <span class="enscript-string">'uint'</span> , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span> , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 5, <span class="enscript-string">'dwarf'</span>: 4, <span class="enscript-string">'generic'</span>: <span class="enscript-string">'sp'</span>, <span class="enscript-string">'alt-name'</span>: <span class="enscript-string">'sp'</span>},
        { <span class="enscript-string">'name'</span>: <span class="enscript-string">'ss'</span>    , <span class="enscript-string">'bitsize'</span>: 32, <span class="enscript-string">'offset'</span> :32, <span class="enscript-string">'encoding'</span>: <span class="enscript-string">'uint'</span> , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span> , <span class="enscript-string">'set'</span>: 0},
        { <span class="enscript-string">'name'</span>: <span class="enscript-string">'eflags'</span>, <span class="enscript-string">'bitsize'</span>: 32, <span class="enscript-string">'offset'</span> :36, <span class="enscript-string">'encoding'</span>: <span class="enscript-string">'uint'</span> , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span> , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 9, <span class="enscript-string">'dwarf'</span>: 9, <span class="enscript-string">'generic'</span>: <span class="enscript-string">'flags'</span>},
        { <span class="enscript-string">'name'</span>: <span class="enscript-string">'eip'</span>   , <span class="enscript-string">'bitsize'</span>: 32, <span class="enscript-string">'offset'</span> :40, <span class="enscript-string">'encoding'</span>: <span class="enscript-string">'uint'</span> , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span> , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> :8, <span class="enscript-string">'dwarf'</span>:8, <span class="enscript-string">'generic'</span>: <span class="enscript-string">'pc'</span>, <span class="enscript-string">'alt-name'</span>: <span class="enscript-string">'pc'</span>},
        { <span class="enscript-string">'name'</span>: <span class="enscript-string">'cs'</span>    , <span class="enscript-string">'bitsize'</span>: 32, <span class="enscript-string">'offset'</span> :44, <span class="enscript-string">'encoding'</span>: <span class="enscript-string">'uint'</span> , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span> , <span class="enscript-string">'set'</span>: 0},
        { <span class="enscript-string">'name'</span>: <span class="enscript-string">'ds'</span>    , <span class="enscript-string">'bitsize'</span>: 32, <span class="enscript-string">'offset'</span> :48, <span class="enscript-string">'encoding'</span>: <span class="enscript-string">'uint'</span> , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span> , <span class="enscript-string">'set'</span>: 0},
        { <span class="enscript-string">'name'</span>: <span class="enscript-string">'es'</span>    , <span class="enscript-string">'bitsize'</span>: 32, <span class="enscript-string">'offset'</span> :52, <span class="enscript-string">'encoding'</span>: <span class="enscript-string">'uint'</span> , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span> , <span class="enscript-string">'set'</span>: 0},
        { <span class="enscript-string">'name'</span>: <span class="enscript-string">'fs'</span>    , <span class="enscript-string">'bitsize'</span>: 32, <span class="enscript-string">'offset'</span> :56, <span class="enscript-string">'encoding'</span>: <span class="enscript-string">'uint'</span> , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span> , <span class="enscript-string">'set'</span>: 0},
        { <span class="enscript-string">'name'</span>: <span class="enscript-string">'gs'</span>    , <span class="enscript-string">'bitsize'</span>: 32, <span class="enscript-string">'offset'</span> :60, <span class="enscript-string">'encoding'</span>: <span class="enscript-string">'uint'</span> , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span> , <span class="enscript-string">'set'</span>: 0},
        ]
        }

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__init__</span>(self):
        self.ResetRegisterValues()
    
    @classmethod
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetRegisterInfo</span>(cls, regnum):
        <span class="enscript-keyword">if</span> regnum &lt; 0 <span class="enscript-keyword">or</span> regnum &gt; len(cls.register_info[<span class="enscript-string">'registers'</span>]):
            <span class="enscript-keyword">return</span> <span class="enscript-string">''</span>
            
        reginfo = cls.register_info[<span class="enscript-string">'registers'</span>][regnum]
        retval = <span class="enscript-string">''</span>
        <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> reginfo.keys():
            v_str = str(reginfo[i])
            <span class="enscript-keyword">if</span> i == <span class="enscript-string">'set'</span>:
                v_str = <span class="enscript-string">'General Purpose Registers'</span>
            retval += <span class="enscript-string">&quot;%s:%s;&quot;</span> % (str(i), v_str)
        <span class="enscript-keyword">return</span> retval

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">ResetRegisterValues</span>(self):
        <span class="enscript-string">&quot;&quot;&quot; set all registers to zero &quot;&quot;&quot;</span>
        self.eax = 0
        self.ebx = 0
        self.ecx = 0
        self.edx = 0
        self.edi = 0
        self.esi = 0
        self.ebp = 0
        self.esp = 0
        self.ss  = 0
        self.eflags = 0
        self.eip = 0
        self.cs = 0
        self.ds = 0
        self.es = 0
        self.fs = 0
        self.gs = 0

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__str__</span>(self):
        <span class="enscript-keyword">return</span> <span class="enscript-string">&quot;&quot;&quot;
            eax = {o.eax: #010x}
            ebx = {o.ebx: #010x}
            ecx = {o.ecx: #010x}
            edx = {o.edx: #010x}
            edi = {o.edi: #010x}
            esi = {o.esi: #010x}
            ebp = {o.ebp: #010x}
            esp = {o.esp: #010x}
            ss  = {o.ss: #010x}
         eflags = {o.eflags: #010x}
            eip = {o.eip: #010x}
            cs  = {o.cs: #010x}
            ds  = {o.ds: #010x}
            es  = {o.es: #010x}
            fs  = {o.fs: #010x}
            gs  = {o.gs: #010x}
            &quot;&quot;&quot;</span>.format(o=self)

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetPackedRegisterState</span>(self):
        <span class="enscript-string">&quot;&quot;&quot; get a struct.pack register data &quot;&quot;&quot;</span>
        <span class="enscript-keyword">return</span> struct.pack(<span class="enscript-string">'16I'</span>, self.eax, self.ebx, self.ecx,
            self.edx, self.edi, self.esi,
            self.ebp, self.esp, self.ss,
            self.eflags, self.eip, self.cs,
            self.ds, self.es, self.fs, self.gs
            )

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">ReadRegisterDataFromKDPSavedState</span>(self, kdp_state, kernel_version):
        <span class="enscript-string">&quot;&quot;&quot; to be implemented&quot;&quot;&quot;</span>
        <span class="enscript-keyword">return</span> None

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">ReadRegisterDataFromKernelStack</span>(self, kstack_saved_state_addr, kernel_version):
        <span class="enscript-string">&quot;&quot;&quot; to be implemented &quot;&quot;&quot;</span>
        <span class="enscript-keyword">return</span> None

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">ReadRegisterDataFromContinuation</span>(self, continuation_ptr):
        self.ResetRegisterValues()
        self.eip = continuation_ptr
        <span class="enscript-keyword">return</span> self


<span class="enscript-keyword">class</span> X86_64RegisterSet(object):
    <span class="enscript-string">&quot;&quot;&quot; register info set for x86_64 architecture &quot;&quot;&quot;</span>
    register_info = { <span class="enscript-string">'sets'</span> : [<span class="enscript-string">'GPR'</span>],
                  <span class="enscript-string">'registers'</span>: [
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'rax'</span>       , <span class="enscript-string">'bitsize'</span> :  64, <span class="enscript-string">'offset'</span> :   0, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>  , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>         , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 0, <span class="enscript-string">'dwarf'</span> : 0},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'rbx'</span>       , <span class="enscript-string">'bitsize'</span> :  64, <span class="enscript-string">'offset'</span> :   8, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>  , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>         , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 3, <span class="enscript-string">'dwarf'</span> : 3},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'rcx'</span>       , <span class="enscript-string">'bitsize'</span> :  64, <span class="enscript-string">'offset'</span> :  16, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>  , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>         , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 2, <span class="enscript-string">'dwarf'</span> : 2, <span class="enscript-string">'generic'</span>:<span class="enscript-string">'arg4'</span>, <span class="enscript-string">'alt-name'</span>:<span class="enscript-string">'arg4'</span>, },
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'rdx'</span>       , <span class="enscript-string">'bitsize'</span> :  64, <span class="enscript-string">'offset'</span> :  24, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>  , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>         , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 1, <span class="enscript-string">'dwarf'</span> : 1, <span class="enscript-string">'generic'</span>:<span class="enscript-string">'arg3'</span>, <span class="enscript-string">'alt-name'</span>:<span class="enscript-string">'arg3'</span>, },
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'rdi'</span>       , <span class="enscript-string">'bitsize'</span> :  64, <span class="enscript-string">'offset'</span> :  32, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>  , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>         , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 5, <span class="enscript-string">'dwarf'</span> : 5, <span class="enscript-string">'generic'</span>:<span class="enscript-string">'arg1'</span>, <span class="enscript-string">'alt-name'</span>:<span class="enscript-string">'arg1'</span>, },
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'rsi'</span>       , <span class="enscript-string">'bitsize'</span> :  64, <span class="enscript-string">'offset'</span> :  40, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>  , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>         , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 4, <span class="enscript-string">'dwarf'</span> : 4, <span class="enscript-string">'generic'</span>:<span class="enscript-string">'arg2'</span>, <span class="enscript-string">'alt-name'</span>:<span class="enscript-string">'arg2'</span>, },
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'rbp'</span>       , <span class="enscript-string">'bitsize'</span> :  64, <span class="enscript-string">'offset'</span> :  48, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>  , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>         , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 6, <span class="enscript-string">'dwarf'</span> : 6, <span class="enscript-string">'generic'</span>:<span class="enscript-string">'fp'</span>  , <span class="enscript-string">'alt-name'</span>:<span class="enscript-string">'fp'</span>, },
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'rsp'</span>       , <span class="enscript-string">'bitsize'</span> :  64, <span class="enscript-string">'offset'</span> :  56, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>  , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>         , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 7, <span class="enscript-string">'dwarf'</span> : 7, <span class="enscript-string">'generic'</span>:<span class="enscript-string">'sp'</span>  , <span class="enscript-string">'alt-name'</span>:<span class="enscript-string">'sp'</span>, },
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'r8'</span>        , <span class="enscript-string">'bitsize'</span> :  64, <span class="enscript-string">'offset'</span> :  64, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>  , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>         , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 8, <span class="enscript-string">'dwarf'</span> : 8, <span class="enscript-string">'generic'</span>:<span class="enscript-string">'arg5'</span>, <span class="enscript-string">'alt-name'</span>:<span class="enscript-string">'arg5'</span>, },
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'r9'</span>        , <span class="enscript-string">'bitsize'</span> :  64, <span class="enscript-string">'offset'</span> :  72, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>  , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>         , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 9, <span class="enscript-string">'dwarf'</span> : 9, <span class="enscript-string">'generic'</span>:<span class="enscript-string">'arg6'</span>, <span class="enscript-string">'alt-name'</span>:<span class="enscript-string">'arg6'</span>, },
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'r10'</span>       , <span class="enscript-string">'bitsize'</span> :  64, <span class="enscript-string">'offset'</span> :  80, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>  , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>         , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 10, <span class="enscript-string">'dwarf'</span> : 10},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'r11'</span>       , <span class="enscript-string">'bitsize'</span> :  64, <span class="enscript-string">'offset'</span> :  88, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>  , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>         , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 11, <span class="enscript-string">'dwarf'</span> : 11},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'r12'</span>       , <span class="enscript-string">'bitsize'</span> :  64, <span class="enscript-string">'offset'</span> :  96, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>  , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>         , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 12, <span class="enscript-string">'dwarf'</span> : 12},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'r13'</span>       , <span class="enscript-string">'bitsize'</span> :  64, <span class="enscript-string">'offset'</span> : 104, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>  , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>         , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 13, <span class="enscript-string">'dwarf'</span> : 13},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'r14'</span>       , <span class="enscript-string">'bitsize'</span> :  64, <span class="enscript-string">'offset'</span> : 112, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>  , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>         , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 14, <span class="enscript-string">'dwarf'</span> : 14},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'r15'</span>       , <span class="enscript-string">'bitsize'</span> :  64, <span class="enscript-string">'offset'</span> : 120, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>  , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>         , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 15, <span class="enscript-string">'dwarf'</span> : 15},
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'rip'</span>       , <span class="enscript-string">'bitsize'</span> :  64, <span class="enscript-string">'offset'</span> : 128, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>  , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>         , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'gcc'</span> : 16, <span class="enscript-string">'dwarf'</span> : 16, <span class="enscript-string">'generic'</span>:<span class="enscript-string">'pc'</span>, <span class="enscript-string">'alt-name'</span>:<span class="enscript-string">'pc'</span> },
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'rflags'</span>    , <span class="enscript-string">'bitsize'</span> :  64, <span class="enscript-string">'offset'</span> : 136, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>  , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>         , <span class="enscript-string">'set'</span>: 0, <span class="enscript-string">'generic'</span>:<span class="enscript-string">'flags'</span>, <span class="enscript-string">'alt-name'</span>:<span class="enscript-string">'flags'</span> },
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'cs'</span>        , <span class="enscript-string">'bitsize'</span> :  64, <span class="enscript-string">'offset'</span> : 144, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>  , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>         , <span class="enscript-string">'set'</span>: 0                          },
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'fs'</span>        , <span class="enscript-string">'bitsize'</span> :  64, <span class="enscript-string">'offset'</span> : 152, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>  , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>         , <span class="enscript-string">'set'</span>: 0                          },
        { <span class="enscript-string">'name'</span>:<span class="enscript-string">'gs'</span>        , <span class="enscript-string">'bitsize'</span> :  64, <span class="enscript-string">'offset'</span> : 160, <span class="enscript-string">'encoding'</span>:<span class="enscript-string">'uint'</span>  , <span class="enscript-string">'format'</span>:<span class="enscript-string">'hex'</span>         , <span class="enscript-string">'set'</span>: 0                          },
        ]
        }
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__init__</span>(self):
        self.ResetRegisterValues()

    @classmethod
    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetRegisterInfo</span>(cls, regnum):
        <span class="enscript-keyword">if</span> regnum &lt; 0 <span class="enscript-keyword">or</span> regnum &gt; len(cls.register_info[<span class="enscript-string">'registers'</span>]):
            <span class="enscript-keyword">return</span> <span class="enscript-string">''</span>

        reginfo = cls.register_info[<span class="enscript-string">'registers'</span>][regnum]
        retval = <span class="enscript-string">''</span>
        <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> reginfo.keys():
            v_str = str(reginfo[i])
            <span class="enscript-keyword">if</span> i == <span class="enscript-string">'set'</span>:
                v_str = <span class="enscript-string">'General Purpose Registers'</span>
            retval += <span class="enscript-string">&quot;%s:%s;&quot;</span> % (str(i), v_str)
        <span class="enscript-keyword">return</span> retval


    <span class="enscript-keyword">def</span> <span class="enscript-function-name">ResetRegisterValues</span>(self):
        <span class="enscript-string">&quot;&quot;&quot; set all the registers to zero. &quot;&quot;&quot;</span>
        self.rax = 0
        self.rbx = 0
        self.rcx = 0
        self.rdx = 0
        self.rdi = 0
        self.rsi = 0
        self.rbp = 0
        self.rsp = 0
        self.r8  = 0
        self.r9  = 0
        self.r10 = 0
        self.r11 = 0
        self.r12 = 0
        self.r13 = 0
        self.r14 = 0
        self.r15 = 0
        self.rip = 0
        self.rflags = 0
        self.cs  = 0
        self.fs  = 0
        self.gs  = 0

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__str__</span>(self):
        <span class="enscript-keyword">return</span> <span class="enscript-string">&quot;&quot;&quot;
            rax = {o.rax: &lt;#018x}
            rbx = {o.rbx: &lt;#018x}
            rcx = {o.rcx: &lt;#018x}
            rdx = {o.rdx: &lt;#018x}
            rdi = {o.rdi: &lt;#018x}
            rsi = {o.rsi: &lt;#018x}
            rbp = {o.rbp: &lt;#018x}
            rsp = {o.rsp: &lt;#018x}
            r8  = {o.r8: &lt;#018x}
            r9  = {o.r9: &lt;#018x}
            r10 = {o.r10: &lt;#018x}
            r11 = {o.r11: &lt;#018x}
            r12 = {o.r12: &lt;#018x}
            r13 = {o.r13: &lt;#018x}
            r14 = {o.r14: &lt;#018x}
            r15 = {o.r15: &lt;#018x}
            rip = {o.rip: &lt;#018x}
            rflags =  {o.rflags: &lt;#018x}
            cs = {o.cs: &lt;#018x}
            fs = {o.fs: &lt;#018x}
            gs = {o.gs: &lt;#018x}
            &quot;&quot;&quot;</span>.format(o=self)

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">GetPackedRegisterState</span>(self):
        <span class="enscript-string">&quot;&quot;&quot; get a struct.pack register data for passing to C constructs &quot;&quot;&quot;</span>
        <span class="enscript-keyword">return</span> struct.pack(<span class="enscript-string">'21Q'</span>, self.rax, self.rbx, self.rcx, self.rdx, self.rdi,
            self.rsi, self.rbp, self.rsp, self.r8,  self.r9,
            self.r10, self.r11, self.r12, self.r13, self.r14,
            self.r15, self.rip, self.rflags, self.cs, self.fs, self.gs)

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">ReadRegisterDataFromKDPSavedState</span>(self, kdp_state, kernel_version):
        saved_state = kernel_version.CreateValueFromExpression(None,  <span class="enscript-string">'(struct x86_saved_state64 *) '</span>+ str(kdp_state.GetValueAsUnsigned()))
        saved_state = saved_state.Dereference()
        saved_state = PluginValue(saved_state)
        self.ResetRegisterValues()
        self.rdi = saved_state.GetChildMemberWithName(<span class="enscript-string">'rdi'</span>).GetValueAsUnsigned()
        self.rsi = saved_state.GetChildMemberWithName(<span class="enscript-string">'rsi'</span>).GetValueAsUnsigned()
        self.rdx = saved_state.GetChildMemberWithName(<span class="enscript-string">'rdx'</span>).GetValueAsUnsigned()
        self.r10 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r10'</span>).GetValueAsUnsigned()
        self.r8 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r8'</span>).GetValueAsUnsigned()
        self.r9 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r9'</span>).GetValueAsUnsigned()
        self.r15 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r15'</span>).GetValueAsUnsigned()
        self.r14 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r14'</span>).GetValueAsUnsigned()
        self.r13 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r13'</span>).GetValueAsUnsigned()
        self.r12 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r12'</span>).GetValueAsUnsigned()
        self.r11 = saved_state.GetChildMemberWithName(<span class="enscript-string">'r11'</span>).GetValueAsUnsigned()
        self.rbp = saved_state.GetChildMemberWithName(<span class="enscript-string">'rbp'</span>).GetValueAsUnsigned()
        self.rbx = saved_state.GetChildMemberWithName(<span class="enscript-string">'rbx'</span>).GetValueAsUnsigned()
        self.rcx = saved_state.GetChildMemberWithName(<span class="enscript-string">'rcx'</span>).GetValueAsUnsigned()
        self.rax = saved_state.GetChildMemberWithName(<span class="enscript-string">'rax'</span>).GetValueAsUnsigned()
        self.rip = saved_state.GetChildMemberWithName(<span class="enscript-string">'isf'</span>).GetChildMemberWithName(<span class="enscript-string">'rip'</span>).GetValueAsUnsigned()
        self.rflags = saved_state.GetChildMemberWithName(<span class="enscript-string">'isf'</span>).GetChildMemberWithName(<span class="enscript-string">'rflags'</span>).GetValueAsUnsigned()
        self.rsp = saved_state.GetChildMemberWithName(<span class="enscript-string">'isf'</span>).GetChildMemberWithName(<span class="enscript-string">'rsp'</span>).GetValueAsUnsigned()
        <span class="enscript-keyword">return</span> self

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">ReadRegisterDataFromKernelStack</span>(self, kstack_saved_state_addr, kernel_version):
        saved_state = kernel_version.CreateValueFromExpression(None, <span class="enscript-string">'(struct x86_kernel_state *) '</span>+ str(kstack_saved_state_addr))
        saved_state = saved_state.Dereference()
        saved_state = PluginValue(saved_state)
        self.ResetRegisterValues()
        self.rbx = saved_state.GetChildMemberWithName(<span class="enscript-string">'k_rbx'</span>).GetValueAsUnsigned()
        self.rsp = saved_state.GetChildMemberWithName(<span class="enscript-string">'k_rsp'</span>).GetValueAsUnsigned()
        self.rbp = saved_state.GetChildMemberWithName(<span class="enscript-string">'k_rbp'</span>).GetValueAsUnsigned()
        self.r12 = saved_state.GetChildMemberWithName(<span class="enscript-string">'k_r12'</span>).GetValueAsUnsigned()
        self.r13 = saved_state.GetChildMemberWithName(<span class="enscript-string">'k_r13'</span>).GetValueAsUnsigned()
        self.r14 = saved_state.GetChildMemberWithName(<span class="enscript-string">'k_r14'</span>).GetValueAsUnsigned()
        self.r15 = saved_state.GetChildMemberWithName(<span class="enscript-string">'k_r15'</span>).GetValueAsUnsigned()
        self.rip = saved_state.GetChildMemberWithName(<span class="enscript-string">'k_rip'</span>).GetValueAsUnsigned()
        <span class="enscript-keyword">return</span> self

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">ReadRegisterDataFromContinuation</span>(self, continuation_ptr):
        self.ResetRegisterValues()
        self.rip = continuation_ptr
        <span class="enscript-keyword">return</span> self




<span class="enscript-keyword">def</span> <span class="enscript-function-name">IterateQueue</span>(queue_head, element_ptr_type, element_field_name):
    <span class="enscript-string">&quot;&quot;&quot; iterate over a queue in kernel of type queue_head_t. refer to osfmk/kern/queue.h
        params:
            queue_head         - lldb.SBValue : Value object for queue_head.
            element_type       - lldb.SBType : a pointer type of the element 'next' points to. Typically its structs like thread, task etc..
            element_field_name - str : name of the field in target struct.
        returns:
            A generator does not return. It is used for iterating.
            SBValue  : an object thats of type (element_type) queue_head-&gt;next. Always a pointer object
    &quot;&quot;&quot;</span>
    queue_head_addr = 0x0
    <span class="enscript-keyword">if</span> queue_head.TypeIsPointerType():
        queue_head_addr = queue_head.GetValueAsUnsigned()
    <span class="enscript-keyword">else</span>:
        queue_head_addr = queue_head.GetAddress().GetLoadAddress(osplugin_target_obj)
    cur_elt = queue_head.GetChildMemberWithName(<span class="enscript-string">'next'</span>)
    <span class="enscript-keyword">while</span> True:
        <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> cur_elt.IsValid() <span class="enscript-keyword">or</span> cur_elt.GetValueAsUnsigned() == 0 <span class="enscript-keyword">or</span> cur_elt.GetValueAsUnsigned() == queue_head_addr:
            <span class="enscript-keyword">break</span>
        elt = cur_elt.Cast(element_ptr_type)
        <span class="enscript-keyword">yield</span> elt
        cur_elt = elt.GetChildMemberWithName(element_field_name).GetChildMemberWithName(<span class="enscript-string">'next'</span>)

<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetUniqueSessionID</span>(process_obj):
    <span class="enscript-string">&quot;&quot;&quot; Create a unique session identifier.
        params:
          process_obj: lldb.SBProcess object refering to connected process.
        returns:
          int - a unique number identified by processid and stopid.
    &quot;&quot;&quot;</span>
    session_key_str = <span class="enscript-string">&quot;&quot;</span>
    <span class="enscript-keyword">if</span> hasattr(process_obj, <span class="enscript-string">&quot;GetUniqueID&quot;</span>):
        session_key_str += str(process_obj.GetUniqueID()) + <span class="enscript-string">&quot;:&quot;</span>
    <span class="enscript-keyword">else</span>:
        session_key_str += <span class="enscript-string">&quot;0:&quot;</span>

    <span class="enscript-keyword">if</span> hasattr(process_obj, <span class="enscript-string">&quot;GetStopID&quot;</span>):
        session_key_str += str(process_obj.GetStopID())
    <span class="enscript-keyword">else</span>:
        session_key_str +=<span class="enscript-string">&quot;1&quot;</span>

    <span class="enscript-keyword">return</span> hash(session_key_str)


(archX86_64, archARMv7_family, archI386, archARMv8) = (<span class="enscript-string">&quot;x86_64&quot;</span>, (<span class="enscript-string">&quot;armv7&quot;</span>, <span class="enscript-string">&quot;armv7s&quot;</span>, <span class="enscript-string">&quot;armv7k&quot;</span>) , <span class="enscript-string">&quot;i386&quot;</span>, <span class="enscript-string">&quot;arm64&quot;</span>)

<span class="enscript-keyword">class</span> OperatingSystemPlugIn(object):
    <span class="enscript-string">&quot;&quot;&quot;Class that provides data for an instance of a LLDB 'OperatingSystemPython' plug-in class&quot;&quot;&quot;</span>

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">__init__</span>(self, process):
        <span class="enscript-string">'''Initialization needs a valid.SBProcess object'''</span>
        self.process = None
        self.registers = None
        self.threads = None
        self.thread_cache = {}
        self.current_session_id = 0
        self.kdp_thread = None
        <span class="enscript-keyword">if</span> type(process) <span class="enscript-keyword">is</span> lldb.SBProcess <span class="enscript-keyword">and</span> process.IsValid():
            <span class="enscript-keyword">global</span> osplugin_target_obj
            self.process = process
            self._target = process.target
            osplugin_target_obj = self._target
            self.current_session_id = GetUniqueSessionID(self.process)
            self.version = self._target.FindGlobalVariables(<span class="enscript-string">'version'</span>, 1).GetValueAtIndex(0)
            self.kernel_stack_size = self._target.FindGlobalVariables(<span class="enscript-string">'kernel_stack_size'</span>, 1).GetValueAtIndex(0).GetValueAsUnsigned()
            self.kernel_context_size = 0
            self.connected_over_kdp = False
            <span class="enscript-comment"># connected_to_debugserver signifies if we are connected to astris or other gdbserver instance
</span>            <span class="enscript-comment"># that has the correct thread state for on core threads. For kdp and coredumps we rely on in memory
</span>            <span class="enscript-comment"># state of threads.
</span>            self.connected_to_debugserver = True
            plugin_string = self.process.GetPluginName().lower()
            <span class="enscript-keyword">if</span> plugin_string.find(<span class="enscript-string">&quot;kdp&quot;</span>) &gt;=0:
                self.connected_over_kdp = True
                self.connected_to_debugserver = False
            <span class="enscript-comment">#print &quot;version&quot;, self.version, &quot;kernel_stack_size&quot;, self.kernel_stack_size, &quot;context_size&quot;, self.kernel_context_size
</span>            self.threads = None <span class="enscript-comment"># Will be an dictionary containing info for each thread
</span>            triple = self.process.target.triple
            arch = triple.split(<span class="enscript-string">'-'</span>)[0].lower()
            self.target_arch = <span class="enscript-string">&quot;&quot;</span>
            self.kernel_context_size = 0
            <span class="enscript-keyword">if</span> arch == archX86_64 :
                self.target_arch = archX86_64
                <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Target arch: x86_64&quot;</span>
                self.register_set = X86_64RegisterSet()
                self.kernel_context_size = self._target.FindFirstType(<span class="enscript-string">'x86_kernel_state'</span>).GetByteSize()
            <span class="enscript-keyword">elif</span> arch <span class="enscript-keyword">in</span> archARMv7_family :
                self.target_arch = arch
                <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Target arch: &quot;</span> + self.target_arch
                self.register_set = Armv7_RegisterSet()
            <span class="enscript-keyword">elif</span> arch == archARMv8:
                self.target_arch = arch
                <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Target arch: &quot;</span> + self.target_arch
                self.register_set = Armv8_RegisterSet()
            <span class="enscript-comment">#  connection     intel         arm
</span>            <span class="enscript-comment">#  kdp            Memory        Memory
</span>            <span class="enscript-comment">#  gdb            Server        Server
</span>            <span class="enscript-comment">#  coredump       Memory        Server
</span>            <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> self.connected_over_kdp :
                <span class="enscript-keyword">if</span> plugin_string.find(<span class="enscript-string">'core'</span>) &gt;= 0 <span class="enscript-keyword">and</span> self.target_arch == archX86_64:
                    self.connected_to_debugserver = False
            self.registers = self.register_set.register_info
            <span class="enscript-keyword">if</span> self.connected_to_debugserver:
                <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Connected to live debugserver or arm core. Will associate on-core threads to registers reported by server.&quot;</span>
            <span class="enscript-keyword">else</span>:
                <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Instantiating threads completely from saved state in memory.&quot;</span>

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">create_thread</span>(self, tid, context):
        <span class="enscript-comment"># if tid is deadbeef means its a custom thread which kernel does not know of.
</span>        <span class="enscript-keyword">if</span> tid == 0xdeadbeef :
            <span class="enscript-comment"># tid manipulation should be the same as in &quot;switchtoregs&quot; code in lldbmacros/process.py .
</span>            tid = 0xdead0000 | (context &amp; ~0xffff0000)
            tid = tid &amp; 0xdeadffff
            thread_obj = { <span class="enscript-string">'tid'</span>   : tid,
                           <span class="enscript-string">'ptr'</span>   : context,
                           <span class="enscript-string">'name'</span>  : <span class="enscript-string">'switchtoregs'</span> + hex(context),
                           <span class="enscript-string">'queue'</span> : <span class="enscript-string">'None'</span>,
                           <span class="enscript-string">'state'</span> : <span class="enscript-string">'stopped'</span>,
                           <span class="enscript-string">'stop_reason'</span> : <span class="enscript-string">'none'</span>
                         }
            self.thread_cache[tid] = thread_obj
            <span class="enscript-keyword">return</span> thread_obj
        
        th_ptr = context
        th = self.version.CreateValueFromExpression(str(th_ptr),<span class="enscript-string">'(struct thread *)'</span> + str(th_ptr))
        thread_id = th.GetChildMemberWithName(<span class="enscript-string">'thread_id'</span>).GetValueAsUnsigned()
        <span class="enscript-keyword">if</span> tid != thread_id:
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;FATAL ERROR: Creating thread from memory 0x%x with tid in mem=%d when requested tid = %d &quot;</span> % (context, thread_id, tid)
            <span class="enscript-keyword">return</span> None
        thread_obj = { <span class="enscript-string">'tid'</span>   : thread_id,
                       <span class="enscript-string">'ptr'</span>   : th.GetValueAsUnsigned(),
                       <span class="enscript-string">'name'</span>  : hex(th.GetValueAsUnsigned()).rstrip(<span class="enscript-string">'L'</span>),
                       <span class="enscript-string">'queue'</span> : hex(th.GetChildMemberWithName(<span class="enscript-string">'wait_queue'</span>).GetValueAsUnsigned()).rstrip(<span class="enscript-string">'L'</span>),
                       <span class="enscript-string">'state'</span> : <span class="enscript-string">'stopped'</span>,
                       <span class="enscript-string">'stop_reason'</span> : <span class="enscript-string">'none'</span>
                     }
        <span class="enscript-keyword">if</span> self.current_session_id != GetUniqueSessionID(self.process):
            self.thread_cache = {}
            self.current_session_id = GetUniqueSessionID(self.process)

        self.thread_cache[tid] = thread_obj
        <span class="enscript-keyword">return</span> thread_obj


    <span class="enscript-keyword">def</span> <span class="enscript-function-name">get_thread_info</span>(self):
        self.kdp_thread = None
        self.kdp_state = None
        <span class="enscript-keyword">if</span> self.connected_over_kdp :
            kdp = self._target.FindGlobalVariables(<span class="enscript-string">'kdp'</span>,1).GetValueAtIndex(0)
            kdp_state = kdp.GetChildMemberWithName(<span class="enscript-string">'saved_state'</span>)
            kdp_thread = kdp.GetChildMemberWithName(<span class="enscript-string">'kdp_thread'</span>)
            <span class="enscript-keyword">if</span> kdp_thread <span class="enscript-keyword">and</span> kdp_thread.GetValueAsUnsigned() != 0:
                self.kdp_thread = kdp_thread
                self.kdp_state = kdp_state
                kdp_thid = kdp_thread.GetChildMemberWithName(<span class="enscript-string">'thread_id'</span>).GetValueAsUnsigned()
                self.create_thread(kdp_thid, kdp_thread.GetValueAsUnsigned())
                self.thread_cache[kdp_thid][<span class="enscript-string">'core'</span>]=0
                retval = [self.thread_cache[kdp_thid]]
                <span class="enscript-keyword">return</span> retval
            <span class="enscript-keyword">else</span>:
                <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;FATAL FAILURE: Unable to find kdp_thread state for this connection.&quot;</span>
                <span class="enscript-keyword">return</span> []

        num_threads = self._target.FindGlobalVariables(<span class="enscript-string">'threads_count'</span>,1).GetValueAtIndex(0).GetValueAsUnsigned()
        <span class="enscript-comment">#In case we are caught before threads are initialized. Fallback to threads known by astris/gdb server.
</span>        <span class="enscript-keyword">if</span> num_threads &lt;=0 :
            <span class="enscript-keyword">return</span> []

        self.current_session_id = GetUniqueSessionID(self.process)
        self.threads = []
        self.thread_cache = {}
        self.processors = []
        <span class="enscript-keyword">try</span>:
            processor_list_val = PluginValue(self._target.FindGlobalVariables(<span class="enscript-string">'processor_list'</span>,1).GetValueAtIndex(0))
            <span class="enscript-keyword">while</span> processor_list_val.IsValid() <span class="enscript-keyword">and</span> processor_list_val.GetValueAsUnsigned() !=0 :
                th = processor_list_val.GetChildMemberWithName(<span class="enscript-string">'active_thread'</span>)
                th_id = th.GetChildMemberWithName(<span class="enscript-string">'thread_id'</span>).GetValueAsUnsigned()
                cpu_id = processor_list_val.GetChildMemberWithName(<span class="enscript-string">'cpu_id'</span>).GetValueAsUnsigned()
                self.processors.append({<span class="enscript-string">'active_thread'</span>: th.GetValueAsUnsigned(), <span class="enscript-string">'cpu_id'</span>: cpu_id})
                self.create_thread(th_id, th.GetValueAsUnsigned())
                <span class="enscript-keyword">if</span> self.connected_to_debugserver:
                    self.thread_cache[th_id][<span class="enscript-string">'core'</span>] = cpu_id
                self.thread_cache[th_id][<span class="enscript-string">'queue'</span>] = <span class="enscript-string">&quot;cpu-%d&quot;</span> % int(cpu_id)
                nth = self.thread_cache[th_id]
                self.threads.append(nth)
                self.thread_cache[nth[<span class="enscript-string">'tid'</span>]] = nth
                processor_list_val = processor_list_val.GetChildMemberWithName(<span class="enscript-string">'processor_list'</span>)
        <span class="enscript-keyword">except</span> KeyboardInterrupt, ke:
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;OS Plugin Interrupted during thread loading process. \nWARNING:Thread registers and backtraces may not be accurate.&quot;</span>
            <span class="enscript-keyword">return</span> self.threads

        <span class="enscript-keyword">if</span> hasattr(self.process, <span class="enscript-string">'CreateOSPluginThread'</span>):
            <span class="enscript-keyword">return</span> self.threads

        <span class="enscript-comment"># FIXME remove legacy code
</span>        <span class="enscript-keyword">try</span>:
            thread_q_head = self._target.FindGlobalVariables(<span class="enscript-string">'threads'</span>, 1).GetValueAtIndex(0)
            thread_type = self._target.FindFirstType(<span class="enscript-string">'thread'</span>)
            thread_ptr_type = thread_type.GetPointerType()
            <span class="enscript-keyword">for</span> th <span class="enscript-keyword">in</span> IterateQueue(thread_q_head, thread_ptr_type, <span class="enscript-string">'threads'</span>):
                th_id = th.GetChildMemberWithName(<span class="enscript-string">'thread_id'</span>).GetValueAsUnsigned()
                self.create_thread(th_id, th.GetValueAsUnsigned())
                nth = self.thread_cache[th_id]
                <span class="enscript-keyword">for</span> cputhread <span class="enscript-keyword">in</span> self.processors:
                    <span class="enscript-keyword">if</span> cputhread[<span class="enscript-string">'active_thread'</span>] == nth[<span class="enscript-string">'ptr'</span>]:
                        nth[<span class="enscript-string">'core'</span>] = cputhread[<span class="enscript-string">'cpu_id'</span>]
                self.threads.append( nth )
        <span class="enscript-keyword">except</span> KeyboardInterrupt, ke:
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;OS Plugin Interrupted during thread loading process. \nWARNING:Thread registers and backtraces may not be accurate.&quot;</span>
            <span class="enscript-keyword">return</span> self.threads
        <span class="enscript-comment"># end legacy code
</span>        <span class="enscript-keyword">return</span> self.threads

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">get_register_info</span>(self):
        <span class="enscript-keyword">if</span> self.registers == None:
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Register Information not found &quot;</span>
        <span class="enscript-keyword">return</span> self.register_set.register_info

    <span class="enscript-keyword">def</span> <span class="enscript-function-name">get_register_data</span>(self, tid):
        thobj = None
        <span class="enscript-keyword">try</span>:
            regs = self.register_set
            <span class="enscript-keyword">if</span> self.current_session_id != GetUniqueSessionID(self.process):
                self.thread_cache = {}
                self.current_session_id = GetUniqueSessionID(self.process)
            <span class="enscript-keyword">if</span> tid <span class="enscript-keyword">in</span> self.thread_cache.keys():
                
                <span class="enscript-comment">#Check if the thread is a fake one. Then create and return registers directly
</span>                <span class="enscript-keyword">if</span> self.thread_cache[tid][<span class="enscript-string">'name'</span>].find(<span class="enscript-string">'switchtoregs'</span>) == 0:
                    savedstateobj = self.version.CreateValueFromExpression(None, <span class="enscript-string">'(uintptr_t *) '</span> + str(self.thread_cache[tid][<span class="enscript-string">'ptr'</span>]))
                    regs.ReadRegisterDataFromKDPSavedState(savedstateobj, self.version)
                    <span class="enscript-keyword">return</span> regs.GetPackedRegisterState()

                thobj = self.version.CreateValueFromExpression(self.thread_cache[tid][<span class="enscript-string">'name'</span>], <span class="enscript-string">'(struct thread *)'</span> + str(self.thread_cache[tid][<span class="enscript-string">'ptr'</span>]))
            
            <span class="enscript-keyword">if</span> thobj == None :
                <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;FATAL ERROR: Could not find thread with id %d&quot;</span> % tid
                regs.ResetRegisterValues()
                <span class="enscript-keyword">return</span> regs.GetPackedRegisterState()

            <span class="enscript-keyword">if</span> self.kdp_thread <span class="enscript-keyword">and</span> self.kdp_thread.GetValueAsUnsigned() == thobj.GetValueAsUnsigned():
                regs.ReadRegisterDataFromKDPSavedState(self.kdp_state, self.version)
                <span class="enscript-keyword">return</span> regs.GetPackedRegisterState()
            <span class="enscript-keyword">if</span> int(PluginValue(thobj).GetChildMemberWithName(<span class="enscript-string">'kernel_stack'</span>).GetValueAsUnsigned()) != 0 :
                <span class="enscript-keyword">if</span> self.target_arch == archX86_64 :
                    <span class="enscript-comment"># we do have a stack so lets get register information
</span>                    saved_state_addr = PluginValue(thobj).GetChildMemberWithName(<span class="enscript-string">'kernel_stack'</span>).GetValueAsUnsigned() + self.kernel_stack_size - self.kernel_context_size
                    regs.ReadRegisterDataFromKernelStack(saved_state_addr, self.version)
                    <span class="enscript-keyword">return</span> regs.GetPackedRegisterState()
                <span class="enscript-keyword">elif</span> self.target_arch <span class="enscript-keyword">in</span> archARMv7_family <span class="enscript-keyword">and</span> int(PluginValue(thobj).GetChildMemberWithName(<span class="enscript-string">'machine'</span>).GetChildMemberWithName(<span class="enscript-string">'kstackptr'</span>).GetValueAsUnsigned()) != 0:
                    <span class="enscript-comment">#we have stack on the machine.kstackptr.
</span>                    saved_state_addr = PluginValue(thobj).GetChildMemberWithName(<span class="enscript-string">'machine'</span>).GetChildMemberWithName(<span class="enscript-string">'kstackptr'</span>).GetValueAsUnsigned()
                    regs.ReadRegisterDataFromKernelStack(saved_state_addr, self.version)
                    <span class="enscript-keyword">return</span> regs.GetPackedRegisterState()
                <span class="enscript-keyword">elif</span> self.target_arch == archARMv8 <span class="enscript-keyword">and</span> int(PluginValue(thobj).GetChildMemberWithName(<span class="enscript-string">'machine'</span>).GetChildMemberWithName(<span class="enscript-string">'kstackptr'</span>).GetValueAsUnsigned()) != 0:
                    saved_state_addr = PluginValue(thobj).GetChildMemberWithName(<span class="enscript-string">'machine'</span>).GetChildMemberWithName(<span class="enscript-string">'kstackptr'</span>).GetValueAsUnsigned()
                    arm_ctx = PluginValue(self.version.CreateValueFromExpression(None, <span class="enscript-string">'(struct arm_context *) '</span> + str(saved_state_addr)))
                    ss_64_addr = arm_ctx.GetChildMemberWithName(<span class="enscript-string">'ss'</span>).GetChildMemberWithName(<span class="enscript-string">'uss'</span>).GetChildMemberWithName(<span class="enscript-string">'ss_64'</span>).GetLoadAddress()
                    regs.ReadRegisterDataFromKernelStack(ss_64_addr, self.version)
                    <span class="enscript-keyword">return</span> regs.GetPackedRegisterState()
            <span class="enscript-keyword">elif</span> self.target_arch == archX86_64 <span class="enscript-keyword">or</span> self.target_arch <span class="enscript-keyword">in</span> archARMv7_family <span class="enscript-keyword">or</span> self.target_arch == archARMv8:
                regs.ReadRegisterDataFromContinuation( PluginValue(thobj).GetChildMemberWithName(<span class="enscript-string">'continuation'</span>).GetValueAsUnsigned())
                <span class="enscript-keyword">return</span> regs.GetPackedRegisterState()
            <span class="enscript-comment">#incase we failed very miserably
</span>        <span class="enscript-keyword">except</span> KeyboardInterrupt, ke:
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;OS Plugin Interrupted during thread register load. \nWARNING:Thread registers and backtraces may not be accurate. for tid = %d&quot;</span> % tid
        regs.ResetRegisterValues()
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;FATAL ERROR: Failed to get register state for thread id 0x%x &quot;</span> % tid
        <span class="enscript-keyword">print</span> thobj
        <span class="enscript-keyword">return</span> regs.GetPackedRegisterState()

</pre>
<hr />
</body></html>