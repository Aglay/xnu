<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>structanalyze.py</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">structanalyze.py&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-keyword">import</span> lldb
<span class="enscript-keyword">from</span> xnu <span class="enscript-keyword">import</span> *

<span class="enscript-keyword">def</span> <span class="enscript-function-name">_showStructPacking</span>(symbol, prefix, begin_offset=0):
  <span class="enscript-string">&quot;&quot;&quot;
     recursively parse the field members of structure. 
     params : symbol (lldb.SBType) reference to symbol in binary
              prefix (string)      string to be prefixed for each line of output. Useful for recursive struct parsing.
     returns: string containing lines of output.
  &quot;&quot;&quot;</span>
  ctype = <span class="enscript-string">&quot;unknown type&quot;</span>
  <span class="enscript-keyword">if</span> symbol.GetTypeClass() == lldb.eTypeClassUnion :
    ctype = <span class="enscript-string">&quot;union&quot;</span>
  <span class="enscript-keyword">if</span> symbol.GetTypeClass() == lldb.eTypeClassStruct :
    ctype = <span class="enscript-string">&quot;struct&quot;</span>
  outstr =  <span class="enscript-string">&quot;[%4d] (%s) %s { &quot;</span> % (symbol.GetByteSize(), ctype, symbol.GetName()) + <span class="enscript-string">&quot;\n&quot;</span>
  numFields = symbol.GetNumberOfFields()
  _has_memory_hole = False
  _compact_size = 0    <span class="enscript-comment"># asuming the struct is perfectly packed
</span>  _compact_offset = begin_offset
  _previous_bit_offset = 0 
  <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> range(numFields):
    member = symbol.GetFieldAtIndex(i)
    m_offset = member.GetOffsetInBytes() + begin_offset
    m_offset_bits = member.GetOffsetInBits()
    m_type = member.GetType()
    m_name = member.GetName()
    m_size = m_type.GetByteSize()
    warningstr = <span class="enscript-string">&quot;&quot;</span>
    debugstr = <span class="enscript-string">&quot;&quot;</span> <span class="enscript-comment"># + str((m_size, m_offset , m_offset_bits, _previous_bit_offset, _compact_offset, begin_offset))
</span>    <span class="enscript-keyword">if</span> _compact_offset != m_offset <span class="enscript-keyword">and</span> (m_offset_bits -  _previous_bit_offset) &gt; m_size*8 :
      _has_memory_hole = True
      warningstr = <span class="enscript-string">&quot;   *** Possible memory hole ***&quot;</span> 
      _compact_offset = m_offset
    _compact_offset += m_size
    <span class="enscript-keyword">if</span> m_type.GetTypeClass() == lldb.eTypeClassStruct <span class="enscript-keyword">or</span> m_type.GetTypeClass() == lldb.eTypeClassUnion :
      outstr += prefix + (<span class="enscript-string">&quot;*%4d,&quot;</span> % m_offset) + _showStructPacking(m_type, prefix+<span class="enscript-string">&quot;    &quot;</span>, m_offset) + warningstr + debugstr + <span class="enscript-string">&quot;\n&quot;</span>
    <span class="enscript-keyword">else</span>:
      outstr += prefix + (<span class="enscript-string">&quot;+%4d,[%4d] (%s) %s&quot;</span> % (m_offset, m_size, m_type.GetName(), m_name)) + warningstr + debugstr + <span class="enscript-string">&quot;\n&quot;</span>
    <span class="enscript-keyword">if</span> i &gt; 0 :
      _previous_bit_offset = m_offset_bits
  outstr += prefix + <span class="enscript-string">&quot;}&quot;</span>
  <span class="enscript-keyword">if</span> _has_memory_hole == True :
    outstr += <span class="enscript-string">&quot;   *** Warning: Struct layout leaves memory hole *** &quot;</span>
  <span class="enscript-keyword">return</span> outstr

@lldb_command(<span class="enscript-string">'showstructpacking'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">showStructInfo</span>(cmd_args=None):
  <span class="enscript-string">&quot;&quot;&quot;Show how a structure is packed in the binary. The format is 
     +&lt;offset&gt;, [&lt;size_of_member&gt;] (&lt;type&gt;) &lt;name&gt; 
     For example:
      (lldb) script lldbmacros.showStructInfo(&quot;pollfd&quot;)
      [  8] (struct) pollfd { 
      +  0,[  4] (int) fd
      +  4,[  2] (short) events
      +  6,[  2] (short) revents
      }
    syntax: showstructpacking task
  &quot;&quot;&quot;</span>
  <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> cmd_args:
    <span class="enscript-keyword">raise</span> ArgumentError(<span class="enscript-string">&quot;Please provide a type name.&quot;</span>)
  
  sym = gettype(cmd_args[0])
  <span class="enscript-keyword">if</span> sym == None:
    <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;No such struct found&quot;</span>
  <span class="enscript-keyword">if</span> sym.GetTypeClass() == lldb.eTypeClassTypedef:
      sym = sym.GetCanonicalType()
  <span class="enscript-keyword">if</span> sym.GetTypeClass() != lldb.eTypeClassStruct:
    <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;%s is not a structure&quot;</span> % cmd_args[0]
  <span class="enscript-keyword">else</span>:
    <span class="enscript-keyword">print</span> _showStructPacking(sym,<span class="enscript-string">&quot;&quot;</span>, 0)

<span class="enscript-comment"># EndMacro: showstructinto
</span></pre>
<hr />
</body></html>