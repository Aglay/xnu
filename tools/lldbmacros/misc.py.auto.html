<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>misc.py</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">misc.py&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-string">&quot;&quot;&quot;
Miscellaneous (Intel) platform-specific commands.
&quot;&quot;&quot;</span>

<span class="enscript-keyword">from</span> xnu <span class="enscript-keyword">import</span> *
<span class="enscript-keyword">import</span> xnudefines

@lldb_command(<span class="enscript-string">'showmcastate'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">showMCAstate</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot;
    Print machine-check register state after MC exception.
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> kern.arch != <span class="enscript-string">'x86_64'</span>:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Not available for current architecture.&quot;</span>
        <span class="enscript-keyword">return</span>

    present = [<span class="enscript-string">&quot;not present&quot;</span>, <span class="enscript-string">&quot;present&quot;</span>]
    <span class="enscript-keyword">print</span> <span class="enscript-string">'MCA {:s}, control MSR {:s}, threshold status {:s}'</span>.format(
    present[int(kern.globals.mca_MCA_present)],
    present[int(kern.globals.mca_control_MSR_present)],
    present[int(kern.globals.mca_threshold_status_present)])
    <span class="enscript-keyword">print</span> <span class="enscript-string">'{:d} error banks, family code {:#0x}, machine-check dump state: {:d}'</span>.format(
        kern.globals.mca_error_bank_count,
        kern.globals.mca_dump_state,
        kern.globals.mca_family)
    cpu = 0
    <span class="enscript-keyword">while</span> kern.globals.cpu_data_ptr[cpu]:
        cd = kern.globals.cpu_data_ptr[cpu]
        mc = cd.cpu_mca_state
        <span class="enscript-keyword">if</span> mc:
            <span class="enscript-keyword">print</span> <span class="enscript-string">'CPU {:d}: mca_mcg_ctl: {:#018x} mca_mcg_status {:#018x}'</span>.format(cpu, mc.mca_mcg_ctl, mc.mca_mcg_status.u64)
            hdr = <span class="enscript-string">'{:&lt;4s} {:&lt;18s} {:&lt;18s} {:&lt;18s} {:&lt;18s}'</span>
            val = <span class="enscript-string">'{:&gt;3d}: {:#018x} {:#018x} {:#018x} {:#018x}'</span>
            <span class="enscript-keyword">print</span> hdr.format(<span class="enscript-string">'bank'</span>,
                    <span class="enscript-string">'mca_mci_ctl'</span>,
                    <span class="enscript-string">'mca_mci_status'</span>,
                    <span class="enscript-string">'mca_mci_addr'</span>,
                    <span class="enscript-string">'mca_mci_misc'</span>)
            <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> range(int(kern.globals.mca_error_bank_count)):
                bank = mc.mca_error_bank[i]
                <span class="enscript-keyword">print</span> val.format(i,
                    bank.mca_mci_ctl,
                    bank.mca_mci_status.u64,
                    bank.mca_mci_addr,     
                    bank.mca_mci_misc)     
        <span class="enscript-keyword">print</span> <span class="enscript-string">'register state:'</span>
        reg = cd.cpu_desc_index.cdi_ktss.ist1 - sizeof(<span class="enscript-string">'x86_saved_state_t'</span>)
        <span class="enscript-keyword">print</span> lldb_run_command(<span class="enscript-string">'p/x *(x86_saved_state_t *) '</span> + hex(reg))
        cpu = cpu + 1

<span class="enscript-keyword">def</span> <span class="enscript-function-name">dumpTimerList</span>(anchor):
    <span class="enscript-string">&quot;&quot;&quot;
    Utility function to dump the timer entries in list (anchor).
    &quot;&quot;&quot;</span>
    entry = Cast(anchor.head, <span class="enscript-string">'queue_t'</span>)
    <span class="enscript-keyword">if</span> entry == addressof(anchor):
        <span class="enscript-keyword">print</span> <span class="enscript-string">'(empty)'</span>
        <span class="enscript-keyword">return</span>

    thdr = <span class="enscript-string">' {:&lt;22s}{:&lt;17s}{:&lt;16s} {:&lt;14s} {:&lt;18s}'</span>
    <span class="enscript-keyword">print</span> thdr.format(<span class="enscript-string">'entry:'</span>,<span class="enscript-string">'deadline'</span>,<span class="enscript-string">'soft_deadline'</span>,<span class="enscript-string">'to go'</span>,<span class="enscript-string">'(*func)(param0,param1'</span>)
    <span class="enscript-keyword">while</span> entry != addressof(anchor):
        timer_call = Cast(entry, <span class="enscript-string">'timer_call_t'</span>)
        call_entry = Cast(entry, <span class="enscript-string">'struct call_entry *'</span>)
        debugger_entry = kern.globals.debugger_entry_time
        <span class="enscript-keyword">if</span> (debugger_entry &lt; call_entry.deadline):
            delta_sign = <span class="enscript-string">' '</span>
            timer_fire = call_entry.deadline - debugger_entry
        <span class="enscript-keyword">else</span>:
            delta_sign = <span class="enscript-string">'-'</span>
            timer_fire = debugger_entry - call_entry.deadline
        tval = <span class="enscript-string">' {:#018x}: {:16d} {:16d} {:s}{:3d}.{:09d}  ({:#018x})({:#018x},{:#018x})'</span>
        <span class="enscript-keyword">print</span> tval.format(entry,
            call_entry.deadline,
            timer_call.soft_deadline,
            delta_sign,
            timer_fire/1000000000,
            timer_fire%1000000000,
            call_entry.func,
            call_entry.param0,
            call_entry.param1)
        entry = entry.next

@lldb_command(<span class="enscript-string">'longtermtimers'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">longtermTimers</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot;
    Print details of long-term timers and stats.
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> kern.arch != <span class="enscript-string">'x86_64'</span>:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Not available for current architecture.&quot;</span>
        <span class="enscript-keyword">return</span>

    lt = kern.globals.timer_longterm
    ltt = lt.threshold
    EndofAllTime = -1
    <span class="enscript-keyword">if</span> ltt.interval == EndofAllTime:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Longterm timers disabled&quot;</span>
        <span class="enscript-keyword">return</span>

    <span class="enscript-keyword">if</span> lt.escalates &gt; 0:
        ratio = lt.enqueues / lt.escalates
    <span class="enscript-keyword">else</span>:
        ratio = lt.enqueues
    <span class="enscript-keyword">print</span>     <span class="enscript-string">'Longterm timer object: {:#018x}'</span>.format(addressof(lt))
    <span class="enscript-keyword">print</span>     <span class="enscript-string">' queue count         : {:d}'</span>    .format(lt.queue.count)
    <span class="enscript-keyword">print</span>     <span class="enscript-string">' number of enqueues  : {:d}'</span>    .format(lt.enqueues)
    <span class="enscript-keyword">print</span>     <span class="enscript-string">' number of dequeues  : {:d}'</span>    .format(lt.dequeues)
    <span class="enscript-keyword">print</span>     <span class="enscript-string">' number of escalates : {:d}'</span>    .format(lt.escalates)
    <span class="enscript-keyword">print</span>     <span class="enscript-string">' enqueues/escalates  : {:d}'</span>    .format(ratio)
    <span class="enscript-keyword">print</span>     <span class="enscript-string">' threshold.interval  : {:d}'</span>    .format(ltt.interval)
    <span class="enscript-keyword">print</span>     <span class="enscript-string">' threshold.margin    : {:d}'</span>    .format(ltt.margin)
    <span class="enscript-keyword">print</span>     <span class="enscript-string">' scan_time           : {:d}'</span>    .format(lt.scan_time)
    <span class="enscript-keyword">if</span> ltt.preempted == EndofAllTime:
        <span class="enscript-keyword">print</span> <span class="enscript-string">' threshold.preempted : None'</span>
    <span class="enscript-keyword">else</span>:
        <span class="enscript-keyword">print</span> <span class="enscript-string">' threshold.preempted : {:d}'</span>    .format(ltt.preempted)
    <span class="enscript-keyword">if</span> ltt.deadline == EndofAllTime:
        <span class="enscript-keyword">print</span> <span class="enscript-string">' threshold.deadline  : None'</span>
    <span class="enscript-keyword">else</span>:
        <span class="enscript-keyword">print</span> <span class="enscript-string">' threshold.deadline  : {:d}'</span>    .format(ltt.deadline)
        <span class="enscript-keyword">print</span> <span class="enscript-string">' threshold.call      : {:#018x}'</span>.format(ltt.call)
        <span class="enscript-keyword">print</span> <span class="enscript-string">' actual deadline set : {:d}'</span>    .format(ltt.deadline_set)
    <span class="enscript-keyword">print</span>     <span class="enscript-string">' threshold.scans     : {:d}'</span>    .format(ltt.scans)
    <span class="enscript-keyword">print</span>     <span class="enscript-string">' threshold.preempts  : {:d}'</span>    .format(ltt.preempts)
    <span class="enscript-keyword">print</span>     <span class="enscript-string">' threshold.latency   : {:d}'</span>    .format(ltt.latency)
    <span class="enscript-keyword">print</span>     <span class="enscript-string">'               - min : {:d}'</span>    .format(ltt.latency_min)
    <span class="enscript-keyword">print</span>     <span class="enscript-string">'               - max : {:d}'</span>    .format(ltt.latency_max)
    dumpTimerList(lt.queue)


@lldb_command(<span class="enscript-string">'processortimers'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">processorTimers</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot;
    Print details of processor timers, noting anything suspicious
    Also include long-term timer details
    &quot;&quot;&quot;</span>
    hdr = <span class="enscript-string">'{:&lt;32s}{:&lt;18s} {:&lt;18s} {:&lt;18s}'</span>
    <span class="enscript-keyword">print</span> hdr.format(<span class="enscript-string">'Processor'</span>,<span class="enscript-string">'Last dispatch'</span>,<span class="enscript-string">'Next deadline'</span>,<span class="enscript-string">'difference'</span>)
    p = kern.globals.processor_list
    <span class="enscript-keyword">while</span> p:
        cpu = p.cpu_id
        rt_timer = kern.globals.cpu_data_ptr[cpu].rtclock_timer
        diff = p.last_dispatch - rt_timer.deadline
        tmr = <span class="enscript-string">'Processor {:d}: {:#018x} {:#018x} {:#018x} {:#018x} {:s}'</span>
        <span class="enscript-keyword">print</span> tmr.format(cpu,
            p,
            p.last_dispatch,
            rt_timer.deadline,
            diff,
            [<span class="enscript-string">'probably BAD'</span>, <span class="enscript-string">'(ok)'</span>][int(diff &lt; 0)])
        <span class="enscript-keyword">if</span> kern.arch == <span class="enscript-string">'x86_64'</span>:
            <span class="enscript-keyword">print</span> <span class="enscript-string">'Next deadline set at: {:#018x}. Timer call list:'</span>.format(rt_timer.when_set)
            dumpTimerList(rt_timer.queue)
        p = p.processor_list
    longtermTimers()


@lldb_command(<span class="enscript-string">'showtimerwakeupstats'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">showTimerWakeupStats</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot;
    Displays interrupt and platform idle wakeup frequencies
    associated with each thread, timer time-to-deadline frequencies, and
    CPU time with user/system break down where applicable, with thread tags.
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">for</span> task <span class="enscript-keyword">in</span> kern.tasks:
        proc = Cast(task.bsd_info, <span class="enscript-string">'proc_t'</span>)
        <span class="enscript-keyword">print</span> dereference(task)
        <span class="enscript-keyword">print</span> <span class="enscript-string">'{:d}({:s}), terminated thread timer wakeups: {:d} {:d} 2ms: {:d} 5ms: {:d} UT: {:d} ST: {:d}'</span>.format(
            proc.p_pid,
            proc.p_comm,
<span class="enscript-comment"># Commented-out references below to be addressed by rdar://13009660.
</span>            0, <span class="enscript-comment">#task.task_interrupt_wakeups,
</span>            0, <span class="enscript-comment">#task.task_platform_idle_wakeups,
</span>            task.task_timer_wakeups_bin_1,
            task.task_timer_wakeups_bin_2,
            task.total_user_time,
            task.total_system_time)
        tot_wakes = 0 <span class="enscript-comment">#task.task_interrupt_wakeups
</span>        tot_platform_wakes = 0 <span class="enscript-comment">#task.task_platform_idle_wakeups
</span>        <span class="enscript-keyword">for</span> thread <span class="enscript-keyword">in</span> IterateQueue(task.threads, <span class="enscript-string">'thread_t'</span>, <span class="enscript-string">'task_threads'</span>):
<span class="enscript-comment">#           if thread.thread_interrupt_wakeups == 0:
</span><span class="enscript-comment">#               continue
</span>            <span class="enscript-keyword">print</span> <span class="enscript-string">'\tThread ID 0x{:x}, Tag 0x{:x}, timer wakeups: {:d} {:d} {:d} {:d} &lt;2ms: {:d}, &lt;5ms: {:d} UT: {:d} ST: {:d}'</span>.format(
                thread.thread_id,
                thread.thread_tag,
                0, <span class="enscript-comment">#thread.thread_interrupt_wakeups,
</span>                0, <span class="enscript-comment">#thread.thread_platform_idle_wakeups,
</span>                0, <span class="enscript-comment">#thread.thread_callout_interrupt_wakeups,
</span>                0, <span class="enscript-comment">#thread.thread_callout_platform_idle_wakeups,
</span>                0,0,0,0,
                thread.thread_timer_wakeups_bin_1,
                thread.thread_timer_wakeups_bin_2,
                thread.user_timer.all_bits,
                thread.system_timer.all_bits)
            tot_wakes += 0 <span class="enscript-comment">#thread.thread_interrupt_wakeups
</span>            tot_platform_wakes += 0 <span class="enscript-comment">#thread.thread_platform_idle_wakeups
</span>        <span class="enscript-keyword">print</span> <span class="enscript-string">'Task total wakeups: {:d} {:d}'</span>.format(
            tot_wakes, tot_platform_wakes)

<span class="enscript-keyword">def</span> <span class="enscript-function-name">DoReadMsr64</span>(msr_address, lcpu):
    <span class="enscript-string">&quot;&quot;&quot; Read a 64-bit MSR from the specified CPU
        Params:
            msr_address: int - MSR index to read from
            lcpu: int - CPU identifier
        Returns:
            64-bit value read from the MSR
    &quot;&quot;&quot;</span>
    result = 0xbad10ad

    <span class="enscript-keyword">if</span> <span class="enscript-string">&quot;kdp&quot;</span> != GetConnectionProtocol():
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Target is not connected over kdp. Cannot read MSR.&quot;</span>
        <span class="enscript-keyword">return</span> result

    input_address = unsigned(addressof(kern.globals.manual_pkt.input))
    len_address = unsigned(addressof(kern.globals.manual_pkt.len))
    data_address = unsigned(addressof(kern.globals.manual_pkt.data))
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt32ToMemoryAddress(0, input_address):
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;DoReadMsr64() failed to write 0 to input_address&quot;</span>
        <span class="enscript-keyword">return</span> result
    
    kdp_pkt_size = GetType(<span class="enscript-string">'kdp_readmsr64_req_t'</span>).GetByteSize()
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt32ToMemoryAddress(kdp_pkt_size, len_address):
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;DoReadMsr64() failed to write kdp_pkt_size&quot;</span>
        <span class="enscript-keyword">return</span> result
    
    kgm_pkt = kern.GetValueFromAddress(data_address, <span class="enscript-string">'kdp_readmsr64_req_t *'</span>)
    header_value = GetKDPPacketHeaderInt(
        request=GetEnumValue(<span class="enscript-string">'kdp_req_t::KDP_READMSR64'</span>),
        length=kdp_pkt_size)

    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt64ToMemoryAddress(header_value, int(addressof(kgm_pkt.hdr))):
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;DoReadMsr64() failed to write header_value&quot;</span>
        <span class="enscript-keyword">return</span> result
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt32ToMemoryAddress(msr_address, int(addressof(kgm_pkt.address))):
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;DoReadMsr64() failed to write msr_address&quot;</span>
        <span class="enscript-keyword">return</span> result
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt16ToMemoryAddress(lcpu, int(addressof(kgm_pkt.lcpu))):
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;DoReadMsr64() failed to write lcpu&quot;</span>
        <span class="enscript-keyword">return</span> result
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt32ToMemoryAddress(1, input_address):
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;DoReadMsr64() failed to write to input_address&quot;</span>
        <span class="enscript-keyword">return</span> result

    result_pkt = Cast(addressof(kern.globals.manual_pkt.data),
        <span class="enscript-string">'kdp_readmsr64_reply_t *'</span>)
    <span class="enscript-keyword">if</span> (result_pkt.error == 0):
        result = dereference(Cast(addressof(result_pkt.data), <span class="enscript-string">'uint64_t *'</span>))
    <span class="enscript-keyword">else</span>:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;DoReadMsr64() result_pkt.error != 0&quot;</span>
    <span class="enscript-keyword">return</span> result

<span class="enscript-keyword">def</span> <span class="enscript-function-name">DoWriteMsr64</span>(msr_address, lcpu, data):
    <span class="enscript-string">&quot;&quot;&quot; Write a 64-bit MSR
        Params: 
            msr_address: int - MSR index to write to
            lcpu: int - CPU identifier
            data: int - value to write
        Returns:
            True upon success, False if error
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-string">&quot;kdp&quot;</span> != GetConnectionProtocol():
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Target is not connected over kdp. Cannot write MSR.&quot;</span>
        <span class="enscript-keyword">return</span> False

    input_address = unsigned(addressof(kern.globals.manual_pkt.input))
    len_address = unsigned(addressof(kern.globals.manual_pkt.len))
    data_address = unsigned(addressof(kern.globals.manual_pkt.data))
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt32ToMemoryAddress(0, input_address):
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;DoWriteMsr64() failed to write 0 to input_address&quot;</span>
        <span class="enscript-keyword">return</span> False
    
    kdp_pkt_size = GetType(<span class="enscript-string">'kdp_writemsr64_req_t'</span>).GetByteSize()
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt32ToMemoryAddress(kdp_pkt_size, len_address):
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;DoWriteMsr64() failed to kdp_pkt_size&quot;</span>
        <span class="enscript-keyword">return</span> False
    
    kgm_pkt = kern.GetValueFromAddress(data_address, <span class="enscript-string">'kdp_writemsr64_req_t *'</span>)
    header_value = GetKDPPacketHeaderInt(
        request=GetEnumValue(<span class="enscript-string">'kdp_req_t::KDP_WRITEMSR64'</span>),
        length=kdp_pkt_size)
    
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt64ToMemoryAddress(header_value, int(addressof(kgm_pkt.hdr))):
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;DoWriteMsr64() failed to write header_value&quot;</span>
        <span class="enscript-keyword">return</span> False
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt32ToMemoryAddress(msr_address, int(addressof(kgm_pkt.address))):
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;DoWriteMsr64() failed to write msr_address&quot;</span>
        <span class="enscript-keyword">return</span> False
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt16ToMemoryAddress(lcpu, int(addressof(kgm_pkt.lcpu))):
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;DoWriteMsr64() failed to write lcpu&quot;</span>
        <span class="enscript-keyword">return</span> False
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt64ToMemoryAddress(data, int(addressof(kgm_pkt.data))):
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;DoWriteMsr64() failed to write data&quot;</span>
        <span class="enscript-keyword">return</span> False
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> WriteInt32ToMemoryAddress(1, input_address):
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;DoWriteMsr64() failed to write to input_address&quot;</span>
        <span class="enscript-keyword">return</span> False

    result_pkt = Cast(addressof(kern.globals.manual_pkt.data),
        <span class="enscript-string">'kdp_writemsr64_reply_t *'</span>)
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> result_pkt.error == 0:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;DoWriteMsr64() error received in reply packet&quot;</span>
        <span class="enscript-keyword">return</span> False
    
    <span class="enscript-keyword">return</span> True

@lldb_command(<span class="enscript-string">'readmsr64'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">ReadMsr64</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Read the specified MSR. The CPU can be optionally specified
        Syntax: readmsr64 &lt;msr&gt; [lcpu]
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> cmd_args == None <span class="enscript-keyword">or</span> len(cmd_args) &lt; 1:
        <span class="enscript-keyword">print</span> ReadMsr64.__doc__
        <span class="enscript-keyword">return</span>
    
    msr_address = ArgumentStringToInt(cmd_args[0])
    <span class="enscript-keyword">if</span> len(cmd_args) &gt; 1:
        lcpu = ArgumentStringToInt(cmd_args[1])
    <span class="enscript-keyword">else</span>:
        lcpu = int(xnudefines.lcpu_self)

    msr_value = DoReadMsr64(msr_address, lcpu)
    <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;MSR[{:x}]: {:#016x}&quot;</span>.format(msr_address, msr_value)

@lldb_command(<span class="enscript-string">'writemsr64'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">WriteMsr64</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Write the specified MSR. The CPU can be optionally specified
        Syntax: writemsr64 &lt;msr&gt; &lt;value&gt; [lcpu]
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> cmd_args == None <span class="enscript-keyword">or</span> len(cmd_args) &lt; 2:
        <span class="enscript-keyword">print</span> WriteMsr64.__doc__
        <span class="enscript-keyword">return</span>
    msr_address = ArgumentStringToInt(cmd_args[0])
    write_val = ArgumentStringToInt(cmd_args[1])
    <span class="enscript-keyword">if</span> len(cmd_args) &gt; 2:
        lcpu = ArgumentStringToInt(cmd_args[2])
    <span class="enscript-keyword">else</span>:
        lcpu = xnudefines.lcpu_self

    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> DoWriteMsr64(msr_address, lcpu, write_val):
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;writemsr64 FAILED&quot;</span>

<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetEVFlags</span>(debug_arg):
    <span class="enscript-string">&quot;&quot;&quot; Return the EV Flags for the given kernel debug arg value
        params:
            debug_arg - value from arg member of kernel debug buffer entry
        returns: 
            str - string representing the EV Flag for given input arg value
    &quot;&quot;&quot;</span>
    out_str = <span class="enscript-string">&quot;&quot;</span>
    <span class="enscript-keyword">if</span> debug_arg &amp; 1:
        out_str += <span class="enscript-string">&quot;EV_RE &quot;</span>
    <span class="enscript-keyword">if</span> debug_arg &amp; 2:
        out_str += <span class="enscript-string">&quot;EV_WR &quot;</span>
    <span class="enscript-keyword">if</span> debug_arg &amp; 4:
        out_str += <span class="enscript-string">&quot;EV_EX &quot;</span>
    <span class="enscript-keyword">if</span> debug_arg &amp; 8:
        out_str += <span class="enscript-string">&quot;EV_RM &quot;</span>
    <span class="enscript-keyword">if</span> debug_arg &amp; 0x00100:
        out_str += <span class="enscript-string">&quot;EV_RBYTES &quot;</span>
    <span class="enscript-keyword">if</span> debug_arg &amp; 0x00200:
        out_str += <span class="enscript-string">&quot;EV_WBYTES &quot;</span>
    <span class="enscript-keyword">if</span> debug_arg &amp; 0x00400:
        out_str += <span class="enscript-string">&quot;EV_RCLOSED &quot;</span>
    <span class="enscript-keyword">if</span> debug_arg &amp; 0x00800:
        out_str += <span class="enscript-string">&quot;EV_RCONN &quot;</span>
    <span class="enscript-keyword">if</span> debug_arg &amp; 0x01000:
        out_str += <span class="enscript-string">&quot;EV_WCLOSED &quot;</span>
    <span class="enscript-keyword">if</span> debug_arg &amp; 0x02000:
        out_str += <span class="enscript-string">&quot;EV_WCONN &quot;</span>
    <span class="enscript-keyword">if</span> debug_arg &amp; 0x04000:
        out_str += <span class="enscript-string">&quot;EV_OOB &quot;</span>
    <span class="enscript-keyword">if</span> debug_arg &amp; 0x08000:
        out_str += <span class="enscript-string">&quot;EV_FIN &quot;</span>
    <span class="enscript-keyword">if</span> debug_arg &amp; 0x10000:
        out_str += <span class="enscript-string">&quot;EV_RESET &quot;</span>
    <span class="enscript-keyword">if</span> debug_arg &amp; 0x20000:
        out_str += <span class="enscript-string">&quot;EV_TIMEOUT &quot;</span>
    
    <span class="enscript-keyword">return</span> out_str

<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetKernelDebugBufferEntry</span>(kdbg_entry):
    <span class="enscript-string">&quot;&quot;&quot; Extract the information from given kernel debug buffer entry and return the summary
        params:
            kdebug_entry - kd_buf - address of kernel debug buffer entry
        returns: 
            str - formatted output information of kd_buf entry
    &quot;&quot;&quot;</span>
    out_str = <span class="enscript-string">&quot;&quot;</span>
    code_info_str = <span class="enscript-string">&quot;&quot;</span>
    kdebug_entry = kern.GetValueFromAddress(kdbg_entry, <span class="enscript-string">'kd_buf *'</span>)
    debugid     = kdebug_entry.debugid
    kdebug_arg1 = kdebug_entry.arg1
    kdebug_arg2 = kdebug_entry.arg2
    kdebug_arg3 = kdebug_entry.arg3
    kdebug_arg4 = kdebug_entry.arg4
    
    <span class="enscript-keyword">if</span> kern.arch <span class="enscript-keyword">in</span> (<span class="enscript-string">'x86_64'</span>, <span class="enscript-string">'arm64'</span>):
        kdebug_cpu   = kdebug_entry.cpuid
        ts_hi        = (kdebug_entry.timestamp &gt;&gt; 32) &amp; 0xFFFFFFFF
        ts_lo        = kdebug_entry.timestamp &amp; 0xFFFFFFFF
    <span class="enscript-keyword">else</span>:
        kdebug_cpu   = (kdebug_entry.timestamp &gt;&gt; 56)
        ts_hi        = (kdebug_entry.timestamp &gt;&gt; 32) &amp; 0x00FFFFFF
        ts_lo        = kdebug_entry.timestamp &amp; 0xFFFFFFFF
    
    kdebug_class    = (debugid &gt;&gt; 24) &amp; 0x000FF
    kdebug_subclass = (debugid &gt;&gt; 16) &amp; 0x000FF
    kdebug_code     = (debugid &gt;&gt;  2) &amp; 0x03FFF
    kdebug_qual     = (debugid) &amp; 0x00003
    
    <span class="enscript-keyword">if</span> kdebug_qual == 0:
        kdebug_qual = <span class="enscript-string">'-'</span>
    <span class="enscript-keyword">elif</span> kdebug_qual == 1:
        kdebug_qual = <span class="enscript-string">'S'</span>
    <span class="enscript-keyword">elif</span> kdebug_qual == 2:
        kdebug_qual = <span class="enscript-string">'E'</span>
    <span class="enscript-keyword">elif</span> kdebug_qual == 3:
        kdebug_qual = <span class="enscript-string">'?'</span>

    <span class="enscript-comment"># preamble and qual
</span>    out_str += <span class="enscript-string">&quot;{:&lt;#20x} {:&gt;6d} {:&gt;#12x} &quot;</span>.format(kdebug_entry, kdebug_cpu, kdebug_entry.arg5)
    out_str += <span class="enscript-string">&quot; {:#010x}{:08x} {:&gt;6s} &quot;</span>.format(ts_hi, ts_lo, kdebug_qual)
    
    <span class="enscript-comment"># class
</span>    kdbg_class = <span class="enscript-string">&quot;&quot;</span>
    <span class="enscript-keyword">if</span> kdebug_class == 1:
        kdbg_class = <span class="enscript-string">&quot;MACH&quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 2:
        kdbg_class = <span class="enscript-string">&quot;NET &quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 3:
        kdbg_class = <span class="enscript-string">&quot;FS  &quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 4:
        kdbg_class = <span class="enscript-string">&quot;BSD &quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 5:
        kdbg_class = <span class="enscript-string">&quot;IOK &quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 6:
        kdbg_class = <span class="enscript-string">&quot;DRVR&quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 7:
        kdbg_class = <span class="enscript-string">&quot;TRAC&quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 8:
        kdbg_class = <span class="enscript-string">&quot;DLIL&quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 9:
        kdbg_class = <span class="enscript-string">&quot;WQ  &quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 10:
        kdbg_class = <span class="enscript-string">&quot;CS  &quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 11:
        kdbg_class = <span class="enscript-string">&quot;CG  &quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 20:
        kdbg_class = <span class="enscript-string">&quot;MISC&quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 30:
        kdbg_class = <span class="enscript-string">&quot;SEC &quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 31:
        kdbg_class = <span class="enscript-string">&quot;DYLD&quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 32:
        kdbg_class = <span class="enscript-string">&quot;QT  &quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 33:
        kdbg_class = <span class="enscript-string">&quot;APPS&quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 34:
        kdbg_class = <span class="enscript-string">&quot;LAUN&quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 36:
        kdbg_class = <span class="enscript-string">&quot;PPT &quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 37:
        kdbg_class = <span class="enscript-string">&quot;PERF&quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 38:
        kdbg_class = <span class="enscript-string">&quot;IMP &quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 39:
        kdbg_class = <span class="enscript-string">&quot;PCTL&quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 40:
        kdbg_class = <span class="enscript-string">&quot;BANK&quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 41:
        kdbg_class = <span class="enscript-string">&quot;XPC &quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 42:
        kdbg_class = <span class="enscript-string">&quot;ATM &quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 128:
        kdbg_class = <span class="enscript-string">&quot;ANS &quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 129:
        kdbg_class = <span class="enscript-string">&quot;SIO &quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 130:
        kdbg_class = <span class="enscript-string">&quot;SEP &quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 131:
        kdbg_class = <span class="enscript-string">&quot;ISP &quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 132:
        kdbg_class = <span class="enscript-string">&quot;OSCA&quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 133:
        kdbg_class = <span class="enscript-string">&quot;EGFX&quot;</span>
    <span class="enscript-keyword">elif</span> kdebug_class == 255:
        kdbg_class = <span class="enscript-string">&quot;MIG &quot;</span>
    <span class="enscript-keyword">else</span>:
        out_str += <span class="enscript-string">&quot;{:^#10x} &quot;</span>.format(kdebug_class)
    
    <span class="enscript-keyword">if</span> kdbg_class:
        out_str += <span class="enscript-string">&quot;{:^10s} &quot;</span>.format(kdbg_class)

    <span class="enscript-comment"># subclass and code
</span>    out_str += <span class="enscript-string">&quot; {:&gt;#5x} {:&gt;8d}   &quot;</span>.format(kdebug_subclass, kdebug_code)

    <span class="enscript-comment"># space for debugid-specific processing
</span>    <span class="enscript-comment"># EVPROC from bsd/kern/sys_generic.c
</span>    <span class="enscript-comment"># MISCDBG_CODE(DBG_EVENT,DBG_WAIT)
</span>    <span class="enscript-keyword">if</span> debugid == 0x14100048:
        code_info_str += <span class="enscript-string">&quot;waitevent &quot;</span>
        <span class="enscript-keyword">if</span> kdebug_arg1 == 1:
            code_info_str += <span class="enscript-string">&quot;before sleep&quot;</span>
        <span class="enscript-keyword">elif</span> kdebug_arg1 == 2:
            code_info_str += <span class="enscript-string">&quot;after  sleep&quot;</span>
        <span class="enscript-keyword">else</span>:
            code_info_str += <span class="enscript-string">&quot;????????????&quot;</span>
        code_info_str += <span class="enscript-string">&quot; chan={:#08x} &quot;</span>.format(kdebug_arg2)
    <span class="enscript-keyword">elif</span> debugid == 0x14100049:
        <span class="enscript-comment"># MISCDBG_CODE(DBG_EVENT,DBG_WAIT|DBG_FUNC_START)
</span>        code_info_str += <span class="enscript-string">&quot;waitevent &quot;</span>
    <span class="enscript-keyword">elif</span> debugid == 0x1410004a:
        <span class="enscript-comment"># MISCDBG_CODE(DBG_EVENT,DBG_WAIT|DBG_FUNC_END)
</span>        code_info_str += <span class="enscript-string">&quot;waitevent error={:d} &quot;</span>.format(kdebug_arg1)
        code_info_str += <span class="enscript-string">&quot;eqp={:#08x} &quot;</span>.format(kdebug_arg4)
        code_info_str += GetEVFlags(kdebug_arg3)
        code_info_str += <span class="enscript-string">&quot;er_handle={:d} &quot;</span>.format(kdebug_arg2)
    <span class="enscript-keyword">elif</span> debugid == 0x14100059:
        <span class="enscript-comment"># MISCDBG_CODE(DBG_EVENT,DBG_DEQUEUE|DBG_FUNC_START)
</span>        code_info_str += <span class="enscript-string">&quot;evprocdeque proc={:#08x} &quot;</span>.format(kdebug_arg1)
        <span class="enscript-keyword">if</span> kdebug_arg2 == 0:
            code_info_str += <span class="enscript-string">&quot;remove first &quot;</span>
        <span class="enscript-keyword">else</span>:
            code_info_str += <span class="enscript-string">&quot;remove {:#08x} &quot;</span>.format(kdebug_arg2)
    <span class="enscript-keyword">elif</span> debugid == 0x1410005a:
        <span class="enscript-comment"># MISCDBG_CODE(DBG_EVENT,DBG_DEQUEUE|DBG_FUNC_END)
</span>        code_info_str += <span class="enscript-string">&quot;evprocdeque &quot;</span>
        <span class="enscript-keyword">if</span> kdebug_arg1 == 0:
            code_info_str += <span class="enscript-string">&quot;result=NULL &quot;</span>
        <span class="enscript-keyword">else</span>:
            code_info_str += <span class="enscript-string">&quot;result={:#08x} &quot;</span>.format(kdebug_arg1)
    <span class="enscript-keyword">elif</span> debugid == 0x14100041:
        <span class="enscript-comment"># MISCDBG_CODE(DBG_EVENT,DBG_POST|DBG_FUNC_START)
</span>        code_info_str += <span class="enscript-string">&quot;postevent &quot;</span>
        code_info_str += GetEVFlags(kdebug_arg1)
    <span class="enscript-keyword">elif</span> debugid == 0x14100040:
        <span class="enscript-comment"># MISCDBG_CODE(DBG_EVENT,DBG_POST)
</span>        code_info_str += <span class="enscript-string">&quot;postevent &quot;</span>
        code_info_str += <span class="enscript-string">&quot;evq={:#08x} &quot;</span>.format(kdebug_arg1)
        code_info_str += <span class="enscript-string">&quot;er_eventbits=&quot;</span>
        code_info_str += GetEVFlags(kdebug_arg2)
        code_info_str +=<span class="enscript-string">&quot;mask=&quot;</span>
        code_info_str += GetEVFlags(kdebug_arg3)
    <span class="enscript-keyword">elif</span> debugid == 0x14100042:
        <span class="enscript-comment"># MISCDBG_CODE(DBG_EVENT,DBG_POST|DBG_FUNC_END)
</span>        code_info_str += <span class="enscript-string">&quot;postevent &quot;</span>
    <span class="enscript-keyword">elif</span> debugid == 0x14100055:
        <span class="enscript-comment"># MISCDBG_CODE(DBG_EVENT,DBG_ENQUEUE|DBG_FUNC_START)
</span>        code_info_str += <span class="enscript-string">&quot;evprocenque eqp={:#08x} &quot;</span>.format(kdebug_arg1)
        <span class="enscript-keyword">if</span> kdebug_arg2 &amp; 1:
            code_info_str += <span class="enscript-string">&quot;EV_QUEUED &quot;</span>
        code_info_str += GetEVFlags(kdebug_arg3)
    <span class="enscript-keyword">elif</span> debugid == 0x14100050:
        <span class="enscript-comment"># MISCDBG_CODE(DBG_EVENT,DBG_EWAKEUP)
</span>        code_info_str += <span class="enscript-string">&quot;evprocenque before wakeup eqp={:#08x} &quot;</span>.format(kdebug_arg4)
    <span class="enscript-keyword">elif</span> debugid == 0x14100056:
        <span class="enscript-comment"># MISCDBG_CODE(DBG_EVENT,DBG_ENQUEUE|DBG_FUNC_END)
</span>        code_info_str += <span class="enscript-string">&quot;evprocenque &quot;</span>
    <span class="enscript-keyword">elif</span> debugid == 0x1410004d:
        <span class="enscript-comment"># MISCDBG_CODE(DBG_EVENT,DBG_MOD|DBG_FUNC_START)
</span>        code_info_str += <span class="enscript-string">&quot;modwatch &quot;</span>
    <span class="enscript-keyword">elif</span> debugid == 0x1410004c:
        <span class="enscript-comment"># MISCDBG_CODE(DBG_EVENT,DBG_MOD)
</span>        code_info_str += <span class="enscript-string">&quot;modwatch er_handle={:d} &quot;</span>.format(kdebug_arg1)
        code_info_str += GetEVFlags(kdebug_arg2)
        code_info_str += <span class="enscript-string">&quot;evq={:#08x} &quot;</span>, kdebug_arg3
    <span class="enscript-keyword">elif</span> debugid == 0x1410004e:
    <span class="enscript-comment"># MISCDBG_CODE(DBG_EVENT,DBG_MOD|DBG_FUNC_END)
</span>        code_info_str += <span class="enscript-string">&quot;modwatch er_handle={:d} &quot;</span>.format(kdebug_arg1)
        code_info_str += <span class="enscript-string">&quot;ee_eventmask=&quot;</span>
        code_info_str += GetEVFlags(kdebug_arg2)
        code_info_str += <span class="enscript-string">&quot;sp={:#08x} &quot;</span>.format(kdebug_arg3)
        code_info_str += <span class="enscript-string">&quot;flag=&quot;</span>
        code_info_str += GetEVFlags(kdebug_arg4)
    <span class="enscript-keyword">else</span>:
        code_info_str += <span class="enscript-string">&quot;arg1={:#010x} &quot;</span>.format(kdebug_arg1)
        code_info_str += <span class="enscript-string">&quot;arg2={:#010x} &quot;</span>.format(kdebug_arg2)
        code_info_str += <span class="enscript-string">&quot;arg3={:#010x} &quot;</span>.format(kdebug_arg3)
        code_info_str += <span class="enscript-string">&quot;arg4={:#010x} &quot;</span>.format(kdebug_arg4)
    
    <span class="enscript-comment"># finish up
</span>    out_str += <span class="enscript-string">&quot;{:&lt;25s}\n&quot;</span>.format(code_info_str)
    <span class="enscript-keyword">return</span> out_str

@lldb_command(<span class="enscript-string">'showkerneldebugbuffercpu'</span>)
@header(<span class="enscript-string">&quot;{0: ^20s} {1: &gt;6s} {2: &gt;12s} {3: ^20s} {4: &gt;6s} {5: ^10s} {6: &gt;5s} {7: &gt;8s} {8: ^25s}&quot;</span>.
    format(<span class="enscript-string">'kd_buf'</span>, <span class="enscript-string">'CPU'</span>, <span class="enscript-string">'Thread'</span>, <span class="enscript-string">'Timestamp'</span>, <span class="enscript-string">'S/E'</span>, <span class="enscript-string">'Class'</span>, <span class="enscript-string">'Sub'</span>, <span class="enscript-string">'Code'</span>, <span class="enscript-string">'Code Specific Info'</span>))
<span class="enscript-keyword">def</span> <span class="enscript-function-name">ShowKernelDebugBufferCPU</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Prints the last N entries in the kernel debug buffer for specified cpu
        Syntax: showkerneldebugbuffercpu &lt;cpu_num&gt; &lt;count&gt;
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> cmd_args == None <span class="enscript-keyword">or</span> len(cmd_args) &lt; 2:
        <span class="enscript-keyword">raise</span> ArgumentError(<span class="enscript-string">&quot;Invalid arguments passed.&quot;</span>)
    
    out_str = <span class="enscript-string">&quot;&quot;</span>
    kdbg_str = <span class="enscript-string">&quot;&quot;</span>
    cpu_number = ArgumentStringToInt(cmd_args[0])
    entry_count = ArgumentStringToInt(cmd_args[1])
    debugentriesfound = 0
    <span class="enscript-comment">#  Check if KDBG_BFINIT (0x80000000) is set in kdebug_flags
</span>    <span class="enscript-keyword">if</span> (kern.globals.kd_ctrl_page.kdebug_flags &amp; 0x80000000):   
        out_str += ShowKernelDebugBufferCPU.header + <span class="enscript-string">&quot;\n&quot;</span>
        <span class="enscript-keyword">if</span> entry_count == 0:
            out_str += <span class="enscript-string">&quot;&lt;count&gt; is 0, dumping 50 entries\n&quot;</span>
            entry_count = 50

        <span class="enscript-keyword">if</span> cpu_number &gt;= kern.globals.kd_ctrl_page.kdebug_cpus:
            kdbg_str += <span class="enscript-string">&quot;cpu number too big\n&quot;</span>
        <span class="enscript-keyword">else</span>:
            kdbp = addressof(kern.globals.kdbip[cpu_number])
            kdsp = kdbp.kd_list_head
            <span class="enscript-keyword">while</span> ((kdsp.raw != 0 <span class="enscript-keyword">and</span> kdsp.raw != 0x00000000ffffffff) <span class="enscript-keyword">and</span> (entry_count &gt; 0)):
                kd_buffer = kern.globals.kd_bufs[kdsp.buffer_index]
                kdsp_actual = addressof(kd_buffer.kdsb_addr[kdsp.offset])
                <span class="enscript-keyword">if</span> kdsp_actual.kds_readlast != kdsp_actual.kds_bufindx:
                    kds_buf = kdsp_actual.kds_records[kdsp_actual.kds_bufindx]
                    kds_bufptr = addressof(kds_buf)
                    <span class="enscript-keyword">while</span> (entry_count &gt; 0) <span class="enscript-keyword">and</span> \
                        (unsigned(kds_bufptr) &gt; unsigned(addressof(kdsp_actual.kds_records[kdsp_actual.kds_readlast]))):
                        kds_bufptr = kds_bufptr - sizeof(kds_buf)
                        entry_count = entry_count - 1
                        kdbg_str += GetKernelDebugBufferEntry(kds_bufptr)
                kdsp = kdsp_actual.kds_next
    <span class="enscript-keyword">else</span>:
        kdbg_str += <span class="enscript-string">&quot;Trace buffer not enabled for CPU {:d}\n&quot;</span>.format(cpu_number)
    
    <span class="enscript-keyword">if</span> kdbg_str:
        out_str += kdbg_str
        <span class="enscript-keyword">print</span> out_str

@lldb_command(<span class="enscript-string">'showkerneldebugbuffer'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">ShowKernelDebugBuffer</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Prints the last N entries in the kernel debug buffer per cpu
        Syntax: showkerneldebugbuffer &lt;count&gt;
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> cmd_args == None <span class="enscript-keyword">or</span> len(cmd_args) &lt; 1:
        <span class="enscript-keyword">raise</span> ArgumentError(<span class="enscript-string">&quot;Invalid arguments passed.&quot;</span>)
    
    <span class="enscript-comment">#  Check if KDBG_BFINIT (0x80000000) is set in kdebug_flags
</span>    <span class="enscript-keyword">if</span> (kern.globals.kd_ctrl_page.kdebug_flags &amp; 0x80000000):
        entrycount = ArgumentStringToInt(cmd_args[0])
        <span class="enscript-keyword">if</span> entrycount == 0:
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;&lt;count&gt; is 0, dumping 50 entries per cpu\n&quot;</span>
            entrycount = 50
        cpu_num = 0
        <span class="enscript-keyword">while</span> cpu_num &lt; kern.globals.kd_ctrl_page.kdebug_cpus:
            ShowKernelDebugBufferCPU([str(cpu_num), str(entrycount)])
            cpu_num += 1
    <span class="enscript-keyword">else</span>:
        <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Trace buffer not enabled\n&quot;</span>
</pre>
<hr />
</body></html>