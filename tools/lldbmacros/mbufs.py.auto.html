<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>mbufs.py</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">mbufs.py&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>

<span class="enscript-string">&quot;&quot;&quot; Please make sure you read the README COMPLETELY BEFORE reading anything below.
    It is very critical that you read coding guidelines in Section E in README file.
&quot;&quot;&quot;</span>

<span class="enscript-keyword">from</span> xnu <span class="enscript-keyword">import</span> *
<span class="enscript-keyword">from</span> utils <span class="enscript-keyword">import</span> *

<span class="enscript-keyword">from</span> mbufdefines <span class="enscript-keyword">import</span> *
<span class="enscript-keyword">import</span> xnudefines

<span class="enscript-comment"># Macro: mbuf_stat
</span>@lldb_command(<span class="enscript-string">'mbuf_stat'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">MBufStat</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Print extended mbuf allocator statistics.
    &quot;&quot;&quot;</span>
    hdr_format = <span class="enscript-string">&quot;{0: &lt;16s} {1: &gt;8s} {2: &gt;8s} {3: ^16s} {4: &gt;8s} {5: &gt;12s} {6: &gt;8s} {7: &gt;8s} {8: &gt;8s}&quot;</span>
    <span class="enscript-keyword">print</span> hdr_format.format(<span class="enscript-string">'class'</span>, <span class="enscript-string">'total'</span>, <span class="enscript-string">'cached'</span>, <span class="enscript-string">'uncached'</span>, <span class="enscript-string">'inuse'</span>, <span class="enscript-string">'failed'</span>, <span class="enscript-string">'waiter'</span>, <span class="enscript-string">'notified'</span>, <span class="enscript-string">'purge'</span>)
    <span class="enscript-keyword">print</span> hdr_format.format(<span class="enscript-string">'name'</span>, <span class="enscript-string">'objs'</span>, <span class="enscript-string">'objs'</span>, <span class="enscript-string">'objs/slabs'</span>, <span class="enscript-string">'objs'</span>, <span class="enscript-string">'alloc count'</span>, <span class="enscript-string">'count'</span>, <span class="enscript-string">'count'</span>, <span class="enscript-string">'count'</span>)
    <span class="enscript-keyword">print</span> hdr_format.format(<span class="enscript-string">'-'</span>*16, <span class="enscript-string">'-'</span>*8, <span class="enscript-string">'-'</span>*8, <span class="enscript-string">'-'</span>*16, <span class="enscript-string">'-'</span>*8, <span class="enscript-string">'-'</span>*12, <span class="enscript-string">'-'</span>*8, <span class="enscript-string">'-'</span>*8, <span class="enscript-string">'-'</span>*8)
    entry_format = <span class="enscript-string">&quot;{0: &lt;16s} {1: &gt;8d} {2: &gt;8d} {3:&gt;7d} / {4:&lt;6d} {5: &gt;8d} {6: &gt;12d} {7: &gt;8d} {8: &gt;8d} {9: &gt;8d}&quot;</span>
    num_items = sizeof(kern.globals.mbuf_table) / sizeof(kern.globals.mbuf_table[0])
    ncpus = int(kern.globals.ncpu)
    <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> range(num_items):
        mbuf = kern.globals.mbuf_table[i]
        mcs = Cast(mbuf.mtbl_stats, <span class="enscript-string">'mb_class_stat_t *'</span>)
        mc = mbuf.mtbl_cache
        total = 0
        total += int(mc.mc_full.bl_total) * int(mc.mc_cpu[0].cc_bktsize)
        ccp_arr = mc.mc_cpu
        <span class="enscript-keyword">for</span> i <span class="enscript-keyword">in</span> range(ncpus):
            ccp = ccp_arr[i]
            <span class="enscript-keyword">if</span> int(ccp.cc_objs) &gt; 0:
                total += int(ccp.cc_objs)
            <span class="enscript-keyword">if</span> int(ccp.cc_pobjs) &gt; 0:
                total += int(ccp.cc_pobjs)
        <span class="enscript-keyword">print</span> entry_format.format(mcs.mbcl_cname, mcs.mbcl_total,  total,
                                  mcs.mbcl_infree, mcs.mbcl_slab_cnt,
                                  (mcs.mbcl_total - total - mcs.mbcl_infree),
                                  mcs.mbcl_fail_cnt, mbuf.mtbl_cache.mc_waiter_cnt,
                                  mcs.mbcl_notified, mcs.mbcl_purge_cnt
                                  )
<span class="enscript-comment"># EndMacro: mbuf_stat
</span>
<span class="enscript-comment"># Macro: mbuf_walkpkt
</span>@lldb_command(<span class="enscript-string">'mbuf_walkpkt'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">MbufWalkPacket</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Walk the mbuf packet chain (m_nextpkt)
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> cmd_args:
        <span class="enscript-keyword">raise</span> ArgumentError(<span class="enscript-string">&quot;Missing argument 0 in user function.&quot;</span>)

    mp = kern.GetValueFromAddress(cmd_args[0], <span class="enscript-string">'mbuf *'</span>)
    cnt = 1
    tot = 0
    <span class="enscript-keyword">while</span> (mp):
        out_string = <span class="enscript-string">&quot;&quot;</span>
        mbuf_walk_packet_format = <span class="enscript-string">&quot;{0:4d} 0x{1:x} [len {2:4d}, type {3:2d}, &quot;</span>
        out_string += mbuf_walk_packet_format.format(cnt, mp, mp.m_hdr.mh_len, mp.m_hdr.mh_type)
        <span class="enscript-keyword">if</span> (kern.globals.mclaudit != 0):
            out_string += GetMbufBuf2Mca(mp) + <span class="enscript-string">&quot;, &quot;</span>
        tot = tot + mp.m_hdr.mh_len
        out_string += <span class="enscript-string">&quot;total &quot;</span> + str(tot) + <span class="enscript-string">&quot;]&quot;</span>
        <span class="enscript-keyword">print</span> out_string
        mp = mp.m_hdr.mh_nextpkt
        cnt += 1
<span class="enscript-comment"># EndMacro: mbuf_walkpkt
</span>
<span class="enscript-comment"># Macro: mbuf_walk
</span>@lldb_command(<span class="enscript-string">'mbuf_walk'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">MbufWalk</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Walk the mbuf chain (m_next)
    &quot;&quot;&quot;</span>
    mp = kern.GetValueFromAddress(cmd_args[0], <span class="enscript-string">'mbuf *'</span>)
    cnt = 1
    tot = 0
    <span class="enscript-keyword">while</span> (mp):
        out_string = <span class="enscript-string">&quot;&quot;</span>
        mbuf_walk_format = <span class="enscript-string">&quot;{0:4d} 0x{1:x} [len {2:4d}, type {3:2d}, &quot;</span>
        out_string += mbuf_walk_format.format(cnt, mp, mp.m_hdr.mh_len, mp.m_hdr.mh_type)
        <span class="enscript-keyword">if</span> (kern.globals.mclaudit != 0):
            out_string += GetMbufBuf2Mca(mp) + <span class="enscript-string">&quot;, &quot;</span>
        tot = tot + mp.m_hdr.mh_len
        out_string += <span class="enscript-string">&quot;total &quot;</span> + str(tot) + <span class="enscript-string">&quot;]&quot;</span>
        <span class="enscript-keyword">print</span> out_string
        mp = mp.m_hdr.mh_next
        cnt += 1
<span class="enscript-comment"># EndMacro: mbuf_walk
</span>
<span class="enscript-comment"># Macro: mbuf_buf2slab
</span>@lldb_command(<span class="enscript-string">'mbuf_buf2slab'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">MbufBuf2Slab</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Given an mbuf object, find its corresponding slab address
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> cmd_args:
        <span class="enscript-keyword">raise</span> ArgumentError(<span class="enscript-string">&quot;Missing argument 0 in user function.&quot;</span>)

    m = kern.GetValueFromAddress(cmd_args[0], <span class="enscript-string">'mbuf *'</span>)
    slab = GetMbufSlab(m)
    <span class="enscript-keyword">if</span> (kern.ptrsize == 8):
        mbuf_slab_format = <span class="enscript-string">&quot;0x{0:&lt;16x}&quot;</span>
        <span class="enscript-keyword">print</span> mbuf_slab_format.format(slab)
    <span class="enscript-keyword">else</span>:
        mbuf_slab_format = <span class="enscript-string">&quot;0x{0:&lt;8x}&quot;</span>
        <span class="enscript-keyword">print</span> mbuf_slab_format.format(slab)
<span class="enscript-comment"># EndMacro: mbuf_buf2slab
</span>
<span class="enscript-comment"># Macro: mbuf_buf2mca
</span>@lldb_command(<span class="enscript-string">'mbuf_buf2mca'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">MbufBuf2Mca</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Find the mcache audit structure of the corresponding mbuf
    &quot;&quot;&quot;</span>
    m = kern.GetValueFromAddress(cmd_args[0], <span class="enscript-string">'mbuf *'</span>)
    <span class="enscript-keyword">print</span> GetMbufBuf2Mca(m)
    <span class="enscript-keyword">return</span>
<span class="enscript-comment"># EndMacro: mbuf_buf2mca
</span>
<span class="enscript-comment"># Macro: mbuf_slabs
</span>@lldb_command(<span class="enscript-string">'mbuf_slabs'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">MbufSlabs</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Print all slabs in the group
    &quot;&quot;&quot;</span>

    out_string = <span class="enscript-string">&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> cmd_args:
        <span class="enscript-keyword">raise</span> ArgumentError(<span class="enscript-string">&quot;Invalid arguments passed.&quot;</span>)

    slg = kern.GetValueFromAddress(cmd_args[0], <span class="enscript-string">'mcl_slabg_t *'</span>)
    x = 0

    <span class="enscript-keyword">if</span> (kern.ptrsize == 8):
        slabs_string_format = <span class="enscript-string">&quot;{0:&gt;4d}: 0x{1:16x} 0x{2:16x} 0x{3:16x} {4:4s} {5:20d} {6:3d} {7:3d} {8:3d} {9:3d} {10:&gt;6s} &quot;</span>
        out_string += <span class="enscript-string">&quot;slot slab               next               obj                mca                tstamp     C  R  N   size flags\n&quot;</span>
        out_string += <span class="enscript-string">&quot;---- ------------------ ------------------ ------------------ ------------------ ---------- -- -- -- ------ -----\n&quot;</span>
    <span class="enscript-keyword">else</span>:
        slabs_string_format = <span class="enscript-string">&quot;{0:&gt;4d}: 0x{1:8x} 0x{2:8x} 0x{3:8x} {4:4s} {5:20d} {6:3d} {7:3d} {8:3d} {9:3d} {10:&gt;6s} &quot;</span>
        out_string += <span class="enscript-string">&quot;slot slab       next       obj        mca        tstamp     C  R  N   size flags\n&quot;</span>
        out_string += <span class="enscript-string">&quot;---- ---------- ---------- ---------- ---------- ---------- -- -- -- ------ -----\n&quot;</span>

    mbutl = cast(kern.globals.mbutl, <span class="enscript-string">'unsigned char *'</span>)
    nslabspmb = int((1 &lt;&lt; MBSHIFT) &gt;&gt; unsigned(kern.globals.page_shift))
    <span class="enscript-keyword">while</span> x &lt; nslabspmb:
        sl = addressof(slg.slg_slab[x])
        mca = 0
        obj = sl.sl_base
        ts = 0

        <span class="enscript-keyword">if</span> (kern.globals.mclaudit != 0):
            mca = GetMbufMcaPtr(obj, sl.sl_class)
            trn = (mca.mca_next_trn + unsigned(kern.globals.mca_trn_max) - 1) % unsigned(kern.globals.mca_trn_max)
            ts = mca.mca_trns[trn].mca_tstamp

        out_string += slabs_string_format.format((x + 1), sl, sl.sl_next, obj, hex(mca), int(ts), int(sl.sl_class), int(sl.sl_refcnt), int(sl.sl_chunks), int(sl.sl_len), hex(sl.sl_flags))

        <span class="enscript-keyword">if</span> (sl.sl_flags != 0):
            out_string += <span class="enscript-string">&quot;&lt;&quot;</span>
            <span class="enscript-keyword">if</span> sl.sl_flags &amp; SLF_MAPPED:
                out_string += <span class="enscript-string">&quot;mapped&quot;</span>
            <span class="enscript-keyword">if</span> sl.sl_flags &amp; SLF_PARTIAL:
                out_string += <span class="enscript-string">&quot;,partial&quot;</span>
            <span class="enscript-keyword">if</span> sl.sl_flags &amp; SLF_DETACHED:
                out_string += <span class="enscript-string">&quot;,detached&quot;</span>
            out_string += <span class="enscript-string">&quot;&gt;&quot;</span>
        out_string += <span class="enscript-string">&quot;\n&quot;</span>

        <span class="enscript-keyword">if</span> sl.sl_chunks &gt; 1:
            z = 1
            c = sl.sl_len/sl.sl_chunks

            <span class="enscript-keyword">while</span> z &lt; sl.sl_chunks:
                obj = sl.sl_base + (c * z)
                mca = 0
                ts = 0

                <span class="enscript-keyword">if</span> (kern.globals.mclaudit != 0):
                    mca = GetMbufMcaPtr(obj, sl.sl_class)
                    trn = (mca.mca_next_trn + unsigned(kern.globals.mca_trn_max) - 1) % unsigned(kern.globals.mca_trn_max)
                    ts = mca.mca_trns[trn].mca_tstamp

                <span class="enscript-keyword">if</span> (kern.ptrsize == 8):
                    out_string += <span class="enscript-string">&quot;                                            &quot;</span> + hex(obj) + <span class="enscript-string">&quot; &quot;</span> + hex(mca) + <span class="enscript-string">&quot;                    &quot;</span> + str(unsigned(ts)) + <span class="enscript-string">&quot;\n&quot;</span>
                <span class="enscript-keyword">else</span>:
                    out_string += <span class="enscript-string">&quot;                            &quot;</span> + hex(obj) + <span class="enscript-string">&quot; &quot;</span> + hex(mca) + <span class="enscript-string">&quot;           &quot;</span> + str(unsigned(ts)) + <span class="enscript-string">&quot;\n&quot;</span>

                z += 1
        x += 1
    <span class="enscript-keyword">print</span> out_string
<span class="enscript-comment"># EndMacro: mbuf_slabs
</span>
<span class="enscript-comment"># Macro: mbuf_slabstbl
</span>@lldb_command(<span class="enscript-string">'mbuf_slabstbl'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">MbufSlabsTbl</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Print slabs table
    &quot;&quot;&quot;</span>
    out_string = <span class="enscript-string">&quot;&quot;</span>
    x = 0

    <span class="enscript-keyword">if</span> (kern.ptrsize == 8):
        out_string += <span class="enscript-string">&quot;slot slabg              slabs range\n&quot;</span>
        out_string += <span class="enscript-string">&quot;---- ------------------ -------------------------------------------\n&quot;</span>
    <span class="enscript-keyword">else</span>:
        out_string += <span class="enscript-string">&quot;slot slabg      slabs range\n&quot;</span>
        out_string += <span class="enscript-string">&quot;---- ---------- ---------------------------\n&quot;</span>

    slabstbl = kern.globals.slabstbl
    slabs_table_blank_string_format = <span class="enscript-string">&quot;{0:&gt;3d}: - \n&quot;</span>
    nslabspmb = int(((1 &lt;&lt; MBSHIFT) &gt;&gt; unsigned(kern.globals.page_shift)))
    <span class="enscript-keyword">while</span> (x &lt; unsigned(kern.globals.maxslabgrp)):
        slg = slabstbl[x]
        <span class="enscript-keyword">if</span> (slg == 0):
            out_string += slabs_table_blank_string_format.format(x+1)
        <span class="enscript-keyword">else</span>:
            <span class="enscript-keyword">if</span> (kern.ptrsize == 8):
                slabs_table_string_format = <span class="enscript-string">&quot;{0:&gt;3d}: 0x{1:16x}  [ 0x{2:16x} - 0x{3:16x} ]\n&quot;</span>
                out_string += slabs_table_string_format.format(x+1, slg, addressof(slg.slg_slab[0]), addressof(slg.slg_slab[nslabspmb-1]))
            <span class="enscript-keyword">else</span>:
                slabs_table_string_format = <span class="enscript-string">&quot;{0:&gt;3d}: 0x{1:8x}  [ 0x{2:8x} - 0x{3:8x} ]\n&quot;</span>
                out_string += slabs_table_string_format.format(x+1, slg, addressof(slg.slg_slab[0]), addressof(slg.slg_slab[nslabspmb-1]))

        x += 1
    <span class="enscript-keyword">print</span> out_string
<span class="enscript-comment"># EndMacro: mbuf_slabstbl
</span>
<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetMbufMcaPtr</span>(m, cl):
    pgshift = int(kern.globals.page_shift)
    ix = int((m - Cast(kern.globals.mbutl, <span class="enscript-string">'char *'</span>)) &gt;&gt; pgshift)
    page_addr = (Cast(kern.globals.mbutl, <span class="enscript-string">'char *'</span>) + (ix &lt;&lt; pgshift))

    <span class="enscript-keyword">if</span> (int(cl) == 0):
        midx = int((m - page_addr) &gt;&gt; 8)
        mca = kern.globals.mclaudit[ix].cl_audit[midx]
    <span class="enscript-keyword">elif</span> (int(cl) == 1):
        midx = int((m - page_addr) &gt;&gt; 11)
        mca = kern.globals.mclaudit[ix].cl_audit[midx]
    <span class="enscript-keyword">elif</span> (int(cl) == 2):
        midx = int((m - page_addr) &gt;&gt; 12)
        mca = kern.globals.mclaudit[ix].cl_audit[midx]
    <span class="enscript-keyword">else</span>:
        mca = kern.globals.mclaudit[ix].cl_audit[0]
    <span class="enscript-keyword">return</span> Cast(mca, <span class="enscript-string">'mcache_audit_t *'</span>)

<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetMbufSlab</span>(m):
    pgshift = int(kern.globals.page_shift)
    gix = int((Cast(m, <span class="enscript-string">'char *'</span>) - Cast(kern.globals.mbutl, <span class="enscript-string">'char *'</span>)) &gt;&gt; MBSHIFT)
    slabstbl = kern.globals.slabstbl
    ix = int((Cast(m, <span class="enscript-string">'char *'</span>) - Cast(slabstbl[gix].slg_slab[0].sl_base, <span class="enscript-string">'char *'</span>)) &gt;&gt; pgshift)
    <span class="enscript-keyword">return</span> addressof(slabstbl[gix].slg_slab[ix])

<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetMbufBuf2Mca</span>(m):
    sl = GetMbufSlab(m)
    mca = GetMbufMcaPtr(m, sl.sl_class)
    <span class="enscript-keyword">return</span> str(mca)

<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetMbufWalkAllSlabs</span>(show_a, show_f, show_tr):
    out_string = <span class="enscript-string">&quot;&quot;</span>

    kern.globals.slabstbl[0]

    x = 0
    total = 0
    total_a = 0
    total_f = 0

    <span class="enscript-keyword">if</span> (show_a <span class="enscript-keyword">and</span> <span class="enscript-keyword">not</span>(show_f)):
        out_string += <span class="enscript-string">&quot;Searching only for active... \n&quot;</span>
    <span class="enscript-keyword">if</span> (<span class="enscript-keyword">not</span>(show_a) <span class="enscript-keyword">and</span> show_f):
        out_string += <span class="enscript-string">&quot;Searching only for inactive... \n&quot;</span>
    <span class="enscript-keyword">if</span> (show_a <span class="enscript-keyword">and</span> show_f):
        out_string += <span class="enscript-string">&quot;Displaying all... \n&quot;</span>

    <span class="enscript-keyword">if</span> (kern.ptrsize == 8):
        show_mca_string_format = <span class="enscript-string">&quot;{0:&gt;4s} {1:&gt;4s} {2:&gt;16s} {3:&gt;16s} {4:&gt;16} {5:&gt;12s} {6:12s}&quot;</span>
        out_string += show_mca_string_format.format(<span class="enscript-string">&quot;slot&quot;</span>, <span class="enscript-string">&quot;idx&quot;</span>, <span class="enscript-string">&quot;slab address&quot;</span>, <span class="enscript-string">&quot;mca address&quot;</span>, <span class="enscript-string">&quot;obj address&quot;</span>, <span class="enscript-string">&quot;type&quot;</span>, <span class="enscript-string">&quot;allocation state\n&quot;</span>)
    <span class="enscript-keyword">else</span>:
        show_mca_string_format = <span class="enscript-string">&quot;{0:4s} {1:4s} {2:8s} {3:8s} {4:8} {5:12s} {6:12s}&quot;</span>
        out_string += show_mca_string_format.format(<span class="enscript-string">&quot;slot&quot;</span>, <span class="enscript-string">&quot;idx&quot;</span>, <span class="enscript-string">&quot;slab address&quot;</span>, <span class="enscript-string">&quot;mca address&quot;</span>, <span class="enscript-string">&quot;obj address&quot;</span>, <span class="enscript-string">&quot;type&quot;</span>, <span class="enscript-string">&quot;allocation state\n&quot;</span>)

    nslabspmb = unsigned((1 &lt;&lt; MBSHIFT) &gt;&gt; unsigned(kern.globals.page_shift))
    <span class="enscript-keyword">while</span> (x &lt; unsigned(kern.globals.slabgrp)):
        slg = kern.globals.slabstbl[x]
        y = 0
        stop = 0
        <span class="enscript-keyword">while</span> ((y &lt; nslabspmb) <span class="enscript-keyword">and</span> (stop == 0)):
            sl = addressof(slg.slg_slab[y])
            base = sl.sl_base
            mca = GetMbufMcaPtr(base, sl.sl_class)
            first = 1

            <span class="enscript-keyword">while</span> ((Cast(mca, <span class="enscript-string">'int'</span>) != 0) <span class="enscript-keyword">and</span> (unsigned(mca.mca_addr) != 0)):
                printmca = 0
                <span class="enscript-keyword">if</span> (mca.mca_uflags &amp; (MB_INUSE | MB_COMP_INUSE)):
                    total_a = total_a + 1
                    printmca = show_a
                <span class="enscript-keyword">else</span>:
                    total_f = total_f + 1
                    printmca = show_f

                <span class="enscript-keyword">if</span> (printmca != 0):
                    <span class="enscript-keyword">if</span> (first == 1):
                        <span class="enscript-keyword">if</span> (kern.ptrsize == 8):
                            mca_string_format = <span class="enscript-string">&quot;{0:4d} {1:4d} 0x{2:16x} &quot;</span>
                            out_string += mca_string_format.format(x, y, sl)
                        <span class="enscript-keyword">else</span>:
                            mca_string_format = <span class="enscript-string">&quot;{0:4d} {1:4d} 0x{02:8x} &quot;</span>
                            out_string += mca_string_format.format(x, y, sl)
                    <span class="enscript-keyword">else</span>:
                        <span class="enscript-keyword">if</span> (kern.ptrsize == 8):
                            out_string += <span class="enscript-string">&quot;                             &quot;</span>
                        <span class="enscript-keyword">else</span>:
                            out_string += <span class="enscript-string">&quot;                     &quot;</span>

                    <span class="enscript-keyword">if</span> (kern.ptrsize == 8):
                        mca_string_format = <span class="enscript-string">&quot;0x{0:16x} 0x{1:16x}&quot;</span>
                        out_string += mca_string_format.format(mca, mca.mca_addr)
                    <span class="enscript-keyword">else</span>:
                        mca_string_format = <span class="enscript-string">&quot;0x{0:8x} 0x{1:8x}&quot;</span>
                        out_string += mca_string_format.format(mca, mca.mca_addr)

                    out_string += GetMbufMcaCtype(mca, 0)

                    <span class="enscript-keyword">if</span> (mca.mca_uflags &amp; (MB_INUSE | MB_COMP_INUSE)):
                        out_string += <span class="enscript-string">&quot;active        &quot;</span>
                    <span class="enscript-keyword">else</span>:
                        out_string += <span class="enscript-string">&quot;       freed &quot;</span>
                    <span class="enscript-keyword">if</span> (first == 1):
                        first = 0
                    out_string += <span class="enscript-string">&quot;\n&quot;</span>
                    total = total + 1

                    <span class="enscript-keyword">if</span> (show_tr != 0):
                        trn = (mca.mca_next_trn + idx - 1) % unsigned(kern.globals.mca_trn_max)
                        out_string += <span class="enscript-string">&quot;Transaction &quot;</span> + str(int(trn)) + <span class="enscript-string">&quot; at &quot;</span> + str(int(mca.mca_trns[int(trn)].mca_tstamp)) + <span class="enscript-string">&quot; by thread: 0x&quot;</span> + str(hex(mca.mca_trns[int(trn)].mca_thread)) + <span class="enscript-string">&quot;:\n&quot;</span>
                        cnt = 0
                        <span class="enscript-keyword">while</span> (cnt &lt; mca.mca_trns[int(trn)].mca_depth):
                            kgm_pc = mca.mca_trns[int(trn)].mca_stack[int(cnt)]
                            out_string += str(int(cnt) + 1) + <span class="enscript-string">&quot; &quot;</span>
                            out_string += GetPc(kgm_pc)
                            cnt += 1

                    <span class="enscript-keyword">print</span> out_string
                    out_string = <span class="enscript-string">&quot;&quot;</span>
                mca = mca.mca_next

            y += 1
            <span class="enscript-keyword">if</span> (slg.slg_slab[int(y)].sl_base == 0):
                stop = 1
        x += 1

    <span class="enscript-keyword">if</span> (total <span class="enscript-keyword">and</span> show_a <span class="enscript-keyword">and</span> show_f):
        out_string += <span class="enscript-string">&quot;total objects = &quot;</span> + str(int(total)) + <span class="enscript-string">&quot;\n&quot;</span>
        out_string += <span class="enscript-string">&quot;active/unfreed objects = &quot;</span> + str(int(total_a)) + <span class="enscript-string">&quot;\n&quot;</span>
        out_string += <span class="enscript-string">&quot;freed/in_cache objects = &quot;</span> + str(int(total_f)) + <span class="enscript-string">&quot;\n&quot;</span>

    <span class="enscript-keyword">return</span> out_string

<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetMbufMcaCtype</span>(mca, vopt):
    cp = mca.mca_cache
    mca_class = unsigned(cp.mc_private)
    csize = unsigned(kern.globals.mbuf_table[mca_class].mtbl_stats.mbcl_size)
    done = 0
    out_string = <span class="enscript-string">&quot;    &quot;</span>
    <span class="enscript-keyword">if</span> (csize == MSIZE):
        <span class="enscript-keyword">if</span> (vopt):
            out_string += <span class="enscript-string">&quot;M (mbuf) &quot;</span>
        <span class="enscript-keyword">else</span>:
            out_string += <span class="enscript-string">&quot;M     &quot;</span>
        <span class="enscript-keyword">return</span> out_string
    <span class="enscript-keyword">if</span> (csize == MCLBYTES):
        <span class="enscript-keyword">if</span> (vopt):
            out_string += <span class="enscript-string">&quot;CL (2K cluster) &quot;</span>
        <span class="enscript-keyword">else</span>:
            out_string += <span class="enscript-string">&quot;CL     &quot;</span>
        <span class="enscript-keyword">return</span> out_string
    <span class="enscript-keyword">if</span> (csize == MBIGCLBYTES):
        <span class="enscript-keyword">if</span> (vopt):
            out_string += <span class="enscript-string">&quot;BCL (4K cluster) &quot;</span>
        <span class="enscript-keyword">else</span>:
            out_string += <span class="enscript-string">&quot;BCL     &quot;</span>
        <span class="enscript-keyword">return</span> out_string
    <span class="enscript-keyword">if</span> (csize == M16KCLBYTES):
        <span class="enscript-keyword">if</span> (vopt):
            out_string += <span class="enscript-string">&quot;JCL (16K cluster) &quot;</span>
        <span class="enscript-keyword">else</span>:
            out_string += <span class="enscript-string">&quot;JCL     &quot;</span>
        <span class="enscript-keyword">return</span> out_string

    <span class="enscript-keyword">if</span> (csize == (MSIZE + MCLBYTES)):
        <span class="enscript-keyword">if</span> (mca.mca_uflags &amp; MB_SCVALID):
            <span class="enscript-keyword">if</span> (mca.mca_uptr):
                out_string += <span class="enscript-string">&quot;M+CL  &quot;</span>
                <span class="enscript-keyword">if</span> vopt:
                    out_string += <span class="enscript-string">&quot;(paired mbuf, 2K cluster) &quot;</span>
            <span class="enscript-keyword">else</span>:
                out_string += <span class="enscript-string">&quot;M-CL  &quot;</span>
                <span class="enscript-keyword">if</span> vopt:
                    out_string += <span class="enscript-string">&quot;(unpaired mbuf, 2K cluster) &quot;</span>
        <span class="enscript-keyword">else</span>:
            <span class="enscript-keyword">if</span> (mca.mca_uptr):
                out_string += <span class="enscript-string">&quot;CL+M  &quot;</span>
                <span class="enscript-keyword">if</span> vopt:
                    out_string += <span class="enscript-string">&quot;(paired 2K cluster, mbuf) &quot;</span>
            <span class="enscript-keyword">else</span>:
                out_string += <span class="enscript-string">&quot;CL-M  &quot;</span>
                <span class="enscript-keyword">if</span> vopt:
                    out_string += <span class="enscript-string">&quot;(unpaired 2K cluster, mbuf) &quot;</span>
        <span class="enscript-keyword">return</span> out_string

    <span class="enscript-keyword">if</span> (csize == (MSIZE + MBIGCLBYTES)):
        <span class="enscript-keyword">if</span> (mca.mca_uflags &amp; MB_SCVALID):
            <span class="enscript-keyword">if</span> (mca.mca_uptr):
                out_string += <span class="enscript-string">&quot;M+BCL  &quot;</span>
                <span class="enscript-keyword">if</span> vopt:
                    out_string += <span class="enscript-string">&quot;(paired mbuf, 4K cluster) &quot;</span>
            <span class="enscript-keyword">else</span>:
                out_string += <span class="enscript-string">&quot;M-BCL  &quot;</span>
                <span class="enscript-keyword">if</span> vopt:
                    out_string += <span class="enscript-string">&quot;(unpaired mbuf, 4K cluster) &quot;</span>
        <span class="enscript-keyword">else</span>:
            <span class="enscript-keyword">if</span> (mca.mca_uptr):
                out_string += <span class="enscript-string">&quot;BCL+M  &quot;</span>
                <span class="enscript-keyword">if</span> vopt:
                    out_string += <span class="enscript-string">&quot;(paired 4K cluster, mbuf) &quot;</span>
            <span class="enscript-keyword">else</span>:
                out_string += <span class="enscript-string">&quot;BCL-m  &quot;</span>
                <span class="enscript-keyword">if</span> vopt:
                    out_string += <span class="enscript-string">&quot;(unpaired 4K cluster, mbuf) &quot;</span>
        <span class="enscript-keyword">return</span> out_string

    <span class="enscript-keyword">if</span> (csize == (MSIZE + M16KCLBYTES)):
        <span class="enscript-keyword">if</span> (mca.mca_uflags &amp; MB_SCVALID):
            <span class="enscript-keyword">if</span> (mca.mca_uptr):
                out_string += <span class="enscript-string">&quot;M+BCL  &quot;</span>
                <span class="enscript-keyword">if</span> vopt:
                    out_string += <span class="enscript-string">&quot;(paired mbuf, 4K cluster) &quot;</span>
            <span class="enscript-keyword">else</span>:
                out_string += <span class="enscript-string">&quot;M-BCL  &quot;</span>
                <span class="enscript-keyword">if</span> vopt:
                    out_string += <span class="enscript-string">&quot;(unpaired mbuf, 4K cluster) &quot;</span>
        <span class="enscript-keyword">else</span>:
            <span class="enscript-keyword">if</span> (mca.mca_uptr):
                out_string += <span class="enscript-string">&quot;BCL+M  &quot;</span>
                <span class="enscript-keyword">if</span> vopt:
                    out_string += <span class="enscript-string">&quot;(paired 4K cluster, mbuf) &quot;</span>
            <span class="enscript-keyword">else</span>:
                out_string += <span class="enscript-string">&quot;BCL-m  &quot;</span>
                <span class="enscript-keyword">if</span> vopt:
                    out_string += <span class="enscript-string">&quot;(unpaired 4K cluster, mbuf) &quot;</span>
        <span class="enscript-keyword">return</span> out_string

    out_string += <span class="enscript-string">&quot;unknown: &quot;</span> + cp.mc_name
    <span class="enscript-keyword">return</span> out_string

kgm_pkmod = 0
kgm_pkmodst = 0
kgm_pkmoden = 0

<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetPointerAsString</span>(kgm_pc):
    <span class="enscript-keyword">if</span> (kern.ptrsize == 8):
        pointer_format_string = <span class="enscript-string">&quot;0x{0:&lt;16x} &quot;</span>
    <span class="enscript-keyword">else</span>:
        pointer_format_string = <span class="enscript-string">&quot;0x{0:&lt;8x} &quot;</span>
    <span class="enscript-keyword">return</span> pointer_format_string.format(kgm_pc)

<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetKmodAddrIntAsString</span>(kgm_pc):
    <span class="enscript-keyword">global</span> kgm_pkmod
    <span class="enscript-keyword">global</span> kgm_pkmodst
    <span class="enscript-keyword">global</span> kgm_pkmoden

    out_string = <span class="enscript-string">&quot;&quot;</span>
    mh_execute_addr = int(lldb_run_command(<span class="enscript-string">'p/x (uintptr_t *)&amp;_mh_execute_header'</span>).split(<span class="enscript-string">'='</span>)[-1].strip(), 16)

    out_string += GetPointerAsString(kgm_pc)
    <span class="enscript-keyword">if</span> ((unsigned(kgm_pc) &gt;= unsigned(kgm_pkmodst)) <span class="enscript-keyword">and</span> (unsigned(kgm_pc) &lt; unsigned(kgm_pkmoden))):
            kgm_off = kgm_pc - kgm_pkmodst
            out_string += <span class="enscript-string">&quot;&lt;&quot;</span> + str(Cast(kgm_pkmod, <span class="enscript-string">'kmod_info_t *'</span>).name) + <span class="enscript-string">&quot; + 0x&quot;</span> + str(kgm_off) + <span class="enscript-string">&quot;&gt;&quot;</span>
    <span class="enscript-keyword">else</span>:
        kgm_kmodp = kern.globals.kmod
        <span class="enscript-keyword">if</span> ((kern.arch == <span class="enscript-string">'x86_64'</span>) <span class="enscript-keyword">and</span> (long(kgm_pc) &gt;= long(mh_execute_addr))):
            kgm_kmodp = 0

        <span class="enscript-keyword">while</span> kgm_kmodp:
            kgm_off = unsigned((kgm_pc - kgm_kmodp.address) &amp; 0x00000000ffffffff)
            <span class="enscript-keyword">if</span> ((long(kgm_kmodp.address) &lt;= long(kgm_pc)) <span class="enscript-keyword">and</span> (kgm_off) &lt; unsigned(kgm_kmodp.size)):
                kgm_pkmod = kgm_kmodp
                kgm_pkmodst = unsigned(kgm_kmodp.address)
                kgm_pkmoden = unsigned(kgm_pkmodst + kgm_kmodp.size)
                kgm_kmodp = 0
            <span class="enscript-keyword">else</span>:
                kgm_kmodp = kgm_kmodp.next
    <span class="enscript-keyword">return</span> out_string

<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetPc</span>(kgm_pc):
    out_string = <span class="enscript-string">&quot;&quot;</span>
    mh_execute_addr = int(lldb_run_command(<span class="enscript-string">'p/x (uintptr_t *)&amp;_mh_execute_header'</span>).split(<span class="enscript-string">'='</span>)[-1].strip(), 16)
    <span class="enscript-keyword">if</span> (unsigned(kgm_pc) &lt; unsigned(mh_execute_addr) <span class="enscript-keyword">or</span> unsigned(kgm_pc) &gt;= unsigned(kern.globals.vm_kernel_top)):
        out_string += GetKmodAddrIntAsString(kgm_pc)
    <span class="enscript-keyword">else</span>:
        out_string += GetSourceInformationForAddress(int(kgm_pc))
    <span class="enscript-keyword">return</span> out_string + <span class="enscript-string">&quot;\n&quot;</span>


<span class="enscript-comment"># Macro: mbuf_showactive
</span>@lldb_command(<span class="enscript-string">'mbuf_showactive'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">MbufShowActive</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Print all active/in-use mbuf objects
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> cmd_args:
        <span class="enscript-keyword">print</span> GetMbufWalkAllSlabs(1, 0, cmd_args[0])
    <span class="enscript-keyword">else</span>:
        <span class="enscript-keyword">print</span> GetMbufWalkAllSlabs(1, 0, 0)
<span class="enscript-comment"># EndMacro: mbuf_showactive
</span>

<span class="enscript-comment"># Macro: mbuf_showinactive
</span>@lldb_command(<span class="enscript-string">'mbuf_showinactive'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">MbufShowInactive</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Print all freed/in-cache mbuf objects
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">print</span> GetMbufWalkAllSlabs(0, 1, 0)
<span class="enscript-comment"># EndMacro: mbuf_showinactive
</span>

<span class="enscript-comment"># Macro: mbuf_showmca
</span>@lldb_command(<span class="enscript-string">'mbuf_showmca'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">MbufShowMca</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Print the contents of an mbuf mcache audit structure
    &quot;&quot;&quot;</span>
    out_string = <span class="enscript-string">&quot;&quot;</span>
    pgshift = unsigned(kern.globals.page_shift)
    <span class="enscript-keyword">if</span> cmd_args:
        mca = kern.GetValueFromAddress(cmd_args[0], <span class="enscript-string">'mcache_audit_t *'</span>)
        cp = mca.mca_cache
        out_string += <span class="enscript-string">&quot;object type:\t&quot;</span>
        out_string += GetMbufMcaCtype(mca, 1)
        out_string += <span class="enscript-string">&quot;\nControlling mcache :\t&quot;</span> + hex(mca.mca_cache) + <span class="enscript-string">&quot; (&quot;</span> + str(cp.mc_name) + <span class="enscript-string">&quot;)\n&quot;</span>
        <span class="enscript-keyword">if</span> (mca.mca_uflags &amp; MB_SCVALID):
            mbutl = Cast(kern.globals.mbutl, <span class="enscript-string">'unsigned char *'</span>)
            ix = (mca.mca_addr - mbutl) &gt;&gt; pgshift
            clbase = mbutl + (ix &lt;&lt; pgshift)
            mclidx = (mca.mca_addr - clbase) &gt;&gt; 8
            out_string += <span class="enscript-string">&quot;mbuf obj :\t\t&quot;</span> + hex(mca.mca_addr) + <span class="enscript-string">&quot;\n&quot;</span>
            out_string += <span class="enscript-string">&quot;mbuf index :\t\t&quot;</span> + str(mclidx + 1) + <span class="enscript-string">&quot; (out of 16) in cluster base &quot;</span> + hex(clbase) + <span class="enscript-string">&quot;\n&quot;</span>
            <span class="enscript-keyword">if</span> (int(mca.mca_uptr) != 0):
                peer_mca = cast(mca.mca_uptr, <span class="enscript-string">'mcache_audit_t *'</span>)
                out_string += <span class="enscript-string">&quot;paired cluster obj :\t&quot;</span> + hex(peer_mca.mca_addr) + <span class="enscript-string">&quot; (mca &quot;</span> + hex(peer_mca) + <span class="enscript-string">&quot;)\n&quot;</span>
            out_string += <span class="enscript-string">&quot;saved contents :\t&quot;</span> + hex(mca.mca_contents) + <span class="enscript-string">&quot; (&quot;</span> + str(int(mca.mca_contents_size)) + <span class="enscript-string">&quot; bytes)\n&quot;</span>
        <span class="enscript-keyword">else</span>:
            out_string += <span class="enscript-string">&quot;cluster obj :\t\t&quot;</span> + hex(mca.mca_addr) + <span class="enscript-string">&quot;\n&quot;</span>
            <span class="enscript-keyword">if</span> (mca.mca_uptr != 0):
                peer_mca = cast(mca.mca_uptr, <span class="enscript-string">'mcache_audit_t *'</span>)
                out_string += <span class="enscript-string">&quot;paired mbuf obj :\t&quot;</span> + hex(peer_mca.mca_addr) + <span class="enscript-string">&quot; (mca &quot;</span> + hex(peer_mca) + <span class="enscript-string">&quot;)\n&quot;</span>

        <span class="enscript-keyword">for</span> idx <span class="enscript-keyword">in</span> range(unsigned(kern.globals.mca_trn_max), 0, -1):
                trn = (mca.mca_next_trn + idx - 1) % unsigned(kern.globals.mca_trn_max)
                out_string += <span class="enscript-string">&quot;transaction {:d} (tstamp {:d}, thread 0x{:x}):\n&quot;</span>.format(trn, mca.mca_trns[trn].mca_tstamp, mca.mca_trns[trn].mca_thread)
                cnt = 0
                <span class="enscript-keyword">while</span> (cnt &lt; mca.mca_trns[trn].mca_depth):
                    kgm_pc = mca.mca_trns[trn].mca_stack[cnt]
                    out_string += <span class="enscript-string">&quot;  &quot;</span> + str(cnt + 1) + <span class="enscript-string">&quot;.  &quot;</span>
                    out_string += GetPc(kgm_pc)
                    cnt += 1

        msc = cast(mca.mca_contents, <span class="enscript-string">'mcl_saved_contents_t *'</span>)
        msa = addressof(msc.sc_scratch)
        <span class="enscript-keyword">if</span> (mca.mca_uflags &amp; MB_SCVALID):
            <span class="enscript-keyword">if</span> (msa.msa_depth &gt; 0):
                out_string += <span class="enscript-string">&quot;Recent scratch transaction (tstamp {:d}, thread 0x{:x}):\n&quot;</span>.format(msa.msa_tstamp, msa.msa_thread)
                cnt = 0
                <span class="enscript-keyword">while</span> (cnt &lt; msa.msa_depth):
                    kgm_pc = msa.msa_stack[cnt]
                    out_string += <span class="enscript-string">&quot;  &quot;</span> + str(cnt + 1) + <span class="enscript-string">&quot;.  &quot;</span>
                    out_string += GetPc(kgm_pc)
                    cnt += 1

            <span class="enscript-keyword">if</span> (msa.msa_pdepth &gt; 0):
                out_string += <span class="enscript-string">&quot;previous scratch transaction (tstamp {:d}, thread 0x{:x}):\n&quot;</span>.format(msa.msa_ptstamp, msa.msa_pthread)
        <span class="enscript-keyword">if</span> (msa):
            cnt = 0
            <span class="enscript-keyword">while</span> (cnt &lt; msa.msa_pdepth):
                kgm_pc = msa.msa_pstack[cnt]
                out_string += <span class="enscript-string">&quot;  &quot;</span> + str(cnt + 1) + <span class="enscript-string">&quot;.  &quot;</span>
                out_string += GetPc(kgm_pc)
                cnt += 1
    <span class="enscript-keyword">else</span>:
        out_string += <span class="enscript-string">&quot;Missing argument 0 in user function.&quot;</span>

    <span class="enscript-keyword">print</span> out_string
<span class="enscript-comment"># EndMacro: mbuf_showmca
</span>

<span class="enscript-comment"># Macro: mbuf_showall
</span>@lldb_command(<span class="enscript-string">'mbuf_showall'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">MbufShowAll</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Print all mbuf objects
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">print</span> GetMbufWalkAllSlabs(1, 1, 0)
<span class="enscript-comment"># EndMacro: mbuf_showall
</span>
<span class="enscript-comment"># Macro: mbuf_countchain
</span>@lldb_command(<span class="enscript-string">'mbuf_countchain'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">MbufCountChain</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Count the length of an mbuf chain
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> cmd_args:
        <span class="enscript-keyword">raise</span> ArgumentError(<span class="enscript-string">&quot;Missing argument 0 in user function.&quot;</span>)

    mp = kern.GetValueFromAddress(cmd_args[0], <span class="enscript-string">'mbuf *'</span>)

    pkt = 0
    nxt = 0

    <span class="enscript-keyword">while</span> (mp):
        pkt = pkt + 1
        mn = mp.m_hdr.mh_next
        <span class="enscript-keyword">while</span> (mn):
            nxt = nxt + 1
            mn = mn.m_hdr.mh_next

        mp = mp.m_hdr.mh_nextpkt

        <span class="enscript-keyword">if</span> (((pkt + nxt) % 50) == 0):
            <span class="enscript-keyword">print</span> <span class="enscript-string">&quot; ...&quot;</span> + str(pkt_nxt)

    <span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Total: &quot;</span> + str(pkt + nxt) + <span class="enscript-string">&quot; (via m_next: &quot;</span> + str(nxt) + <span class="enscript-string">&quot;)&quot;</span>
<span class="enscript-comment"># EndMacro: mbuf_countchain
</span>


<span class="enscript-comment"># Macro: mbuf_topleak
</span>@lldb_command(<span class="enscript-string">'mbuf_topleak'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">MbufTopLeak</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Print the top suspected mbuf leakers
    &quot;&quot;&quot;</span>
    topcnt = 0
    <span class="enscript-keyword">if</span> (int(len(cmd_args)) &gt; 0 <span class="enscript-keyword">and</span> int(cmd_args[0]) &lt; 5):
        maxcnt = cmd_args[0]
    <span class="enscript-keyword">else</span>:
        maxcnt = 5
    <span class="enscript-keyword">while</span> (topcnt &lt; maxcnt):
        <span class="enscript-keyword">print</span> GetMbufTraceLeak(kern.globals.mleak_top_trace[topcnt])
        topcnt += 1

<span class="enscript-comment"># EndMacro: mbuf_topleak
</span>
<span class="enscript-keyword">def</span> <span class="enscript-function-name">GetMbufTraceLeak</span>(trace):
    out_string = <span class="enscript-string">&quot;&quot;</span>
    <span class="enscript-keyword">if</span> (trace.allocs != 0):
        out_string += hex(trace) + <span class="enscript-string">&quot;:&quot;</span> + str(trace.allocs) + <span class="enscript-string">&quot; outstanding allocs\n&quot;</span>
        out_string += <span class="enscript-string">&quot;Backtrace saved &quot;</span> + str(trace.depth) + <span class="enscript-string">&quot; deep\n&quot;</span>
        <span class="enscript-keyword">if</span> (trace.depth != 0):
            cnt = 0
            <span class="enscript-keyword">while</span> (cnt &lt; trace.depth):
                out_string += str(cnt + 1) + <span class="enscript-string">&quot;: &quot;</span>
                out_string += GetPc(trace.addr[cnt])
                out_string += <span class="enscript-string">&quot;\n&quot;</span>
                cnt += 1
    <span class="enscript-keyword">return</span> out_string


<span class="enscript-comment"># Macro: mbuf_traceleak
</span>@lldb_command(<span class="enscript-string">'mbuf_traceleak'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">MbufTraceLeak</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Print the leak information for a given leak address
        Given an mbuf leak trace (mtrace) structure address, print out the
        stored information with that trace
        syntax: (lldb) mbuf_traceleak &lt;addr&gt;
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> cmd_args:
        <span class="enscript-keyword">raise</span> ArgumentError(<span class="enscript-string">&quot;Missing argument 0 in user function.&quot;</span>)

    trace = kern.GetValueFromAddress(cmd_args[0], <span class="enscript-string">'mtrace *'</span>)
    <span class="enscript-keyword">print</span> GetMbufTraceLeak(trace)
<span class="enscript-comment"># EndMacro: mbuf_traceleak
</span>

<span class="enscript-comment"># Macro: mcache_walkobj
</span>@lldb_command(<span class="enscript-string">'mcache_walkobj'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">McacheWalkObject</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Given a mcache object address, walk its obj_next pointer
    &quot;&quot;&quot;</span>
    <span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> cmd_args:
        <span class="enscript-keyword">raise</span> ArgumentError(<span class="enscript-string">&quot;Missing argument 0 in user function.&quot;</span>)

    out_string = <span class="enscript-string">&quot;&quot;</span>
    p = kern.GetValueFromAddress(cmd_args[0], <span class="enscript-string">'mcache_obj_t *'</span>)
    cnt = 1
    total = 0
    <span class="enscript-keyword">while</span> (p):
        mcache_object_format = <span class="enscript-string">&quot;{0:&gt;4d}: 0x{1:&gt;16x}&quot;</span>
        out_string += mcache_object_format.format(cnt, p) + <span class="enscript-string">&quot;\n&quot;</span>
        p = p.obj_next
        cnt += 1
    <span class="enscript-keyword">print</span> out_string
<span class="enscript-comment"># EndMacro: mcache_walkobj
</span>
<span class="enscript-comment"># Macro: mcache_stat
</span>@lldb_command(<span class="enscript-string">'mcache_stat'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">McacheStat</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot; Print all mcaches in the system.
    &quot;&quot;&quot;</span>
    head = kern.globals.mcache_head
    out_string = <span class="enscript-string">&quot;&quot;</span>
    mc = cast(head.lh_first, <span class="enscript-string">'mcache *'</span>)
    <span class="enscript-keyword">if</span> (kern.ptrsize == 8):
        mcache_stat_format_string = <span class="enscript-string">&quot;{0:&lt;24s} {1:&gt;8s} {2:&gt;20s} {3:&gt;5s} {4:&gt;5s} {5:&gt;20s} {6:&gt;30s} {7:&gt;18s}&quot;</span>
    <span class="enscript-keyword">else</span>:
        mcache_stat_format_string = <span class="enscript-string">&quot;{0:&lt;24s} {1:&gt;8s} {2:&gt;12s} {3:&gt;5s} {4:&gt;5s} {5:&gt;12s} {6:&gt;30s} {7:&gt;18s}&quot;</span>

    <span class="enscript-keyword">if</span> (kern.ptrsize == 8):
        mcache_stat_data_format_string = <span class="enscript-string">&quot;{0:&lt;24s} {1:&gt;12s} {2:&gt;20s} {3:&gt;5s} {4:&gt;5s} {5:&gt;22s} {6:&gt;12d} {7:&gt;8d} {8:&gt;8d} {9:&gt;18d}&quot;</span>
    <span class="enscript-keyword">else</span>:
        mcache_stat_data_format_string = <span class="enscript-string">&quot;{0:&lt;24s} {1:&gt;12s} {2:&gt;12s} {3:&gt;5s} {4:&gt;5s} {5:&gt;14s} {6:&gt;12d} {7:&gt;8d} {8:&gt;8d} {9:&gt;18d}&quot;</span>

    out_string += mcache_stat_format_string.format(<span class="enscript-string">&quot;cache name&quot;</span>, <span class="enscript-string">&quot;cache state&quot;</span>, <span class="enscript-string">&quot;cache addr&quot;</span>, <span class="enscript-string">&quot;buf size&quot;</span>, <span class="enscript-string">&quot;buf align&quot;</span>, <span class="enscript-string">&quot;backing zone&quot;</span>, <span class="enscript-string">&quot;wait     nowait     failed&quot;</span>, <span class="enscript-string">&quot;bufs incache&quot;</span>)
    out_string += <span class="enscript-string">&quot;\n&quot;</span>

    ncpu = int(kern.globals.ncpu)
    <span class="enscript-keyword">while</span> mc != 0:
        bktsize = mc.mc_cpu[0].cc_bktsize
        cache_state = <span class="enscript-string">&quot;&quot;</span>
        <span class="enscript-keyword">if</span> (mc.mc_flags &amp; MCF_NOCPUCACHE):
            cache_state = <span class="enscript-string">&quot;disabled&quot;</span>
        <span class="enscript-keyword">else</span>:
            <span class="enscript-keyword">if</span> (bktsize == 0):
                cache_state = <span class="enscript-string">&quot; offline&quot;</span>
            <span class="enscript-keyword">else</span>:
                cache_state = <span class="enscript-string">&quot; online&quot;</span>
        <span class="enscript-keyword">if</span> (mc.mc_slab_zone != 0):
            backing_zone = mc.mc_slab_zone
        <span class="enscript-keyword">else</span>:
            <span class="enscript-keyword">if</span> (kern.ptrsize == 8):
                backing_zone = <span class="enscript-string">&quot;            custom&quot;</span>
            <span class="enscript-keyword">else</span>:
                backing_zone = <span class="enscript-string">&quot;    custom&quot;</span>

        total = 0
        total += mc.mc_full.bl_total * bktsize
        n = 0
        <span class="enscript-keyword">while</span>(n &lt; ncpu):
            ccp = mc.mc_cpu[n]
            <span class="enscript-keyword">if</span> (ccp.cc_objs &gt; 0):
                total += ccp.cc_objs
            <span class="enscript-keyword">if</span> (ccp.cc_pobjs &gt; 0):
                total += ccp.cc_pobjs
            n += 1
            ccp += 1

        out_string += mcache_stat_data_format_string.format(mc.mc_name, cache_state, hex(mc), str(int(mc.mc_bufsize)), str(int(mc.mc_align)), hex(mc.mc_slab_zone), int(mc.mc_wretry_cnt), int(mc.mc_nwretry_cnt), int(mc.mc_nwfail_cnt), total)
        out_string += <span class="enscript-string">&quot;\n&quot;</span>
        mc = cast(mc.mc_list.le_next, <span class="enscript-string">'mcache *'</span>)
    <span class="enscript-keyword">print</span> out_string
<span class="enscript-comment"># EndMacro: mcache_stat
</span>
<span class="enscript-comment"># Macro: mcache_showcache
</span>@lldb_command(<span class="enscript-string">'mcache_showcache'</span>)
<span class="enscript-keyword">def</span> <span class="enscript-function-name">McacheShowCache</span>(cmd_args=None):
    <span class="enscript-string">&quot;&quot;&quot;Display the number of objects in cache.
    &quot;&quot;&quot;</span>
    out_string = <span class="enscript-string">&quot;&quot;</span>
    cp = kern.GetValueFromAddress(cmd_args[0], <span class="enscript-string">'mcache_t *'</span>)
    bktsize = cp.mc_cpu[0].cc_bktsize
    cnt = 0
    total = 0
    mcache_cache_format = <span class="enscript-string">&quot;{0:&lt;4d} {1:&gt;8d} {2:&gt;8d} {3:&gt;8d}&quot;</span>
    out_string += <span class="enscript-string">&quot;Showing cache &quot;</span> + str(cp.mc_name) + <span class="enscript-string">&quot; :\n\n&quot;</span>
    out_string += <span class="enscript-string">&quot; CPU  cc_objs cc_pobjs    total\n&quot;</span>
    out_string += <span class="enscript-string">&quot;----  ------- -------- --------\n&quot;</span>
    ncpu = int(kern.globals.ncpu)
    <span class="enscript-keyword">while</span> (cnt &lt; ncpu):
        ccp = cp.mc_cpu[cnt]
        objs = ccp.cc_objs
        <span class="enscript-keyword">if</span> (objs &lt;= 0):
            objs = 0
        pobjs = ccp.cc_pobjs
        <span class="enscript-keyword">if</span> (pobjs &lt;= 0):
            pobjs = 0
        tot_cpu = objs + pobjs
        total += tot_cpu
        out_string += mcache_cache_format.format(cnt, objs, pobjs, tot_cpu)
        out_string += <span class="enscript-string">&quot;\n&quot;</span>
        cnt += 1

    out_string += <span class="enscript-string">&quot;                       ========\n&quot;</span>
    out_string += <span class="enscript-string">&quot;                           &quot;</span> + str(total) + <span class="enscript-string">&quot;\n\n&quot;</span>
    total += cp.mc_full.bl_total * bktsize

    out_string += <span class="enscript-string">&quot;Total # of full buckets (&quot;</span> + str(int(bktsize)) + <span class="enscript-string">&quot; objs/bkt):\t&quot;</span> + str(int(cp.mc_full.bl_total)) + <span class="enscript-string">&quot;\n&quot;</span>
    out_string += <span class="enscript-string">&quot;Total # of objects cached:\t\t&quot;</span> + str(total) + <span class="enscript-string">&quot;\n&quot;</span>
    <span class="enscript-keyword">print</span> out_string
<span class="enscript-comment"># EndMacro: mcache_showcache
</span></pre>
<hr />
</body></html>