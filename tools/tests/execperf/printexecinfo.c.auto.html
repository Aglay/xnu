<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>printexecinfo.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">printexecinfo.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdio.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;err.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;crt_externs.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/mach.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach-o/ldsyms.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach-o/dyld_images.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach-o/arch.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdlib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/sysctl.h&gt;</span>

<span class="enscript-function-name">__attribute__</span>((constructor))
<span class="enscript-type">void</span> <span class="enscript-function-name">init</span>(<span class="enscript-type">int</span> argc, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *argv[], <span class="enscript-type">const</span> <span class="enscript-type">char</span> *envp[], <span class="enscript-type">const</span> <span class="enscript-type">char</span> *appl[], <span class="enscript-type">void</span> *vars __attribute__((unused))) {
	<span class="enscript-type">int</span> i;

	printf(<span class="enscript-string">&quot;argv = %p\n&quot;</span>, argv);
	<span class="enscript-keyword">for</span> (i=0; argv[i]; i++) {
		printf(<span class="enscript-string">&quot;argv[%2d] = %p %.100s%s\n&quot;</span>, i, argv[i], argv[i], strlen(argv[i]) &gt; 100 ? <span class="enscript-string">&quot;...&quot;</span> : <span class="enscript-string">&quot;&quot;</span>);
	}
	printf(<span class="enscript-string">&quot;envp = %p\n&quot;</span>, envp);
	<span class="enscript-keyword">for</span> (i=0; envp[i]; i++) {
		printf(<span class="enscript-string">&quot;envp[%2d] = %p %.100s%s\n&quot;</span>, i, envp[i], envp[i], strlen(envp[i]) &gt; 100 ? <span class="enscript-string">&quot;...&quot;</span> : <span class="enscript-string">&quot;&quot;</span>);
	}
	printf(<span class="enscript-string">&quot;appl = %p\n&quot;</span>, appl);
	<span class="enscript-keyword">for</span> (i=0; appl[i]; i++) {
		printf(<span class="enscript-string">&quot;appl[%2d] = %p %.100s%s\n&quot;</span>, i, appl[i], appl[i], strlen(appl[i]) &gt; 100 ? <span class="enscript-string">&quot;...&quot;</span> : <span class="enscript-string">&quot;&quot;</span>);
	}
}

<span class="enscript-type">void</span> <span class="enscript-function-name">printexecinfo</span>(<span class="enscript-type">void</span>)
{
	<span class="enscript-type">int</span> ret;
	uint64_t stackaddr;
	size_t len = <span class="enscript-keyword">sizeof</span>(stackaddr);
	<span class="enscript-type">const</span> NXArchInfo *arch = NXGetArchInfoFromCpuType(_mh_execute_header.cputype, _mh_execute_header.cpusubtype &amp; ~CPU_SUBTYPE_MASK);

	printf(<span class="enscript-string">&quot;executable load address = 0x%016llx\n&quot;</span>, (uint64_t)(uintptr_t)&amp;_mh_execute_header);
	printf(<span class="enscript-string">&quot;executable cputype 0x%08x cpusubtype 0x%08x (%s:%s)\n&quot;</span>,
		   _mh_execute_header.cputype,
		   _mh_execute_header.cpusubtype,
		   arch ? arch-&gt;name : <span class="enscript-string">&quot;unknown&quot;</span>,
		   arch ? arch-&gt;description : <span class="enscript-string">&quot;unknown&quot;</span>);

	ret = sysctlbyname(<span class="enscript-string">&quot;kern.usrstack64&quot;</span>, &amp;stackaddr, &amp;len, NULL, 0);
	<span class="enscript-keyword">if</span> (ret == -1)
		err(1, <span class="enscript-string">&quot;sysctlbyname&quot;</span>);

	printf(<span class="enscript-string">&quot;          stack address = 0x%016llx\n&quot;</span>, stackaddr);
}

<span class="enscript-type">void</span> <span class="enscript-function-name">printdyldinfo</span>(<span class="enscript-type">void</span>)
{
	task_dyld_info_data_t info;
	mach_msg_type_number_t size = TASK_DYLD_INFO_COUNT;
	kern_return_t kret;
	<span class="enscript-type">struct</span> dyld_all_image_infos *all_image_infos;
	
	kret = task_info(mach_task_self(), TASK_DYLD_INFO,
					 (<span class="enscript-type">void</span> *)&amp;info, &amp;size);
	<span class="enscript-keyword">if</span> (kret != KERN_SUCCESS)
		errx(1, <span class="enscript-string">&quot;task_info: %s&quot;</span>, mach_error_string(kret));

	all_image_infos = (<span class="enscript-type">struct</span> dyld_all_image_infos *)(uintptr_t)info.all_image_info_addr;

	printf(<span class="enscript-string">&quot;      dyld load address = 0x%016llx\n&quot;</span>, (uint64_t)(uintptr_t)all_image_infos-&gt;dyldImageLoadAddress);
	printf(<span class="enscript-string">&quot;     shared cache slide = 0x%016llx\n&quot;</span>, (uint64_t)(uintptr_t)all_image_infos-&gt;sharedCacheSlide);

}

<span class="enscript-type">int</span> <span class="enscript-function-name">main</span>(<span class="enscript-type">int</span> argc, <span class="enscript-type">char</span> *argv[]) {

	printexecinfo();
	printdyldinfo();

	<span class="enscript-keyword">return</span> 0;
}
</pre>
<hr />
</body></html>