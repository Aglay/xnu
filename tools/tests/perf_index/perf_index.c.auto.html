<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>perf_index.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">perf_index.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdlib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;dlfcn.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdio.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/param.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/time.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;pthread.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;assert.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach-o/dyld.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;libgen.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;unistd.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;fail.h&quot;</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> parsed_args_struct {
    <span class="enscript-type">char</span>* my_name;
    <span class="enscript-type">char</span>* test_name;
    <span class="enscript-type">int</span> num_threads;
    <span class="enscript-type">long</span> <span class="enscript-type">long</span> length;
    <span class="enscript-type">int</span> test_argc;
    <span class="enscript-type">void</span>** test_argv;
} parsed_args_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> test_struct {
    <span class="enscript-type">int</span> (*setup)(<span class="enscript-type">int</span>, <span class="enscript-type">long</span> <span class="enscript-type">long</span>, <span class="enscript-type">int</span>, <span class="enscript-type">void</span>**);
    <span class="enscript-type">int</span> (*execute)(<span class="enscript-type">int</span>, <span class="enscript-type">int</span>, <span class="enscript-type">long</span> <span class="enscript-type">long</span>, <span class="enscript-type">int</span>, <span class="enscript-type">void</span>**);
    <span class="enscript-type">int</span> (*cleanup)(<span class="enscript-type">int</span>, <span class="enscript-type">long</span> <span class="enscript-type">long</span>);
    <span class="enscript-type">char</span>** error_str_ptr;
} test_t;

parsed_args_t args;
test_t test;
<span class="enscript-type">int</span> ready_thread_count;
pthread_mutex_t ready_thread_count_lock;
pthread_cond_t start_cvar;
pthread_cond_t threads_ready_cvar;

<span class="enscript-type">int</span> <span class="enscript-function-name">parse_args</span>(<span class="enscript-type">int</span> argc, <span class="enscript-type">char</span>** argv, parsed_args_t* parsed_args) {
    <span class="enscript-keyword">if</span>(argc != 4) {
        <span class="enscript-keyword">return</span> -1;
    }

    parsed_args-&gt;my_name = argv[0];
    parsed_args-&gt;test_name = argv[1];
    parsed_args-&gt;num_threads = atoi(argv[2]);
    parsed_args-&gt;length = strtoll(argv[3], NULL, 10);
    parsed_args-&gt;test_argc = 0;
    parsed_args-&gt;test_argv = NULL;
    <span class="enscript-keyword">return</span> 0;
}

<span class="enscript-type">void</span> <span class="enscript-function-name">print_usage</span>(<span class="enscript-type">char</span>** argv) {
    printf(<span class="enscript-string">&quot;Usage: %s test_name threads length\n&quot;</span>, argv[0]);
}

<span class="enscript-type">int</span> <span class="enscript-function-name">find_test</span>(<span class="enscript-type">char</span>* test_name, <span class="enscript-type">char</span>* test_path) {
    <span class="enscript-type">char</span> binpath[MAXPATHLEN];
    <span class="enscript-type">char</span>* dirpath;
    uint32_t size = <span class="enscript-keyword">sizeof</span>(binpath);
    <span class="enscript-type">int</span> retval;

    retval = _NSGetExecutablePath(binpath, &amp;size);
    assert(retval == 0);
    dirpath = dirname(binpath);

    snprintf(test_path, MAXPATHLEN, <span class="enscript-string">&quot;%s/perfindex-%s.dylib&quot;</span>, dirpath, test_name);
    <span class="enscript-keyword">if</span>(access(test_path, F_OK) == 0)
        <span class="enscript-keyword">return</span> 0;
    <span class="enscript-keyword">else</span>
        <span class="enscript-keyword">return</span> -1;
}

<span class="enscript-type">int</span> <span class="enscript-function-name">load_test</span>(<span class="enscript-type">char</span>* path, test_t* test) {
    <span class="enscript-type">void</span>* handle;
    <span class="enscript-type">void</span>* p;

    handle = dlopen(path, RTLD_NOW | RTLD_LOCAL);
    <span class="enscript-keyword">if</span>(!handle) {
        <span class="enscript-keyword">return</span> -1;
    }


    p = dlsym(handle, <span class="enscript-string">&quot;setup&quot;</span>);
    test-&gt;setup = (<span class="enscript-type">int</span> (*)(<span class="enscript-type">int</span>, <span class="enscript-type">long</span> <span class="enscript-type">long</span>, <span class="enscript-type">int</span>, <span class="enscript-type">void</span> **))p;

    p = dlsym(handle, <span class="enscript-string">&quot;execute&quot;</span>);
    test-&gt;execute = (<span class="enscript-type">int</span> (*)(<span class="enscript-type">int</span>, <span class="enscript-type">int</span>, <span class="enscript-type">long</span> <span class="enscript-type">long</span>, <span class="enscript-type">int</span>, <span class="enscript-type">void</span> **))p;
    <span class="enscript-keyword">if</span>(p == NULL)
        <span class="enscript-keyword">return</span> -1;

    p = dlsym(handle, <span class="enscript-string">&quot;cleanup&quot;</span>);
    test-&gt;cleanup = (<span class="enscript-type">int</span> (*)(<span class="enscript-type">int</span>, <span class="enscript-type">long</span> <span class="enscript-type">long</span>))p;

    p = dlsym(handle, <span class="enscript-string">&quot;error_str&quot;</span>);
    test-&gt;error_str_ptr = (<span class="enscript-type">char</span>**)p;

    <span class="enscript-keyword">return</span> 0;
}

<span class="enscript-type">void</span> <span class="enscript-function-name">start_timer</span>(<span class="enscript-type">struct</span> timeval *tp) {
  gettimeofday(tp, NULL);
}

<span class="enscript-type">void</span> <span class="enscript-function-name">end_timer</span>(<span class="enscript-type">struct</span> timeval *tp) {
  <span class="enscript-type">struct</span> timeval tend;
  gettimeofday(&amp;tend, NULL);
  <span class="enscript-keyword">if</span>(tend.tv_usec &gt;= tp-&gt;tv_usec) {
    tp-&gt;tv_sec = tend.tv_sec - tp-&gt;tv_sec;
    tp-&gt;tv_usec = tend.tv_usec - tp-&gt;tv_usec;
  }
  <span class="enscript-keyword">else</span> {
    tp-&gt;tv_sec = tend.tv_sec - tp-&gt;tv_sec - 1;
    tp-&gt;tv_usec = tend.tv_usec - tp-&gt;tv_usec + 1000000;
  }
}

<span class="enscript-type">void</span> <span class="enscript-function-name">print_timer</span>(<span class="enscript-type">struct</span> timeval *tp) {
  printf(<span class="enscript-string">&quot;%ld.%06d\n&quot;</span>, tp-&gt;tv_sec, tp-&gt;tv_usec);
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span>* <span class="enscript-function-name">thread_setup</span>(<span class="enscript-type">void</span> *arg) {
  <span class="enscript-type">int</span> my_index = (<span class="enscript-type">int</span>)arg;
  <span class="enscript-type">long</span> <span class="enscript-type">long</span> work_size = args.length / args.num_threads;
  <span class="enscript-type">int</span> work_remainder = args.length % args.num_threads;

  <span class="enscript-keyword">if</span>(work_remainder &gt; my_index) {
    work_size++;
  }

  pthread_mutex_lock(&amp;ready_thread_count_lock);
  ready_thread_count++;
  <span class="enscript-keyword">if</span>(ready_thread_count == args.num_threads)
    pthread_cond_signal(&amp;threads_ready_cvar);
  pthread_cond_wait(&amp;start_cvar, &amp;ready_thread_count_lock);
  pthread_mutex_unlock(&amp;ready_thread_count_lock);
  test.execute(my_index, args.num_threads, work_size, args.test_argc, args.test_argv);
  <span class="enscript-keyword">return</span> NULL;
}

<span class="enscript-type">int</span> <span class="enscript-function-name">main</span>(<span class="enscript-type">int</span> argc, <span class="enscript-type">char</span>** argv) {
    <span class="enscript-type">int</span> retval;
    <span class="enscript-type">int</span> thread_index;
    <span class="enscript-type">struct</span> timeval timer;
    pthread_t* threads;
    <span class="enscript-type">int</span> thread_retval;
    <span class="enscript-type">void</span>* thread_retval_ptr = &amp;thread_retval;
    <span class="enscript-type">char</span> test_path[MAXPATHLEN];

    retval = parse_args(argc, argv, &amp;args);
    <span class="enscript-keyword">if</span>(retval) {
        print_usage(argv);
        <span class="enscript-keyword">return</span> -1;
    }

    retval = find_test(args.test_name, test_path);
    <span class="enscript-keyword">if</span>(retval) {
        printf(<span class="enscript-string">&quot;Unable to find test %s\n&quot;</span>, args.test_name);
        <span class="enscript-keyword">return</span> -1;
    }

    load_test(test_path, &amp;test);
    <span class="enscript-keyword">if</span>(retval) {
        printf(<span class="enscript-string">&quot;Unable to load test %s\n&quot;</span>, args.test_name);
        <span class="enscript-keyword">return</span> -1;
    }

    pthread_cond_init(&amp;threads_ready_cvar, NULL);
    pthread_cond_init(&amp;start_cvar, NULL);
    pthread_mutex_init(&amp;ready_thread_count_lock, NULL);
    ready_thread_count = 0;

    <span class="enscript-keyword">if</span>(test.setup) {
        retval = test.setup(args.num_threads, args.length, 0, NULL);
        <span class="enscript-keyword">if</span>(retval == PERFINDEX_FAILURE) {
            fprintf(stderr, <span class="enscript-string">&quot;Test setup failed: %s\n&quot;</span>, *test.error_str_ptr);
            <span class="enscript-keyword">return</span> -1;
        }
    }

    threads = (pthread_t*)malloc(<span class="enscript-keyword">sizeof</span>(pthread_t)*args.num_threads);
    <span class="enscript-keyword">for</span>(thread_index = 0; thread_index &lt; args.num_threads; thread_index++) {
        retval = pthread_create(&amp;threads[thread_index], NULL, thread_setup, (<span class="enscript-type">void</span>*)(<span class="enscript-type">long</span>)thread_index);
        assert(retval == 0);
    }

    pthread_mutex_lock(&amp;ready_thread_count_lock);
    <span class="enscript-keyword">if</span>(ready_thread_count != args.num_threads) {
        pthread_cond_wait(&amp;threads_ready_cvar, &amp;ready_thread_count_lock);
    }
    pthread_mutex_unlock(&amp;ready_thread_count_lock);

    start_timer(&amp;timer);
    pthread_cond_broadcast(&amp;start_cvar);
    <span class="enscript-keyword">for</span>(thread_index = 0; thread_index &lt; args.num_threads; thread_index++) {
        pthread_join(threads[thread_index], &amp;thread_retval_ptr);
        <span class="enscript-keyword">if</span>(**test.error_str_ptr) {
            printf(<span class="enscript-string">&quot;Test failed: %s\n&quot;</span>, *test.error_str_ptr);
        }
    }
    end_timer(&amp;timer);

    <span class="enscript-keyword">if</span>(test.cleanup)
        retval = test.cleanup(args.num_threads, args.length);
        <span class="enscript-keyword">if</span>(retval == PERFINDEX_FAILURE) {
            fprintf(stderr, <span class="enscript-string">&quot;Test cleanup failed: %s\n&quot;</span>, *test.error_str_ptr);
            free(threads);
            <span class="enscript-keyword">return</span> -1;
        }

    print_timer(&amp;timer);

    free(threads);

    <span class="enscript-keyword">return</span> 0;
}
</pre>
<hr />
</body></html>