<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>test_file_helper.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">test_file_helper.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;test_file_helper.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;fail.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdlib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;fcntl.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/param.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;assert.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdio.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;strings.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;unistd.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;pthread.h&gt;</span>

<span class="enscript-type">static</span> <span class="enscript-type">char</span> readbuff[4096];
<span class="enscript-type">static</span> <span class="enscript-type">char</span> writebuff[4096];
<span class="enscript-type">static</span> <span class="enscript-type">int</span>* fds = NULL;

<span class="enscript-type">char</span>* <span class="enscript-function-name">setup_tempdir</span>(<span class="enscript-type">char</span>* buf) {
    strcpy(buf, <span class="enscript-string">&quot;/tmp/perfindex.XXXXXX&quot;</span>);
    <span class="enscript-keyword">return</span> mkdtemp(buf);
}

<span class="enscript-type">int</span> <span class="enscript-function-name">cleanup_tempdir</span>(<span class="enscript-type">char</span>* path) {
    <span class="enscript-keyword">return</span> rmdir(path);
}

<span class="enscript-type">int</span> <span class="enscript-function-name">test_file_create</span>(<span class="enscript-type">char</span>* path, <span class="enscript-type">int</span> thread_id, <span class="enscript-type">int</span> num_threads, <span class="enscript-type">long</span> <span class="enscript-type">long</span> length) {
  <span class="enscript-type">long</span> <span class="enscript-type">long</span> i;
  <span class="enscript-type">int</span> fd;
  <span class="enscript-type">int</span> retval;
  <span class="enscript-type">char</span> filepath[MAXPATHLEN];

  <span class="enscript-keyword">for</span>(i=0; i&lt;length; i++) {
    snprintf(filepath, MAXPATHLEN, <span class="enscript-string">&quot;%s/file_create-%d-%lld&quot;</span>, path, thread_id, i);
    fd = open(filepath, O_CREAT | O_EXCL | O_WRONLY, 0644);
    VERIFY(fd &gt;= 0, <span class="enscript-string">&quot;open failed&quot;</span>);

    close(fd);
  }

  <span class="enscript-keyword">for</span>(i=0; i&lt;length; i++) {
    snprintf(filepath, MAXPATHLEN, <span class="enscript-string">&quot;%s/file_create-%d-%lld&quot;</span>, path, thread_id, i);
    retval = unlink(filepath);
    VERIFY(retval == 0, <span class="enscript-string">&quot;unlink failed&quot;</span>);
  }

  <span class="enscript-keyword">return</span> PERFINDEX_SUCCESS;
}

<span class="enscript-type">int</span> <span class="enscript-function-name">test_file_read_setup</span>(<span class="enscript-type">char</span>* path, <span class="enscript-type">int</span> num_threads, <span class="enscript-type">long</span> <span class="enscript-type">long</span> length, <span class="enscript-type">long</span> <span class="enscript-type">long</span> max_file_size) {
    <span class="enscript-type">int</span> fd;
    <span class="enscript-type">char</span> filepath[MAXPATHLEN];
    <span class="enscript-type">long</span> <span class="enscript-type">long</span> left;
    <span class="enscript-type">int</span> retval;
    size_t writelen;

    <span class="enscript-keyword">if</span>(max_file_size == 0)
        max_file_size = MAXFILESIZE;

    left = MIN(length, max_file_size/num_threads);

    snprintf(filepath, <span class="enscript-keyword">sizeof</span>(filepath), <span class="enscript-string">&quot;%s/file_read&quot;</span>, path);
    fd = open(filepath, O_CREAT | O_EXCL | O_WRONLY, 0644);
    printf(<span class="enscript-string">&quot;%d\n&quot;</span>, fd);
    VERIFY(fd &gt;= 0, <span class="enscript-string">&quot;open failed&quot;</span>);

    bzero(readbuff, <span class="enscript-keyword">sizeof</span>(readbuff));

    <span class="enscript-keyword">while</span>(left &gt; 0) {
        writelen = <span class="enscript-keyword">sizeof</span>(readbuff) &lt; left ? <span class="enscript-keyword">sizeof</span>(readbuff) : left;
        retval = write(fd, readbuff, writelen);
        VERIFY(retval == writelen, <span class="enscript-string">&quot;write failed&quot;</span>);
        left -= writelen;
    }

    <span class="enscript-keyword">return</span> PERFINDEX_SUCCESS;
}

<span class="enscript-type">int</span> <span class="enscript-function-name">test_file_read</span>(<span class="enscript-type">char</span>* path, <span class="enscript-type">int</span> thread_id, <span class="enscript-type">int</span> num_threads, <span class="enscript-type">long</span> <span class="enscript-type">long</span> length, <span class="enscript-type">long</span> <span class="enscript-type">long</span> max_file_size) {
    <span class="enscript-type">long</span> <span class="enscript-type">long</span> left;
    size_t file_offset = 0;
    <span class="enscript-type">int</span> readlen;
    <span class="enscript-type">int</span> fd;
    <span class="enscript-type">int</span> retval;
    <span class="enscript-type">char</span> filepath[MAXPATHLEN];
    <span class="enscript-type">long</span> <span class="enscript-type">long</span> filesize;


    <span class="enscript-keyword">if</span>(max_file_size == 0)
        max_file_size = MAXFILESIZE;
    filesize =  MIN(length, max_file_size/num_threads);

    snprintf(filepath, <span class="enscript-keyword">sizeof</span>(filepath), <span class="enscript-string">&quot;%s/file_read&quot;</span>, path);
    fd = open(filepath, O_RDONLY);
    VERIFY(fd &gt;= 0, <span class="enscript-string">&quot;open failed&quot;</span>);

    <span class="enscript-keyword">for</span>(left=length; left&gt;0;) {
        readlen = <span class="enscript-keyword">sizeof</span>(readbuff) &lt; left ? <span class="enscript-keyword">sizeof</span>(readbuff) : left;
        <span class="enscript-keyword">if</span>(file_offset+readlen &gt; filesize) {
            retval = lseek(fd, 0, SEEK_SET);


            VERIFY(retval &gt;= 0, <span class="enscript-string">&quot;lseek failed&quot;</span>);

            file_offset = 0;
            <span class="enscript-keyword">continue</span>;
        }
        retval = read(fd, readbuff, readlen);
        VERIFY(retval == readlen, <span class="enscript-string">&quot;read failed&quot;</span>);
        left -= readlen;
        file_offset += readlen;
    }
    <span class="enscript-keyword">return</span> PERFINDEX_SUCCESS;
}

<span class="enscript-type">int</span> <span class="enscript-function-name">test_file_read_cleanup</span>(<span class="enscript-type">char</span>* path, <span class="enscript-type">int</span> num_threads, <span class="enscript-type">long</span> <span class="enscript-type">long</span> length) {
    <span class="enscript-type">char</span> filepath[MAXPATHLEN];
    <span class="enscript-type">int</span> retval;

    snprintf(filepath, <span class="enscript-keyword">sizeof</span>(filepath), <span class="enscript-string">&quot;%s/file_read&quot;</span>, path);
    retval = unlink(filepath);
    VERIFY(retval == 0, <span class="enscript-string">&quot;unlink failed&quot;</span>);

    <span class="enscript-keyword">return</span> PERFINDEX_SUCCESS;
}

<span class="enscript-type">int</span> <span class="enscript-function-name">test_file_write_setup</span>(<span class="enscript-type">char</span>* path, <span class="enscript-type">int</span> num_threads, <span class="enscript-type">long</span> <span class="enscript-type">long</span> length) {
    <span class="enscript-type">int</span> i;
    <span class="enscript-type">char</span> filepath[MAXPATHLEN];

    <span class="enscript-keyword">if</span>(fds == NULL) {
        fds = (<span class="enscript-type">int</span>*)malloc(<span class="enscript-keyword">sizeof</span>(<span class="enscript-type">int</span>)*num_threads);
        VERIFY(fds, <span class="enscript-string">&quot;malloc failed&quot;</span>);
    }

    <span class="enscript-keyword">for</span>(i=0; i&lt;num_threads; i++) {
        snprintf(filepath, <span class="enscript-keyword">sizeof</span>(filepath), <span class="enscript-string">&quot;%s/file_write-%d&quot;</span>, path, i);
        fds[i] = open(filepath, O_CREAT | O_EXCL | O_WRONLY, 0644);
        <span class="enscript-keyword">if</span>(fds[i] &lt; 0) {
            free(fds);
            fds = NULL;
            FAIL(<span class="enscript-string">&quot;open failed&quot;</span>);
        }
    }

    bzero(writebuff, <span class="enscript-keyword">sizeof</span>(writebuff));

    <span class="enscript-keyword">return</span> PERFINDEX_SUCCESS;
}

<span class="enscript-type">int</span> <span class="enscript-function-name">test_file_write</span>(<span class="enscript-type">char</span>* path, <span class="enscript-type">int</span> thread_id, <span class="enscript-type">int</span> num_threads, <span class="enscript-type">long</span> <span class="enscript-type">long</span> length, <span class="enscript-type">long</span> <span class="enscript-type">long</span> max_file_size) {
    <span class="enscript-type">long</span> <span class="enscript-type">long</span> left;
    size_t file_offset = 0;
    <span class="enscript-type">int</span> writelen;
    <span class="enscript-type">int</span> retval;
    <span class="enscript-type">int</span> fd = fds[thread_id];

    <span class="enscript-keyword">if</span>(max_file_size == 0)
        max_file_size = MAXFILESIZE;

    <span class="enscript-keyword">for</span>(left=length; left&gt;0;) {
        writelen = <span class="enscript-keyword">sizeof</span>(writebuff) &lt; left ? <span class="enscript-keyword">sizeof</span>(writebuff) : left;
        retval = write(fd, writebuff, writelen);
        VERIFY(retval == writelen, <span class="enscript-string">&quot;write failed&quot;</span>);

        left -= writelen;
        file_offset += writelen;
        <span class="enscript-keyword">if</span>(file_offset&gt;max_file_size/num_threads) {
            retval = lseek(fd, 0, SEEK_SET);
            VERIFY(retval &gt;= 0, <span class="enscript-string">&quot;leeks failed&quot;</span>);
            file_offset = 0;
        }
    }

    <span class="enscript-keyword">return</span> PERFINDEX_SUCCESS;
}


<span class="enscript-type">int</span> <span class="enscript-function-name">test_file_write_cleanup</span>(<span class="enscript-type">char</span>* path, <span class="enscript-type">int</span> num_threads, <span class="enscript-type">long</span> <span class="enscript-type">long</span> length) {
    <span class="enscript-type">int</span> i;
    <span class="enscript-type">char</span> filepath[MAXPATHLEN];
    <span class="enscript-type">int</span> retval;

    <span class="enscript-keyword">for</span>(i=0; i&lt;num_threads; i++) {
        snprintf(filepath, <span class="enscript-keyword">sizeof</span>(filepath), <span class="enscript-string">&quot;%s/file_write-%d&quot;</span>, path, i);
        retval = unlink(filepath);
        VERIFY(retval == 0, <span class="enscript-string">&quot;unlink failed&quot;</span>);
    }

    <span class="enscript-keyword">return</span> PERFINDEX_SUCCESS;
}
</pre>
<hr />
</body></html>