<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>kqueue_file_tests.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">kqueue_file_tests.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;errno.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;pwd.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdarg.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdio.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdlib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;unistd.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;fcntl.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;pthread.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;poll.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/event.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/time.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/stat.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/mman.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/xattr.h&gt;</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIR1</span> 	<span class="enscript-string">&quot;dir1&quot;</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DOTDOT</span> 	<span class="enscript-string">&quot;..&quot;</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DIR2</span> 	<span class="enscript-string">&quot;dir2&quot;</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">FILE1</span>	<span class="enscript-string">&quot;file1&quot;</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">FILE2</span> 	<span class="enscript-string">&quot;file2&quot;</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">KEY</span>	<span class="enscript-string">&quot;somekey&quot;</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VAL</span>	<span class="enscript-string">&quot;someval&quot;</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">NOSLEEP</span>		0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SLEEP</span>		1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">NO_EVENT</span>	0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">YES_EVENT</span>	1


#<span class="enscript-reference">define</span> <span class="enscript-variable-name">OUTPUT_LEVEL</span> 	2
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">RESULT_LEVEL</span>	3

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TEST_STRING</span>	<span class="enscript-string">&quot;Some text!!! Yes indeed, some of that very structure which has passed on man's knowledge for generations.&quot;</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">HELLO_WORLD</span>	<span class="enscript-string">&quot;Hello, World!&quot;</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SLEEP_TIME</span>	2
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">WAIT_TIME</span>	(4l)
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LENGTHEN_SIZE</span>	500
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">FIFO_SPACE</span>	8192	<span class="enscript-comment">/* FIFOS have 8K of buffer space */</span>

<span class="enscript-comment">/*
 * Types of actions for setup, cleanup, and execution of tests
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> {CREAT, MKDIR, READ, WRITE, WRITEFD, FILLFD, UNLINK, LSKEE, RMDIR, MKFIFO, LENGTHEN, TRUNC,
	SYMLINK, CHMOD, CHOWN, EXCHANGEDATA, RENAME, LSEEK, OPEN, MMAP, NOTHING,
	SETXATTR, UTIMES, STAT, HARDLINK, REVOKE} action_id_t;

<span class="enscript-comment">/* 
 * Directs an action as mentioned above
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> _action {
	<span class="enscript-type">int</span> 		act_dosleep;
	action_id_t 	act_id;
	<span class="enscript-type">void</span> 		*act_args[5];
	<span class="enscript-type">int</span>		act_fd;
} action_t;

<span class="enscript-comment">/*
 * A test case.  Specifies setup, an event to look for, an action to take to
 * cause (or not cause) that event, and cleanup.
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> _test {
	<span class="enscript-type">char</span> *t_testname;
	
	<span class="enscript-comment">/* Test kevent() or poll() */</span>
	<span class="enscript-type">int</span> 	t_is_poll_test;	
	
	<span class="enscript-comment">/* Actions for setting up test */</span>
	<span class="enscript-type">int</span> 	 t_n_prep_actions;
	action_t t_prep_actions[5];
	
	<span class="enscript-comment">/* Actions for cleaning up test */</span>
	<span class="enscript-type">int</span> 	 t_n_cleanup_actions;
	action_t t_cleanup_actions[5];
	
	<span class="enscript-comment">/* Action for thred to take while we wait */</span>
	action_t t_helpthreadact;
	
	<span class="enscript-comment">/* File to look for event on */</span>
	<span class="enscript-type">char</span> 	 *t_watchfile; 	<span class="enscript-comment">/* set event ident IN TEST (can't know fd beforehand)*/</span>
	<span class="enscript-type">int</span>	 t_file_is_fifo;<span class="enscript-comment">/* FIFOs are handled in a special manner */</span>
	
	<span class="enscript-comment">/* Different parameters for poll() vs kevent() */</span>
	<span class="enscript-type">union</span> { 
		<span class="enscript-type">struct</span> kevent	tu_kev;
		<span class="enscript-type">short</span>		tu_pollevents;
	} t_union;
	
	<span class="enscript-comment">/* Do we expect results? */</span>
	<span class="enscript-type">int</span>	 t_want_event;
	
	<span class="enscript-comment">/* Not always used--how much data should we find (EVFILT_{READ,WRITE}) */</span>
	<span class="enscript-type">int</span>	 t_nbytes;
	
	<span class="enscript-comment">/* Hacks for FILT_READ and pipes */</span>
	<span class="enscript-type">int</span> 	 t_read_to_end_first; 	<span class="enscript-comment">/* Consume all data in file before waiting for event */</span>
	<span class="enscript-type">int</span> 	 t_write_some_data; 	<span class="enscript-comment">/* Write some data to file before waiting for event (FIFO hack) */</span>
	<span class="enscript-type">int</span>	 t_extra_sleep_hack;	<span class="enscript-comment">/* Sleep before waiting, to let a fifo fill up with data */</span>
} test_t;

<span class="enscript-comment">/*
 * Extra logging infrastructure so we can filter some out
 */</span>
<span class="enscript-type">void</span> <span class="enscript-function-name">LOG</span>(<span class="enscript-type">int</span> level, FILE *f, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *fmt, ...) {
	va_list ap;
	va_start(ap, fmt);
	<span class="enscript-keyword">if</span> (level &gt;= OUTPUT_LEVEL) {
		<span class="enscript-comment">/* Indent for ease of reading */</span>
		<span class="enscript-keyword">if</span> (level &lt; RESULT_LEVEL) {
			fprintf(f, <span class="enscript-string">&quot;\t&quot;</span>);
		}
		vfprintf(f, fmt, ap);
	} 
	
	va_end(ap);
}

<span class="enscript-comment">/*
 * Initialize an action struct.  Whether to sleep, what action to take,
 * and arguments for that action.
 */</span>
<span class="enscript-type">void</span> 
<span class="enscript-function-name">init_action</span>(action_t *act, <span class="enscript-type">int</span> sleep, action_id_t call, <span class="enscript-type">int</span> nargs, ...) 
{
	<span class="enscript-type">int</span> i;
	va_list ap;
	va_start(ap, nargs);
	act-&gt;act_dosleep = sleep;
	act-&gt;act_id = call;
	
	<span class="enscript-keyword">for</span> (i = 0; i &lt; nargs; i++)
	{
		act-&gt;act_args[i] = va_arg(ap, <span class="enscript-type">void</span>*);
	}
	
	va_end(ap);
	
}

<span class="enscript-comment">/*
 * Opening a fifo is complicated: need to open both sides at once 
 */</span>
<span class="enscript-type">void</span>*
<span class="enscript-function-name">open_fifo_readside</span>(<span class="enscript-type">void</span> *arg) 
{
	<span class="enscript-keyword">return</span> (<span class="enscript-type">void</span>*)open((<span class="enscript-type">char</span>*)arg, O_RDONLY);
}

<span class="enscript-comment">/*
 * Open a fifo, setting read and write descriptors.  Return 0 for success, -1 for failure.
 * Only set FD args upon success; they will be unmodified on failure.
 */</span>
<span class="enscript-type">int</span> 
<span class="enscript-function-name">open_fifo</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *path, <span class="enscript-type">int</span> *readfd, <span class="enscript-type">int</span> *writefd) 
{
	pthread_t thread;
	<span class="enscript-type">int</span> waitres;
	<span class="enscript-type">int</span> res;
	<span class="enscript-type">int</span> tmpreadfd, tmpwritefd;
	
	res = pthread_create(&amp;thread, 0, open_fifo_readside, (<span class="enscript-type">void</span>*)path);
	<span class="enscript-keyword">if</span> (res == 0) {
		tmpwritefd = open(path, O_WRONLY);
		waitres = pthread_join(thread, (<span class="enscript-type">void</span>**) &amp;tmpreadfd);
		
		fcntl(tmpwritefd, F_SETFL, O_WRONLY | O_NONBLOCK);
		
		<span class="enscript-keyword">if</span> ((waitres == 0) &amp;&amp; (tmpwritefd &gt;= 0) &amp;&amp; (tmpreadfd &gt;= 0)) {
			*readfd = tmpreadfd;
			*writefd = tmpwritefd;
		} <span class="enscript-keyword">else</span> {
			res = -1;	
		}
	}
	
	<span class="enscript-keyword">return</span> res;
}

<span class="enscript-comment">/*
 * Just concatenate a directory and a filename, sticking a &quot;/&quot; betwixt them
 */</span>
<span class="enscript-type">void</span> 
<span class="enscript-function-name">makepath</span>(<span class="enscript-type">char</span> *buf, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *dir, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *file) 
{
	strcpy(buf, dir);
	strcat(buf, <span class="enscript-string">&quot;/&quot;</span>);
	strcat(buf, file);
}


<span class="enscript-comment">/* Execute a prep, cleanup, or test action; specific tricky notes below.
 *
 * CREAT: 	comes to life and given length 1
 * READ: 	try to read one char
 * WRITE:	try to write TEST_STRING to file
 * LENGTHEN:	make longer by LENGTHEN_SIZE
 * MMAP:	mmap first 20 bytes of file, write HELLO_WORLD in
 * SETXATTR:	set the KEY attribute to value VAL
 * WRITEFD:	instead of opening fresh, take an FD in the action struct (FIFOs)
 * FILLFD:	write a file until you can no longer.  for filling FIFOS.
 *
 * * Several of these have hard-coded sizes.
 */</span>
<span class="enscript-type">void</span>* 
<span class="enscript-function-name">execute_action</span>(<span class="enscript-type">void</span> *actionptr) 
{
	action_t *act = (action_t*)actionptr;
	<span class="enscript-type">void</span> **args = act-&gt;act_args;
	<span class="enscript-type">char</span> c;
	<span class="enscript-type">int</span> res = -1, tmpfd, tmpfd2;
	<span class="enscript-type">static</span> <span class="enscript-type">int</span> lastfd;
	<span class="enscript-type">void</span> *addr;
	<span class="enscript-type">struct</span> timeval tv;
	<span class="enscript-type">struct</span> stat sstat;
	
	LOG(1, stderr, <span class="enscript-string">&quot;Beginning action of type %d\n&quot;</span>, act-&gt;act_id);
	
	<span class="enscript-comment">/* Let other thread get into kevent() sleep */</span>
	<span class="enscript-keyword">if</span>(SLEEP == act-&gt;act_dosleep) {
		sleep(SLEEP_TIME); 
	}
	<span class="enscript-keyword">switch</span>(act-&gt;act_id) {
		<span class="enscript-keyword">case</span> <span class="enscript-reference">NOTHING</span>:
			res = 0;
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">CREAT</span>:
			tmpfd = creat((<span class="enscript-type">char</span>*)args[0], 0755);
			ftruncate(tmpfd, 1); <span class="enscript-comment">/* So that mmap() doesn't fool us */</span>
			<span class="enscript-keyword">if</span> (tmpfd &gt;= 0) {
				close(tmpfd);
				res = 0;
			}
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">MKDIR</span>:
			res = mkdir((<span class="enscript-type">char</span>*)args[0], 0755);
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">READ</span>:
			tmpfd = open((<span class="enscript-type">char</span>*)args[0], O_RDONLY);
			<span class="enscript-keyword">if</span> (tmpfd &gt;= 0) {
				res = read(tmpfd, &amp;c, 1);
				res = (res == 1 ? 0 : -1);
			}
			close(tmpfd);
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">WRITE</span>:
			tmpfd = open((<span class="enscript-type">char</span>*)args[0], O_RDWR);
			<span class="enscript-keyword">if</span> (tmpfd &gt;= 0) {
				res = write(tmpfd, TEST_STRING, strlen(TEST_STRING));
				<span class="enscript-keyword">if</span> (res == strlen(TEST_STRING)) {
					res = 0;
				} <span class="enscript-keyword">else</span> {
					res = -1;
				}
				
				close(tmpfd);
			}
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">WRITEFD</span>:
			res = write((<span class="enscript-type">int</span>)act-&gt;act_fd, TEST_STRING, strlen(TEST_STRING));
			<span class="enscript-keyword">if</span> (res == strlen(TEST_STRING)) {
				res = 0;
			} <span class="enscript-keyword">else</span> {
				res = -1;
			}
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">FILLFD</span>:
			<span class="enscript-keyword">while</span> (write((<span class="enscript-type">int</span>)act-&gt;act_fd, <span class="enscript-string">&quot;a&quot;</span>, 1) &gt; 0);
			res = 0;
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">UNLINK</span>:
			res = unlink((<span class="enscript-type">char</span>*)args[0]);
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">LSEEK</span>:
			res = lseek((<span class="enscript-type">int</span>)act-&gt;act_fd, (<span class="enscript-type">int</span>)args[0], SEEK_SET);
			res = (res == (<span class="enscript-type">int</span>)args[0] ? 0 : -1);
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">RMDIR</span>:
			res = rmdir((<span class="enscript-type">char</span>*)args[0]);
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">MKFIFO</span>:
			res = mkfifo((<span class="enscript-type">char</span>*)args[0], 0755);
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">LENGTHEN</span>:
			res = truncate((<span class="enscript-type">char</span>*)args[0], LENGTHEN_SIZE);
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">TRUNC</span>:
			res = truncate((<span class="enscript-type">char</span>*)args[0], 0);
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">SYMLINK</span>:
			res = symlink((<span class="enscript-type">char</span>*)args[0], (<span class="enscript-type">char</span>*)args[1]);
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">CHMOD</span>:
			res = chmod((<span class="enscript-type">char</span>*)args[0], (<span class="enscript-type">int</span>)args[1]);
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">CHOWN</span>:
			<span class="enscript-comment">/* path, uid, gid */</span>
			res = chown((<span class="enscript-type">char</span>*)args[0], (<span class="enscript-type">int</span>) args[1], (<span class="enscript-type">int</span>) args[2]);
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">EXCHANGEDATA</span>:
			res = exchangedata((<span class="enscript-type">char</span>*)args[0], (<span class="enscript-type">char</span>*)args[1], 0);
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">RENAME</span>:
			res = rename((<span class="enscript-type">char</span>*)args[0], (<span class="enscript-type">char</span>*)args[1]);
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">OPEN</span>:
			tmpfd = open((<span class="enscript-type">char</span>*)args[0], O_RDONLY | O_CREAT);
			res = close(tmpfd);
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">MMAP</span>:
			<span class="enscript-comment">/* It had best already exist with nonzero size */</span>
			tmpfd = open((<span class="enscript-type">char</span>*)args[0], O_RDWR);
			addr = mmap(0, 20, PROT_WRITE | PROT_READ, MAP_FILE | MAP_SHARED, tmpfd, 0);
			<span class="enscript-keyword">if</span> (addr != ((<span class="enscript-type">void</span>*)-1)) {
				res = 0;
				<span class="enscript-keyword">if</span> ((<span class="enscript-type">int</span>)args[1]) {
					strcpy((<span class="enscript-type">char</span>*)addr, HELLO_WORLD);
					msync(addr, 20, MS_SYNC);
				}
			}
			close(tmpfd);
			munmap(addr, 20);
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">SETXATTR</span>:
			res = setxattr((<span class="enscript-type">char</span>*)args[0], KEY, (<span class="enscript-type">void</span>*)VAL, strlen(VAL),
						   0, 0);
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">UTIMES</span>:
			tv.tv_sec = time(NULL);
			tv.tv_usec = 0;
			res = utimes((<span class="enscript-type">char</span>*)args[0], &amp;tv); 
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">STAT</span>:
			res = lstat((<span class="enscript-type">char</span>*)args[0], &amp;sstat);
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">HARDLINK</span>:
			res = link((<span class="enscript-type">char</span>*)args[0], (<span class="enscript-type">char</span>*)args[1]);
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-reference">REVOKE</span>:
			tmpfd = open((<span class="enscript-type">char</span>*)args[0], O_RDONLY);
			res = revoke((<span class="enscript-type">char</span>*)args[0]);
			close(tmpfd);
			<span class="enscript-keyword">break</span>;
		<span class="enscript-reference">default</span>:
			res = -1;
			<span class="enscript-keyword">break</span>;
	}
	
	<span class="enscript-keyword">return</span> (<span class="enscript-type">void</span>*)res;
	
}

<span class="enscript-comment">/*
 * Read until the end of a file, for EVFILT_READ purposes (considers file position)
 */</span>
<span class="enscript-type">void</span> 
<span class="enscript-function-name">read_to_end</span>(<span class="enscript-type">int</span> fd) 
{
	<span class="enscript-type">char</span> buf[50];
	<span class="enscript-keyword">while</span> (read(fd, buf, <span class="enscript-keyword">sizeof</span>(buf)) &gt; 0);
}

<span class="enscript-comment">/*
 * Helper for setup and cleanup; just execute every action in an array
 * of actions.  &quot;failout&quot; parameter indicates whether to stop if one fails.
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">execute_action_list</span>(action_t *actions, <span class="enscript-type">int</span> nactions, <span class="enscript-type">int</span> failout) 
{
	<span class="enscript-type">int</span> i, res;
	<span class="enscript-keyword">for</span> (i = 0, res = 0; (0 == res || (!failout)) &amp;&amp; (i &lt; nactions); i++) {
		LOG(1, stderr, <span class="enscript-string">&quot;Starting prep action %d\n&quot;</span>, i);
		res = (<span class="enscript-type">int</span>) execute_action(&amp;(actions[i]));
		<span class="enscript-keyword">if</span>(res != 0) {
			LOG(2, stderr, <span class="enscript-string">&quot;Action list failed on step %d.\n&quot;</span>, i);
		} <span class="enscript-keyword">else</span> {
			LOG(1, stderr, <span class="enscript-string">&quot;Action list work succeeded on step %d.\n&quot;</span>, i);
		}
	}
	
	<span class="enscript-keyword">return</span> res;
}

<span class="enscript-comment">/*
 * Execute a full test, return success value.
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">execute_test</span>(test_t *test)
{
	<span class="enscript-type">int</span> i, kqfd, filefd = -1, res2, res, cnt, status, writefd = -1;
	<span class="enscript-type">int</span> retval = -1;
	pthread_t thr;
	<span class="enscript-type">struct</span> kevent evlist;
	<span class="enscript-type">struct</span> timespec ts = {WAIT_TIME, 0l};
	
	memset(&amp;evlist, 0, <span class="enscript-keyword">sizeof</span>(evlist));
	
	LOG(1, stderr, <span class="enscript-string">&quot;Test %s starting.\n&quot;</span>, test-&gt;t_testname);
	LOG(1, stderr, test-&gt;t_want_event ? <span class="enscript-string">&quot;Expecting an event.\n&quot;</span> : <span class="enscript-string">&quot;Not expecting events.\n&quot;</span>);
	
	res = execute_action_list(test-&gt;t_prep_actions, test-&gt;t_n_prep_actions, 1);
	
	<span class="enscript-comment">/* If prep succeeded */</span>
	<span class="enscript-keyword">if</span> (0 == res) {
		<span class="enscript-comment">/* Create kqueue for kqueue tests*/</span>
		<span class="enscript-keyword">if</span> (!test-&gt;t_is_poll_test) {
			kqfd = kqueue(); 
		}
		
		<span class="enscript-keyword">if</span> ((test-&gt;t_is_poll_test) || kqfd &gt;= 0) {
			LOG(1, stderr, <span class="enscript-string">&quot;Opened kqueue.\n&quot;</span>);
			
			<span class="enscript-comment">/* Open the file we're to monitor.  Fifos get special handling */</span>
			<span class="enscript-keyword">if</span> (test-&gt;t_file_is_fifo) {
				filefd = -1;
				open_fifo(test-&gt;t_watchfile, &amp;filefd, &amp;writefd);
			} <span class="enscript-keyword">else</span> {
				filefd = open(test-&gt;t_watchfile, O_RDONLY | O_SYMLINK);
			}
			
			<span class="enscript-keyword">if</span> (filefd &gt;= 0) {
				LOG(1, stderr, <span class="enscript-string">&quot;Opened file to monitor.\n&quot;</span>);
				
				<span class="enscript-comment">/* 
				 * Fill in the fd to monitor once you know it 
				 * If it's a fifo test, then the helper is definitely going to want the write end.
				 */</span>
				test-&gt;t_helpthreadact.act_fd = (writefd &gt;= 0 ? writefd : filefd);
				
				<span class="enscript-keyword">if</span> (test-&gt;t_read_to_end_first) {
					read_to_end(filefd);
				} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (test-&gt;t_write_some_data) {
					action_t dowr;
					init_action(&amp;dowr, NOSLEEP, WRITEFD, 0);
					dowr.act_fd = writefd;
					execute_action(&amp;dowr);
				}
				
				<span class="enscript-comment">/* Helper modifies the file that we're listening on (sleeps first, in general) */</span>
				res = pthread_create(&amp;thr, NULL, execute_action, (<span class="enscript-type">void</span>*) &amp;test-&gt;t_helpthreadact);
				<span class="enscript-keyword">if</span> (0 == res) {
					LOG(1, stderr, <span class="enscript-string">&quot;Created helper thread.\n&quot;</span>);
					
					<span class="enscript-comment">/* This is ugly business to hack on filling up a FIFO */</span>
					<span class="enscript-keyword">if</span> (test-&gt;t_extra_sleep_hack) {
						sleep(5);
					}
					
					<span class="enscript-keyword">if</span> (test-&gt;t_is_poll_test) {
						<span class="enscript-type">struct</span> pollfd pl;
						pl.fd = filefd;
						pl.events = test-&gt;t_union.tu_pollevents;
						cnt = poll(&amp;pl, 1, WAIT_TIME);
						LOG(1, stderr, <span class="enscript-string">&quot;Finished poll() call.\n&quot;</span>);
						
						<span class="enscript-keyword">if</span> ((cnt &lt; 0)) {
							LOG(2, stderr, <span class="enscript-string">&quot;error is in errno, %s\n&quot;</span>, strerror(errno));
							res = cnt;
						}
					} <span class="enscript-keyword">else</span> {
						test-&gt;t_union.tu_kev.ident = filefd; 
						cnt = kevent(kqfd, &amp;test-&gt;t_union.tu_kev, 1, &amp;evlist, 1,  &amp;ts);
						LOG(1, stderr, <span class="enscript-string">&quot;Finished kevent() call.\n&quot;</span>);
						
						<span class="enscript-keyword">if</span> ((cnt &lt; 0) || (evlist.flags &amp; EV_ERROR))  {
							LOG(2, stderr, <span class="enscript-string">&quot;kevent() call failed.\n&quot;</span>);
							<span class="enscript-keyword">if</span> (cnt &lt; 0) {
								LOG(2, stderr, <span class="enscript-string">&quot;error is in errno, %s\n&quot;</span>, strerror(errno));
							} <span class="enscript-keyword">else</span> {
								LOG(2, stderr, <span class="enscript-string">&quot;error is in data, %s\n&quot;</span>, strerror(evlist.data));
							}
							res = cnt;
						}
					}
					
					<span class="enscript-comment">/* Success only if you've succeeded to this point AND joined AND other thread is happy*/</span>
					status = 0;
					res2 = pthread_join(thr, (<span class="enscript-type">void</span>**)&amp;status);
					<span class="enscript-keyword">if</span> (res2 &lt; 0) {
						LOG(2, stderr, <span class="enscript-string">&quot;Couldn't join helper thread.\n&quot;</span>); 
					} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (status) {
						LOG(2, stderr, <span class="enscript-string">&quot;Helper action had result %d\n&quot;</span>, (<span class="enscript-type">int</span>)status);
					}
					res = ((res == 0) &amp;&amp; (res2 == 0) &amp;&amp; (status == 0)) ? 0 : -1;
				} <span class="enscript-keyword">else</span> {
					LOG(2, stderr, <span class="enscript-string">&quot;Couldn't start thread.\n&quot;</span>);
				}
				
				close(filefd);
				<span class="enscript-keyword">if</span> (test-&gt;t_file_is_fifo) {
					close(writefd);
				}
			} <span class="enscript-keyword">else</span> {
				LOG(2, stderr, <span class="enscript-string">&quot;Couldn't open test file %s to monitor.\n&quot;</span>, test-&gt;t_watchfile);
				res = -1;
			}
			close(kqfd);
		} <span class="enscript-keyword">else</span> {
			LOG(2, stderr, <span class="enscript-string">&quot;Couldn't open kqueue.\n&quot;</span>);
			res = -1;
		}
	}
	
	<span class="enscript-comment">/* Cleanup work */</span>
	execute_action_list(test-&gt;t_cleanup_actions, test-&gt;t_n_cleanup_actions, 0);
	
	<span class="enscript-comment">/* Success if nothing failed and we either received or did not receive event,
	 * as expected 
	 */</span>
	<span class="enscript-keyword">if</span> (0 == res) {
		LOG(1, stderr, cnt &gt; 0 ? <span class="enscript-string">&quot;Got an event.\n&quot;</span> : <span class="enscript-string">&quot;Did not get an event.\n&quot;</span>);
		<span class="enscript-keyword">if</span> (((cnt &gt; 0) &amp;&amp; (test-&gt;t_want_event)) || ((cnt == 0) &amp;&amp; (!test-&gt;t_want_event))) {
			<span class="enscript-keyword">if</span> ((!test-&gt;t_is_poll_test) &amp;&amp; (test-&gt;t_union.tu_kev.filter == EVFILT_READ || test-&gt;t_union.tu_kev.filter == EVFILT_WRITE)
				&amp;&amp; (test-&gt;t_nbytes) &amp;&amp; (test-&gt;t_nbytes != evlist.data)) {
				LOG(2, stderr, <span class="enscript-string">&quot;Read wrong number of bytes available.  Wanted %d, got %d\n&quot;</span>, test-&gt;t_nbytes, evlist.data);
				retval = -1;
			} <span class="enscript-keyword">else</span> {
				retval = 0;
			}
			
		} <span class="enscript-keyword">else</span> {
			LOG(2, stderr, <span class="enscript-string">&quot;Got unexpected event or lack thereof.\n&quot;</span>);
			retval = -1;
		}
	} <span class="enscript-keyword">else</span> {
		LOG(2, stderr, <span class="enscript-string">&quot;Failed to execute test.\n&quot;</span>);
		retval = -1;
	}
	
	LOG(3, stdout, <span class="enscript-string">&quot;Test %s done with result %d.\n&quot;</span>, test-&gt;t_testname, retval);
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">init_test_common</span>(test_t *tst, <span class="enscript-type">char</span> *testname, <span class="enscript-type">char</span> *watchfile, <span class="enscript-type">int</span> nprep, <span class="enscript-type">int</span> nclean, <span class="enscript-type">int</span> event, <span class="enscript-type">int</span> want, <span class="enscript-type">int</span> ispoll)
{
	memset(tst, 0, <span class="enscript-keyword">sizeof</span>(test_t));
	tst-&gt;t_testname = testname;
	tst-&gt;t_watchfile = watchfile;
	tst-&gt;t_n_prep_actions = nprep;
	tst-&gt;t_n_cleanup_actions = nclean;
	tst-&gt;t_want_event = (want &gt; 0);
	
	<span class="enscript-keyword">if</span> (ispoll) {
		tst-&gt;t_is_poll_test = 1;
		tst-&gt;t_union.tu_pollevents = (<span class="enscript-type">short</span>)event;
	} <span class="enscript-keyword">else</span> {
		<span class="enscript-comment">/* Can do this because filter is negative, notes are positive */</span>
		<span class="enscript-keyword">if</span> (event == EVFILT_READ || event == EVFILT_WRITE) {
			EV_SET(&amp;tst-&gt;t_union.tu_kev, 0, event, EV_ADD | EV_ENABLE, 0, 0, NULL);
			tst-&gt;t_nbytes = want;
		} <span class="enscript-keyword">else</span> {
			EV_SET(&amp;tst-&gt;t_union.tu_kev, 0, EVFILT_VNODE, EV_ADD | EV_ENABLE, event, 0, NULL);
		}
	}
}

<span class="enscript-comment">/*
 * Initialize a test case, not including its actions.  Meaning: a name for it, what filename to watch,
 * counts of prep and cleanup actions, what event to watch for, and whether you want an event/how many bytes read.
 *
 * &quot;want&quot; does double duty as whether you want an event and how many bytes you might want to read
 * &quot;event&quot; is either an event flag (e.g. NOTE_WRITE) or EVFILT_READ
 */</span>	
<span class="enscript-type">void</span> 
<span class="enscript-function-name">init_test</span>(test_t *tst, <span class="enscript-type">char</span> *testname, <span class="enscript-type">char</span> *watchfile, <span class="enscript-type">int</span> nprep, <span class="enscript-type">int</span> nclean, <span class="enscript-type">int</span> event, <span class="enscript-type">int</span> want) 
{
	init_test_common(tst, testname, watchfile, nprep, nclean, event, want, 0);
}

<span class="enscript-comment">/*
 * Same as above, but for a poll() test
 */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">init_poll_test</span>(test_t *tst, <span class="enscript-type">char</span> *testname, <span class="enscript-type">char</span> *watchfile, <span class="enscript-type">int</span> nprep, <span class="enscript-type">int</span> nclean, <span class="enscript-type">int</span> event, <span class="enscript-type">int</span> want) 
{
	init_test_common(tst, testname, watchfile, nprep, nclean, event, want, 1);
}

<span class="enscript-type">void</span> 
<span class="enscript-function-name">run_note_delete_tests</span>() 
{
	test_t test;
	
	init_test(&amp;test, <span class="enscript-string">&quot;1.1.2: unlink a file&quot;</span>, FILE1, 1, 0, NOTE_DELETE, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;1.1.3: rmdir a dir&quot;</span>, DIR1, 1, 0, NOTE_DELETE, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;1.1.4: rename one file over another&quot;</span>, FILE2, 2, 1, NOTE_DELETE, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE2, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)FILE2);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE2, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;1.1.5: rename one dir over another&quot;</span>, DIR2, 2, 1, NOTE_DELETE, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR2, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)DIR2);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR2, NULL);
	execute_test(&amp;test);
	
	<span class="enscript-comment">/* Do FIFO stuff here */</span>
	init_test(&amp;test, <span class="enscript-string">&quot;1.1.6: make a fifo, unlink it&quot;</span>, FILE1, 1, 0, NOTE_DELETE, YES_EVENT);
	test.t_file_is_fifo = 1;
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKFIFO, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, UNLINK, 1, (<span class="enscript-type">void</span>*)FILE1);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;1.1.7: rename a file over a fifo&quot;</span>, FILE1, 2, 1, NOTE_DELETE, YES_EVENT);
	test.t_file_is_fifo = 1;
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKFIFO, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE2, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)FILE2, (<span class="enscript-type">void</span>*)FILE1);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;1.1.8: unlink a symlink to a file&quot;</span>, FILE2, 2, 1, NOTE_DELETE, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, SYMLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)FILE2);
	init_action(&amp;test.t_helpthreadact, SLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE2, NULL);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
	
	<span class="enscript-comment">/* ================= */</span>
	
	init_test(&amp;test, <span class="enscript-string">&quot;1.2.1: Straight-up rename file&quot;</span>, FILE1, 1, 1, NOTE_DELETE, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)FILE2); 
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE2, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;1.2.2: Straight-up rename dir&quot;</span>, DIR1, 1, 1, NOTE_DELETE, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)DIR2); 
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR2, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;1.2.3: Null action on file&quot;</span>, FILE1, 1, 1, NOTE_DELETE, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, NOTHING, 2, NULL, NULL); <span class="enscript-comment">/* The null action */</span>
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;1.2.4: Rename one file over another: watch the file that lives&quot;</span>, FILE1, 2, 1, NOTE_DELETE, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE2, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)FILE2);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE2, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;1.2.5: Rename one dir over another, watch the dir that lives&quot;</span>, DIR1, 2, 1, NOTE_DELETE, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR2, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)DIR2);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR2, NULL);
}

<span class="enscript-type">void</span> 
<span class="enscript-function-name">run_note_write_tests</span>()
{
	<span class="enscript-type">char</span> pathbuf[50];
	<span class="enscript-type">char</span> otherpathbuf[50];
	
	test_t test;
	
	init_test(&amp;test, <span class="enscript-string">&quot;2.1.1: Straight-up write to a file&quot;</span>, FILE1, 1, 1, NOTE_WRITE, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, WRITE, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	
	makepath(pathbuf, DIR1, FILE1);
	init_test(&amp;test, <span class="enscript-string">&quot;2.1.2: creat() file inside a dir&quot;</span>, DIR1, 1, 2, NOTE_WRITE, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)pathbuf, NULL);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	makepath(pathbuf, DIR1, FILE1);
	init_test(&amp;test, <span class="enscript-string">&quot;2.1.3: open() file inside a dir&quot;</span>, DIR1, 1, 2, NOTE_WRITE, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, OPEN, 2, (<span class="enscript-type">void</span>*)pathbuf, NULL);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	makepath(pathbuf, DIR1, FILE1);
	init_test(&amp;test, <span class="enscript-string">&quot;2.1.3: unlink a file from a dir&quot;</span>, DIR1, 2, 1, NOTE_WRITE, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)pathbuf, NULL);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	makepath(pathbuf, DIR1, FILE1);
	makepath(otherpathbuf, DIR1, FILE2);
	init_test(&amp;test, <span class="enscript-string">&quot;2.1.5: rename a file in a dir&quot;</span>, DIR1, 2, 2, NOTE_WRITE, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)otherpathbuf);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)otherpathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	makepath(pathbuf, DIR1, FILE1);
	init_test(&amp;test, <span class="enscript-string">&quot;2.1.6: rename a file to outside of a dir&quot;</span>, DIR1, 2, 2, NOTE_WRITE, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)FILE1);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	makepath(pathbuf, DIR1, FILE1);
	init_test(&amp;test, <span class="enscript-string">&quot;2.1.7: rename a file into a dir&quot;</span>, DIR1, 2, 2, NOTE_WRITE, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)pathbuf);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	makepath(pathbuf, DIR1, FILE1);
	init_test(&amp;test, <span class="enscript-string">&quot;2.1.9: unlink a fifo from a dir&quot;</span>, DIR1, 2, 1, NOTE_WRITE, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, MKFIFO, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)pathbuf, NULL);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	makepath(pathbuf, DIR1, FILE1);
	init_test(&amp;test, <span class="enscript-string">&quot;2.1.10: make symlink in a dir&quot;</span>, DIR1, 1, 2, NOTE_WRITE, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, SYMLINK, 2, (<span class="enscript-type">void</span>*)DOTDOT, (<span class="enscript-type">void</span>*)pathbuf);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;2.1.12: write to a FIFO&quot;</span>, FILE1, 1, 1, NOTE_WRITE, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKFIFO, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	test.t_file_is_fifo = 1;
	init_action(&amp;test.t_helpthreadact, SLEEP, WRITEFD, 0);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	
	makepath(pathbuf, DIR1, FILE1);
	init_test(&amp;test, <span class="enscript-string">&quot;2.1.13: delete a symlink in a dir&quot;</span>, DIR1, 2, 1, NOTE_WRITE, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, SYMLINK, 2, (<span class="enscript-type">void</span>*)DOTDOT, (<span class="enscript-type">void</span>*)pathbuf);
	init_action(&amp;test.t_helpthreadact, SLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)FILE1);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	<span class="enscript-comment">/* This actually should not generate an event, though it's in this section */</span>
	makepath(pathbuf, DIR1, FILE1);
	makepath(otherpathbuf, DIR1, FILE2);
	init_test(&amp;test, <span class="enscript-string">&quot;2.1.14: exchangedata two files in a dir&quot;</span>, DIR1, 3, 3, NOTE_WRITE, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[2]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)otherpathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, EXCHANGEDATA, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)otherpathbuf);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)otherpathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_cleanup_actions[2], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	LOG(1, stderr, <span class="enscript-string">&quot;MMAP test should fail on HFS.\n&quot;</span>);
	init_test(&amp;test, <span class="enscript-string">&quot;2.1.15: Change a file with mmap()&quot;</span>, FILE1, 1, 1, NOTE_WRITE, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, MMAP, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)1); <span class="enscript-comment">/* 1 -&gt; &quot;modify it&quot;*/</span>
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	<span class="enscript-comment">/*================= no-event tests ==================*/</span>
	init_test(&amp;test, <span class="enscript-string">&quot;2.2.1: just open and close existing file&quot;</span>, FILE1, 1, 1, NOTE_WRITE, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, OPEN, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;2.2.2: read from existing file&quot;</span>, FILE1, 1, 1, NOTE_WRITE, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, READ, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;2.2.3: rename existing file&quot;</span>, FILE1, 1, 1, NOTE_WRITE, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)FILE2);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE2, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;2.2.4: just open and close dir&quot;</span>, DIR1, 1, 1, NOTE_WRITE, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, OPEN, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	<span class="enscript-comment">/* There are no tests 2.2.5 or 2.2.6 */</span>
	
	init_test(&amp;test, <span class="enscript-string">&quot;2.2.7: rename a dir&quot;</span>, DIR1, 1, 1, NOTE_WRITE, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)DIR2);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR2, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;2.2.8: rename a fifo&quot;</span>, FILE1, 1, 1, NOTE_WRITE, NO_EVENT);
	test.t_file_is_fifo = 1;
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKFIFO, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)FILE2);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE2, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;2.2.9: unlink a fifo&quot;</span>, FILE1, 1, 0, NOTE_WRITE, NO_EVENT);
	test.t_file_is_fifo = 1;
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKFIFO, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, UNLINK,1, (<span class="enscript-type">void</span>*)FILE1);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;2.2.10: chmod a file&quot;</span>, FILE1, 1, 1, NOTE_WRITE, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, CHMOD, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)0700);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	<span class="enscript-type">struct</span> passwd *pwd = getpwnam(<span class="enscript-string">&quot;local&quot;</span>);
	<span class="enscript-type">int</span> uid = pwd-&gt;pw_uid;
	<span class="enscript-type">int</span> gid = pwd-&gt;pw_gid;
	
	init_test(&amp;test, <span class="enscript-string">&quot;2.2.11: chown a file&quot;</span>, FILE1, 2, 1, NOTE_WRITE, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_prep_actions[1], NOSLEEP, CHOWN, 3, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)uid, (<span class="enscript-type">void</span>*)gid);
	init_action(&amp;test.t_helpthreadact, SLEEP, CHOWN, 3, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)getuid(), (<span class="enscript-type">void</span>*)getgid());
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	
	init_test(&amp;test, <span class="enscript-string">&quot;2.2.12: chmod a dir&quot;</span>, DIR1, 1, 1, NOTE_WRITE, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, CHMOD, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)0700);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;2.2.13: chown a dir&quot;</span>, DIR1, 2, 1, NOTE_WRITE, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_prep_actions[1], NOSLEEP, CHOWN, 3, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)uid, (<span class="enscript-type">void</span>*)gid);
	init_action(&amp;test.t_helpthreadact, SLEEP, CHOWN, 3, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)getuid(), (<span class="enscript-type">void</span>*)getgid());
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	
	
	LOG(1, stderr, <span class="enscript-string">&quot;MMAP will never give a notification on HFS.\n&quot;</span>);
	init_test(&amp;test, <span class="enscript-string">&quot;2.1.14: mmap() a file but do not change it&quot;</span>, FILE1, 1, 1, NOTE_WRITE, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, MMAP, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)0); 
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">run_note_extend_tests</span>()
{
	test_t test;
	<span class="enscript-type">char</span> pathbuf[50];
	
	LOG(1, stderr, <span class="enscript-string">&quot;THESE TESTS WILL FAIL ON HFS!\n&quot;</span>);
	
	init_test(&amp;test, <span class="enscript-string">&quot;3.1.1: write beyond the end of a file&quot;</span>, FILE1, 1, 1, NOTE_EXTEND, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, WRITE, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL); 
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	<span class="enscript-comment">/*
	 * We won't concern ourselves with lengthening directories: commenting these out  
	 *
	 
	 makepath(pathbuf, DIR1, FILE1);
	 init_test(&amp;test, &quot;3.1.2: add a file to a directory with creat()&quot;, DIR1, 1, 2, NOTE_EXTEND, YES_EVENT);
	 init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (void*)DIR1, (void*)NULL);
	 init_action(&amp;test.t_helpthreadact, SLEEP, CREAT, 2, (void*)pathbuf, (void*)NULL); 
	 init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (void*)pathbuf, (void*)NULL);
	 init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, RMDIR, 2, (void*)DIR1, (void*)NULL);
	 execute_test(&amp;test);
	 
	 makepath(pathbuf, DIR1, FILE1);
	 init_test(&amp;test, &quot;3.1.3: add a file to a directory with open()&quot;, DIR1, 1, 2, NOTE_EXTEND, YES_EVENT);
	 init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (void*)DIR1, (void*)NULL);
	 init_action(&amp;test.t_helpthreadact, SLEEP, CREAT, 2, (void*)pathbuf, (void*)NULL); 
	 init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (void*)pathbuf, (void*)NULL);
	 init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, RMDIR, 2, (void*)DIR1, (void*)NULL);
	 execute_test(&amp;test);
	 
	 makepath(pathbuf, DIR1, FILE1);
	 init_test(&amp;test, &quot;3.1.4: add a file to a directory with rename()&quot;, DIR1, 2, 2, NOTE_EXTEND, YES_EVENT);
	 init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (void*)FILE1, (void*)NULL);
	 init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, MKDIR, 2, (void*)DIR1, (void*)NULL);
	 init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (void*)FILE1, (void*)pathbuf); 
	 init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (void*)pathbuf, (void*)NULL);
	 init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, RMDIR, 2, (void*)DIR1, (void*)NULL);
	 execute_test(&amp;test);
	 */</span>
	
	<span class="enscript-comment">/* 3.1.5: a placeholder for a potential kernel test */</span>
	<span class="enscript-comment">/*
	 makepath(pathbuf, DIR1, DIR2);
	 init_test(&amp;test, &quot;3.1.6: add a file to a directory with mkdir()&quot;, DIR1, 1, 2, NOTE_EXTEND, YES_EVENT);
	 init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (void*)DIR1, (void*)NULL);
	 init_action(&amp;test.t_helpthreadact, SLEEP, MKDIR, 2, (void*)pathbuf, (void*)NULL); 
	 init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (void*)pathbuf, (void*)NULL);
	 init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, RMDIR, 2, (void*)DIR1, (void*)NULL);
	 execute_test(&amp;test);
	 */</span>
	init_test(&amp;test, <span class="enscript-string">&quot;3.1.7: lengthen a file with truncate()&quot;</span>, FILE1, 1, 1, NOTE_EXTEND, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, LENGTHEN, 2, FILE1, (<span class="enscript-type">void</span>*)NULL); 
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	
	<span class="enscript-comment">/** ========== NO EVENT SECTION ============== **/</span>
	init_test(&amp;test, <span class="enscript-string">&quot;3.2.1: setxattr() a file&quot;</span>, FILE1, 1, 1, NOTE_EXTEND, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, SETXATTR, 2, FILE1, (<span class="enscript-type">void</span>*)NULL); 
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;3.2.2: chmod a file&quot;</span>, FILE1, 1, 1, NOTE_EXTEND, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, CHMOD, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)0700);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	<span class="enscript-type">struct</span> passwd *pwd = getpwnam(<span class="enscript-string">&quot;local&quot;</span>);
	<span class="enscript-keyword">if</span> (!pwd) {
		LOG(2, stderr, <span class="enscript-string">&quot;Couldn't getpwnam for local.\n&quot;</span>);
		exit(1);
	} 	
	<span class="enscript-type">int</span> uid = pwd-&gt;pw_uid;
	<span class="enscript-type">int</span> gid = pwd-&gt;pw_gid;
	
	init_test(&amp;test, <span class="enscript-string">&quot;3.2.3: chown a file&quot;</span>, FILE1, 2, 1, NOTE_EXTEND, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_prep_actions[1], NOSLEEP, CHOWN, 3, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)uid, (<span class="enscript-type">void</span>*)gid);
	init_action(&amp;test.t_helpthreadact, SLEEP, CHOWN, 3, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)getuid(), (<span class="enscript-type">void</span>*)getgid());
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	
	init_test(&amp;test, <span class="enscript-string">&quot;3.2.4: chmod a dir&quot;</span>, DIR1, 1, 1, NOTE_EXTEND, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, CHMOD, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)0700);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;3.2.5: chown a dir&quot;</span>, DIR1, 2, 1, NOTE_EXTEND, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_prep_actions[1], NOSLEEP, CHOWN, 3, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)uid, (<span class="enscript-type">void</span>*)gid);
	init_action(&amp;test.t_helpthreadact, SLEEP, CHOWN, 3, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)getuid(), (<span class="enscript-type">void</span>*)getgid());
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;3.2.6: TRUNC a file with truncate()&quot;</span>, FILE1, 1, 1, NOTE_EXTEND, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, TRUNC, 2, FILE1, (<span class="enscript-type">void</span>*)NULL); 
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">run_note_attrib_tests</span>()
{
	test_t test;
	<span class="enscript-type">char</span> pathbuf[50];
	
	init_test(&amp;test, <span class="enscript-string">&quot;4.1.1: chmod a file&quot;</span>, FILE1, 1, 1, NOTE_ATTRIB, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, CHMOD, 2, FILE1, (<span class="enscript-type">void</span>*)0700); 
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	<span class="enscript-type">struct</span> passwd *pwd = getpwnam(<span class="enscript-string">&quot;local&quot;</span>);
	<span class="enscript-type">int</span> uid = pwd-&gt;pw_uid;
	<span class="enscript-type">int</span> gid = pwd-&gt;pw_gid;
	
	init_test(&amp;test, <span class="enscript-string">&quot;4.1.2: chown a file&quot;</span>, FILE1, 2, 1, NOTE_ATTRIB, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, CHOWN, 3, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)uid, (<span class="enscript-type">void</span>*)gid);
	init_action(&amp;test.t_helpthreadact, SLEEP, CHOWN, 3, FILE1, (<span class="enscript-type">void</span>*)getuid(), (<span class="enscript-type">void</span>*)gid); 
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;4.1.3: chmod a dir&quot;</span>, DIR1, 1, 1, NOTE_ATTRIB, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_helpthreadact), SLEEP, CHMOD, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)0700);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;4.1.4: chown a dir&quot;</span>, DIR1, 2, 1, NOTE_ATTRIB, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, CHOWN, 3, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*) uid, (<span class="enscript-type">void</span>*)gid);
	init_action(&amp;test.t_helpthreadact, SLEEP, CHOWN, 3, DIR1, (<span class="enscript-type">void</span>*)getuid(), (<span class="enscript-type">void</span>*)getgid()); 
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;4.1.5: setxattr on a file&quot;</span>, FILE1, 1, 1, NOTE_ATTRIB, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, SETXATTR, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL); 
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;4.1.6: setxattr on a dir&quot;</span>, DIR1, 1, 1, NOTE_ATTRIB, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, SETXATTR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL); 
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	
	init_test(&amp;test, <span class="enscript-string">&quot;4.1.7: exchangedata&quot;</span>, FILE1, 2, 2, NOTE_ATTRIB, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE2, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, EXCHANGEDATA, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)FILE2); 
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE2, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	
	init_test(&amp;test, <span class="enscript-string">&quot;4.1.8: utimes on a file&quot;</span>, FILE1, 1, 1, NOTE_ATTRIB, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, UTIMES, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL); 
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;4.1.9: utimes on a dir&quot;</span>, DIR1, 1, 1, NOTE_ATTRIB, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, UTIMES, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL); 
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	
	<span class="enscript-comment">/* ====== NO EVENT TESTS ========== */</span>
	
	init_test(&amp;test, <span class="enscript-string">&quot;4.2.1: rename a file&quot;</span>, FILE1, 1, 1, NOTE_ATTRIB, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)FILE2);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE2, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;4.2.2: open (do not change) a file&quot;</span>, FILE1, 1, 1, NOTE_ATTRIB, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, OPEN, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;4.2.3: stat a file&quot;</span>, FILE1, 1, 1, NOTE_ATTRIB, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, STAT, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;4.2.4: unlink a file&quot;</span>, FILE1, 1, 0, NOTE_ATTRIB, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;4.2.5: write to a file&quot;</span>, FILE1, 1, 1, NOTE_ATTRIB, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, WRITE, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL); 
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	LOG(1, stderr, <span class="enscript-string">&quot;EXPECT SPURIOUS NOTE_ATTRIB EVENTS FROM DIRECTORY OPERATIONS on HFS.\n&quot;</span>);
	init_test(&amp;test, <span class="enscript-string">&quot;4.2.6: add a file to a directory with creat()&quot;</span>, DIR1, 1, 2, NOTE_ATTRIB, NO_EVENT);
	makepath(pathbuf, DIR1, FILE1);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL); 
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;4.2.7: mkdir in a dir&quot;</span>, DIR1, 1, 2, NOTE_ATTRIB, NO_EVENT);
	makepath(pathbuf, DIR1, DIR2);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL); 
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;4.2.8: add a symlink to a directory&quot;</span>, DIR1, 1, 2, NOTE_ATTRIB, NO_EVENT);
	makepath(pathbuf, DIR1, FILE1);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, SYMLINK, 2, (<span class="enscript-type">void</span>*)DOTDOT, (<span class="enscript-type">void</span>*)pathbuf); 
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;4.2.9: rename into a dir()&quot;</span>, DIR1, 2, 2, NOTE_ATTRIB, NO_EVENT);
	makepath(pathbuf, DIR1, FILE1);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)pathbuf); 
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;4.2.10: unlink() file from dir&quot;</span>, DIR1, 2, 1, NOTE_ATTRIB, NO_EVENT);
	makepath(pathbuf, DIR1, FILE1);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL); 
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;4.2.11: mkfifo in a directory&quot;</span>, DIR1, 1, 2, NOTE_ATTRIB, NO_EVENT);
	makepath(pathbuf, DIR1, FILE1);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, MKFIFO, 1, (<span class="enscript-type">void</span>*)pathbuf); 
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	
}


<span class="enscript-type">void</span> 
<span class="enscript-function-name">run_note_link_tests</span>()
{
	test_t test;
	<span class="enscript-type">char</span> pathbuf[50];
	<span class="enscript-type">char</span> otherpathbuf[50];
	
	LOG(1, stderr, <span class="enscript-string">&quot;HFS DOES NOT HANDLE UNLINK CORRECTLY...\n&quot;</span>);
	init_test(&amp;test, <span class="enscript-string">&quot;5.1.1: unlink() a file&quot;</span>, FILE1, 1, 0, NOTE_LINK, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	
	init_test(&amp;test, <span class="enscript-string">&quot;5.1.1.5: link A to B, watch A, remove B&quot;</span>, FILE1, 2, 1, NOTE_LINK, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, HARDLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)FILE2);
	init_action(&amp;test.t_helpthreadact, SLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE2, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;5.1.2: link() to a file&quot;</span>, FILE1, 1, 2, NOTE_LINK, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, HARDLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)FILE2);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE2, NULL);
	execute_test(&amp;test);
	
	makepath(pathbuf, DIR1, DIR2);
	init_test(&amp;test, <span class="enscript-string">&quot;5.1.3: make one dir in another&quot;</span>, DIR1, 1, 2, NOTE_LINK, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)pathbuf, NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, NULL);
	execute_test(&amp;test);
	
	makepath(pathbuf, DIR1, DIR2);
	init_test(&amp;test, <span class="enscript-string">&quot;5.1.4: rmdir a dir from within another&quot;</span>, DIR1, 2, 1, NOTE_LINK, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, NULL);
	execute_test(&amp;test);
	
	makepath(pathbuf, DIR1, DIR2);
	makepath(otherpathbuf, DIR1, DIR1);
	init_test(&amp;test, <span class="enscript-string">&quot;5.1.5: rename dir A over dir B inside dir C&quot;</span>, DIR1, 3, 2, NOTE_LINK, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[2]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)otherpathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)otherpathbuf);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)otherpathbuf, NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, NULL);
	execute_test(&amp;test);
	
	LOG(1, stderr, <span class="enscript-string">&quot;HFS bypasses hfs_makenode to create in target, so misses knote.\n&quot;</span>);
	makepath(pathbuf, DIR1, DIR2);
	init_test(&amp;test, <span class="enscript-string">&quot;5.1.6: rename one dir into another&quot;</span>, DIR1, 2, 2, NOTE_LINK, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR2, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)DIR2, (<span class="enscript-type">void</span>*)pathbuf);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)pathbuf, NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, NULL);
	execute_test(&amp;test);
	
	LOG(1, stderr, <span class="enscript-string">&quot;HFS bypasses hfs_removedir to remove from source, so misses knote.\n&quot;</span>);
	makepath(pathbuf, DIR1, DIR2);
	init_test(&amp;test, <span class="enscript-string">&quot;5.1.7: rename one dir out of another&quot;</span>, DIR1, 2, 2, NOTE_LINK, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)DIR2);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR2, NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;5.1.8: rmdir a dir&quot;</span>, DIR1, 1, 0, NOTE_LINK, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	execute_test(&amp;test);
	
	<span class="enscript-comment">/* ============= NO EVENT SECTION ============== */</span>
	makepath(pathbuf, DIR1, FILE1);
	init_test(&amp;test, <span class="enscript-string">&quot;5.2.1: make a file in a dir&quot;</span>, DIR1, 1, 2, NOTE_LINK, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)pathbuf, NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, NULL);
	execute_test(&amp;test);
	
	makepath(pathbuf, DIR1, FILE1);
	init_test(&amp;test, <span class="enscript-string">&quot;5.2.2: unlink a file in a dir&quot;</span>, DIR1, 2, 1, NOTE_LINK, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, NULL);
	execute_test(&amp;test);
	
	makepath(pathbuf, DIR1, FILE1);
	makepath(otherpathbuf, DIR1, FILE2);
	init_test(&amp;test, <span class="enscript-string">&quot;5.2.3: rename a file within a dir&quot;</span>, DIR1, 2, 2, NOTE_LINK, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)pathbuf, (<span class="enscript-type">void</span>*)otherpathbuf);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)otherpathbuf, NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, NULL);
	execute_test(&amp;test);
	
	makepath(pathbuf, DIR1, FILE1);
	init_test(&amp;test, <span class="enscript-string">&quot;5.2.4: rename a file into a dir&quot;</span>, DIR1, 2, 2, NOTE_LINK, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)pathbuf);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)pathbuf, NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, NULL);
	execute_test(&amp;test);
	
	makepath(pathbuf, DIR1, FILE1);
	init_test(&amp;test, <span class="enscript-string">&quot;5.2.5: make a symlink in a dir&quot;</span>, DIR1, 1, 2, NOTE_LINK, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, SYMLINK, 2, (<span class="enscript-type">void</span>*)DOTDOT, (<span class="enscript-type">void</span>*)pathbuf);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)pathbuf, NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;5.2.6: make a symlink to a dir&quot;</span>, DIR1, 1, 2, NOTE_LINK, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, SYMLINK, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)FILE1);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;5.2.7: make a symlink to a file&quot;</span>, FILE1, 1, 2, NOTE_LINK, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, SYMLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)FILE2);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE2, NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">run_note_rename_tests</span>() 
{
	test_t test;
	
	init_test(&amp;test, <span class="enscript-string">&quot;6.1.1: rename a file&quot;</span>, FILE1, 1, 1, NOTE_RENAME, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)FILE2);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE2, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;6.1.2: rename a dir&quot;</span>, DIR1, 1, 1, NOTE_RENAME, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)DIR2);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR2, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;6.1.2: rename one file over another&quot;</span>, FILE1, 2, 1, NOTE_RENAME, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE2, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)FILE2);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE2, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;6.1.3: rename one dir over another&quot;</span>, DIR1, 2, 1, NOTE_RENAME, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR2, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)DIR2);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR2, NULL);
	execute_test(&amp;test);
	
	<span class="enscript-comment">/* ========= NO EVENT SECTION =========== */</span>
	
	init_test(&amp;test, <span class="enscript-string">&quot;6.2.1: unlink a file&quot;</span>, FILE1, 1, 0, NOTE_RENAME, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;6.2.2: rmdir a dir&quot;</span>, DIR1, 1, 0, NOTE_RENAME, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;6.2.3: link() to a file&quot;</span>, FILE1, 1, 2, NOTE_RENAME, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, HARDLINK, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)FILE2);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	init_action(&amp;test.t_cleanup_actions[1], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE2, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;6.2.4: rename one file over another: watch deceased&quot;</span>, 
			  FILE2, 2, 1, NOTE_RENAME, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE2, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)FILE2);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE2, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;6.2.5: rename one dir over another: watch deceased&quot;</span>, 
			  DIR2, 2, 1, NOTE_RENAME, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR2, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)DIR2);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR2, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;6.2.6: rename a file to itself&quot;</span>, FILE1, 1, 1, NOTE_RENAME, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)FILE1);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;6.2.7: rename a dir to itself&quot;</span>, DIR1, 1, 1, NOTE_RENAME, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKDIR, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)DIR1, (<span class="enscript-type">void</span>*)DIR1);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, RMDIR, 2, (<span class="enscript-type">void</span>*)DIR1, NULL);
	execute_test(&amp;test);
}

<span class="enscript-type">void</span> 
<span class="enscript-function-name">run_note_revoke_tests</span>() 
{
	test_t test;
	init_test(&amp;test, <span class="enscript-string">&quot;7.1.1: revoke file&quot;</span>, FILE1, 1, 1, NOTE_REVOKE, YES_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 1, (<span class="enscript-type">void</span>*)FILE1);
	init_action(&amp;test.t_helpthreadact, SLEEP, REVOKE, 1, (<span class="enscript-type">void</span>*)FILE1);
	init_action(&amp;(test.t_cleanup_actions[0]), NOSLEEP, UNLINK, 1, (<span class="enscript-type">void</span>*)FILE1);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;7.2.1: delete file&quot;</span>, FILE1, 1, 0, NOTE_REVOKE, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 1, (<span class="enscript-type">void</span>*)FILE1);
	init_action(&amp;test.t_helpthreadact, SLEEP, UNLINK, 1, (<span class="enscript-type">void</span>*)FILE1);
	execute_test(&amp;test);
}


<span class="enscript-type">void</span>
<span class="enscript-function-name">run_evfilt_read_tests</span>() 
{
	test_t test;
	init_test(&amp;test, <span class="enscript-string">&quot;8.1.1: how much data in file of length LENGTHEN_SIZE?&quot;</span>, FILE1, 2, 1, EVFILT_READ, LENGTHEN_SIZE);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, LENGTHEN, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, NOTHING, 0);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;8.1.2: block, then write to file&quot;</span>, FILE1, 2, 1, EVFILT_READ, strlen(TEST_STRING));
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 1, (<span class="enscript-type">void</span>*)FILE1);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, TRUNC, 1, (<span class="enscript-type">void</span>*)FILE1);
	init_action(&amp;test.t_helpthreadact, SLEEP, WRITE, 1, (<span class="enscript-type">void</span>*)FILE1);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;8.1.3: block, then extend&quot;</span>, FILE1, 2, 1, EVFILT_READ, LENGTHEN_SIZE);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 1, (<span class="enscript-type">void</span>*)FILE1);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, TRUNC, 1, (<span class="enscript-type">void</span>*)FILE1);
	init_action(&amp;test.t_helpthreadact, SLEEP, LENGTHEN, 1, (<span class="enscript-type">void</span>*)FILE1);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;8.1.4: block, then seek to beginning&quot;</span>, FILE1, 2, 1, EVFILT_READ, strlen(TEST_STRING));
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 1, (<span class="enscript-type">void</span>*)FILE1);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, WRITE, 1, (<span class="enscript-type">void</span>*)FILE1);
	test.t_read_to_end_first = 1; <span class="enscript-comment">/* hack means that we've gotten to EOF before we block */</span>
	init_action(&amp;test.t_helpthreadact, SLEEP, LSEEK, 1, (<span class="enscript-type">void</span>*)0);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
	
	
	init_test(&amp;test, <span class="enscript-string">&quot;8.1.5: block, then write to fifo&quot;</span>, FILE1, 1, 1, EVFILT_READ, strlen(TEST_STRING));
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKFIFO, 1, (<span class="enscript-type">void</span>*)FILE1);
	test.t_file_is_fifo = 1;
	init_action(&amp;test.t_helpthreadact, SLEEP, WRITE, 1, (<span class="enscript-type">void</span>*)FILE1);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
	
	<span class="enscript-comment">/* No result section... */</span>
	init_test(&amp;test, <span class="enscript-string">&quot;8.2.1: just rename&quot;</span>, FILE1, 2, 1, EVFILT_READ, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 1, (<span class="enscript-type">void</span>*)FILE1);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, TRUNC, 1, (<span class="enscript-type">void</span>*)FILE1);
	init_action(&amp;test.t_helpthreadact, SLEEP, RENAME, 2, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)FILE2);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE2, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;8.2.2: delete file&quot;</span>, FILE1, 2, 0, EVFILT_READ, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 1, (<span class="enscript-type">void</span>*)FILE1);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, TRUNC, 1, (<span class="enscript-type">void</span>*)FILE1);
	init_action(&amp;test.t_helpthreadact, SLEEP, UNLINK, 1, (<span class="enscript-type">void</span>*)FILE1);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;8.2.3: write to beginning&quot;</span>, FILE1, 2, 1, EVFILT_READ, NO_EVENT);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 1, (<span class="enscript-type">void</span>*)FILE1);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, WRITE, 1, (<span class="enscript-type">void</span>*)FILE1);
	test.t_read_to_end_first = 1; <span class="enscript-comment">/* hack means that we've gotten to EOF before we block */</span>
	init_action(&amp;test.t_helpthreadact, SLEEP, WRITE, 1, (<span class="enscript-type">void</span>*)FILE1);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 1, (<span class="enscript-type">void</span>*)FILE1);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;8.1.4: block, then seek to current location&quot;</span>, FILE1, 2, 1, EVFILT_READ, 0);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 1, (<span class="enscript-type">void</span>*)FILE1);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, WRITE, 1, (<span class="enscript-type">void</span>*)FILE1);
	test.t_read_to_end_first = 1; <span class="enscript-comment">/* hack means that we've gotten to EOF before we block */</span>
	init_action(&amp;test.t_helpthreadact, SLEEP, LSEEK, 1, (<span class="enscript-type">void</span>*)strlen(TEST_STRING));
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;8.2.5: trying to read from empty fifo&quot;</span>, FILE1, 1, 1, EVFILT_READ, 0);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKFIFO, 1, (<span class="enscript-type">void</span>*)FILE1);
	test.t_file_is_fifo = 1;
	init_action(&amp;test.t_helpthreadact, SLEEP, NOTHING, 1, (<span class="enscript-type">void</span>*)0);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
	
}



<span class="enscript-type">void</span>*
<span class="enscript-function-name">read_from_fd</span>(<span class="enscript-type">void</span> *arg)
{
	<span class="enscript-type">char</span> buf[50];
	<span class="enscript-type">int</span> fd = (<span class="enscript-type">int</span>) arg;
	sleep(2);
	<span class="enscript-keyword">return</span> (<span class="enscript-type">void</span>*) read(fd, buf, <span class="enscript-keyword">sizeof</span>(buf));
}

<span class="enscript-type">void</span>*
<span class="enscript-function-name">write_to_fd</span>(<span class="enscript-type">void</span> *arg)
{
	<span class="enscript-type">char</span> buf[50];
	<span class="enscript-type">int</span> fd = (<span class="enscript-type">int</span>) arg;
	sleep(2);
	<span class="enscript-keyword">return</span> (<span class="enscript-type">void</span>*) write(fd, buf, <span class="enscript-keyword">sizeof</span>(buf));
}

<span class="enscript-comment">/*
 * We don't (in principle) support EVFILT_WRITE for vnodes; thusly, no tests here
 */</span>
<span class="enscript-type">void</span> 
<span class="enscript-function-name">run_evfilt_write_tests</span>()
{
	
	test_t test;
	init_test(&amp;test, <span class="enscript-string">&quot;9.1.1: how much space in empty fifo?&quot;</span>, FILE1, 1, 1, EVFILT_WRITE, FIFO_SPACE);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKFIFO, 1, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	test.t_file_is_fifo = 1;
	init_action(&amp;test.t_helpthreadact, SLEEP, NOTHING, 0);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;9.1.2: how much space in slightly written fifo?&quot;</span>, FILE1, 1, 1, EVFILT_WRITE, FIFO_SPACE - strlen(TEST_STRING));
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKFIFO, 1, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	test.t_file_is_fifo = 1;
	test.t_write_some_data = 1;
	init_action(&amp;(test.t_helpthreadact), NOSLEEP, NOTHING, 0);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
	
	init_test(&amp;test, <span class="enscript-string">&quot;9.2.1: how much space in a full fifo?&quot;</span>, FILE1, 1, 1, EVFILT_WRITE, 0);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKFIFO, 1, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	test.t_file_is_fifo = 1;
	test.t_extra_sleep_hack = 1;
	init_action(&amp;(test.t_helpthreadact), NOSLEEP, FILLFD, 1, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">run_poll_tests</span>()
{
	test_t test;
	init_poll_test(&amp;test, <span class="enscript-string">&quot;10.1.1: does poll say I can write a regular file?&quot;</span>, FILE1, 1, 1, POLLWRNORM, 1);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 1, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, NOTHING, 0);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
	
	init_poll_test(&amp;test, <span class="enscript-string">&quot;10.1.2: does poll say I can write an empty FIFO?&quot;</span>, FILE1, 1, 1, POLLWRNORM, 1);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKFIFO, 1, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	test.t_file_is_fifo = 1;
	init_action(&amp;test.t_helpthreadact, SLEEP, NOTHING, 0);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
	
	init_poll_test(&amp;test, <span class="enscript-string">&quot;10.1.3: does poll say I can read a nonempty FIFO?&quot;</span>, FILE1, 1, 1, POLLRDNORM, 1);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKFIFO, 1, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	test.t_file_is_fifo = 1;
	test.t_write_some_data = 1;
	init_action(&amp;test.t_helpthreadact, SLEEP, NOTHING, 0);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
	
	init_poll_test(&amp;test, <span class="enscript-string">&quot;10.1.4: does poll say I can read a nonempty regular file?&quot;</span>, FILE1, 2, 1, POLLRDNORM, 1);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 1, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;(test.t_prep_actions[1]), NOSLEEP, LENGTHEN, 1, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, NOTHING, 0);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
	
	init_poll_test(&amp;test, <span class="enscript-string">&quot;10.1.5: does poll say I can read an empty file?&quot;</span>, FILE1, 1, 1, POLLRDNORM, 1);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, CREAT, 1, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_helpthreadact, SLEEP, NOTHING, 0);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
	
	
	
	
	init_poll_test(&amp;test, <span class="enscript-string">&quot;10.2.2: does poll say I can read an empty FIFO?&quot;</span>, FILE1, 1, 1, POLLRDNORM, 0);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKFIFO, 1, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	test.t_file_is_fifo = 1;
	init_action(&amp;test.t_helpthreadact, SLEEP, NOTHING, 0);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
	
	init_poll_test(&amp;test, <span class="enscript-string">&quot;10.2.3: does poll say I can write a full FIFO?&quot;</span>, FILE1, 1, 1, POLLWRNORM, 0);
	init_action(&amp;(test.t_prep_actions[0]), NOSLEEP, MKFIFO, 1, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	test.t_file_is_fifo = 1;
	test.t_extra_sleep_hack = 1;
	init_action(&amp;(test.t_helpthreadact), NOSLEEP, FILLFD, 1, (<span class="enscript-type">void</span>*)FILE1, (<span class="enscript-type">void</span>*)NULL);
	init_action(&amp;test.t_cleanup_actions[0], NOSLEEP, UNLINK, 2, (<span class="enscript-type">void</span>*)FILE1, NULL);
	execute_test(&amp;test);
}

<span class="enscript-type">void</span> 
<span class="enscript-function-name">run_all_tests</span>() 
{
	run_note_delete_tests();
	run_note_write_tests();
	run_note_extend_tests();
	run_note_attrib_tests();
	run_note_link_tests();
	run_note_rename_tests();
#<span class="enscript-reference">if</span> 0
	run_note_revoke_tests(); <span class="enscript-comment">/* Can no longer revoke a regular file--need an unmount test */</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* 0 */</span>
	run_evfilt_read_tests();
	run_evfilt_write_tests();
	run_poll_tests();
}

<span class="enscript-type">int</span> 
<span class="enscript-function-name">main</span>(<span class="enscript-type">int</span> argc, <span class="enscript-type">char</span> **argv) 
{
	<span class="enscript-type">char</span> *which = NULL;
	<span class="enscript-keyword">if</span> (argc &gt; 1) {
		which = argv[1];
	}
	
	<span class="enscript-keyword">if</span> ((!which) || (strcmp(which, <span class="enscript-string">&quot;all&quot;</span>) == 0))
		run_all_tests();
	<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (strcmp(which, <span class="enscript-string">&quot;delete&quot;</span>) == 0) 
		run_note_delete_tests();
	<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (strcmp(which, <span class="enscript-string">&quot;write&quot;</span>) == 0)
		run_note_write_tests();
	<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (strcmp(which, <span class="enscript-string">&quot;extend&quot;</span>) == 0)
		run_note_extend_tests();
	<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (strcmp(which, <span class="enscript-string">&quot;attrib&quot;</span>) == 0)
		run_note_attrib_tests();
	<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (strcmp(which, <span class="enscript-string">&quot;link&quot;</span>) == 0)
		run_note_link_tests();
	<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (strcmp(which, <span class="enscript-string">&quot;rename&quot;</span>) == 0)
		run_note_rename_tests();
	<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (strcmp(which, <span class="enscript-string">&quot;revoke&quot;</span>) == 0)
		run_note_revoke_tests();
	<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (strcmp(which, <span class="enscript-string">&quot;evfiltread&quot;</span>) == 0)
		run_evfilt_read_tests();
	<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (strcmp(which, <span class="enscript-string">&quot;evfiltwrite&quot;</span>) == 0)
		run_evfilt_write_tests();
	<span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (strcmp(which, <span class="enscript-string">&quot;poll&quot;</span>) == 0)
		run_poll_tests();
	<span class="enscript-keyword">else</span> {
		fprintf(stderr, <span class="enscript-string">&quot;Valid options are:\n\tdelete, write, extend,&quot;</span>
				<span class="enscript-string">&quot;attrib, link, rename, revoke, evfiltread, fifo, all, evfiltwrite&lt;none&gt;\n&quot;</span>);
		exit(1);
	}
	<span class="enscript-keyword">return</span> 0;
}

</pre>
<hr />
</body></html>