<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>od_account_delete.sh</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">od_account_delete.sh&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-reference">#!/bin/bash
</span>
<span class="enscript-keyword">function</span> sighandler {
  <span class="enscript-builtin">echo</span> 
  <span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;Interrupting account creation&quot;</span>
  rm -f $TMPF
  <span class="enscript-builtin">exit</span> 2
}

<span class="enscript-builtin">trap</span> sighandler INT TERM

<span class="enscript-comment"># Fixed parameters
</span><span class="enscript-comment">#
</span>NAME=`basename $0`
COUNT=$1
PREFIX=<span class="enscript-string">&quot;od_test_&quot;</span>
GROUP_NAME='od_test_group'
TMPF=/tmp/.${NAME}.$$
NODE=$2

usage () {
  <span class="enscript-builtin">echo</span>
  <span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;Usage: ${NAME} count nodename&quot;</span>
  <span class="enscript-builtin">echo</span> 
  <span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;   ie. ${NAME} 1000 /Local/Default&quot;</span>
  <span class="enscript-builtin">echo</span>
  <span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;       will delete ${GROUPNAME} and 1000 users &quot;</span>
  <span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;       from '${PREFIX}1' to '${PREFIX}1000'&quot;</span>
  <span class="enscript-builtin">echo</span>
  <span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;This tool assumes user 'diradmin' with password 'admin' for OD admin&quot;</span>
  <span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;when talking to anything other than /Local/Default&quot;</span>
  <span class="enscript-builtin">exit</span> 85 <span class="enscript-comment"># WRONGARGS
</span>}

<span class="enscript-keyword">if</span> [ $<span class="enscript-comment"># -ne 2 ]; then
</span>  usage
<span class="enscript-keyword">fi</span>

<span class="enscript-comment"># we don't need credentials if its a local node
</span><span class="enscript-keyword">if</span> [ $NODE != <span class="enscript-string">&quot;/Local/Default&quot;</span> ]; <span class="enscript-keyword">then</span>
  OD_ADMIN=<span class="enscript-string">&quot;diradmin&quot;</span>
  OD_PASS=<span class="enscript-string">&quot;admin&quot;</span>
<span class="enscript-keyword">fi</span>

<span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;Deleting users ${PREFIX}1 to ${PREFIX}$COUNT&quot;</span>

<span class="enscript-comment"># Using a script file and feed it into dscl is much faster than
</span><span class="enscript-comment"># calling dscl everytime.
</span><span class="enscript-comment"># 
</span>i=1
<span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;Writing a temporary script ...&quot;</span>
<span class="enscript-keyword">if</span> [ -n <span class="enscript-string">&quot;$OD_ADMIN&quot;</span> ]; <span class="enscript-keyword">then</span>
  <span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;auth $OD_ADMIN $OD_PASS&quot;</span> &gt;&gt; $TMPF
<span class="enscript-keyword">fi</span>

<span class="enscript-keyword">while</span> [ $i -le $COUNT ]
<span class="enscript-keyword">do</span>
  result=`dscl $NODE -list Users/${PREFIX}${i} 2&gt; /dev/null`
  <span class="enscript-keyword">if</span> [ $? -eq 0 ]; <span class="enscript-keyword">then</span>
    <span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;delete Users/${PREFIX}${i}&quot;</span> &gt;&gt; $TMPF
    printf <span class="enscript-string">&quot;\r${PREFIX}${i} / ${COUNT}&quot;</span>
  <span class="enscript-keyword">fi</span>
  i=`expr $i + 1` 
<span class="enscript-keyword">done</span>
<span class="enscript-builtin">echo</span> 

<span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;Deleting temporary test groups&quot;</span>
<span class="enscript-keyword">if</span> [ -n <span class="enscript-string">&quot;$OD_ADMIN&quot;</span> ]; <span class="enscript-keyword">then</span>
  result=`dseditgroup -q -o delete -n $NODE -u $OD_ADMIN -P $OD_PASS ${GROUP_NAME<span class="enscript-keyword">}</span>1 2&gt;&amp;1 /dev/null`
  result=`dseditgroup -q -o delete -n $NODE -u $OD_ADMIN -P $OD_PASS ${GROUP_NAME<span class="enscript-keyword">}</span>2 2&gt;&amp;1 /dev/null`
<span class="enscript-keyword">else</span>
  result=`dseditgroup -q -o delete -n $NODE ${GROUP_NAME<span class="enscript-keyword">}</span>1 2&gt;&amp;1 /dev/null`
  result=`dseditgroup -q -o delete -n $NODE ${GROUP_NAME<span class="enscript-keyword">}</span>2 2&gt;&amp;1 /dev/null`
<span class="enscript-keyword">fi</span>

result=`dseditgroup -q -o delete com.apple.access_libMicro 2&gt;&amp;1 /dev/null`

<span class="enscript-comment"># Now do the real work
</span><span class="enscript-comment">#
</span><span class="enscript-keyword">if</span> [[ -f $TMPF ]]; <span class="enscript-keyword">then</span>
  <span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;Running dscl to delete users. Please be patient. This takes a while ...&quot;</span>
  <span class="enscript-keyword">if</span> [[ -x /usr/sbin/slapconfig ]]; <span class="enscript-keyword">then</span>
    /usr/sbin/slapconfig -setfullsyncmode no
  <span class="enscript-keyword">fi</span>

  /usr/bin/<span class="enscript-keyword">time</span> dscl ${NODE} &lt; $TMPF

  <span class="enscript-keyword">if</span> [[ -x /usr/sbin/slapconfig ]]; <span class="enscript-keyword">then</span>
    /usr/sbin/slapconfig -setfullsyncmode yes
  <span class="enscript-keyword">fi</span>
<span class="enscript-keyword">fi</span>

<span class="enscript-comment"># and now delete the temp file
</span><span class="enscript-comment">#
</span>rm -f $TMPF

<span class="enscript-builtin">echo</span> 'Finished'

</pre>
<hr />
</body></html>