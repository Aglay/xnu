<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>libmicro.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">libmicro.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * CDDL HEADER START
 *
 * The contents of this file are subject to the terms of the
 * Common Development and Distribution License, Version 1.0 only
 * (the &quot;License&quot;).  You may not use this file except in compliance
 * with the License.
 *
 * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE
 * or <a href="http://www.opensolaris.org/os/licensing.">http://www.opensolaris.org/os/licensing.</a>
 * See the License for the specific language governing permissions
 * and limitations under the License.
 *
 * When distributing Covered Code, include this CDDL HEADER in each
 * file and include the License file at usr/src/OPENSOLARIS.LICENSE.
 * If applicable, add the following below this CDDL HEADER, with the
 * fields enclosed by brackets &quot;[]&quot; replaced with your own identifying
 * information: Portions Copyright [yyyy] [name of copyright owner]
 *
 * CDDL HEADER END
 */</span>

<span class="enscript-comment">/*
 * Copyright 2007 Sun Microsystems, Inc.  All rights reserved.
 * Use is subject to license terms.
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">LIBMICRO_H</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LIBMICRO_H</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;pthread.h&gt;</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">LIBMICRO_VERSION</span>	<span class="enscript-string">&quot;0.4.0&quot;</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">STRSIZE</span>			1024

#<span class="enscript-reference">define</span> <span class="enscript-function-name">STREQ</span>(a,b) (strcmp(a,b) == 0)

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
	<span class="enscript-type">long</span> <span class="enscript-type">long</span>		re_count;
	<span class="enscript-type">long</span> <span class="enscript-type">long</span>		re_errors;
	<span class="enscript-type">long</span> <span class="enscript-type">long</span>		re_t0;
	<span class="enscript-type">long</span> <span class="enscript-type">long</span>		re_t1;
} result_t;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
	<span class="enscript-type">double</span>			sum;
	<span class="enscript-type">long</span> <span class="enscript-type">long</span>		count;
} histo_t;

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">HISTOSIZE</span>		32
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DATASIZE</span>		100000

<span class="enscript-comment">/*
 * stats we compute on data sets
 */</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> stats {
	<span class="enscript-type">double</span>	st_min;
	<span class="enscript-type">double</span>	st_max;
	<span class="enscript-type">double</span>	st_mean;
	<span class="enscript-type">double</span>	st_median;
	<span class="enscript-type">double</span>	st_stddev;
	<span class="enscript-type">double</span>	st_stderr;
	<span class="enscript-type">double</span>	st_99confidence;
	<span class="enscript-type">double</span>	st_skew;
	<span class="enscript-type">double</span>	st_kurtosis;
	<span class="enscript-type">double</span>	st_timecorr;	<span class="enscript-comment">/* correlation with respect to time */</span>
} stats_t;

<span class="enscript-comment">/*
 * Barrier stuff
 */</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
	<span class="enscript-type">int</span>			ba_hwm;		<span class="enscript-comment">/* barrier setpoint	*/</span>
	<span class="enscript-type">int</span>			ba_flag;	<span class="enscript-comment">/* benchmark while true	*/</span>
	<span class="enscript-type">long</span> <span class="enscript-type">long</span>		ba_deadline;	<span class="enscript-comment">/* when to stop		*/</span>
	<span class="enscript-type">int</span>			ba_phase;	<span class="enscript-comment">/* number of time used	*/</span>
	<span class="enscript-type">int</span> 			ba_waiters;	<span class="enscript-comment">/* how many are waiting	*/</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">USE_SEMOP</span>
	<span class="enscript-type">int</span>			ba_semid;
#<span class="enscript-reference">else</span>
	pthread_mutex_t		ba_lock;
	pthread_cond_t		ba_cv;
#<span class="enscript-reference">endif</span>

	<span class="enscript-type">long</span> <span class="enscript-type">long</span>		ba_count;	<span class="enscript-comment">/* how many ops		 */</span>
	<span class="enscript-type">long</span> <span class="enscript-type">long</span>		ba_errors;	<span class="enscript-comment">/* how many errors	 */</span>

	<span class="enscript-type">int</span>			ba_quant;	<span class="enscript-comment">/* how many quant errors */</span>
	<span class="enscript-type">int</span>			ba_batches;	<span class="enscript-comment">/* how many samples	 */</span>

	<span class="enscript-type">double</span>			ba_starttime;	<span class="enscript-comment">/* test time start */</span>
	<span class="enscript-type">double</span>			ba_endtime;	<span class="enscript-comment">/* test time end */</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">NEVER</span>
	<span class="enscript-type">double</span>			ba_tmin;	<span class="enscript-comment">/* min time taken */</span>
	<span class="enscript-type">double</span>			ba_tmax;	<span class="enscript-comment">/* max time taken */</span>
	<span class="enscript-type">double</span>			ba_ctmax;	<span class="enscript-comment">/* max after outliers */</span>
	<span class="enscript-type">double</span>			ba_mean;	<span class="enscript-comment">/* average value */</span>
	<span class="enscript-type">double</span>			ba_median;	<span class="enscript-comment">/* median value */</span>
	<span class="enscript-type">double</span>			ba_rawmedian;	<span class="enscript-comment">/* raw median value */</span>
	<span class="enscript-type">double</span>			ba_stddev;	<span class="enscript-comment">/* standard deviation */</span>
	<span class="enscript-type">double</span>			ba_stderr;	<span class="enscript-comment">/* standard error */</span>
	<span class="enscript-type">double</span>			ba_skew; 	<span class="enscript-comment">/* skew */</span>
	<span class="enscript-type">double</span>			ba_kurtosis;	<span class="enscript-comment">/* kurtosis */</span>
#<span class="enscript-reference">endif</span>
	stats_t			ba_raw;		<span class="enscript-comment">/* raw stats */</span>
	stats_t			ba_corrected;	<span class="enscript-comment">/* corrected stats */</span>

	<span class="enscript-type">int</span>			ba_outliers;	<span class="enscript-comment">/* outlier count */</span>

	<span class="enscript-type">long</span> <span class="enscript-type">long</span>		ba_t0;		<span class="enscript-comment">/* first thread/proc */</span>
	<span class="enscript-type">long</span> <span class="enscript-type">long</span>		ba_t1;		<span class="enscript-comment">/* time of last thread */</span>
	<span class="enscript-type">long</span> <span class="enscript-type">long</span>		ba_count0;
	<span class="enscript-type">long</span> <span class="enscript-type">long</span>		ba_errors0;

	<span class="enscript-type">int</span>			ba_datasize;	<span class="enscript-comment">/* possible #items data	*/</span>
	<span class="enscript-type">double</span>			ba_data[1];	<span class="enscript-comment">/* start of data ararry	*/</span>
} barrier_t;


<span class="enscript-comment">/*
 * Barrier interfaces
 */</span>

barrier_t *<span class="enscript-function-name">barrier_create</span>(<span class="enscript-type">int</span> hwm, <span class="enscript-type">int</span> datasize);
<span class="enscript-type">int</span> <span class="enscript-function-name">barrier_destroy</span>(barrier_t *bar);
<span class="enscript-type">int</span> <span class="enscript-function-name">barrier_queue</span>(barrier_t *bar, result_t *res);


<span class="enscript-comment">/*
 * Functions that can be provided by the user
 */</span>

<span class="enscript-type">int</span>	benchmark(<span class="enscript-type">void</span> *tsd, result_t *res);
<span class="enscript-type">int</span>	benchmark_init();
<span class="enscript-type">int</span>	benchmark_fini();
<span class="enscript-type">int</span>	benchmark_initrun();
<span class="enscript-type">int</span>	benchmark_finirun();
<span class="enscript-type">int</span>	benchmark_initworker();
<span class="enscript-type">int</span>	benchmark_finiworker();
<span class="enscript-type">int</span>	benchmark_initbatch(<span class="enscript-type">void</span> *tsd);
<span class="enscript-type">int</span>	benchmark_finibatch(<span class="enscript-type">void</span> *tsd);
<span class="enscript-type">int</span>	benchmark_optswitch(<span class="enscript-type">int</span> opt, <span class="enscript-type">char</span> *optarg);
<span class="enscript-type">char</span>	*benchmark_result();


<span class="enscript-comment">/*
 * Globals exported to the user
 */</span>

<span class="enscript-type">extern</span> <span class="enscript-type">int</span>			lm_argc;
<span class="enscript-type">extern</span> <span class="enscript-type">char</span>			**lm_argv;

<span class="enscript-type">extern</span> <span class="enscript-type">int</span>			lm_optB;
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>			lm_optD;
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>			lm_optH;
<span class="enscript-type">extern</span> <span class="enscript-type">char</span>			*lm_optN;
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>			lm_optP;
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>			lm_optS;
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>			lm_optT;

<span class="enscript-type">extern</span> <span class="enscript-type">int</span>			lm_defB;
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>			lm_defD;
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>			lm_defH;
<span class="enscript-type">extern</span> <span class="enscript-type">char</span>			*lm_defN;
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>			lm_defP;
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>			lm_defS;
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>			lm_defT;
<span class="enscript-type">extern</span> <span class="enscript-type">int</span>			lm_nsecs_per_op;

<span class="enscript-type">extern</span> <span class="enscript-type">char</span>			*lm_procpath;
<span class="enscript-type">extern</span> <span class="enscript-type">char</span>			lm_procname[STRSIZE];
<span class="enscript-type">extern</span> <span class="enscript-type">char</span> 			lm_usage[STRSIZE];
<span class="enscript-type">extern</span> <span class="enscript-type">char</span> 			lm_optstr[STRSIZE];
<span class="enscript-type">extern</span> <span class="enscript-type">char</span> 			lm_header[STRSIZE];
<span class="enscript-type">extern</span> size_t			lm_tsdsize;


<span class="enscript-comment">/*
 * Utility functions
 */</span>

<span class="enscript-type">int</span> 		getpindex();
<span class="enscript-type">int</span> 		gettindex();
<span class="enscript-type">void</span> 		*gettsd(<span class="enscript-type">int</span> p, <span class="enscript-type">int</span> t);
#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__APPLE__</span>)
<span class="enscript-type">int</span> <span class="enscript-function-name">gettsdindex</span>(<span class="enscript-type">void</span> *arg);
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* __APPLE__ */</span>
<span class="enscript-type">long</span> <span class="enscript-type">long</span> 	getusecs();
<span class="enscript-type">long</span> <span class="enscript-type">long</span> 	getnsecs();
<span class="enscript-type">int</span> 		setfdlimit(<span class="enscript-type">int</span> limit);
<span class="enscript-type">long</span> <span class="enscript-type">long</span> 	sizetoll();
<span class="enscript-type">int</span> 		sizetoint();
<span class="enscript-type">int</span>		fit_line(<span class="enscript-type">double</span> *, <span class="enscript-type">double</span> *, <span class="enscript-type">int</span>, <span class="enscript-type">double</span> *, <span class="enscript-type">double</span> *);
<span class="enscript-type">long</span> <span class="enscript-type">long</span>	get_nsecs_resolution();


<span class="enscript-comment">/* Apple Mods Here */</span>



#<span class="enscript-reference">ifdef</span>  <span class="enscript-variable-name">NO_PORTMAPPER</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TCP_SELECT</span>      -31233
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TCP_XACT</span>        -31234
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TCP_CONTROL</span>     -31235
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TCP_DATA</span>        -31236
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TCP_CONNECT</span>     -31237
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">UDP_XACT</span>        -31238
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">UDP_DATA</span>        -31239
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TCP_SELECT</span>      (u_long)404038  <span class="enscript-comment">/* XXX - unregistered */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TCP_XACT</span>        (u_long)404039  <span class="enscript-comment">/* XXX - unregistered */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TCP_CONTROL</span>     (u_long)404040  <span class="enscript-comment">/* XXX - unregistered */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TCP_DATA</span>        (u_long)404041  <span class="enscript-comment">/* XXX - unregistered */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TCP_CONNECT</span>     (u_long)404042  <span class="enscript-comment">/* XXX - unregistered */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">UDP_XACT</span>        (u_long)404032  <span class="enscript-comment">/* XXX - unregistered */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">UDP_DATA</span>        (u_long)404033  <span class="enscript-comment">/* XXX - unregistered */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VERS</span>            (u_long)1
#<span class="enscript-reference">endif</span>
 
<span class="enscript-comment">/*
* socket send/recv buffer optimizations
*/</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SOCKOPT_READ</span>    0x0001
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SOCKOPT_WRITE</span>   0x0002
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SOCKOPT_RDWR</span>    0x0003
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SOCKOPT_PID</span>     0x0004
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SOCKOPT_REUSE</span>   0x0008
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SOCKOPT_NONE</span>    0

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">SOCKBUF</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">SOCKBUF</span>         (1024*1024)
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">XFERSIZE</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">XFERSIZE</span>        (64*1024)       <span class="enscript-comment">/* all bandwidth I/O should use this */</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> iter_t;

<span class="enscript-type">int</span>     <span class="enscript-function-name">tcp_server</span>(<span class="enscript-type">int</span> prog, <span class="enscript-type">int</span> rdwr);
<span class="enscript-type">int</span>     <span class="enscript-function-name">tcp_done</span>(<span class="enscript-type">int</span> prog);
<span class="enscript-type">int</span>     <span class="enscript-function-name">tcp_accept</span>(<span class="enscript-type">int</span> sock, <span class="enscript-type">int</span> rdwr);
<span class="enscript-type">int</span>     <span class="enscript-function-name">tcp_connect</span>(<span class="enscript-type">char</span> *host, <span class="enscript-type">int</span> prog, <span class="enscript-type">int</span> rdwr);
<span class="enscript-type">void</span>    <span class="enscript-function-name">sock_optimize</span>(<span class="enscript-type">int</span> sock, <span class="enscript-type">int</span> rdwr);
<span class="enscript-type">int</span>     <span class="enscript-function-name">sockport</span>(<span class="enscript-type">int</span> s);

<span class="enscript-comment">/* end Apple Mods */</span>
	

#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* LIBMICRO_H */</span>
</pre>
<hr />
</body></html>