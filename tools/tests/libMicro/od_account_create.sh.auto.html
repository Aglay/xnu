<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>od_account_create.sh</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">od_account_create.sh&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-reference">#!/bin/bash
</span>

<span class="enscript-keyword">function</span> sighandler {
  <span class="enscript-builtin">echo</span> 
  <span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;Interrupting account creation&quot;</span>
  rm -f $TMPF
  <span class="enscript-builtin">exit</span> 1
}

<span class="enscript-builtin">trap</span> sighandler INT TERM

<span class="enscript-comment"># Fixed parameters
</span><span class="enscript-comment">#
</span>NAME=`basename $0`
COUNT=$1
NODE=$2
PREFIX=<span class="enscript-string">&quot;od_test_&quot;</span>
GROUP_ID=1211	<span class="enscript-comment"># A group everybody's in
</span>GROUP_ID2=1212	<span class="enscript-comment"># A group nobody's in
</span>GROUP_NAME='od_test_group'
UID_BASE=5000
TMPF=/tmp/.${NAME}.$$

usage () {
  <span class="enscript-builtin">echo</span>
  <span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;Usage: ${NAME} count nodename&quot;</span>
  <span class="enscript-builtin">echo</span> 
  <span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;   ie. ${NAME} 1000 /Local/Default&quot;</span>
  <span class="enscript-builtin">echo</span>
  <span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;       will create users 1000 users (from '${PREFIX}1' to '${PREFIX}1000')&quot;</span>
  <span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;       Default password is set to 'test'&quot;</span>
  <span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;       User ID starts from 5000&quot;</span>
  <span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;       Default group is '${GROUP_NAME}', Group ID 1211&quot;</span>
  <span class="enscript-builtin">echo</span>
  <span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;This tool assumes user 'diradmin' with password 'admin' for OD admin&quot;</span>
  <span class="enscript-builtin">echo</span>
  <span class="enscript-builtin">exit</span> 85 <span class="enscript-comment"># WRONGARGS
</span>}

<span class="enscript-keyword">if</span> [ $<span class="enscript-comment"># -ne 2 ]; then
</span>  usage
<span class="enscript-keyword">fi</span>

<span class="enscript-comment"># we don't need credentials if its a local node
</span><span class="enscript-keyword">if</span> [ $NODE != <span class="enscript-string">&quot;/Local/Default&quot;</span> ]; <span class="enscript-keyword">then</span>
  OD_ADMIN=<span class="enscript-string">&quot;diradmin&quot;</span>
  OD_PASS=<span class="enscript-string">&quot;admin&quot;</span>
<span class="enscript-keyword">fi</span>

<span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;Creating users ${PREFIX}1 to ${PREFIX}$COUNT&quot;</span>

<span class="enscript-comment"># check to see if od_test_group exist. if not, create one
</span><span class="enscript-comment">#
</span>result=`dscl $NODE -list Groups/${GROUP_NAME<span class="enscript-keyword">}</span>1 2&gt; /dev/null`
<span class="enscript-keyword">if</span> [ $? -ne 0 ]; <span class="enscript-keyword">then</span>
  <span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;Group \&quot;${GROUP_NAME}\&quot; does not exist. Creating ${GROUP_NAME}&quot;</span>
  <span class="enscript-keyword">if</span> [ -n <span class="enscript-string">&quot;$OD_ADMIN&quot;</span> ]; <span class="enscript-keyword">then</span>
    dseditgroup -q -o create -n $NODE -u $OD_ADMIN -P $OD_PASS -i ${GROUP_ID} ${GROUP_NAME<span class="enscript-keyword">}</span>1
    dseditgroup -q -o create -n $NODE -u $OD_ADMIN -P $OD_PASS -i ${GROUP_ID2} ${GROUP_NAME<span class="enscript-keyword">}</span>2
  <span class="enscript-keyword">else</span>
    dseditgroup -q -o create -n $NODE -i ${GROUP_ID} ${GROUP_NAME<span class="enscript-keyword">}</span>1
    dseditgroup -q -o create -n $NODE -i ${GROUP_ID2} ${GROUP_NAME<span class="enscript-keyword">}</span>2
  <span class="enscript-keyword">fi</span>
<span class="enscript-keyword">fi</span>

<span class="enscript-keyword">if</span> [ $? -ne 0 ]; <span class="enscript-keyword">then</span>
	<span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;Failed to create test_group&quot;</span>
	<span class="enscript-builtin">exit</span> 1
<span class="enscript-keyword">fi</span>

<span class="enscript-comment"># using dsimport is faster than using dscl
</span>i=1
uid=$UID_BASE
<span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;Writing a temporary import file ...&quot;</span>
<span class="enscript-keyword">while</span> [ $i -le $COUNT ]
<span class="enscript-keyword">do</span>
  result=`dscl $NODE -list Users/${PREFIX}${i} 2&gt; /dev/null`
  <span class="enscript-keyword">if</span> [ $? -ne 0 ]; <span class="enscript-keyword">then</span> 
    <span class="enscript-comment"># Uses standard template
</span>	<span class="enscript-comment"># RecordName:Password:UniqueID:PrimaryGroupID:DistinguishedName:NFSHomeDirectory:UserShell
</span>	<span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;${PREFIX}${i}:test:${uid}:1211:${PREFIX}${i}:/Users/${PREFIX}${i}:/bin/bash&quot;</span> &gt;&gt; $TMPF
    printf <span class="enscript-string">&quot;\r${PREFIX}${i} / ${COUNT}&quot;</span>
  <span class="enscript-keyword">else</span>
    <span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;account $PREFIX$i already exist. skipping&quot;</span>
  <span class="enscript-keyword">fi</span>
  i=`expr $i + 1` 
  uid=`expr $uid + 1` 
<span class="enscript-keyword">done</span>
<span class="enscript-builtin">echo</span> 

<span class="enscript-comment"># Now do the real work
</span><span class="enscript-comment">#
</span><span class="enscript-keyword">if</span> [[ -f $TMPF ]]; <span class="enscript-keyword">then</span>
  <span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;Running dsimport to create users. Please be patient. This takes a while ...&quot;</span>
  <span class="enscript-comment"># assume if admin is provided that slapconfig exists
</span>  <span class="enscript-keyword">if</span> [ -n <span class="enscript-string">&quot;$OD_ADMIN&quot;</span> ]; <span class="enscript-keyword">then</span>
    <span class="enscript-keyword">if</span> [[ -x <span class="enscript-string">&quot;/usr/sbin/slapconfig&quot;</span> ]]; <span class="enscript-keyword">then</span>
      /usr/sbin/slapconfig -setfullsyncmode no
      sleep 2
    <span class="enscript-keyword">fi</span>
    /usr/bin/<span class="enscript-keyword">time</span> dsimport $TMPF $NODE I --username $OD_ADMIN --password $OD_PASS --template StandardUser
    sleep 2
    <span class="enscript-keyword">if</span> [[ -x <span class="enscript-string">&quot;/usr/sbin/slapconfig&quot;</span> ]]; <span class="enscript-keyword">then</span>
      /usr/sbin/slapconfig -setfullsyncmode yes
    <span class="enscript-keyword">fi</span>
  <span class="enscript-keyword">else</span>
    /usr/bin/<span class="enscript-keyword">time</span> dsimport $TMPF $NODE I --template StandardUser
    sleep 2
  <span class="enscript-keyword">fi</span>
  
  <span class="enscript-comment"># and now delete the temp file
</span>  <span class="enscript-comment">#
</span>  rm -f $TMPF
<span class="enscript-keyword">else</span>
  <span class="enscript-builtin">echo</span> <span class="enscript-string">&quot;Nothing done. All users already exist&quot;</span>
<span class="enscript-keyword">fi</span> 

<span class="enscript-builtin">echo</span> Create a SACL group <span class="enscript-keyword">for</span> libMicro
<span class="enscript-comment"># Create a sample SACL group
</span>dseditgroup -q -o create -r <span class="enscript-string">&quot;libMicro ACL&quot;</span> com.apple.access_libMicro
i=1
<span class="enscript-keyword">while</span> [ $i -le $COUNT ]; <span class="enscript-keyword">do</span>
	dseditgroup -q -o edit -a ${PREFIX}${i} -t user com.apple.access_libMicro 
	i=`expr $i + 1` 
<span class="enscript-keyword">done</span>

<span class="enscript-builtin">echo</span> 'Finished'

</pre>
<hr />
</body></html>