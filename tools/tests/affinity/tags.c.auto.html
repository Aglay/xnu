<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>tags.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">tags.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;AvailabilityMacros.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/thread_policy.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/mach.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/mach_traps.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/mach_error.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;mach/mach_time.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdio.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdlib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;unistd.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;err.h&gt;</span>

<span class="enscript-type">int</span>		verbosity = 1;

#<span class="enscript-reference">define</span> <span class="enscript-function-name">DBG</span>(x...) do {				\
	<span class="enscript-keyword">if</span> (verbosity &gt; 1) {			\
		printf(x);			\
	}					\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">mutter</span>(x...) do {			\
	<span class="enscript-keyword">if</span> (verbosity &gt; 0) {			\
		printf(x);			\
	}					\
} <span class="enscript-keyword">while</span> (0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">s_if_plural</span>(x)	(((x) &gt; 1) ? <span class="enscript-string">&quot;s&quot;</span> : <span class="enscript-string">&quot;&quot;</span>)

<span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">usage</span>()
{
	fprintf(stderr,
		<span class="enscript-string">&quot;usage: tags [-i]   interactive/input\n&quot;</span>
		<span class="enscript-string">&quot;            [-v V] verbosity level 0..2 (1)\n&quot;</span>
		<span class="enscript-string">&quot;            [-h]   help info\n&quot;</span>
		<span class="enscript-string">&quot;            pid    process id of target task\n&quot;</span>
	);
	exit(1);
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">thread_tag_set</span>(thread_t thread, <span class="enscript-type">int</span> tag)
{
	kern_return_t			ret;
	thread_affinity_policy_data_t	policy;

	policy.affinity_tag = tag;
	ret = thread_policy_set(
			thread, THREAD_AFFINITY_POLICY,
			(thread_policy_t) &amp;policy,
			THREAD_AFFINITY_POLICY_COUNT);
	<span class="enscript-keyword">if</span> (ret != KERN_SUCCESS) {
		printf(<span class="enscript-string">&quot;thread_policy_set(1) returned %d\n&quot;</span>, ret);
		exit(1);
	}
}

<span class="enscript-type">int</span>
<span class="enscript-function-name">thread_tag_get</span>(thread_t thread)
{
	kern_return_t			ret;
	boolean_t			get_default = FALSE;
	thread_affinity_policy_data_t	policy;
	mach_msg_type_number_t		count = THREAD_AFFINITY_POLICY_COUNT;

	ret = thread_policy_get(
			thread, THREAD_AFFINITY_POLICY,
			(thread_policy_t) &amp;policy, &amp;count, &amp;get_default);
	<span class="enscript-keyword">if</span> (ret != KERN_SUCCESS) {
		printf(<span class="enscript-string">&quot;thread_policy_set(1) returned %d\n&quot;</span>, ret);
		exit(1);
	}

	<span class="enscript-keyword">return</span> policy.affinity_tag;
}

<span class="enscript-type">char</span>			input[81];
<span class="enscript-type">int</span>
<span class="enscript-function-name">main</span>(<span class="enscript-type">int</span> argc, <span class="enscript-type">char</span> *argv[])
{
	kern_return_t		ret;
	mach_port_name_t	port;
	<span class="enscript-type">int</span>			pid;
	<span class="enscript-type">int</span>			c;
	thread_act_t		*thread_array;
	mach_msg_type_number_t	num_threads;
	<span class="enscript-type">int</span>			i;
	boolean_t		interactive = FALSE;
	<span class="enscript-type">int</span>			tag;

	<span class="enscript-keyword">if</span> (geteuid() != 0) {
		printf(<span class="enscript-string">&quot;Must be run as root\n&quot;</span>);
		exit(1);
	}

	<span class="enscript-comment">/* Do switch parsing: */</span>
	<span class="enscript-keyword">while</span> ((c = getopt (argc, argv, <span class="enscript-string">&quot;hiv:&quot;</span>)) != -1) {
		<span class="enscript-keyword">switch</span> (c) {
		<span class="enscript-keyword">case</span> <span class="enscript-string">'i'</span>:
			interactive = TRUE;
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-string">'v'</span>:
			verbosity = atoi(optarg);
			<span class="enscript-keyword">break</span>;
		<span class="enscript-keyword">case</span> <span class="enscript-string">'h'</span>:
		<span class="enscript-keyword">case</span> <span class="enscript-string">'?'</span>:
		<span class="enscript-reference">default</span>:
			usage();
		}
	}
	argc -= optind; argv += optind;
	<span class="enscript-keyword">if</span> (argc &gt; 0)
		pid = atoi(*argv);

	ret = task_for_pid(mach_task_self(), pid, &amp;port);
	<span class="enscript-keyword">if</span> (ret != KERN_SUCCESS)
		err(1, <span class="enscript-string">&quot;task_for_pid(,%d,) returned %d&quot;</span>, pid, ret);	

	mutter(<span class="enscript-string">&quot;task %p\n&quot;</span>, port);
	ret = task_threads(port, &amp;thread_array, &amp;num_threads);
	<span class="enscript-keyword">if</span> (ret != KERN_SUCCESS)
		err(1, <span class="enscript-string">&quot;task_threads() returned %d&quot;</span>, pid, ret);	
 
	<span class="enscript-keyword">for</span> (i = 0; i &lt; num_threads; i++) {
		printf(<span class="enscript-string">&quot; %d: thread 0x%08x tag %d\n&quot;</span>,
			i, thread_array[i], thread_tag_get(thread_array[i]));
	}

	<span class="enscript-keyword">while</span> (interactive) {
		printf(<span class="enscript-string">&quot;Enter new tag or &lt;return&gt; to skip or ^D to quit\n&quot;</span>);
		<span class="enscript-keyword">for</span> (i = 0; i &lt; num_threads; i++) {
			tag =  thread_tag_get(thread_array[i]);
			printf(<span class="enscript-string">&quot; %d: thread 0x%08x tag %d: &quot;</span>,
				i, thread_array[i], tag);
			fflush(stdout);
			(<span class="enscript-type">void</span>) fgets(input, 20, stdin);
			<span class="enscript-keyword">if</span> (feof(stdin)) {
				printf(<span class="enscript-string">&quot;\n&quot;</span>);
				interactive = FALSE;
				<span class="enscript-keyword">break</span>;
			}
			<span class="enscript-keyword">if</span> (strlen(input) &gt; 1) {
				tag = atoi(input);
				thread_tag_set(thread_array[i], tag);
			}
		}
	}

	<span class="enscript-keyword">return</span> 0;
}
</pre>
<hr />
</body></html>