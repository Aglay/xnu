<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>remote_build.sh</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">remote_build.sh&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-reference">#!/bin/bash
</span><span class="enscript-comment">#
</span><span class="enscript-comment"># Script that rsyncs a source/build tree to a remote server, performs a build,
</span><span class="enscript-comment"># and copies the result back
</span><span class="enscript-comment">#
</span>
<span class="enscript-comment"># This script is invoked instead of the initial recursive make(1) in ./Makefile.
</span><span class="enscript-comment"># First it must cache all binaries that might be used during the build by
</span><span class="enscript-comment"># calling &quot;make print_exports&quot; (any target would work) with an overriden xcrun(1)
</span><span class="enscript-comment"># which caches tools an SDKs into ./BUILD/obj/BuildTools. When the combined
</span><span class="enscript-comment"># source+build tree is rsync-ed to the remote server, we run a script to
</span><span class="enscript-comment"># re-initiate the build using an overriden xcrun(1) which hands back
</span><span class="enscript-comment"># cached tools in ./BUILD/obj/BuildTools instead of whatever Xcode tools are on
</span><span class="enscript-comment"># the remote system (or if no Xcode tools are installed remotely). Finally,
</span><span class="enscript-comment"># the build results are copied back locally.
</span><span class="enscript-comment">#
</span>
function die() {
    <span class="enscript-keyword">echo</span> <span class="enscript-string">&quot;$1&quot;</span> 1&gt;&amp;2
    <span class="enscript-keyword">exit</span> 1
}


TARGET=
declare -a ARGS
declare -a REMOTEARGS
index=0
<span class="enscript-keyword">for</span> arg <span class="enscript-keyword">in</span> <span class="enscript-string">&quot;$@&quot;</span>; <span class="enscript-keyword">do</span>
    <span class="enscript-keyword">case</span> $arg <span class="enscript-keyword">in</span>
	_REMOTEBUILD_TARGET=*)
	    TARGET=`<span class="enscript-keyword">echo</span> $arg | awk -F= '{print $2}'`
	    <span class="enscript-keyword">continue</span>
	    ;;
	_REMOTEBUILD_MAKE=*)
	    MAKE=`<span class="enscript-keyword">echo</span> $arg | awk -F= '{print $2}'`
	    <span class="enscript-keyword">continue</span>
	    ;;
	REMOTEBUILD=*)
	    <span class="enscript-comment"># Don't restart another remote build remotely
</span>	    ;;
	SRCROOT=*)
	    <span class="enscript-keyword">continue</span>
	    ;;
	OBJROOT=*)
	    <span class="enscript-keyword">continue</span>
	    ;;
	SYMROOT=*)
	    <span class="enscript-keyword">continue</span>
	    ;;
	DSTROOT=*)
	    <span class="enscript-keyword">continue</span>
	    ;;
	CCHROOT=*)
	    <span class="enscript-keyword">continue</span>
	    ;;
	RC_XBS=*)
	    <span class="enscript-comment"># Remote build isn't chrooted or special in any way
</span>	    arg=<span class="enscript-string">&quot;VERBOSE=YES&quot;</span>
	    <span class="enscript-keyword">continue</span>
	    ;;
	VERBOSE=YES)
	    <span class="enscript-keyword">set</span> -x
	    ;;
    <span class="enscript-keyword">esac</span>
    ARGS[$index]=<span class="enscript-string">&quot;$arg&quot;</span>
    REMOTEARGS[$index]=<span class="enscript-string">&quot;\&quot;$arg\&quot;&quot;</span>
    index=$(($index+1))
<span class="enscript-keyword">done</span>


RSYNC_ARGS=<span class="enscript-string">&quot;-azvh&quot;</span>
ARGS[$index]=<span class="enscript-string">&quot;REMOTEBUILD=&quot;</span>
REMOTEARGS[$index]=<span class="enscript-string">&quot;\&quot;REMOTEBUILD=\&quot;&quot;</span>

<span class="enscript-comment"># For some targets like installsrc, we can't to a remote build
</span>SKIPREMOTE=0
<span class="enscript-keyword">case</span> $TARGET <span class="enscript-keyword">in</span>
    clean)
	SKIPREMOTE=1
	;;
    installsrc)
	SKIPREMOTE=1
	;;
    installopensource)
	SKIPREMOTE=1
	;;
    cscope)
	SKIPREMOTE=1
	;;
    tags)
	SKIPREMOTE=1
	;;
    help)
	SKIPREMOTE=1
	;;
<span class="enscript-keyword">esac</span>

<span class="enscript-keyword">if</span> [ $SKIPREMOTE -eq 1 ]; <span class="enscript-keyword">then</span>
    <span class="enscript-keyword">exec</span> <span class="enscript-string">&quot;$MAKE&quot;</span> <span class="enscript-string">&quot;$TARGET&quot;</span> <span class="enscript-string">&quot;${ARGS[@]}&quot;</span>
<span class="enscript-keyword">fi</span>

SRC=<span class="enscript-string">&quot;$(pwd -P)&quot;</span>
SRCNAME=<span class="enscript-string">&quot;$(basename $SRC)&quot;</span>

<span class="enscript-comment"># Pick up build locations passed in the environment
</span>OBJROOT=<span class="enscript-string">&quot;${OBJROOT}&quot;</span>
SYMROOT=<span class="enscript-string">&quot;${SYMROOT}&quot;</span>
DSTROOT=<span class="enscript-string">&quot;${DSTROOT}&quot;</span>

<span class="enscript-keyword">if</span> [ -z <span class="enscript-string">&quot;${OBJROOT}&quot;</span> ]; <span class="enscript-keyword">then</span>
    die <span class="enscript-string">&quot;OBJROOT not set in environment&quot;</span>
<span class="enscript-keyword">fi</span>
mkdir -p <span class="enscript-string">&quot;${OBJROOT}&quot;</span> || die <span class="enscript-string">&quot;Could not create ${OBJROOT}&quot;</span>

<span class="enscript-keyword">if</span> [ -z <span class="enscript-string">&quot;${SYMROOT}&quot;</span> ]; <span class="enscript-keyword">then</span>
    die <span class="enscript-string">&quot;SYMROOT not set in environment&quot;</span>
<span class="enscript-keyword">fi</span>
mkdir -p <span class="enscript-string">&quot;${SYMROOT}&quot;</span> || die <span class="enscript-string">&quot;Could not create ${SYMROOT}&quot;</span>

<span class="enscript-keyword">if</span> [ -z <span class="enscript-string">&quot;${DSTROOT}&quot;</span> ]; <span class="enscript-keyword">then</span>
    die <span class="enscript-string">&quot;DSTROOT not set in environment&quot;</span>
<span class="enscript-keyword">fi</span>
mkdir -p <span class="enscript-string">&quot;${DSTROOT}&quot;</span> || die <span class="enscript-string">&quot;Could not create ${DSTROOT}&quot;</span>

<span class="enscript-keyword">if</span> [ <span class="enscript-string">&quot;$REMOTEBUILD&quot;</span> = <span class="enscript-string">&quot;$SPECIALREMOTEBUILD&quot;</span> ]; <span class="enscript-keyword">then</span>
    :
<span class="enscript-keyword">else</span>
    DOINSTALLSRC=0
    REMOTE_SRCREL=<span class="enscript-string">&quot;./&quot;</span>
    BUILDTOOLSDIR=<span class="enscript-string">&quot;$OBJROOT&quot;</span>
    REMOTE_BUILDTOOLSREL=<span class="enscript-string">&quot;./BUILD/obj&quot;</span>
    BUILDSCRIPTDIR=<span class="enscript-string">&quot;$OBJROOT&quot;</span>
    REMOTE_BUILDSCRIPTREL=<span class="enscript-string">&quot;./BUILD/obj&quot;</span>
    BUILDSCRIPTNAME=<span class="enscript-string">&quot;build.sh&quot;</span>
    <span class="enscript-keyword">if</span> [ ! -d <span class="enscript-string">&quot;${OBJROOT}/SETUP&quot;</span> ]; <span class="enscript-keyword">then</span>
    RSYNC_DELETE_EXCLUDED=<span class="enscript-string">&quot;--delete-excluded&quot;</span>
    <span class="enscript-keyword">else</span>
    RSYNC_DELETE_EXCLUDED=<span class="enscript-string">&quot;&quot;</span>
    <span class="enscript-keyword">fi</span>
    <span class="enscript-keyword">if</span> [ ! -e <span class="enscript-string">&quot;${SYMROOT}/&quot;</span> ]; <span class="enscript-keyword">then</span>
	RSYNC_DELETE_SYMROOT=1
    <span class="enscript-keyword">else</span>
	RSYNC_DELETE_SYMROOT=0
    <span class="enscript-keyword">fi</span>
    <span class="enscript-keyword">if</span> [ ! -e <span class="enscript-string">&quot;${DSTROOT}/&quot;</span> ]; <span class="enscript-keyword">then</span>
	RSYNC_DELETE_DSTROOT=1
    <span class="enscript-keyword">else</span>
	RSYNC_DELETE_DSTROOT=0
    <span class="enscript-keyword">fi</span>
    TARBUILDDIRS=0
<span class="enscript-keyword">fi</span>

<span class="enscript-keyword">echo</span> <span class="enscript-string">&quot;Caching build tools...&quot;</span> 1&gt;&amp;2
mkdir -p <span class="enscript-string">&quot;${BUILDTOOLSDIR}&quot;</span> || die <span class="enscript-string">&quot;Could not create BUILDTOOLSDIR&quot;</span>
$MAKE print_exports <span class="enscript-string">&quot;${ARGS[@]}&quot;</span> XCRUN=<span class="enscript-string">&quot;${SRC}/tools/xcrun_cache.sh -c \&quot;${BUILDTOOLSDIR}\&quot;&quot;</span> &gt;/dev/null || die <span class="enscript-string">&quot;Could not cache build tools&quot;</span>

<span class="enscript-comment"># Cache the make(1) binary itself
</span>MAKE_SDKROOT=`<span class="enscript-string">&quot;${SRC}/tools/xcrun_cache.sh&quot;</span> -u <span class="enscript-string">&quot;${BUILDTOOLSDIR}&quot;</span> -sdk / -show-sdk-path`
<span class="enscript-string">&quot;${SRC}/tools/xcrun_cache.sh&quot;</span> -c <span class="enscript-string">&quot;${BUILDTOOLSDIR}&quot;</span> -sdk <span class="enscript-string">&quot;${MAKE_SDKROOT}&quot;</span> -find make &gt;/dev/null || die <span class="enscript-string">&quot;Could not cache make&quot;</span>

<span class="enscript-comment"># Create a canned build script that can restart the build on the remote server.
</span>mkdir -p <span class="enscript-string">&quot;${BUILDSCRIPTDIR}&quot;</span> || die <span class="enscript-string">&quot;Could not create BUILDSCRIPTDIR&quot;</span>
cat &gt; <span class="enscript-string">&quot;${BUILDSCRIPTDIR}/${BUILDSCRIPTNAME}&quot;</span> &lt;&lt;EOF
<span class="enscript-reference">#!/bin/sh
</span>mkdir -p /private/tmp
mkdir -p /private/var/tmp
mkdir -p <span class="enscript-string">&quot;\${TMPDIR}&quot;</span>
<span class="enscript-keyword">cd</span> <span class="enscript-string">&quot;${REMOTE_SRCREL}&quot;</span>
mkdir -p ./BUILD/obj
mkdir -p ./BUILD/sym
mkdir -p ./BUILD/dst
MAKE=\`\$PWD/tools/xcrun_cache.sh -u <span class="enscript-string">&quot;\$PWD/${REMOTE_BUILDTOOLSREL}&quot;</span> -sdk / -find make\`
<span class="enscript-keyword">if</span> [ -z <span class="enscript-string">&quot;\${MAKE}&quot;</span> ]; <span class="enscript-keyword">then</span> <span class="enscript-keyword">exit</span> 1; <span class="enscript-keyword">fi</span>
\${MAKE} ${TARGET} ${REMOTEARGS[@]} XCRUN=<span class="enscript-string">&quot;\$PWD/tools/xcrun_cache.sh -u \&quot;\$PWD/${REMOTE_BUILDTOOLSREL}\&quot;&quot;</span>
ret=\$?
<span class="enscript-keyword">if</span> [ \$ret -eq 0 ]; <span class="enscript-keyword">then</span>
<span class="enscript-keyword">if</span> [ ${TARBUILDDIRS} -eq 1 ]; <span class="enscript-keyword">then</span>
tar jcf ./BUILD/obj.tar.bz2 --exclude=\*.o --exclude=\*.cpo --exclude=\*.d --exclude=\*.cpd --exclude=\*.non_lto --exclude=\*.ctf --exclude=conf -C ./BUILD/obj . || <span class="enscript-keyword">exit</span> 1
tar jcf ./BUILD/sym.tar.bz2 -C ./BUILD/sym . || <span class="enscript-keyword">exit</span> 1
tar jcf ./BUILD/dst.tar.bz2 -C ./BUILD/dst . || <span class="enscript-keyword">exit</span> 1
<span class="enscript-keyword">fi</span>
<span class="enscript-keyword">fi</span>
<span class="enscript-keyword">exit</span> \$ret
EOF
chmod a+x <span class="enscript-string">&quot;${BUILDSCRIPTDIR}/${BUILDSCRIPTNAME}&quot;</span>
<span class="enscript-comment">#echo &quot;Build script is:&quot;
</span><span class="enscript-comment">#cat &quot;${BUILDSCRIPTDIR}/${BUILDSCRIPTNAME}&quot;
</span>
mkdir -p <span class="enscript-string">&quot;${BUILDTOOLSDIR}/empty&quot;</span>

<span class="enscript-keyword">if</span> [ <span class="enscript-string">&quot;$REMOTEBUILD&quot;</span> = <span class="enscript-string">&quot;$SPECIALREMOTEBUILD&quot;</span> ]; <span class="enscript-keyword">then</span>
    :
<span class="enscript-keyword">else</span>

    REMOTEBUILD=<span class="enscript-string">&quot;$REMOTEBUILD&quot;</span>
    REMOTEBUILDPATH=<span class="enscript-string">&quot;$REMOTEBUILDPATH&quot;</span>

    <span class="enscript-keyword">if</span> [ -z <span class="enscript-string">&quot;$REMOTEBUILDPATH&quot;</span> ]; <span class="enscript-keyword">then</span>
	WHOAMI=`whoami`
	<span class="enscript-keyword">case</span> <span class="enscript-string">&quot;${REMOTEBUILD}&quot;</span> <span class="enscript-keyword">in</span>
	    *@*)
		WHOAMI=`<span class="enscript-keyword">echo</span> <span class="enscript-string">&quot;${REMOTEBUILD}&quot;</span> | awk -F@ '{print $1}'`
		;;
	<span class="enscript-keyword">esac</span>
	REMOTEBUILDPATH=<span class="enscript-string">&quot;/tmp/$WHOAMI&quot;</span>
    <span class="enscript-keyword">fi</span>

<span class="enscript-comment"># Construct a unique remote path
</span>    <span class="enscript-keyword">eval</span> `stat -s <span class="enscript-string">&quot;${SRC}&quot;</span>`

    REMOTEBUILDPATH=<span class="enscript-string">&quot;${REMOTEBUILDPATH}/$st_ino/${SRCNAME}/&quot;</span>
    <span class="enscript-keyword">echo</span> <span class="enscript-string">&quot;Remote path is ${REMOTEBUILD}:${REMOTEBUILDPATH}&quot;</span> 1&gt;&amp;2

    ssh $REMOTEBUILD <span class="enscript-string">&quot;mkdir -p \&quot;${REMOTEBUILDPATH}/BUILD/\&quot;{obj,sym,dst}&quot;</span> || die <span class="enscript-string">&quot;Could not make remote build directory&quot;</span>

    <span class="enscript-comment"># Copy source only
</span>    rsync $RSYNC_ARGS --delete --exclude=\*~ --exclude=.svn --exclude=.git --exclude=/BUILD . $REMOTEBUILD:<span class="enscript-string">&quot;${REMOTEBUILDPATH}&quot;</span> || die <span class="enscript-string">&quot;Could not rsync source tree&quot;</span>

    <span class="enscript-comment"># Copy partial OBJROOT (just build tools and build script), and optionally delete everything else
</span>    rsync $RSYNC_ARGS --delete $RSYNC_DELETE_EXCLUDED --include=/build.sh --include=/BuildTools --include=/BuildTools/\*\* --exclude=\* <span class="enscript-string">&quot;${OBJROOT}/&quot;</span> $REMOTEBUILD:<span class="enscript-string">&quot;${REMOTEBUILDPATH}/BUILD/obj/&quot;</span> || die <span class="enscript-string">&quot;Could not rsync build tree&quot;</span>

    <span class="enscript-comment"># Delete remote SYMROOT if it has been deleted locally
</span>    <span class="enscript-keyword">if</span> [ <span class="enscript-string">&quot;$RSYNC_DELETE_SYMROOT&quot;</span> -eq 1 ]; <span class="enscript-keyword">then</span>
	rsync $RSYNC_ARGS --delete <span class="enscript-string">&quot;${BUILDTOOLSDIR}/empty/&quot;</span> $REMOTEBUILD:<span class="enscript-string">&quot;${REMOTEBUILDPATH}/BUILD/sym/&quot;</span> || die <span class="enscript-string">&quot;Could not rsync delete SYMROOT&quot;</span>
    <span class="enscript-keyword">fi</span>

    <span class="enscript-comment"># Delete remote DSTROOT if it has been deleted locally
</span>    <span class="enscript-keyword">if</span> [ <span class="enscript-string">&quot;$RSYNC_DELETE_DSTROOT&quot;</span> -eq 1 ]; <span class="enscript-keyword">then</span>
	rsync $RSYNC_ARGS --delete <span class="enscript-string">&quot;${BUILDTOOLSDIR}/empty/&quot;</span> $REMOTEBUILD:<span class="enscript-string">&quot;${REMOTEBUILDPATH}/BUILD/dst/&quot;</span> || die <span class="enscript-string">&quot;Could not rsync delete DSTROOT&quot;</span>
    <span class="enscript-keyword">fi</span>

    <span class="enscript-comment"># Start the build
</span>    <span class="enscript-keyword">echo</span> ssh $REMOTEBUILD <span class="enscript-string">&quot;/bin/bash -c 'cd \&quot;${REMOTEBUILDPATH}\&quot; &amp;&amp; ${REMOTE_BUILDSCRIPTREL}/${BUILDSCRIPTNAME}'&quot;</span> 1&gt;&amp;2
    ssh $REMOTEBUILD <span class="enscript-string">&quot;/bin/bash -c 'cd \&quot;${REMOTEBUILDPATH}\&quot; &amp;&amp; ${REMOTE_BUILDSCRIPTREL}/${BUILDSCRIPTNAME}'&quot;</span> || die <span class="enscript-string">&quot;Could not complete remote build&quot;</span>

    <span class="enscript-comment"># Copy back build results except for object files (which might be several GB)
</span>    <span class="enscript-keyword">echo</span> <span class="enscript-string">&quot;Copying results back...&quot;</span>
    rsync $RSYNC_ARGS --no-o --no-g --exclude=\*.o --exclude=\*.cpo --exclude=\*.d --exclude=\*.cpd --exclude=\*.non_lto --exclude=\*.ctf $REMOTEBUILD:<span class="enscript-string">&quot;${REMOTEBUILDPATH}/BUILD/obj/&quot;</span> <span class="enscript-string">&quot;${OBJROOT}/&quot;</span> || die <span class="enscript-string">&quot;Could not rsync build results&quot;</span>
    rsync $RSYNC_ARGS --no-o --no-g $REMOTEBUILD:<span class="enscript-string">&quot;${REMOTEBUILDPATH}/BUILD/sym/&quot;</span> <span class="enscript-string">&quot;${SYMROOT}/&quot;</span> || die <span class="enscript-string">&quot;Could not rsync build results&quot;</span>
    rsync $RSYNC_ARGS --no-o --no-g $REMOTEBUILD:<span class="enscript-string">&quot;${REMOTEBUILDPATH}/BUILD/dst/&quot;</span> <span class="enscript-string">&quot;${DSTROOT}/&quot;</span> || die <span class="enscript-string">&quot;Could not rsync build results&quot;</span>

<span class="enscript-keyword">fi</span>

<span class="enscript-keyword">exit</span> 0
</pre>
<hr />
</body></html>